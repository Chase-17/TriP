# Battle Components / Боевая система

Компоненты для отображения и взаимодействия с боевой картой.

## BattleMap.vue (~3500 строк)
Главный компонент гексагональной карты.

**Функционал:**
- Рендеринг гекс-сетки на canvas
- Отображение токенов (игроки, NPC, монстры)
- Terrain painting (режим мастера)
- Pan/zoom с touch-поддержкой
- Выбор токенов и гексов
- Анимации перемещения
- Fill profile - заполнение областей
- **Система движения и поворотов** (см. ниже)

**Props:**
- `readonly` - режим только чтение
- `mobileMode` - мобильная адаптация
- `isMaster` - режим мастера

**События:**
- `token-selected`, `hex-selected`
- `hex-double-tap`, `hex-long-press-*`
- `token-rotate`, `move-to-hex`

**Использует stores:**
- `battleMapStore` - состояние карты, токены, terrain
- `charactersStore` - данные персонажей
- `interactionStore` - состояние интерактивности (выбор токена, путь, facing)
- `pointerStore` - визуализация указки и пути

---

## Система движения и поворотов (Token Movement & Facing)

### Концепция
Токен персонажа имеет **facing** (направление, 0-11, каждый сектор = 30°).
Направление влияет на защиту и атаки.

### Схема взаимодействия "Рогатка"
При выборе направления используется **инвертированная схема**:
- Пользователь тянет палец/мышь **в противоположную сторону** от желаемого направления
- Как натягивание рогатки: тянем назад → стреляем вперёд

### Touch (мобильные устройства)
1. **Токен НЕ выбран:**
   - Один палец = pan карты / tap по токену для выбора
   - Два пальца = pinch-zoom

2. **Токен выбран (свой):**
   - Tap на гекс = показать путь
   - Повторный tap на гекс с путём = подтвердить перемещение
   - **Drag = выбор направления:**
     - Drag от любого места → показывает путь к начальной точке касания + выбор facing
     - Drag на своём токене → поворот на месте
     - Угол drag'а определяет facing (схема "рогатка")
   - Отпускание пальца → подтверждение действия

### Mouse (десктоп)
1. **Клик на токен** → выбор токена, показ зоны движения
2. **Клик на гекс** → показать путь
3. **Повторный клик на гекс с путём** → подтвердить перемещение
4. **Drag при показанном пути** (не по токену, без Shift) → выбор направления
5. **Shift+LMB или MMB** → pan карты

### Preview (предпросмотр)
- **Поворот на месте:** оригинальный токен вращается в реальном времени
- **Перемещение:** на целевой позиции появляется **ghost token** (полупрозрачный) с выбранным facing и защитой

### Ключевые переменные
```javascript
// BattleMap.vue
isDraggingFacing      // Флаг: идёт drag для выбора facing
facingDragSource      // 'ring' | 'path-end' (устаревшее, теперь только isRotateInPlace)
facingDragCenter      // Центр для расчёта угла

// touchState (внутри ref)
isDragForFacing       // Touch: drag для facing
isRotateInPlace       // Touch: поворот на месте vs перемещение
dragStartHex          // Гекс начала drag (для показа пути)

// interactionStore (Pinia)
state                 // IDLE | TOKEN_SELECTED | PATH_SHOWN | ...
targetHex             // Целевой гекс пути
selectedFacing        // Выбранный пользователем facing
```

### Ключевые функции
```javascript
getFacingFromDragAngle(centerX, centerY, pointX, pointY)
// Вычисляет facing (0-11) по углу drag с учётом:
// - Инверсии 180° (рогатка)
// - Коррекции 90° для согласования с системой
// - Ориентации карты (flat-top / pointy-top)

showPathToHex(hex)
// Показывает путь от выбранного токена к hex
// Вычисляет suggestedFacing по направлению последнего шага

renderUI() → рисует ghost token
// Если есть interactionTargetHex и не isRotateInPlace,
// рисует полупрозрачный токен на целевой позиции с preview facing
```

### Удалённый код
- `renderRotateRing` - кольцо поворота вокруг токена (заменено на drag)
- `renderFacingIndicator` - 5 стрелок на конце пути (заменено на ghost token)
- `isPointInRotateRing`, `isPointNearPathEnd` - проверки зон (не нужны)

---

## MapPointer.vue
Слой указки поверх карты (canvas overlay).

**Функционал:**
- Отрисовка пути (сегменты по ресурсам)
- Зона движения (reachable hexes)
- Пинги мастера
- Измерение расстояний
- Рисование фигур

**Не рисует:**
- Rotation ring (удалён)
- Facing indicator стрелки (удалён) — ghost token рисуется в BattleMap

---

## SceneLog.vue (~2900 строк)
Лог событий сцены с фильтрацией и взаимодействием.

**Функционал:**
- Отображение бросков, сообщений, действий
- Фильтрация по типу/источнику
- Интерактивные элементы (переход к событиям)
- Изображения сцены в логе

**Использует stores:**
- `sceneLogStore` - история событий

---

## Важные утилиты
- `@/utils/hex/grid` - геометрия гексов, HexGrid класс
- `@/utils/hex/pathfinding` - поиск пути A*
- `@/utils/hex/animation` - анимация движения токенов
- `@/utils/rendering/tokenRenderer` - отрисовка токенов, защиты, facing
- `@/utils/hex/selection` - логика выбора областей
- `@/utils/hex/fill` - заполнение областей
