import{D as A,u as D,r as c,l as P,o as _,E as C,b as E,m as U,f as h,j as y}from"./index-gQaYO5ct.js";import{u as z,b as N,d as O,a as j,H as F}from"./fillProfile-BtIfjwhZ.js";import{G as J,o as K,u as Q,k as V}from"./GameLayout-B-di3ld6.js";import{usePointerStore as W}from"./pointer-D6QFUiDV.js";import{s as r,a as g}from"./safeStoreRefs-BFQqCsTa.js";const re={__name:"MasterRoom",setup(X){const S=A(),m=D(),o=r(z,"session");r(y,"user");const l=r(N,"battleMap"),d=r(O,"sceneLog"),k=r(j,"characters"),M=r(K,"interaction"),x=r(W,"pointer"),I=r(Q,"terrain"),{roomId:Y=c(""),status:R=c(""),connections:T=c([])}=g(o,"session"),{characters:b=c([])}=g(k,"characters");P(()=>T.value||[]),_(async()=>{const t=S.params.roomId;if(!t){m.push("/master");return}o.setRole("master"),o.roomId=t;try{await o.createRoom(),o.onMessage("scene-event",e=>{console.log("Получено событие сцены от игрока:",e),e.event&&d.handleIncomingEvent(e.event)}),o.onMessage("skill-check-result",e=>{console.log("Получен результат проверки от игрока:",e),e.eventId&&e.result&&d.updateEvent(e.eventId,{completed:!0,result:e.result,completedBy:e.senderId,completedAt:Date.now(),characterName:e.characterName})})}catch(e){console.error("Ошибка создания комнаты:",e)}}),C(()=>{o.leaveRoom()});const H=()=>{o.leaveRoom(),m.push("/master")},s=c(null),p=c(null),q=()=>{const t=l.activeMap;return t?new F({orientation:t.orientation||"flat",hexSize:t.hexSize||32,origin:{x:0,y:0}}):null},{moveToken:B}=V({battleMapStore:l,terrainStore:I,getHexGrid:q}),G=t=>{if(!t)return;const e={q:t.q,r:t.r},n=t.facing;if(console.log("[MasterRoom] hex-double-tap:",e,"facing:",n,"selectedToken:",s.value),!s.value){console.log("[MasterRoom] Нет выбранного токена");return}const i=s.value,v=l.activeMapId,u=B({characterId:i.characterId,targetHex:e,facing:n,pathfindingOptions:{modifiers:{},maxCost:100},onBeforeAnimate:({characterId:f,path:a,duration:L,facing:w})=>{o.broadcastTokenAnimationToPlayers(f,a,L,w)},onComplete:({finalFacing:f,targetHex:a})=>{o.broadcastMapTokenMove(v,i.characterId,a.q,a.r),s.value={...s.value,q:a.q,r:a.r},M.reset(),x.hideHoveredPath()}});u.success&&u.rotateOnly&&o.broadcastMapTokenMove(v,i.characterId,e.q,e.r),u.success||console.warn("[MasterRoom] Ошибка перемещения:",u.error)};return(t,e)=>(E(),U(J,{"is-master":!0,character:null,characters:h(b),"selected-token":s.value,"selected-hex":p.value,"player-facing":0,"player-token-position":null,"connection-status":h(R),"current-turn":null,"is-player-turn":!0,"pending-action":null,"reaction-prompt":null,onLeaveRoom:H,onTokenSelected:e[0]||(e[0]=n=>s.value=n),onHexSelected:e[1]||(e[1]=n=>p.value=n),onHexDoubleTap:G},null,8,["characters","selected-token","selected-hex","connection-status"]))}};export{re as default};
