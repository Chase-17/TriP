import{G as El,r as Q,H as Ml,o as Ut,m as Qt,E as Xs,I as gn,J as Mt,n as X,c as s,d as n,e,F as W,p as re,x as te,t as u,k as ke,i as x,y as Ke,w as Fe,T as Tt,h as Me,v as Be,A as Al,g as f,q as Ne,K as _t,l as Dl,s as pt,L as Un,a as ms,M as Lt,f as U,j as Zt,C as us,N as Nl,O as ws,P as zs}from"./index-CduOqXut.js";import{f as ts,g as Ll,F as mt,C as yt,e as Bn,b as ss,a as Rt,u as Bt,H as qt,M as Ht,h as Fl,S as Rl,T as os,L as Vt,i as vt,j as xt,k as jt,l as Ls,d as Ys,m as Ee,n as is}from"./fillProfile-dB6AUmU-.js";import{_ as Gt}from"./UserAvatar-CwDA-9dA.js";const At=t=>{const o="/TriP/";return t.startsWith("/")?o.endsWith("/")?o+t.slice(1):o+t:o.endsWith("/")?o+t:o+"/"+t},Ol=t=>At(`/images/presets/${t}.png`),I2=t=>At(`/images/classes/${t}.png`),Hl=t=>At(`/images/items/${t}.png`),P2=(t,o,a="base")=>At(`/images/races/${t}/${o}/${a}.png`),E2=t=>At(`/images/gender/${t}.png`),Wn=/^[a-z0-9]+(-[a-z0-9]+)*$/,Is=(t,o,a,l="")=>{const i=t.split(":");if(t.slice(0,1)==="@"){if(i.length<2||i.length>3)return null;l=i.shift().slice(1)}if(i.length>3||!i.length)return null;if(i.length>1){const E=i.pop(),g=i.pop(),b={provider:i.length>0?i[0]:l,prefix:g,name:E};return o&&!$s(b)?null:b}const d=i[0],v=d.split("-");if(v.length>1){const E={provider:l,prefix:v.shift(),name:v.join("-")};return o&&!$s(E)?null:E}if(a&&l===""){const E={provider:l,prefix:"",name:d};return o&&!$s(E,a)?null:E}return null},$s=(t,o)=>t?!!((o&&t.prefix===""||t.prefix)&&t.name):!1,qn=Object.freeze({left:0,top:0,width:16,height:16}),Ss=Object.freeze({rotate:0,vFlip:!1,hFlip:!1}),Ps=Object.freeze({...qn,...Ss}),Us=Object.freeze({...Ps,body:"",hidden:!1});function jl(t,o){const a={};!t.hFlip!=!o.hFlip&&(a.hFlip=!0),!t.vFlip!=!o.vFlip&&(a.vFlip=!0);const l=((t.rotate||0)+(o.rotate||0))%4;return l&&(a.rotate=l),a}function bn(t,o){const a=jl(t,o);for(const l in Us)l in Ss?l in t&&!(l in a)&&(a[l]=Ss[l]):l in o?a[l]=o[l]:l in t&&(a[l]=t[l]);return a}function zl(t,o){const a=t.icons,l=t.aliases||Object.create(null),i=Object.create(null);function d(v){if(a[v])return i[v]=[];if(!(v in i)){i[v]=null;const E=l[v]&&l[v].parent,g=E&&d(E);g&&(i[v]=[E].concat(g))}return i[v]}return Object.keys(a).concat(Object.keys(l)).forEach(d),i}function Ul(t,o,a){const l=t.icons,i=t.aliases||Object.create(null);let d={};function v(E){d=bn(l[E]||i[E],d)}return v(o),a.forEach(v),bn(t,d)}function Vn(t,o){const a=[];if(typeof t!="object"||typeof t.icons!="object")return a;t.not_found instanceof Array&&t.not_found.forEach(i=>{o(i,null),a.push(i)});const l=zl(t);for(const i in l){const d=l[i];d&&(o(i,Ul(t,i,d)),a.push(i))}return a}const Bl={provider:"",aliases:{},not_found:{},...qn};function Fs(t,o){for(const a in o)if(a in t&&typeof t[a]!=typeof o[a])return!1;return!0}function Xn(t){if(typeof t!="object"||t===null)return null;const o=t;if(typeof o.prefix!="string"||!t.icons||typeof t.icons!="object"||!Fs(t,Bl))return null;const a=o.icons;for(const i in a){const d=a[i];if(!i||typeof d.body!="string"||!Fs(d,Us))return null}const l=o.aliases||Object.create(null);for(const i in l){const d=l[i],v=d.parent;if(!i||typeof v!="string"||!a[v]&&!l[v]||!Fs(d,Us))return null}return o}const yn=Object.create(null);function Wl(t,o){return{provider:t,prefix:o,icons:Object.create(null),missing:new Set}}function Jt(t,o){const a=yn[t]||(yn[t]=Object.create(null));return a[o]||(a[o]=Wl(t,o))}function Yn(t,o){return Xn(o)?Vn(o,(a,l)=>{l?t.icons[a]=l:t.missing.add(a)}):[]}function ql(t,o,a){try{if(typeof a.body=="string")return t.icons[o]={...a},!0}catch{}return!1}let fs=!1;function Gn(t){return typeof t=="boolean"&&(fs=t),fs}function Vl(t){const o=typeof t=="string"?Is(t,!0,fs):t;if(o){const a=Jt(o.provider,o.prefix),l=o.name;return a.icons[l]||(a.missing.has(l)?null:void 0)}}function Xl(t,o){const a=Is(t,!0,fs);if(!a)return!1;const l=Jt(a.provider,a.prefix);return o?ql(l,a.name,o):(l.missing.add(a.name),!0)}function Yl(t,o){if(typeof t!="object")return!1;if(typeof o!="string"&&(o=t.provider||""),fs&&!o&&!t.prefix){let i=!1;return Xn(t)&&(t.prefix="",Vn(t,(d,v)=>{Xl(d,v)&&(i=!0)})),i}const a=t.prefix;if(!$s({prefix:a,name:"a"}))return!1;const l=Jt(o,a);return!!Yn(l,t)}const Kn=Object.freeze({width:null,height:null}),Qn=Object.freeze({...Kn,...Ss}),Gl=/(-?[0-9.]*[0-9]+[0-9.]*)/g,Kl=/^-?[0-9.]*[0-9]+[0-9.]*$/g;function xn(t,o,a){if(o===1)return t;if(a=a||100,typeof t=="number")return Math.ceil(t*o*a)/a;if(typeof t!="string")return t;const l=t.split(Gl);if(l===null||!l.length)return t;const i=[];let d=l.shift(),v=Kl.test(d);for(;;){if(v){const E=parseFloat(d);isNaN(E)?i.push(d):i.push(Math.ceil(E*o*a)/a)}else i.push(d);if(d=l.shift(),d===void 0)return i.join("");v=!v}}function Ql(t,o="defs"){let a="";const l=t.indexOf("<"+o);for(;l>=0;){const i=t.indexOf(">",l),d=t.indexOf("</"+o);if(i===-1||d===-1)break;const v=t.indexOf(">",d);if(v===-1)break;a+=t.slice(i+1,d).trim(),t=t.slice(0,l).trim()+t.slice(v+1)}return{defs:a,content:t}}function Zl(t,o){return t?"<defs>"+t+"</defs>"+o:o}function Jl(t,o,a){const l=Ql(t);return Zl(l.defs,o+l.content+a)}const ea=t=>t==="unset"||t==="undefined"||t==="none";function ta(t,o){const a={...Ps,...t},l={...Qn,...o},i={left:a.left,top:a.top,width:a.width,height:a.height};let d=a.body;[a,l].forEach(Z=>{const j=[],oe=Z.hFlip,ie=Z.vFlip;let ne=Z.rotate;oe?ie?ne+=2:(j.push("translate("+(i.width+i.left).toString()+" "+(0-i.top).toString()+")"),j.push("scale(-1 1)"),i.top=i.left=0):ie&&(j.push("translate("+(0-i.left).toString()+" "+(i.height+i.top).toString()+")"),j.push("scale(1 -1)"),i.top=i.left=0);let O;switch(ne<0&&(ne-=Math.floor(ne/4)*4),ne=ne%4,ne){case 1:O=i.height/2+i.top,j.unshift("rotate(90 "+O.toString()+" "+O.toString()+")");break;case 2:j.unshift("rotate(180 "+(i.width/2+i.left).toString()+" "+(i.height/2+i.top).toString()+")");break;case 3:O=i.width/2+i.left,j.unshift("rotate(-90 "+O.toString()+" "+O.toString()+")");break}ne%2===1&&(i.left!==i.top&&(O=i.left,i.left=i.top,i.top=O),i.width!==i.height&&(O=i.width,i.width=i.height,i.height=O)),j.length&&(d=Jl(d,'<g transform="'+j.join(" ")+'">',"</g>"))});const v=l.width,E=l.height,g=i.width,b=i.height;let I,M;v===null?(M=E===null?"1em":E==="auto"?b:E,I=xn(M,g/b)):(I=v==="auto"?g:v,M=E===null?xn(I,b/g):E==="auto"?b:E);const R={},T=(Z,j)=>{ea(j)||(R[Z]=j.toString())};T("width",I),T("height",M);const F=[i.left,i.top,g,b];return R.viewBox=F.join(" "),{attributes:R,viewBox:F,body:d}}const sa=/\sid="(\S+)"/g,na="IconifyId"+Date.now().toString(16)+(Math.random()*16777216|0).toString(16);let la=0;function aa(t,o=na){const a=[];let l;for(;l=sa.exec(t);)a.push(l[1]);if(!a.length)return t;const i="suffix"+(Math.random()*16777216|Date.now()).toString(16);return a.forEach(d=>{const v=typeof o=="function"?o(d):o+(la++).toString(),E=d.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");t=t.replace(new RegExp('([#;"])('+E+')([")]|\\.[a-z])',"g"),"$1"+v+i+"$3")}),t=t.replace(new RegExp(i,"g"),""),t}const Bs=Object.create(null);function oa(t,o){Bs[t]=o}function Ws(t){return Bs[t]||Bs[""]}function Gs(t){let o;if(typeof t.resources=="string")o=[t.resources];else if(o=t.resources,!(o instanceof Array)||!o.length)return null;return{resources:o,path:t.path||"/",maxURL:t.maxURL||500,rotate:t.rotate||750,timeout:t.timeout||5e3,random:t.random===!0,index:t.index||0,dataAfterTimeout:t.dataAfterTimeout!==!1}}const Ks=Object.create(null),rs=["https://api.simplesvg.com","https://api.unisvg.com"],Cs=[];for(;rs.length>0;)rs.length===1||Math.random()>.5?Cs.push(rs.shift()):Cs.push(rs.pop());Ks[""]=Gs({resources:["https://api.iconify.design"].concat(Cs)});function ia(t,o){const a=Gs(o);return a===null?!1:(Ks[t]=a,!0)}function Qs(t){return Ks[t]}const ra=()=>{let t;try{if(t=fetch,typeof t=="function")return t}catch{}};let kn=ra();function ca(t,o){const a=Qs(t);if(!a)return 0;let l;if(!a.maxURL)l=0;else{let i=0;a.resources.forEach(v=>{i=Math.max(i,v.length)});const d=o+".json?icons=";l=a.maxURL-i-a.path.length-d.length}return l}function da(t){return t===404}const ua=(t,o,a)=>{const l=[],i=ca(t,o),d="icons";let v={type:d,provider:t,prefix:o,icons:[]},E=0;return a.forEach((g,b)=>{E+=g.length+1,E>=i&&b>0&&(l.push(v),v={type:d,provider:t,prefix:o,icons:[]},E=g.length),v.icons.push(g)}),l.push(v),l};function fa(t){if(typeof t=="string"){const o=Qs(t);if(o)return o.path}return"/"}const va=(t,o,a)=>{if(!kn){a("abort",424);return}let l=fa(o.provider);switch(o.type){case"icons":{const d=o.prefix,E=o.icons.join(","),g=new URLSearchParams({icons:E});l+=d+".json?"+g.toString();break}case"custom":{const d=o.uri;l+=d.slice(0,1)==="/"?d.slice(1):d;break}default:a("abort",400);return}let i=503;kn(t+l).then(d=>{const v=d.status;if(v!==200){setTimeout(()=>{a(da(v)?"abort":"next",v)});return}return i=501,d.json()}).then(d=>{if(typeof d!="object"||d===null){setTimeout(()=>{d===404?a("abort",d):a("next",i)});return}setTimeout(()=>{a("success",d)})}).catch(()=>{a("next",i)})},ma={prepare:ua,send:va};function pa(t){const o={loaded:[],missing:[],pending:[]},a=Object.create(null);t.sort((i,d)=>i.provider!==d.provider?i.provider.localeCompare(d.provider):i.prefix!==d.prefix?i.prefix.localeCompare(d.prefix):i.name.localeCompare(d.name));let l={provider:"",prefix:"",name:""};return t.forEach(i=>{if(l.name===i.name&&l.prefix===i.prefix&&l.provider===i.provider)return;l=i;const d=i.provider,v=i.prefix,E=i.name,g=a[d]||(a[d]=Object.create(null)),b=g[v]||(g[v]=Jt(d,v));let I;E in b.icons?I=o.loaded:v===""||b.missing.has(E)?I=o.missing:I=o.pending;const M={provider:d,prefix:v,name:E};I.push(M)}),o}function Zn(t,o){t.forEach(a=>{const l=a.loaderCallbacks;l&&(a.loaderCallbacks=l.filter(i=>i.id!==o))})}function ha(t){t.pendingCallbacksFlag||(t.pendingCallbacksFlag=!0,setTimeout(()=>{t.pendingCallbacksFlag=!1;const o=t.loaderCallbacks?t.loaderCallbacks.slice(0):[];if(!o.length)return;let a=!1;const l=t.provider,i=t.prefix;o.forEach(d=>{const v=d.icons,E=v.pending.length;v.pending=v.pending.filter(g=>{if(g.prefix!==i)return!0;const b=g.name;if(t.icons[b])v.loaded.push({provider:l,prefix:i,name:b});else if(t.missing.has(b))v.missing.push({provider:l,prefix:i,name:b});else return a=!0,!0;return!1}),v.pending.length!==E&&(a||Zn([t],d.id),d.callback(v.loaded.slice(0),v.missing.slice(0),v.pending.slice(0),d.abort))})}))}let ga=0;function ba(t,o,a){const l=ga++,i=Zn.bind(null,a,l);if(!o.pending.length)return i;const d={id:l,icons:o,callback:t,abort:i};return a.forEach(v=>{(v.loaderCallbacks||(v.loaderCallbacks=[])).push(d)}),i}function ya(t,o=!0,a=!1){const l=[];return t.forEach(i=>{const d=typeof i=="string"?Is(i,o,a):i;d&&l.push(d)}),l}var xa={resources:[],index:0,timeout:2e3,rotate:750,random:!1,dataAfterTimeout:!1};function ka(t,o,a,l){const i=t.resources.length,d=t.random?Math.floor(Math.random()*i):t.index;let v;if(t.random){let D=t.resources.slice(0);for(v=[];D.length>1;){const r=Math.floor(Math.random()*D.length);v.push(D[r]),D=D.slice(0,r).concat(D.slice(r+1))}v=v.concat(D)}else v=t.resources.slice(d).concat(t.resources.slice(0,d));const E=Date.now();let g="pending",b=0,I,M=null,R=[],T=[];typeof l=="function"&&T.push(l);function F(){M&&(clearTimeout(M),M=null)}function Z(){g==="pending"&&(g="aborted"),F(),R.forEach(D=>{D.status==="pending"&&(D.status="aborted")}),R=[]}function j(D,r){r&&(T=[]),typeof D=="function"&&T.push(D)}function oe(){return{startTime:E,payload:o,status:g,queriesSent:b,queriesPending:R.length,subscribe:j,abort:Z}}function ie(){g="failed",T.forEach(D=>{D(void 0,I)})}function ne(){R.forEach(D=>{D.status==="pending"&&(D.status="aborted")}),R=[]}function O(D,r,h){const _=r!=="success";switch(R=R.filter(P=>P!==D),g){case"pending":break;case"failed":if(_||!t.dataAfterTimeout)return;break;default:return}if(r==="abort"){I=h,ie();return}if(_){I=h,R.length||(v.length?S():ie());return}if(F(),ne(),!t.random){const P=t.resources.indexOf(D.resource);P!==-1&&P!==t.index&&(t.index=P)}g="completed",T.forEach(P=>{P(h)})}function S(){if(g!=="pending")return;F();const D=v.shift();if(D===void 0){if(R.length){M=setTimeout(()=>{F(),g==="pending"&&(ne(),ie())},t.timeout);return}ie();return}const r={status:"pending",resource:D,callback:(h,_)=>{O(r,h,_)}};R.push(r),b++,M=setTimeout(S,t.rotate),a(D,o,r.callback)}return setTimeout(S),oe}function Jn(t){const o={...xa,...t};let a=[];function l(){a=a.filter(E=>E().status==="pending")}function i(E,g,b){const I=ka(o,E,g,(M,R)=>{l(),b&&b(M,R)});return a.push(I),I}function d(E){return a.find(g=>E(g))||null}return{query:i,find:d,setIndex:E=>{o.index=E},getIndex:()=>o.index,cleanup:l}}function wn(){}const Rs=Object.create(null);function wa(t){if(!Rs[t]){const o=Qs(t);if(!o)return;const a=Jn(o),l={config:o,redundancy:a};Rs[t]=l}return Rs[t]}function _a(t,o,a){let l,i;if(typeof t=="string"){const d=Ws(t);if(!d)return a(void 0,424),wn;i=d.send;const v=wa(t);v&&(l=v.redundancy)}else{const d=Gs(t);if(d){l=Jn(d);const v=t.resources?t.resources[0]:"",E=Ws(v);E&&(i=E.send)}}return!l||!i?(a(void 0,424),wn):l.query(o,i,a)().abort}function _n(){}function $a(t){t.iconsLoaderFlag||(t.iconsLoaderFlag=!0,setTimeout(()=>{t.iconsLoaderFlag=!1,ha(t)}))}function Ca(t){const o=[],a=[];return t.forEach(l=>{(l.match(Wn)?o:a).push(l)}),{valid:o,invalid:a}}function cs(t,o,a){function l(){const i=t.pendingIcons;o.forEach(d=>{i&&i.delete(d),t.icons[d]||t.missing.add(d)})}if(a&&typeof a=="object")try{if(!Yn(t,a).length){l();return}}catch(i){console.error(i)}l(),$a(t)}function $n(t,o){t instanceof Promise?t.then(a=>{o(a)}).catch(()=>{o(null)}):o(t)}function Ta(t,o){t.iconsToLoad?t.iconsToLoad=t.iconsToLoad.concat(o).sort():t.iconsToLoad=o,t.iconsQueueFlag||(t.iconsQueueFlag=!0,setTimeout(()=>{t.iconsQueueFlag=!1;const{provider:a,prefix:l}=t,i=t.iconsToLoad;if(delete t.iconsToLoad,!i||!i.length)return;const d=t.loadIcon;if(t.loadIcons&&(i.length>1||!d)){$n(t.loadIcons(i,l,a),I=>{cs(t,i,I)});return}if(d){i.forEach(I=>{const M=d(I,l,a);$n(M,R=>{const T=R?{prefix:l,icons:{[I]:R}}:null;cs(t,[I],T)})});return}const{valid:v,invalid:E}=Ca(i);if(E.length&&cs(t,E,null),!v.length)return;const g=l.match(Wn)?Ws(a):null;if(!g){cs(t,v,null);return}g.prepare(a,l,v).forEach(I=>{_a(a,I,M=>{cs(t,I.icons,M)})})}))}const Sa=(t,o)=>{const a=ya(t,!0,Gn()),l=pa(a);if(!l.pending.length){let g=!0;return o&&setTimeout(()=>{g&&o(l.loaded,l.missing,l.pending,_n)}),()=>{g=!1}}const i=Object.create(null),d=[];let v,E;return l.pending.forEach(g=>{const{provider:b,prefix:I}=g;if(I===E&&b===v)return;v=b,E=I,d.push(Jt(b,I));const M=i[b]||(i[b]=Object.create(null));M[I]||(M[I]=[])}),l.pending.forEach(g=>{const{provider:b,prefix:I,name:M}=g,R=Jt(b,I),T=R.pendingIcons||(R.pendingIcons=new Set);T.has(M)||(T.add(M),i[b][I].push(M))}),d.forEach(g=>{const b=i[g.provider][g.prefix];b.length&&Ta(g,b)}),o?ba(o,l,d):_n};function Ia(t,o){const a={...t};for(const l in o){const i=o[l],d=typeof i;l in Kn?(i===null||i&&(d==="string"||d==="number"))&&(a[l]=i):d===typeof a[l]&&(a[l]=l==="rotate"?i%4:i)}return a}const Pa=/[\s,]+/;function Ea(t,o){o.split(Pa).forEach(a=>{switch(a.trim()){case"horizontal":t.hFlip=!0;break;case"vertical":t.vFlip=!0;break}})}function Ma(t,o=0){const a=t.replace(/^-?[0-9.]*/,"");function l(i){for(;i<0;)i+=4;return i%4}if(a===""){const i=parseInt(t);return isNaN(i)?0:l(i)}else if(a!==t){let i=0;switch(a){case"%":i=25;break;case"deg":i=90}if(i){let d=parseFloat(t.slice(0,t.length-a.length));return isNaN(d)?0:(d=d/i,d%1===0?l(d):0)}}return o}function Aa(t,o){let a=t.indexOf("xlink:")===-1?"":' xmlns:xlink="http://www.w3.org/1999/xlink"';for(const l in o)a+=" "+l+'="'+o[l]+'"';return'<svg xmlns="http://www.w3.org/2000/svg"'+a+">"+t+"</svg>"}function Da(t){return t.replace(/"/g,"'").replace(/%/g,"%25").replace(/#/g,"%23").replace(/</g,"%3C").replace(/>/g,"%3E").replace(/\s+/g," ")}function Na(t){return"data:image/svg+xml,"+Da(t)}function La(t){return'url("'+Na(t)+'")'}const Cn={...Qn,inline:!1},Fa={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink","aria-hidden":!0,role:"img"},Ra={display:"inline-block"},qs={backgroundColor:"currentColor"},el={backgroundColor:"transparent"},Tn={Image:"var(--svg)",Repeat:"no-repeat",Size:"100% 100%"},Sn={webkitMask:qs,mask:qs,background:el};for(const t in Sn){const o=Sn[t];for(const a in Tn)o[t+a]=Tn[a]}const Ts={};["horizontal","vertical"].forEach(t=>{const o=t.slice(0,1)+"Flip";Ts[t+"-flip"]=o,Ts[t.slice(0,1)+"-flip"]=o,Ts[t+"Flip"]=o});function In(t){return t+(t.match(/^[-0-9.]+$/)?"px":"")}const Pn=(t,o)=>{const a=Ia(Cn,o),l={...Fa},i=o.mode||"svg",d={},v=o.style,E=typeof v=="object"&&!(v instanceof Array)?v:{};for(let Z in o){const j=o[Z];if(j!==void 0)switch(Z){case"icon":case"style":case"onLoad":case"mode":case"ssr":break;case"inline":case"hFlip":case"vFlip":a[Z]=j===!0||j==="true"||j===1;break;case"flip":typeof j=="string"&&Ea(a,j);break;case"color":d.color=j;break;case"rotate":typeof j=="string"?a[Z]=Ma(j):typeof j=="number"&&(a[Z]=j);break;case"ariaHidden":case"aria-hidden":j!==!0&&j!=="true"&&delete l["aria-hidden"];break;default:{const oe=Ts[Z];oe?(j===!0||j==="true"||j===1)&&(a[oe]=!0):Cn[Z]===void 0&&(l[Z]=j)}}}const g=ta(t,a),b=g.attributes;if(a.inline&&(d.verticalAlign="-0.125em"),i==="svg"){l.style={...d,...E},Object.assign(l,b);let Z=0,j=o.id;return typeof j=="string"&&(j=j.replace(/-/g,"_")),l.innerHTML=aa(g.body,j?()=>j+"ID"+Z++:"iconifyVue"),gn("svg",l)}const{body:I,width:M,height:R}=t,T=i==="mask"||(i==="bg"?!1:I.indexOf("currentColor")!==-1),F=Aa(I,{...b,width:M+"",height:R+""});return l.style={...d,"--svg":La(F),width:In(b.width),height:In(b.height),...Ra,...T?qs:el,...E},gn("span",l)};Gn(!0);oa("",ma);if(typeof document<"u"&&typeof window<"u"){const t=window;if(t.IconifyPreload!==void 0){const o=t.IconifyPreload,a="Invalid IconifyPreload syntax.";typeof o=="object"&&o!==null&&(o instanceof Array?o:[o]).forEach(l=>{try{(typeof l!="object"||l===null||l instanceof Array||typeof l.icons!="object"||typeof l.prefix!="string"||!Yl(l))&&console.error(a)}catch{console.error(a)}})}if(t.IconifyProviders!==void 0){const o=t.IconifyProviders;if(typeof o=="object"&&o!==null)for(let a in o){const l="IconifyProviders["+a+"] is invalid.";try{const i=o[a];if(typeof i!="object"||!i||i.resources===void 0)continue;ia(a,i)||console.error(l)}catch{console.error(l)}}}}const Oa={...Ps,body:""},K=El((t,{emit:o})=>{const a=Q(null);function l(){var b,I;a.value&&((I=(b=a.value).abort)==null||I.call(b),a.value=null)}const i=Q(!!t.ssr),d=Q(""),v=Ml(null);function E(){const b=t.icon;if(typeof b=="object"&&b!==null&&typeof b.body=="string")return d.value="",{data:b};let I;if(typeof b!="string"||(I=Is(b,!1,!0))===null)return null;let M=Vl(I);if(!M){const F=a.value;return(!F||F.name!==b)&&(M===null?a.value={name:b}:a.value={name:b,abort:Sa([I],g)}),null}l(),d.value!==b&&(d.value=b,Mt(()=>{o("load",b)}));const R=t.customise;if(R){M=Object.assign({},M);const F=R(M.body,I.name,I.prefix,I.provider);typeof F=="string"&&(M.body=F)}const T=["iconify"];return I.prefix!==""&&T.push("iconify--"+I.prefix),I.provider!==""&&T.push("iconify--"+I.provider),{data:M,classes:T}}function g(){var I;const b=E();b?b.data!==((I=v.value)==null?void 0:I.data)&&(v.value=b):v.value=null}return i.value?g():Ut(()=>{i.value=!0,g()}),Qt(()=>t.icon,g),Xs(l),()=>{const b=v.value;if(!b)return Pn(Oa,t);let I=t;return b.classes&&(I={...t,class:b.classes.join(" ")}),Pn({...Ps,...b.data},I)}},{props:["icon","mode","ssr","width","height","style","color","inline","rotate","hFlip","horizontalFlip","vFlip","verticalFlip","flip","id","ariaHidden","customise","title"],emits:["load"]}),Ha=[{id:"war",name:"Война",nameEn:"War",description:"Физическая сила, боевые навыки, агрессия и доминирование",characteristic:{name:"Мощь",nameEn:"Might",abbreviation:"MIG"},check:{name:"Конфликт",nameEn:"Conflict",description:"Проверки прямого противостояния, боя и физической силы"},mode:{name:"Напористо",nameEn:"Assertive",icon:"game-icons:fist",description:"Действуйте решительно и прямолинейно",bonuses:[]},color:"#dc2626",colorName:"red",icon:"game-icons:crossed-swords",characteristicIcon:"game-icons:embrassed-energy",checkIcon:"game-icons:arrow-scope",position:{angle:330,corner:"top-left",description:"Верхний левый угол шестиугольника"},neighbors:["nature","knowledge"],opposite:"shadow",axis:{id:"power",name:"Сила",nameEn:"Power",pole:"active"},traits:[{id:"firstStrike",name:"Первый удар",levels:[{text:"Противник не может отреагировать на Ваше передвижение, если Вы атакуете сразу после сближения. Тем не менее, он может отреагировать после.",effect:{}},{text:"Противник, по которому Вы попали после сближения, теряет один порыв прямо перед атакой. Если у него не оставалось порывов, его защита ниже на одну категорию до конца Вашей атаки.",effect:{}},{text:"Противник, которого Вы атакуете сразу после сближения, теряет два порыва и не может отреагировать даже после атаки. Если у него не хватает порывов, он теряет по одной категории защиты за каждый, эффект длится до начала Вашего следующего хода",effect:{}}]},{id:"flurryOfBlows",name:"Шквал ударов",levels:[{text:"Потратив два порыва, Вы можете провести одну атаку.",effect:{}},{text:"Потратив два порыва, Вы можете провести одну атаку, при этом Вы добавляете к броску кость порыва.",effect:{}},{text:"В свой ход Вы можете проводить дополнительную атаку, затратив всего одну кость порыва. Кость порыва к броску при этом не добавляется.",effect:{}}]},{id:"suppression",name:"Подавление",levels:[{text:"Ваши атаки мешают противнику действовать, даже если они не попадают по цели. Тот, кого Вы атаковали в свой ход с порывом считается подавленным до конца Вашего следующего хода. Он получает штраф к передвижению в одну клетку, атаке и защите - в одну категорию. Эти штрафы не складываются.",effect:{}},{text:"Противнику приходится тратить всё больше времени и внимания, чтобы бороться с Вашим напором. Каждая атака с порывом по уже подавленному противнику забирает у него один порыв (если он есть), или понижает защиту на две категории вместо одной (если порывы закончились)",effect:{}},{text:"Вы достигли мастерства в подавлении противника. Вам больше не обязательно вкладывать порывы в свои атаки, чтобы подавление сработало.",effect:{}}]}]},{id:"knowledge",name:"Знание",nameEn:"Knowledge",description:"Интеллект, логика, наука и аналитическое мышление",characteristic:{name:"Разум",nameEn:"Reason",abbreviation:"REA"},check:{name:"Порядок",nameEn:"Order",description:"Проверки знаний, логики и систематического подхода"},mode:{name:"Рассудительно",nameEn:"Deliberate",icon:"game-icons:brain",description:"Анализируйте и планируйте каждый шаг",bonuses:[]},color:"#3b82f7",colorName:"blue",icon:"game-icons:open-book",characteristicIcon:"game-icons:inspiration",checkIcon:"game-icons:materials-science",position:{angle:30,corner:"top-right",description:"Верхний правый угол шестиугольника"},neighbors:["war","community"],opposite:"mysticism",axis:{id:"progress",name:"Развитие",nameEn:"Progress",pole:"rational"},traits:[{id:"education",name:"Образование",levels:[{text:"Получив хорошую обучающую книгу о каком-то навыке, Вы можете научиться его первому уровню, затратив на это не менее месяца времени. Обучение обойдётся Вам в одно очко повышения, если у Вас нет необходимого класса или бесплатно, если он есть. Вы не можете таким образом изучать навыки противоположных аспектов (или их смежные)",effect:{}},{text:"Найдя хорошего мастера навыка (владеющего его третьей ступенью), Вы можете научиться второму уровню. На это Вам и Вашему учителю придётся потратить как минимум месяц времени. Это обойдётся Вам в два очка повышения, если у Вас нет необходимого класса или бесплатно, если он есть.",effect:{}},{text:'Вы можете обучать других тем навыкам, которыми владеете сами. Вам и Вашему ученику потребуется не менее месяца, а обучаемый так же потратит одно очко повышения за уровень навыка, если у него нет необходимого класса. Вашему ученику не обязательно иметь навык "Образование". На этом уровне Вы можете обучаться навыкам противоположных аспектов.',effect:{}}]},{id:"quickWit",name:"Живой ум",levels:[{text:"Ваш пытливый ум позволяет Вам быстрее разбираться в любых сферах знаний, которыми владеют разумные. Поиск информации в книгах и библиотеках для Вас на две категории проще. Вы хорошо читаете карты, Вам на одну категорию проще планировать маршрут так, чтобы избежать опасностей или выйти на желаемую точку боевой карты.",effect:{}},{text:"Вы постоянно подмечаете и запоминаете, Ваш разум анализирует и раскладывает по полочкам. Если Вы видите за работой специалиста гражданского профиля на протяжении хотя бы нескольких часов, все Ваши проверки по его профессии впоследствии на одну категорию проще. Если он взялся обучать Вас и на это был затрачен хотя бы один день, проверки на две категории проще. Кроме того, Вы хорошо разбираетесь в общеизвестной истории, в курсе новейших открытий и изобретений.",effect:{}},{text:"Вы знаете и понимаете так много, что зачастую можете дать полезную подсказку даже хорошему специалисту. Если он готов принять Вашу помощь и делится своими планами или соображениями, Вы можете снизить сложность проверки на одну категорию или даже на две, если область знания принадлежит Вашему классу или смежному.",effect:{}}]},{id:"inMasterHands",name:"В руках мастера",levels:[{text:"Пока для других механизмы - просто инструмент достижения целей, для Вас это ещё и загадка, которую хочется разгадать. Починка механических устройств и обезвреживание механических ловушек с Вашей помощью легче на две категории. Кроме того, Вы можете потратить некоторое время на то, чтобы аккуратно разобрать устройство и понять, как создавать подобные в будущем. Для этого Вам нужно будет пройти проверку, тем более сложную, чем более сложное оборудование Вы разбираете. Это умение не распространяется на магические предметы и артефакты.",effect:{}},{text:"Большой опыт в работе с различными механизмами дал свои плоды - затратив достаточно времени Вы можете сами изобрести некое механическое устройство. Придуманный Вами предмет должен быть принципиально возможным в этом мире и должен опережать технический уровень общества не слишком сильно. Сложность проверки для попытки изобрести нечто определяется мастером. Теперь Вы можете разбирать чтобы изучить и магические предметы, а также Ваш бонус на починку и обезвреживание теперь распространяется и на магические устройства и ловушки. Вы можете создавать простые механические ловушки.",effect:{}},{text:"Теперь Вы можете изобретать и магические устройства и ловушки. Ваше глубокое понимание магии также даёт Вам значительный бонус к заклинаниям - теперь вызов заклинания основным действием всегда работает так, как будто Вы так же затратили один порыв.",effect:{}}]}]},{id:"community",name:"Общество",nameEn:"Community",description:"Социальные связи, лидерство, убеждение и дипломатия",characteristic:{name:"Харизма",nameEn:"Charisma",abbreviation:"CHA"},check:{name:"Влияние",nameEn:"Influence",description:"Проверки социального взаимодействия и убеждения"},mode:{name:"Выразительно",nameEn:"Expressive",icon:"game-icons:conversation",description:"Общайтесь открыто и убедительно",bonuses:[]},color:"#f59e0b",colorName:"amber",icon:"game-icons:human-pyramid",characteristicIcon:"game-icons:cheerful",checkIcon:"game-icons:caesar",position:{angle:90,corner:"right",description:"Правый угол шестиугольника"},neighbors:["knowledge","shadow"],opposite:"nature",axis:{id:"path",name:"Путь",nameEn:"Path",pole:"civilization"},traits:[{id:"everythingSells",name:"Всё продаётся",levels:[{text:"Вы тонко чувствуете потребности окружающих и что они готовы отдать за желаемое. Если Вы пытаетесь выяснить мотивацию персонажа или распознать ложь, Ваши проверки на две категории проще (6). Занимаясь любой работой, Вы можете подняться на одну ступень Богатства выше, чем остальные. Скорость набора Богатства, впрочем, остаётся прежней. Если Вы живёте в городе, Ваш уровень Богатства никогда не опускается ниже Среднего (5)",effect:{}},{text:"Продавая добычу после боевого похода Вы можете выручить на две категории больше. Занимаясь любой работой, Вы набираете Богатство вдвое быстрее других.",effect:{}},{text:"Один раз в месяц Вы можете покупать предмет выше своего уровня Богатства на 1 без затрат, либо на 2 уровня, потеряв при этом только один уровень Богатства",effect:{}}]},{id:"strongConnections",name:"Прочные связи",levels:[{text:"Большинство окружающих, которым Вы не чинили явного зла, считают Вас как минимум приятелем (Симпатия, 1). Вы знаете как найти выходы на всех влиятельных людей Вашего поселения, а также можете за несколько дней найти общих знакомых с специалистом какой-то профессии, если он есть в Вашем поселении. Вы можете давать взятки на одну категорию меньшие, чтобы добиться того же эффекта.",effect:{}},{text:"Проведя хотя бы три месяца в поселении, Вы обретаете влияние, с которым приходится считаться. Ваши просьбы и угрозы звучат гораздо весомее. Вам также значительно проще искать что-то в обществе - будь это скрывающийся человек или особый товар. Проверки проще на две категории (6). Даже если Вам не удаётся найти искомое, велика вероятность что Вам дадут хотя бы наводку на того, кто может знать ответ. Помогать Вам будут только те силы и фракции, с которыми Вы как минимум не враждуете. Затраты Влияния на значительные услуги снижены на одну категорию.",effect:{}},{text:"Если Вы проводите в поселении хотя бы полгода, Вам удаётся наладить контакт со всеми лидерами фракций (Значительное Влияние, 3) кроме тех что к Вам враждебны. Ваше Влияние на фракции растёт с удвоенной скоростью и никогда не опускается ниже Значительного (3). Когда Вы впервые посещаете поселения, которые активно контактируют с Вашим, Вы сразу получаете преимущества второго уровня этого умения. Преимущества третьего Вы можете получить, проведя в нём месяц. Вам легче внедрять свои задумки в другие фракции, ведь во всех (даже во враждебных) у Вас есть свои люди. Эти проверки проще на две категории.",effect:{}}]},{id:"friendOfAFriend",name:"Друг моего друга",levels:[{text:"Имея как минимум Высокое (5) влияние на фракцию, Вы можете попросить их порекомендовать Вас кому-то. При этом Вы потратите два уровня Репутации, но приобретёте один у цели. Для этого Ваша цель должна быть в хороших отношениях с фракцией.",effect:{}},{text:"Вам удаётся поддерживать связь даже со знакомыми в других поселениях и государствах. Вы можете найти знакомого или знакомого знакомого почти в любом крупном поселении. В результате Ваши проверки на Поиск в других поселениях проще на две категории. Кроме того, Вы получаете информацию и новости из далёких земель значительно раньше других.",effect:{}},{text:"Ваш круг знакомых и друзей превращается в настоящую паутину. Ваша Репутация у невраждебных фракций в других поселениях как минимум Неплохая (2), проверки на Порядок и Диверсию проще на категорию. Если Ваш уровень Богатства как минимум Зажиточный (7), проверки становятся проще ещё на одну категорию.",effect:{}}]}]},{id:"shadow",name:"Тень",nameEn:"Shadow",description:"Скрытность, обман, манипуляция и тайные действия",characteristic:{name:"Хитрость",nameEn:"Cunning",abbreviation:"CUN"},check:{name:"Коварство",nameEn:"Treachery",description:"Проверки скрытности, обмана и манипуляций"},mode:{name:"Скрытно",nameEn:"Stealthy",icon:"game-icons:ninja-mask",description:"Действуйте незаметно и осторожно",bonuses:[]},color:"#374151",colorName:"gray",icon:"game-icons:cowled",characteristicIcon:"game-icons:domino-mask",checkIcon:"game-icons:hooded-figure",position:{angle:150,corner:"bottom-right",description:"Нижний правый угол шестиугольника"},neighbors:["community","mysticism"],opposite:"war",axis:{id:"power",name:"Сила",nameEn:"Power",pole:"subtle"},traits:[{id:"cunningPlan",name:"Хитрый план",levels:[{text:"Один раз в месяц Вы можете добавить облегчить свою проверку социального Влияния, используя свою Хитрость. Сложность снижается на одну категорию за каждые три полные единицы в параметре Хитрость. Есть некая верятность, что местные власти сочтут Ваши действия незаконными.",effect:{}},{text:"Вы можете использовать эту способность два раза в месяц.",effect:{}},{text:"Теперь Вы можете использовать эту способность на проверках Диверсии",effect:{}}]},{id:"militaryCunning",name:"Военная хитрость",levels:[{text:"Проводя первую атаку по противнику за свой ход, Вы добавляете к броску кость порыва, не затрачивая порыв, если сразу после этого разрываете дистанцию (ближний бой) или скрываетесь из виду (дальний бой).",effect:{}},{text:"Вы учитесь использовать быстрый отскок - затратив один порыв, Вы можете отскочить назад на две клетки. Такое действие не вызывает срабатывания реакций.",effect:{}},{text:"В бою Вы можете двигаться боком с полной скоростью. Кроме того, если Вы видите как противник пытается атаковать Вас, Вы можете отреагировать за мгновение до этой атаки, если Ваша Защита превосходит его Атаку. Это распространяется даже на дистанционные атаки.",effect:{}}]},{id:"floatLikeButterfly",name:"Порхай как бабочка",levels:[{text:"Вы научились наносить невероятно точные удары. Максимальное количество костей порыва, которые Вы можете использовать в броске атаки увеличивается до двух.",effect:{}},{text:"Ваша скорость передвижения увеличивается на единицу. Доступное Вам максимальное количество порывов также увеличивается на единицу.",effect:{}},{text:"Идеальный способ обезопасить себя - закончить бой одним невероятно точным ударом. Максимальное количество костей порыва, которые Вы можете использовать в броске атаки увеличивается до трёх.",effect:{}}]}]},{id:"mysticism",name:"Мистика",nameEn:"Mysticism",description:"Магия, духовность, интуиция и связь с потусторонним",characteristic:{name:"Интуиция",nameEn:"Intuition",abbreviation:"INT"},check:{name:"Хаос",nameEn:"Chaos",description:"Проверки магии, интуиции и духовной связи"},mode:{name:"Чутко",nameEn:"Intuitive",icon:"game-icons:third-eye",description:"Доверьтесь интуиции и предчувствиям",bonuses:[]},color:"#9333ea",colorName:"purple",icon:"game-icons:pentacle",characteristicIcon:"game-icons:coiling-curl",checkIcon:"game-icons:small-fire",position:{angle:210,corner:"bottom-left",description:"Нижний левый угол шестиугольника"},neighbors:["shadow","nature"],opposite:"knowledge",axis:{id:"progress",name:"Развитие",nameEn:"Progress",pole:"intuitive"},traits:[{id:"spiritualPractices",name:"Духовные практики",levels:[{text:"Вы чувствуете мир иначе чем другие и можете находить связь там где другие её не увидят. Вы можете повысить любую характеристику на 1, пока следуете некоторой духовной практике. Это может быть аскеза, обет, небольшой ежедневный ритуал. Объясните, как эта практика мистически связана с пользой, которую Вы получаете. Вы начинаете получать преимущества когда использовали практику как минимум месяц.",effect:{}},{text:"Вы можете одновременно получать пользу от двух духовных практик направленных на две разные характеристики, или от одной более сложной, повышающей характеристику на 2. В обоих случаях это уже не может быть чем-то небольшим, никак не влияющим на Ваш уровень комфорта.",effect:{}},{text:"Погружаясь в практики всё дальше, Вы можете использовать 3 очков повышения, распределив их как угодно по трём характеристикам, выбирая значения 1, 2 или 3. Такой уровень погружения требует значительных затрат времени и ресурсов, может вызывать непонимание в обществе и иногда создавать значительные проблемы.",effect:{}}]},{id:"impossibleKnowledge",name:"Невозможные знания",levels:[{text:"Иногда Вы просто знаете то, чего никак не могли знать. В боевых ситуациях один раз в день Вы можете задать вопрос, в ответ на который Вам явится подсказка. Вопрос должен касаться того, с чем Вы взаимодействуете или как минимум находитесь на расстоянии нескольких минут движения пешком. Подсказка должна быть правдивой, но не всегда будет точно отвечать на Ваш вопрос, иногда лишь касаться его косвенно.",effect:{}},{text:"Вы научились взывать к таинственному источнику знаний вселенной и вне напряжённых боевых ситуаций. Затратив месяц на поиск и обучение, Вы можете получить навык чужого аспекта или класса по обычной цене, а своего аспекта или класса - на одно очко дешевле. Вы всё ещё не можете изучать противоположные аспекты и их классы.",effect:{}},{text:"Направляя свой взор всё глубже внутрь себя Вы получаете всё больше знаний из таинственного источника. Любая местность для Вас - как минимум Знакомая (3). Теперь Вы можете задавать вопрос мирозданию до трёх раз в боевую сцену или за месяц другой деятельности. Вы можете потратить использование такого вопроса чтобы получить информацию о слабых местах противника, снижая его защиту от Ваших будущих атак на две категории или о слабых местах фракции или организации чтобы облегчить проверки Порядка или Диверсии на две категории",effect:{}}]},{id:"dropsOfOneSea",name:"Капли одного моря",levels:[{text:"Вы чувствуете необъяснимое родство с другими разумными, даже если Ваши взгляды и цели расходятся. Иногда Вы ощущаете небольшие отблески их мыслей и чувств, и умеете воспользоваться этим себе на пользу. Окружающие оценивают это как удачу, но Вы точно знаете что это навык, доступный немногим. Если на Вашем кубе д12 выпадает 3 или меньше в вопросах связанных с разумными, один раз за боевую сцену или за месяц другой деятельности Вы можете его перебросить.",effect:{}},{text:"Теперь Вы ощущаете подобное родство даже с дикими животными. Количество использований навыка увеличено до двух, а помимо разумных он теперь распространяется на любых живых существ.",effect:{}},{text:"Вы чувствуете мир вокруг как своё продолжение. Всё вокруг - лишь разные узоры на волнах единого моря реальности. Количество использований навыка увеличено до трёх, теперь Вы можете использовать его в любых проверках, в том числе связанных с магией, стихиями, духами и прочим.",effect:{}}]}]},{id:"nature",name:"Природа",nameEn:"Nature",description:"Связь с природой, выживание, животные инстинкты и гармония",characteristic:{name:"Восприятие",nameEn:"Perception",abbreviation:"PER"},check:{name:"Поиск",nameEn:"Search",description:"Проверки наблюдательности, выживания и связи с природой"},mode:{name:"Внимательно",nameEn:"Watchful",icon:"game-icons:eagle-emblem",description:"Наблюдайте и замечайте детали",bonuses:[]},color:"#22c55e",colorName:"green",icon:"game-icons:curled-leaf",characteristicIcon:"game-icons:semi-closed-eye",checkIcon:"game-icons:spyglass",position:{angle:270,corner:"left",description:"Левый угол шестиугольника"},neighbors:["mysticism","war"],opposite:"community",axis:{id:"path",name:"Путь",nameEn:"Path",pole:"wilderness"},traits:[{id:"lawsOfExistence",name:"Законы бытия",levels:[{text:"Вы принимаете природу вокруг себя - и она отвечает Вам тем же. Вы можете комфортно жить и выживать в диких условиях, если там вообще могут выживать разумные Вашего вида. На это Вам нужно тратить всё своё время, но вы не нуждаетесь в припасах, добывая их самостоятельно, а Ваше снаряжение почти не ветшает. При этом Вы изучаете данную местность с удвоенной скоростью.",effect:{}},{text:"Вы можете комфортно выживать даже в агрессивных средах, где разумные Вашего вида не живут (пустыни, пещеры и прочее подобное), но не в тех, которые обусловлены магическими эффектами. В обычной дикой местности (такой как лес или степь) Вы теперь можете выживать, практически не тратя на это времени. Скорость освоения местности так же удвоена.",effect:{}},{text:"Глубоко понимая порядки каждой экосистемы, Вы мастерски находите в них место для себя. Вы можете комфортно выживать даже в магических аномалиях, если это вообще возможно для существа с Вашими способностями. Вы должны тратить всё своё время на это только до уровня Изученная (5). Магические аномалии Вы изучаете с обычной скоростью.",effect:{}}]},{id:"ingredientGathering",name:"Сбор ингредиентов",levels:[{text:"Если Ваш уровень знания местности хотя бы 5, Вы можете каждый ход выращивать или собирать одну меру качественных немагических ингредиентов, характерных для этой местности, потратив на это всё своё время.",effect:{}},{text:"Вы можете собирать ингредиенты, не затрачивая на это времени, если живёте в этой местности.",effect:{}},{text:"Вы можете собирать качественные магические ингредиенты, в количестве двух мер за один ход, если живёте в этой местности.",effect:{}}]},{id:"likeAFishInWater",name:"Как рыба в воде",levels:[{text:"Если Ваш уровень знания местности как минимум 3, Вы получаете дополнительную скорость передвижения в 1 клетку.",effect:{}},{text:"Если Ваш уровень знания местности как минимум 5, Вы можете проходить через сложную местность без дополнительных трат передвижения. Подходящие объекты Вы также можете использовать как укрытия или подспорье в бою",effect:{}},{text:"Если Ваш уровень знания местности как минимум 7, вы получаете дополнительный порыв, а обнаружить Вас сложнее на три категории (9)",effect:{}}]}]}],ja=[{id:"power",name:"Сила",nameEn:"Power",description:"Ось силы: от прямой физической мощи до скрытого влияния",aspects:["war","shadow"],poles:{active:{aspect:"war",description:"Прямое действие, открытая сила, доминирование"},subtle:{aspect:"shadow",description:"Скрытое влияние, манипуляция, тайные действия"}}},{id:"progress",name:"Развитие",nameEn:"Progress",description:"Ось развития: от рационального познания до интуитивного понимания",aspects:["knowledge","mysticism"],poles:{rational:{aspect:"knowledge",description:"Логика, наука, аналитическое мышление"},intuitive:{aspect:"mysticism",description:"Интуиция, магия, духовное познание"}}},{id:"path",name:"Путь",nameEn:"Path",description:"Ось пути: от дикой природы до цивилизованного общества",aspects:["nature","community"],poles:{wilderness:{aspect:"nature",description:"Природа, инстинкты, гармония с окружением"},civilization:{aspect:"community",description:"Общество, культура, социальные структуры"}}}],za={systemName:"triP",systemFullName:"Triple P System",systemDescription:"Система трёх осей: Power (Сила), Progress (Развитие), Path (Путь)",version:"1.0",aspectCount:6,axisCount:3,circularOrder:["war","knowledge","community","shadow","mysticism","nature"]},kt={aspects:Ha,axes:ja,metadata:za},Ua=[{id:"scholar",name:{m:"Учёный",f:"Учёная"},nameEn:"Scholar",professions:[],aspects:["knowledge","nature"],traits:[{id:"knowNature",name:"Знание природы",levels:[{text:`:check:nature 1:easier
 Все проверки Поиска для Вас на одну категорию проще.`,effect:{}},{text:`2:check:nature в :turn
Вы можете выполнить две проверки Поиска вместо одной за каждый ход.`,effect:{}},{text:`2:check в :turn, :check:nature 2:easier
Вы можете выполнить любые две проверки одного типа вместо одной за каждый ход. Проверки Поиска проще на две категории`,effect:{}}]},{id:"knowEnemy",name:"Знание врага",levels:[{text:`:attack 1:easier если Вы ранили
Любые атаки по противникам, которых Вам уже удалось ранить - на одну категорию проще.`,effect:{}},{text:`:defence 1:easier если уже отражали
Если Вы успешно отбили удар противника, Ваша защита против него повышается на одну категорию, пока вы дееспособны`,effect:{}},{text:`:attack :defence 1:easier, если видели как ранят или защищаются от атак противника
Вам достаточно видеть как другие ранят противника или успешно отражают его удары, чтобы адаптироваться к ним и получить преимущества.`,effect:{}}]},{id:"constructor",name:"Конструктор",levels:[{text:"Вы получаете преимущество в две категории на создание предметов с помощью немагических ремёсел. В этот список входят самодельное оружие и доспехи, эликсиры и яды, особые боеприпасы, но не ловушки. Для создания Вам всё ещё нужен рецепт достаточного качества.",effect:{}},{text:"Вы можете подбирать рецепты самостоятельно, ориентируясь на найденные слухи и общеизвестную информацию. Для этого Вам нужно провести проверку Поиска или Влияния, если это уместно в данной ситуации",effect:{}},{text:"Вы можете сами создавать рецепты, изучая природные материалы. Проведя успешную проверку Поиска Вы можете узнать о свойствах того или иного материала и придумать ему применение. Проверка на первое создание предмета тем проще, чем более реалистичный у вас план. На усмотрение мастера",effect:{}}]}],edges:[{type:"aspect",id:"knowledge",cost:3},{type:"aspect",id:"nature",cost:3}]},{id:"mastermind",name:{m:"Комбинатор",f:"Комбинаторша"},nameEn:"Mastermind",professions:[],aspects:["shadow","community"],traits:[{id:"ambushMaster",name:"Засадный мастер",levels:[{text:"Вы можете подготовить хорошее место для засады, если потратите на это некоторое время. Противнику будет сложнее Вас обнаружить на две категории, а в случае успеха в первый ход все Ваши герои атакуют и защищаются на две категории эффективнее.",effect:{}},{text:"Если вы отражаете атаку, Вы можете пройти проверку Влияния (против разумных) или  Поиска (против зверей и монстров), чтобы симулировать тяжёлое ранение или даже смерть. Если Ваш обман не раскрыт, Вы можете получить преимущество в две категории на атаку, если наносите неожиданный удар в полную мощь.",effect:{}},{text:"Вы можете провести проверку Влияния (против разумных) или Поиска (против зверей и монстров), чтобы инициировать ложное отступление. Сложность её будет тем больше, чем меньше у Вас понятных врагу причин для отступления, на усмотрение мастера. В случае успеха Вы должны отходить назад один ход, увлекая противника за собой, а затем обрушиться на него снова, получая преимущества как от засады.",effect:{}}]},{id:"criminalSchemes",name:"Преступные схемы",levels:[{text:"Потратив не менее месяца на подготовку, Вы можете организовать серьёзное преступление в поселении. Это может быть кража, похищение или убийство влиятельного лица. Сложность проверки определяет мастер исходя из степени реалистичности Вашего плана. Вы можете отказаться от реализации плана, когда мастер объявил сложность. Выполнить задуманное нелегко, ещё сложнее - не попасться после.  Вероятность того, что кто-то выйдет на Ваш след, зависит от превышения проверки.",effect:{}},{text:"Потратив не менее месяца на подготовку, Вы можете инициировать войну между разными фракциями в пределах одного поселения. Потратив не менее трёх месяцев - глобальную вражду между глобальными фракциями, не менее шести - войну. Формат войны или вражды может быть разным, в зависимости от сути фракций, например, купеческие гильдии будут враждовать совсем не так, как гильдии воров. Ваши преступные планы на две категории эффективнее, если затрагивают интересы воюющих.",effect:{}},{text:"Проведя полгода в поселении, вы можете подчинить себе все его преступные организации, при этом оставаясь в тени. Они не знают Вас в лицо и не будут подчиняться напрямую, но дёргая за правильные ниточки Вы можете заставлять их делать то, что нужно Вам. Все проверки Влияния удаются Вам проще на три категории, а уровень Вашего влияния на эти организации не может опускаться ниже Крепкой Дружбы",effect:{}}]},{id:"noDistinctiveFeatures",name:"Без особых примет",levels:[{text:"Вы умеете затеряться в толпе, знаете толк в маскировке в поселениях разумных. Искать Вас сложнее на две категории, если Вы только не хотите быть найденным. Иначе - на две категории проще.",effect:{}},{text:"Ваше умение скрываться с глаз оказывается полезным и на поле боя. Вы умеете быть неприметным и не угрожающим. Если противник собирается атаковать Вас, когда имеет возможность бить по Вашему союзнику, Вы можете пройти проверку Влияния, чтобы переключить его внимание. На это не требуется никаких действий, Вы можете сделать это сколько угодно раз за ход, но каждая следующая проверка будет сложнее.",effect:{}},{text:"Если Вам удаётся переключить внимание противника на своего союзника - вы можете нанести неожиданную атаку по нему в самый неподходящий момент. Такая атака стоит один порыв, и может быть усилена, но выполняется только один раз за ход.",effect:{}}]}],edges:[{type:"aspect",id:"shadow",cost:2},{type:"aspect",id:"community",cost:4}]},{id:"weaponmaster",name:{m:"Оружейник",f:"Оружейница"},nameEn:"Weaponmaster",professions:[],aspects:["war","knowledge"],traits:[{id:"steelShines",name:"И сталь блестит",levels:[{text:"Вы знаете толк в боевом снаряжении и со всей скурпулёзностью подходите к его выбору. Ваша броня или один из наборов вооружения качественнее на целую категорию.",effect:{}},{text:"Прежде чем стать популярным, более эффективное оружие появляется на рынке в малом количестве. Используя свои связи (не менее 4 уровня) и деньги (не менее 7 уровня), Вы можете найти такие редкие образцы и пополнить свою коллекцию. Теперь более высоким качеством могут отличаться два набора вооружения, или один набор и броня.",effect:{}},{text:"Если вы привыкаете к оружию не менее месяца, необходимое превышение защиты за каждый вид травмы сокращается на единицу (мин 1). Кроме того, Вы можете использовать особые удары экзотического оружия без штрафов. Одновременно вы можете таким образом привыкнуть только к трём наборам снаряжения. ",effect:{}}]},{id:"mySword",name:"Таких мечей много, но этот - мой",levels:[{text:"Если Вы организуете что-то, связанное с оружием или вооружёнными людьми, Ваши проверки Порядка легче на две категории (6). Нанимать и вооружать отряд наёмников для Вас дешевле на одну категорию.",effect:{}},{text:"Вооружённые с Вашей помощью отряды защищаются и атакуют эффективнее на одну категорию.",effect:{}},{text:"Если Ваши товарищи по команде прислушиваются к Вашим советам, каждый может сделать один набор оружия или свою броню более эффективными (на одну категорию). На этом уровне Вы также получаете такое преимущество.",effect:{}}]},{id:"worthMoreThanGold",name:"Дороже золота",levels:[{text:"Оружие даёт силу, а сила - власть. Попадая в новые сообщества Вы сразу получаете как минимум Небольшое Влияние на воинское и дворянское сословие, если готовы демонстрировать своё превосходное снаряжение.",effect:{}},{text:"Внешний вид Вашего снаряжения заставляет нанимателей задуматься о цене за Ваши услуги. Если Вашему заказчику это по карману, он предложит на одну категорию более высокую оплату. Если нет - он и вовсе не станет предлагать Вам работу.",effect:{}},{text:"Раз в три месяца Вы можете купить действительно очень редкое оружие, совершив покупку не менее чем 7 уровня богатства. Такую редкость с удовольствием купят любые коллекционеры, вполне вероятно - даже короли и императоры.",effect:{}}]}],edges:[{type:"aspect",id:"war",cost:2},{type:"aspect",id:"knowledge",cost:4}]},{id:"tactician",name:{m:"Тактик",f:"Тактичка"},nameEn:"Tactician",professions:[],aspects:["war","knowledge"],traits:[{id:"holdOn",name:"Держись!",levels:[{text:"За один ход Вы можете помочь союзнику советом два раза, а не один. Кроме того, Ваши советы могут увеличить не только защиту, но и нападение. Ваши советы должны быть реалистичны, иначе мастер может решить, что они не принесут пользу.",effect:{}},{text:"Стоящие плечом к плечу с Вами товарищи атакуют и защищаются на одну категорию эффективнее, но это преимущество не складывается с эффектом от вербальной помощи.",effect:{}},{text:"Вы можете помочь союзнику трижды за один ход, эффект суммируется с преимуществом от второго уровня этого умения.",effect:{}}]},{id:"officerCourses",name:"Офицерские курсы",levels:[{text:"Вы можете невзначай демонстрировать свои познания в тактике в разговоре, если хотите этого. Все Ваши проверки Влияния на невраждебных разумных-воинов эффективнее на две категории.",effect:{}},{text:"Вам проще находить грамотных командиров, все нанятые Вами воины атакуют и защищаются эффективнее на одну категорию.",effect:{}},{text:"Ваша слава идёт впереди Вас, больше хороших бойцов хотят служить под Вашим началом, меньше дураков готовы на Вас напасть. Проверки Влияния на поиск бойцов легче на две категории, проверки организации диверсий и нападений на Вас на две категории сложнее",effect:{}}]},{id:"artOfWar",name:"Искусство войны",levels:[{text:"Война требует денег, денег и ещё раз денег. А ещё, бизнес здорово похож на войну. Ваши проверки Порядка и Диверсии на одну категории проще, если они касаются организации прибыльной компании или борьбы с конкурентами.",effect:{}},{text:"Какой бы важной не была тактика, она не может обойтись без стратегии. Проверки Поиска и Влияния на одну категорию проще, если касаются исследования рынков или стратегических позиций противника.",effect:{}},{text:"Проверки Порядка, Диверсии, Поиска и Влияния первых двух уровней умения становятся проще не на одну, а на три категории.",effect:{}}]}],edges:[{type:"aspect",id:"war",cost:4},{type:"aspect",id:"knowledge",cost:2}]},{id:"monk",name:{m:"Монах",f:"Монахиня"},nameEn:"Monk",professions:[],aspects:["war","mysticism"],traits:[{id:"martialArts",name:"Боевые искусства",levels:[{text:"Ваша скорость передвижения увеличивается на 2, а рукопашные атаки без оружия становятся эффективнее на одну категорию. Кроме того, Ваша защита в ближнем бою повышается на одну категорию, а в дальнем - на две. Эти бонусы работают только в том случае, если Вы носите броню не тяжелее лёгкой. ",effect:{}},{text:"Вы больше не получаете штрафов к защите сбоку. Ваши сокрушительные удары без оружия - всегда точные. ",effect:{}},{text:"Бой для вас - особая форма транса, вы умудряетесь замечать всё происходящее вокруг. Вы больше не получаете штрафов к защите сзади, а также можете реагировать на происходящее за своей спиной. Ваши безоружные атаки становятся эффективнее ещё на одну категорию, а ваши тяжёлые удары оружием ближнего боя становятся всегда точными.",effect:{}}]},{id:"bastionOfSpirit",name:"Бастион духа",levels:[{text:"Боевые искусства - не просто способ убрать врага со своей дороги. Для Вас - это способ обратиться к себе, познать мир через себя, а себя - через мир вокруг. Вы должны проводить не менее 10 часов в неделю в изнуряющих тренировках, но в результате Вы чувствуете происходящее вокруг невероятно тонко. Любые проверки Диверсии на две категории проще, если Вы участвуете в них лично.",effect:{}},{text:"Вы должны тратить на тренировки не менее 20 часов в неделю, но Ваша потребность в сне значительно сократилась. Теперь Вы высыпаетесь всего за 6 часов в сутки. Проверки Порядка проще на одну категорию, если Вы участвуете в них лично.",effect:{}},{text:"Ваше тело - всего лишь продолжение Вашей несгибаемой воли. Вам больше не нужно спать, но Вы должны проводить не меньше 4х часов в сутки в медитациях, поддерживающих Ваш дух. Пока Вам удаётся выполнять это условие, Вам нужно вдвое меньше припасов для выживания, Ваши раны кровоточат вдвое меньше, а ранить Ваше тело значительно сложнее. Ваш класс брони увеличивается на 1.",effect:{}}]},{id:"innerCalm",name:"Внутреннее спокойствие",levels:[{text:"Вам одинаково просто выживать в дикой природе, в суетливом городе или горном додзё. Однако внешний мир Вам не особенно интересен. Ваш уровень знания немагической местности не может быть ниже 4х, но выше этого значения растёт вдвое медленнее обычного.",effect:{}},{text:"Ваш путь боевых искусств провёл Вас через множество стран и регионов - Ваши проверки Влияния на впервые встреченных незнакомцев на две категории легче.",effect:{}},{text:"Ваше паранормальное предчувствие опасности позволяет точно знать, когда Вас держат на прицеле, а иногда и заранее знать, что кто-то замыслил недоброе. Это предчувствие иногда может давать ложноположительный результат.",effect:{}}]}],edges:[{type:"aspect",id:"war",cost:3},{type:"aspect",id:"mysticism",cost:3}]},{id:"commander",name:{m:"Командир",f:"Командирша"},nameEn:"Commander",professions:[],aspects:["war","community"],traits:[{id:"followMe",name:"За мной!",levels:[{text:"Перед боем командир может повысить мораль союзных бойцов ниже или равных по рангу на 3 единицы, если успешно пройдёт проверку Влияния или на 1, если провалит её.",effect:{}},{text:"Вербальная команда командира во время боя поднимает мораль бойца на единицу, а так же позволяет один ход игнорировать негативные последствия тяжёлой травмы.",effect:{}},{text:"Потратив основное действие во время боя, командир может повысить мораль всех способных его слышать бойцов на 2 единицы, снизить мораль всех разумных бойцов противника на 2 единицы. ",effect:{}}]},{id:"allInOrder",name:"Всё по порядку",levels:[{text:"Составить хороший план - половина успеха. Ваши проверки Порядка на одну категорию легче.",effect:{}},{text:"Мало составить план - нужно ещё и ему следовать. Ваши проверки Порядка на две категории проще, если Вы выполняете работу самостоятельно или с проверенными исполнителями, с которыми Вам уже доводилось работать раньше.",effect:{}},{text:"Вы умеете составлять чёткие исчерпывающие инструкции, такие, чтобы по ним выполнить работу смогла и обезьяна. Ваши проверки Порядка легче на две категории, если исполнителями на месте руководит выбранный Вами смышлёный человек. Этот бонус работает и если вы руководите лично.",effect:{}}]},{id:"togetherStronger",name:"Вместе сильнее",levels:[{text:"Если несколько персонажей думают над решением одной проблемы и готовы доверить Вам руководство, Вы можете сделать так, чтобы проверку проходил персонаж с самой высокой характеристикой, а бонусы учитывались от персонажа с самыми высокими бонусами.",effect:{}},{text:"Если это проверка Войны, Порядка или Влияния, Вы так же можете облегчить её ещё на одну категорию.",effect:{}},{text:"Для любых проверок Вы можете сложить все бонусы всех участников, однако полученное преимущество не должно быть больше чем в два раза большим, чем самый большой бонус.",effect:{}}]}],edges:[{type:"aspect",id:"war",cost:3},{type:"aspect",id:"community",cost:3}]},{id:"ranger",name:{m:"Следопыт",f:"Следопытка"},nameEn:"Ranger",professions:[],aspects:["war","nature"],traits:[{id:"bloodyTrail",name:"По кровавому следу",levels:[{text:"Вы не уличный задира, Вы - профессиональный убийца. Вы выслеживаете свою цель и наносите удар издалека. Проверки Поиска на категорию легче, если вы ищете живое существо. Первый удар по не подозревающей о Вас цели эффективнее дополнительно на две категории, но это не должен быть удар с соседней клетки.",effect:{}},{text:"Ваши атаки по не подозревающему о Вашем присутствии противнику - всегда считаются точными, если Вы успели изучить его по следам или наблюдая в течении хотя бы одной минуты.",effect:{}},{text:"Ваши дальние атаки (даже через одну клетку) эффективнее на одну категорию даже по обнаружившим Вас противникам, если Вы успели изучить их по следам. Ваша защита в ближнем и дальнем бою против них так же выше на категорию.",effect:{}}]},{id:"likeHome",name:"Как у себя дома",levels:[{text:"Если Ваше знание местности хотя бы 5, обнаружить Вас сложнее на одну категорию.",effect:{}},{text:"Если Ваше знание местности хотя бы 5, обнаружить весь Ваш отряд сложнее на одну категорию. Это касается как попыток спрятаться в засаде, так и передвижения по глобальной карте.",effect:{}},{text:"Ваше мастерство скрытности достигло своего апогея. Если Вы знаете местность хотя бы до уровня 3, Вы можете скрыть себя с дополнительной сложностью в три категории, или весь отряд - со сложностью в две. Кроме того, Ваш первый удар по не подозревающему о Вашем присутствии врагу получает дополнительный бонус в одну категорию",effect:{}}]},{id:"secretPaths",name:"Тайные тропы",levels:[{text:"Вы знаете, как выбирать дорогу, чтобы меньше уставать и больше успевать. Ваша скорость передвижения по глобальной карте увеличена на два. Вы значительно эффективнее обнаруживаете другие отряды неподалёку, на две категории. ",effect:{}},{text:"С Вашей помощью весь отряд может двигаться по глобальной карте быстрее на единицу. Если Вы прокладываете маршрут движения какого-нибудь отряда, он оказывается на одну категорию безопаснее.",effect:{}},{text:"Ваши проверки Диверсии против отрядов, движущихся по дикой местности, эффективнее на две категории. Маршруты, проложенные Вами на две категории безопаснее.",effect:{}}]}],edges:[{type:"aspect",id:"war",cost:2},{type:"aspect",id:"nature",cost:4}]},{id:"hunter",name:{m:"Охотник",f:"Охотница"},nameEn:"Hunter",professions:[],aspects:["war","nature"],traits:[{id:"catchTheHunter",name:"На ловца",levels:[{text:"Вопреки расхожему мифу, рыцарь в латах и на коне не сумеет одолеть дракона. А вот хорошо подготовленный охотник - сможет. Вы очень хороши в бою против зверей и монстров из крови и плоти - атака и защита эффективнее на одну категорию.",effect:{}},{text:"Кое-что из Ваших навыков прекрасно работает и на разумных. Ваши ловушки на одну категорию эффективнее, а кровотечение спровоцированное Вашими атаками, вдвое тяжелее.",effect:{}},{text:"В бою против зверей и монстров, с которыми Вы уже сталкивались раньше, Ваша атака и защита эффективнее на две категории.",effect:{}}]},{id:"battleTrophies",name:"Боевые трофеи",levels:[{text:"Если Ваш уровень знания местности хотя бы 4, Вы можете собирать одну меру немагических полезных ингредиентов из тел живущих в ней животных в месяц. Для этого Вам нужно найти подходящее место и остановиться в нём. Вы также можете извлекать обычные ингредиенты из поверженных в бою монстров",effect:{}},{text:"Вы можете собирать редкие ингредиенты, тратя на это всё своё время или обычные - прямо на ходу. Из побеждённых в бою Вы можете извлекать обычные или редкие ингредиенты",effect:{}},{text:"Вы можете собирать даже магические материалы из монстров, которых победили в бою или на которых охотились.",effect:{}}]},{id:"startYearAgo",name:"Начинаем год назад",levels:[{text:"Хорошая подготовка - ключ к успешной охоте. Имея большой опыт в вещах такого рода, Вы можете неплохо организовывать и другие дела. Проверки Порядка проще на одну категорию, если они хоть как-то связаны с пребыванием в дикой местности.",effect:{}},{text:"Что будет, если Ваши конкуретны забудут палатку? Проверки Диверсии так же проще на одну категорию, если связаны с пребыванием Вашей цели в дикой местности.",effect:{}},{text:"Ваше снаряжениие подобрано так хорошо, что Вы можете использовать его исключительно быстро. Полным действием в бою Вы можете подготовить ловушку, это может быть заранее подготовленный капкан на медведя или некая импровизация на месте. В случае импровизации, вы будете проходить проверку Порядка, сложность которой зависит от реалистичности Вашей задумки.",effect:{}}]}],edges:[{type:"aspect",id:"war",cost:4},{type:"aspect",id:"nature",cost:2}]},{id:"druid",name:{m:"Друид",f:"Друидка"},nameEn:"Druid",professions:[],aspects:["nature","mysticism"],traits:[{id:"oneAmongBeasts",name:"Свой среди зверей",levels:[{text:"Вы умеете вести себя так, чтобы не провоцировать диких животных. Они нападут на Вас только по исключительной причине, например, умирая от голода или защищая своё потомство. Проверки Поиска связанные со зверьми для вас на одну категорию проще.",effect:{}},{text:"Звери рассматривают Вас как доброго приятеля. Драться на Вашей стороне они, конечно, не станут, но могут предупредить о приближающейся опасности. Ваш отряд на одну категорию сложнее обнаружить, а Вы обнаруживаете другие на одну проще",effect:{}},{text:"Вы учитесь гораздо лучше понимать, что пытаются Вам сказать наши братья меньшие. Ваши проверки Поиска в местности, где есть звери на две категории эффективнее. Сообщения от зверей мастер теперь передаёт Вам как короткие предложения из двух-трёх простых слов.",effect:{}}]},{id:"forestSpirits",name:"Духи леса",levels:[{text:"Ежедневно жертвуя духам местности, в которой Вы находитесь, нечто ценное (обычно подходят съестные припасы) за одну неделю Вы можете наладить с ними контакт. Если духи благоволят Вам, один раз за боевую сцену (или один раз в месяц вне боя), Вы можете пройти проверку автоматически, если это возможно хотя бы при каком-то значении на кубике.",effect:{}},{text:"Регулярно жертвуя духам местности нечто ценное (отлично подойдут ценные материалы) Вы можете расположить их к себе ещё больше. Проверка, которую Вы видите, может получить максимум или минимум на кубиках по Вашему желанию. Это умение можно применить один раз за бой или раз в месяц в небоевых сценах.",effect:{}},{text:"Регулярно жертвуя духам местности магические ингредиенты или артефакты (не менее месяца), Вы достигаете максимального расположения с их стороны. Они могут самостоятельно помогать Вам как посчитают нужным, будь это подсказки или помощь в бою.",effect:{}}]},{id:"likeAFish",name:"Как рыба в воде",levels:[{text:"Вы чувствуете присутствие крупных зверей на расстоянии в сотню метров. Ваши проверки Поиска в отношении зверей проще на три категории.",effect:{}},{text:"Монстры - совершенно чуждые природе существа. Земля стонет и плачет там, где они ходят по ней. Вы слышите этот плач издалека, за несколько километров определяя направление до ближайшего монстра. Проверки Поиска в отношении монстров на две категории проще.",effect:{}},{text:"Магия вплетена в природу, но всё же выделяется на фоне всего остального ярким пятном. Вы чувствуете магические артефакты и ингредиенты, находящиеся в дикой природе за несколько километров. Поиск таких предметов проще на три категории, но имейте ввиду - духи местности могут разозлиться на Вас, если Вы заберёте что-то ценное.",effect:{}}]}],edges:[{type:"aspect",id:"nature",cost:2},{type:"aspect",id:"mysticism",cost:4}]},{id:"outlaw",name:{m:"Беглец",f:"Беглянка"},nameEn:"Outlaw",professions:[],aspects:["shadow","nature"],traits:[{id:"shepherdOfBlackSheep",name:"Пастух паршивых овец",levels:[{text:"В любом обществе есть те, кто промышляет тёмными делишками. Вы легко определяете таких, сложность проверки ниже на две категории.",effect:{}},{text:"Вы можете не только успешно определять криминальные элементы, но ещё и ловить их на горячем. Чтобы затем шантажировать. Ваши проверки Влияния на них на две категории эффективнее.",effect:{}},{text:"Вы безошибочно определяете тёмных дельцов, воров, взяточников в любом обществе, проведя с ними в разговоре хотя бы несколько минут. Размеры взяток для Вас снижены на две категории. Пройдя дополнительную проверку, Вы можете разгадать схему, в которой кто-то замешан.",effect:{}}]},{id:"constantlyLookingBack",name:"Постоянно оглядываясь",levels:[{text:"Вы так долго скрывались от властей, что теперь чувствуете себя гораздо лучше вне поселений. Скорость изучения местности удвоена вплоть до уровня 4, если это не магическая местность.",effect:{}},{text:"Уходить от погони - сильнейший из Ваших талантов. Если Вас преследуют, (в бою или на стратегической карте) Ваша скорость передвижения увеличивается на два.",effect:{}},{text:"Проведя в поселении хотя бы месяц, Вы узнаёте обо всех тайных ходах, не закрытых от простых людей или криминальных элементов. Если это поселение около границы другого государства, Вы также узнаёте как проникнуть туда незамеченным.",effect:{}}]},{id:"withoutStopping",name:"Не останавливаясь",levels:[{text:"Вы учитесь атаковать на бегу, не разворачиваясь. Для Вас возможны атаки вбок с штрафом эффективности в одну категорию.",effect:{}},{text:"От привычки не так легко избавиться. Если Ваши атаки наносят хотя бы лёгкую травму, они снижают скорость передвижения противника на одну клетку длительностью на два хода. Если только Вы явно не захотите обратного.",effect:{}},{text:"Вы можете атаковать назад не разворачиваясь со штрафом в одну категорию, или вбок - без штрафа. Кроме того, Ваша защита с тыла становится сильнее на одну категорию.",effect:{}}]}],edges:[{type:"aspect",id:"shadow",cost:3},{type:"aspect",id:"nature",cost:3}]},{id:"warlock",name:{m:"Колдун",f:"Колдунья"},nameEn:"Warlock",professions:[],aspects:["mysticism","shadow"],traits:[{id:"bloodMagic",name:"Магия крови",levels:[{text:"Вы получаете связь первого уровня с Концептом Жизнь, если ещё не имели её. Ваше особое умение - направлять магическую энергию по крови, которую Вы сумели получить от цели. Касты, направленные таким образом, слабее на два уровня, но не слабее Быстрого. Кровь, изьятая из организма, имеет связь с телом несколько часов.",effect:{}},{text:"Вы можете жертвовать собственную кровь для усиления магического эффекта - это наносит царапину при результате на кубике 10-12, лёгкую травму в иных случаях. Сила каста вырастает на один уровень.",effect:{}},{text:"Вы учитесь лучше чувствовать связь Крови, теперь магические эффекты, передаваемые через неё, слабее всего на один уровень, а если Вы прикладываете небольшие усилия, образец крови может оставаться связанным с целью сколь угодно долго. Одновременно Вы можете держать у себя не больше трёх таких образцов, но если не сумеете укрепить связь в какой-нибудь день, она будет разрушена.",effect:{}}]},{id:"myOtherHalf",name:"Половинка меня",levels:[{text:"Вам удаётся сделать невероятное - оторвать от своей души небольшой кусок, да ещё так, чтобы он не развалился при этом. Получилось нечто живое, отдельное от Вас и в то же время являющееся Вами. Вы вселили это в животное, получив, таким образом, фамильяра. Небольшой зверёк на Ваш выбор подчиняется Вашей воле, но главное - Вы можете направлять любые касты из той точки, где находится он. Помните, что любые энергии Порядка изгоняют духа, а чтобы вселить его в новое тело, Вам нужно потратить как минимум один день. В случае полного разрушения духовной сущности, Вы получаете травму уровня смертельного ранения и должны потратить не менее недели, чтобы повторить свой опыт.",effect:{}},{text:"Ваш дух-фамильяр становится значительно сильнее. Животное-носитель больше не является живым - скорее немёртвым. Остановить его физическим оружием можно, но убить - нельзя. Теперь Вы можете проводить энергии Порядка через фамильяра, но эффекты будут на один уровень слабее. Кроме того, теперь духа нельзя изгнать энергией порядка ниже уровнем, чем Средний каст. Вы можете общаться телепатически с фамильяром, когда он меньше чем в 1000 метров от Вас.",effect:{}},{text:"Дух становится всё сильнее, как и Ваша с ним связь. Вы можете общаться с ним телепатически на любом расстоянии (в пределах одного мира), а в пределах 1000 метров - ещё и ощущать мир его органами чувств. Вселение духа в животное больше не занимает у Вас много времени - достаточно нескольких минут. Любые энергии каста теперь передаются без потерь. В случае полного разрушения духовной сущности фамильяра, вы больше не получите урона.",effect:{}}]},{id:"deadWater",name:"Мёртвая вода",levels:[{text:"Вы учитесь заключать некоторые магические эффекты в специальных отварах. Потратив час времени и немного как минимум редких ингредиентов, Вы можете выполнить каст и при успехе, заключить его действие в магическом отваре. Энергия сохранится в нём ещё одни сутки, а затем развеется. Ваш отвар - всегда яд, производить что-то кроме яда Вы ещё не научились. Чтобы он подействовал в полной мере, цель должна его проглотить - а внесённый в кровь вместе с ударом оружия яд подействует на уровень слабее. Сила эффектов, которые может вместить Ваш отвар ограничена уровнем Малого каста.",effect:{}},{text:'Вы можете заключать более мощные магические эффекты в отварах, теперь они ограничены уровнем до Среднего каста. Кроме того, теперь Вы можете добавлять дополнительные эффекты, кроме урона, но они должны быть слабее основного, а сделать зелье с "умным" эффектом любого рода не получится - оно не привязано к разуму применяющего, потому всегда имеет нулевой контроль и нулевую самостоятельность.',effect:{}},{text:"Ваши зелья теперь могут вмещать эффект вплоть до уровня Большого каста, гораздо более долговечны - могут прожить до недели, а периодически подновляя магию в них, Вы можете держать их рабочими сколь угодно долго (до 9 зелий, 3 шт каждого из 3х типов).Теперь дополнительные эффекты могут оказываться сильнее вредоносного, но как минимум царапину Ваш яд всегда должен наносить.",effect:{}}]}],edges:[{type:"aspect",id:"mysticism",cost:2},{type:"aspect",id:"shadow",cost:4}]},{id:"specialist",name:{m:"Мастер",f:"Мастерица"},nameEn:"Specialist",professions:[],aspects:["community","knowledge"],traits:[{id:"fasterAndHigher",name:"Быстрее и выше",levels:[{text:"Вы копаете глубоко и не останавливаетесь на достигнутом. И это даёт свои плоды - в любом ремесле, распространённом в обществе, Вы преуспеваете больше других. Работая по любой профессии, не связанной с Мистикой, Вы можете заработать на один уровень богатства больше. Кроме того, все проверки Порядка для Вас на одну категорию проще.",effect:{}},{text:"Хороших профессионалов ценят. Ваши проверки Влияния на категорию проще, а искать специалистов в какой-то области - проще на две.",effect:{}},{text:"Занимаясь своим ремеслом, Вы можете заработать на две категории больше богатства больше, чем другие. Ваши проверки Влияния на две категории эффективнее, если Вы проработали по профессии в этом поселении хотя бы месяц.",effect:{}}]},{id:"allOnShelves",name:"Всё по полочкам",levels:[{text:"Вы бы не смогли достичь таких высот в своих ремёслах, если бы не анализировали и не систематизировали всё. Все проверки Порядка на одну категорию проще, если они связаны с освоенным Вами ремеслом - на две.",effect:{}},{text:"Вы можете осваивать новые профессии и ремёсла гораздо быстрее остальных - всего за месяц обучения Вы достигаете уровня среднего специалиста. Ремесло в таком случае считается усвоенным. Вам всё ещё не доступны профессии, связанные с мистикой.",effect:{}},{text:"Даже мистические профессии теперь доступны Вам, однако Вы должны потратить втрое больше времени, чтобы разобраться в них. Освоив совершенно новую для себя профессию, Вы получите одно очко развития.",effect:{}}]},{id:"almostChess",name:"Почти шахматы",levels:[{text:"Потратив основное действие в бою, Вы можете попробовать разгадать тактический замысел противника, если он есть. Это проверка Порядка или Диверсии, на Ваш выбор. Если проверка пройдена успешно, мастер раскрывает Вам суть задумки, а Вы и Ваши товарищи получают преимущество в атаке и защите в одну категорию на следующий раунд боя.",effect:{}},{text:"Проанализировав как минимум три взаимодействия с враждебными силами, Вы можете попробовать разгадать стратегический замысел противника. Это проверка Порядка или Диверсии на Ваш выбор, сложность тем больше, чем меньше Ваш персонаж узнал предварительно. В случае успеха Вы получаете преимущество в две категории на все проверки (кроме боя) в отношении этой фракции на месяц",effect:{}},{text:"Преимущество, которое Вы получаете от первых двух уровней этого умения, длится вдвое дольше. Кроме того, если Вы прошли изначальную проверку (Порядка или Диверсии), Вы можете предложить план, как помешать врагу и пройти другую (Диверсии для Порядка или наоборот), чтобы удвоить и силу Вашего преимущества. Сложность проверки выставляет мастер ориентируясь на реалистичность Вашего плана.",effect:{}}]}],edges:[{type:"aspect",id:"community",cost:2},{type:"aspect",id:"knowledge",cost:4}]},{id:"skald",name:{m:"Скальд",f:"Скальдесса"},nameEn:"Skald",professions:[],aspects:["community","knowledge"],traits:[{id:"knowATale",name:"Знаю сказ, который начинался...",levels:[{text:"Ничто не ново в этом мире, и Вы, как хранитель легенд ушедших эпох, знаете это лучше других. В любой ситуации Вы можете попробовать пройти проверку Порядка, чтобы вспомнить, не было ли уже на свете подобной ситуации. Проверка тем сложнее, чем более необычный пример Вы пытаетесь вспомнить, но если она пройдена, Вы можете поделиться поучительной историей из прошлого с другими, облегчая следующую проверку (свою или чужую) на две категории. Вы можете упрощать подобным образом только проверки Конфликта, Порядка или Влияния.",effect:{}},{text:"Многие баллады сложены о героизме или о любви, но не стоит забывать и тёмные сказки, которые народ тоже исправно хранит в своей памяти. Теперь Вы можете усиливать этим умением и проверки Диверсии, Защиты и Поиска. Кроме того, раз в месяц Вы можете усилить свою проверку, не затрачивая хода.",effect:{}},{text:"Вам не составляет труда вывернуть любую историю так, чтобы она выставляла Вас в выгодном свете. Ваши собственные проверки Влияния всегда проще на две категории, а Репутация Вашей группы с любыми невраждебными фракциями всегда как минимум 2 (Небольшое Влияние)",effect:{}}]},{id:"ourLastAndDecisive",name:"Наш последний и решительный",levels:[{text:"Жизнь жестока и вопрос не в том, выживешь ли ты. Только в том, каким тебя запомнят. Те, кто дерётся с Вами плечом к плечу понимают, что каждый бой - их шанс занять своё место в героической легенде. Боевой дух всех бойцов ниже рангом чем Вы выше на единицу.",effect:{}},{text:"Когда Вы успешно побеждаете противника в бою, Вы можете сопровождать свои действия вдохновляющими союзников репликами. Все увидевшие и услышавшие это в бою бойцы ниже Вас рангом получат преимущество в одну категорию при атаке на один раунд.",effect:{}},{text:"Преимущества двух предыдущих уровней теперь действуют даже на бойцов Вашего ранга, включая товарищей по команде и даже Вас.",effect:{}}]},{id:"goldenPages",name:"Золотые страницы",levels:[{text:"Не только простые бойцы хотят остаться в легендах, выдающимся людям своей эпохи тоже не чужда жажда славы. Вам на две категории проще находить выход на тех, кто не стремится общаться с простым людом, а Ваши проверки Влияния против них на одну категорию проще.",effect:{}},{text:"Вам на две категории проще убеждать нейтральные стороны оказать Вам какую-то помощь - подкрепления, припасы, деньги или снаряжение. Это работает только в том случае, если по мнению люда Вам противостоит серьёный враг.",effect:{}},{text:"Здорово казаться всем храбрым... но и сойти богатым и щедрым - тоже неплохо. Вы можете рассчитывать на награду на одну категорию выше, если заказчик способен её себе позволить.",effect:{}}]}],edges:[{type:"aspect",id:"community",cost:4},{type:"aspect",id:"knowledge",cost:2}]},{id:"cutthroat",name:{m:"Головорез",f:"Головорезка"},nameEn:"Cutthroat",professions:[],aspects:["war","shadow"],traits:[{id:"terrorToAll",name:"Гроза всему живому",levels:[{text:"Вы славитесь своей безпринципностью и безжалостностью. Проверки Влияния на одну категорию эффективнее, если Вы предпочитаете действовать через угрозы. Однако, вероятность того, что Ваша деятельность привлечёт внимание властей ничуть не меньше.",effect:{}},{text:"Враждебные фракции подумают дважды, прежде чем чинить Вам какие-то неудобства. Но уж если они решатся - бросят в бой всё, что имеют. Враждебные фракции решаются на активные действия только при репутации Ненависть (-4) или Лютая Ненависть (-5)",effect:{}},{text:"Ваши проверки Влияния эффективнее на одну категорию при попытках договориться или на две, если Вы используете угрозы. Любые предприятия и организации связанные с Вашим именем на одну категорию больше защищены от нападок разумных.",effect:{}}]},{id:"mindBlowingCruelty",name:"Умопомрачительная жестокость",levels:[{text:"Пришедшие за Вашей головой морально готовы умереть, но никто не готов умереть ТАК. Если противник уже не может эффективно сопротивляться, Вы можете устроить показательную жестокую казнь, подрывая мораль всех, кто это увидел и услышал. Противники получают -2 морали, союзники и нейтральные бойцы -1. На это нужно затратить основное действие, но в следующий ход противники будут защищаться и нападать на одну категорию хуже. Этот эффект не проймёт бойцов более высокого ранга, чем убитый.",effect:{}},{text:"Захватив в бою пленного, Вы можете жестоко казнить его позже прилюдно. Такое действие снизит вероятность нападок на Вас со стороны враждебных фракций на две категории на следующий месяц.",effect:{}},{text:"Вы можете проводить казнь в бою, затрачивая всего один порыв. Это действие больше не подрывает мораль Ваших союзников, а кроме того может пронять бойцов даже более опытных, чем убитый.",effect:{}}]},{id:"honorForFools",name:"Честь - для идиотов и мертвецов",levels:[{text:"Ваши атаки во фланг и тыл получают преимущество в одну категорию.",effect:{}},{text:"Ваши атаки во фланг и тыл - всегда точные.",effect:{}},{text:"Ваши атаки во фланг и тыл не вызывают срабатывания реакции, а кроме того забирают у цели один порыв даже в случае промаха.",effect:{}}]}],edges:[{type:"aspect",id:"war",cost:3},{type:"aspect",id:"shadow",cost:3}]},{id:"heretic",name:{m:"Еретик",f:"Еретичка"},nameEn:"Heretic",professions:[],aspects:["mysticism","knowledge"],traits:[{id:"comprehendingIncomprehensible",name:"Постигая непостижимое",levels:[{text:"Парадокс - Ваше второе имя. Проходя любую проверку, Вы можете выбрать противоположную ей и преуспеть необъяснимым образом. Такая проверка, правда, будет на одну категорию сложнее заявленной. Вы должны объяснить, каким образом применяете свои навыки для того, чтобы пройти проверку.",effect:{}},{text:"Странно для других, естественно - для Вас. Вы можете выбрать соседнюю проверку вместо противоположной, но она будет на две категории сложнее.",effect:{}},{text:"Гениальность или безумие? Главное, чтобы это работало. Противоположные проверки больше не получают штрафа, а штраф при использовании соседних проверок снижен до одной категории.",effect:{}}]},{id:"verbalMagic",name:"Вербальная магия",levels:[{text:"Посвятив месяц изучению и анализу необъяснимых мистических сущностей, вы всё же находите кое-какие закономерности. Вы способны создавать заклинания - нелепые высказывания, которые нужно громко пропевать странно пританцовывая, чтобы они сработали. Каждое использование заклинания - парная проверка Порядка и Диверсии, требующая основного действия в бою или полного хода в небоевой сцене. Сложность определяется мастером по степени реалистичности задумки. Эти проверки нельзя заменить на другие, к ним не применяются никакие бонусы. Если обе пройдены - заклинание срабатывает как и планировалось, если провалена одна - не происходит ничего, если провалены обе - срабатывает наоборот. Одновременно Вы можете помнить только три заклинания.",effect:{}},{text:"Вы учитесь записывать свои заклинания и лучше запоминать, как именно их следует выполнять. Проверки сложности теперь проще на одну категорию, а если Вам нужно выбросить на кубике 6 или меньше, Вы проходите проверку автоматически. Теперь Вы можете хранить в своей памяти три заклинания и ещё три - в своих записях. Заклинания из памяти используются основным действием, заклинания из записей - основным действием и двумя порывами.",effect:{}},{text:"Вы научились так хорошо записывать свои заклинания, что даже другие могут их повторять. Потратив не менее двух недель и одного очка развития на изучение, Ваш товарищ может научиться использовать заклинание. В вашей собственной памяти теперь может храниться до шести заклинаний, ещё три - в записях.",effect:{}}]},{id:"completePicture",name:"Дорисовать картину",levels:[{text:"Высокие аналитические способности и хорошая интуиция - невероятно редкое сочетание, но благодаря этой связке Вы можете понимать то, что для других - недоступно. Например, разгадывать самые запутанные истории по обрывкам информации. Раз в месяц Вы можете сделать невероятную догадку - точно узнать причину какого-то события, которое Вы подробно изучали.",effect:{}},{text:"Будущее не может быть секретом для того, кто так хорошо понимает прошлое. Раз в месяц Вы можете сделать невероятную догадку - точно узнать последствия какого-то события, которое Вы подробно изучали или действия, которое собираетесь совершить.",effect:{}},{text:"Остальные видят только разрозренные кусочки, а Вы - полную картину. Жаль, что такие озарения посещают Вас лишь иногда. Раз в месяц Вы можете точно узнать самый лучший, простой и надёжный способ добиться каких-то результатов.",effect:{}}]}],edges:[{type:"aspect",id:"mysticism",cost:3},{type:"aspect",id:"knowledge",cost:3}]},{id:"seeker",name:{m:"Искатель",f:"Искательница"},nameEn:"Seeker",professions:[],aspects:["nature","community"],traits:[{id:"wolfToWolf",name:"Волк волку человек",levels:[{text:"Дух первооткрывателя толкает Вас почти всё время проводить в экспедициях по неизведанным землям. Вы здорово научились находить общий язык с местными дикими сообществами, Ваша Репутация с ними начинается с Небольшого Влияния (2), а все проверки Поиска и Влияния с их помощью на две категории проще.",effect:{}},{text:"Вы легко можете затеряться в дикой местности, поселившись в диком сообществе. За месяц проживания с ними, Вы можете хорошо выучить их язык, подняв попутно уровень Репутации до Дружбы (5). Ваши проверки Поиска в этой местности с помощью дружественных аборигенов проще на три категории.",effect:{}},{text:"Затратив достаточно времени, Вы способны, кажется, подружиться с кем угодно. Теперь Вы можете вжиться в сообщество любых животных или монстров, если им свойственна хотя бы какая-то стайность или социальность. На это придётся потратить не менее трёх месяцев, но в результате вы получите полное знание местности Как Свои Пять Пальцев (10), и одно очко развития.",effect:{}}]},{id:"artifactorFlair",name:"Чутьё артефактора",levels:[{text:"Пока другие покупают безделушки по цене магических артефактов, Вы делаете обратное. Паранормальное чутьё позволяет Вам находить действительно магические предметы даже в куче хлама, если они там есть. Проверки Поиска и Влияния проще на две категории при попытке найти артефакты.",effect:{}},{text:"Продажа магических материалов, ингредиентов и артефактов позволяет Вам выручить на одну категорию больше богатства.",effect:{}},{text:"Собирая вместе все знания о местной природе, слухи и легенды местного населения и своё таинственное чутьё, Вы гораздо легче находите древние руины, гробницы, затерянные города, магические места силы и прочее подобное. Проверки такого рода легче на три категории.",effect:{}}]},{id:"untilVictorious",name:"До победного",levels:[{text:"Простая неудача не может остановить Вашу несгибаемую волю Искателя. Раз в месяц Вы можете попробовать пройти проверку ещё два раза, если провалили первую попытку. Если вы пройдёте хотя бы одну из трёх - это зачитывается как успех. Мастер может наложить на Вас какой-нибудь штраф за приложение чрезмерных усилий.",effect:{}},{text:"Если Вы преуспели со второй попытки, третью можете использовать на другой проверке в этом же месяце.",effect:{}},{text:"Если Вы проваливаете проверку все три раза, при следующей попытке Ваша проверка будет на одну категорию проще.",effect:{}}]}],edges:[{type:"aspect",id:"nature",cost:3},{type:"aspect",id:"community",cost:3}]},{id:"dervish",name:{m:"Дервиш",f:"Дервишка"},nameEn:"Dervish",professions:[],aspects:["community","mysticism"],traits:[{id:"danceOfBliss",name:"Танец блаженства",levels:[{text:"Потратив действие в свой ход, Вы можете войти в особый боевой танец, в процессе которого не можете использовать атаки дальнего боя, но получаете преимущество в атаке в одну категорию.",effect:{}},{text:"Ваши движения иррациональны и непредсказуемы. Если Ваше передвижение или атака вызывает реакцию, пройдите проверку Влияния против Поиска противника. В случае успеха ему не удаётся отреагировать на Ваше действие, но затраченный порыв всё равно тратится.",effect:{}},{text:"Во время танца вы не получаете штрафов из-за ранений и морали (кроме смертельных), в к Вашей проверке Влияния на реакцию противника прибавляется две категории сложности.",effect:{}}]},{id:"ignitingHearts",name:"Зажигающий сердца",levels:[{text:"Свет вашей безграничной веры зажигает сердца и увлекает за собой. Ваши проверки Влияния вне боя легче на две категории, если цель не настроена враждебно по отношению к Вам.",effect:{}},{text:"Вы учитесь входить в особый транс в танце, который позволяет Вам лучше настроиться на следующую проверку. Проведя особый ритуал, Вы можете снизить сложность следующей проверки на категорию.",effect:{}},{text:"Ваш фанатизм сияет настолько ярко, что способен заворожить даже врага в бою. Теперь Ваши проверки Влияния легче на две категории даже в бою, даже в отношении врагов.",effect:{}}]},{id:"asIfNoOneSees",name:"Как будто никто не видит",levels:[{text:"Дервиш - это юродивый, которого никто не замечает, если он только сам того не хочет. Найти Вас в поселении с помощью Влияния на категорию сложнее.",effect:{}},{text:"Паранормальное чувство опасности ведёт Вас, позволяя избегать недоброжелателей. Найти Вас с помощью Влияния или Поиска становится сложнее на две категории. Этот бонус работает как в поселениях, так и в дикой природе.",effect:{}},{text:"Если Вас никто не видит, Вы можете делать что захотите. Проверки Диверсии становятся проще на две категории, если Вы лично участвуете в деле.",effect:{}}]}],edges:[{type:"aspect",id:"community",cost:3},{type:"aspect",id:"mysticism",cost:3}]},{id:"bard",name:{m:"Бард",f:"Бардесса"},nameEn:"Bard",professions:[],aspects:["community","shadow"],traits:[{id:"withoutMusic",name:"А без музыки…",levels:[{text:"Хотя бардам и не часто приходится участвовать в сражениях, в кабацких драках они бывают чаще прочих. Те, кто не научился защищать себя - попросту не выжили. Потратив два порыва Вы можете провести проверку Влияния против Влияния противника, чтобы отвлечь его и заставить потерять оставшиеся действия и порывы.",effect:{}},{text:"Пока Ваша собственная мораль высока и у Вас нет тяжёлых ранений, Вы можете петь в бою, не затрачивая никаких ресурсов. Это укрепляет мораль окружающих, добавляя единицу.",effect:{}},{text:"Ваше пение теперь повышает мораль на две единицы, а затратив в свой ход полное действие Вы можете подключить к нему игру на инструменте, попробовав, таким образом, отвлечь внимание сразу всей противников, которые способны Вас видеть и слышать. С высокой долей вероятности они вскоре захотят атаковать Вас.",effect:{}}]},{id:"welcomeGuest",name:"Желанный гость",levels:[{text:"Любое застолье проходит приятнее под хорошую музыку. Мало кто откажется от присутствия барда на светском рауте. Вы в курсе всех слухов поселения, в котором провели хотя бы один месяц, это упрощает Ваши проверки Влияния в поселении на три категории. ",effect:{}},{text:"Если Вы проводите в поселении хотя бы месяц, все фракции кроме враждебных, начинают относиться к Вам как минимум с Симпатией (1).",effect:{}},{text:"Если Вы проводите в поселении хотя бы месяц, все фракции кроме враждебных начинают относиться к Вам как к доброму приятелю (Сопереживание, 4), а жители окрестных селений - с Симпатией (1)",effect:{}}]},{id:"lightWedge",name:"Свет клином",levels:[{text:"Любое тёмное дело гораздо проще провернуть, если в нём участвует яркий фанфарон, привлекающий всё внимание. Вы не можете действовать в одиночку, но облегчаете проверки Диверсии для своих друзей на одну категорию. Этот бонус складывается с другими, которыми они обладают.",effect:{}},{text:"Как же не помочь хорошим ребятам! Вы облегчаете проверки Влияния на одну категорию для своих друзей, этот бонус складывается с другими. Размер бонуса к Диверсии увеличивается до двух категорий.",effect:{}},{text:" Как складно говорит! Проверки Порядка для Ваших друзей становятся легче на одну, Влияния - на две, Порядка - на три категории. Все эти бонусы складываются с другими, которые есть у этих персонажей.",effect:{}}]}],edges:[{type:"aspect",id:"community",cost:2},{type:"aspect",id:"shadow",cost:4}]},{id:"assassin",name:{m:"Убийца",f:"Убийца"},nameEn:"Assassin",professions:[],aspects:["mysticism","shadow"],traits:[{id:"slidingInShadows",name:"Скользящий в тени",levels:[{text:"Договариваться и подкупать стражу - не для Вас. Вам больше по душе верёвка с крюком и немного акробатики. А ещё Вы тонко чувствуете опасности, потому знаете, куда и когда лучше не соваться. Проверки Диверсии на проникновение на защищаемые объекты легче на две категории. Вы гарантированно успешно проникаете на объект, если его охраняют только Бойцы или ниже.",effect:{}},{text:"Затратив полный ход (включая порывы и передвижения) Вы можете попробовать настроиться на своё сверхъестественное чувство и узнать, какие опасности есть поблизости. Этот талант работает нестабильно, но всё же много раз спасал Вам жизнь.",effect:{}},{text:"Тени вокруг Вас неестественно темны, а под Вашими шагами не хрустят ветки и не скрипят половицы. Вне боя противник может заметить Вас, только если вы попадёте в его фронтальное поле зрения без укрытия. Противник не может протрубить тревогу в тот же ход, когда обнаружил Вас, если Вы нанесли ему хотя бы лёгкую травму. Проверки Диверсии теперь легче на три категории, если Вы можете обосновать, как будете использовать своё мастерство проникновения. ",effect:{}}]},{id:"flyingDeath",name:"Летящая смерть",levels:[{text:'Вопреки расхожим мифам, убийца - вовсе не лучший воин на свете. Ваше лучшее оружие - неожиданность и удары в спину. Затрачивая порыв на передвижение, Вы можете сделать один шаг и метнуть небольшой металлический шип через одну клетку. При попадании, он нанесёт травму категории "царапина".',effect:{}},{text:'Вы можете метать своё оружие через две клетки, а при попадании вы можете выбрать "точный удар" категории царапина или "лёгкая травма".',effect:{}},{text:'Ваши метательные ножи отравлены. Если Вы наносите хотя бы "лёгкую травму" своим метательным шипом, противник подвергается воздействию сильного яда, который удвоит этот урон на следующий ход. Теперь Вы можете метать ножи порывом, не затормаживая своего движения, в Вашем распоряжении остаются все два очка передвижения.',effect:{}}]},{id:"rememberDeath",name:"Помни о смерти",levels:[{text:"Хотя вы не афишируете свои умения, многие знают, что Ваши недоброжелатели долго не живут. Кто-то захлебнулся чаем, кто-то накормил в лесу стаю волков, а кто-то упал на собственный кухонный нож 18 раз. Проверки Влияния на две категории (6) проще, если Вы пытаетесь запугать кого-то.",effect:{}},{text:"Доказательств нет, но слухи… Преступные сообщества поселения, в котором Вы живёте не менее месяца, относятся к Вам с опаской. Быть безразличными им не удаётся - либо ненависть, либо уважение. Уровни влияния с -2 до +2 недоступны, все сообщества должны выбрать свою сторону. Те, кому Вы не чинили явного зла, будут склонны выбрать дружбу. Переходить из -3 до +3 для Вас вдвое проще, чем в обратную сторону..",effect:{}},{text:"Кроме тех, кто Вас боится, есть ещё и те, кто Вам должен. Все проверки Влияния на категорию проще, если Вы провели в этом поселении не менее месяца. Этот бонус складывается с бонусом при угрозах.",effect:{}}]}],edges:[{type:"aspect",id:"mysticism",cost:4},{type:"aspect",id:"shadow",cost:2}]},{id:"shaman",name:{m:"Шаман",f:"Шаманка"},nameEn:"Shaman",professions:[],aspects:["mysticism","nature"],traits:[{id:"bearSkin",name:"Медвежья шкура",levels:[{text:"В бою Вы способны впадать в кровавую ярость - за каждую степень этого эффекта Ваши защита и атака повышаются на одну категорию, но Вы не можете сопротивляться соблазну рвать на части зубами и когтями тело поверженного врага, если оказываетесь вплотную к нему. Активация ярости происходит мгновенно, сразу на второй степени. Вы можете потратить действие, чтобы снизить уровень эффекта на единицу, проведя проверку категории Простая + степень эффекта. В случае провала, Вы не можете контролировать своего персонажа следующий ход. Расправа над поверженным занимает целое действие.",effect:{}},{text:"За каждого разодранного противника Вы получаете дополнительную степень эффекта, вплоть до пяти. Начиная с третьей, расправа над противником требует только один порыв.",effect:{}},{text:"Максимальная степень эффекта теперь шестая. Начиная с третьей Вы мгновенно раздираете противника на части, если добиваете своей атакой. Если же он уже был повержен к тому моменту, Вам требуется один порыв.",effect:{}}]},{id:"iSee",name:"Я вижу",levels:[{text:"Духи говорят с Вами, позволяют видеть своими глазами. Вы получаете дополнительную информацию о том, что происходит в пределах километра от Вас. Проверки Поиска легче на одну категорию.",effect:{}},{text:"Духи видят прошлое и будущее. Вы можете узнать прошлое и будущее места, которое посетили, если свяжетесь с духами, которые здесь живут. Доступна особая проверка Интуиции, сложность на усмотрение мастера.",effect:{}},{text:"Духи помнят, помнят всё. Вы можете ограниченно получать информацию от мёртвых. Доступна особая проверка интуиции, сложность на усмотрение мастера.",effect:{}}]},{id:"visions",name:"Видения",levels:[{text:"Знать - недостаточно, нужно ещё суметь применить эти знания на пользу делу. Вы учитесь использовать полученную информацию для шпионажа и диверсий, таким образом можете облегчить любую проверку Диверсии на одну категорию.",effect:{}},{text:"Предупреждён - значит вооружён. Позволяет усложнить вражеские проверки Диверсии против какого-то предприятия на одну категорию.",effect:{}},{text:"Удваивает бонусы двух предыдущих уровней этого умения.",effect:{}}]}],edges:[{type:"aspect",id:"mysticism",cost:2},{type:"aspect",id:"nature",cost:4}]},{id:"fixer",name:{m:"Решала",f:"Решала"},nameEn:"Fixer",professions:[],aspects:["knowledge","shadow"],traits:[{id:"sneakyStrike",name:"Подлый удар",levels:[{text:"Вы не рыцарь в сверкающих доспехах, а всего лишь деловой человек, который не хочет проблем. Но иногда проблемы приходят сами… Потратив один порыв Вы можете нанести точный лёгкий удар рукой по противнику. Если Вы держите в руках оружие, считается что Вы ударили рукоятью, гардой, древком. Этот удар гарантировано сработает против противника, который ещё не знает что Вы так умеете. Но только один раз, и всех увидевших Вы уже не сможете удивить повторно.",effect:{}},{text:"Ваша точная неожиданная атага теперь наносит лёгкую травму, а не царапину. После такой атаки защита противника снижена на две категории.",effect:{}},{text:"Разнообразие. Вы знаете столько приёмов, что можете удивить каждого. Если Вы используете подлый удар, в течении этого хода Вы можете применить его несколько раз до полного исчерпания порывов.",effect:{}}]},{id:"whileNoOneSees",name:"Пока никто не видит",levels:[{text:"Ваша специализация - тёмные дела, чаще всего торговые. Вы проводите теневые сделки проще, зарабатываете с них больше. Проверки проще на одну категорию, прибыль также больше на одну.",effect:{}},{text:"Ваши шансы найти что-то действительно ценное значительно повышаются, если Вы занимаетесь торговлей. Поиск через Влияние работает на две категории проще, если Вы знаете, что именно ищете.",effect:{}},{text:"Торговля удаётся Вам всё лучше - теперь проверки и прибыль лучше сразу на две категории. Раз в месяц Вы можете провести особенно крупную сделку, с повышенными шансами на провал и на то, что Вас поймают.",effect:{}}]},{id:"boundByBlood",name:"Повязанные кровью",levels:[{text:"У Вас обширная сеть контактов в криминальном мире, преимущественно - среди гильдий воров. Ваши отношения с ними изначально на уровне 4, Сопереживание, но могут и меняться со временем.",effect:{}},{text:"В любом поселении цивилизованного мира Вы легко можете найти своих. За звонкую монету они готовы выполнить любой заказ. Доступен особый тип наёмников - разъярённые бедняки. Они способны устроить беспорядки в своём селении, но не покинут его пределов.",effect:{}},{text:"Вам доступен особый тип наёмников - городские бандиты. Могут наниматься только в крупных городах, их дисциплина хромает, как и мораль. Зато они обходятся крайне дёшево и с такими потерями можно не считаться.",effect:{}}]}],edges:[{type:"aspect",id:"knowledge",cost:3},{type:"aspect",id:"shadow",cost:3}]},{id:"champion",name:{m:"Чемпион",f:"Чемпион"},nameEn:"Champion",professions:[],aspects:["war"],traits:[{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]}],edges:[{type:"aspect",id:"war",cost:2}]},{id:"strategist",name:{m:"Стратег",f:"Стратег"},nameEn:"Strategist",professions:[],aspects:["war"],traits:[{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]}],edges:[{type:"aspect",id:"war",cost:2},{type:"class",id:"surgeon",cost:4}]},{id:"sniper",name:{m:"Снайпер",f:"Снайпер"},nameEn:"Sniper",professions:[],aspects:["war"],traits:[{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]}],edges:[{type:"aspect",id:"war",cost:2},{type:"class",id:"warden",cost:4}]},{id:"surgeon",name:{m:"Хирург",f:"Хирург"},nameEn:"Surgeon",professions:[],aspects:["knowledge"],traits:[{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]}],edges:[{type:"aspect",id:"knowledge",cost:2},{type:"class",id:"strategist",cost:4}]},{id:"magister",name:{m:"Магистр",f:"Магистр"},nameEn:"Magister",professions:[],aspects:["knowledge"],traits:[{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]}],edges:[{type:"aspect",id:"knowledge",cost:2}]},{id:"advisor",name:{m:"Советник",f:"Советница"},nameEn:"Advisor",professions:[],aspects:["knowledge"],traits:[{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]}],edges:[{type:"aspect",id:"knowledge",cost:2},{type:"class",id:"politician",cost:4}]},{id:"politician",name:{m:"Политик",f:"Политик"},nameEn:"Politician",professions:[],aspects:["community"],traits:[{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]}],edges:[{type:"aspect",id:"community",cost:2},{type:"class",id:"advisor",cost:4}]},{id:"leader",name:{m:"Лидер",f:"Лидер"},nameEn:"Leader",professions:[],aspects:["community"],traits:[{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]}],edges:[{type:"aspect",id:"community",cost:2}]},{id:"instigator",name:{m:"Провокатор",f:"Провокатор"},nameEn:"Instigator",professions:[],aspects:["community"],traits:[{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]}],edges:[{type:"aspect",id:"community",cost:2},{type:"class",id:"spy",cost:4}]},{id:"spy",name:{m:"Шпион",f:"Шпион"},nameEn:"Spy",professions:[],aspects:["shadow"],traits:[{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]}],edges:[{type:"aspect",id:"shadow",cost:2},{type:"class",id:"instigator",cost:4}]},{id:"thief",name:{m:"Вор",f:"Вор"},nameEn:"Thief",professions:[],aspects:["shadow"],traits:[{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]}],edges:[{type:"aspect",id:"shadow",cost:2}]},{id:"trickster",name:{m:"Шулер",f:"Шулер"},nameEn:"Trickster",professions:[],aspects:["shadow"],traits:[{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]}],edges:[{type:"aspect",id:"shadow",cost:2},{type:"class",id:"mentalist",cost:4}]},{id:"mentalist",name:{m:"Менталист",f:"Менталист"},nameEn:"Mentalist",professions:[],aspects:["mysticism"],traits:[{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]}],edges:[{type:"aspect",id:"mysticism",cost:2},{type:"class",id:"trickster",cost:4}]},{id:"occultist",name:{m:"Оккультист",f:"Оккультист"},nameEn:"Occultist",professions:[],aspects:["mysticism"],traits:[{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]}],edges:[{type:"aspect",id:"mysticism",cost:2}]},{id:"seer",name:{m:"Провидец",f:"Провидица"},nameEn:"Seer",professions:[],aspects:["mysticism"],traits:[{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]}],edges:[{type:"aspect",id:"mysticism",cost:2},{type:"class",id:"stalker",cost:4}]},{id:"stalker",name:{m:"Сталкер",f:"Сталкер"},nameEn:"Stalker",professions:[],aspects:["nature"],traits:[{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]}],edges:[{type:"aspect",id:"nature",cost:2},{type:"class",id:"seer",cost:4}]},{id:"archon",name:{m:"Архонт",f:"Архонт"},nameEn:"Archon",professions:[],aspects:["nature"],traits:[{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]}],edges:[{type:"aspect",id:"nature",cost:2}]},{id:"warden",name:{m:"Страж",f:"Страж"},nameEn:"Warden",professions:[],aspects:["nature"],traits:[{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]}],edges:[{type:"aspect",id:"nature",cost:2},{type:"class",id:"sniper",cost:4}]}],Ba={systemName:"triP Classes",version:"1.0"},vs={classes:Ua,metadata:Ba},Wa=[{id:"clothes",category:"armor",subcat:"light",name:"Обычная одежда",desc:"Надевать такую в бой - довольно сомнительная затея. Однако на полях сражений нередко оказывались те, кто не смог себе позволить вовсе никакую броню. А иногда и серьёзных воинов нападение заставало не готовыми, погружёнными в обычные бытовые проблемы.",price:1,epoch:1,defence:0,resist:0,movement:0,bursts:0},{id:"makeshift_light_armor",category:"armor",subcat:"light",name:"Крепкая одежда",desc:"Некоторые виды одежды лучше других держат удар, что позволяет использовать их в качестве импровизированной брони. Это может быть куртка из толстой кожи, шкура зверя или вовсе обычные одеяния, на которые нашили твёрдые элементы.",price:3,epoch:2,defence:3,resist:0,movement:0,bursts:0},{id:"makeshift_heavy_armor",category:"armor",subcat:"heavy",name:"Кустарная тяжёлая броня",desc:"Хорошенько потрудившись, можно сделать из обычной одежды некое подобие брони. Обилие нашитых элементов здорово сковывает движение, зато такой доспех снижает входящий урон и (главное), очень дёшев в производстве.",price:3,epoch:2,defence:0,resist:1,movement:-1,bursts:-1},{id:"light_armor",category:"armor",subcat:"light",name:"Лёгкая броня",desc:"Лёгкая броня не сковывает движений и даёт кое-какую защиту - попасть в уязвимое место противнику становится значительно сложнее.",price:5,epoch:4,defence:6,resist:0,movement:0,bursts:0},{id:"heavy_armor",category:"armor",subcat:"heavy",name:"Тяжёлая броня",desc:"Хорошая тяжёлая броня лишь немного сковывает движения, но уворачиваться в ней уже гораздо сложнее. Зато, если по Вам всё же попали, урона Вы получите значительно меньше.",price:5,epoch:4,defence:0,resist:1,movement:-1,bursts:0},{id:"late_light_armor",category:"armor",subcat:"light",name:"Поздняя лёгкая броня",desc:"Позволить себе такой шедевр мастерства бронников могут не многие, зато живут на поле боя эти счастливчики гораздо дольше других. Защищённых областей на теле больше, а маневренность при этом никак не страдает.",price:7,epoch:6,defence:12,resist:0,movement:0,bursts:0},{id:"late_medium_armor",category:"armor",subcat:"middle",name:"Поздняя средняя броня",desc:"Хороший компромисс между подвижностью и защищённостью, но по совершенно бескомпромиссной цене.",price:7,epoch:6,defence:3,resist:1,movement:0,bursts:0},{id:"late_heavy_armor",category:"armor",subcat:"heavy",name:"Поздняя тяжёлая броня",desc:"Для тех, кто хочет почувствовать себя настоящим танком на поле боя - беспрецедентный уровень защищённости при минимальной подвижности. Несмотря на огромную цену этих доспехов, вряд ли найдётся идиот, который захочет сразиться с Вами ради такого трофея.",price:7,epoch:6,defence:0,resist:2,movement:-1,bursts:0},{id:"simple_spear",category:"weapon",subcat:"spears",name:"Простое копьё",desc:"",length:2,hands:1,price:2,epoch:2,attack:4,defence:3,damageType:"Колющий",armorPen:0,damage:{0:"Царапина",3:"Лёгкий урон",6:"Точный удар"}},{id:"iron_spear",category:"weapon",subcat:"spears",name:"Железное копьё",desc:"",length:2,hands:1,price:4,epoch:4,attack:5,defence:3,damageType:"Колющий",armorPen:0,damage:{0:"Царапина",2:"Лёгкий урон",4:"Точный удар",6:"Тяжёлый урон"}},{id:"steel_spear",category:"weapon",subcat:"spears",name:"Стальное копьё",desc:"",length:2,hands:1,price:6,epoch:6,attack:6,defence:4,damageType:"Колющий",armorPen:0,damage:{0:"Царапина",2:"Лёгкий урон",4:"Точный удар",6:"Тяжёлый урон",9:"Огромный урон"}},{id:"iron_glaive",category:"weapon",subcat:"spears",name:"Глефа",desc:"",length:2,hands:2,price:5,epoch:5,attack:6,defence:2,damageType:"Рубящий",armorPen:0,damage:{0:"Лёгкий урон",3:"Тяжёлый урон",6:"Точный удар",9:"Огромный урон"}},{id:"steel_glaive",category:"weapon",subcat:"spears",name:"Стальная глефа",desc:"",length:2,hands:2,price:7,epoch:7,attack:8,defence:4,damageType:"Рубящий",armorPen:0,damage:{0:"Лёгкий урон",2:"Тяжёлый урон",4:"Точный удар",8:"Огромный урон"}},{id:"iron_halberd",category:"weapon",subcat:"spears",name:"Алебарда",desc:"",length:2,hands:2,price:5,epoch:5,attack:4,defence:3,damageType:"Рубящий",armorPen:0,damage:{0:"Лёгкий урон",2:"Тяжёлый урон",6:"Огромный урон"}},{id:"steel_halberd",category:"weapon",subcat:"spears",name:"Стальная алебарда",desc:"",length:2,hands:2,price:7,epoch:7,attack:5,defence:4,damageType:"Рубящий",armorPen:0,damage:{0:"Лёгкий урон",2:"Тяжёлый урон",6:"Огромный урон"}},{id:"simple_bow",category:"weapon",subcat:"bows",name:"Короткий лук",desc:"",spec:"Нельзя стрелять с порывом",length:2,hands:2,price:3,epoch:2,attack:6,defence:0,damageType:"Колющий",armorPen:0,damage:{0:"Царапина",3:"Лёгкий урон",6:"Точный удар"}},{id:"strong_bow",category:"weapon",subcat:"bows",name:"Боевой лук",desc:"",spec:"",length:2,hands:2,price:4,epoch:4,attack:6,defence:0,damageType:"Колющий",armorPen:0,damage:{0:"Царапина",3:"Лёгкий урон",6:"Точный удар",9:"Тяжёлый урон"}},{id:"longbow",category:"weapon",subcat:"bows",name:"Длинный лук",desc:"",spec:"Нельзя стрелять без порыва. Можно вкладывать в выстрел второй порыв, тогда игнорирует единицу брони.",length:2,hands:2,price:5,epoch:4,attack:6,defence:0,damageType:"Колющий",armorPen:0,damage:{0:"Лёгкий урон",3:"Точный удар",6:"Тяжёлый урон",12:"Огромный урон"}},{id:"stone_knife",category:"weapon",subcat:"daggers",name:"Простой нож",desc:"",length:1,hands:.5,price:1,epoch:1,attack:2,defence:0,damageType:"Колющий",armorPen:0,damage:{0:"Царапина",3:"Лёгкий урон",5:"Точный удар"}},{id:"knife",category:"weapon",subcat:"daggers",name:"Добротный нож",desc:"",length:1,hands:.5,price:2,epoch:2,attack:2,defence:1,damageType:"Колющий",armorPen:0,damage:{0:"Царапина",2:"Лёгкий урон",3:"Точный удар"}},{id:"steel_dagger",category:"weapon",subcat:"daggers",name:"Cтальной кинжал",desc:"",length:1,hands:.5,price:5,epoch:4,attack:3,defence:1,damageType:"Колющий",armorPen:0,damage:{0:"Царапина",2:"Лёгкий урон",3:"Точный удар",4:"Тяжёлый урон"}},{id:"stiletto",category:"weapon",subcat:"daggers",name:"Стилет",desc:"Стилет не особенно то удобен в бою, зато замечательно пронзает многие виды доспехов.",length:1,hands:.5,price:6,epoch:5,attack:2,defence:0,damageType:"Колющий",armorPen:2,damage:{0:"Царапина",2:"Лёгкий урон",3:"Точный удар",6:"Тяжёлый урон"}},{id:"main_gauche",category:"weapon",subcat:"daggers",name:"Дага",desc:"Дага - преимущественно защитный кинжал во вторую руку, тем не менее может применяться и для нанесения серьёзных ударов. Особенно, если вражеская защита пробита. Атаки дагой во второй руке могут наносить ту же категорию ранения, что и атаки основным оружием, а не на категорию ниже, как обычно.",length:1,hands:1,price:6,epoch:5,attack:2,defence:4,damageType:"Колющий",armorPen:0,damage:{0:"Царапина",2:"Лёгкий урон",3:"Точный удар",6:"Тяжёлый урон"}},{id:"wooden_flail",category:"weapon",subcat:"flails",name:"Цеп",desc:"",length:1,hands:1,price:1,epoch:2,attack:6,defence:0,damageType:"Дробящий",armorPen:1,damage:{0:"Царапина",3:"Лёгкий урон"}},{id:"iron_flail",category:"weapon",subcat:"flails",name:"Железный цеп",desc:"",length:2,hands:1,price:5,epoch:4,attack:8,defence:0,damageType:"Дробящий",armorPen:1,damage:{0:"Царапина",6:"Лёгкий урон",12:"Тяжёлый урон",15:"Точный удар"}},{id:"steel_flail",category:"weapon",subcat:"flails",name:"Стальной цеп",desc:"",length:2,hands:1,price:6,epoch:6,attack:9,defence:0,damageType:"Дробящий",armorPen:1,damage:{0:"Царапина",6:"Лёгкий урон",9:"Тяжёлый урон",12:"Точный удар"}},{id:"wooden_club",category:"weapon",subcat:"maces",name:"Дубинка",desc:"",length:1,hands:1,price:1,epoch:1,attack:2,defence:2,damageType:"Дробящий",armorPen:1,damage:{0:"Царапина",6:"Лёгкий урон"}},{id:"simple_staff",category:"weapon",subcat:"maces",name:"Простой посох",desc:"",length:2,hands:2,price:1,epoch:1,attack:2,defence:2,damageType:"Дробящий",armorPen:0,damage:{0:"Царапина",6:"Лёгкий урон"}},{id:"battle_staff",category:"weapon",subcat:"maces",name:"Боевой посох",desc:"",length:2,hands:2,price:3,epoch:3,attack:4,defence:2,damageType:"Дробящий",armorPen:0,damage:{0:"Царапина",5:"Лёгкий урон",10:"Тяжёлый урон"}},{id:"steel_staff",category:"weapon",subcat:"maces",name:"Стальной посох",desc:"",length:2,hands:2,price:5,epoch:5,attack:4,defence:4,damageType:"Дробящий",armorPen:1,damage:{0:"Царапина",5:"Лёгкий урон",10:"Тяжёлый урон"}},{id:"iron_mace",category:"weapon",subcat:"maces",name:"Булава",desc:"",length:1,hands:1,price:5,epoch:4,attack:4,defence:2,damageType:"Дробящий",armorPen:1,damage:{0:"Царапина",6:"Тяжёлый урон",12:"Точный удар"}},{id:"steel_mace",category:"weapon",subcat:"maces",name:"Стальная булава",desc:"",length:1,hands:1,price:7,epoch:6,attack:5,defence:3,damageType:"Дробящий",armorPen:1,damage:{0:"Царапина",2:"Лёгкий урон",4:"Тяжёлый урон",6:"Точный удар"}},{id:"simple_axe",category:"weapon",subcat:"axes",name:"Плотницкий топор",desc:"",length:1,hands:1,price:2,epoch:1,attack:4,defence:2,damageType:"Режущий",armorPen:0,damage:{0:"Царапина",8:"Тяжёлый урон",9:"Точный удар"}},{id:"battle_axe",category:"weapon",subcat:"axes",name:"Боевой топорик",desc:"",length:1,hands:1,price:5,epoch:4,attack:6,defence:3,damageType:"Режущий",armorPen:0,damage:{0:"Царапина",3:"Лёгкий урон",6:"Точный удар",9:"Тяжёлый урон"}},{id:"steel_axe",category:"weapon",subcat:"axes",name:"Стальной топор",desc:"",length:1,hands:1,price:6,epoch:7,attack:8,defence:3,damageType:"Режущий",armorPen:0,damage:{0:"Царапина",2:"Лёгкий урон",4:"Точный удар",6:"Тяжёлый урон"}},{id:"battle_greataxe",category:"weapon",subcat:"axes",name:"Двуручный топор",desc:"",length:2,hands:2,price:6,epoch:5,attack:6,defence:3,damageType:"Режущий",armorPen:0,damage:{0:"Лёгкий урон",3:"Тяжёлый урон",9:"Огромный урон",12:"Точный удар"}},{id:"steel_greataxe",category:"weapon",subcat:"axes",name:"Стальной двуручный топор",desc:"",length:2,hands:2,price:7,epoch:7,attack:8,defence:3,damageType:"Режущий",armorPen:0,damage:{0:"Лёгкий урон",2:"Тяжёлый урон",8:"Огромный урон",10:"Точный удар"}},{id:"stone_hammer",category:"weapon",subcat:"maces",name:"Каменный молоток",desc:"",length:1,hands:1,price:2,epoch:2,attack:2,defence:0,damageType:"Дробящий",armorPen:1,damage:{0:"Лёгкий урон",6:"Тяжёлый урон",12:"Точный удар"}},{id:"stone_greathammer",category:"weapon",subcat:"maces",name:"Каменная кувалда",desc:"",length:2,hands:2,price:2,epoch:2,attack:0,defence:0,damageType:"Дробящий",armorPen:1,damage:{0:"Тяжёлый урон",6:"Огромный урон"}},{id:"iron_hammer",category:"weapon",subcat:"maces",name:"Железный молот",desc:"",length:1,hands:1,price:3,epoch:3,attack:3,defence:0,damageType:"Дробящий",armorPen:1,damage:{0:"Лёгкий урон",5:"Тяжёлый урон",10:"Точный удар"}},{id:"iron_greathammer",category:"weapon",subcat:"maces",name:"Железная кувалда",desc:"",length:2,hands:2,price:5,epoch:4,attack:0,defence:0,damageType:"Дробящий",armorPen:1,damage:{0:"Тяжёлый урон",5:"Огромный урон"}},{id:"iron_warhammer",category:"weapon",subcat:"maces",name:"Железный боевой молот",desc:"",length:1,hands:1,price:4,epoch:4,attack:4,defence:0,damageType:"Дробящий",armorPen:2,damage:{0:"Лёгкий урон",6:"Тяжёлый урон",12:"Точный удар"}},{id:"iron_greatwarhammer",category:"weapon",subcat:"maces",name:"Двуручный боевой молот",desc:"",length:2,hands:2,price:6,epoch:5,attack:2,defence:0,damageType:"Дробящий",armorPen:2,damage:{0:"Тяжёлый урон",6:"Огромный урон",12:"Точный удар"}},{id:"steel_warhammer",category:"weapon",subcat:"maces",name:"Стальной боевой молот",desc:"",length:1,hands:1,price:6,epoch:7,attack:5,defence:2,damageType:"Дробящий",armorPen:2,damage:{0:"Лёгкий урон",4:"Тяжёлый урон",8:"Точный удар"}},{id:"steel_greatwarhammer",category:"weapon",subcat:"maces",name:"Длинный стальной боевой молот",desc:"",length:2,hands:2,price:7,epoch:7,attack:3,defence:2,damageType:"Дробящий",armorPen:2,damage:{0:"Тяжёлый урон",4:"Огромный урон",8:"Точный удар"}},{id:"wooden_buckler",category:"shield",subcat:"shields",name:"Деревянный баклер",desc:"",spec:"Баклер может использоваться для атак, как второе оружие.",length:0,hands:.5,price:5,epoch:4,attack:1,defence:{front:{melee:3,ranged:3},side:{melee:3,ranged:0}}},{id:"wooden_shield",category:"shield",subcat:"shields",name:"Деревянный щит",desc:"",spec:"Небольшим щитом можно толкать противника, затратив один порыв.",length:0,hands:1,price:4,epoch:3,attack:1,defence:{front:{melee:6,ranged:6}}},{id:"large_wooden_shield",category:"shield",subcat:"shields",name:"Большой деревянный щит",desc:"",length:0,hands:1,price:5,epoch:3,defence:{front:{melee:6,ranged:9}}},{id:"wooden_tower_shield",category:"shield",subcat:"shields",name:"Деревянный башенный щит",desc:"",length:0,hands:1,price:5,epoch:3,movement:-1,attack:-3,defence:{front:{melee:9,ranged:12}}},{id:"metal_buckler",category:"shield",subcat:"shields",name:"Стальной баклер",desc:"",spec:"Баклер может использоваться для атак, как второе оружие.",length:0,hands:.5,price:6,epoch:6,attack:3,defence:{front:{melee:6,ranged:3},side:{melee:6,ranged:0}}},{id:"metal_shield",category:"shield",subcat:"shields",name:"Стальной щит",desc:"",spec:"Небольшим щитом можно толкать противника, затратив один порыв.",length:0,hands:1,price:7,epoch:6,attack:3,defence:{front:{melee:6,ranged:6}}},{id:"large_metal_shield",category:"shield",subcat:"shields",name:"Большой стальной щит",desc:"",length:0,hands:1,price:5,epoch:7,attack:1,defence:{front:{melee:9,ranged:9}}},{id:"metal_tower_shield",category:"shield",subcat:"shields",name:"Cтальной башенный щит",desc:"",length:0,hands:1,price:7,epoch:7,defence:{front:{melee:12,ranged:12}}},{id:"iron_shortsword",category:"weapon",subcat:"swords",name:"Короткий меч",desc:"",length:1,hands:1,price:4,epoch:3,attack:3,defence:5,damageType:"Режущий",armorPen:0,damage:{0:"Царапина",4:"Лёгкий урон",8:"Точный удар",12:"Тяжёлый урон"}},{id:"iron_sword",category:"weapon",subcat:"swords",name:"Меч пехотинца",desc:"",length:2,hands:1,price:4,epoch:4,attack:5,defence:5,damageType:"Режущий",armorPen:0,damage:{0:"Царапина",3:"Лёгкий урон",6:"Точный удар",10:"Тяжёлый урон"}},{id:"iron_falchion",category:"weapon",subcat:"swords",name:"Фальшион",desc:"",length:1,hands:1,price:4,epoch:4,attack:7,defence:4,damageType:"Режущий",armorPen:0,damage:{0:"Царапина",3:"Лёгкий урон",6:"Точный удар",10:"Тяжёлый урон"}},{id:"iron_greatsword",category:"weapon",subcat:"swords",name:"Двуручный меч",desc:"",length:2,hands:2,price:5,epoch:4,attack:6,defence:3,damageType:"Режущий",armorPen:0,damage:{0:"Лёгкий урон",4:"Тяжёлый урон",8:"Огромный урон"}},{id:"steel_shortsword",category:"weapon",subcat:"swords",name:"Стальной короткий меч",desc:"",length:1,hands:1,price:6,epoch:6,attack:4,defence:5,damageType:"Режущий",armorPen:0,damage:{0:"Царапина",3:"Лёгкий урон",6:"Точный удар",9:"Тяжёлый урон"}},{id:"steel_sword",category:"weapon",subcat:"swords",name:"Стальной меч",desc:"",length:2,hands:1,price:7,epoch:6,attack:6,defence:6,damageType:"Режущий",armorPen:0,damage:{0:"Царапина",2:"Лёгкий урон",4:"Точный удар",8:"Тяжёлый урон"}},{id:"steel_saber",category:"weapon",subcat:"swords",name:"Сабля",desc:"",length:2,hands:1,price:7,epoch:7,attack:8,defence:3,damageType:"Режущий",armorPen:0,damage:{0:"Царапина",3:"Лёгкий урон",6:"Тяжёлый урон",8:"Точный удар"}},{id:"steel_scimitar",category:"weapon",subcat:"swords",name:"Скимитар",desc:"",length:2,hands:1,price:7,epoch:7,attack:9,defence:2,damageType:"Режущий",armorPen:0,damage:{0:"Царапина",3:"Лёгкий урон",6:"Тяжёлый урон",9:"Точный удар"}},{id:"steel_greatsword",category:"weapon",subcat:"swords",name:"Качественный двуручный меч",desc:"",length:2,hands:2,price:7,epoch:6,attack:7,defence:4,damageType:"Режущий",armorPen:0,damage:{0:"Лёгкий урон",4:"Тяжёлый урон",6:"Огромный урон"}},{id:"rapier",category:"weapon",subcat:"swords",name:"Рапира",desc:"",length:2,hands:1.5,price:6,epoch:7,attack:7,defence:3,damageType:"Колющий",armorPen:0,damage:{0:"Царапина",2:"Лёгкий урон",6:"Точный удар",8:"Тяжёлый урон"}},{id:"hand_crossbow",category:"weapon",subcat:"crossbows",name:"Ручной арбалет",desc:"Требует порыва на перезарядку",length:2,hands:1.5,price:5,epoch:5,attack:4,defence:0,damageType:"Колющий",armorPen:0,damage:{0:"Царапина",5:"Лёгкий урон"}},{id:"crossbow",category:"weapon",subcat:"crossbows",name:"Арбалет",desc:"Требуется два порыва или полное основное действие на перезарядку",length:2,hands:2,price:6,epoch:5,attack:6,defence:0,damageType:"Колющий",armorPen:0,damage:{0:"Царапина",4:"Лёгкий урон",6:"Точный удар",8:"Тяжёлый урон"}},{id:"heavy_crossbow",category:"weapon",subcat:"crossbows",name:"Тяжёлый арбалет",desc:"Требуется полное действие и один порыв на перезарядку, в процессе нельзя передвигаться.",length:2,hands:2,price:6,epoch:5,attack:8,defence:0,damageType:"Колющий",armorPen:1,damage:{0:"Царапина",4:"Лёгкий урон",6:"Точный удар",8:"Тяжёлый урон"}},{id:"sling",category:"weapon",subcat:"slings",name:"Простая праща",desc:"",spec:"Нельзя стрелять с порывом",length:2,hands:2,price:2,epoch:2,attack:3,defence:0,damageType:"Дробящий",armorPen:0,damage:{0:"Царапина",3:"Лёгкий урон"}},{id:"heavy_sling",category:"weapon",subcat:"slings",name:"Боевая праща",desc:"",spec:"Нельзя стрелять без порыва",length:2,hands:2,price:4,epoch:3,attack:4,defence:0,damageType:"Дробящий",armorPen:0,damage:{0:"Царапина",3:"Лёгкий урон",9:"Тяжёлый урон"}}],qa={systemName:"triP Items",version:"1.0",totalItems:110},Ft={items:Wa,metadata:qa},wt=(t,o)=>{const a=t.__vccOpts||t;for(const[l,i]of o)a[l]=i;return a},Va=[{id:"dwarf",name:"Дворфы",nameEn:"Dwarf",description:"Крепкие и стойкие мастера камня и металла, живущие в горных твердынях",icon:"🧔",position:{aspects:["war","knowledge"],description:"Между Войной и Знанием"},color:"amber",subraceAliases:{}},{id:"human",name:"Люди",nameEn:"Human",description:"Универсальные и адаптивные существа, способные проявить себя в любой сфере",icon:"👤",position:{aspects:["knowledge","community"],description:"Между Знанием и Обществом"},color:"slate",subraceAliases:{}},{id:"tiefling",name:"Тифлинги",nameEn:"Tiefling",description:"Существа с демоническим наследием, обладающие врождённой магией и харизмой",icon:"😈",position:{aspects:["community","shadow"],description:"Между Обществом и Тенью"},color:"purple",subraceAliases:{}},{id:"drow",name:"Дроу",nameEn:"Drow",description:"Тёмные эльфы подземий, мастера скрытности и магии теней",icon:"🕷️",position:{aspects:["shadow","mysticism"],description:"Между Тенью и Мистикой"},color:"gray",subraceAliases:{}},{id:"goblin",name:"Гоблины",nameEn:"Goblin",description:"Хитрые и изобретательные существа, выжившие благодаря смекалке",icon:"👺",position:{aspects:["mysticism","nature"],description:"Между Мистикой и Природой"},color:"green",subraceAliases:{}},{id:"orc",name:"Орки",nameEn:"Orc",description:"Могучие воины с первобытной силой и связью с природой",icon:"💪",position:{aspects:["nature","war"],description:"Между Природой и Войной"},color:"green",subraceAliases:{}},{id:"hobgoblin",name:"Хобгоблины",nameEn:"Hobgoblin",description:"Дисциплинированные и организованные военные стратеги",icon:"🎖️",position:{aspects:["war","community"],description:"Между Войной и Обществом"},color:"red",subraceAliases:{}},{id:"kobold",name:"Кобольды",nameEn:"Kobold",description:"Маленькие драконоподобные существа, изобретательные и хитрые",icon:"🦎",position:{aspects:["knowledge","shadow"],description:"Между Знанием и Тенью"},color:"orange",subraceAliases:{}},{id:"liminar",name:"Лиминары",nameEn:"Liminar",description:"Загадочные существа пограничных миров, обладающие глубокой связью с мистикой и обществом",icon:"✨",position:{aspects:["community","mysticism"],description:"Между Обществом и Мистикой"},color:"pink",subraceAliases:{}},{id:"shifter",name:"Шифтеры",nameEn:"Shifter",description:"Существа с ликантропическим наследием, способные менять облик",icon:"🐺",position:{aspects:["shadow","nature"],description:"Между Тенью и Природой"},color:"brown",subraceAliases:{}},{id:"ferrat",name:"Фераты",nameEn:"Ferrat",description:"Дикие гуманоиды с первобытной магией и боевыми инстинктами",icon:"🐉",position:{aspects:["mysticism","war"],description:"Между Мистикой и Войной"},color:"purple",subraceAliases:{}},{id:"elf",name:"Эльфы",nameEn:"Elf",description:"Грациозные и долгоживущие существа с глубокой связью с природой и знаниями",icon:"🧝",position:{aspects:["nature","knowledge"],description:"Между Природой и Знанием"},color:"emerald",subraceAliases:{}}],Zs={races:Va},$t={3:{name:"Ниже простой",short:"НП",level:1,modifier:"below",color:"#00DDFF",lightText:!1,linetype:"dashed"},6:{name:"Простая",short:"П",level:1,modifier:"base",color:"#00DDFF",lightText:!1,linetype:"single"},9:{name:"Выше простой",short:"ВП",level:1,modifier:"above",color:"#00DDFF",lightText:!1,linetype:"double"},12:{name:"Ниже лёгкой",short:"НЛ",level:2,modifier:"below",color:"#00CC44",lightText:!1,linetype:"dashed"},15:{name:"Лёгкая",short:"Л",level:2,modifier:"base",color:"#00CC44",lightText:!1,linetype:"single"},18:{name:"Выше лёгкой",short:"ВЛ",level:2,modifier:"above",color:"#00CC44",lightText:!1,linetype:"double"},21:{name:"Ниже средней",short:"НС",level:3,modifier:"below",color:"#FFEE00",lightText:!1,linetype:"dashed"},24:{name:"Средняя",short:"С",level:3,modifier:"base",color:"#FFEE00",lightText:!1,linetype:"single"},27:{name:"Выше средней",short:"ВС",level:3,modifier:"above",color:"#FFEE00",lightText:!1,linetype:"double"},30:{name:"Ниже тяжёлой",short:"НТ",level:4,modifier:"below",color:"#FF8800",lightText:!1,linetype:"dashed"},33:{name:"Тяжёлая",short:"Т",level:4,modifier:"base",color:"#FF8800",lightText:!1,linetype:"single"},36:{name:"Выше тяжёлой",short:"ВТ",level:4,modifier:"above",color:"#FF8800",lightText:!1,linetype:"double"},39:{name:"Ниже жестокой",short:"НЖ",level:5,modifier:"below",color:"#CC0000",lightText:!0,linetype:"dashed"},42:{name:"Жестокая",short:"Ж",level:5,modifier:"base",color:"#CC0000",lightText:!0,linetype:"single"},45:{name:"Выше жестокой",short:"ВЖ",level:5,modifier:"above",color:"#CC0000",lightText:!0,linetype:"double"},48:{name:"Ниже кошмарной",short:"НК",level:6,modifier:"below",color:"#440066",lightText:!0,linetype:"dashed"},51:{name:"Кошмарная",short:"К",level:6,modifier:"base",color:"#440066",lightText:!0,linetype:"single"},54:{name:"Выше кошмарной",short:"ВК",level:6,modifier:"above",color:"#440066",lightText:!0,linetype:"double"},60:{name:"Невозможная",short:"Н",level:7,modifier:"base",color:"#000000",lightText:!0,linetype:"single"}},Xa={class:"equipment-manager"},Ya={class:"weapon-sets-selector bg-slate-900/60 border border-white/10 rounded-2xl p-4 mb-4"},Ga={class:"flex gap-2 flex-wrap"},Ka=["onClick"],Qa={class:"armor-section bg-slate-900/60 border border-white/10 rounded-2xl p-4 mb-4"},Za={class:"flex items-center justify-between mb-3"},Ja={key:0,class:"p-3 bg-slate-950/40 rounded-lg border border-slate-700"},eo={class:"font-bold text-white mb-1"},to={class:"grid grid-cols-2 gap-2 text-xs"},so={class:"flex items-center justify-between p-2 bg-slate-900/60 rounded"},no={class:"text-emerald-400 font-bold"},lo={class:"flex items-center justify-between p-2 bg-slate-900/60 rounded"},ao={class:"text-blue-400 font-bold"},oo={class:"weapons-section bg-slate-900/60 border border-white/10 rounded-2xl p-4"},io={class:"flex items-center justify-between mb-3"},ro={class:"text-sm font-bold text-slate-400 uppercase flex items-center gap-2"},co={class:"flex items-center justify-between text-xs mb-1"},uo={class:"flex items-center justify-between text-xs"},fo={key:0,class:"mb-3 p-2 rounded-lg bg-red-900/20 border border-red-700"},vo={key:1,class:"space-y-2"},mo={class:"flex-1"},po={class:"font-bold text-white text-sm"},ho={class:"text-xs text-slate-400"},go={key:0},bo={key:1},yo={key:2},xo={key:3,class:"mt-1 text-[10px]"},ko={key:0},wo={key:1},_o={key:2},$o=["onClick"],Co={key:2,class:"text-slate-500 text-sm text-center py-4"},To={class:"bg-slate-900 rounded-2xl border border-white/10 max-w-2xl w-full max-h-[80vh] overflow-y-auto"},So={class:"sticky top-0 bg-slate-900 border-b border-white/10 p-4 flex items-center justify-between"},Io={class:"p-4 space-y-2"},Po=["onClick"],Eo={class:"font-bold text-white mb-1"},Mo={class:"text-xs text-slate-400 mb-2"},Ao={class:"grid grid-cols-4 gap-2 text-xs"},Do={class:"text-center"},No={class:"text-emerald-400 font-bold"},Lo={class:"text-center"},Fo={class:"text-blue-400 font-bold"},Ro={class:"text-center"},Oo={class:"text-center"},Ho={class:"bg-slate-900 rounded-2xl border border-white/10 max-w-4xl w-full max-h-[80vh] overflow-y-auto"},jo={class:"sticky top-0 bg-slate-900 border-b border-white/10 p-4 flex items-center justify-between"},zo={class:"text-xl font-bold"},Uo={class:"p-4 grid grid-cols-1 sm:grid-cols-2 gap-3"},Bo=["onClick","disabled"],Wo={class:"flex items-start justify-between mb-1"},qo={class:"font-bold text-white"},Vo={key:0,class:"text-red-400 text-xs"},Xo={class:"text-xs text-slate-400 mb-2 line-clamp-2"},Yo={class:"grid grid-cols-4 gap-2 text-xs"},Go={key:0,class:"text-center"},Ko={class:"text-red-400 font-bold"},Qo={key:1,class:"text-center"},Zo={class:"text-emerald-400 font-bold"},Jo={key:2,class:"col-span-4 p-2 bg-slate-900/60 rounded"},ei={class:"space-y-1 text-[9px]"},ti={key:0,class:"flex justify-between"},si={class:"text-emerald-400 font-bold"},ni={class:"text-sky-400 font-bold"},li={key:1,class:"flex justify-between"},ai={class:"text-emerald-400 font-bold"},oi={class:"text-sky-400 font-bold"},ii={key:2,class:"flex justify-between"},ri={class:"text-emerald-400 font-bold"},ci={class:"text-sky-400 font-bold"},di={key:3,class:"text-center"},ui={class:"text-cyan-400 font-bold"},fi={key:4,class:"text-center"},vi={class:"text-purple-400 font-bold"},mi={__name:"EquipmentManager",props:{character:{type:Object,required:!0}},emits:["update:character"],setup(t,{emit:o}){const a=t,l=o,i=X(()=>Ft.items.filter(O=>O.category==="armor")),d=X(()=>Ft.items.filter(O=>O.category==="weapon"||O.category==="shield")),v=X({get:()=>{var O;return((O=a.character.equipment)==null?void 0:O.activeSetIndex)||0},set:O=>{T({activeSetIndex:O})}}),E=X(()=>{var O,S;return((S=(O=a.character.equipment)==null?void 0:O.weaponSets)==null?void 0:S[v.value])||{name:"Набор 1",weapons:[]}}),g=X(()=>{var S;const O=((S=a.character.equipment)==null?void 0:S.armor)||"clothes";return i.value.find(D=>D.id===O)}),b=X(()=>E.value.weapons.map(O=>d.value.find(S=>S.id===O)).filter(Boolean)),I=X(()=>{const O=b.value,S=O.reduce((h,_)=>h+(_.hands||0),0),D=O.filter(h=>h.length===2).length,r=[];return S>2&&r.push(`Сумма рук превышает 2 (текущая: ${S})`),D>1&&r.push(`Нельзя держать больше одного длинного оружия (текущее: ${D})`),{valid:r.length===0,errors:r,totalHands:S,longWeaponsCount:D}}),M=O=>{const S=d.value.find(_=>_.id===O);if(!S)return!1;const D=[...b.value,S],r=D.reduce((_,P)=>_+(P.hands||0),0),h=D.filter(_=>_.length===2).length;return r<=2&&h<=1},R=X(()=>{var B,ce,Y,ve,H;const O=((B=a.character.equipment)==null?void 0:B.wealth)||0,S=((ce=a.character.equipment)==null?void 0:ce.epoch)||0,D=((Y=a.character.inventory)==null?void 0:Y.map(y=>typeof y=="string"?y:y.id))||[],r=((H=(ve=a.character.equipment)==null?void 0:ve.weaponSets)==null?void 0:H.flatMap(y=>y.weapons))||[],h=[...new Set([...r,...D])],_=d.value.filter(y=>h.includes(y.id)),P=d.value.filter(y=>{if(h.includes(y.id))return!1;const L=(y.wealth||y.price||0)<=O,le=(y.epoch||0)<=S;return L&&le});return[..._,...P]}),T=O=>{const S={...a.character,equipment:{...a.character.equipment,...O}};l("update:character",S)},F=O=>{T({armor:O})},Z=O=>{var r;if(!M(O))return;const S=[...((r=a.character.equipment)==null?void 0:r.weaponSets)||[]],D={...S[v.value]};D.weapons.includes(O)||(D.weapons=[...D.weapons,O],S[v.value]=D,T({weaponSets:S}))},j=O=>{var r;const S=[...((r=a.character.equipment)==null?void 0:r.weaponSets)||[]],D={...S[v.value]};D.weapons=D.weapons.filter(h=>h!==O),S[v.value]=D,T({weaponSets:S})},oe=()=>{var D;const O=[...((D=a.character.equipment)==null?void 0:D.weaponSets)||[]],S=O.length+1;O.push({name:`Набор ${S}`,weapons:[]}),T({weaponSets:O})},ie=Q(!1),ne=Q(!1);return(O,S)=>{var D;return s(),n("div",Xa,[e("div",Ya,[S[6]||(S[6]=e("h3",{class:"text-sm font-bold text-slate-400 uppercase mb-3"},"Активный набор",-1)),e("div",Ga,[(s(!0),n(W,null,re(((D=t.character.equipment)==null?void 0:D.weaponSets)||[],(r,h)=>(s(),n("button",{key:h,onClick:_=>v.value=h,class:te(["flex-1 min-w-[120px] px-4 py-2 rounded-lg font-semibold transition-all",v.value===h?"bg-amber-500/20 border-2 border-amber-400 text-amber-100":"bg-slate-800/40 border border-slate-700 text-slate-400 hover:bg-slate-800/60"])},u(r.name),11,Ka))),128)),e("button",{onClick:oe,class:"px-4 py-2 rounded-lg border border-dashed border-slate-600 text-slate-500 hover:border-amber-500 hover:text-amber-400 transition-all",title:"Добавить набор (требуется особая способность)"}," + Новый набор ")])]),e("div",Qa,[e("div",Za,[S[7]||(S[7]=e("h3",{class:"text-sm font-bold text-slate-400 uppercase flex items-center gap-2"},[e("span",null,"🛡️"),ke(" Броня ")],-1)),e("button",{onClick:S[0]||(S[0]=r=>ie.value=!0),class:"px-3 py-1 text-xs rounded-lg bg-sky-500/20 border border-sky-400/60 text-sky-100 hover:bg-sky-500/30 transition"}," Сменить ")]),g.value?(s(),n("div",Ja,[e("h4",eo,u(g.value.name),1),e("div",to,[e("div",so,[S[8]||(S[8]=e("span",{class:"text-slate-400"},"Защита",-1)),e("span",no,u(g.value.defence),1)]),e("div",lo,[S[9]||(S[9]=e("span",{class:"text-slate-400"},"Резист",-1)),e("span",ao,u(g.value.resist),1)])])])):x("",!0)]),e("div",oo,[e("div",io,[e("h3",ro,[S[10]||(S[10]=e("span",null,"⚔️",-1)),ke(" Оружие ("+u(E.value.name)+") ",1)]),e("button",{onClick:S[1]||(S[1]=r=>ne.value=!0),class:"px-3 py-1 text-xs rounded-lg bg-amber-500/20 border border-amber-400/60 text-amber-100 hover:bg-amber-500/30 transition"}," Выбрать ")]),e("div",{class:te(["mb-3 p-2 rounded-lg",I.value.valid?"bg-slate-950/40 border border-slate-700":"bg-red-900/20 border border-red-700"])},[e("div",co,[S[11]||(S[11]=e("span",{class:"text-slate-400"},"Занято рук:",-1)),e("span",{class:te(I.value.totalHands>2?"text-red-400 font-bold":"text-emerald-400 font-bold")},u(I.value.totalHands)+" / 2 ",3)]),e("div",uo,[S[12]||(S[12]=e("span",{class:"text-slate-400"},"Длинное оружие:",-1)),e("span",{class:te(I.value.longWeaponsCount>1?"text-red-400 font-bold":"text-emerald-400 font-bold")},u(I.value.longWeaponsCount)+" / 1 ",3)])],2),I.value.valid?x("",!0):(s(),n("div",fo,[(s(!0),n(W,null,re(I.value.errors,(r,h)=>(s(),n("p",{key:h,class:"text-xs text-red-300"}," ⚠️ "+u(r),1))),128))])),b.value.length?(s(),n("div",vo,[(s(!0),n(W,null,re(b.value,r=>(s(),n("div",{key:r.id,class:"p-3 bg-slate-950/40 rounded-lg border border-slate-700 flex items-center justify-between"},[e("div",mo,[e("h4",po,u(r.name),1),e("div",ho,[r.attack!==void 0?(s(),n("span",go,"Атака: "+u(r.attack),1)):x("",!0),r.attack!==void 0&&typeof r.defence!="object"?(s(),n("span",bo," • ")):x("",!0),typeof r.defence!="object"?(s(),n("span",yo,"Защита: "+u(r.defence||0),1)):x("",!0),typeof r.defence=="object"?(s(),n("div",xo,[S[13]||(S[13]=ke(" 🛡️ Защита (удар/снаряд): ",-1)),r.defence.front?(s(),n("span",ko," спереди "+u(r.defence.front.melee)+"/"+u(r.defence.front.ranged),1)):x("",!0),r.defence.side?(s(),n("span",wo,", фланг "+u(r.defence.side.melee)+"/"+u(r.defence.side.ranged),1)):x("",!0),r.defence.back?(s(),n("span",_o,", сзади "+u(r.defence.back.melee)+"/"+u(r.defence.back.ranged),1)):x("",!0)])):x("",!0)])]),e("button",{onClick:h=>j(r.id),class:"ml-2 px-2 py-1 text-xs rounded bg-red-500/20 border border-red-400/40 text-red-300 hover:bg-red-500/30"}," Убрать ",8,$o)]))),128))])):(s(),n("p",Co," Оружие не выбрано "))]),(s(),Ke(Tt,{to:"body"},[ie.value?(s(),n("div",{key:0,class:"fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4",onClick:S[3]||(S[3]=Fe(r=>ie.value=!1,["self"]))},[e("div",To,[e("div",So,[S[14]||(S[14]=e("h2",{class:"text-xl font-bold"},"Выбрать броню",-1)),e("button",{onClick:S[2]||(S[2]=r=>ie.value=!1),class:"w-8 h-8 rounded-lg hover:bg-white/10 transition"}," ✕ ")]),e("div",Io,[(s(!0),n(W,null,re(i.value,r=>{var h;return s(),n("button",{key:r.id,onClick:_=>{F(r.id),ie.value=!1},class:te(["w-full p-4 rounded-lg border transition text-left",((h=g.value)==null?void 0:h.id)===r.id?"bg-sky-500/20 border-sky-400":"bg-slate-950/40 border-slate-700 hover:bg-slate-800/40"])},[e("h3",Eo,u(r.name),1),e("p",Mo,u(r.desc),1),e("div",Ao,[e("div",Do,[S[15]||(S[15]=e("div",{class:"text-slate-500"},"Защита",-1)),e("div",No,u(r.defence),1)]),e("div",Lo,[S[16]||(S[16]=e("div",{class:"text-slate-500"},"Резист",-1)),e("div",Fo,u(r.resist),1)]),e("div",Ro,[S[17]||(S[17]=e("div",{class:"text-slate-500"},"Движение",-1)),e("div",{class:te([r.movement>=0?"text-green-400":"text-red-400","font-bold"])},u(r.movement>=0?"+":"")+u(r.movement),3)]),e("div",Oo,[S[18]||(S[18]=e("div",{class:"text-slate-500"},"Порывы",-1)),e("div",{class:te([r.bursts>=0?"text-green-400":"text-red-400","font-bold"])},u(r.bursts>=0?"+":"")+u(r.bursts),3)])])],10,Po)}),128))])])])):x("",!0)])),(s(),Ke(Tt,{to:"body"},[ne.value?(s(),n("div",{key:0,class:"fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4",onClick:S[5]||(S[5]=Fe(r=>ne.value=!1,["self"]))},[e("div",Ho,[e("div",jo,[e("h2",zo,"Выбрать оружие ("+u(E.value.name)+")",1),e("button",{onClick:S[4]||(S[4]=r=>ne.value=!1),class:"w-8 h-8 rounded-lg hover:bg-white/10 transition"}," ✕ ")]),e("div",Uo,[(s(!0),n(W,null,re(R.value,r=>(s(),n("button",{key:r.id,onClick:h=>E.value.weapons.includes(r.id)?j(r.id):Z(r.id),disabled:!E.value.weapons.includes(r.id)&&!M(r.id),class:te(["p-4 rounded-lg border transition text-left",E.value.weapons.includes(r.id)?"bg-amber-500/20 border-amber-400":M(r.id)?"bg-slate-950/40 border-slate-700 hover:bg-slate-800/40":"bg-slate-950/20 border-slate-800 opacity-50 cursor-not-allowed"])},[e("div",Wo,[e("h3",qo,u(r.name),1),!E.value.weapons.includes(r.id)&&!M(r.id)?(s(),n("div",Vo," ⚠️ ")):x("",!0)]),e("p",Xo,u(r.desc),1),e("div",Yo,[r.attack!==void 0?(s(),n("div",Go,[S[19]||(S[19]=e("div",{class:"text-slate-500"},"Атака",-1)),e("div",Ko,u(r.attack),1)])):x("",!0),typeof r.defence!="object"?(s(),n("div",Qo,[S[20]||(S[20]=e("div",{class:"text-slate-500"},"Защита",-1)),e("div",Zo,u(r.defence||0),1)])):x("",!0),typeof r.defence=="object"?(s(),n("div",Jo,[S[27]||(S[27]=e("div",{class:"text-emerald-400 font-semibold text-center mb-1 text-[10px]"},"🛡️ Защита (удар/снаряд)",-1)),e("div",ei,[r.defence.front?(s(),n("div",ti,[S[22]||(S[22]=e("span",{class:"text-slate-500"},"Спереди:",-1)),e("span",null,[e("span",si,u(r.defence.front.melee||0),1),S[21]||(S[21]=ke(" / ",-1)),e("span",ni,u(r.defence.front.ranged||0),1)])])):x("",!0),r.defence.side?(s(),n("div",li,[S[24]||(S[24]=e("span",{class:"text-slate-500"},"С фланга:",-1)),e("span",null,[e("span",ai,u(r.defence.side.melee||0),1),S[23]||(S[23]=ke(" / ",-1)),e("span",oi,u(r.defence.side.ranged||0),1)])])):x("",!0),r.defence.back?(s(),n("div",ii,[S[26]||(S[26]=e("span",{class:"text-slate-500"},"Сзади:",-1)),e("span",null,[e("span",ri,u(r.defence.back.melee||0),1),S[25]||(S[25]=ke(" / ",-1)),e("span",ci,u(r.defence.back.ranged||0),1)])])):x("",!0)])])):x("",!0),r.length!==void 0?(s(),n("div",di,[S[28]||(S[28]=e("div",{class:"text-slate-500"},"Длина",-1)),e("div",ui,u(r.length),1)])):x("",!0),r.hands!==void 0?(s(),n("div",fi,[S[29]||(S[29]=e("div",{class:"text-slate-500"},"Руки",-1)),e("div",vi,u(r.hands),1)])):x("",!0)])],10,Bo))),128))])])])):x("",!0)]))])}}},pi=wt(mi,[["__scopeId","data-v-e08ec306"]]),hi={class:"inventory-panel"},gi={class:"flex items-center justify-between mb-4"},bi={class:"mb-4 space-y-3"},yi={class:"flex gap-2 flex-wrap"},xi=["onClick"],ki={class:"mr-1"},wi={class:"mb-4 p-3 rounded-lg bg-slate-900/40 border border-slate-700 text-sm"},_i={class:"flex items-center justify-between"},$i={class:"text-white font-bold"},Ci={class:"flex items-center justify-between mt-1"},Ti={class:"text-emerald-400 font-bold"},Si={class:"flex items-center justify-between mt-1"},Ii={class:"text-amber-400 font-bold"},Pi={key:0,class:"space-y-2"},Ei=["onClick"],Mi={class:"flex items-start justify-between mb-2"},Ai={class:"flex-1"},Di={class:"flex items-center gap-2 mb-1"},Ni={class:"font-bold text-white"},Li={key:0,class:"px-2 py-0.5 text-xs rounded bg-emerald-500/20 text-emerald-300 border border-emerald-500/40"},Fi={class:"text-xs text-slate-400 leading-relaxed"},Ri={class:"flex items-center gap-2 ml-4"},Oi=["onClick"],Hi=["onClick"],ji={class:"grid grid-cols-4 gap-2 text-xs mt-3"},zi={key:0,class:"text-center p-2 bg-slate-900/60 rounded"},Ui={class:"text-red-400 font-bold"},Bi={key:1,class:"text-center p-2 bg-slate-900/60 rounded"},Wi={class:"text-emerald-400 font-bold"},qi={key:2,class:"col-span-4 p-2 bg-slate-900/60 rounded"},Vi={class:"grid grid-cols-3 gap-1 text-[10px]"},Xi={class:"text-emerald-400 font-bold"},Yi={class:"text-sky-400 font-bold"},Gi={class:"text-emerald-400 font-bold"},Ki={class:"text-sky-400 font-bold"},Qi={class:"text-emerald-400 font-bold"},Zi={class:"text-sky-400 font-bold"},Ji={key:3,class:"text-center p-2 bg-slate-900/60 rounded"},er={class:"text-red-400 font-bold"},tr={key:4,class:"text-center p-2 bg-slate-900/60 rounded"},sr={class:"text-blue-400 font-bold"},nr={key:5,class:"text-center p-2 bg-slate-900/60 rounded"},lr={class:"text-cyan-400 font-bold"},ar={key:6,class:"text-center p-2 bg-slate-900/60 rounded"},or={class:"text-purple-400 font-bold"},ir={key:7,class:"text-center p-2 bg-slate-900/60 rounded"},rr={key:8,class:"text-center p-2 bg-slate-900/60 rounded"},cr={key:1,class:"text-center py-12 text-slate-500"},dr={class:"bg-slate-900 rounded-2xl border border-white/10 max-w-4xl w-full max-h-[85vh] overflow-y-auto"},ur={class:"sticky top-0 bg-slate-900 border-b border-white/10 p-4 flex items-center justify-between z-10"},fr={class:"p-4 space-y-3 border-b border-white/10"},vr={class:"flex gap-2 flex-wrap"},mr=["onClick"],pr={class:"mr-1"},hr={class:"p-4"},gr={class:"text-sm text-slate-400 mb-3"},br={class:"text-white font-bold"},yr={key:0,class:"grid grid-cols-1 sm:grid-cols-2 gap-3"},xr=["onClick"],kr={class:"font-bold text-white mb-1"},wr={class:"text-xs text-slate-400 mb-2 line-clamp-2"},_r={class:"grid grid-cols-4 gap-1 text-xs"},$r={key:0,class:"text-center p-1 bg-slate-900/60 rounded"},Cr={class:"text-red-400 font-bold"},Tr={key:1,class:"text-center p-1 bg-slate-900/60 rounded"},Sr={class:"text-emerald-400 font-bold"},Ir={key:2,class:"col-span-4 p-1 bg-slate-900/60 rounded text-[9px]"},Pr={key:0,class:"flex justify-between"},Er={class:"text-emerald-400"},Mr={class:"text-sky-400"},Ar={key:1,class:"flex justify-between"},Dr={class:"text-emerald-400"},Nr={class:"text-sky-400"},Lr={key:3,class:"text-center p-1 bg-slate-900/60 rounded"},Fr={class:"text-blue-400 font-bold"},Rr={key:4,class:"text-center p-1 bg-slate-900/60 rounded"},Or={class:"text-purple-400 font-bold"},Hr={key:1,class:"text-center py-8 text-slate-500"},jr={class:"flex items-center justify-between p-6 border-b border-slate-700"},zr={class:"text-2xl font-bold text-slate-100"},Ur={class:"flex-1 overflow-y-auto p-6 space-y-6"},Br={class:"w-48 h-48 mx-auto bg-slate-950/50 rounded-xl p-4 flex items-center justify-center"},Wr=["src","alt"],qr={key:0,class:"p-4 bg-slate-950/30 border-l-4 border-slate-600 rounded-r-lg"},Vr={class:"text-slate-300 text-sm leading-relaxed italic"},Xr={class:"grid grid-cols-2 gap-3"},Yr={key:0,class:"stat-box"},Gr={class:"stat-value text-red-400"},Kr={key:1,class:"stat-box"},Qr={class:"stat-value text-emerald-400"},Zr={key:2,class:"stat-box"},Jr={class:"stat-value text-blue-400"},ec={key:3,class:"stat-box"},tc={class:"stat-value text-cyan-400"},sc={key:4,class:"stat-box"},nc={class:"stat-value text-purple-400"},lc={key:5,class:"stat-box"},ac={key:6,class:"stat-box"},oc={key:7,class:"stat-box"},ic={class:"stat-value text-amber-400"},rc={key:1,class:"bg-slate-950/50 rounded-xl p-4 border border-slate-700"},cc={class:"overflow-x-auto"},dc={class:"w-full text-sm"},uc={key:0,class:"border-b border-slate-800"},fc={class:"text-center py-3 px-3"},vc={class:"text-emerald-400 font-bold text-lg"},mc={class:"text-center py-3 px-3"},pc={class:"text-sky-400 font-bold text-lg"},hc={key:1,class:"border-b border-slate-800"},gc={class:"text-center py-3 px-3"},bc={class:"text-emerald-400 font-bold text-lg"},yc={class:"text-center py-3 px-3"},xc={class:"text-sky-400 font-bold text-lg"},kc={key:2},wc={class:"text-center py-3 px-3"},_c={class:"text-emerald-400 font-bold text-lg"},$c={class:"text-center py-3 px-3"},Cc={class:"text-sky-400 font-bold text-lg"},Tc={key:2,class:"bg-slate-950/50 rounded-xl p-4 border border-slate-700"},Sc={class:"space-y-2"},Ic={class:"text-2xl font-bold text-slate-100 w-12 text-center"},Pc={class:"flex-1 text-slate-300"},Ec={class:"flex gap-3 p-6 border-t border-slate-700"},Mc={__name:"InventoryPanel",props:{character:{type:Object,required:!0}},emits:["update:character","equip-item"],setup(t,{emit:o}){const a=t,l=o,i=[{id:"all",name:"Всё",icon:"📦"},{id:"weapon",name:"Оружие",icon:"⚔️"},{id:"shield",name:"Щиты",icon:"🛡️"},{id:"armor",name:"Броня",icon:"🦺"},{id:"special",name:"Особые",icon:"✨"},{id:"quest",name:"Квестовые",icon:"📜"}],d=Q("all"),v=Q(!1),E=Q(!1),g=Q(null),b=Q(""),I=X(()=>{var r,h,_,P;const D=new Set;return(r=a.character.equipment)!=null&&r.armor&&D.add(a.character.equipment.armor),(_=(h=a.character.equipment)==null?void 0:h.weaponSets)==null||_.forEach(B=>{B.weapons.forEach(ce=>D.add(ce))}),(P=a.character.inventory)==null||P.forEach(B=>{typeof B=="string"?D.add(B):B.id&&D.add(B.id)}),Array.from(D)}),M=X(()=>I.value.map(D=>{var P,B,ce;const r=Ft.items.find(Y=>Y.id===D);if(!r)return null;const h=((P=a.character.equipment)==null?void 0:P.armor)===D,_=(ce=(B=a.character.equipment)==null?void 0:B.weaponSets)==null?void 0:ce.some(Y=>Y.weapons.includes(D));return{...r,equipped:h||_,equippedAs:h?"armor":_?"weapon":null}}).filter(Boolean)),R=X(()=>{let D=M.value;if(d.value!=="all"&&(D=D.filter(r=>r.category===d.value)),b.value){const r=b.value.toLowerCase();D=D.filter(h=>{var _;return h.name.toLowerCase().includes(r)||((_=h.desc)==null?void 0:_.toLowerCase().includes(r))})}return D}),T=X(()=>{var h,_;const D=((h=a.character.equipment)==null?void 0:h.wealth)||0,r=((_=a.character.equipment)==null?void 0:_.epoch)||0;return Ft.items.filter(P=>{if(I.value.includes(P.id))return!1;const B=(P.wealth||P.price||0)<=D,ce=(P.epoch||0)<=r;return B&&ce})}),F=D=>{const r=a.character.inventory||[],h={...a.character,inventory:[...r,D]};l("update:character",h),v.value=!1},Z=D=>{const r=M.value.find(h=>h.id===D);if(r!=null&&r.equipped){alert("Нельзя удалить экипированный предмет. Сначала снимите его.");return}if(confirm(`Удалить "${r.name}" из инвентаря?`)){const h=a.character.inventory.filter(P=>typeof P=="string"?P!==D:P.id!==D),_={...a.character,inventory:h};l("update:character",_)}},j=D=>{l("equip-item",D)},oe=D=>{g.value=D,E.value=!0},ie=()=>{g.value=null,E.value=!1},ne=Q("all"),O=Q(""),S=X(()=>{let D=T.value;if(ne.value!=="all"&&(D=D.filter(r=>r.category===ne.value)),O.value){const r=O.value.toLowerCase();D=D.filter(h=>{var _;return h.name.toLowerCase().includes(r)||((_=h.desc)==null?void 0:_.toLowerCase().includes(r))})}return D});return(D,r)=>(s(),n("div",hi,[e("div",gi,[r[10]||(r[10]=e("h2",{class:"text-xl font-bold text-slate-300"},"Инвентарь",-1)),e("button",{onClick:r[0]||(r[0]=h=>v.value=!0),class:"px-3 py-2 rounded-lg bg-emerald-500/20 border border-emerald-400/60 text-emerald-100 hover:bg-emerald-500/30 transition flex items-center gap-2"},[...r[9]||(r[9]=[e("span",null,"+",-1),e("span",null,"Добавить предмет",-1)])])]),e("div",bi,[e("div",yi,[(s(),n(W,null,re(i,h=>e("button",{key:h.id,onClick:_=>d.value=h.id,class:te(["px-3 py-2 rounded-lg text-sm font-medium transition",d.value===h.id?"bg-sky-500/20 border border-sky-400 text-sky-100":"bg-slate-800/40 border border-slate-700 text-slate-400 hover:bg-slate-800/60"])},[e("span",ki,u(h.icon),1),ke(" "+u(h.name),1)],10,xi)),64))]),Me(e("input",{"onUpdate:modelValue":r[1]||(r[1]=h=>b.value=h),type:"text",placeholder:"Поиск по названию или описанию...",class:"w-full px-4 py-2 rounded-lg bg-slate-900/60 border border-slate-700 text-white placeholder-slate-500 focus:border-sky-400 focus:outline-none"},null,512),[[Be,b.value]])]),e("div",wi,[e("div",_i,[r[11]||(r[11]=e("span",{class:"text-slate-400"},"Всего предметов:",-1)),e("span",$i,u(M.value.length),1)]),e("div",Ci,[r[12]||(r[12]=e("span",{class:"text-slate-400"},"Экипировано:",-1)),e("span",Ti,u(M.value.filter(h=>h.equipped).length),1)]),e("div",Si,[r[13]||(r[13]=e("span",{class:"text-slate-400"},"В инвентаре:",-1)),e("span",Ii,u(M.value.filter(h=>!h.equipped).length),1)])]),R.value.length?(s(),n("div",Pi,[(s(!0),n(W,null,re(R.value,h=>(s(),n("div",{key:h.id,onClick:_=>oe(h),class:te(["p-4 rounded-lg border transition cursor-pointer hover:bg-slate-800/60",h.equipped?"bg-emerald-900/20 border-emerald-700":"bg-slate-950/40 border-slate-700"])},[e("div",Mi,[e("div",Ai,[e("div",Di,[e("h3",Ni,u(h.name),1),h.equipped?(s(),n("span",Li," Надето ")):x("",!0)]),e("p",Fi,u(h.desc),1)]),e("div",Ri,[!h.equipped&&(h.category==="weapon"||h.category==="shield"||h.category==="armor")?(s(),n("button",{key:0,onClick:Fe(_=>j(h),["stop"]),class:"px-3 py-1 text-xs rounded-lg bg-sky-500/20 border border-sky-400/60 text-sky-100 hover:bg-sky-500/30 transition",title:"Экипировать"}," Надеть ",8,Oi)):x("",!0),h.equipped?x("",!0):(s(),n("button",{key:1,onClick:Fe(_=>Z(h.id),["stop"]),class:"px-3 py-1 text-xs rounded-lg bg-red-500/20 border border-red-400/40 text-red-300 hover:bg-red-500/30 transition",title:"Удалить"}," 🗑️ ",8,Hi))])]),e("div",ji,[h.attack!==void 0&&typeof h.defence!="object"?(s(),n("div",zi,[r[14]||(r[14]=e("div",{class:"text-slate-500"},"Атака",-1)),e("div",Ui,u(h.attack),1)])):x("",!0),h.defence!==void 0&&typeof h.defence!="object"?(s(),n("div",Bi,[r[15]||(r[15]=e("div",{class:"text-slate-500"},"Защита",-1)),e("div",Wi,u(h.defence),1)])):x("",!0),typeof h.defence=="object"?(s(),n("div",qi,[r[20]||(r[20]=e("div",{class:"text-slate-500 text-center mb-2 font-semibold"},"Защита щита",-1)),e("div",Vi,[r[19]||(r[19]=Al('<div class="text-center" data-v-4ce688b4><div class="text-slate-500" data-v-4ce688b4>Направление</div></div><div class="text-center" data-v-4ce688b4><div class="text-slate-500" data-v-4ce688b4>Удары</div></div><div class="text-center" data-v-4ce688b4><div class="text-slate-500" data-v-4ce688b4>Снаряды</div></div>',3)),h.defence.front?(s(),n(W,{key:0},[r[16]||(r[16]=e("div",{class:"text-slate-400"},"Спереди",-1)),e("div",Xi,u(h.defence.front.melee||0),1),e("div",Yi,u(h.defence.front.ranged||0),1)],64)):x("",!0),h.defence.side?(s(),n(W,{key:1},[r[17]||(r[17]=e("div",{class:"text-slate-400"},"С фланга",-1)),e("div",Gi,u(h.defence.side.melee||0),1),e("div",Ki,u(h.defence.side.ranged||0),1)],64)):x("",!0),h.defence.back?(s(),n(W,{key:2},[r[18]||(r[18]=e("div",{class:"text-slate-400"},"Сзади",-1)),e("div",Qi,u(h.defence.back.melee||0),1),e("div",Zi,u(h.defence.back.ranged||0),1)],64)):x("",!0)])])):x("",!0),h.attack!==void 0&&typeof h.defence=="object"?(s(),n("div",Ji,[r[21]||(r[21]=e("div",{class:"text-slate-500"},"Атака",-1)),e("div",er,u(h.attack),1)])):x("",!0),h.resist!==void 0?(s(),n("div",tr,[r[22]||(r[22]=e("div",{class:"text-slate-500"},"Резист",-1)),e("div",sr,u(h.resist),1)])):x("",!0),h.length!==void 0?(s(),n("div",nr,[r[23]||(r[23]=e("div",{class:"text-slate-500"},"Длина",-1)),e("div",lr,u(h.length),1)])):x("",!0),h.hands!==void 0?(s(),n("div",ar,[r[24]||(r[24]=e("div",{class:"text-slate-500"},"Руки",-1)),e("div",or,u(h.hands),1)])):x("",!0),h.movement!==void 0?(s(),n("div",ir,[r[25]||(r[25]=e("div",{class:"text-slate-500"},"Движение",-1)),e("div",{class:te([h.movement>=0?"text-green-400":"text-red-400","font-bold"])},u(h.movement>=0?"+":"")+u(h.movement),3)])):x("",!0),h.bursts!==void 0?(s(),n("div",rr,[r[26]||(r[26]=e("div",{class:"text-slate-500"},"Порывы",-1)),e("div",{class:te([h.bursts>=0?"text-green-400":"text-red-400","font-bold"])},u(h.bursts>=0?"+":"")+u(h.bursts),3)])):x("",!0)])],10,Ei))),128))])):(s(),n("div",cr,[...r[27]||(r[27]=[e("div",{class:"text-4xl mb-3"},"📦",-1),e("p",null,"Ничего не найдено",-1)])])),(s(),Ke(Tt,{to:"body"},[v.value?(s(),n("div",{key:0,class:"fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4",onClick:r[4]||(r[4]=Fe(h=>v.value=!1,["self"]))},[e("div",dr,[e("div",ur,[r[28]||(r[28]=e("h2",{class:"text-xl font-bold"},"Добавить предмет",-1)),e("button",{onClick:r[2]||(r[2]=h=>v.value=!1),class:"w-8 h-8 rounded-lg hover:bg-white/10 transition"}," ✕ ")]),e("div",fr,[e("div",vr,[(s(),n(W,null,re(i,h=>e("button",{key:h.id,onClick:_=>ne.value=h.id,class:te(["px-3 py-2 rounded-lg text-sm font-medium transition",ne.value===h.id?"bg-sky-500/20 border border-sky-400 text-sky-100":"bg-slate-800/40 border border-slate-700 text-slate-400 hover:bg-slate-800/60"])},[e("span",pr,u(h.icon),1),ke(" "+u(h.name),1)],10,mr)),64))]),Me(e("input",{"onUpdate:modelValue":r[3]||(r[3]=h=>O.value=h),type:"text",placeholder:"Поиск...",class:"w-full px-4 py-2 rounded-lg bg-slate-950/60 border border-slate-700 text-white placeholder-slate-500 focus:border-sky-400 focus:outline-none"},null,512),[[Be,O.value]])]),e("div",hr,[e("p",gr,[r[29]||(r[29]=ke(" Доступно предметов: ",-1)),e("span",br,u(S.value.length),1)]),S.value.length?(s(),n("div",yr,[(s(!0),n(W,null,re(S.value,h=>(s(),n("button",{key:h.id,onClick:_=>F(h.id),class:"p-4 rounded-lg border bg-slate-950/40 border-slate-700 hover:bg-slate-800/40 transition text-left"},[e("h3",kr,u(h.name),1),e("p",wr,u(h.desc),1),e("div",_r,[h.attack!==void 0&&typeof h.defence!="object"?(s(),n("div",$r,[r[30]||(r[30]=e("div",{class:"text-slate-500 text-[10px]"},"Атака",-1)),e("div",Cr,u(h.attack),1)])):x("",!0),h.defence!==void 0&&typeof h.defence!="object"?(s(),n("div",Tr,[r[31]||(r[31]=e("div",{class:"text-slate-500 text-[10px]"},"Защита",-1)),e("div",Sr,u(h.defence),1)])):x("",!0),typeof h.defence=="object"?(s(),n("div",Ir,[r[36]||(r[36]=e("div",{class:"text-emerald-400 font-bold text-center mb-1"},"🛡️ Защита",-1)),h.defence.front?(s(),n("div",Pr,[r[33]||(r[33]=e("span",{class:"text-slate-500"},"Спереди:",-1)),e("span",null,[e("span",Er,u(h.defence.front.melee||0),1),r[32]||(r[32]=ke(" / ",-1)),e("span",Mr,u(h.defence.front.ranged||0),1)])])):x("",!0),h.defence.side?(s(),n("div",Ar,[r[35]||(r[35]=e("span",{class:"text-slate-500"},"Фланг:",-1)),e("span",null,[e("span",Dr,u(h.defence.side.melee||0),1),r[34]||(r[34]=ke(" / ",-1)),e("span",Nr,u(h.defence.side.ranged||0),1)])])):x("",!0)])):x("",!0),h.resist!==void 0?(s(),n("div",Lr,[r[37]||(r[37]=e("div",{class:"text-slate-500 text-[10px]"},"Резист",-1)),e("div",Fr,u(h.resist),1)])):x("",!0),h.hands!==void 0?(s(),n("div",Rr,[r[38]||(r[38]=e("div",{class:"text-slate-500 text-[10px]"},"Руки",-1)),e("div",Or,u(h.hands),1)])):x("",!0)])],8,xr))),128))])):(s(),n("div",Hr," Нет доступных предметов "))])])])):x("",!0)])),(s(),Ke(Tt,{to:"body"},[E.value&&g.value?(s(),n("div",{key:0,class:"fixed inset-0 bg-black/80 flex items-center justify-center z-[60] p-4 backdrop-blur-sm",onClick:ie},[e("div",{class:"bg-slate-900 rounded-2xl border border-slate-700 max-w-2xl w-full max-h-[90vh] overflow-hidden flex flex-col",onClick:r[8]||(r[8]=Fe(()=>{},["stop"]))},[e("div",jr,[e("h2",zr,u(g.value.name),1),e("button",{onClick:ie,class:"w-10 h-10 rounded-lg hover:bg-slate-800 transition flex items-center justify-center text-slate-400 hover:text-slate-100"},[...r[39]||(r[39]=[e("span",{class:"text-2xl"},"✕",-1)])])]),e("div",Ur,[e("div",Br,[e("img",{src:f(Hl)(g.value.id),alt:g.value.name,class:"w-full h-full object-contain",onError:r[5]||(r[5]=h=>h.target.style.display="none")},null,40,Wr)]),g.value.desc?(s(),n("div",qr,[e("p",Vr,u(g.value.desc),1)])):x("",!0),e("div",Xr,[g.value.attack!==void 0&&typeof g.value.defence!="object"?(s(),n("div",Yr,[r[40]||(r[40]=e("div",{class:"stat-label"},[e("span",{class:"text-lg"},"⚔️"),ke(" Атака ")],-1)),e("div",Gr,u(g.value.attack),1)])):x("",!0),g.value.defence!==void 0&&typeof g.value.defence!="object"?(s(),n("div",Kr,[r[41]||(r[41]=e("div",{class:"stat-label"},[e("span",{class:"text-lg"},"🛡️"),ke(" Защита ")],-1)),e("div",Qr,u(g.value.defence),1)])):x("",!0),g.value.resist!==void 0?(s(),n("div",Zr,[r[42]||(r[42]=e("div",{class:"stat-label"},[e("span",{class:"text-lg"},"💎"),ke(" Резист ")],-1)),e("div",Jr,u(g.value.resist),1)])):x("",!0),g.value.length!==void 0?(s(),n("div",ec,[r[43]||(r[43]=e("div",{class:"stat-label"},[e("span",{class:"text-lg"},"↔️"),ke(" Дальность ")],-1)),e("div",tc,u(g.value.length),1)])):x("",!0),g.value.hands!==void 0?(s(),n("div",sc,[r[44]||(r[44]=e("div",{class:"stat-label"},[e("span",{class:"text-lg"},"🤲"),ke(" Руки ")],-1)),e("div",nc,u(g.value.hands),1)])):x("",!0),g.value.movement!==void 0?(s(),n("div",lc,[r[45]||(r[45]=e("div",{class:"stat-label"},[e("span",{class:"text-lg"},"👟"),ke(" Движение ")],-1)),e("div",{class:te(["stat-value",g.value.movement>=0?"text-green-400":"text-red-400"])},u(g.value.movement>=0?"+":"")+u(g.value.movement),3)])):x("",!0),g.value.bursts!==void 0?(s(),n("div",ac,[r[46]||(r[46]=e("div",{class:"stat-label"},[e("span",{class:"text-lg"},"💨"),ke(" Порывы ")],-1)),e("div",{class:te(["stat-value",g.value.bursts>=0?"text-green-400":"text-red-400"])},u(g.value.bursts>=0?"+":"")+u(g.value.bursts),3)])):x("",!0),g.value.price!==void 0?(s(),n("div",oc,[r[47]||(r[47]=e("div",{class:"stat-label"},[e("span",{class:"text-lg"},"💰"),ke(" Цена ")],-1)),e("div",ic,u(g.value.price),1)])):x("",!0)]),typeof g.value.defence=="object"?(s(),n("div",rc,[r[52]||(r[52]=e("h3",{class:"text-lg font-bold text-emerald-400 mb-4 flex items-center gap-2"},[e("span",null,"🛡️"),ke(" Защита щита ")],-1)),e("div",cc,[e("table",dc,[r[51]||(r[51]=e("thead",null,[e("tr",{class:"border-b border-slate-700"},[e("th",{class:"text-left text-slate-400 pb-2 pr-4"},"Направление"),e("th",{class:"text-center text-slate-400 pb-2 px-3"},"Ближний бой"),e("th",{class:"text-center text-slate-400 pb-2 px-3"},"Дальний бой")])],-1)),e("tbody",null,[g.value.defence.front?(s(),n("tr",uc,[r[48]||(r[48]=e("td",{class:"py-3 pr-4 text-slate-300 font-medium"},"Спереди",-1)),e("td",fc,[e("span",vc,u(g.value.defence.front.melee||0),1)]),e("td",mc,[e("span",pc,u(g.value.defence.front.ranged||0),1)])])):x("",!0),g.value.defence.side?(s(),n("tr",hc,[r[49]||(r[49]=e("td",{class:"py-3 pr-4 text-slate-300 font-medium"},"С фланга",-1)),e("td",gc,[e("span",bc,u(g.value.defence.side.melee||0),1)]),e("td",yc,[e("span",xc,u(g.value.defence.side.ranged||0),1)])])):x("",!0),g.value.defence.back?(s(),n("tr",kc,[r[50]||(r[50]=e("td",{class:"py-3 pr-4 text-slate-300 font-medium"},"Сзади",-1)),e("td",wc,[e("span",_c,u(g.value.defence.back.melee||0),1)]),e("td",$c,[e("span",Cc,u(g.value.defence.back.ranged||0),1)])])):x("",!0)])])])])):x("",!0),g.value.damage?(s(),n("div",Tc,[r[53]||(r[53]=e("h3",{class:"text-lg font-bold text-red-400 mb-4 flex items-center gap-2"},[e("span",null,"⚔️"),ke(" Превышение защиты ")],-1)),e("div",Sc,[(s(!0),n(W,null,re(g.value.damage,(h,_)=>(s(),n("div",{key:_,class:"flex items-center gap-4 p-3 bg-slate-900/50 rounded-lg"},[e("div",Ic,u(_),1),e("div",Pc,u(h),1)]))),128))])])):x("",!0)]),e("div",Ec,[!g.value.equipped&&(g.value.category==="weapon"||g.value.category==="shield"||g.value.category==="armor")?(s(),n("button",{key:0,onClick:r[6]||(r[6]=h=>{j(g.value),ie()}),class:"flex-1 px-4 py-3 rounded-lg bg-sky-500/20 border border-sky-400/60 text-sky-100 hover:bg-sky-500/30 transition font-semibold"}," Надеть ")):x("",!0),g.value.equipped?x("",!0):(s(),n("button",{key:1,onClick:r[7]||(r[7]=h=>{Z(g.value.id),ie()}),class:"flex-1 px-4 py-3 rounded-lg bg-red-500/20 border border-red-400/40 text-red-300 hover:bg-red-500/30 transition font-semibold"}," Удалить ")),e("button",{onClick:ie,class:"flex-1 px-4 py-3 rounded-lg bg-slate-700/50 border border-slate-600 text-slate-300 hover:bg-slate-700 transition font-semibold"}," Закрыть ")])])])):x("",!0)]))]))}},Ac=wt(Mc,[["__scopeId","data-v-4ce688b4"]]),Dc={key:0,class:"hp-display"},Nc={key:0,class:"hp-compact"},Lc={class:"hp-text"},Fc={key:0,class:"hp-penalty"},Rc={key:1,class:"hp-full"},Oc={class:"hp-header"},Hc={class:"hp-value"},jc={key:0,class:"hp-penalty-badge"},zc={class:"hp-groups"},Uc=["onClick"],Bc={key:1,class:"wounds-display"},Wc={key:0,class:"wounds-compact"},qc={key:0,class:"wound-healthy"},Vc={key:1,class:"wounds-full"},Xc=["onClick","onContextmenu","onTouchstart","onTouchend"],Yc={class:"wound-header"},Gc={class:"wound-icon"},Kc={class:"wound-label"},Qc={class:"wound-slots"},Zc={class:"wound-count"},Jc=500,ed={__name:"HealthDisplay",props:{combat:{type:Object,required:!0},stats:{type:Object,default:()=>({})},compact:{type:Boolean,default:!1},readonly:{type:Boolean,default:!1}},emits:["update:hp","add-wound","remove-wound","toggle-health-type"],setup(t,{emit:o}){const a=t,l=o,i=X(()=>{var O;return((O=a.combat)==null?void 0:O.healthType)||"simple"}),d=X(()=>{var O;return((O=a.combat)==null?void 0:O.hp)||0}),v=X(()=>{var O;return((O=a.combat)==null?void 0:O.maxHp)||8}),E=X(()=>{const O=[],D=v.value,r=D%3;let h=0;if(r>0){const _=[];for(let P=0;P<r;P++)_.push({index:h,filled:h<d.value}),h++;O.push(_)}for(;h<D;){const _=[];for(let P=0;P<3&&h<D;P++)_.push({index:h,filled:h<d.value}),h++;O.push(_)}return O}),g=X(()=>{const O=v.value-d.value;return Math.floor(O/3)}),b=X(()=>{var O;return((O=a.combat)==null?void 0:O.wounds)||{scratch:0,light:0,heavy:0,deadly:0}}),I=X(()=>{var O;return((O=a.combat)==null?void 0:O.bonusDeadlySlots)||0}),M=X(()=>{const O=ts(a.stats,I.value);return{scratch:{...O.scratch,total:O.scratch.base+O.scratch.bonus,filled:b.value.scratch,label:"Царапины",icon:"🩹",color:"amber"},light:{...O.light,total:O.light.base+O.light.bonus,filled:b.value.light,label:"Лёгкие",icon:"🩸",color:"orange"},heavy:{...O.heavy,total:O.heavy.base+O.heavy.bonus,filled:b.value.heavy,label:"Тяжёлые",icon:"💔",color:"rose"},deadly:{...O.deadly,total:O.deadly.base+O.deadly.bonus,filled:b.value.deadly,label:"Смертельные",icon:"💀",color:"red"}}}),R=["scratch","light","heavy","deadly"],T=O=>{const S=M.value[O],D=[];S.bonus+S.base;const r=S.filled;for(let h=0;h<S.bonus;h++)D.push({index:h,isBonus:!0,filled:h<r});for(let h=0;h<S.base;h++)D.push({index:S.bonus+h,isBonus:!1,filled:S.bonus+h<r});return D};let F=null;const Z=O=>{a.readonly||(O<d.value?l("update:hp",d.value-1):l("update:hp",Math.min(v.value,d.value+1)))},j=(O,S)=>{a.readonly||(S.preventDefault(),l("add-wound",O))},oe=(O,S)=>{a.readonly||(S.preventDefault(),l("remove-wound",O))},ie=(O,S)=>{a.readonly||(F=setTimeout(()=>{l("remove-wound",O),F=null},Jc))},ne=(O,S)=>{a.readonly||F&&(clearTimeout(F),F=null,l("add-wound",O))};return(O,S)=>(s(),n("div",{class:te(["health-display",{compact:t.compact}])},[i.value==="simple"?(s(),n("div",Dc,[t.compact?(s(),n("div",Nc,[S[0]||(S[0]=e("span",{class:"hp-icon"},"❤️",-1)),e("span",Lc,u(d.value)+"/"+u(v.value),1),g.value>0?(s(),n("span",Fc,"-"+u(g.value),1)):x("",!0)])):(s(),n("div",Rc,[e("div",Oc,[S[1]||(S[1]=e("span",{class:"hp-label"},"HP",-1)),e("span",Hc,u(d.value)+"/"+u(v.value),1),g.value>0?(s(),n("span",jc,"штраф: -"+u(g.value),1)):x("",!0)]),e("div",zc,[(s(!0),n(W,null,re(E.value,(D,r)=>(s(),n("div",{key:r,class:"hp-group"},[(s(!0),n(W,null,re(D,h=>(s(),n("div",{key:h.index,class:te(["hp-cell",{filled:h.filled,clickable:!t.readonly}]),onClick:_=>Z(h.index)},null,10,Uc))),128))]))),128))])]))])):(s(),n("div",Bc,[t.compact?(s(),n("div",Wc,[(s(),n(W,null,re(R,D=>(s(),n(W,{key:D},[M.value[D].filled>0?(s(),n("span",{key:0,class:te(["wound-badge",`wound-${M.value[D].color}`])},u(M.value[D].icon)+" "+u(M.value[D].filled),3)):x("",!0)],64))),64)),Object.values(b.value).every(D=>D===0)?(s(),n("span",qc," ✓ Здоров ")):x("",!0)])):(s(),n("div",Vc,[(s(),n(W,null,re(R,D=>e("div",{key:D,class:te(["wound-column",[`wound-column-${M.value[D].color}`,`wound-column-${D}`,{clickable:!t.readonly}]]),onClick:r=>j(D,r),onContextmenu:r=>oe(D,r),onTouchstart:r=>ie(D),onTouchend:r=>ne(D)},[e("div",Yc,[e("span",Gc,u(M.value[D].icon),1),e("span",Kc,u(M.value[D].label),1)]),e("div",Qc,[(s(!0),n(W,null,re(T(D),r=>(s(),n("div",{key:r.index,class:te(["wound-slot",{filled:r.filled,bonus:r.isBonus}])},null,2))),128))]),e("div",Zc,u(M.value[D].filled)+"/"+u(M.value[D].total),1)],42,Xc)),64))]))]))],2))}},En=wt(ed,[["__scopeId","data-v-2d19fffd"]]),td={class:"portrait-image"},sd=["src","alt"],nd={key:1,class:"portrait-fallback"},ld={key:3,class:"death-overlay"},ad=["viewBox","width","height"],od=["transform"],id={key:0,class:"melee-defence"},rd=["d"],cd=["d"],dd=["d"],ud=["d"],fd=["d"],vd=["d"],md={key:1,class:"ranged-defence"},pd=["d"],hd=["d"],gd=["d"],bd=["d"],yd=["d"],xd=["d"],kd=["viewBox","width","height"],wd=["d","stroke"],_d=["cx","cy","r","fill"],Xt=2,$d={__name:"CharacterPortrait",props:{portrait:{type:[String,Number],default:null},name:{type:String,default:""},combat:{type:Object,default:()=>({})},stats:{type:Object,default:()=>({})},meleeDefence:{type:Object,default:null},rangedDefence:{type:Object,default:null},defenceMode:{type:String,default:"all",validator:t=>["all","melee","ranged","none"].includes(t)},defenceLayout:{type:String,default:"left",validator:t=>["left","both"].includes(t)},defenceRotation:{type:Number,default:0},highlightSegment:{type:Object,default:null},showDefence:{type:Boolean,default:!1},size:{type:String,default:"md",validator:t=>["sm","md","lg","xl"].includes(t)},showWounds:{type:Boolean,default:!0}},setup(t){const o=t,a={sm:48,md:80,lg:120,xl:160},l=X(()=>a[o.size]),i=X(()=>{const y=o.portrait;return y?typeof y=="string"&&(y.startsWith("http://")||y.startsWith("https://")||y.startsWith("data:"))?y:Ol(y):null}),d=X(()=>{var y;return((y=o.combat)==null?void 0:y.healthType)||"simple"}),v=X(()=>{var y;return((y=o.combat)==null?void 0:y.wounds)||{scratch:0,light:0,heavy:0,deadly:0}}),E=X(()=>{var y;return d.value!=="wounds"?null:ts(o.stats,((y=o.combat)==null?void 0:y.bonusDeadlySlots)||0)}),g=X(()=>{if(!E.value)return[];const y=E.value.scratch.base+E.value.scratch.bonus,L=E.value.scratch.bonus,le=v.value.scratch;if(le===0)return[];const V=10,Se=(360-y*V)/y,he=180-(le*Se+(le-1)*V)/2,we=[];for(let De=0;De<le;De++){const ye=he+De*(Se+V);we.push({index:De,startAngle:ye,endAngle:ye+Se,filled:!0,isBonus:De<L})}return we}),b=(y,L,le,V)=>{const de=l.value,Se=de/2,fe=de/2,he=le,we=(y-90)*Math.PI/180,De=(L-90)*Math.PI/180,ye=Se+he*Math.cos(we),xe=fe+he*Math.sin(we),Le=Se+he*Math.cos(De),qe=fe+he*Math.sin(De),Qe=L-y>180?1:0;return`M ${ye} ${xe} A ${he} ${he} 0 ${Qe} 1 ${Le} ${qe}`},I=X(()=>{if(!E.value)return[];const y=E.value.light.bonus,L=v.value.light;if(L===0)return[];const le=[],V=l.value,de=V*.08,Se=V/2,fe=V/2,he=V/2,we=25,ye=90+(L-1)*we/2;for(let xe=0;xe<L;xe++){const qe=(ye-xe*we)*Math.PI/180;le.push({index:xe,cx:fe+Se*Math.cos(qe),cy:he+Se*Math.sin(qe),r:de,filled:!0,isBonus:xe<y})}return le}),M=X(()=>{if(!E.value)return 0;const y=E.value.heavy.base+E.value.heavy.bonus,L=v.value.heavy;return y===0||L===0?0:L/y*70}),R=X(()=>{if(!E.value)return 0;const y=E.value.deadly.base+E.value.deadly.bonus,L=v.value.deadly;return y===0?0:L/y}),T=X(()=>R.value>0),F=X(()=>R.value>=1),Z=X(()=>{var le,V;if(d.value!=="simple")return 100;const y=((le=o.combat)==null?void 0:le.hp)||0,L=((V=o.combat)==null?void 0:V.maxHp)||1;return y/L*100}),j=X(()=>Math.max(0,100-Z.value)*.7),oe=X(()=>{var y,L;return((L=(y=o.name)==null?void 0:y.charAt(0))==null?void 0:L.toUpperCase())||"?"}),ie=y=>{const L=Object.entries($t.default||$t).map(([V,de])=>({value:parseInt(V),...de})).filter(V=>V.value>=0).sort((V,de)=>V.value-de.value);let le=L[0];for(const V of L)if(V.value<=y)le=V;else break;return le},ne=y=>{if(!o.meleeDefence)return null;const L=o.meleeDefence[y];return L==null?null:ie(L)},O=y=>{if(!o.rangedDefence)return null;const L=o.rangedDefence[y];return L==null?null:ie(L)},S=X(()=>!o.showDefence||!o.meleeDefence||o.defenceMode==="none"||o.defenceMode==="ranged"?null:{front:ne("front"),flank:ne("flank"),back:ne("back")}),D=X(()=>!o.showDefence||!o.rangedDefence||o.defenceMode==="none"||o.defenceMode==="melee"?null:{front:O("front"),flank:O("flank"),back:O("back")}),r=(y,L)=>o.highlightSegment?o.highlightSegment.type===y&&o.highlightSegment.direction===L:!1,h=X(()=>o.highlightSegment!==null),_=X(()=>{if(o.defenceRotation===0)return"";const y=l.value,L=ve.value,le=y/2+L,V=y/2+L;return`rotate(${o.defenceRotation} ${le} ${V})`}),P=(y,L=0)=>{const le=l.value,V=ve.value,de=le/2+V,Se=le/2+V,fe=le/2+14+L,he=Le=>{const qe=(Le-90)*Math.PI/180;return{x:de+fe*Math.cos(qe),y:Se+fe*Math.sin(qe)}},we=he(0),De=he(180),ye=he(240),xe=he(300);return y==="front"?`M ${we.x} ${we.y} L ${xe.x} ${xe.y}`:y==="flank"?`M ${xe.x} ${xe.y} L ${ye.x} ${ye.y}`:y==="back"?`M ${ye.x} ${ye.y} L ${De.x} ${De.y}`:""},B=(y,L=0,le="left")=>{const V=l.value,de=ve.value,Se=V/2+de,fe=V/2+de,we=V/2+14+8+L;let De,ye;if(le==="left")if(y==="front")De=300,ye=360;else if(y==="flank")De=240,ye=300;else if(y==="back")De=180,ye=240;else return"";else if(y==="front")De=0,ye=60;else if(y==="flank")De=60,ye=120;else if(y==="back")De=120,ye=180;else return"";const xe=(De-90)*Math.PI/180,Le=(ye-90)*Math.PI/180,qe=Se+we*Math.cos(xe),Qe=fe+we*Math.sin(xe),Ve=Se+we*Math.cos(Le),Re=fe+we*Math.sin(Le);return`M ${qe} ${Qe} A ${we} ${we} 0 0 1 ${Ve} ${Re}`},ce=y=>{if(!y)return{};const L=y.linetype||"single",V={stroke:y.color||"#FFFFFF","stroke-width":2,fill:"none","stroke-linecap":"butt"};return L==="dashed"?{...V,"stroke-dasharray":"4 3"}:V},Y=y=>!y||y.linetype!=="double"?null:{stroke:y.color||"#FFFFFF","stroke-width":2,fill:"none","stroke-linecap":"butt","stroke-dasharray":"4 3"},ve=X(()=>o.showDefence?28:0),H=X(()=>l.value+ve.value*2);return(y,L)=>(s(),n("div",{class:te(["character-portrait",[`size-${t.size}`,{dying:T.value,dead:F.value,"with-defence":t.showDefence}]]),style:Ne({width:`${H.value}px`,height:`${H.value}px`})},[e("div",{class:"portrait-container",style:Ne({width:`${l.value}px`,height:`${l.value}px`,position:"absolute",top:`${ve.value}px`,left:`${ve.value}px`})},[e("div",td,[t.portrait?(s(),n("img",{key:0,src:i.value,alt:t.name,class:"portrait-img",onError:L[0]||(L[0]=le=>le.target.style.display="none")},null,40,sd)):(s(),n("div",nd,u(oe.value),1))]),t.showWounds&&d.value==="wounds"&&M.value>0?(s(),n("div",{key:0,class:"heavy-overlay",style:Ne({height:`${M.value}%`})},null,4)):x("",!0),t.showWounds&&d.value==="simple"&&j.value>0?(s(),n("div",{key:1,class:"hp-damage-overlay",style:Ne({height:`${j.value}%`})},null,4)):x("",!0),t.showWounds&&T.value?(s(),n("div",{key:2,class:"deadly-overlay",style:Ne({opacity:R.value*.8})},null,4)):x("",!0),F.value?(s(),n("div",ld,[...L[1]||(L[1]=[e("span",{class:"death-icon"},"💀",-1)])])):x("",!0)],4),t.showDefence&&(S.value||D.value)?(s(),n("svg",{key:0,class:"defence-overlay",viewBox:`0 0 ${H.value} ${H.value}`,width:H.value,height:H.value,style:{position:"absolute",top:"0",left:"0"}},[e("g",{transform:_.value},[S.value?(s(),n("g",id,[!h.value||r("melee","front")?(s(),n(W,{key:0},[S.value.front?(s(),n("path",_t({key:0,d:P("front",0)},ce(S.value.front)),null,16,rd)):x("",!0),Y(S.value.front)?(s(),n("path",_t({key:1,d:P("front",Xt)},Y(S.value.front)),null,16,cd)):x("",!0)],64)):x("",!0),!h.value||r("melee","flank")?(s(),n(W,{key:1},[S.value.flank?(s(),n("path",_t({key:0,d:P("flank",0)},ce(S.value.flank)),null,16,dd)):x("",!0),Y(S.value.flank)?(s(),n("path",_t({key:1,d:P("flank",Xt)},Y(S.value.flank)),null,16,ud)):x("",!0)],64)):x("",!0),!h.value||r("melee","back")?(s(),n(W,{key:2},[S.value.back?(s(),n("path",_t({key:0,d:P("back",0)},ce(S.value.back)),null,16,fd)):x("",!0),Y(S.value.back)?(s(),n("path",_t({key:1,d:P("back",Xt)},Y(S.value.back)),null,16,vd)):x("",!0)],64)):x("",!0)])):x("",!0),D.value?(s(),n("g",md,[!h.value||r("ranged","front")?(s(),n(W,{key:0},[D.value.front?(s(),n("path",_t({key:0,d:B("front",0,t.defenceLayout)},ce(D.value.front)),null,16,pd)):x("",!0),Y(D.value.front)?(s(),n("path",_t({key:1,d:B("front",Xt,t.defenceLayout)},Y(D.value.front)),null,16,hd)):x("",!0)],64)):x("",!0),!h.value||r("ranged","flank")?(s(),n(W,{key:1},[D.value.flank?(s(),n("path",_t({key:0,d:B("flank",0,t.defenceLayout)},ce(D.value.flank)),null,16,gd)):x("",!0),Y(D.value.flank)?(s(),n("path",_t({key:1,d:B("flank",Xt,t.defenceLayout)},Y(D.value.flank)),null,16,bd)):x("",!0)],64)):x("",!0),!h.value||r("ranged","back")?(s(),n(W,{key:2},[D.value.back?(s(),n("path",_t({key:0,d:B("back",0,t.defenceLayout)},ce(D.value.back)),null,16,yd)):x("",!0),Y(D.value.back)?(s(),n("path",_t({key:1,d:B("back",Xt,t.defenceLayout)},Y(D.value.back)),null,16,xd)):x("",!0)],64)):x("",!0)])):x("",!0)],8,od)],8,ad)):x("",!0),t.showWounds?(s(),n("svg",{key:1,class:"wounds-overlay",viewBox:`0 0 ${l.value} ${l.value}`,width:l.value,height:l.value,style:Ne({position:"absolute",top:t.showDefence?`${ve.value}px`:"0",left:t.showDefence?`${ve.value}px`:"0",overflow:"visible"})},[(s(!0),n(W,null,re(g.value,le=>(s(),n("path",{key:`scratch-${le.index}`,d:b(le.startAngle,le.endAngle,l.value/2-3),fill:"none",stroke:le.isBonus?"#a855f7":"#fbbf24","stroke-width":"3","stroke-linecap":"round",class:"scratch-arc filled"},null,8,wd))),128)),(s(!0),n(W,null,re(I.value,le=>(s(),n("circle",{key:`light-${le.index}`,cx:le.cx,cy:le.cy,r:le.r,fill:le.isBonus?"#a855f7":"#ef4444",stroke:"#1f2937","stroke-width":"1.5",class:"light-dot filled"},null,8,_d))),128))],12,kd)):x("",!0)],6))}},zt=wt($d,[["__scopeId","data-v-46557206"]]),tl={};kt.aspects.forEach(t=>{tl[t.id]=t});const Cd=t=>tl[t]||null,Td=t=>{var v,E,g,b,I,M;const o=(t==null?void 0:t.stats)||{},a=((v=t==null?void 0:t.combat)==null?void 0:v.wounds)||(t==null?void 0:t.wounds)||{};if(!a.scratch&&!a.light&&!a.heavy&&!a.deadly)return 0;const l={scratch:{current:typeof a.scratch=="number"?a.scratch:((E=a.scratch)==null?void 0:E.current)||0},light:{current:typeof a.light=="number"?a.light:((g=a.light)==null?void 0:g.current)||0},heavy:{current:typeof a.heavy=="number"?a.heavy:((b=a.heavy)==null?void 0:b.current)||0},deadly:{current:typeof a.deadly=="number"?a.deadly:((I=a.deadly)==null?void 0:I.current)||0}},i=((M=t==null?void 0:t.combat)==null?void 0:M.bonusDeadlySlots)||0,d=ts(o,i);return-Ll(l,d)},Sd=t=>{let o=0;return o-=Td(t),o},Js=(t,o)=>{const a=Cd(o);if(!a)return 0;const l=(t==null?void 0:t.stats)||{},i=l[o]||0,d=a.neighbors||[],v=l[d[0]]||0,E=l[d[1]]||0,g=l[a.opposite]||0,b=Math.floor(i+v/2+E/2),I=Math.floor(g/2),M=Math.max(b,I),R=Sd(t);return M+R},en={};Object.keys(Ft).forEach(t=>{Array.isArray(Ft[t])&&Ft[t].forEach(o=>{en[o.id]=o})});const Id=t=>Js(t,"shadow"),Pd=t=>{var a;const o=(a=t==null?void 0:t.equipment)==null?void 0:a.armor;return o&&en[o]||null},Ed=(t,o,a)=>{var E,g;const l=((E=t==null?void 0:t.equipment)==null?void 0:E.activeSetIndex)??0,d=(((g=t==null?void 0:t.equipment)==null?void 0:g.weaponSets)||[])[l];if(!d||!d.weapons)return 0;let v=0;for(const b of d.weapons){const I=en[b];I&&(I.type==="shield"&&o==="front"&&(a==="melee"?v+=I.defenceMelee||0:a==="ranged"&&(v+=I.defenceRanged||0)),I.parry&&o==="front"&&a==="melee"&&(v+=I.parry||0))}return v},Os=(t,o,a)=>{const l=Id(t),i=Math.floor(l/2),d=Pd(t),v=(d==null?void 0:d.defence)||0,E=Ed(t,o,a);let g=0,b=0;return o==="front"?(g=6,b=l):o==="flank"?(g=3,b=i):o==="back"&&(g=0,b=i),Math.max(0,g+b+v+E)},es=(t,o)=>({front:Os(t,"front",o),flank:Os(t,"flank",o),back:Os(t,"back",o)}),Md=[{id:"plains",name:"Равнина",color:"#8BC34A"},{id:"forest",name:"Лес",color:"#2E7D32"},{id:"desert",name:"Пустыня",color:"#FDD835"},{id:"swamp",name:"Болото",color:"#5D4037"},{id:"mountain",name:"Горы",color:"#78909C"},{id:"water",name:"Вода",color:"#1E88E5"},{id:"snow",name:"Снег",color:"#ECEFF1"},{id:"volcanic",name:"Вулкан",color:"#BF360C"},{id:"urban",name:"Город",color:"#616161"},{id:"underground",name:"Подземелье",color:"#37474F"}],Ad=[{id:"open",name:"Открытая",description:"Полностью просматривается",value:0},{id:"partial",name:"Частичная",description:"Маскирует (высокая трава, кусты)",value:1},{id:"blocking",name:"Блокирующая",description:"Блокирует обзор (стена, скала)",value:2}],Dd=[{id:"grass",name:"Трава",description:"Обычный луг",biome:"plains",color:"#4CAF50",image:null,visibility:"open",movementCost:1,meleeAdvantage:0,tags:["природа","базовый"]},{id:"tall_grass",name:"Высокая трава",description:"Высокая трава, скрывающая присевших",biome:"plains",color:"#7CB342",image:null,visibility:"partial",movementCost:1,meleeAdvantage:0,tags:["природа","укрытие"]},{id:"forest_light",name:"Редколесье",description:"Редкие деревья и кустарники",biome:"forest",color:"#66BB6A",image:null,visibility:"partial",movementCost:2,meleeAdvantage:0,tags:["природа","лес","укрытие"]},{id:"forest_dense",name:"Густой лес",description:"Плотный лес с густым подлеском",biome:"forest",color:"#2E7D32",image:null,visibility:"blocking",movementCost:3,meleeAdvantage:-1,tags:["природа","лес","труднопроходимый"]},{id:"sand",name:"Песок",description:"Рыхлый песок",biome:"desert",color:"#FFD54F",image:null,visibility:"open",movementCost:2,meleeAdvantage:-1,tags:["природа","пустыня"]},{id:"dunes",name:"Дюны",description:"Песчаные холмы",biome:"desert",color:"#FFC107",image:null,visibility:"partial",movementCost:3,meleeAdvantage:1,tags:["природа","пустыня","возвышенность"]},{id:"shallow_water",name:"Мелководье",description:"Неглубокая вода по колено",biome:"water",color:"#4FC3F7",image:null,visibility:"open",movementCost:2,meleeAdvantage:-1,tags:["вода"]},{id:"deep_water",name:"Глубокая вода",description:"Глубокая вода, нужно плыть",biome:"water",color:"#1565C0",image:null,visibility:"open",movementCost:4,meleeAdvantage:-2,tags:["вода","опасность"]},{id:"swamp",name:"Болото",description:"Топкое болото",biome:"swamp",color:"#6D4C41",image:null,visibility:"partial",movementCost:3,meleeAdvantage:-1,tags:["природа","болото","опасность"]},{id:"rocks",name:"Камни",description:"Каменистая местность",biome:"mountain",color:"#90A4AE",image:null,visibility:"partial",movementCost:2,meleeAdvantage:0,tags:["природа","горы"]},{id:"cliff",name:"Утёс",description:"Крутой обрыв или возвышенность",biome:"mountain",color:"#607D8B",image:null,visibility:"blocking",movementCost:5,meleeAdvantage:2,tags:["природа","горы","возвышенность"]},{id:"snow",name:"Снег",description:"Заснеженная местность",biome:"snow",color:"#ECEFF1",image:null,visibility:"open",movementCost:2,meleeAdvantage:-1,tags:["природа","холод"]},{id:"ice",name:"Лёд",description:"Скользкий лёд",biome:"snow",color:"#B3E5FC",image:null,visibility:"open",movementCost:1,meleeAdvantage:-2,tags:["природа","холод","опасность"]},{id:"lava",name:"Лава",description:"Раскалённая лава",biome:"volcanic",color:"#FF5722",image:null,visibility:"open",movementCost:5,meleeAdvantage:-2,tags:["опасность","огонь"]},{id:"volcanic_rock",name:"Вулканический камень",description:"Застывшая лава",biome:"volcanic",color:"#3E2723",image:null,visibility:"open",movementCost:2,meleeAdvantage:0,tags:["природа","горы"]},{id:"road_dirt",name:"Грунтовая дорога",description:"Утоптанная тропа",biome:"plains",color:"#A1887F",image:null,visibility:"open",movementCost:1,meleeAdvantage:0,tags:["дорога"]},{id:"road_stone",name:"Каменная дорога",description:"Мощёная дорога",biome:"urban",color:"#9E9E9E",image:null,visibility:"open",movementCost:1,meleeAdvantage:0,tags:["дорога","город"]},{id:"floor_wood",name:"Деревянный пол",description:"Деревянный настил",biome:"urban",color:"#8D6E63",image:null,visibility:"open",movementCost:1,meleeAdvantage:0,tags:["город","здание"]},{id:"floor_stone",name:"Каменный пол",description:"Каменные плиты",biome:"urban",color:"#757575",image:null,visibility:"open",movementCost:1,meleeAdvantage:0,tags:["город","здание"]},{id:"wall",name:"Стена",description:"Непроходимая стена",biome:"urban",color:"#424242",image:null,visibility:"blocking",movementCost:5,meleeAdvantage:0,tags:["город","здание","преграда"]},{id:"dungeon_floor",name:"Пол подземелья",description:"Холодный каменный пол",biome:"underground",color:"#455A64",image:null,visibility:"open",movementCost:1,meleeAdvantage:0,tags:["подземелье"]},{id:"dungeon_wall",name:"Стена подземелья",description:"Массивная каменная стена",biome:"underground",color:"#263238",image:null,visibility:"blocking",movementCost:5,meleeAdvantage:0,tags:["подземелье","преграда"]},{id:"void",name:"Пустота",description:"Пустое пространство",biome:"underground",color:"#0D1117",image:null,visibility:"blocking",movementCost:5,meleeAdvantage:0,tags:["специальный"]}],Hs={biomes:Md,visibility:Ad,terrains:Dd},sl=Dl("terrain",()=>{const t=Q(Hs.terrains),o=Q([]),a=Q(Hs.biomes),l=Q(Hs.visibility),i=Q(new Map),d=Q({search:"",biome:null,visibility:null,movementCostMin:1,movementCostMax:5,meleeAdvantageMin:-2,meleeAdvantageMax:2,tags:[]}),v=X(()=>[...t.value,...o.value]),E=X(()=>{const r=new Set;return v.value.forEach(h=>{var _;(_=h.tags)==null||_.forEach(P=>r.add(P))}),Array.from(r).sort()}),g=X(()=>v.value.filter(r=>{var h;if(d.value.search){const _=d.value.search.toLowerCase(),P=r.name.toLowerCase().includes(_),B=(h=r.description)==null?void 0:h.toLowerCase().includes(_);if(!P&&!B)return!1}if(d.value.biome&&r.biome!==d.value.biome||d.value.visibility&&r.visibility!==d.value.visibility||r.movementCost<d.value.movementCostMin||r.movementCost>d.value.movementCostMax||r.meleeAdvantage<d.value.meleeAdvantageMin||r.meleeAdvantage>d.value.meleeAdvantageMax)return!1;if(d.value.tags.length>0){const _=new Set(r.tags||[]);if(!d.value.tags.every(B=>_.has(B)))return!1}return!0})),b=X(()=>{const r={};return a.value.forEach(h=>{r[h.id]={biome:h,terrains:g.value.filter(_=>_.biome===h.id)}}),r});function I(r){return v.value.find(h=>h.id===r)||null}function M(r={}){const{biome:h=null,visibility:_=null,passabilityMin:P=0,passabilityMax:B=5,meleeAdvantageMin:ce=-2,meleeAdvantageMax:Y=2,search:ve="",tags:H=[]}=r;return v.value.filter(y=>{var V;if(ve){const de=ve.toLowerCase(),Se=y.name.toLowerCase().includes(de),fe=(V=y.description)==null?void 0:V.toLowerCase().includes(de);if(!Se&&!fe)return!1}if(h&&y.biome!==h||_&&y.visibility!==_)return!1;const L=y.movementCost??1;if(L<P||L>B)return!1;const le=y.meleeAdvantage??0;if(le<ce||le>Y)return!1;if(H.length>0){const de=new Set(y.tags||[]);if(!H.every(Se=>de.has(Se)))return!1}return!0})}function R(r){return a.value.find(h=>h.id===r)||null}function T(r){const h=I(r);if(!h)return"#888888";if(h.color)return h.color;const _=R(h.biome);return(_==null?void 0:_.color)||"#888888"}function F(r){const h=I(r);return(h==null?void 0:h.image)||null}async function Z(r){return i.value.has(r)?i.value.get(r):new Promise((h,_)=>{const P=new Image;P.onload=()=>{i.value.set(r,P),h(P)},P.onerror=_,P.src=r})}function j(r){const _={id:`custom_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,name:r.name||"Новый террейн",description:r.description||"",biome:r.biome||"plains",color:r.color||"#888888",image:r.image||null,visibility:r.visibility||"open",movementCost:Math.max(1,Math.min(5,r.movementCost||1)),meleeAdvantage:Math.max(-2,Math.min(2,r.meleeAdvantage||0)),tags:r.tags||[],isCustom:!0,createdAt:Date.now()};return o.value.push(_),_}function oe(r,h){const _=o.value.findIndex(P=>P.id===r);return _===-1?!1:(o.value[_]={...o.value[_],...h,updatedAt:Date.now()},!0)}function ie(r){const h=o.value.findIndex(_=>_.id===r);return h===-1?!1:(o.value.splice(h,1),!0)}function ne(r){d.value={...d.value,...r}}function O(){d.value={search:"",biome:null,visibility:null,movementCostMin:1,movementCostMax:5,meleeAdvantageMin:-2,meleeAdvantageMax:2,tags:[]}}function S(){return JSON.stringify(o.value,null,2)}function D(r){try{const h=JSON.parse(r);if(!Array.isArray(h))throw new Error("Invalid format");return h.forEach(_=>{j(_)}),!0}catch(h){return console.error("Failed to import terrains:",h),!1}}return{baseTerrains:t,customTerrains:o,biomes:a,visibilityTypes:l,imageCache:i,filters:d,allTerrains:v,allTags:E,filteredTerrains:g,terrainsByBiome:b,getTerrainById:I,getFilteredTerrains:M,getBiomeById:R,getTerrainColor:T,getTerrainImage:F,loadImage:Z,addCustomTerrain:j,updateCustomTerrain:oe,removeCustomTerrain:ie,setFilters:ne,resetFilters:O,exportCustomTerrains:S,importCustomTerrains:D}},{persist:{key:"trip-terrains",paths:["customTerrains"]}});class Nd{constructor(o=null){this.seed=o??Date.now(),this.current=this.seed}next(){return this.current=this.current*1103515245+12345&2147483647,this.current/2147483647}nextInt(o,a){return Math.floor(this.next()*(a-o+1))+o}shuffle(o){const a=[...o];for(let l=a.length-1;l>0;l--){const i=this.nextInt(0,l);[a[l],a[i]]=[a[i],a[l]]}return a}}function Ld(t,o){return[{q:t+1,r:o},{q:t+1,r:o-1},{q:t,r:o-1},{q:t-1,r:o},{q:t-1,r:o+1},{q:t,r:o+1}]}function Fd(t){const[o,a]=t.split(",").map(Number);return{q:o,r:a}}function Rd(t,o){return`${t},${o}`}function Od(t,o,a){if(!t||t.type===mt.NONE)return!0;const{type:l,operator:i,value:d,minValue:v,maxValue:E}=t;let g;switch(l){case mt.TERRAIN_ID:g=o==null?void 0:o.id;break;case mt.TERRAIN_BIOME:g=o==null?void 0:o.biome;break;case mt.VISIBILITY:g=o==null?void 0:o.visibility;break;case mt.MOVEMENT_COST:g=(o==null?void 0:o.movementCost)??1;break;case mt.MELEE_ADVANTAGE:g=(o==null?void 0:o.meleeAdvantage)??0;break;case mt.TAG:g=(o==null?void 0:o.tags)||[];break;case mt.RANDOM:return!0;default:return!0}switch(i){case yt.EQUALS:return g===d;case yt.NOT_EQUALS:return g!==d;case yt.GREATER:return g>d;case yt.GREATER_EQUALS:return g>=d;case yt.LESS:return g<d;case yt.LESS_EQUALS:return g<=d;case yt.CONTAINS:return Array.isArray(g)?g.includes(d):String(g).includes(String(d));default:return!0}}function Hd(t,o,a){return!t.conditions||t.conditions.length===0?!0:t.conditions.every(l=>Od(l,o))}function jd(t,o,a,l){if(t.length===0)return new Set;const i=Math.round(t.length*(o/100));if(i===0)return new Set;const d=new Set,v=new Set(t),E=a/100,g=Math.max(1,Math.round(i*(1-E*.8))),b=l.shuffle([...v]);for(b.slice(0,Math.min(g,b.length)).forEach(M=>{d.add(M),v.delete(M)});d.size<i&&v.size>0;)if(l.next()<E){const R=[...d],T=l.shuffle(R);let F=!1;for(const Z of T){const{q:j,r:oe}=Fd(Z),ie=Ld(j,oe),ne=l.shuffle(ie);for(const O of ne){const S=Rd(O.q,O.r);if(v.has(S)){d.add(S),v.delete(S),F=!0;break}}if(F)break}if(!F&&v.size>0){const Z=l.shuffle([...v])[0];d.add(Z),v.delete(Z)}}else{const R=l.shuffle([...v])[0];d.add(R),v.delete(R)}return d}function nl(t,o,a,l={}){const{previewOnly:i=!1,customSeed:d=null}=l;if(!t||!o||o.length===0)return new Map;const v=d??t.seed??Date.now(),E=new Nd(v),g=new Map;for(const I of o)g.set(I,t.baseTerrain);const b=[...t.layers].filter(I=>I.enabled&&I.terrainId).sort((I,M)=>I.priority-M.priority);for(const I of b){const M=[];for(const T of o){const F=g.get(T),Z=a.getTerrainById(F);Hd(I,Z)&&M.push(T)}const R=jd(M,I.density,I.clustering,E);for(const T of R)g.set(T,I.terrainId)}return g}function zd(t,o){const a={total:t.size,byTerrain:{}};return t.forEach((l,i)=>{if(!a.byTerrain[l]){const d=o.getTerrainById(l);a.byTerrain[l]={id:l,name:(d==null?void 0:d.name)||l,count:0,percent:0}}a.byTerrain[l].count++}),Object.values(a.byTerrain).forEach(l=>{l.percent=Math.round(l.count/a.total*100)}),a}function Ud(t,o,a,l=null){return nl(t,o,a,{previewOnly:!0,customSeed:l??Date.now()})}const Kt=new Map,St=t=>t==null?null:typeof t=="number"?At(`/images/presets/${t}.png`):typeof t!="string"?At(`/images/presets/${String(t)}.png`):t.startsWith("http://")||t.startsWith("https://")||t.startsWith("data:")||t.startsWith("blob:")?t:t.startsWith("/")?At(t):At(`/images/presets/${t}.png`),ll=t=>{if(!t)return Promise.resolve(null);if(Kt.has(t))return Promise.resolve(Kt.get(t));const o=t.startsWith("http://")||t.startsWith("https://"),a=t.startsWith("data:")||t.startsWith("blob:");return new Promise((l,i)=>{const d=new Image,v=()=>{const E=new Image;E.onload=()=>{Kt.set(t,E),l(E)},E.onerror=()=>{console.warn("Failed to load image (no CORS):",t),l(null)},E.src=t};a||(d.crossOrigin="anonymous"),d.onload=()=>{Kt.set(t,d),l(d)},d.onerror=E=>{o?(console.warn("CORS failed for image, trying without:",t),v()):(console.warn("Failed to load image:",t,E),l(null))},d.src=t})},Bd=async t=>{const o=t.filter(a=>{var l;return(l=a.character)==null?void 0:l.portrait}).map(a=>{const l=St(a.character.portrait);return ll(l).catch(()=>null)});await Promise.all(o)},Mn=t=>{const o=Object.entries($t.default||$t).map(([l,i])=>({value:parseInt(l),...i})).filter(l=>l.value>=0).sort((l,i)=>l.value-i.value);let a=o[0];for(const l of o)if(l.value<=t)a=l;else break;return a},Et=(t,o,a,l)=>{const i=(l-90)*Math.PI/180;return{x:t+a*Math.cos(i),y:o+a*Math.sin(i)}},Es=(t,o,a,l,i,d,v,E)=>{var b;t.save();const g=St(i);if(t.beginPath(),t.arc(o,a,l,0,Math.PI*2),t.clip(),t.fillStyle="#1e293b",t.fill(),g&&Kt.has(g)){const I=Kt.get(g),M=I.width/I.height;let R,T,F,Z;M>1?(T=l*2,R=T*M,F=o-R/2,Z=a-l):(R=l*2,T=R/M,F=o-l,Z=a-T/2),t.drawImage(I,F,Z,R,T)}else t.fillStyle="#64748b",t.font=`bold ${l}px sans-serif`,t.textAlign="center",t.textBaseline="middle",t.fillText(((b=d==null?void 0:d.charAt(0))==null?void 0:b.toUpperCase())||"?",o,a);if(v&&E&&v.heavy>0){const I=E.heavy.base+E.heavy.bonus,M=v.heavy/I*.7,R=t.createLinearGradient(o,a+l,o,a-l);R.addColorStop(0,"rgba(220, 38, 38, 0.8)"),R.addColorStop(M,"rgba(220, 38, 38, 0.4)"),R.addColorStop(M+.01,"transparent"),t.fillStyle=R,t.fillRect(o-l,a-l,l*2,l*2)}if(v&&E&&v.deadly>0){const I=E.deadly.base+E.deadly.bonus,M=v.deadly/I;if(M>=1)t.fillStyle="rgba(0, 0, 0, 0.7)",t.fillRect(o-l,a-l,l*2,l*2);else{const R=t.createRadialGradient(o,a,0,o,a,l);R.addColorStop(0,"transparent"),R.addColorStop(.7,"transparent"),R.addColorStop(1,`rgba(220, 38, 38, ${.3+M*.5})`),t.fillStyle=R,t.fillRect(o-l,a-l,l*2,l*2)}}t.restore(),t.beginPath(),t.arc(o,a,l,0,Math.PI*2),t.strokeStyle="rgba(255, 255, 255, 0.3)",t.lineWidth=2,t.stroke()},tn=(t,o,a,l,i,d)=>{if(!i||!d||i.scratch===0)return;const v=d.scratch.base+d.scratch.bonus,E=i.scratch,g=10,b=(360-v*g)/v,M=180-(E*b+(E-1)*g)/2,R=l+4;t.strokeStyle="#fbbf24",t.lineWidth=2,t.lineCap="round";for(let T=0;T<E;T++){const F=M+T*(b+g),Z=(F-90)*Math.PI/180,j=(F+b-90)*Math.PI/180;t.beginPath(),t.arc(o,a,R,Z,j),t.stroke()}},sn=(t,o,a,l,i,d)=>{if(!i||!d||i.light===0)return;const v=i.light,E=25,g=l*.1,I=90+(v-1)*E/2;t.fillStyle="#dc2626";for(let M=0;M<v;M++){const T=(I-M*E)*Math.PI/180;t.beginPath(),t.arc(o+l*Math.cos(T),a+l*Math.sin(T),g,0,Math.PI*2),t.fill()}},An=(t,o,a,l,i,d,v=0,E="left")=>{if(!d)return;const g=d.color||"#FFFFFF",b=d.linetype||"single";let I;E==="left"?I={top:0,upper:300,lower:240,bottom:180}:I={top:0,upper:60,lower:120,bottom:180};const M=Et(o,a,l,I.top+v),R=Et(o,a,l,I.upper+v),T=Et(o,a,l,I.lower+v),F=Et(o,a,l,I.bottom+v);let Z,j;if(i==="front")Z=M,j=R;else if(i==="flank")Z=R,j=T;else if(i==="back")Z=T,j=F;else return;if(t.lineCap="butt",t.strokeStyle=g,b==="dashed")t.setLineDash([4,5]),t.lineWidth=1.5,t.beginPath(),t.moveTo(Z.x,Z.y),t.lineTo(j.x,j.y),t.stroke(),t.setLineDash([]);else if(b==="double"){t.lineWidth=1.5,t.beginPath(),t.moveTo(Z.x,Z.y),t.lineTo(j.x,j.y),t.stroke();const oe=l+1.5,ie=Et(o,a,oe,(i==="front"?I.top:i==="flank"?I.upper:I.lower)+v),ne=Et(o,a,oe,(i==="front"?I.upper:i==="flank"?I.lower:I.bottom)+v);t.setLineDash([4,5]),t.lineWidth=1.5,t.beginPath(),t.moveTo(ie.x,ie.y),t.lineTo(ne.x,ne.y),t.stroke(),t.setLineDash([])}else t.lineWidth=1.5,t.beginPath(),t.moveTo(Z.x,Z.y),t.lineTo(j.x,j.y),t.stroke()},Dn=(t,o,a,l,i,d,v=0,E="left")=>{if(!d)return;const g=d.color||"#FFFFFF",b=d.linetype||"single";let I,M;if(E==="left")if(i==="front")I=300,M=360;else if(i==="flank")I=240,M=300;else if(i==="back")I=180,M=240;else return;else if(i==="front")I=0,M=60;else if(i==="flank")I=60,M=120;else if(i==="back")I=120,M=180;else return;I+=v,M+=v;const R=(I-90)*Math.PI/180,T=(M-90)*Math.PI/180;t.lineCap="butt",t.strokeStyle=g,b==="dashed"?(t.setLineDash([4,5]),t.lineWidth=1.5,t.beginPath(),t.arc(o,a,l,R,T),t.stroke(),t.setLineDash([])):b==="double"?(t.lineWidth=1.5,t.beginPath(),t.arc(o,a,l,R,T),t.stroke(),t.setLineDash([4,5]),t.lineWidth=1.5,t.beginPath(),t.arc(o,a,l+1.5,R,T),t.stroke(),t.setLineDash([])):(t.lineWidth=1.5,t.beginPath(),t.arc(o,a,l,R,T),t.stroke())},nn=(t,o,a,l,i,d,v=0,E={})=>{const{bothSides:g=!1}=E,b=l+14,I=b+6;if(i)for(const M of["front","flank","back"]){const R=i[M];if(R!=null){const T=Mn(R);An(t,o,a,b,M,T,v,"left"),g&&An(t,o,a,b,M,T,v,"right")}}if(d)for(const M of["front","flank","back"]){const R=d[M];if(R!=null){const T=Mn(R);Dn(t,o,a,I,M,T,v,"left"),g&&Dn(t,o,a,I,M,T,v,"right")}}},al=(t,o,a,l,i=0)=>{const d=Et(o,a,l+8,i),v=Et(o,a,l,i-15),E=Et(o,a,l,i+15);t.beginPath(),t.moveTo(d.x,d.y),t.lineTo(v.x,v.y),t.lineTo(E.x,E.y),t.closePath(),t.fillStyle="rgba(250, 204, 21, 0.9)",t.fill(),t.strokeStyle="rgba(0, 0, 0, 0.5)",t.lineWidth=1,t.stroke()},Wd=(t,o,a={})=>{var ne,O;const{tokenSize:l=48,isHovered:i=!1,isSelected:d=!1,canSeeDefence:v=!1,facingOffset:E=0}=a,{character:g,pixelX:b,pixelY:I,facing:M=0,meleeDefence:R,rangedDefence:T}=o;if(!g)return;const F=b,Z=I,j=l/2,oe=M*30+E;if((i||d)&&v&&(R||T)){const S=(ne=g.combat)==null?void 0:ne.wounds,D=g.woundSlots||(g.stats?ts(g.stats,((O=g.combat)==null?void 0:O.bonusDeadlySlots)||0):null);ol(t,F,Z,j,oe,d,i),nn(t,F,Z,j,R,T,oe,{bothSides:!0}),Es(t,F,Z,j,g.portrait,g.name,S,D),S&&D&&(tn(t,F,Z,j,S,D),sn(t,F,Z,j,S,D));const r=j+28;al(t,F,Z,r,oe)}},qd=(t,o,a={})=>{var r,h;const{tokenSize:l=48,showDefence:i=!1,showFacing:d=!0,isHovered:v=!1,isSelected:E=!1,canSeeDefence:g=!1,facingOffset:b=0}=a,{character:I,pixelX:M,pixelY:R,facing:T=0,meleeDefence:F,rangedDefence:Z}=o;if(!I)return;const j=M,oe=R,ie=l/2,ne=T*30+b,O=(r=I.combat)==null?void 0:r.wounds,S=I.woundSlots||(I.stats?ts(I.stats,((h=I.combat)==null?void 0:h.bonusDeadlySlots)||0):null),D=(v||E)&&g&&(F||Z);if(D&&ol(t,j,oe,ie,ne,E,v),Es(t,j,oe,ie,I.portrait,I.name,O,S),O&&S&&(tn(t,j,oe,ie,O,S),sn(t,j,oe,ie,O,S)),D&&nn(t,j,oe,ie,F,Z,ne,{bothSides:!0}),d){const _=ie+(D?28:8);al(t,j,oe,_,ne)}},ol=(t,o,a,l,i=0,d=!1,v=!1)=>{t.save();const E=l+35,g=t.createRadialGradient(o,a,l-5,o,a,E);d?(g.addColorStop(0,"rgba(45, 35, 15, 0.95)"),g.addColorStop(.6,"rgba(35, 28, 12, 0.85)"),g.addColorStop(1,"rgba(25, 20, 8, 0)")):v?(g.addColorStop(0,"rgba(15, 30, 45, 0.95)"),g.addColorStop(.6,"rgba(12, 25, 38, 0.85)"),g.addColorStop(1,"rgba(8, 18, 28, 0)")):(g.addColorStop(0,"rgba(15, 23, 42, 0.95)"),g.addColorStop(.6,"rgba(15, 23, 42, 0.85)"),g.addColorStop(1,"rgba(15, 23, 42, 0)")),t.beginPath(),t.arc(o,a,E,0,Math.PI*2),t.fillStyle=g,t.fill(),t.beginPath(),t.arc(o,a,E-2,0,Math.PI*2),d?t.strokeStyle="rgba(250, 204, 21, 0.4)":v?t.strokeStyle="rgba(56, 189, 248, 0.4)":t.strokeStyle="rgba(148, 163, 184, 0.3)",t.lineWidth=1,t.stroke(),t.restore()},Vd=(t,o,a={})=>{const{hoveredTokenId:l=null,selectedTokenId:i=null,currentUserId:d=null,isMaster:v=!1,draggingTokenId:E=null,facingOffset:g=0}=a,b=o.map(M=>{var ie,ne,O;const R=M.id===l||M.characterId===l,T=M.id===i||M.characterId===i,F=M.id===E||M.characterId===E,Z=((ie=M.character)==null?void 0:ie.ownerId)===d,j=((O=(ne=M.character)==null?void 0:ne.combat)==null?void 0:O.showDefenceToOthers)||!1;return{token:M,isHovered:R,isSelected:T,isDragging:F,canSeeDefence:v||Z||j}});for(const{token:M,isHovered:R,isSelected:T,isDragging:F,canSeeDefence:Z}of b)F&&(t.save(),t.globalAlpha=.7),qd(t,M,{...a,isHovered:!1,isSelected:!1,canSeeDefence:Z}),F&&t.restore();const I=b.filter(M=>M.isHovered||M.isSelected);I.sort((M,R)=>M.isHovered&&!R.isHovered?1:!M.isHovered&&R.isHovered?-1:0);for(const{token:M,isHovered:R,isSelected:T,canSeeDefence:F}of I)Wd(t,M,{...a,isHovered:R,isSelected:T,canSeeDefence:F})},Xd=(t,o,a,l)=>{const i=t-a.pixelX,d=o-a.pixelY,v=l/2;return i*i+d*d<=v*v},ds=(t,o,a,l)=>{for(let i=a.length-1;i>=0;i--){const d=a[i];if(Xd(t,o,d,l))return d}return null},Yt=(t,o,a)=>({x:(t-a.x)/a.zoom,y:(o-a.y)/a.zoom}),Yd={class:"fill-profile-panel flex flex-col h-full bg-slate-800 text-white"},Gd={class:"flex items-center justify-between px-3 py-2 border-b border-white/10"},Kd={class:"flex border-b border-white/10"},Qd=["onClick"],Zd={class:"flex-1 overflow-y-auto p-3"},Jd={class:"space-y-2"},eu={class:"flex items-center justify-between mb-2"},tu={class:"flex gap-1"},su={key:0,class:"p-2 bg-slate-700/50 rounded-lg mb-2"},nu={class:"flex gap-1"},lu=["onClick"],au={class:"flex items-center justify-between"},ou={class:"text-sm font-medium"},iu={class:"text-xs text-slate-400"},ru=["onClick"],cu={key:1,class:"text-center text-slate-500 text-xs py-4"},du={key:0,class:"mt-4 pt-4 border-t border-white/10"},uu={class:"grid grid-cols-5 gap-1 max-h-32 overflow-y-auto"},fu=["title","onClick"],vu={key:1,class:"space-y-2"},mu={class:"flex items-center justify-between mb-2"},pu={class:"text-xs text-slate-400"},hu=["onClick"],gu={class:"flex items-center gap-2"},bu=["checked","onChange"],yu={class:"text-sm"},xu={class:"flex items-center gap-1"},ku={class:"text-xs text-slate-400"},wu=["onClick"],_u={key:0,class:"mt-3 pt-3 border-t border-white/10 space-y-3"},$u=["value","onInput"],Cu={class:"grid grid-cols-6 gap-1 mt-1 max-h-24 overflow-y-auto"},Tu=["title","onClick"],Su={class:"flex items-center justify-between"},Iu={class:"text-xs text-sky-400"},Pu=["value","onInput"],Eu={class:"flex items-center justify-between"},Mu={class:"text-xs text-sky-400"},Au={class:"flex items-center gap-2 text-[10px] text-slate-500"},Du=["value","onInput"],Nu={class:"flex items-center justify-between mb-1"},Lu=["onClick"],Fu={key:0,class:"text-xs text-slate-500 italic"},Ru=["value","onChange"],Ou=["value"],Hu=["value","onChange"],ju=["value"],zu=["value","onInput"],Uu=["onClick"],Bu={key:0,class:"text-center text-slate-500 text-xs py-4"},Wu={key:2,class:"text-center py-8"},qu={key:3,class:"text-center text-slate-500 text-xs py-8"},Vu={key:0,class:"p-3 border-t border-white/10"},Xu={__name:"FillProfilePanel",emits:["apply","preview","close"],setup(t,{emit:o}){const a=o,l=Bn(),i=sl(),{profiles:d,currentProfile:v,sortedProfiles:E}=pt(l),g=Q("profile"),b=Q(null),I=Q(!1),M=Q(""),R=X(()=>[...i.baseTerrains,...i.customTerrains]),T=ce=>R.value.find(Y=>Y.id===ce)||{name:ce,color:"#888"},F=()=>{M.value.trim()&&(l.createProfile({name:M.value.trim()}),M.value="",I.value=!1)},Z=ce=>{l.selectProfile(ce),b.value=null},j=ce=>{confirm("Удалить профиль?")&&l.deleteProfile(ce)},oe=()=>{var Y;if(!v.value)return;const ce=l.addLayer(v.value.id,{name:`Слой ${(((Y=v.value.layers)==null?void 0:Y.length)||0)+1}`});ce&&(b.value=ce.id,g.value="layers")},ie=ce=>{v.value&&(l.removeLayer(v.value.id,ce),b.value===ce&&(b.value=null))},ne=(ce,Y,ve)=>{v.value&&l.updateLayer(v.value.id,ce,{[Y]:ve})},O=ce=>{v.value&&l.updateProfile(v.value.id,{baseTerrain:ce})},S=ce=>{v.value&&l.addCondition(v.value.id,ce,{type:mt.NONE})},D=(ce,Y)=>{v.value&&l.removeCondition(v.value.id,ce,Y)},r=()=>{v.value&&a("apply",v.value)},h=()=>{v.value&&a("preview",v.value)},_=()=>{l.createDefaultProfile()},P={[mt.NONE]:"Без условия",[mt.TERRAIN_ID]:"Террейн",[mt.TERRAIN_BIOME]:"Биом",[mt.VISIBILITY]:"Видимость",[mt.MOVEMENT_COST]:"Проходимость",[mt.MELEE_ADVANTAGE]:"Бонус ближ. боя",[mt.TAG]:"Тег"},B={[yt.EQUALS]:"=",[yt.NOT_EQUALS]:"≠",[yt.GREATER]:">",[yt.GREATER_EQUALS]:"≥",[yt.LESS]:"<",[yt.LESS_EQUALS]:"≤",[yt.CONTAINS]:"содержит"};return(ce,Y)=>{var ve;return s(),n("div",Yd,[e("header",Gd,[Y[5]||(Y[5]=e("h3",{class:"text-sm font-medium"},"Профили заливки",-1)),e("button",{type:"button",class:"text-slate-400 hover:text-white transition",onClick:Y[0]||(Y[0]=H=>a("close"))}," ✕ ")]),e("div",Kd,[(s(),n(W,null,re([{id:"profile",label:"📋 Профиль"},{id:"layers",label:"📚 Слои"},{id:"preview",label:"👁 Превью"}],H=>e("button",{key:H.id,type:"button",class:te(["flex-1 px-3 py-2 text-xs transition",g.value===H.id?"bg-sky-500/20 text-sky-400 border-b-2 border-sky-400":"text-slate-400 hover:text-white hover:bg-white/5"]),onClick:y=>g.value=H.id},u(H.label),11,Qd)),64))]),e("div",Zd,[g.value==="profile"?(s(),n(W,{key:0},[e("div",Jd,[e("div",eu,[Y[6]||(Y[6]=e("span",{class:"text-xs text-slate-400"},"Сохранённые профили",-1)),e("div",tu,[e("button",{type:"button",class:"px-2 py-1 text-xs bg-sky-500/20 text-sky-400 rounded hover:bg-sky-500/30 transition",onClick:Y[1]||(Y[1]=H=>I.value=!0)}," + Новый "),f(d).length===0?(s(),n("button",{key:0,type:"button",class:"px-2 py-1 text-xs bg-emerald-500/20 text-emerald-400 rounded hover:bg-emerald-500/30 transition",onClick:_}," Пример ")):x("",!0)])]),I.value?(s(),n("div",su,[Me(e("input",{"onUpdate:modelValue":Y[2]||(Y[2]=H=>M.value=H),type:"text",placeholder:"Название профиля...",class:"w-full px-2 py-1 text-xs bg-slate-900/50 border border-white/10 rounded mb-2 focus:outline-none focus:border-sky-400/50",onKeyup:Un(F,["enter"])},null,544),[[Be,M.value]]),e("div",nu,[e("button",{type:"button",class:"flex-1 px-2 py-1 text-xs bg-sky-500 text-white rounded hover:bg-sky-600 transition",onClick:F}," Создать "),e("button",{type:"button",class:"px-2 py-1 text-xs text-slate-400 hover:text-white transition",onClick:Y[3]||(Y[3]=H=>{I.value=!1,M.value=""})}," Отмена ")])])):x("",!0),(s(!0),n(W,null,re(f(E),H=>{var y,L;return s(),n("div",{key:H.id,class:te(["p-2 rounded-lg border transition cursor-pointer",((y=f(v))==null?void 0:y.id)===H.id?"bg-sky-500/20 border-sky-400/60":"bg-slate-700/30 border-white/10 hover:border-white/20"]),onClick:le=>Z(H.id)},[e("div",au,[e("div",null,[e("div",ou,u(H.name),1),e("div",iu,u(((L=H.layers)==null?void 0:L.length)||0)+" слоёв • База: "+u(T(H.baseTerrain).name),1)]),e("button",{type:"button",class:"p-1 text-slate-400 hover:text-red-400 transition",onClick:Fe(le=>j(H.id),["stop"])}," 🗑 ",8,ru)])],10,lu)}),128)),f(d).length===0?(s(),n("div",cu," Нет сохранённых профилей ")):x("",!0)]),f(v)?(s(),n("div",du,[Y[7]||(Y[7]=e("div",{class:"text-xs text-slate-400 mb-2"},"Базовый террейн",-1)),e("div",uu,[(s(!0),n(W,null,re(R.value,H=>(s(),n("button",{key:H.id,type:"button",class:te(["w-10 h-10 rounded border transition",f(v).baseTerrain===H.id?"border-sky-400 ring-2 ring-sky-400/50":"border-white/10 hover:border-white/30"]),style:Ne({backgroundColor:H.color||"#888"}),title:H.name,onClick:y=>O(H.id)},null,14,fu))),128))])])):x("",!0)],64)):x("",!0),g.value==="layers"&&f(v)?(s(),n("div",vu,[e("div",mu,[e("span",pu,'Слои профиля "'+u(f(v).name)+'"',1),e("button",{type:"button",class:"px-2 py-1 text-xs bg-sky-500/20 text-sky-400 rounded hover:bg-sky-500/30 transition",onClick:oe}," + Слой ")]),(s(!0),n(W,null,re(f(v).layers,H=>{var y;return s(),n("div",{key:H.id,class:te(["p-2 rounded-lg border transition",b.value===H.id?"bg-sky-500/10 border-sky-400/60":"bg-slate-700/30 border-white/10"])},[e("div",{class:"flex items-center justify-between cursor-pointer",onClick:L=>b.value=b.value===H.id?null:H.id},[e("div",gu,[e("input",{type:"checkbox",checked:H.enabled,class:"rounded",onClick:Y[4]||(Y[4]=Fe(()=>{},["stop"])),onChange:L=>ne(H.id,"enabled",L.target.checked)},null,40,bu),e("span",{class:"w-4 h-4 rounded",style:Ne({backgroundColor:T(H.terrainId).color||"#888"})},null,4),e("span",yu,u(H.name),1)]),e("div",xu,[e("span",ku,u(H.density)+"%",1),e("button",{type:"button",class:"p-1 text-slate-400 hover:text-red-400 transition",onClick:Fe(L=>ie(H.id),["stop"])}," ✕ ",8,wu)])],8,hu),b.value===H.id?(s(),n("div",_u,[e("div",null,[Y[8]||(Y[8]=e("label",{class:"text-xs text-slate-400"},"Название",-1)),e("input",{value:H.name,type:"text",class:"w-full px-2 py-1 text-xs bg-slate-900/50 border border-white/10 rounded mt-1 focus:outline-none focus:border-sky-400/50",onInput:L=>ne(H.id,"name",L.target.value)},null,40,$u)]),e("div",null,[Y[9]||(Y[9]=e("label",{class:"text-xs text-slate-400"},"Террейн",-1)),e("div",Cu,[(s(!0),n(W,null,re(R.value,L=>(s(),n("button",{key:L.id,type:"button",class:te(["w-8 h-8 rounded border transition",H.terrainId===L.id?"border-sky-400 ring-2 ring-sky-400/50":"border-white/10 hover:border-white/30"]),style:Ne({backgroundColor:L.color||"#888"}),title:L.name,onClick:le=>ne(H.id,"terrainId",L.id)},null,14,Tu))),128))])]),e("div",null,[e("div",Su,[Y[10]||(Y[10]=e("label",{class:"text-xs text-slate-400"},"Плотность",-1)),e("span",Iu,u(H.density)+"%",1)]),e("input",{value:H.density,type:"range",min:"0",max:"100",class:"w-full mt-1",onInput:L=>ne(H.id,"density",Number(L.target.value))},null,40,Pu)]),e("div",null,[e("div",Eu,[Y[11]||(Y[11]=e("label",{class:"text-xs text-slate-400"},"Группировка",-1)),e("span",Mu,u(H.clustering)+"%",1)]),e("div",Au,[Y[12]||(Y[12]=e("span",null,"Разброс",-1)),e("input",{value:H.clustering,type:"range",min:"0",max:"100",class:"flex-1",onInput:L=>ne(H.id,"clustering",Number(L.target.value))},null,40,Du),Y[13]||(Y[13]=e("span",null,"Кластеры",-1))])]),e("div",null,[e("div",Nu,[Y[14]||(Y[14]=e("label",{class:"text-xs text-slate-400"},"Условия",-1)),e("button",{type:"button",class:"text-xs text-sky-400 hover:text-sky-300",onClick:L=>S(H.id)}," + Условие ",8,Lu)]),((y=H.conditions)==null?void 0:y.length)===0?(s(),n("div",Fu," Нет условий (применяется везде) ")):x("",!0),(s(!0),n(W,null,re(H.conditions,L=>(s(),n("div",{key:L.id,class:"flex items-center gap-1 mt-1 p-1 bg-slate-900/30 rounded text-xs"},[e("select",{value:L.type,class:"flex-1 px-1 py-0.5 bg-slate-800 border border-white/10 rounded text-xs",onChange:le=>f(l).updateLayer(f(v).id,H.id,{conditions:H.conditions.map(V=>V.id===L.id?{...V,type:le.target.value}:V)})},[(s(),n(W,null,re(P,(le,V)=>e("option",{key:V,value:V},u(le),9,Ou)),64))],40,Ru),L.type!==f(mt).NONE?(s(),n("select",{key:0,value:L.operator,class:"px-1 py-0.5 bg-slate-800 border border-white/10 rounded text-xs",onChange:le=>f(l).updateLayer(f(v).id,H.id,{conditions:H.conditions.map(V=>V.id===L.id?{...V,operator:le.target.value}:V)})},[(s(),n(W,null,re(B,(le,V)=>e("option",{key:V,value:V},u(le),9,ju)),64))],40,Hu)):x("",!0),L.type!==f(mt).NONE?(s(),n("input",{key:1,value:L.value,type:"text",placeholder:"значение",class:"w-16 px-1 py-0.5 bg-slate-800 border border-white/10 rounded text-xs",onInput:le=>f(l).updateLayer(f(v).id,H.id,{conditions:H.conditions.map(V=>V.id===L.id?{...V,value:le.target.value}:V)})},null,40,zu)):x("",!0),e("button",{type:"button",class:"text-slate-400 hover:text-red-400",onClick:le=>D(H.id,L.id)}," ✕ ",8,Uu)]))),128))])])):x("",!0)],2)}),128)),(ve=f(v).layers)!=null&&ve.length?x("",!0):(s(),n("div",Bu," Добавьте слои для настройки заливки "))])):x("",!0),g.value==="preview"&&f(v)?(s(),n("div",Wu,[Y[15]||(Y[15]=e("div",{class:"text-slate-400 text-sm mb-4"},' Выделите область на карте и нажмите "Превью" чтобы увидеть результат ',-1)),e("button",{type:"button",class:"px-4 py-2 bg-amber-500/20 text-amber-400 rounded-lg hover:bg-amber-500/30 transition",onClick:h}," 👁 Показать превью ")])):x("",!0),!f(v)&&g.value!=="profile"?(s(),n("div",qu," Выберите или создайте профиль ")):x("",!0)]),f(v)?(s(),n("footer",Vu,[e("button",{type:"button",class:"w-full py-2 bg-emerald-500 text-white rounded-lg font-medium hover:bg-emerald-600 transition",onClick:r}," 🎲 Применить к выделению ")])):x("",!0)])}}},Yu=wt(Xu,[["__scopeId","data-v-f9b9add9"]]),Gu={class:"h-full bg-slate-950 text-slate-50 flex flex-col overflow-hidden relative"},Ku={key:0,class:"bg-slate-900/90 backdrop-blur border-b border-white/10 px-4 py-2 flex items-center justify-between flex-shrink-0 gap-2 relative z-20"},Qu={class:"flex items-center gap-2"},Zu={key:0,class:"relative"},Ju={class:"font-medium truncate max-w-32"},ef=["onClick"],tf={class:"text-sm font-medium"},sf={class:"text-xs text-slate-400"},nf={key:0,class:"text-xs text-emerald-400"},lf={key:0,class:"border-t border-white/10 mt-1 pt-1"},af={key:1,class:"flex items-center gap-2"},of={key:0,class:"px-3 py-1.5 rounded-lg bg-slate-800 border border-white/10 text-sm font-medium"},rf={key:1,class:"px-3 py-1.5 rounded-lg bg-slate-800/50 border border-white/10 text-sm text-slate-400"},cf={key:0,class:"text-xs px-2 py-1 rounded bg-slate-800 border border-white/10"},df={key:1,class:"text-xs px-2 py-1 rounded bg-slate-700 text-slate-400"},uf={key:0,class:"flex items-center gap-1"},ff=["title","onClick"],vf={class:"relative"},mf={class:"p-2 border-b border-white/10"},pf={class:"overflow-y-auto flex-1 p-2"},hf={key:0,class:"mb-3"},gf={class:"grid grid-cols-2 gap-1"},bf=["onClick"],yf={class:"w-5 h-5 rounded-full bg-slate-700 flex items-center justify-center text-[10px] flex-shrink-0 overflow-hidden"},xf=["src"],kf={key:1},wf={class:"truncate flex-1"},_f={key:0,class:"text-emerald-400"},$f={key:1},Cf={class:"grid grid-cols-2 gap-1"},Tf=["onClick"],Sf={class:"w-5 h-5 rounded-full bg-slate-700 flex items-center justify-center text-[10px] flex-shrink-0 overflow-hidden"},If=["src"],Pf={key:1},Ef={class:"truncate flex-1"},Mf={key:0,class:"text-emerald-400"},Af={key:2,class:"text-xs text-slate-500 italic text-center py-4"},Df={class:"relative"},Nf={class:"mb-3"},Lf={class:"flex gap-1"},Ff=["title","onClick"],Rf={class:"mb-3"},Of={class:"flex gap-1"},Hf=["title","onClick"],jf={class:"mb-3"},zf={class:"flex gap-1"},Uf=["title","onClick"],Bf={class:"text-[10px] text-slate-500 mt-1"},Wf={key:0},qf={class:"text-xs text-slate-400 mb-1"},Vf=["value"],Xf={class:"text-xs text-slate-400 px-1"},Yf={class:"relative"},Gf={class:"text-xs"},Kf={class:"p-2 border-b border-white/10"},Qf={class:"flex items-center gap-2"},Zf={key:0,class:"mt-2 space-y-2"},Jf={class:"flex items-center gap-2"},ev=["value"],tv={class:"flex items-center gap-2"},sv=["value"],nv={class:"flex items-center gap-2"},lv={class:"text-xs text-slate-300 w-8"},av={class:"p-2 max-h-64 overflow-y-auto"},ov={key:0,class:"grid grid-cols-5 gap-1"},iv=["title","onClick"],rv={class:"absolute bottom-0 left-0 right-0 flex justify-center gap-0.5 p-0.5 bg-black/50 opacity-0 group-hover:opacity-100 transition"},cv={key:0,class:"text-[8px]"},dv={key:1,class:"text-[8px]"},uv={key:2,class:"text-[8px]"},fv={key:3,class:"text-[8px]"},vv={key:4,class:"text-[8px] text-green-400"},mv={key:5,class:"text-[8px] text-red-400"},pv={key:1,class:"text-center text-xs text-slate-400 py-4"},hv={key:2,class:"mt-2 pt-2 border-t border-white/10"},gv={class:"grid grid-cols-5 gap-1"},bv=["title","onClick"],yv={class:"flex items-center gap-2"},xv=["title"],kv={class:"flex-1 flex overflow-hidden"},wv=["width","height"],_v=["width","height"],$v=["width","height"],Cv={key:0,class:"absolute bottom-4 left-4 px-3 py-1.5 rounded-lg bg-slate-900/90 border border-white/10 text-xs font-mono pointer-events-none"},Tv={key:1,class:"absolute bottom-4 right-4 px-3 py-1.5 rounded-lg bg-slate-900/90 border border-white/10 text-xs pointer-events-none"},Sv={key:1,class:"bg-slate-900/80 backdrop-blur border-t border-white/10 px-4 py-2 flex-shrink-0 relative z-10"},Iv={class:"flex items-center justify-between text-sm"},Pv={class:"text-slate-400 text-xs"},Ev={class:"flex items-center gap-2"},Mv={class:"bg-slate-800 border border-white/10 rounded-xl p-6 w-full max-w-md shadow-2xl"},Av={class:"space-y-4"},Dv={class:"flex gap-2"},Nv=["value"],Lv={class:"flex justify-end gap-2 mt-6"},Fv=400,Rv=80,Ov=25,_s=45,Nn=15,Hv={__name:"BattleMap",props:{readonly:{type:Boolean,default:!1},mobileMode:{type:Boolean,default:!1},pendingAction:{type:Object,default:null}},emits:["action-target-selected","token-selected","hex-selected","hex-double-tap","hex-long-press-move","hex-long-press-confirm","token-rotate"],setup(t,{emit:o}){const a=t,l=o,i=ss(),d=sl();Bn();const v=Rt(),E=Bt(),g=ms(),{activeMap:b,editingMap:I,editorMode:M,selectedTerrain:R,activeLayerId:T,camera:F,maps:Z,publishedMaps:j,selection:oe}=pt(i),{isMaster:ie}=pt(v),{characters:ne,npcs:O,otherTokens:S}=pt(E),D=X(()=>{const w=[...ne.value||[]];return ie.value&&(O.value||[]).forEach(q=>{w.push({...q,isNpc:!0})}),w}),r=w=>{var c;return w?ie.value?!0:((c=w.character)==null?void 0:c.ownerId)===g.userId:!1},h=X(()=>a.readonly||!ie.value),_=X(()=>!h.value),P=Q(null),B=Q(null),ce=Q(null),Y=Q(null),ve=Q({width:800,height:600}),H=Q(!1),y=Q(!1),L=Q(!1),le=Q(!1),V=Q(!1),de=Q(!1),Se=Q(""),fe=Q(null),he=Q(null),we=Q(null),De=Q(!1),ye=Q(!1),xe=Q(!1),Le=Q(null),qe=Q({x:0,y:0}),Qe=Q(null),Ve=Q(""),Re=Q(null),rt=Q(null),at=Q({min:1,max:5}),lt=Q(!1),tt=Q(!1),it=Q(null),Oe=Q(null),Xe=Q([]),je=Q(new Set),dt=Q(null),ht=Q({x:0,y:0}),z=Q({name:"",orientation:qt.FLAT,scale:Ht.BATTLE,hexSize:32}),N=X(()=>{const w=b.value;return w?new Fl({orientation:w.orientation,hexSize:w.hexSize,origin:{x:0,y:0}}):null}),me=X(()=>{if(!b.value||!N.value)return[];O.value,ne.value,S.value;const w=i.getAllTokens(b.value.id),c=N.value;return w.map(q=>{const ee=E.getCharacterById(q.characterId);if(!ee)return null;const ge=c.hexToPixel(q.q,q.r);return{...q,character:ee,pixelX:ge.x,pixelY:ge.y,meleeDefence:es(ee,"melee"),rangedDefence:es(ee,"ranged")}}).filter(Boolean)}),p=X(()=>b.value?Math.floor(b.value.hexSize*1.6):48),k=X(()=>N.value?new Rl(N.value):null),$=X(()=>d.getFilteredTerrains({biome:Re.value,visibility:rt.value,passabilityMin:at.value.min,passabilityMax:at.value.max,search:Ve.value})),se=X(()=>[...d.baseTerrains,...d.customTerrains]),G=X(()=>{const w=se.value.find(c=>c.id===R.value);if(w)return w;if(os[R.value]){const c=os[R.value];return{id:R.value,name:c.name,fallbackColor:c.color,passability:c.passable?1:0}}return{id:"void",name:"Пустота",fallbackColor:"#0d1117",passability:0}}),ue=w=>{if(!w||!b.value)return w;const c=i.getHexTerrain(b.value.id,w.q,w.r),q=d.getTerrainById(c);return{q:w.q,r:w.r,terrain:q||null}};Ut(()=>{We(),_.value&&(Z.value.length===0?an():b.value||i.setActiveMap(Z.value[0].id)),ct(),Mt(()=>{ot()}),window.addEventListener("resize",ps)}),Xs(()=>{window.removeEventListener("resize",ps)}),Qt([b,F],()=>{Mt(()=>{ot()})},{deep:!0}),Qt(me,async w=>{w.length>0&&(await Bd(w),et())},{immediate:!0});let Ze=null;Qt(()=>{var w;return(w=b.value)==null?void 0:w.updatedAt},(w,c)=>{!ie.value||!w||(Ze&&clearTimeout(Ze),Ze=setTimeout(()=>{v.broadcastMap()},500))},{flush:"post"});const We=()=>{if(P.value){const w=P.value.getBoundingClientRect();ve.value={width:Math.floor(w.width)||800,height:Math.floor(w.height)||600}}},ct=()=>{i.$patch({camera:{x:ve.value.width/2,y:ve.value.height/2,zoom:1}})},ot=()=>{J(),nt(),et()},J=()=>{const w=B.value;if(!w||!b.value||!N.value)return;const c=w.getContext("2d"),q=b.value,ee=N.value;c.clearRect(0,0,w.width,w.height),c.save(),c.translate(F.value.x,F.value.y),c.scale(F.value.zoom,F.value.zoom);const ge=q.layers.find(Ae=>Ae.type===Vt.TERRAIN);if(!ge){c.restore();return}ge.data.forEach((Ae,C)=>{const[be,_e]=C.split(",").map(Number),Ce=ee.hexToPixel(be,_e),Pe=ee.getHexCorners(Ce.x,Ce.y);let Ue=(Ae==null?void 0:Ae.terrain)||"void",He=!1;Qe.value&&Qe.value.has(C)&&(Ue=Qe.value.get(C),He=!0);let Ye="#0d1117";const ft=d.getTerrainById(Ue);ft?Ye=ft.fallbackColor||ft.color||Ye:os[Ue]&&(Ye=os[Ue].color),c.beginPath(),c.moveTo(Pe[0].x,Pe[0].y);for(let st=1;st<6;st++)c.lineTo(Pe[st].x,Pe[st].y);c.closePath(),c.fillStyle=Ye,c.fill(),He&&(c.strokeStyle="rgba(255, 255, 0, 0.6)",c.lineWidth=2/F.value.zoom,c.stroke())}),c.restore()},nt=()=>{const w=ce.value;if(!w||!b.value||!N.value)return;const c=w.getContext("2d"),q=b.value,ee=N.value;if(c.clearRect(0,0,w.width,w.height),!q.visibility.showGrid)return;c.save(),c.translate(F.value.x,F.value.y),c.scale(F.value.zoom,F.value.zoom);const ge=q.layers.find(C=>C.type===Vt.TERRAIN);if(!ge){c.restore();return}c.strokeStyle="rgba(255, 255, 255, 0.2)",c.lineWidth=1/F.value.zoom,ge.data.forEach((C,be)=>{const[_e,Ce]=be.split(",").map(Number),Pe=ee.hexToPixel(_e,Ce),Ue=ee.getHexCorners(Pe.x,Pe.y);c.beginPath(),c.moveTo(Ue[0].x,Ue[0].y);for(let He=1;He<6;He++)c.lineTo(Ue[He].x,Ue[He].y);c.closePath(),c.stroke()});const Ae=ee.hexToPixel(0,0);c.beginPath(),c.arc(Ae.x,Ae.y,4/F.value.zoom,0,Math.PI*2),c.fillStyle="rgba(250, 204, 21, 0.8)",c.fill(),c.restore()},et=()=>{var ge,Ae,C,be;const w=Y.value;if(!w||!b.value||!N.value)return;const c=w.getContext("2d"),q=N.value;if(c.clearRect(0,0,w.width,w.height),c.save(),c.translate(F.value.x,F.value.y),c.scale(F.value.zoom,F.value.zoom),je.value.size>0&&je.value.forEach(_e=>{const[Ce,Pe]=_e.split(",").map(Number),Ue=q.hexToPixel(Ce,Pe),He=q.getHexCorners(Ue.x,Ue.y);c.beginPath(),c.moveTo(He[0].x,He[0].y);for(let Ye=1;Ye<6;Ye++)c.lineTo(He[Ye].x,He[Ye].y);c.closePath(),c.fillStyle="rgba(250, 204, 21, 0.25)",c.fill(),c.strokeStyle="rgba(250, 204, 21, 0.8)",c.lineWidth=2/F.value.zoom,c.stroke()}),Xe.value.length>0&&tt.value){const _e=oe.value.mode;let Ce,Pe;if(_e===xt.ADD?(Ce="rgba(34, 197, 94, 0.3)",Pe="rgba(34, 197, 94, 0.9)"):_e===xt.SUBTRACT?(Ce="rgba(239, 68, 68, 0.3)",Pe="rgba(239, 68, 68, 0.9)"):(Ce="rgba(56, 189, 248, 0.3)",Pe="rgba(56, 189, 248, 0.9)"),Xe.value.forEach(Ue=>{const He=q.hexToPixel(Ue.q,Ue.r),Ye=q.getHexCorners(He.x,He.y);c.beginPath(),c.moveTo(Ye[0].x,Ye[0].y);for(let ft=1;ft<6;ft++)c.lineTo(Ye[ft].x,Ye[ft].y);c.closePath(),c.fillStyle=Ce,c.fill(),c.strokeStyle=Pe,c.lineWidth=1.5/F.value.zoom,c.stroke()}),Oe.value&&fe.value){const Ue=oe.value.shape,He=Oe.value,Ye=q.hexToPixel(fe.value.q,fe.value.r);if(c.setLineDash([5/F.value.zoom,5/F.value.zoom]),c.strokeStyle=Pe,c.lineWidth=2/F.value.zoom,Ue===vt.RECTANGLE){const ft=Math.min(He.x,Ye.x),st=Math.max(He.x,Ye.x),Nt=Math.min(He.y,Ye.y),ls=Math.max(He.y,Ye.y);c.strokeRect(ft,Nt,st-ft,ls-Nt)}else if(Ue===vt.CIRCLE||Ue===vt.HEXAGON){const ft=Ye.x-He.x,st=Ye.y-He.y,Nt=Math.sqrt(ft*ft+st*st);c.beginPath(),c.arc(He.x,He.y,Nt,0,Math.PI*2),c.stroke()}else Ue===vt.LINE&&(c.beginPath(),c.moveTo(He.x,He.y),c.lineTo(Ye.x,Ye.y),c.stroke());c.setLineDash([])}}if(Oe.value&&tt.value){const _e=Oe.value;c.beginPath(),c.arc(_e.x,_e.y,6/F.value.zoom,0,Math.PI*2),c.fillStyle="rgba(250, 204, 21, 0.9)",c.fill(),c.strokeStyle="rgba(0, 0, 0, 0.5)",c.lineWidth=1/F.value.zoom,c.stroke()}if(fe.value&&!tt.value){const _e=q.hexToPixel(fe.value.q,fe.value.r),Ce=q.getHexCorners(_e.x,_e.y);c.beginPath(),c.moveTo(Ce[0].x,Ce[0].y);for(let Pe=1;Pe<6;Pe++)c.lineTo(Ce[Pe].x,Ce[Pe].y);c.closePath(),c.fillStyle="rgba(56, 189, 248, 0.3)",c.fill(),c.strokeStyle="rgba(56, 189, 248, 0.8)",c.lineWidth=2,c.stroke()}const ee=me.value;if(ee.length>0){const Ce=((ge=b.value)==null?void 0:ge.orientation)===qt.POINTY?0:90;Vd(c,ee,{tokenSize:p.value,showFacing:!0,hoveredTokenId:((Ae=he.value)==null?void 0:Ae.characterId)||null,selectedTokenId:((C=we.value)==null?void 0:C.characterId)||null,currentUserId:g.userId,isMaster:ie.value,draggingTokenId:xe.value?(be=Le.value)==null?void 0:be.characterId:null,facingOffset:Ce})}if(xe.value&&Le.value&&N.value){const _e=N.value.pixelToHex(Le.value.pixelX,Le.value.pixelY),Ce=N.value.hexToPixel(_e.q,_e.r);c.beginPath();const Pe=N.value.getHexCorners(Ce.x,Ce.y);c.moveTo(Pe[0].x,Pe[0].y);for(let Ue=1;Ue<Pe.length;Ue++)c.lineTo(Pe[Ue].x,Pe[Ue].y);c.closePath(),c.fillStyle="rgba(250, 204, 21, 0.3)",c.fill(),c.strokeStyle="rgba(250, 204, 21, 0.8)",c.lineWidth=2,c.stroke()}c.restore(),Te.value.showFacingPicker&&Te.value.targetHex&&N.value&&il(c)},ps=()=>{We(),Mt(()=>{ot()})},Dt=w=>{if(!N.value||!Y.value)return null;const c=Y.value.getBoundingClientRect(),q=(w.clientX-c.left-F.value.x)/F.value.zoom,ee=(w.clientY-c.top-F.value.y)/F.value.zoom;return N.value.pixelToHex(q,ee)},Ge=w=>{if(!Y.value)return null;const c=Y.value.getBoundingClientRect(),q=(w.clientX-c.left-F.value.x)/F.value.zoom,ee=(w.clientY-c.top-F.value.y)/F.value.zoom;return{x:q,y:ee}},hs=w=>{if(!N.value||!fe.value)return null;const c=Ge(w);if(!c)return null;const q=N.value,ee=fe.value,ge=q.hexToPixel(ee.q,ee.r),Ae=q.getHexCorners(ge.x,ge.y),C=[{x:ge.x,y:ge.y,type:"center"},...Ae.map((Ce,Pe)=>({x:Ce.x,y:Ce.y,type:`corner${Pe}`}))];let be=1/0,_e=C[0];for(const Ce of C){const Pe=Ce.x-c.x,Ue=Ce.y-c.y,He=Pe*Pe+Ue*Ue;He<be&&(be=He,_e=Ce)}return{x:_e.x,y:_e.y}},Ms=w=>{if(Te.value.showFacingPicker){Pt(w.clientX,w.clientY);return}if(De.value){const be=w.clientX-ht.value.x,_e=w.clientY-ht.value.y;i.panCamera(be,_e),ht.value={x:w.clientX,y:w.clientY},ot();return}if(xe.value&&Le.value){const be=w.target.getBoundingClientRect(),_e=w.clientX-be.left,Ce=w.clientY-be.top,Pe=Yt(_e,Ce,F.value);Le.value.pixelX=Pe.x-qe.value.x,Le.value.pixelY=Pe.y-qe.value.y,et();return}const c=Dt(w);c?(fe.value=c,tt.value&&it.value&&k.value&&Je(c,w),ye.value&&I.value&&M.value!=="select"&&$e(c)):fe.value=null;const q=w.target.getBoundingClientRect(),ee=w.clientX-q.left,ge=w.clientY-q.top,Ae=Yt(ee,ge,F.value),C=ds(Ae.x,Ae.y,me.value,p.value);C!==he.value&&(he.value=C),et()},ns=Q({x:0,y:0,time:0}),As=w=>{var c;if(H.value=!1,L.value=!1,le.value=!1,Te.value.showFacingPicker){Ds(),w.preventDefault();return}if(w.button===1||w.button===0&&w.shiftKey){De.value=!0,ht.value={x:w.clientX,y:w.clientY},w.preventDefault();return}if(w.button===2&&fe.value){const q=Ge(w);if(!q)return;const ee=ds(q.x,q.y,me.value,p.value),ge=r(ee),Ae=ie.value&&ee?!0:ge;if(!ee||ge){Te.value.startPos={x:w.clientX,y:w.clientY},Te.value.targetHex=fe.value,bt(Ae),w.preventDefault();return}}if(w.button===0&&he.value&&ie.value){xe.value=!0,Le.value=he.value,we.value=he.value,l("token-selected",he.value);const q=w.target.getBoundingClientRect(),ee=w.clientX-q.left,ge=w.clientY-q.top,Ae=Yt(ee,ge,F.value);qe.value={x:Ae.x-he.value.pixelX,y:Ae.y-he.value.pixelY},w.preventDefault();return}if(w.button===0&&he.value){if(a.mobileMode&&a.pendingAction&&(a.pendingAction.id==="attack"||a.pendingAction.id==="skill")){l("action-target-selected",he.value);return}((c=we.value)==null?void 0:c.characterId)===he.value.characterId?(we.value=null,l("token-selected",null)):(we.value=he.value,l("token-selected",he.value)),et();return}if(w.button===0&&!he.value){if(a.mobileMode&&a.pendingAction&&a.pendingAction.id==="move"&&fe.value){l("action-target-selected",{type:"hex",hex:ue(fe.value)});return}if(fe.value){const q=Date.now(),ee=ns.value,ge=w.clientX-ee.x,Ae=w.clientY-ee.y;if(Math.hypot(ge,Ae)<20&&q-ee.time<400){Te.value.startPos={x:w.clientX,y:w.clientY},Te.value.targetHex=fe.value,bt(!1),ns.value={x:0,y:0,time:0};return}ns.value={x:w.clientX,y:w.clientY,time:q}}fe.value&&l("hex-selected",ue(fe.value)),we.value&&(we.value=null,l("token-selected",null),et())}if(!h.value&&w.button===0&&fe.value&&I.value)if(M.value==="select"){tt.value=!0,it.value={...fe.value};const q=hs(w);Oe.value=q,Xe.value=[{...fe.value}]}else M.value==="token"?(je.value.clear(),je.value.add(`${fe.value.q},${fe.value.r}`),et()):(ye.value=!0,$e(fe.value))},ae=w=>{if(Te.value.showFacingPicker&&w.button===2){Ds();return}if(xe.value&&Le.value&&N.value&&b.value){const c=N.value.pixelToHex(Le.value.pixelX,Le.value.pixelY),q=Le.value.q,ee=Le.value.r;(q!==c.q||ee!==c.r)&&(i.moveToken(b.value.id,q,ee,c.q,c.r)?v.broadcastMapTokenMove(b.value.id,Le.value.characterId,c.q,c.r):console.warn("Failed to move token - target hex may be occupied")),xe.value=!1,Le.value=null,qe.value={x:0,y:0},et();return}tt.value&&it.value&&fe.value&&ut(),De.value=!1,ye.value=!1,tt.value=!1,it.value=null,Oe.value=null,Xe.value=[],et()},m=()=>{fe.value=null,he.value=null,De.value=!1,ye.value=!1,xe.value&&(xe.value=!1,Le.value=null,qe.value={x:0,y:0}),tt.value&&(tt.value=!1,it.value=null,Oe.value=null,Xe.value=[]),et()},pe=w=>{w.preventDefault();const c=Y.value.getBoundingClientRect(),q=w.clientX-c.left,ee=w.clientY-c.top,ge=F.value.zoom,Ae=w.deltaY>0?.9:1.1,C=Math.max(.25,Math.min(4,ge*Ae)),be=(q-F.value.x)/ge,_e=(ee-F.value.y)/ge;i.$patch({camera:{x:q-be*C,y:ee-_e*C,zoom:C}}),ot()},$e=w=>{if(I.value){if(M.value==="paint")i.setHexTerrain(I.value.id,w.q,w.r,R.value),J(),nt();else if(M.value==="erase"){const c=b.value,q=c==null?void 0:c.layers.find(ee=>ee.type===Vt.TERRAIN);if(q){const ee=Ls(w.q,w.r);q.data.delete(ee),c.updatedAt=Date.now(),J(),nt()}}}},Je=(w,c=null)=>{if(!k.value||!Oe.value)return;const q=oe.value.shape,ee=oe.value.behavior,ge=oe.value.lineWidth,Ae=b.value,C=Ae==null?void 0:Ae.layers.find(Pe=>Pe.type===Vt.TERRAIN),be=C?C.data:new Map,_e=c?hs(c)||Ge(c):null;if(!_e)return;let Ce=[];switch(q){case vt.RECTANGLE:Ce=k.value.calculateRectanglePreviewPixel(Oe.value,_e,be,ee);break;case vt.CIRCLE:Ce=k.value.calculateCirclePreviewPixel(Oe.value,_e,be,ee);break;case vt.HEXAGON:Ce=k.value.calculateHexagonPreviewPixel(Oe.value,_e,be,ee);break;case vt.LINE:Ce=k.value.calculateLinePreviewPixel(Oe.value,_e,ge,be,ee);break}Xe.value=Ce},ut=()=>{if(Xe.value.length===0)return;const w=oe.value.mode,c=new Set(je.value);Xe.value.forEach(q=>{const ee=Ls(q.q,q.r);switch(w){case xt.REPLACE:c.size===je.value.size&&c.clear(),c.add(ee);break;case xt.ADD:c.add(ee);break;case xt.SUBTRACT:c.delete(ee);break}}),w===xt.REPLACE?je.value=new Set(Xe.value.map(q=>Ls(q.q,q.r))):je.value=c},It=()=>{je.value=new Set,et()},gt=()=>{je.value.size===0||!I.value||(je.value.forEach(w=>{const[c,q]=w.split(",").map(Number);i.setHexTerrain(I.value.id,c,q,R.value)}),J(),nt())},Ct=()=>{if(je.value.size===0||!b.value)return;const w=b.value.layers.find(c=>c.type===Vt.TERRAIN);w&&(je.value.forEach(c=>{w.data.delete(c)}),b.value.updatedAt=Date.now(),It(),J(),nt())},Ie=Q({touches:[],lastTap:null,isMultiTouch:!1,isPanning:!1,wasZooming:!1,initialDistance:0,initialZoom:1}),Te=Q({isActive:!1,timer:null,startPos:null,targetHex:null,showFacingPicker:!1,previewFacing:null,originalFacing:0,isDraggingFacing:!1,movedToHex:!1,isRotateInPlace:!1,activeToken:null}),Ot=w=>{const c=b.value;return!c||c.orientation===qt.POINTY?w%2===0:w%2===1},gs=w=>{let q=((w%360+360)%360+90)%360;const ee=b.value,Ae=ee&&ee.orientation===qt.POINTY?0:90;let C=(q-Ae+360)%360;const be=Math.round(C/30)%12,Ce=Ot(be)?_s/2:Nn/2,Pe=be*30;let Ue=Math.abs(C-Pe);if(Ue>180&&(Ue=360-Ue),Ue<=Ce)return be;const He=(be-1+12)%12,Ye=(be+1)%12;if(Ot(He)){const ft=He*30;let st=Math.abs(C-ft);if(st>180&&(st=360-st),st<=_s/2)return He}if(Ot(Ye)){const ft=Ye*30;let st=Math.abs(C-ft);if(st>180&&(st=360-st),st<=_s/2)return Ye}return be},bs=(w,c,q,ee=!1)=>{A(),Te.value.startPos={x:w,y:c},Te.value.targetHex=q,Te.value.isRotateInPlace=ee,Te.value.timer=setTimeout(()=>{bt(ee)},Fv)},A=()=>{Te.value.timer&&(clearTimeout(Te.value.timer),Te.value.timer=null),Te.value.isActive=!1},ze=()=>{A(),Te.value={isActive:!1,timer:null,startPos:null,targetHex:null,showFacingPicker:!1,previewFacing:null,originalFacing:0,isDraggingFacing:!1,movedToHex:!1,isRotateInPlace:!1,activeToken:null},et()},bt=(w=!1)=>{const c=Te.value.targetHex;if(!c)return;Te.value.isActive=!0,Te.value.showFacingPicker=!0,Te.value.isDraggingFacing=!0,Te.value.isRotateInPlace=w;let q;ie.value?w?q=me.value.find(ee=>ee.q===c.q&&ee.r===c.r):q=we.value:q=me.value.find(ee=>{var ge;return((ge=ee.character)==null?void 0:ge.ownerId)===g.userId}),Te.value.originalFacing=(q==null?void 0:q.facing)||0,Te.value.previewFacing=Te.value.originalFacing,Te.value.activeToken=q,w||(l("hex-long-press-move",{hex:ue(c),facing:Te.value.originalFacing}),Te.value.movedToHex=!0),navigator.vibrate&&navigator.vibrate(50),et()},Pt=(w,c)=>{if(!Te.value.showFacingPicker||!Te.value.targetHex||!Y.value)return;const q=Te.value.targetHex,ee=N.value;if(!ee)return;const ge=Y.value.getBoundingClientRect(),Ae=w-ge.left,C=c-ge.top,be=ee.hexToPixel(q.q,q.r),_e=ln(be.x,be.y),Ce=Ae-_e.x,Pe=C-_e.y;if(Math.sqrt(Ce*Ce+Pe*Pe)<Ov){Te.value.previewFacing=Te.value.originalFacing,et();return}let He=Math.atan2(Pe,Ce)*180/Math.PI;He<0&&(He+=360);const Ye=gs(He);Te.value.previewFacing=Ye,et()},Ds=()=>{if(!Te.value.showFacingPicker)return;const w=Te.value.previewFacing,c=w!==null?w:Te.value.originalFacing||0;if(ie.value&&Te.value.isRotateInPlace){const q=Te.value.activeToken;q&&b.value&&i.rotateToken(b.value.id,q.q,q.r,c),ze();return}if(ie.value&&!Te.value.isRotateInPlace){const q=Te.value.activeToken,ee=Te.value.targetHex;q&&b.value&&ee&&i.moveToken(b.value.id,q.q,q.r,ee.q,ee.r)&&i.rotateToken(b.value.id,ee.q,ee.r,c),ze();return}Te.value.isRotateInPlace?l("token-rotate",{facing:c}):l("hex-long-press-confirm",{hex:Te.value.targetHex,facing:c}),ze()},ln=(w,c)=>({x:w*F.value.zoom+F.value.x,y:c*F.value.zoom+F.value.y}),il=w=>{const c=Te.value.targetHex,q=N.value;if(!c||!q)return;const ee=Te.value.activeToken||me.value.find(st=>{var Nt;return((Nt=st.character)==null?void 0:Nt.ownerId)===g.userId}),ge=ee==null?void 0:ee.character,Ae=q.hexToPixel(c.q,c.r),C=ln(Ae.x,Ae.y),be=35,_e=Rv,Ce=Te.value.previewFacing,Pe=b.value,He=Pe&&Pe.orientation===qt.POINTY?0:90,ft=(Ce!==null?Ce:Te.value.originalFacing)*30+He;w.beginPath(),w.arc(C.x,C.y,_e+30,0,Math.PI*2),w.fillStyle="rgba(15, 23, 42, 0.85)",w.fill(),w.beginPath(),w.arc(C.x,C.y,_e,0,Math.PI*2),w.strokeStyle="rgba(148, 163, 184, 0.5)",w.lineWidth=2,w.stroke();for(let st=0;st<12;st++){const ls=st*30+He,Wt=(ls-90)*Math.PI/180,as=Ot(st),Ns=Ce===st,Tl=as?_s:Nn,ys=_e-15;if(Ns){const hn=Tl/2,Il=(ls-90-hn)*Math.PI/180,Pl=(ls-90+hn)*Math.PI/180;w.beginPath(),w.moveTo(C.x,C.y),w.arc(C.x,C.y,_e,Il,Pl),w.closePath(),w.fillStyle="rgba(250, 204, 21, 0.3)",w.fill()}const fn=as?ys+10:ys+4,xs=as?ys-10:ys-4,ks=as?15:6,vn={x:C.x+Math.cos(Wt)*fn,y:C.y+Math.sin(Wt)*fn},mn={x:C.x+Math.cos(Wt-ks*Math.PI/180)*xs,y:C.y+Math.sin(Wt-ks*Math.PI/180)*xs},pn={x:C.x+Math.cos(Wt+ks*Math.PI/180)*xs,y:C.y+Math.sin(Wt+ks*Math.PI/180)*xs};w.beginPath(),w.moveTo(vn.x,vn.y),w.lineTo(mn.x,mn.y),w.lineTo(pn.x,pn.y),w.closePath();const Sl=Ns?1:as?.7:.35;Ns?(w.fillStyle="rgba(250, 204, 21, 0.95)",w.strokeStyle="rgba(0, 0, 0, 0.5)"):(w.fillStyle=`rgba(148, 163, 184, ${Sl})`,w.strokeStyle="rgba(0, 0, 0, 0.3)"),w.fill(),w.lineWidth=1,w.stroke()}ge?Es(w,C.x,C.y,be,ge.portrait,ge.name):(w.beginPath(),w.arc(C.x,C.y,be,0,Math.PI*2),w.fillStyle="rgba(30, 41, 59, 0.9)",w.fill(),w.strokeStyle="rgba(148, 163, 184, 0.5)",w.lineWidth=2,w.stroke(),w.font="16px system-ui, sans-serif",w.textAlign="center",w.textBaseline="middle",w.fillStyle="rgba(148, 163, 184, 0.8)",w.fillText("↻",C.x,C.y)),ee&&(ee.meleeDefence||ee.rangedDefence)&&nn(w,C.x,C.y,be,ee.meleeDefence,ee.rangedDefence,ft,{bothSides:!0})},rl=w=>{w.preventDefault();const c=Array.from(w.touches);if(Ie.value.touches=c,Ie.value.isMultiTouch=c.length>1,c.length===1){const q=c[0];if(Ie.value.lastTap={x:q.clientX,y:q.clientY,time:Date.now()},Ie.value.isPanning=!1,a.mobileMode){const ee=w.target.getBoundingClientRect(),ge=q.clientX-ee.left,Ae=q.clientY-ee.top,C=Yt(ge,Ae,F.value);if(N.value){const be=N.value.pixelToHex(C.x,C.y),_e=ds(C.x,C.y,me.value,p.value);if(be){const Ce=r(_e);(!_e||Ce)&&bs(q.clientX,q.clientY,be,Ce)}}}}else if(c.length===2){A();const q=c[0],ee=c[1],ge=Math.hypot(ee.clientX-q.clientX,ee.clientY-q.clientY);Ie.value.initialDistance=ge,Ie.value.initialZoom=F.value.zoom,Ie.value.isPanning=!1,Ie.value.wasZooming=!0}},cl=w=>{w.preventDefault();const c=Array.from(w.touches);if(Ie.value.touches=c,Te.value.showFacingPicker&&c.length===1){const q=c[0];Pt(q.clientX,q.clientY);return}if(c.length===1&&!Ie.value.isMultiTouch&&!Ie.value.wasZooming){const q=c[0];if(Te.value.timer&&Ie.value.lastTap){const ee=q.clientX-Ie.value.lastTap.x,ge=q.clientY-Ie.value.lastTap.y;Math.hypot(ee,ge)>10&&A()}if(Ie.value.lastTap&&!Ie.value.isPanning){const ee=q.clientX-Ie.value.lastTap.x,ge=q.clientY-Ie.value.lastTap.y;Math.hypot(ee,ge)>10&&(Ie.value.isPanning=!0,A())}if(Ie.value.isPanning&&Ie.value.lastTap){const ee=q.clientX-Ie.value.lastTap.x,ge=q.clientY-Ie.value.lastTap.y;i.$patch({camera:{x:F.value.x+ee,y:F.value.y+ge,zoom:F.value.zoom}}),Ie.value.lastTap={x:q.clientX,y:q.clientY,time:Date.now()},ot()}}else if(c.length===2){A();const q=c[0],ee=c[1],ge=Math.hypot(ee.clientX-q.clientX,ee.clientY-q.clientY);if(Ie.value.initialDistance>0){const Ae=ge/Ie.value.initialDistance,C=Math.max(.25,Math.min(4,Ie.value.initialZoom*Ae)),be=(q.clientX+ee.clientX)/2,_e=(q.clientY+ee.clientY)/2,Ce=Y.value.getBoundingClientRect(),Pe=be-Ce.left,Ue=_e-Ce.top,He=(Pe-F.value.x)/F.value.zoom,Ye=(Ue-F.value.y)/F.value.zoom;i.$patch({camera:{x:Pe-He*C,y:Ue-Ye*C,zoom:C}}),ot()}}if(c.length===1&&!Ie.value.isPanning){const q=c[0],ee=w.target.getBoundingClientRect(),ge=q.clientX-ee.left,Ae=q.clientY-ee.top,C=Yt(ge,Ae,F.value);if(N.value){const _e=N.value.pixelToHex(C.x,C.y);fe.value=_e}const be=ds(C.x,C.y,me.value,p.value);be!==he.value&&(he.value=be),et()}},dl=w=>{w.preventDefault();const c=Array.from(w.touches);if(Ie.value.touches=c,c.length>0){Ie.value.isMultiTouch=c.length>1;return}if(Te.value.showFacingPicker){Ds(),Ie.value.touches=[],Ie.value.lastTap=null,Ie.value.isMultiTouch=!1,Ie.value.isPanning=!1,Ie.value.wasZooming=!1,Ie.value.initialDistance=0,Ie.value.initialZoom=1;return}if(A(),!Ie.value.isPanning&&Ie.value.lastTap&&Date.now()-Ie.value.lastTap.time<300){const ee=w.target.getBoundingClientRect(),ge=Ie.value.lastTap.x-ee.left,Ae=Ie.value.lastTap.y-ee.top,C=Yt(ge,Ae,F.value);let be=null;N.value&&(be=N.value.pixelToHex(C.x,C.y),fe.value=be);const _e=ds(C.x,C.y,me.value,p.value);he.value=_e,ul(_e,be)}Ie.value.touches=[],Ie.value.lastTap=null,Ie.value.isMultiTouch=!1,Ie.value.isPanning=!1,Ie.value.wasZooming=!1,Ie.value.initialDistance=0,Ie.value.initialZoom=1,et()},ul=(w,c)=>{var q;if(w){if(a.mobileMode&&a.pendingAction&&(a.pendingAction.id==="attack"||a.pendingAction.id==="skill")){l("action-target-selected",w);return}((q=we.value)==null?void 0:q.characterId)===w.characterId?(we.value=null,l("token-selected",null)):(we.value=w,l("token-selected",w)),et();return}if(!w){if(a.mobileMode&&a.pendingAction&&a.pendingAction.id==="move"&&c){l("action-target-selected",{type:"hex",hex:ue(c)});return}if(c&&a.mobileMode){const ee=Date.now(),ge=dt.value;if(ge&&ge.q===c.q&&ge.r===c.r&&ee-ge.time<500){l("hex-double-tap",ue(c)),dt.value=null;return}dt.value={q:c.q,r:c.r,time:ee}}c&&l("hex-selected",ue(c)),we.value&&(we.value=null,l("token-selected",null),et())}},an=()=>{const w=i.createMap({name:z.value.name||"Новая карта",orientation:z.value.orientation,scale:z.value.scale,hexSize:z.value.hexSize}),c=5;for(let q=-c;q<=c;q++)for(let ee=-c;ee<=c;ee++)(Math.abs(q)+Math.abs(q+ee)+Math.abs(ee))/2<=c&&i.setHexTerrain(w.id,q,ee,"grass");i.startEditing(w.id),y.value=!1,z.value.name="",Mt(()=>{ct(),ot()})},fl=w=>{i.setActiveMap(w),H.value=!1,Mt(()=>{ct(),ot()})},vl=()=>{I.value?i.stopEditing():b.value&&i.startEditing(b.value.id)},on=w=>{i.selectTerrain(w),M.value!=="select"&&i.setEditorMode("paint"),L.value=!1},ml=()=>{b.value&&i.toggleMapPublished(b.value.id)},pl=()=>{b.value&&confirm(`Удалить карту "${b.value.name}"?`)&&i.deleteMap(b.value.id)},hl=w=>{if(!w||je.value.size===0){alert("Сначала выделите область на карте");return}const c=[...je.value],q=Ud(w,c,d);Qe.value=q,J(),et()},gl=w=>{if(!w||je.value.size===0){alert("Сначала выделите область на карте");return}const c=[...je.value],q=nl(w,c,d);q.forEach((ge,Ae)=>{const[C,be]=Ae.split(",").map(Number);i.setHexTerrain(b.value.id,C,be,ge)});const ee=zd(q,d);console.log("Заливка применена:",ee),Qe.value=null,je.value=new Set,V.value=!1,ot()},bl=()=>{Qe.value=null,J(),et()},yl=(w,c,q)=>{if(!b.value)return!1;const ee=i.placeToken(b.value.id,w,c,q,0);return ee&&(et(),ie.value&&(v.broadcastMap(),v.broadcastTokens())),ee},rn=w=>{let c=null;if(je.value.size>0){const q=je.value.values().next().value,[ee,ge]=q.split(",").map(Number);c={q:ee,r:ge}}else fe.value&&(c=fe.value);return c?yl(w,c.q,c.r):(console.warn("No hex selected for token placement"),!1)},xl=X(()=>{const w=b.value;if(!w)return 0;const c=w.layers.find(q=>q.type===Vt.TERRAIN);return(c==null?void 0:c.data.size)||0}),kl=X(()=>b.value?b.value.orientation===qt.FLAT?"Flat-top ⬡":"Pointy-top ⬢":""),cn={[Ht.BATTLE]:"Бой",[Ht.LOCATION]:"Локация",[Ht.DISTRICT]:"Район",[Ht.CITY]:"Город",[Ht.REGION]:"Регион",[Ht.WORLD]:"Мир"},dn={[vt.RECTANGLE]:"▭",[vt.CIRCLE]:"○",[vt.HEXAGON]:"⬡",[vt.LINE]:"╱"},wl={[vt.RECTANGLE]:"Прямоугольник",[vt.CIRCLE]:"Круг",[vt.HEXAGON]:"Шестиугольник",[vt.LINE]:"Линия"},_l={[xt.REPLACE]:"⬚",[xt.ADD]:"+",[xt.SUBTRACT]:"−"},$l={[xt.REPLACE]:"Заменить",[xt.ADD]:"Добавить",[xt.SUBTRACT]:"Вычесть"},Cl={[jt.AGGRESSIVE]:"Все",[jt.STANDARD]:"Станд.",[jt.PASSIVE]:"Связн."},un={[jt.AGGRESSIVE]:"Все гексы в геометрической области",[jt.STANDARD]:"Все гексы в геометрической области",[jt.PASSIVE]:"Только связные существующие гексы (flood-fill)"};return(w,c)=>{var q,ee,ge,Ae;return s(),n("div",Gu,[!t.mobileMode||f(ie)?(s(),n("header",Ku,[e("div",Qu,[_.value?(s(),n("div",Zu,[e("button",{type:"button",class:"flex items-center gap-2 px-3 py-1.5 rounded-lg bg-slate-800 border border-white/10 hover:bg-slate-700 transition text-sm",onClick:c[0]||(c[0]=Fe(C=>{H.value=!H.value,L.value=!1},["stop"]))},[e("span",Ju,u(((q=f(b))==null?void 0:q.name)||"Выбрать карту"),1),c[28]||(c[28]=e("span",{class:"text-slate-400"},"▼",-1))]),H.value?(s(),n("div",{key:0,class:"absolute top-full left-0 mt-1 w-64 bg-slate-800 border border-white/10 rounded-lg shadow-xl z-50 py-1 max-h-80 overflow-y-auto",onClick:c[2]||(c[2]=Fe(()=>{},["stop"]))},[(s(!0),n(W,null,re(f(Z),C=>{var be,_e;return s(),n("div",{key:C.id,class:te(["px-3 py-2 hover:bg-slate-700 cursor-pointer flex items-center justify-between",C.id===((be=f(b))==null?void 0:be.id)?"bg-sky-500/20":""]),onClick:Ce=>fl(C.id)},[e("div",null,[e("p",tf,u(C.name),1),e("p",sf,u(cn[C.scale]),1)]),(_e=C.visibility)!=null&&_e.published?(s(),n("span",nf,"●")):x("",!0)],10,ef)}),128)),_.value?(s(),n("div",lf,[e("button",{type:"button",class:"w-full px-3 py-2 text-left text-sm text-sky-400 hover:bg-slate-700",onClick:c[1]||(c[1]=C=>{y.value=!0,H.value=!1})}," + Создать карту ")])):x("",!0)])):x("",!0)])):(s(),n("div",af,[f(b)?(s(),n("span",of," 🗺️ "+u(f(b).name),1)):(s(),n("span",rf," ⏳ Ожидание карты... "))])),f(ie)?(s(),n(W,{key:2},[f(b)?(s(),n("span",cf,u(xl.value)+" гексов • "+u(kl.value),1)):x("",!0),h.value&&f(b)?(s(),n("span",df," 👁️ Просмотр ")):x("",!0)],64)):x("",!0)]),f(I)&&_.value?(s(),n("div",uf,[(s(),n(W,null,re(["select","paint","erase","token"],C=>e("button",{key:C,type:"button",class:te(["w-9 h-9 rounded-lg border flex items-center justify-center text-sm transition",f(M)===C?"bg-sky-500/30 border-sky-400/60 text-sky-100":"border-white/10 hover:bg-white/5 text-slate-300"]),title:C==="select"?"Выбор":C==="paint"?"Рисовать":C==="erase"?"Стереть":"Токены",onClick:be=>f(i).setEditorMode(C)},u(C==="select"?"👆":C==="paint"?"🖌️":C==="erase"?"🧹":"👤"),11,ff)),64)),f(M)==="token"?(s(),n(W,{key:0},[c[33]||(c[33]=e("div",{class:"w-px h-6 bg-white/10 mx-1"},null,-1)),e("div",vf,[e("button",{type:"button",class:te(["flex items-center gap-1 px-2 py-1.5 rounded-lg border border-white/10 hover:bg-white/5 transition text-xs",de.value?"bg-sky-500/20 border-sky-400/60":""]),onClick:c[3]||(c[3]=Fe(C=>{de.value=!de.value,L.value=!1,le.value=!1,H.value=!1},["stop"]))},[c[29]||(c[29]=e("span",null,"👤",-1)),e("span",null,"Токены ("+u(D.value.length)+")",1),c[30]||(c[30]=e("span",{class:"text-slate-400"},"▼",-1))],2),de.value?(s(),n("div",{key:0,class:"absolute top-full left-0 mt-1 w-72 bg-slate-800 border border-white/10 rounded-lg shadow-xl z-50 max-h-96 overflow-hidden flex flex-col",onClick:c[5]||(c[5]=Fe(()=>{},["stop"]))},[e("div",mf,[Me(e("input",{"onUpdate:modelValue":c[4]||(c[4]=C=>Se.value=C),type:"text",class:"w-full px-2 py-1.5 rounded bg-slate-900 border border-white/10 text-xs placeholder-slate-500",placeholder:"Поиск по имени..."},null,512),[[Be,Se.value]])]),e("div",pf,[D.value.filter(C=>!C.isNpc).length?(s(),n("div",hf,[c[31]||(c[31]=e("p",{class:"text-xs text-slate-400 mb-1.5 px-1"},"👥 Игроки",-1)),e("div",gf,[(s(!0),n(W,null,re(D.value.filter(C=>!C.isNpc&&(!Se.value||C.name.toLowerCase().includes(Se.value.toLowerCase()))),C=>{var be,_e,Ce,Pe;return s(),n("button",{key:C.id,type:"button",class:te(["flex items-center gap-2 px-2 py-1.5 rounded text-xs border border-white/10 hover:bg-white/10 transition text-left",f(i).findTokenPosition((be=f(b))==null?void 0:be.id,C.id)?"bg-emerald-500/20 border-emerald-400/40":""]),onClick:Ue=>rn(C.id)},[e("span",yf,[C.portrait?(s(),n("img",{key:0,src:f(St)(C.portrait),class:"w-full h-full object-cover"},null,8,xf)):(s(),n("span",kf,u((Ce=(_e=C.name)==null?void 0:_e.charAt(0))==null?void 0:Ce.toUpperCase()),1))]),e("span",wf,u(C.name),1),f(i).findTokenPosition((Pe=f(b))==null?void 0:Pe.id,C.id)?(s(),n("span",_f,"✓")):x("",!0)],10,bf)}),128))])])):x("",!0),D.value.filter(C=>C.isNpc).length?(s(),n("div",$f,[c[32]||(c[32]=e("p",{class:"text-xs text-slate-400 mb-1.5 px-1"},"👹 NPC",-1)),e("div",Cf,[(s(!0),n(W,null,re(D.value.filter(C=>C.isNpc&&(!Se.value||C.name.toLowerCase().includes(Se.value.toLowerCase()))),C=>{var be,_e,Ce,Pe;return s(),n("button",{key:C.id,type:"button",class:te(["flex items-center gap-2 px-2 py-1.5 rounded text-xs border border-amber-500/30 hover:bg-amber-500/10 transition text-left",f(i).findTokenPosition((be=f(b))==null?void 0:be.id,C.id)?"bg-emerald-500/20 border-emerald-400/40":""]),onClick:Ue=>rn(C.id)},[e("span",Sf,[C.portrait?(s(),n("img",{key:0,src:f(St)(C.portrait),class:"w-full h-full object-cover"},null,8,If)):(s(),n("span",Pf,u((Ce=(_e=C.name)==null?void 0:_e.charAt(0))==null?void 0:Ce.toUpperCase()),1))]),e("span",Ef,u(C.name),1),f(i).findTokenPosition((Pe=f(b))==null?void 0:Pe.id,C.id)?(s(),n("span",Mf,"✓")):x("",!0)],10,Tf)}),128))])])):x("",!0),D.value.length?x("",!0):(s(),n("p",Af,"Нет персонажей"))])])):x("",!0)])],64)):x("",!0),f(M)==="select"?(s(),n(W,{key:1},[c[38]||(c[38]=e("div",{class:"w-px h-6 bg-white/10 mx-1"},null,-1)),e("div",Df,[e("button",{type:"button",class:"flex items-center gap-1 px-2 py-1.5 rounded-lg border border-white/10 hover:bg-white/5 transition text-xs",onClick:c[6]||(c[6]=Fe(C=>{le.value=!le.value,L.value=!1,H.value=!1},["stop"]))},[e("span",null,u(dn[f(oe).shape]),1),c[34]||(c[34]=e("span",{class:"text-slate-400"},"▼",-1))]),le.value?(s(),n("div",{key:0,class:"absolute top-full left-0 mt-1 w-56 bg-slate-800 border border-white/10 rounded-lg shadow-xl z-50 p-3",onClick:c[8]||(c[8]=Fe(()=>{},["stop"]))},[e("div",Nf,[c[35]||(c[35]=e("p",{class:"text-xs text-slate-400 mb-1.5"},"Форма",-1)),e("div",Lf,[(s(!0),n(W,null,re(Object.values(f(vt)),C=>(s(),n("button",{key:C,type:"button",class:te(["flex-1 py-1.5 rounded border text-sm transition",f(oe).shape===C?"bg-sky-500/20 border-sky-400/60":"border-white/10 hover:bg-white/5"]),title:wl[C],onClick:be=>f(i).setSelectionShape(C)},u(dn[C]),11,Ff))),128))])]),e("div",Rf,[c[36]||(c[36]=e("p",{class:"text-xs text-slate-400 mb-1.5"},"Режим",-1)),e("div",Of,[(s(!0),n(W,null,re(Object.values(f(xt)),C=>(s(),n("button",{key:C,type:"button",class:te(["flex-1 py-1.5 rounded border text-xs transition",f(oe).mode===C?"bg-sky-500/20 border-sky-400/60":"border-white/10 hover:bg-white/5"]),title:$l[C],onClick:be=>f(i).setSelectionMode(C)},u(_l[C]),11,Hf))),128))])]),e("div",jf,[c[37]||(c[37]=e("p",{class:"text-xs text-slate-400 mb-1.5"},"Поведение",-1)),e("div",zf,[(s(!0),n(W,null,re(Object.values(f(jt)),C=>(s(),n("button",{key:C,type:"button",class:te(["flex-1 py-1 rounded border text-[10px] transition",f(oe).behavior===C?"bg-sky-500/20 border-sky-400/60":"border-white/10 hover:bg-white/5"]),title:un[C],onClick:be=>f(i).setSelectionBehavior(C)},u(Cl[C]),11,Uf))),128))]),e("p",Bf,u(un[f(oe).behavior]),1)]),f(oe).shape===f(vt).LINE?(s(),n("div",Wf,[e("p",qf,"Ширина линии: "+u(f(oe).lineWidth),1),e("input",{type:"range",min:"1",max:"5",value:f(oe).lineWidth,class:"w-full",onInput:c[7]||(c[7]=C=>f(i).setSelectionLineWidth(Number(C.target.value)))},null,40,Vf)])):x("",!0)])):x("",!0)]),je.value.size>0?(s(),n(W,{key:0},[e("span",Xf,u(je.value.size)+" выбрано",1),e("button",{type:"button",class:"px-2 py-1.5 rounded-lg border border-emerald-400/60 bg-emerald-500/20 text-emerald-100 text-xs hover:bg-emerald-500/30 transition",title:"Заполнить выбранным террейном",onClick:gt}," 🎨 Залить "),e("button",{type:"button",class:"px-2 py-1.5 rounded-lg border border-amber-400/60 bg-amber-500/20 text-amber-100 text-xs hover:bg-amber-500/30 transition",title:"Рандомная заливка по профилю",onClick:c[9]||(c[9]=C=>{V.value=!V.value,L.value=!1,le.value=!1})}," 🎲 Рандом "),e("button",{type:"button",class:"px-2 py-1.5 rounded-lg border border-rose-400/60 bg-rose-500/20 text-rose-100 text-xs hover:bg-rose-500/30 transition",title:"Удалить выбранные гексы",onClick:Ct}," 🗑️ "),e("button",{type:"button",class:"px-2 py-1.5 rounded-lg border border-white/10 text-slate-300 text-xs hover:bg-white/5 transition",title:"Снять выделение",onClick:It}," ✕ ")],64)):x("",!0)],64)):x("",!0),c[45]||(c[45]=e("div",{class:"w-px h-6 bg-white/10 mx-1"},null,-1)),e("div",Yf,[e("button",{type:"button",class:"flex items-center gap-2 px-2 py-1.5 rounded-lg border border-white/10 hover:bg-white/5 transition text-sm",onClick:c[10]||(c[10]=Fe(C=>{L.value=!L.value,H.value=!1,le.value=!1},["stop"]))},[e("span",{class:"w-5 h-5 rounded",style:Ne({backgroundColor:G.value.fallbackColor||G.value.color||"#888"})},null,4),e("span",Gf,u(G.value.name||f(R)),1)]),L.value?(s(),n("div",{key:0,class:"absolute top-full left-0 mt-1 w-80 bg-slate-800 border border-white/10 rounded-lg shadow-xl z-50 overflow-hidden",onClick:c[17]||(c[17]=Fe(()=>{},["stop"]))},[e("div",Kf,[e("div",Qf,[Me(e("input",{"onUpdate:modelValue":c[11]||(c[11]=C=>Ve.value=C),type:"text",placeholder:"Поиск террейна...",class:"flex-1 px-2 py-1 text-xs bg-slate-900/50 border border-white/10 rounded focus:outline-none focus:border-sky-400/50"},null,512),[[Be,Ve.value]]),e("button",{type:"button",class:te(["p-1 rounded hover:bg-white/10 transition text-xs",lt.value?"bg-sky-500/20 text-sky-400":"text-slate-400"]),onClick:c[12]||(c[12]=C=>lt.value=!lt.value),title:"Показать фильтры"}," ⚙ ",2)]),lt.value?(s(),n("div",Zf,[e("div",Jf,[c[40]||(c[40]=e("span",{class:"text-xs text-slate-400 w-16"},"Биом:",-1)),Me(e("select",{"onUpdate:modelValue":c[13]||(c[13]=C=>Re.value=C),class:"flex-1 px-2 py-1 text-xs bg-slate-900/50 border border-white/10 rounded focus:outline-none"},[c[39]||(c[39]=e("option",{value:null},"Все биомы",-1)),(s(!0),n(W,null,re(f(d).biomes,C=>(s(),n("option",{key:C.id,value:C.id},u(C.name),9,ev))),128))],512),[[Lt,Re.value]])]),e("div",tv,[c[42]||(c[42]=e("span",{class:"text-xs text-slate-400 w-16"},"Обзор:",-1)),Me(e("select",{"onUpdate:modelValue":c[14]||(c[14]=C=>rt.value=C),class:"flex-1 px-2 py-1 text-xs bg-slate-900/50 border border-white/10 rounded focus:outline-none"},[c[41]||(c[41]=e("option",{value:null},"Любой",-1)),(s(!0),n(W,null,re(f(d).visibilityTypes,C=>(s(),n("option",{key:C.id,value:C.id},u(C.name),9,sv))),128))],512),[[Lt,rt.value]])]),e("div",nv,[c[43]||(c[43]=e("span",{class:"text-xs text-slate-400 w-16"},"Проход:",-1)),Me(e("input",{"onUpdate:modelValue":c[15]||(c[15]=C=>at.value.max=C),type:"range",min:"1",max:"5",step:"1",class:"flex-1"},null,512),[[Be,at.value.max,void 0,{number:!0}]]),e("span",lv,"≤"+u(at.value.max),1)]),e("button",{type:"button",class:"w-full px-2 py-1 text-xs bg-slate-700/50 hover:bg-slate-700 rounded transition",onClick:c[16]||(c[16]=C=>{Re.value=null,rt.value=null,at.value={min:1,max:5},Ve.value=""})}," Сбросить фильтры ")])):x("",!0)]),e("div",av,[$.value.length>0?(s(),n("div",ov,[(s(!0),n(W,null,re($.value,C=>(s(),n("button",{key:C.id,type:"button",class:te(["w-12 h-12 rounded border border-white/10 hover:border-white/30 transition relative group",f(R)===C.id?"ring-2 ring-sky-400":""]),style:Ne({backgroundColor:C.color||C.fallbackColor||"#888"}),title:`${C.name}
Проход: ${C.movementCost??1}
Ближ. бой: ${(C.meleeAdvantage??0)>0?"+":""}${C.meleeAdvantage??0}`,onClick:be=>on(C.id)},[e("div",rv,[C.movementCost>=5?(s(),n("span",cv,"🚫")):C.movementCost>2?(s(),n("span",dv,"⚠")):x("",!0),C.visibility==="blocking"?(s(),n("span",uv,"🔲")):C.visibility==="partial"?(s(),n("span",fv,"🌿")):x("",!0),(C.meleeAdvantage??0)>0?(s(),n("span",vv,"+"+u(C.meleeAdvantage),1)):(C.meleeAdvantage??0)<0?(s(),n("span",mv,u(C.meleeAdvantage),1)):x("",!0)])],14,iv))),128))])):(s(),n("div",pv," Террейны не найдены ")),!Ve.value&&!Re.value&&!rt.value?(s(),n("div",hv,[c[44]||(c[44]=e("div",{class:"text-xs text-slate-500 mb-1"},"Базовые (совместимость):",-1)),e("div",gv,[(s(!0),n(W,null,re(f(os),(C,be)=>(s(),n("button",{key:be,type:"button",class:te(["w-12 h-12 rounded border border-white/10 hover:border-white/30 transition",f(R)===be?"ring-2 ring-sky-400":""]),style:Ne({backgroundColor:C.color}),title:C.name,onClick:_e=>on(be)},null,14,bv))),128))])])):x("",!0)])])):x("",!0)])])):x("",!0),e("div",yv,[f(ie)?(s(),n(W,{key:0},[e("button",{type:"button",class:te(["px-3 py-1.5 rounded-lg border text-xs transition",f(I)?"bg-emerald-500/20 border-emerald-400/60 text-emerald-100":"border-white/10 hover:bg-white/5 text-slate-300"]),onClick:vl},u(f(I)?"✓ Готово":"✏️ Редактировать"),3),f(b)?(s(),n("button",{key:0,type:"button",class:te(["px-3 py-1.5 rounded-lg border text-xs transition",(ee=f(b).visibility)!=null&&ee.published?"bg-emerald-500/20 border-emerald-400/60 text-emerald-100":"border-white/10 hover:bg-white/5 text-slate-300"]),title:(ge=f(b).visibility)!=null&&ge.published?"Карта видна игрокам":"Карта скрыта",onClick:ml},u((Ae=f(b).visibility)!=null&&Ae.published?"👁 Видима":"🙈 Скрыта"),11,xv)):x("",!0)],64)):x("",!0),e("button",{type:"button",class:"w-9 h-9 rounded-lg border border-white/10 hover:bg-white/5 flex items-center justify-center text-sm",title:"Центрировать (0,0)",onClick:c[18]||(c[18]=C=>{ct(),ot()})}," 🎯 ")])])):x("",!0),e("div",kv,[e("div",{ref_key:"canvasContainer",ref:P,class:"flex-1 overflow-hidden relative bg-slate-900/40 z-0"},[e("canvas",{ref_key:"terrainCanvas",ref:B,class:"absolute top-0 left-0",width:ve.value.width,height:ve.value.height},null,8,wv),e("canvas",{ref_key:"gridCanvas",ref:ce,class:"absolute top-0 left-0",width:ve.value.width,height:ve.value.height},null,8,_v),e("canvas",{ref_key:"uiCanvas",ref:Y,class:te(["absolute top-0 left-0",De.value?"cursor-grabbing":f(I)?"cursor-crosshair":"cursor-grab"]),width:ve.value.width,height:ve.value.height,onMousemove:Ms,onMousedown:As,onMouseup:ae,onMouseleave:m,onWheel:pe,onTouchstart:rl,onTouchmove:cl,onTouchend:dl,onContextmenu:c[19]||(c[19]=Fe(()=>{},["prevent"]))},null,42,$v),fe.value&&(!t.mobileMode||f(ie))?(s(),n("div",Cv," q: "+u(fe.value.q)+", r: "+u(fe.value.r),1)):x("",!0),!t.mobileMode||f(ie)?(s(),n("div",Tv,u(Math.round(f(F).zoom*100))+"% ",1)):x("",!0)],512),V.value?(s(),Ke(Yu,{key:0,class:"flex-shrink-0 border-l border-white/10",onClose:c[20]||(c[20]=C=>{V.value=!1,bl()}),onPreview:hl,onApply:gl})):x("",!0)]),!t.mobileMode||f(ie)?(s(),n("footer",Sv,[e("div",Iv,[e("p",Pv,[f(I)?(s(),n(W,{key:0},[ke(" Рисуйте кликом/перетаскиванием • Shift+drag для навигации • Колёсико для зума • 🎯 центр (0,0) ")],64)):(s(),n(W,{key:1},[ke(u(f(ie)?'Нажмите "Редактировать" для изменения карты':"Shift+перетаскивание для навигации"),1)],64))]),e("div",Ev,[f(ie)&&f(b)?(s(),n("button",{key:0,type:"button",class:"px-2 py-1 rounded text-xs text-rose-400 hover:bg-rose-500/10 transition",onClick:pl}," 🗑️ Удалить ")):x("",!0)])])])):x("",!0),y.value?(s(),n("div",{key:2,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/60",onClick:c[27]||(c[27]=Fe(C=>y.value=!1,["self"]))},[e("div",Mv,[c[51]||(c[51]=e("h3",{class:"text-lg font-semibold mb-4"},"Создать карту",-1)),e("div",Av,[e("div",null,[c[46]||(c[46]=e("label",{class:"block text-sm text-slate-400 mb-1"},"Название",-1)),Me(e("input",{"onUpdate:modelValue":c[21]||(c[21]=C=>z.value.name=C),type:"text",class:"w-full px-3 py-2 rounded-lg bg-slate-900 border border-white/10 text-sm",placeholder:"Новая карта"},null,512),[[Be,z.value.name]])]),e("div",null,[c[47]||(c[47]=e("label",{class:"block text-sm text-slate-400 mb-1"},"Ориентация гексов",-1)),e("div",Dv,[e("button",{type:"button",class:te(["flex-1 py-2 rounded-lg border text-sm transition",z.value.orientation==="flat"?"bg-sky-500/20 border-sky-400/60":"border-white/10 hover:bg-white/5"]),onClick:c[22]||(c[22]=C=>z.value.orientation="flat")}," Flat-top ⬡ ",2),e("button",{type:"button",class:te(["flex-1 py-2 rounded-lg border text-sm transition",z.value.orientation==="pointy"?"bg-sky-500/20 border-sky-400/60":"border-white/10 hover:bg-white/5"]),onClick:c[23]||(c[23]=C=>z.value.orientation="pointy")}," Pointy-top ⬢ ",2)])]),e("div",null,[c[48]||(c[48]=e("label",{class:"block text-sm text-slate-400 mb-1"},"Масштаб",-1)),Me(e("select",{"onUpdate:modelValue":c[24]||(c[24]=C=>z.value.scale=C),class:"w-full px-3 py-2 rounded-lg bg-slate-900 border border-white/10 text-sm"},[(s(),n(W,null,re(cn,(C,be)=>e("option",{key:be,value:be},u(C),9,Nv)),64))],512),[[Lt,z.value.scale]])]),e("div",null,[c[49]||(c[49]=e("label",{class:"block text-sm text-slate-400 mb-1"},"Размер гекса (пиксели)",-1)),Me(e("input",{"onUpdate:modelValue":c[25]||(c[25]=C=>z.value.hexSize=C),type:"number",min:"16",max:"64",class:"w-full px-3 py-2 rounded-lg bg-slate-900 border border-white/10 text-sm"},null,512),[[Be,z.value.hexSize,void 0,{number:!0}]])]),c[50]||(c[50]=e("p",{class:"text-xs text-slate-500"}," Карта не имеет фиксированных границ — она расширяется по мере рисования. Центр карты находится в координатах (0, 0). ",-1))]),e("div",Lv,[e("button",{type:"button",class:"px-4 py-2 rounded-lg border border-white/10 hover:bg-white/5 text-sm",onClick:c[26]||(c[26]=C=>y.value=!1)}," Отмена "),e("button",{type:"button",class:"px-4 py-2 rounded-lg bg-sky-500 hover:bg-sky-600 text-sm font-medium",onClick:an}," Создать ")])])])):x("",!0)])}}},jv=()=>window.innerWidth<768,M2=()=>{let t=document.querySelector('meta[name="viewport"]');t||(t=document.createElement("meta"),t.name="viewport",document.head.appendChild(t)),t.content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"},zv={key:0,class:"collapsed-preview"},Uv={class:"collapsed-avatar"},Bv=["src","alt"],Wv={key:1,class:"avatar-fallback"},qv={class:"collapsed-info"},Vv={class:"collapsed-name"},Xv={key:0,class:"collapsed-hint"},Yv={key:1,class:"expanded-content"},Gv={class:"card-header"},Kv={class:"character-name"},Qv={key:0,class:"other-token-badge"},Zv={class:"card-body"},Jv={class:"portrait-section"},em={class:"info-section"},tm={key:0,class:"wounds-display"},sm={class:"wounds-row"},nm={class:"wound-slots"},lm={class:"wounds-row"},am={class:"wound-slots"},om={class:"wounds-row"},im={class:"wound-slots"},rm={class:"wounds-row"},cm={class:"wound-slots"},dm={key:1,class:"other-info"},um={class:"info-row"},fm={class:"info-row"},vm={key:2,class:"terrain-info"},mm={class:"info-row"},pm={key:0,class:"info-row"},hm={key:1,class:"terrain-stats"},gm={key:2,class:"info-row distance-row"},js=140,bm={__name:"MobileInfoCard",props:{selectedToken:{type:Object,default:null},selectedHex:{type:Object,default:null},playerCharacter:{type:Object,default:null},playerFacing:{type:Number,default:0},collapsed:{type:Boolean,default:!1},isPlayerTurn:{type:Boolean,default:!1},playerTokenPosition:{type:Object,default:null},alwaysShowPlayer:{type:Boolean,default:!1},isMaster:{type:Boolean,default:!1}},emits:["toggle-collapse","open-character-sheet","switch-equipment","move-to-hex"],setup(t,{emit:o}){const a=ss(),l=t,i=o,d=Q(null),v=(y,L,le,V)=>(Math.abs(y-le)+Math.abs(y+L-le-V)+Math.abs(L-V))/2,E=X(()=>!l.selectedHex||!l.playerTokenPosition?null:v(l.playerTokenPosition.q,l.playerTokenPosition.r,l.selectedHex.q,l.selectedHex.r)),g=X(()=>{var y;return(y=l.selectedHex)!=null&&y.terrain?l.selectedHex.terrain.movementCost??1:1}),b=X(()=>{const y=g.value;return y>=5?"stat-blocked":y>=3?"stat-hard":y>=2?"stat-medium":"stat-easy"}),I=X(()=>{var y;return(y=l.selectedHex)!=null&&y.terrain?l.selectedHex.terrain.meleeAdvantage??0:0}),M=X(()=>{const y=I.value;return y>0?`+${y}`:y<0?`${y}`:"0"}),R=X(()=>{const y=I.value;return y>0?"stat-bonus":y<0?"stat-penalty":"stat-neutral"}),T=X(()=>{var y;return(y=l.selectedHex)!=null&&y.terrain?l.selectedHex.terrain.visibility??"open":"open"}),F=X(()=>({open:"Откр.",partial:"Част.",blocking:"Блок."})[T.value]||T.value),Z=X(()=>({open:"mdi:eye-outline",partial:"mdi:eye-off-outline",blocking:"mdi:eye-off"})[T.value]||"mdi:eye-outline"),j=X(()=>({open:"stat-neutral",partial:"stat-medium",blocking:"stat-hard"})[T.value]||"stat-neutral");X(()=>!(!l.selectedHex||l.selectedToken||!l.isPlayerTurn||!l.playerTokenPosition||l.selectedHex.q===l.playerTokenPosition.q&&l.selectedHex.r===l.playerTokenPosition.r||g.value>=5));const oe=X(()=>l.isMaster||l.alwaysShowPlayer?!0:l.selectedHex&&!l.selectedToken?!1:l.selectedToken?l.playerCharacter?l.selectedToken.characterId===l.playerCharacter.id:!1:!0),ie=X(()=>l.alwaysShowPlayer?!1:l.selectedHex&&!l.selectedToken),ne=X(()=>{var y;return(y=l.selectedToken)!=null&&y.character?l.selectedToken.character:l.playerCharacter}),O=X(()=>{var y,L;return((L=(y=ne.value)==null?void 0:y.combat)==null?void 0:L.wounds)||{scratch:0,light:0,heavy:0,deadly:0}}),S=X(()=>{var le;if(!ne.value)return null;const y=ne.value.stats||{},L=((le=ne.value.combat)==null?void 0:le.bonusDeadlySlots)||0;return ts(y,L)}),D=X(()=>{var y;return(y=S.value)!=null&&y.scratch?S.value.scratch.base+S.value.scratch.bonus:0}),r=X(()=>{var y;return(y=S.value)!=null&&y.light?S.value.light.base+S.value.light.bonus:0}),h=X(()=>{var y;return(y=S.value)!=null&&y.heavy?S.value.heavy.base+S.value.heavy.bonus:0}),_=X(()=>{var y;return(y=S.value)!=null&&y.deadly?S.value.deadly.base+S.value.deadly.bonus:0}),P=y=>{if(y==null)return null;const L=Object.entries($t).map(([V,de])=>({value:parseInt(V),...de})).filter(V=>V.value>=0).sort((V,de)=>V.value-de.value);let le=L[0];for(const V of L)if(V.value<=y)le=V;else break;return le},B=(y,L,le,V)=>{const de=(V-90)*Math.PI/180;return{x:y+le*Math.cos(de),y:L+le*Math.sin(de)}},ce=(y,L,le,V,de,Se,fe=0,he="left")=>{if(!Se)return;const we=Se.color||"#FFFFFF",De=Se.linetype||"single";let ye;he==="left"?ye={top:0,upper:300,lower:240,bottom:180}:ye={top:0,upper:60,lower:120,bottom:180};const xe=B(L,le,V,ye.top+fe),Le=B(L,le,V,ye.upper+fe),qe=B(L,le,V,ye.lower+fe),Qe=B(L,le,V,ye.bottom+fe);let Ve,Re;if(de==="front")Ve=xe,Re=Le;else if(de==="flank")Ve=Le,Re=qe;else if(de==="back")Ve=qe,Re=Qe;else return;if(y.lineCap="butt",y.strokeStyle=we,De==="dashed")y.setLineDash([4,5]),y.lineWidth=2,y.beginPath(),y.moveTo(Ve.x,Ve.y),y.lineTo(Re.x,Re.y),y.stroke(),y.setLineDash([]);else if(De==="double"){y.lineWidth=2,y.beginPath(),y.moveTo(Ve.x,Ve.y),y.lineTo(Re.x,Re.y),y.stroke();const rt=V+3,at=B(L,le,rt,(de==="front"?ye.top:de==="flank"?ye.upper:ye.lower)+fe),lt=B(L,le,rt,(de==="front"?ye.upper:de==="flank"?ye.lower:ye.bottom)+fe);y.setLineDash([4,5]),y.lineWidth=2,y.beginPath(),y.moveTo(at.x,at.y),y.lineTo(lt.x,lt.y),y.stroke(),y.setLineDash([])}else y.lineWidth=2,y.beginPath(),y.moveTo(Ve.x,Ve.y),y.lineTo(Re.x,Re.y),y.stroke()},Y=(y,L,le,V,de,Se,fe=0,he="left")=>{if(!Se)return;const we=Se.color||"#FFFFFF",De=Se.linetype||"single";let ye,xe;if(he==="left")if(de==="front")ye=300,xe=360;else if(de==="flank")ye=240,xe=300;else if(de==="back")ye=180,xe=240;else return;else if(de==="front")ye=0,xe=60;else if(de==="flank")ye=60,xe=120;else if(de==="back")ye=120,xe=180;else return;ye+=fe,xe+=fe;const Le=(ye-90)*Math.PI/180,qe=(xe-90)*Math.PI/180;if(y.lineCap="butt",y.strokeStyle=we,De==="dashed")y.setLineDash([4,5]),y.lineWidth=2,y.beginPath(),y.arc(L,le,V,Le,qe),y.stroke(),y.setLineDash([]);else if(De==="double"){y.lineWidth=2,y.beginPath(),y.arc(L,le,V,Le,qe),y.stroke();const Qe=V+3;y.setLineDash([4,5]),y.lineWidth=2,y.beginPath(),y.arc(L,le,Qe,Le,qe),y.stroke(),y.setLineDash([])}else y.lineWidth=2,y.beginPath(),y.arc(L,le,V,Le,qe),y.stroke()},ve=async()=>{var tt,it;const y=d.value;if(!y)return;const L=y.getContext("2d"),le=js,V=le/2,de=le/2,Se=le/2-30;L.clearRect(0,0,le,le);const fe=ne.value;if(!fe){L.fillStyle="#1e293b",L.beginPath(),L.arc(V,de,Se,0,Math.PI*2),L.fill(),L.strokeStyle="rgba(255, 255, 255, 0.3)",L.lineWidth=2,L.stroke(),L.fillStyle="#64748b",L.font=`bold ${Se}px sans-serif`,L.textAlign="center",L.textBaseline="middle",L.fillText("?",V,de);return}const he=St(fe.portrait);he&&await ll(he);const we=O.value,De=S.value;if(Es(L,V,de,Se,fe.portrait,fe.name,we,De),we&&De&&(tn(L,V,de,Se,we,De),sn(L,V,de,Se,we,De)),!oe.value)return;let ye=(tt=l.selectedToken)==null?void 0:tt.meleeDefence,xe=(it=l.selectedToken)==null?void 0:it.rangedDefence;if(!ye&&fe&&(ye=es(fe,"melee")),!xe&&fe&&(xe=es(fe,"ranged")),!ye&&!xe)return;const Le=a.maps.find(Oe=>Oe.id===a.activeMapId),Qe=(Le==null?void 0:Le.orientation)==="pointy"?0:90,Ve=(l.playerFacing||0)*30+Qe,Re=Se+14,rt=Re+6,at=["front","flank","back"],lt=["left","right"];if(ye)for(const Oe of lt)for(const Xe of at){const je=ye[Xe];if(je!=null){const dt=P(je);ce(L,V,de,Re,Xe,dt,Ve,Oe)}}if(xe)for(const Oe of lt)for(const Xe of at){const je=xe[Xe];if(je!=null){const dt=P(je);Y(L,V,de,rt,Xe,dt,Ve,Oe)}}},H=()=>{l.collapsed&&i("toggle-collapse")};return Qt(()=>[l.selectedToken,l.playerCharacter,l.playerFacing,l.collapsed],async()=>{await Mt(),l.collapsed||ve()},{immediate:!0,deep:!0}),Ut(async()=>{await Mt(),l.collapsed||ve()}),(y,L)=>{var le,V,de,Se,fe,he;return s(),n("div",{class:te(["mobile-info-card",{collapsed:t.collapsed,"own-token":oe.value}]),onClick:H},[t.collapsed?(s(),n("div",zv,[e("div",Uv,[(le=ne.value)!=null&&le.portrait?(s(),n("img",{key:0,src:f(St)(ne.value.portrait),alt:ne.value.name},null,8,Bv)):(s(),n("div",Wv,u(((Se=(de=(V=ne.value)==null?void 0:V.name)==null?void 0:de.charAt(0))==null?void 0:Se.toUpperCase())||"?"),1))]),e("div",qv,[e("span",Vv,u(((fe=ne.value)==null?void 0:fe.name)||"Неизвестно"),1),oe.value?x("",!0):(s(),n("span",Xv,"нажмите для подробностей"))]),U(f(K),{icon:"mdi:chevron-up",class:"collapse-icon"})])):(s(),n("div",Yv,[e("div",Gv,[e("button",{class:"collapse-btn",onClick:L[0]||(L[0]=Fe(we=>y.$emit("toggle-collapse"),["stop"]))},[U(f(K),{icon:"mdi:chevron-down",class:"w-5 h-5"})]),e("span",Kv,u(((he=ne.value)==null?void 0:he.name)||"Неизвестно"),1),!oe.value&&t.selectedToken?(s(),n("span",Qv,"Чужой")):x("",!0),oe.value?(s(),n("button",{key:1,class:"header-action-btn",onClick:L[1]||(L[1]=Fe(we=>{var De;return y.$emit("open-character-sheet",(De=ne.value)==null?void 0:De.id)},["stop"]))},[U(f(K),{icon:"mdi:file-document-outline",class:"w-4 h-4"})])):x("",!0)]),e("div",Zv,[e("div",Jv,[e("canvas",{ref_key:"defenceCanvas",ref:d,width:js,height:js,class:"defence-canvas"},null,512)]),e("div",em,[oe.value&&ne.value?(s(),n("div",tm,[e("div",sm,[L[2]||(L[2]=e("span",{class:"wound-label"},"Царапины:",-1)),e("div",nm,[(s(!0),n(W,null,re(D.value,we=>(s(),n("div",{key:"scratch-"+we,class:te(["wound-slot scratch",{filled:we<=O.value.scratch}])},null,2))),128))])]),e("div",lm,[L[3]||(L[3]=e("span",{class:"wound-label"},"Лёгкие:",-1)),e("div",am,[(s(!0),n(W,null,re(r.value,we=>(s(),n("div",{key:"light-"+we,class:te(["wound-slot light",{filled:we<=O.value.light}])},null,2))),128))])]),e("div",om,[L[4]||(L[4]=e("span",{class:"wound-label"},"Тяжёлые:",-1)),e("div",im,[(s(!0),n(W,null,re(h.value,we=>(s(),n("div",{key:"heavy-"+we,class:te(["wound-slot heavy",{filled:we<=O.value.heavy}])},null,2))),128))])]),e("div",rm,[L[5]||(L[5]=e("span",{class:"wound-label"},"Смерт.:",-1)),e("div",cm,[(s(!0),n(W,null,re(_.value,we=>(s(),n("div",{key:"deadly-"+we,class:te(["wound-slot deadly",{filled:we<=O.value.deadly}])},null,2))),128))])])])):!oe.value&&!ie.value&&ne.value?(s(),n("div",dm,[e("div",um,[U(f(K),{icon:"mdi:account",class:"w-4 h-4 text-slate-400"}),e("span",null,u(ne.value.race||"Неизвестная раса"),1)]),e("div",fm,[U(f(K),{icon:"mdi:sword",class:"w-4 h-4 text-slate-400"}),e("span",null,u(ne.value.class||"Неизвестный класс"),1)])])):ie.value?(s(),n("div",vm,[e("div",mm,[U(f(K),{icon:"mdi:map-marker",class:"w-4 h-4 text-slate-400"}),e("span",null,"Гекс "+u(t.selectedHex.q)+", "+u(t.selectedHex.r),1)]),t.selectedHex.terrain?(s(),n("div",pm,[U(f(K),{icon:"mdi:terrain",class:"w-4 h-4 text-slate-400"}),e("span",null,u(t.selectedHex.terrain.name||"Неизвестная местность"),1)])):x("",!0),t.selectedHex.terrain?(s(),n("div",hm,[e("div",{class:te(["stat-item",b.value])},[U(f(K),{icon:"mdi:walk",class:"w-3.5 h-3.5"}),e("span",null,u(g.value),1)],2),e("div",{class:te(["stat-item",R.value])},[U(f(K),{icon:"mdi:sword-cross",class:"w-3.5 h-3.5"}),e("span",null,u(M.value),1)],2),e("div",{class:te(["stat-item",j.value])},[U(f(K),{icon:Z.value,class:"w-3.5 h-3.5"},null,8,["icon"]),e("span",null,u(F.value),1)],2)])):x("",!0),E.value!==null?(s(),n("div",gm,[U(f(K),{icon:"mdi:map-marker-distance",class:"w-4 h-4 text-sky-400"}),e("span",null,u(E.value)+" гекс"+u(E.value===1?"":E.value<5?"а":"ов"),1)])):x("",!0)])):x("",!0)])])]))],2)}}},Ln=wt(bm,[["__scopeId","data-v-eec13acd"]]),ym={key:0,class:"perspective-indicator"},xm={key:1,class:"perspective-bar"},km={class:"perspective-options"},wm=["onClick"],_m={class:"perspective-avatar-wrapper"},$m={key:2,class:"offline-dot",title:"Оффлайн"},Cm=["title"],Tm={key:0,class:"master-tools-panel"},Sm={class:"tools-header"},Im={class:"events-count"},Pm={class:"tools-actions"},Em={class:"confirm-dialog"},Mm={class:"confirm-icon"},Am={class:"confirm-text"},Dm={class:"confirm-actions"},Nm={key:2,class:"scene-image-inline"},Lm=["src","alt"],Fm={class:"scene-image-info"},Rm={class:"scene-image-desc"},Om={key:0,class:"load-more-container"},Hm={key:1,class:"empty-log"},jm={key:0,class:"battle-desc"},zm={key:0,class:"delivery-grid"},Um=["onClick"],Bm=["src"],Wm={key:2,class:"face-placeholder"},qm={class:"face-tooltip"},Vm={class:"tooltip-char"},Xm={class:"tooltip-player"},Ym={key:0,class:"tooltip-offline"},Gm={class:"tooltip-status"},Km=["onClick"],Qm={class:"fullwidth-desc"},Zm={key:0,class:"delivery-grid"},Jm=["onClick"],ep=["src"],tp={key:2,class:"face-placeholder"},sp={key:0,class:"invite-used"},np={key:1,class:"invite-portrait-placeholder"},lp={class:"invite-used-name"},ap=["onClick"],op={key:2,class:"invite-not-for-you"},ip={key:1,class:"invite-master-view"},rp={class:"invite-header"},cp={key:0,class:"invite-usages"},dp={key:1,class:"usage-portrait-placeholder"},up={class:"usage-name"},fp={key:0,class:"delivery-grid"},vp=["title"],mp=["src"],pp={key:2,class:"face-placeholder"},hp={key:3,class:"event-row"},gp={class:"event-content"},bp={key:0,class:"event-system"},yp={key:1,class:"event-text-message"},xp={class:"text-content"},kp={class:"text-time"},wp=["onClick"],_p={class:"check-main"},$p={class:"check-icon-wrapper"},Cp={key:0,class:"check-character"},Tp=["src","alt"],Sp={key:1,class:"character-initial"},Ip={class:"check-difficulty"},Pp={key:1,class:"check-result"},Ep={key:0,class:"result-label auto-success"},Mp={key:1,class:"result-label auto-fail"},Ap={key:0,class:"check-details"},Dp={class:"check-roll"},Np={key:0,class:"check-modifier"},Lp={class:"check-total"},Fp={class:"check-target"},Rp={key:1,class:"check-desc"},Op={key:3,class:"event-important-message"},Hp={class:"important-body"},jp={class:"important-content"},zp={class:"important-time"},Up=["onClick"],Bp={class:"quest-header"},Wp={class:"quest-title"},qp={key:0,class:"quest-details"},Vp={key:0,class:"quest-desc"},Xp={key:1,class:"quest-objectives"},Yp={key:5,class:"event-item-give"},Gp={class:"item-content"},Kp={class:"item-list"},Qp={key:6,class:"event-item-loot"},Zp={class:"loot-header"},Jp={key:0,class:"loot-desc"},e0={class:"loot-items"},t0={class:"loot-item-name"},s0={key:0,class:"loot-claimed-by"},n0={key:1,class:"loot-claim-btn"},l0={key:7,class:"event-default"},a0={key:0,class:"delivery-grid"},o0=["onClick"],i0=["src"],r0={key:2,class:"face-placeholder"},c0={class:"face-tooltip"},d0={class:"tooltip-char"},u0={class:"tooltip-player"},f0={key:0,class:"tooltip-offline"},v0={class:"tooltip-status"},m0={__name:"SceneLog",emits:["go-to-battle","create-character","skill-check-clicked","view-image","hide-image"],setup(t,{emit:o}){const a=o,l=Ys(),i=Rt(),d=ms(),v=Bt(),{filteredEvents:E,paginatedEvents:g,hasMoreEvents:b,remainingEventsCount:I,totalEventsCount:M,currentImage:R,hasActiveImage:T,activeFilter:F,perspectiveUserId:Z}=pt(l),{role:j,connections:oe}=pt(i),ie=z=>!de.value||!Z.value?!1:z.hiddenFrom&&z.hiddenFrom.includes(Z.value),ne=Q(null),O=Q(!0),S=Q(!0),D=Q(!1),r=Q(!1),h=Q(new Set),_=()=>{l.downloadLog("trip-session-log"),D.value=!1},P=()=>{r.value=!0,D.value=!1},B=()=>{l.clearAllEvents(),r.value=!1},ce=()=>{r.value=!1},Y=()=>{l.downloadLog("trip-session-log"),l.clearAllEvents(),r.value=!1},ve=z=>{h.value.has(z)?h.value.delete(z):h.value.add(z)},H=z=>{const N=kt.aspects.find(me=>me.id===z);return(N==null?void 0:N.checkIcon)||"mdi:dice-d20"},y=z=>{const N=kt.aspects.find(me=>me.id===z);return(N==null?void 0:N.color)||"#f59e0b"},L=z=>{const N=$t[String(z)];return N?`${N.name} (${z})`:String(z)},le=z=>$t[String(z)]||{name:String(z),color:"#f59e0b"};Ut(()=>{ne.value&&setTimeout(()=>{ne.value.scrollTop=ne.value.scrollHeight},100)}),Qt(g,(z,N)=>{var p,k;const me=z.length>0&&N.length>0&&((p=z[z.length-1])==null?void 0:p.id)!==((k=N[N.length-1])==null?void 0:k.id);O.value&&ne.value&&me&&setTimeout(()=>{ne.value.scrollTop=ne.value.scrollHeight},50)},{deep:!0});const V=()=>{if(!ne.value)return;const{scrollTop:z,scrollHeight:N,clientHeight:me}=ne.value;O.value=N-z-me<50},de=X(()=>j.value==="master"),Se=X(()=>{if(!de.value)return[];const z=[{id:null,name:"Все",avatar:null,online:!0}];return(i.allPlayers||[]).forEach(me=>{z.push({id:me.userId,name:me.characterName||me.alias||"Игрок",avatar:me.characterPortrait||me.avatar,online:me.online})}),z}),fe=z=>{l.setPerspective(z)},he=z=>new Date(z).toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"}),we=z=>{var me,p;if(!z)return{name:"Система",avatar:null,isMe:!1,isSystem:!0};if(z===d.userId)return{name:d.nickname||"Вы",avatar:d.avatar,isMe:!0};const N=(me=i.connections)==null?void 0:me.find(k=>k.userId===z);return N?{name:N.alias||"Игрок",avatar:N.avatar,isMe:!1}:((p=i.masterProfile)==null?void 0:p.userId)===z?{name:i.masterProfile.nickname||"Мастер",avatar:i.masterProfile.avatar,isMe:!1,isMaster:!0}:i.role==="master"?{name:d.nickname||"Мастер",avatar:d.avatar,isMe:!0,isMaster:!0}:{name:"Неизвестный",avatar:null,isMe:!1}},De=()=>{const z=v.getCharactersByUserId(d.userId);return z.length>0?z[0]:null},ye=z=>{if(!z)return null;const N=v.getCharactersByUserId(z);return N.length>0?N[0]:null},xe=z=>{if(z.characterPortrait)return St(z.characterPortrait);const N=ye(z.completedBy);return N!=null&&N.portrait?St(N.portrait):null},Le=z=>{const N=kt.aspects.find(me=>me.id===z);return N?N.id:null},qe=z=>{if(z.completed)return;const N=De();if(!N){console.warn("Нет персонажа для броска");return}const me=Math.floor(Math.random()*12)+1,p=Le(z.checkType),k=p?Js(N,p):0,$=me+k,se=$>=z.difficulty,G={roll:me,modifier:k,total:$,success:se,resultType:"normal",difficulty:z.difficulty};l.updateEvent(z.id,{completed:!0,result:G,completedBy:d.userId,completedAt:Date.now(),characterName:N.name,characterPortrait:N.portrait||null}),i.sendToMaster({type:"skill-check-result",eventId:z.id,result:G,characterName:N.name,characterPortrait:N.portrait||null}),a("skill-check-clicked",{...z,result:G})},Qe=()=>{a("go-to-battle")},Ve=z=>{a("create-character",{constraints:z.constraints||{},inviteId:z.id})},Re=z=>({[Ee.TEXT]:"mdi:message-text",[Ee.SYSTEM]:"mdi:information",[Ee.SKILL_CHECK]:"mdi:dice-d20",[Ee.SKILL_RESULT]:"mdi:check-circle",[Ee.BATTLE_INVITE]:"mdi:sword-cross",[Ee.ATTACK_RESULT]:"mdi:sword",[Ee.DAMAGE]:"mdi:heart-broken",[Ee.IMAGE]:"mdi:image",[Ee.IMPORTANT]:"mdi:alert-circle",[Ee.QUEST]:"mdi:map-marker-star",[Ee.ITEM_GIVE]:"mdi:gift",[Ee.ITEM_TAKE]:"mdi:hand-back-left",[Ee.ITEM_LOOT]:"mdi:treasure-chest",[Ee.CHARACTER_INVITE]:"mdi:account-plus"})[z]||"mdi:circle",rt=z=>({[Ee.TEXT]:"#94a3b8",[Ee.SYSTEM]:"#64748b",[Ee.SKILL_CHECK]:"#f59e0b",[Ee.SKILL_RESULT]:"#10b981",[Ee.BATTLE_INVITE]:"#ef4444",[Ee.ATTACK_RESULT]:"#ef4444",[Ee.DAMAGE]:"#dc2626",[Ee.IMAGE]:"#8b5cf6",[Ee.IMPORTANT]:"#f59e0b",[Ee.QUEST]:"#eab308",[Ee.ITEM_GIVE]:"#22c55e",[Ee.ITEM_TAKE]:"#f97316",[Ee.ITEM_LOOT]:"#a855f7",[Ee.CHARACTER_INVITE]:"#3b82f6"})[z]||"#94a3b8",at=z=>{var N;return z.type===Ee.SKILL_CHECK&&!z.completed?z.targetUserIds===null?!0:Array.isArray(z.targetUserIds)?z.targetUserIds.includes(d.userId):z.targetUserId==="all"||z.targetUserId===d.userId:z.type===Ee.BATTLE_INVITE?z.targetUserIds===null?!0:Array.isArray(z.targetUserIds)?z.targetUserIds.includes(d.userId):!1:z.type===Ee.CHARACTER_INVITE?((N=z.usedBy)==null?void 0:N.some(p=>p.userId===d.userId))?!1:z.targetUserIds===null?!0:Array.isArray(z.targetUserIds)?z.targetUserIds.includes(d.userId):z.targetUserId==="all"||z.targetUserId===d.userId:z.type===Ee.ITEM_GIVE&&!z.accepted?z.targetUserId===d.userId:z.type===Ee.ITEM_LOOT?z.items.some(me=>!me.claimedBy):!1},lt=z=>{var N;return(N=z.usedBy)==null?void 0:N.some(me=>me.userId===d.userId)},tt=z=>{var me;return((me=z.usedBy)==null?void 0:me.find(p=>p.userId===d.userId))||null},it=z=>de.value?(i.allPlayers||[]).map(me=>{var $,se;if(!(z.targetUserIds===null||Array.isArray(z.targetUserIds)&&z.targetUserIds.includes(me.userId)))return null;const k=($=z.usedBy)==null?void 0:$.find(G=>G.userId===me.userId);return{userId:me.userId,alias:me.alias,avatar:me.avatar,online:me.online,delivered:((se=z.deliveredTo)==null?void 0:se.includes(me.userId))||!1,used:!!k,createdCharacter:k?{id:k.characterId,name:k.characterName,portrait:k.characterPortrait}:null}}).filter(Boolean):[],Oe=z=>de.value?(v.allPlayerCharacters||[]).map(me=>{var Ze,We,ct,ot;const p=!z.targetCharacterIds||z.targetCharacterIds===null||z.targetCharacterIds.includes(me.id),k=(Ze=i.connections)==null?void 0:Ze.find(J=>J.userId===me.ownerId),$=((We=k==null?void 0:k.conn)==null?void 0:We.open)||!1,se=((ct=z.deliveredTo)==null?void 0:ct.includes(me.ownerId))||!1,G=((ot=z.hiddenFrom)==null?void 0:ot.includes(me.ownerId))||!1,ue=me.portrait?St(me.portrait):null;return{characterId:me.id,characterName:me.name,characterPortrait:ue,ownerId:me.ownerId,ownerName:me.ownerNickname||(k==null?void 0:k.alias)||"Игрок",online:$,targeted:p,delivered:se,hidden:G}}).filter(me=>me.targeted):[],Xe=(z,N,me)=>{de.value&&(N.hidden?dt(z,N.ownerId,!0):N.delivered?dt(z,N.ownerId,!1):me?ht(z,N.ownerId):je(z,N.ownerId))},je=(z,N)=>{if(!de.value)return;const me=z.hiddenFrom||[];me.includes(N)||l.updateEvent(z.id,{hiddenFrom:[...me,N]})},dt=(z,N,me)=>{var se,G;if(!de.value)return;const p=z.hiddenFrom||[],k=z.deliveredTo||[],$=i.connections.find(ue=>ue.userId===N);if(me){const ue=p.filter(We=>We!==N),Ze=k.includes(N)?k:[...k,N];l.updateEvent(z.id,{hiddenFrom:ue,deliveredTo:Ze}),(se=$==null?void 0:$.conn)!=null&&se.open&&$.conn.send({type:"scene-event",event:{...z,hiddenFrom:ue,deliveredTo:Ze}})}else p.includes(N)||l.updateEvent(z.id,{hiddenFrom:[...p,N]}),(G=$==null?void 0:$.conn)!=null&&G.open&&$.conn.send({type:"scene-event-hide",eventId:z.id})},ht=(z,N)=>{var p;if(!de.value)return;const me=i.connections.find(k=>k.userId===N);if((p=me==null?void 0:me.conn)!=null&&p.open){me.conn.send({type:"scene-event",event:z});const k=z.deliveredTo||[];k.includes(N)||l.updateEvent(z.id,{deliveredTo:[...k,N]})}};return(z,N)=>{var me;return s(),n("div",{class:te(["scene-log",{"perspective-mode":de.value&&f(Z)}])},[de.value&&f(Z)?(s(),n("div",ym,[U(f(K),{icon:"mdi:eye"}),e("span",null,[N[5]||(N[5]=ke("Просмотр от: ",-1)),e("strong",null,u((me=Se.value.find(p=>p.id===f(Z)))==null?void 0:me.name),1)]),e("button",{class:"exit-perspective-btn",onClick:N[0]||(N[0]=p=>fe(null))},[U(f(K),{icon:"mdi:close"}),N[6]||(N[6]=ke(" Выйти ",-1))])])):x("",!0),de.value&&Se.value.length>1?(s(),n("div",xm,[N[7]||(N[7]=e("span",{class:"perspective-label"},"Глазами:",-1)),e("div",km,[(s(!0),n(W,null,re(Se.value,p=>(s(),n("button",{key:p.id||"all",class:te(["perspective-btn",{active:f(Z)===p.id,offline:p.id&&!p.online}]),onClick:k=>fe(p.id)},[e("div",_m,[p.avatar?(s(),Ke(Gt,{key:0,avatar:p.avatar,size:"xs"},null,8,["avatar"])):(s(),Ke(f(K),{key:1,icon:"mdi:account-group",class:"all-icon"})),p.id&&!p.online?(s(),n("span",$m)):x("",!0)]),e("span",null,u(p.name),1)],10,wm))),128))]),e("button",{class:te(["delivery-toggle-btn",{active:S.value}]),onClick:N[1]||(N[1]=p=>S.value=!S.value),title:S.value?"Скрыть статусы доставки":"Показать статусы доставки"},[U(f(K),{icon:S.value?"mdi:account-check":"mdi:account-off"},null,8,["icon"])],10,Cm),e("button",{class:te(["log-tools-btn",{active:D.value}]),onClick:N[2]||(N[2]=p=>D.value=!D.value),title:"Инструменты лога"},[U(f(K),{icon:"mdi:cog"})],2)])):x("",!0),U(us,{name:"slide-down"},{default:Zt(()=>[de.value&&D.value?(s(),n("div",Tm,[e("div",Sm,[N[8]||(N[8]=e("span",{class:"tools-title"},"Управление логом",-1)),e("span",Im,u(f(M))+" событий",1)]),e("div",Pm,[e("button",{class:"tool-btn",onClick:_,title:"Экспортировать лог в JSON"},[U(f(K),{icon:"mdi:download"}),N[9]||(N[9]=e("span",null,"Экспорт",-1))]),e("button",{class:"tool-btn tool-btn-danger",onClick:P,title:"Очистить лог"},[U(f(K),{icon:"mdi:delete-outline"}),N[10]||(N[10]=e("span",null,"Очистить",-1))])])])):x("",!0)]),_:1}),(s(),Ke(Tt,{to:"body"},[U(us,{name:"fade"},{default:Zt(()=>[r.value?(s(),n("div",{key:0,class:"confirm-overlay",onClick:Fe(ce,["self"])},[e("div",Em,[e("div",Mm,[U(f(K),{icon:"mdi:alert-circle"})]),N[15]||(N[15]=e("h3",{class:"confirm-title"},"Очистить лог?",-1)),e("p",Am,[N[11]||(N[11]=ke(" Будет удалено ",-1)),e("strong",null,u(f(M)),1),N[12]||(N[12]=ke(" событий. Это действие нельзя отменить. ",-1))]),e("div",Dm,[e("button",{class:"confirm-btn confirm-btn-secondary",onClick:ce}," Отмена "),e("button",{class:"confirm-btn confirm-btn-primary",onClick:Y},[U(f(K),{icon:"mdi:download"}),N[13]||(N[13]=ke(" Сохранить и очистить ",-1))]),e("button",{class:"confirm-btn confirm-btn-danger",onClick:B},[U(f(K),{icon:"mdi:delete"}),N[14]||(N[14]=ke(" Очистить ",-1))])])])])):x("",!0)]),_:1})])),de.value&&f(T)&&f(R)?(s(),n("div",Nm,[e("img",{src:f(R).url,alt:f(R).description,class:"scene-image-preview"},null,8,Lm),e("div",Fm,[e("span",Rm,u(f(R).description||"Изображение сцены"),1),e("button",{class:"hide-image-btn",onClick:N[3]||(N[3]=p=>a("hide-image")),title:"Скрыть изображение"},[U(f(K),{icon:"mdi:eye-off"})])])])):x("",!0),e("div",{ref_key:"logContainerRef",ref:ne,class:"events-log",onScroll:V},[f(b)?(s(),n("div",Om,[e("button",{class:"load-more-btn",onClick:N[4]||(N[4]=p=>f(l).loadMoreEvents())},[U(f(K),{icon:"mdi:history"}),e("span",null,"Загрузить ещё ("+u(f(I))+")",1)])])):x("",!0),f(g).length===0?(s(),n("div",Hm,[U(f(K),{icon:"mdi:book-open-variant",class:"empty-icon"}),N[16]||(N[16]=e("p",null,"История событий пуста",-1)),N[17]||(N[17]=e("p",{class:"empty-hint"},"Здесь будут отображаться события игры",-1))])):x("",!0),U(Nl,{name:"event-list",tag:"div",class:"events-list"},{default:Zt(()=>[(s(!0),n(W,null,re(f(g),p=>{var k,$,se,G,ue,Ze,We,ct,ot;return s(),n("div",{key:p.id,class:te(["event-item",[`event-${p.type}`,{interactive:at(p),"hidden-for-perspective":ie(p)}]]),style:Ne({"--event-color":rt(p.type)})},[p.type===f(Ee).BATTLE_INVITE?(s(),n("div",{key:0,class:te(["event-row",{"event-row-fullwidth":!de.value}])},[e("div",{class:te(["event-content",{"event-content-fullwidth":!de.value}])},[e("div",{class:"event-battle",onClick:Fe(Qe,["stop"])},[N[18]||(N[18]=e("div",{class:"battle-lines"},null,-1)),U(f(K),{icon:"mdi:sword-cross",class:"battle-icon"}),N[19]||(N[19]=e("div",{class:"battle-lines"},null,-1))]),p.description?(s(),n("p",jm,u(p.description),1)):x("",!0)],2),de.value&&S.value?(s(),n("div",zm,[(s(!0),n(W,null,re(Oe(p),J=>(s(),n("div",{key:J.characterId,class:te(["delivery-face",{delivered:J.delivered&&!J.hidden,"is-hidden":J.hidden&&J.delivered,"pre-hidden":J.hidden&&!J.delivered,pending:!J.delivered&&!J.hidden,offline:!J.online}]),onClick:Fe(nt=>Xe(p,J,nt.shiftKey),["stop"])},[J.characterPortrait?(s(),n("img",{key:0,src:J.characterPortrait,class:"face-img"},null,8,Bm)):J.avatar?(s(),Ke(Gt,{key:1,avatar:J.avatar,size:"sm",class:"face-avatar"},null,8,["avatar"])):(s(),n("div",Wm,u((J.characterName||J.name||"?")[0].toUpperCase()),1)),e("div",qm,[e("div",Vm,u(J.characterName||"Без персонажа"),1),e("div",Xm,"Игрок: "+u(J.ownerName),1),J.online?x("",!0):(s(),n("div",Ym,"офлайн")),e("div",Gm,[J.hidden&&J.delivered?(s(),n(W,{key:0},[ke("Скрыто • Клик: показать")],64)):J.hidden&&!J.delivered?(s(),n(W,{key:1},[ke("Будет скрыто • Клик: отмена")],64)):J.delivered?(s(),n(W,{key:2},[ke("Доставлено • Клик: скрыть")],64)):(s(),n(W,{key:3},[ke("Ожидает • Клик: скрыть, Shift: отправить")],64))])])],10,Um))),128))])):x("",!0)],2)):p.type===f(Ee).IMAGE?(s(),n("div",{key:1,class:te(["event-row",{"event-row-fullwidth":!de.value}])},[e("div",{class:te(["event-content",{"event-content-fullwidth":!de.value}])},[e("div",{class:te(["event-fullwidth-action",{viewing:((k=f(R))==null?void 0:k.url)===p.url}]),onClick:Fe(J=>{var nt;return((nt=f(R))==null?void 0:nt.url)===p.url?a("hide-image",p):a("view-image",p)},["stop"])},[N[20]||(N[20]=e("div",{class:"fullwidth-lines"},null,-1)),U(f(K),{icon:(($=f(R))==null?void 0:$.url)===p.url?"mdi:eye-off":"mdi:image",class:"fullwidth-icon"},null,8,["icon"]),N[21]||(N[21]=e("div",{class:"fullwidth-lines"},null,-1))],10,Km),e("p",Qm,u(p.description||"Изображение"),1)],2),de.value&&S.value?(s(),n("div",Zm,[(s(!0),n(W,null,re(Oe(p),J=>(s(),n("div",{key:J.characterId,class:te(["delivery-face",{delivered:J.delivered&&!J.hidden,"is-hidden":J.hidden&&J.delivered,"pre-hidden":J.hidden&&!J.delivered,pending:!J.delivered&&!J.hidden,offline:!J.online}]),onClick:Fe(nt=>Xe(p,J,nt.shiftKey),["stop"])},[J.characterPortrait?(s(),n("img",{key:0,src:J.characterPortrait,class:"face-img"},null,8,ep)):J.avatar?(s(),Ke(Gt,{key:1,avatar:J.avatar,size:"sm",class:"face-avatar"},null,8,["avatar"])):(s(),n("div",tp,u((J.characterName||J.name||"?")[0].toUpperCase()),1))],10,Jm))),128))])):x("",!0)],2)):p.type===f(Ee).CHARACTER_INVITE?(s(),n("div",{key:2,class:te(["event-row event-row-invite",{"event-row-fullwidth":!de.value}])},[e("div",{class:te(["event-content",{"event-content-fullwidth":!de.value}])},[de.value?(s(),n("div",ip,[e("div",rp,[U(f(K),{icon:"mdi:account-plus",class:"invite-header-icon"}),N[26]||(N[26]=e("span",null,"Приглашение создать персонажа",-1))]),p.usedBy&&p.usedBy.length>0?(s(),n("div",cp,[(s(!0),n(W,null,re(p.usedBy,J=>(s(),n("div",{key:J.characterId,class:"invite-usage"},[J.characterPortrait?(s(),Ke(zt,{key:0,portrait:J.characterPortrait,size:32,showBorder:!0,class:"usage-portrait"},null,8,["portrait"])):(s(),n("div",dp,u((J.characterName||"?")[0].toUpperCase()),1)),e("span",up,u(J.characterName),1)]))),128))])):x("",!0)])):(s(),n(W,{key:0},[lt(p)?(s(),n("div",sp,[(se=tt(p))!=null&&se.characterPortrait?(s(),Ke(zt,{key:0,portrait:tt(p).characterPortrait,size:48,showBorder:!0,class:"invite-portrait"},null,8,["portrait"])):(s(),n("div",np,u((((G=tt(p))==null?void 0:G.characterName)||"?")[0].toUpperCase()),1)),e("span",lp,u(((ue=tt(p))==null?void 0:ue.characterName)||"Персонаж создан"),1)])):at(p)?(s(),n(W,{key:1},[e("div",{class:"event-fullwidth-action",onClick:Fe(J=>Ve(p),["stop"])},[N[22]||(N[22]=e("div",{class:"fullwidth-lines blue"},null,-1)),U(f(K),{icon:"mdi:account-plus",class:"fullwidth-icon blue"}),N[23]||(N[23]=e("div",{class:"fullwidth-lines blue"},null,-1))],8,ap),N[24]||(N[24]=e("p",{class:"fullwidth-desc"},"Создайте персонажа!",-1))],64)):(s(),n("div",op,[U(f(K),{icon:"mdi:account-plus-outline",class:"invite-icon-disabled"}),N[25]||(N[25]=e("span",null,"Приглашение не для вас",-1))]))],64))],2),de.value&&S.value?(s(),n("div",fp,[(s(!0),n(W,null,re(it(p),J=>{var nt,et;return s(),n("div",{key:J.userId,class:te(["delivery-face",{delivered:J.delivered&&!J.used,used:J.used,pending:!J.delivered&&!J.used,offline:!J.online}]),title:J.used?`${J.alias}: ${(nt=J.createdCharacter)==null?void 0:nt.name}`:J.alias},[J.used&&((et=J.createdCharacter)!=null&&et.portrait)?(s(),n("img",{key:0,src:f(St)(J.createdCharacter.portrait),class:"face-img"},null,8,mp)):J.avatar?(s(),Ke(Gt,{key:1,avatar:J.avatar,size:"sm",class:"face-avatar"},null,8,["avatar"])):(s(),n("div",pp,u((J.alias||"?")[0].toUpperCase()),1))],10,vp)}),128))])):x("",!0)],2)):(s(),n("div",hp,[e("div",gp,[p.type===f(Ee).SYSTEM?(s(),n("div",bp,[U(f(K),{icon:Re(p.type),class:"event-icon"},null,8,["icon"]),e("span",null,u(p.text),1)])):p.type===f(Ee).TEXT?(s(),n("div",yp,[e("p",xp,u(p.text),1),e("span",kp,u(he(p.time)),1)])):p.type===f(Ee).SKILL_CHECK?(s(),n("div",{key:2,class:te(["event-check",{success:p.completed&&((Ze=p.result)==null?void 0:Ze.success),failure:p.completed&&p.result&&!p.result.success,"auto-success":((We=p.result)==null?void 0:We.resultType)==="guaranteed-success","auto-failure":((ct=p.result)==null?void 0:ct.resultType)==="guaranteed-fail"}]),style:Ne({"--aspect-color":y(p.checkType),"--diff-color":le(p.difficulty).color}),onClick:Fe(J=>at(p)&&qe(p),["stop"])},[e("div",_p,[e("div",$p,[U(f(K),{icon:H(p.checkType),class:"check-type-icon"},null,8,["icon"])]),p.completed&&(xe(p)||p.characterName)?(s(),n("div",Cp,[xe(p)?(s(),n("img",{key:0,src:xe(p),alt:p.characterName,class:"character-portrait"},null,8,Tp)):(s(),n("div",Sp,u((p.characterName||"?")[0].toUpperCase()),1))])):x("",!0),e("div",Ip,u(L(p.difficulty)),1),p.completed&&p.result?(s(),n("div",Pp,[p.result.resultType==="guaranteed-success"?(s(),n("span",Ep,"Автоуспех")):p.result.resultType==="guaranteed-fail"?(s(),n("span",Mp,"Автопровал")):(s(),n("span",{key:2,class:te(["result-label",p.result.success?"success":"fail"])},u(p.result.success?"Успех":"Провал"),3))])):x("",!0)]),p.completed&&p.result&&p.result.resultType==="normal"?(s(),n("div",Ap,[e("span",Dp,u(p.result.roll),1),p.result.modifier!==0?(s(),n("span",Np,u(p.result.modifier>=0?"+":"")+u(p.result.modifier),1)):x("",!0),N[27]||(N[27]=e("span",{class:"check-equals"},"=",-1)),e("span",Lp,u(p.result.total),1),N[28]||(N[28]=e("span",{class:"check-vs"},"vs",-1)),e("span",Fp,u(p.result.difficulty),1)])):x("",!0),p.description?(s(),n("p",Rp,u(p.description),1)):x("",!0)],14,wp)):p.type===f(Ee).IMPORTANT?(s(),n("div",Op,[U(f(K),{icon:p.icon||"mdi:alert-circle",class:"important-icon"},null,8,["icon"]),e("div",Hp,[e("p",jp,u(p.text),1),e("span",zp,u(he(p.time)),1)])])):p.type===f(Ee).QUEST?(s(),n("div",{key:4,class:"quest-container",onClick:Fe(J=>ve(p.id),["stop"])},[e("div",Bp,[U(f(K),{icon:"mdi:map-marker-star",class:"quest-icon"}),e("span",Wp,u(p.title),1),U(f(K),{icon:h.value.has(p.id)?"mdi:chevron-up":"mdi:chevron-down",class:"quest-chevron"},null,8,["icon"])]),h.value.has(p.id)?(s(),n("div",qp,[p.description?(s(),n("p",Vp,u(p.description),1)):x("",!0),(ot=p.objectives)!=null&&ot.length?(s(),n("ul",Xp,[(s(!0),n(W,null,re(p.objectives,(J,nt)=>(s(),n("li",{key:nt,class:te({completed:J.completed})},[U(f(K),{icon:J.completed?"mdi:checkbox-marked-circle":"mdi:checkbox-blank-circle-outline"},null,8,["icon"]),ke(" "+u(J.text),1)],2))),128))])):x("",!0)])):x("",!0)],8,Up)):p.type===f(Ee).ITEM_GIVE?(s(),n("div",Yp,[U(f(K),{icon:"mdi:gift",class:"item-icon"}),e("div",Gp,[N[29]||(N[29]=e("span",{class:"item-label"},"Получен предмет:",-1)),e("div",Kp,[(s(!0),n(W,null,re(p.items,J=>(s(),n("span",{key:J.id,class:"item-badge"},[ke(u(J.name)+" ",1),J.quantity>1?(s(),n(W,{key:0},[ke("x"+u(J.quantity),1)],64)):x("",!0)]))),128))])])])):p.type===f(Ee).ITEM_LOOT?(s(),n("div",Qp,[e("div",Zp,[U(f(K),{icon:"mdi:treasure-chest",class:"loot-icon"}),N[30]||(N[30]=e("span",{class:"loot-title"},"Найден лут!",-1))]),p.description?(s(),n("p",Jp,u(p.description),1)):x("",!0),e("div",e0,[(s(!0),n(W,null,re(p.items,J=>(s(),n("div",{key:J.id,class:te(["loot-item",{claimed:J.claimedBy}])},[e("span",t0,u(J.name),1),J.claimedBy?(s(),n("span",s0,u(we(J.claimedBy).name),1)):(s(),n("button",n0,"Взять"))],2))),128))])])):(s(),n("div",l0,[U(f(K),{icon:Re(p.type),class:"event-icon"},null,8,["icon"]),e("span",null,u(p.text||p.description||"Событие"),1)]))]),de.value&&S.value?(s(),n("div",a0,[(s(!0),n(W,null,re(Oe(p),J=>(s(),n("div",{key:J.characterId,class:te(["delivery-face",{delivered:J.delivered&&!J.hidden,"is-hidden":J.hidden&&J.delivered,"pre-hidden":J.hidden&&!J.delivered,pending:!J.delivered&&!J.hidden,offline:!J.online}]),onClick:Fe(nt=>Xe(p,J,nt.shiftKey),["stop"])},[J.characterPortrait?(s(),n("img",{key:0,src:J.characterPortrait,class:"face-img"},null,8,i0)):J.avatar?(s(),Ke(Gt,{key:1,avatar:J.avatar,size:"sm",class:"face-avatar"},null,8,["avatar"])):(s(),n("div",r0,u((J.characterName||J.name||"?")[0].toUpperCase()),1)),e("div",c0,[e("div",d0,u(J.characterName||"Без персонажа"),1),e("div",u0,"Игрок: "+u(J.ownerName),1),J.online?x("",!0):(s(),n("div",f0,"офлайн")),e("div",v0,[J.hidden&&J.delivered?(s(),n(W,{key:0},[ke("Скрыто • Клик: показать")],64)):J.hidden&&!J.delivered?(s(),n(W,{key:1},[ke("Будет скрыто • Клик: отмена")],64)):J.delivered?(s(),n(W,{key:2},[ke("Доставлено • Клик: скрыть")],64)):(s(),n(W,{key:3},[ke("Ожидает • Клик: скрыть, Shift: отправить")],64))])])],10,o0))),128))])):x("",!0)]))],6)}),128))]),_:1})],544)],2)}}},Fn=wt(m0,[["__scopeId","data-v-c8aab9c0"]]);function p0(t){var o;for(const a of vs.classes){const l=(o=a.traits)==null?void 0:o.find(i=>i.id===t);if(l)return{sourceType:"class",sourceId:a.id,trait:l}}return null}function h0(t){var o;for(const a of kt.aspects){const l=(o=a.traits)==null?void 0:o.find(i=>i.id===t);if(l)return{sourceType:"aspect",sourceId:a.id,trait:l}}return null}function g0(t){var o;for(const a of Zs.races){const l=(o=a.traits)==null?void 0:o.find(i=>i.id===t);if(l)return{sourceType:"race",sourceId:a.id,trait:l}}return null}function Vs(t){return p0(t)||h0(t)||g0(t)||null}function b0(t){if(typeof t=="object"&&t!==null){if(t.id&&t.sourceType&&t.sourceId){const o={id:t.id,sourceType:t.sourceType,sourceId:t.sourceId,level:t.level||1,customDescriptions:t.customDescriptions||{},customTags:t.customTags||{}};return t.customColor&&(o.customColor=t.customColor),o}if(t.id){const o=Vs(t.id);if(o)return{id:t.id,sourceType:o.sourceType,sourceId:o.sourceId,level:t.level||1,customDescriptions:t.customDescriptions||t.customDescription?{[t.level||1]:t.customDescription}:{},customTags:t.customTags||{}}}return null}if(typeof t=="string"){const o=Vs(t);return o?{id:t,sourceType:o.sourceType,sourceId:o.sourceId,level:1,customDescriptions:{},customTags:{}}:(console.warn(`[SkillsMigration] Навык "${t}" не найден ни в одном источнике`),null)}return null}function y0(t){if(!Array.isArray(t))return{migrated:[],needsSave:!1};let o=!1;const a=[];for(const l of t){(typeof l=="string"||typeof l=="object"&&l&&!l.sourceType)&&(o=!0);const d=b0(l);d&&a.push(d)}return{migrated:a,needsSave:o}}function x0(t){var oe,ie,ne,O,S,D,r,h,_,P;const o=Vs(t.id);if(!o)return{...t,name:t.id,maxLevel:1,levels:[],sourceName:"Неизвестно",sourceIcon:"mdi:help-circle",sourceColor:"#94a3b8",aspectColor:"#94a3b8",currentDescription:""};const a=o.trait,l=((oe=a.levels)==null?void 0:oe.length)||1;let i="",d="mdi:help-circle",v="#94a3b8",E=null,g="#94a3b8",b=null,I=null;if(o.sourceType==="class"){const B=vs.classes.find(Y=>Y.id===o.sourceId);if(d="mdi:school",i=B?B.name.m||B.name:o.sourceId,E=`/TriP/images/classes/${o.sourceId}.png`,(ie=B==null?void 0:B.aspects)!=null&&ie[0]){b=B.aspects[0];const Y=kt.aspects.find(ve=>ve.id===b);Y&&(g=Y.color||"#94a3b8",I=Y.icon)}}else if(o.sourceType==="aspect"){const B=kt.aspects.find(ce=>ce.id===o.sourceId);d=(B==null?void 0:B.icon)||"mdi:hexagon",v=(B==null?void 0:B.color)||"#94a3b8",g=v,I=B==null?void 0:B.icon,i=(B==null?void 0:B.name)||o.sourceId,b=o.sourceId}else if(o.sourceType==="race"){const B=Zs.races.find(ce=>ce.id===o.sourceId);d="mdi:account",i=(B==null?void 0:B.name)||o.sourceId}const M=[];for(let B=0;B<t.level;B++){const ce=(ne=a.levels)==null?void 0:ne[B];ce&&M.push({level:B+1,description:ce.text||ce.description||"",customDescription:((O=t.customDescriptions)==null?void 0:O[B+1])||"",customTags:((S=t.customTags)==null?void 0:S[B+1])||[]})}const R=(D=a.levels)==null?void 0:D[t.level-1],T=(R==null?void 0:R.text)||(R==null?void 0:R.description)||"",F=((r=t.customDescriptions)==null?void 0:r[0])||((h=t.customDescriptions)==null?void 0:h[t.level])||"",Z=((_=t.customTags)==null?void 0:_[0])||((P=t.customTags)==null?void 0:P[t.level])||[],j=t.customColor||null;return{id:t.id,name:a.name,sourceType:t.sourceType,sourceId:t.sourceId,level:t.level,maxLevel:l,levels:a.levels||[],unlockedLevels:M,sourceName:i,sourceIcon:d,sourceColor:v,sourceImage:E,aspectId:b,aspectColor:g,aspectIcon:I,currentDescription:T,customDescription:F,customTags:Z,customColor:j,customDescriptions:t.customDescriptions||{},allCustomTags:t.customTags||{}}}const k0={key:0,class:"character-tabs"},w0=["onClick"],_0=["src","alt"],$0={key:1,class:"char-tab-avatar-fallback"},C0={class:"char-tab-name"},T0={key:1,class:"sheet-tabs-row"},S0=["onClick"],I0={class:"tab-label"},P0={key:2,class:"sheet-content"},E0={key:0,class:"master-edit-section"},M0={class:"master-basic-section"},A0={class:"master-section-header"},D0={class:"master-basic-info"},N0={class:"basic-info-row"},L0={class:"info-value"},F0={key:0,class:"basic-info-row"},R0={key:1,class:"basic-info-row"},O0={class:"info-value"},H0={class:"master-health-section"},j0={class:"master-section-header"},z0={class:"master-health-info"},U0={key:0,class:"health-max"},B0={key:1,class:"health-max"},W0={class:"master-stats-section"},q0={class:"master-section-header"},V0={class:"master-stats-grid"},X0={class:"stat-name"},Y0={class:"stat-value"},G0={class:"master-skills-section"},K0={class:"master-section-header"},Q0={class:"master-skills-info"},Z0={class:"master-danger-section"},J0={class:"tab-content tab-content-bottom"},eh={class:"skills-section"},th={class:"skills-header"},sh={class:"skills-controls"},nh=["title"],lh={key:0,class:"skills-list"},ah=["onClick"],oh={class:"skill-info"},ih={class:"skill-name"},rh={class:"skill-level"},ch={class:"skill-source"},dh={class:"skill-source-name"},uh={key:0,class:"skill-description"},fh={class:"skill-levels-list"},vh={class:"skill-level-badge"},mh={key:1,class:"skill-custom-note"},ph={key:2,class:"skill-hidden-hint"},hh=["onClick"],gh={key:1,class:"skills-empty"},bh={key:2,class:"skills-filter"},yh={class:"skill-details-title"},xh={class:"skill-details-name"},kh={class:"skill-details-level"},wh={class:"skill-details-body"},_h={class:"skill-details-levels"},$h={class:"skill-details-level-badge"},Ch={class:"skill-details-desc-text"},Th={class:"skill-details-section"},Sh=["value"],Ih={class:"skill-details-section"},Ph=["value"],Eh={class:"skill-details-section"},Mh={class:"skill-color-picker"},Ah=["title","onClick"],Dh={class:"action-mode-section"},Nh={class:"mode-header"},Lh={class:"mode-header-center"},Fh={class:"mode-active-name"},Rh={class:"mode-buttons"},Oh=["onClick","title"],Hh=["onClick"],jh={key:0,class:"mode-info-panel"},zh={class:"mode-details-name"},Uh={class:"mode-details-desc"},Bh={class:"checks-section"},Wh={class:"checks-table-container"},qh={class:"aspects-column"},Vh={class:"aspect-name"},Xh={class:"checks-scroll-area"},Yh={class:"checks-grid"},Gh={class:"diff-headers-row"},Kh=["title"],Qh={class:"tab-content"},Zh={class:"section-card"},Jh={class:"section-card"},eg={class:"tab-content"},tg={class:"section-card placeholder"},sg={class:"tab-content"},ng={class:"section-card placeholder"},lg={key:3,class:"empty-state"},ag={class:"master-modal-header"},og={class:"master-modal-body"},ig={class:"form-group"},rg={class:"form-group"},cg={key:0,class:"portrait-preview"},dg=["src"],ug={class:"form-group"},fg={class:"npc-type-selector"},vg=["onClick"],mg={class:"form-group"},pg={class:"checkbox-label"},hg={class:"form-group"},gg={class:"factions-list"},bg=["onClick"],yg={class:"faction-add"},xg={class:"master-modal-footer"},kg={class:"master-modal-header"},wg={class:"master-modal-body"},_g={class:"form-group"},$g={class:"health-type-selector"},Cg={key:0,class:"form-group"},Tg={class:"wounds-grid"},Sg={class:"form-group"},Ig={class:"form-group"},Pg={class:"form-group"},Eg={class:"form-group"},Mg={class:"form-group"},Ag={class:"master-modal-footer"},Dg={class:"master-modal-header"},Ng={class:"master-modal-body"},Lg={class:"stats-editor-grid"},Fg={class:"stat-editor-label"},Rg=["onUpdate:modelValue"],Og={class:"master-modal-footer"},Hg={class:"master-modal-header"},jg={class:"master-modal-body"},zg={class:"skill-add-row"},Ug=["value","disabled"],Bg=["disabled"],Wg={class:"custom-skill-section"},qg={key:1,class:"custom-skill-form"},Vg={class:"custom-skill-actions"},Xg={key:0,class:"skills-editor-list"},Yg={class:"skill-editor-info"},Gg={class:"skill-editor-name"},Kg={key:0,class:"skill-editor-source"},Qg={key:1,class:"skill-editor-source custom"},Zg=["value","onChange"],Jg=["onClick"],e1={key:1,class:"skills-editor-empty"},t1={class:"master-modal-footer"},s1={__name:"MobileCharacterSheet",props:{character:{type:Object,default:null},embedded:{type:Boolean,default:!1},activeTab:{type:String,default:"main"}},emits:["close","switch-tab","update:activeTab","create-character","go-to-characters"],setup(t,{emit:o}){const a=t,l=o,i=Bt(),d=Rt(),v=ms(),E=ss(),{myCharacters:g,activeCharacter:b,activeCharacterId:I}=pt(i),{isMaster:M}=pt(d),{userId:R}=pt(v),T=X(()=>{if(a.character)return a.character;if(M.value)return b.value;const ae=g.value;return ae.length?b.value&&b.value.ownerId===R.value?b.value:ae[0]:null}),F=X(()=>{var ae;return((ae=T.value)==null?void 0:ae.ownerId)===R.value});X(()=>F.value||M.value);const Z=[{id:"main",label:"Личность",icon:"mdi:account-heart"},{id:"items",label:"Инвентарь",icon:"mdi:backpack"},{id:"social",label:"Социум",icon:"mdi:account-group"},{id:"magic",label:"Магия",icon:"mdi:auto-fix"}],j=Q("main"),oe=X({get:()=>a.embedded?a.activeTab:j.value,set:ae=>{a.embedded?l("update:activeTab",ae):j.value=ae}}),ie=ae=>{i.setActiveCharacter(ae)},ne=X(()=>{var m;return(((m=kt.metadata)==null?void 0:m.circularOrder)||kt.aspects.map(pe=>pe.id)).map(pe=>kt.aspects.find($e=>$e.id===pe)).filter(Boolean)}),O=X(()=>ne.value.filter(ae=>ae.mode)),S=X({get:()=>{var ae;return(ae=T.value)!=null&&ae.id?v.getCharacterMode(T.value.id):null},set:ae=>{var m;(m=T.value)!=null&&m.id&&v.setCharacterMode(T.value.id,ae)}}),D=Q(!1),r=Q(null),h=X(()=>{if(!S.value)return"не выбран";const ae=O.value.find(m=>m.id===S.value);return ae?ae.mode.name:"не выбран"}),_=ae=>{S.value=S.value===ae?null:ae},P=ae=>{r.value=ae},B=Q(!1),ce=Q(!0),Y=Q(""),ve=Q(null),H=X(()=>{var ae;return(ae=T.value)!=null&&ae.id?v.getSkillPreferences(T.value.id):{expandedSkills:[],allExpanded:!0}}),y=ae=>H.value.allExpanded?!H.value.expandedSkills.includes(ae):H.value.expandedSkills.includes(ae),L=ae=>{var $e;if(!(($e=T.value)!=null&&$e.id))return;const m=T.value.id,pe=y(ae);H.value.allExpanded?v.setSkillExpanded(m,ae,pe):v.setSkillExpanded(m,ae,!pe)},le=()=>{var ae;(ae=T.value)!=null&&ae.id&&v.setAllSkillsExpanded(T.value.id,!H.value.allExpanded)},V=X(()=>{var pe;if(!((pe=T.value)!=null&&pe.skills))return[];const{migrated:ae,needsSave:m}=y0(T.value.skills);return m&&T.value.id&&(console.log("[Skills] Миграция навыков персонажа",T.value.name),i.updateCharacter(T.value.id,{skills:ae})),ae.map($e=>x0($e)).filter(Boolean)}),de=X(()=>{const ae=Y.value.toLowerCase().trim();if(!ae)return V.value;const m=pe=>{var Ie,Te;let $e=0;const Je=pe.name.toLowerCase(),ut=pe.sourceName.toLowerCase(),It=((Ie=pe.currentDescription)==null?void 0:Ie.toLowerCase())||"",gt=((Te=pe.customDescription)==null?void 0:Te.toLowerCase())||"",Ct=(pe.customTags||[]).join(" ").toLowerCase();return Je===ae?$e+=100:Je.startsWith(ae)?$e+=50:Je.includes(ae)&&($e+=30),ut.includes(ae)&&($e+=15),Ct.includes(ae)&&($e+=20),gt.includes(ae)&&($e+=10),It.includes(ae)&&($e+=5),$e};return V.value.map(pe=>({skill:pe,relevance:m(pe)})).filter(pe=>pe.relevance>0).sort((pe,$e)=>$e.relevance-pe.relevance).map(pe=>pe.skill)}),Se=ae=>{ve.value=ae.id},fe=()=>{ve.value=null},he=X(()=>ve.value&&V.value.find(ae=>ae.id===ve.value)||null),we=(ae,m,pe)=>{if(!T.value)return;const $e=[...T.value.skills||[]],Je=$e.findIndex(ut=>ut.id===ae);if(Je>=0){const ut={...$e[Je]};ut.customDescriptions={...ut.customDescriptions,[m]:pe},$e[Je]=ut,i.updateCharacter(T.value.id,{skills:$e})}},De=(ae,m,pe)=>{if(!T.value)return;const $e=[...T.value.skills||[]],Je=$e.findIndex(ut=>ut.id===ae);if(Je>=0){const ut={...$e[Je]};ut.customTags={...ut.customTags,[m]:pe},$e[Je]=ut,i.updateCharacter(T.value.id,{skills:$e})}},ye=[{name:"Красный",value:"#ef4444"},{name:"Оранжевый",value:"#f97316"},{name:"Жёлтый",value:"#eab308"},{name:"Зелёный",value:"#22c55e"},{name:"Бирюзовый",value:"#14b8a6"},{name:"Голубой",value:"#06b6d4"},{name:"Синий",value:"#3b82f6"},{name:"Фиолетовый",value:"#8b5cf6"},{name:"Розовый",value:"#ec4899"},{name:"Серый",value:"#64748b"}],xe=(ae,m)=>{if(!T.value)return;const pe=[...T.value.skills||[]],$e=pe.findIndex(Je=>Je.id===ae);if($e>=0){const Je={...pe[$e]};m?Je.customColor=m:delete Je.customColor,pe[$e]=Je,i.updateCharacter(T.value.id,{skills:pe})}},Le=X(()=>{const ae=$t.default||$t;return Object.entries(ae).map(([m,pe])=>({value:parseInt(m),...pe})).sort((m,pe)=>m.value-pe.value)}),qe=ae=>Js(T.value,ae),Qe=(ae,m)=>{const pe=qe(ae),$e=m-pe;return $e<=2?{type:"auto",value:"✓"}:$e<=12?{type:"roll",value:$e}:{type:"fail",value:"✗"}},Ve=ae=>{i.updateCharacter(ae.id,ae)},Re=Q(!1),rt=Q({}),at=X(()=>kt.aspects.filter(ae=>["war","knowledge","community","shadow","mysticism","nature"].includes(ae.id))),lt=()=>{T.value&&(rt.value={...T.value.stats||{war:0,knowledge:0,community:0,shadow:0,mysticism:0,nature:0}},Re.value=!0)},tt=()=>{T.value&&(i.updateCharacter(T.value.id,{stats:{...rt.value}}),M.value&&d.broadcastAllCharacters(),Re.value=!1)},it=Q(!1),Oe=Q([]),Xe=Q(""),je=Q(1),dt=Q(""),ht=Q(""),z=Q(!1),N=X(()=>{const ae=[];return vs.classes.forEach(m=>{m.traits&&m.traits.forEach(pe=>{var $e;ae.push({id:`class_${m.id}_${pe.id}`,name:pe.name,sourceType:"class",sourceId:m.id,sourceName:typeof m.name=="object"?m.name.m:m.name,maxLevel:(($e=pe.levels)==null?void 0:$e.length)||1,levels:pe.levels||[]})})}),kt.aspects.forEach(m=>{m.traits&&m.traits.forEach(pe=>{var $e,Je;($e=pe.id)!=null&&$e.toLowerCase().includes("temp")||ae.push({id:`aspect_${m.id}_${pe.id}`,name:pe.name,sourceType:"aspect",sourceId:m.id,sourceName:m.name,aspectColor:m.color,maxLevel:((Je=pe.levels)==null?void 0:Je.length)||1,levels:pe.levels||[]})})}),ae}),me=()=>{T.value&&(Oe.value=[...T.value.skills||[]],it.value=!0)},p=()=>{if(Xe.value){if(Oe.value.some(ae=>ae.id===Xe.value)){alert("Этот навык уже добавлен");return}Oe.value.push({id:Xe.value,level:je.value}),Xe.value="",je.value=1}},k=ae=>{Oe.value=Oe.value.filter(m=>m.id!==ae)},$=(ae,m)=>{const pe=Oe.value.find($e=>$e.id===ae);pe&&(pe.level=parseInt(m)||1)},se=ae=>{const m=N.value.find(pe=>pe.id===ae);if(m)return m;if(ae.startsWith("custom_")){const pe=Oe.value.find($e=>$e.id===ae);if(pe)return{id:ae,name:pe.customName||"Кастомный навык",sourceType:"custom",sourceName:"Особый",maxLevel:3,levels:[],description:pe.customDescription||""}}return null},G=()=>{if(!dt.value.trim()){alert("Введите название навыка");return}const ae=`custom_${Date.now()}`;Oe.value.push({id:ae,level:1,customName:dt.value.trim(),customDescription:ht.value.trim()}),dt.value="",ht.value="",z.value=!1},ue=()=>{T.value&&(i.updateCharacter(T.value.id,{skills:[...Oe.value]}),M.value&&d.broadcastAllCharacters(),it.value=!1)},Ze=Q(!1),We=Q({name:"",portrait:"",npcType:"neutral",factions:[],visibleToPlayers:!0}),ct=[{id:"ally",label:"Союзник",color:"#22c55e"},{id:"neutral",label:"Нейтрал",color:"#94a3b8"},{id:"enemy",label:"Враг",color:"#ef4444"}],ot=()=>{T.value&&(We.value={name:T.value.name||"",portrait:T.value.portrait||"",npcType:T.value.npcType||"neutral",factions:T.value.factions||[],visibleToPlayers:T.value.visibleToPlayers!==!1},Ze.value=!0)},J=()=>{T.value&&(i.updateCharacter(T.value.id,{name:We.value.name,portrait:We.value.portrait,npcType:We.value.npcType,factions:We.value.factions,visibleToPlayers:We.value.visibleToPlayers}),M.value&&d.broadcastAllCharacters(),Ze.value=!1)},nt=Q(""),et=()=>{nt.value.trim()&&(We.value.factions.includes(nt.value.trim())||We.value.factions.push(nt.value.trim()),nt.value="")},ps=ae=>{We.value.factions=We.value.factions.filter(m=>m!==ae)},Dt=Q(!1),Ge=Q({healthType:"simple",maxHp:8,maxScratch:3,maxLight:2,maxHeavy:1,maxDeadly:1,bonusDeadlySlots:0}),hs=()=>{if(!T.value)return;const ae=T.value.combat||{},m=ae.wounds||{};Ge.value={healthType:ae.healthType||"simple",maxHp:ae.maxHp||8,maxScratch:m.maxScratch??3,maxLight:m.maxLight??2,maxHeavy:m.maxHeavy??1,maxDeadly:m.maxDeadly??1,bonusDeadlySlots:ae.bonusDeadlySlots||0},Dt.value=!0},Ms=()=>{if(!T.value)return;const ae=T.value.combat||{},m=ae.wounds||{},pe={combat:{...ae,healthType:Ge.value.healthType,maxHp:Ge.value.maxHp,bonusDeadlySlots:Ge.value.bonusDeadlySlots}};Ge.value.healthType==="wounds"&&(pe.combat.wounds={...m,maxScratch:Ge.value.maxScratch,maxLight:Ge.value.maxLight,maxHeavy:Ge.value.maxHeavy,maxDeadly:Ge.value.maxDeadly}),i.updateCharacter(T.value.id,pe),M.value&&d.broadcastAllCharacters(),Dt.value=!1},ns=()=>{if(!T.value)return;const ae=T.value.isNpc,m=ae?`Удалить NPC "${T.value.name}"?`:F.value?`Удалить персонажа "${T.value.name}"?`:`Удалить персонажа "${T.value.name}" игрока ${T.value.ownerNickname}?`;if(confirm(m)){const pe=T.value.id,$e=E.activeMap;$e&&E.removeTokenByCharacterId($e.id,pe),ae?(i.deleteNpc(pe),d.sendCharacterDelete(pe)):(i.deleteCharacter(pe),d.sendCharacterDelete(pe)),M.value?l("go-to-characters"):l("close")}},As=ae=>{var m;if(T.value){if(ae.category==="armor"){const pe={...T.value,equipment:{...T.value.equipment,armor:ae.id}};Ve(pe)}else if(ae.category==="weapon"||ae.category==="shield"){const pe=[...((m=T.value.equipment)==null?void 0:m.weaponSets)||[]],$e={...pe[0]},Je=$e.weapons.map(gt=>Ft.items.find(Ct=>Ct.id===gt)).filter(Boolean);Je.push(ae);const ut=Je.reduce((gt,Ct)=>gt+(Ct.hands||0),0),It=Je.filter(gt=>gt.length===2).length;if(ut<=2&&It<=1){$e.weapons=[...$e.weapons,ae.id],pe[0]=$e;const gt={...T.value,equipment:{...T.value.equipment,weaponSets:pe}};Ve(gt)}}}};return(ae,m)=>{var pe,$e,Je,ut,It,gt,Ct,Ie,Te,Ot,gs,bs;return s(),n("div",{class:te(["mobile-character-sheet",{embedded:t.embedded}])},[!t.embedded&&f(g).length>1?(s(),n("div",k0,[(s(!0),n(W,null,re(f(g),A=>{var ze,bt;return s(),n("button",{key:A.id,class:te(["char-tab",{active:f(I)===A.id}]),onClick:Pt=>ie(A.id)},[A.portrait?(s(),n("img",{key:0,src:A.portrait,alt:A.name,class:"char-tab-avatar"},null,8,_0)):(s(),n("span",$0,u(((bt=(ze=A.name)==null?void 0:ze.charAt(0))==null?void 0:bt.toUpperCase())||"?"),1)),e("span",C0,u(A.name),1)],10,w0)}),128))])):x("",!0),t.embedded?x("",!0):(s(),n("div",T0,[(s(),n(W,null,re(Z,A=>e("button",{key:A.id,class:te(["sheet-tab-btn",{active:oe.value===A.id}]),onClick:ze=>oe.value=A.id},[U(f(K),{icon:A.icon,class:"tab-icon"},null,8,["icon"]),e("span",I0,u(A.label),1)],10,S0)),64))])),T.value?(s(),n("div",P0,[f(M)?(s(),n("div",E0,[m[57]||(m[57]=e("div",{class:"master-section-title"},"⚙️ Мастерские инструменты",-1)),e("div",M0,[e("div",A0,[m[47]||(m[47]=e("span",null,"Основные данные",-1)),e("button",{class:"master-edit-btn",onClick:ot},[U(f(K),{icon:"mdi:pencil"}),m[46]||(m[46]=ke(" Редактировать ",-1))])]),e("div",D0,[e("div",N0,[m[48]||(m[48]=e("span",{class:"info-label"},"Имя:",-1)),e("span",L0,u(T.value.name),1)]),T.value.isNpc?(s(),n("div",F0,[m[49]||(m[49]=e("span",{class:"info-label"},"Тип:",-1)),e("span",{class:"info-value npc-type-badge",style:Ne({color:((pe=ct.find(A=>A.id===T.value.npcType))==null?void 0:pe.color)||"#94a3b8"})},u((($e=ct.find(A=>A.id===T.value.npcType))==null?void 0:$e.label)||"Нейтрал"),5)])):x("",!0),T.value.isNpc&&((Je=T.value.factions)!=null&&Je.length)?(s(),n("div",R0,[m[50]||(m[50]=e("span",{class:"info-label"},"Фракции:",-1)),e("span",O0,u(T.value.factions.join(", ")),1)])):x("",!0)])]),e("div",H0,[e("div",j0,[m[52]||(m[52]=e("span",null,"Здоровье",-1)),e("button",{class:"master-edit-btn",onClick:hs},[U(f(K),{icon:"mdi:pencil"}),m[51]||(m[51]=ke(" Редактировать ",-1))])]),e("div",z0,[e("span",{class:te(["health-type-badge",((ut=T.value.combat)==null?void 0:ut.healthType)||"simple"])},u(((It=T.value.combat)==null?void 0:It.healthType)==="wounds"?"Ранения":"Простое HP"),3),((gt=T.value.combat)==null?void 0:gt.healthType)!=="wounds"?(s(),n("span",U0," Макс: "+u(((Ct=T.value.combat)==null?void 0:Ct.maxHp)||8),1)):(s(),n("span",B0," Смерт. слоты: "+u(1+(((Ie=T.value.combat)==null?void 0:Ie.bonusDeadlySlots)||0)),1))])]),e("div",W0,[e("div",q0,[m[54]||(m[54]=e("span",null,"Характеристики",-1)),e("button",{class:"master-edit-btn",onClick:lt},[U(f(K),{icon:"mdi:pencil"}),m[53]||(m[53]=ke(" Редактировать ",-1))])]),e("div",V0,[(s(!0),n(W,null,re(at.value,A=>{var ze,bt,Pt;return s(),n("div",{key:A.id,class:"master-stat-item",style:Ne({"--stat-color":A.color})},[U(f(K),{icon:A.characteristicIcon||A.icon,class:"stat-icon"},null,8,["icon"]),e("span",X0,u(((ze=A.characteristic)==null?void 0:ze.name)||A.name),1),e("span",Y0,u(((Pt=(bt=T.value)==null?void 0:bt.stats)==null?void 0:Pt[A.id])||0),1)],4)}),128))])]),e("div",G0,[e("div",K0,[m[56]||(m[56]=e("span",null,"Управление навыками",-1)),e("button",{class:"master-edit-btn",onClick:me},[U(f(K),{icon:"mdi:pencil"}),m[55]||(m[55]=ke(" Редактировать ",-1))])]),e("div",Q0,u(((Ot=(Te=T.value)==null?void 0:Te.skills)==null?void 0:Ot.length)||0)+" навыков назначено ",1)]),e("div",Z0,[e("button",{class:"master-delete-btn",onClick:ns},[U(f(K),{icon:"mdi:delete"}),ke(" "+u(T.value.isNpc?"Удалить NPC":"Удалить персонажа"),1)])])])):x("",!0),Me(e("div",J0,[e("div",eh,[e("div",th,[m[58]||(m[58]=e("span",{class:"skills-title"},"НАВЫКИ И ОСОБЕННОСТИ",-1)),e("div",sh,[e("button",{class:te(["skills-toggle-desc",{active:!ce.value}]),onClick:m[0]||(m[0]=A=>ce.value=!ce.value),title:"Скрыть/показать оригинальные описания"},[U(f(K),{icon:"mdi:text-box-remove"})],2),e("button",{class:te(["skills-toggle-desc",{active:B.value}]),onClick:m[1]||(m[1]=A=>B.value=!B.value),title:"Показать свои заметки"},[U(f(K),{icon:"mdi:note-edit"})],2),e("button",{class:"skills-toggle-expand",onClick:le,title:H.value.allExpanded?"Свернуть все":"Развернуть все"},[U(f(K),{icon:H.value.allExpanded?"mdi:unfold-less-horizontal":"mdi:unfold-more-horizontal"},null,8,["icon"])],8,nh)])]),V.value.length>0?(s(),n("div",lh,[(s(!0),n(W,null,re(de.value,A=>(s(),n("div",{key:A.id,class:te(["skill-item",{expanded:y(A.id)}]),style:Ne({"--skill-color":A.customColor||A.aspectColor})},[e("div",{class:"skill-main",onClick:ze=>L(A.id)},[e("div",oh,[e("span",ih,u(A.name),1),e("span",rh,u(A.level)+"/"+u(A.maxLevel),1)]),e("div",ch,[e("span",dh,u(A.sourceName),1),U(f(K),{icon:y(A.id)?"mdi:chevron-up":"mdi:chevron-down",class:"skill-expand-icon"},null,8,["icon"])])],8,ah),y(A.id)?(s(),n("div",uh,[A.sourceType==="class"&&A.sourceImage?(s(),n("div",{key:0,class:"skill-bg-image",style:Ne({backgroundImage:`url(${A.sourceImage})`})},null,4)):x("",!0),e("div",fh,[ce.value?(s(!0),n(W,{key:0},re(A.unlockedLevels,ze=>(s(),n("div",{key:ze.level,class:"skill-level-item"},[e("span",vh,u(ze.level),1),e("p",null,u(ze.description),1)]))),128)):x("",!0),B.value&&A.customDescription?(s(),n("div",mh,[m[59]||(m[59]=e("span",{class:"skill-note-badge"},"📝",-1)),e("p",null,u(A.customDescription),1)])):x("",!0),!ce.value&&!(B.value&&A.customDescription)?(s(),n("div",ph,[U(f(K),{icon:"mdi:eye-off"}),m[60]||(m[60]=e("span",null,"Описания скрыты",-1))])):x("",!0)]),e("button",{class:"skill-details-btn",onClick:Fe(ze=>Se(A),["stop"])},[U(f(K),{icon:"mdi:dots-horizontal"})],8,hh)])):x("",!0)],6))),128))])):(s(),n("div",gh,[U(f(K),{icon:"mdi:book-open-variant",class:"skills-empty-icon"}),m[61]||(m[61]=e("span",null,"Навыки появятся по мере развития персонажа",-1))])),V.value.length>0?(s(),n("div",bh,[U(f(K),{icon:"mdi:magnify",class:"skills-filter-icon"}),Me(e("input",{type:"text","onUpdate:modelValue":m[2]||(m[2]=A=>Y.value=A),placeholder:"Поиск навыков...",class:"skills-filter-input"},null,512),[[Be,Y.value]]),Y.value?(s(),n("button",{key:0,class:"skills-filter-clear",onClick:m[3]||(m[3]=A=>Y.value="")},[U(f(K),{icon:"mdi:close"})])):x("",!0)])):x("",!0)]),(s(),Ke(Tt,{to:"body"},[he.value?(s(),n("div",{key:0,class:"skill-details-overlay",onClick:fe},[e("div",{class:"skill-details-card",onClick:m[7]||(m[7]=Fe(()=>{},["stop"]))},[e("div",{class:"skill-details-header",style:Ne({borderColor:he.value.customColor||he.value.aspectColor})},[U(f(K),{icon:he.value.sourceIcon,class:"skill-details-source-icon"},null,8,["icon"]),e("div",yh,[e("span",xh,u(he.value.name),1),e("span",kh,"Уровень "+u(he.value.level)+" / "+u(he.value.maxLevel),1)]),e("button",{class:"skill-details-close-btn",onClick:fe},[U(f(K),{icon:"mdi:close"})])],4),e("div",wh,[e("div",_h,[(s(!0),n(W,null,re(he.value.unlockedLevels,A=>(s(),n("div",{key:A.level,class:"skill-details-level"},[e("span",$h,u(A.level),1),e("p",Ch,u(A.description),1)]))),128))]),e("div",Th,[m[62]||(m[62]=e("h4",null,"Заметка",-1)),e("textarea",{class:"skill-custom-desc-input",value:he.value.customDescription,onInput:m[4]||(m[4]=A=>we(he.value.id,0,A.target.value)),placeholder:"Добавьте заметку к навыку..."},null,40,Sh)]),e("div",Ih,[m[63]||(m[63]=e("h4",null,"Теги для поиска",-1)),e("input",{type:"text",class:"skill-tags-input",value:(gs=he.value.customTags)==null?void 0:gs.join(", "),onInput:m[5]||(m[5]=A=>De(he.value.id,0,A.target.value.split(",").map(ze=>ze.trim()).filter(Boolean))),placeholder:"тег1, тег2, тег3..."},null,40,Ph)]),e("div",Eh,[m[64]||(m[64]=e("h4",null,"Цвет метки",-1)),e("div",Mh,[(s(),n(W,null,re(ye,A=>e("button",{key:A.value,class:te(["skill-color-option",{active:(he.value.customColor||he.value.aspectColor)===A.value}]),style:Ne({backgroundColor:A.value}),title:A.name,onClick:ze=>xe(he.value.id,A.value)},null,14,Ah)),64)),e("button",{class:te(["skill-color-option reset",{active:!he.value.customColor}]),title:"Сбросить (цвет аспекта)",onClick:m[6]||(m[6]=A=>xe(he.value.id,null))},[U(f(K),{icon:"mdi:refresh"})],2)])])])])])):x("",!0)])),e("div",Dh,[e("div",Nh,[e("div",Lh,[m[65]||(m[65]=e("span",{class:"mode-title"},"РЕЖИМ ДЕЙСТВИЙ:",-1)),e("span",Fh,u(h.value),1)]),e("button",{class:"mode-info-btn",onClick:m[8]||(m[8]=A=>D.value=!D.value)},[U(f(K),{icon:"mdi:information-outline"})])]),e("div",Rh,[(s(!0),n(W,null,re(O.value,A=>(s(),n("button",{key:A.id,class:te(["mode-btn",{active:S.value===A.id}]),style:Ne({"--mode-color":A.color}),onClick:ze=>_(A.id),title:A.mode.name},[U(f(K),{icon:A.mode.icon,class:"mode-icon"},null,8,["icon"]),e("span",{class:"mode-detail-btn",onClick:Fe(ze=>P(A),["stop"])},[U(f(K),{icon:"mdi:help-circle-outline"})],8,Hh)],14,Oh))),128))])]),D.value?(s(),n("div",jh,[...m[66]||(m[66]=[e("p",null,"Выбранный режим виден мастеру и влияет на контекст сцены.",-1),e("p",null,"При высоких показателях соответствующего Атрибута режимы становятся эффективнее и дают особые бонусы.",-1),e("p",null,"По умолчанию можно выбрать только один режим. Особые умения увеличивают лимит.",-1),e("p",{class:"mode-info-warning"},"В бою режимы менять нельзя.",-1)])])):x("",!0),r.value?(s(),n("div",{key:1,class:"mode-details-overlay",onClick:m[11]||(m[11]=A=>r.value=null)},[e("div",{class:"mode-details-card",onClick:m[10]||(m[10]=Fe(()=>{},["stop"]))},[e("div",{class:"mode-details-header",style:Ne({color:r.value.color})},[U(f(K),{icon:r.value.mode.icon,class:"mode-details-icon"},null,8,["icon"]),e("span",zh,u(r.value.mode.name),1)],4),e("p",Uh,u(r.value.mode.description),1),m[67]||(m[67]=e("div",{class:"mode-details-info"},[e("p",null,"Мастер видит ваш выбранный режим. Контекст сцены может меняться в зависимости от вашего подхода.")],-1)),e("button",{class:"mode-details-close",onClick:m[9]||(m[9]=A=>r.value=null)},"Закрыть")])])):x("",!0),e("div",Bh,[e("div",Wh,[e("div",qh,[m[68]||(m[68]=e("div",{class:"aspect-header-cell"},[e("span",{class:"checks-title"},"ПРОВЕРКИ")],-1)),(s(!0),n(W,null,re(ne.value,A=>{var ze;return s(),n("div",{key:A.id,class:"aspect-row-cell",style:Ne({color:A.color})},[U(f(K),{icon:A.checkIcon||A.icon||"mdi:circle",class:"aspect-icon"},null,8,["icon"]),e("span",Vh,u(((ze=A.check)==null?void 0:ze.name)||A.name),1)],4)}),128))]),e("div",Xh,[e("div",Yh,[e("div",Gh,[(s(!0),n(W,null,re(Le.value,A=>(s(),n("div",{key:A.value,class:te(["diff-header-cell","linetype-"+A.linetype]),style:Ne({"--diff-color":A.color}),title:A.name},u(A.short),15,Kh))),128))]),(s(!0),n(W,null,re(ne.value,A=>(s(),n("div",{key:A.id,class:"checks-row"},[(s(!0),n(W,null,re(Le.value,ze=>(s(),n("div",{key:ze.value,class:te(["check-cell",["linetype-"+ze.linetype,Qe(A.id,ze.value).type]]),style:Ne({"--diff-color":ze.color})},u(Qe(A.id,ze.value).value),7))),128))]))),128))])])])])],512),[[ws,oe.value==="main"]]),Me(e("div",Qh,[e("div",Zh,[m[69]||(m[69]=e("h2",{class:"section-title"},"Снаряжение",-1)),U(pi,{character:T.value,onUpdate:Ve},null,8,["character"])]),e("div",Jh,[m[70]||(m[70]=e("h2",{class:"section-title"},"Инвентарь",-1)),U(Ac,{character:T.value,onEquip:As},null,8,["character"])])],512),[[ws,oe.value==="items"]]),Me(e("div",eg,[e("div",tg,[U(f(K),{icon:"mdi:account-group",class:"placeholder-icon"}),m[71]||(m[71]=e("p",null,"Социальные связи",-1)),m[72]||(m[72]=e("span",{class:"placeholder-hint"},"В разработке",-1))])],512),[[ws,oe.value==="social"]]),Me(e("div",sg,[e("div",ng,[U(f(K),{icon:"mdi:auto-fix",class:"placeholder-icon"}),m[73]||(m[73]=e("p",null,"Магические способности",-1)),m[74]||(m[74]=e("span",{class:"placeholder-hint"},"В разработке",-1))])],512),[[ws,oe.value==="magic"]])])):(s(),n("div",lg,[U(f(K),{icon:"mdi:account-off",class:"empty-icon"}),m[75]||(m[75]=e("p",{class:"empty-title"},"У вас пока нет персонажей",-1)),m[76]||(m[76]=e("p",{class:"empty-hint"}," Чтобы создать нового персонажа, вам нужно получить приглашение от мастера. Оно отобразится на вкладке «Сцена». ",-1))])),(s(),Ke(Tt,{to:"body"},[Ze.value?(s(),n("div",{key:0,class:"master-modal-overlay",onClick:m[19]||(m[19]=A=>Ze.value=!1)},[e("div",{class:"master-modal master-modal-wide",onClick:m[18]||(m[18]=Fe(()=>{},["stop"]))},[e("div",ag,[m[77]||(m[77]=e("h3",null,"Основные данные",-1)),e("button",{class:"modal-close-btn",onClick:m[12]||(m[12]=A=>Ze.value=!1)},[U(f(K),{icon:"mdi:close"})])]),e("div",og,[e("div",ig,[m[78]||(m[78]=e("label",null,"Имя персонажа",-1)),Me(e("input",{type:"text","onUpdate:modelValue":m[13]||(m[13]=A=>We.value.name=A),class:"form-input",placeholder:"Введите имя..."},null,512),[[Be,We.value.name]])]),e("div",rg,[m[79]||(m[79]=e("label",null,"URL портрета",-1)),Me(e("input",{type:"text","onUpdate:modelValue":m[14]||(m[14]=A=>We.value.portrait=A),class:"form-input",placeholder:"https://..."},null,512),[[Be,We.value.portrait]]),We.value.portrait?(s(),n("div",cg,[e("img",{src:We.value.portrait,alt:"Превью"},null,8,dg)])):x("",!0)]),(bs=T.value)!=null&&bs.isNpc?(s(),n(W,{key:0},[e("div",ug,[m[80]||(m[80]=e("label",null,"Тип NPC",-1)),e("div",fg,[(s(),n(W,null,re(ct,A=>e("button",{key:A.id,class:te(["npc-type-btn",{active:We.value.npcType===A.id}]),style:Ne({"--type-color":A.color}),onClick:ze=>We.value.npcType=A.id},u(A.label),15,vg)),64))])]),e("div",mg,[e("label",pg,[Me(e("input",{type:"checkbox","onUpdate:modelValue":m[15]||(m[15]=A=>We.value.visibleToPlayers=A)},null,512),[[zs,We.value.visibleToPlayers]]),m[81]||(m[81]=e("span",null,"Видим игрокам на карте",-1))])]),e("div",hg,[m[82]||(m[82]=e("label",null,"Фракции",-1)),e("div",gg,[(s(!0),n(W,null,re(We.value.factions,A=>(s(),n("span",{key:A,class:"faction-tag"},[ke(u(A)+" ",1),e("button",{class:"faction-remove",onClick:ze=>ps(A)},"×",8,bg)]))),128))]),e("div",yg,[Me(e("input",{type:"text","onUpdate:modelValue":m[16]||(m[16]=A=>nt.value=A),class:"form-input",placeholder:"Новая фракция...",onKeyup:Un(et,["enter"])},null,544),[[Be,nt.value]]),e("button",{class:"add-faction-btn",onClick:et},[U(f(K),{icon:"mdi:plus"})])])])],64)):x("",!0)]),e("div",xg,[e("button",{class:"modal-btn cancel",onClick:m[17]||(m[17]=A=>Ze.value=!1)},"Отмена"),e("button",{class:"modal-btn save",onClick:J},"Сохранить")])])])):x("",!0)])),(s(),Ke(Tt,{to:"body"},[Dt.value?(s(),n("div",{key:0,class:"master-modal-overlay",onClick:m[31]||(m[31]=A=>Dt.value=!1)},[e("div",{class:"master-modal",onClick:m[30]||(m[30]=Fe(()=>{},["stop"]))},[e("div",kg,[m[83]||(m[83]=e("h3",null,"Настройки здоровья",-1)),e("button",{class:"modal-close-btn",onClick:m[20]||(m[20]=A=>Dt.value=!1)},[U(f(K),{icon:"mdi:close"})])]),e("div",wg,[e("div",_g,[m[86]||(m[86]=e("label",null,"Система здоровья",-1)),e("div",$g,[e("button",{class:te(["health-type-btn",{active:Ge.value.healthType==="simple"}]),onClick:m[21]||(m[21]=A=>Ge.value.healthType="simple")},[U(f(K),{icon:"mdi:heart"}),m[84]||(m[84]=e("span",null,"Простое HP",-1))],2),e("button",{class:te(["health-type-btn",{active:Ge.value.healthType==="wounds"}]),onClick:m[22]||(m[22]=A=>Ge.value.healthType="wounds")},[U(f(K),{icon:"mdi:bandage"}),m[85]||(m[85]=e("span",null,"Ранения",-1))],2)])]),Ge.value.healthType==="simple"?(s(),n("div",Cg,[m[87]||(m[87]=e("label",null,"Максимальное HP",-1)),Me(e("input",{type:"number","onUpdate:modelValue":m[23]||(m[23]=A=>Ge.value.maxHp=A),class:"form-input",min:"1",max:"100"},null,512),[[Be,Ge.value.maxHp,void 0,{number:!0}]])])):x("",!0),Ge.value.healthType==="wounds"?(s(),n(W,{key:1},[e("div",Tg,[e("div",Sg,[m[88]||(m[88]=e("label",null,"Царапины (макс.)",-1)),Me(e("input",{type:"number","onUpdate:modelValue":m[24]||(m[24]=A=>Ge.value.maxScratch=A),class:"form-input",min:"0",max:"10"},null,512),[[Be,Ge.value.maxScratch,void 0,{number:!0}]])]),e("div",Ig,[m[89]||(m[89]=e("label",null,"Лёгкие (макс.)",-1)),Me(e("input",{type:"number","onUpdate:modelValue":m[25]||(m[25]=A=>Ge.value.maxLight=A),class:"form-input",min:"0",max:"10"},null,512),[[Be,Ge.value.maxLight,void 0,{number:!0}]])]),e("div",Pg,[m[90]||(m[90]=e("label",null,"Тяжёлые (макс.)",-1)),Me(e("input",{type:"number","onUpdate:modelValue":m[26]||(m[26]=A=>Ge.value.maxHeavy=A),class:"form-input",min:"0",max:"10"},null,512),[[Be,Ge.value.maxHeavy,void 0,{number:!0}]])]),e("div",Eg,[m[91]||(m[91]=e("label",null,"Смертельные (макс.)",-1)),Me(e("input",{type:"number","onUpdate:modelValue":m[27]||(m[27]=A=>Ge.value.maxDeadly=A),class:"form-input",min:"1",max:"10"},null,512),[[Be,Ge.value.maxDeadly,void 0,{number:!0}]])])]),e("div",Mg,[m[92]||(m[92]=e("label",null,"Бонусные смертельные слоты",-1)),Me(e("input",{type:"number","onUpdate:modelValue":m[28]||(m[28]=A=>Ge.value.bonusDeadlySlots=A),class:"form-input",min:"0",max:"5"},null,512),[[Be,Ge.value.bonusDeadlySlots,void 0,{number:!0}]]),m[93]||(m[93]=e("p",{class:"form-hint"},"Добавляются к максимуму смертельных",-1))])],64)):x("",!0)]),e("div",Ag,[e("button",{class:"modal-btn cancel",onClick:m[29]||(m[29]=A=>Dt.value=!1)},"Отмена"),e("button",{class:"modal-btn save",onClick:Ms},"Сохранить")])])])):x("",!0)])),(s(),Ke(Tt,{to:"body"},[Re.value?(s(),n("div",{key:0,class:"master-modal-overlay",onClick:m[35]||(m[35]=A=>Re.value=!1)},[e("div",{class:"master-modal",onClick:m[34]||(m[34]=Fe(()=>{},["stop"]))},[e("div",Dg,[m[94]||(m[94]=e("h3",null,"Редактирование характеристик",-1)),e("button",{class:"modal-close-btn",onClick:m[32]||(m[32]=A=>Re.value=!1)},[U(f(K),{icon:"mdi:close"})])]),e("div",Ng,[e("div",Lg,[(s(!0),n(W,null,re(at.value,A=>{var ze;return s(),n("div",{key:A.id,class:"stat-editor-item",style:Ne({"--stat-color":A.color})},[e("div",Fg,[U(f(K),{icon:A.characteristicIcon||A.icon},null,8,["icon"]),e("span",null,u(((ze=A.characteristic)==null?void 0:ze.name)||A.name),1)]),Me(e("input",{type:"number","onUpdate:modelValue":bt=>rt.value[A.id]=bt,class:"stat-editor-input",min:"-5",max:"10"},null,8,Rg),[[Be,rt.value[A.id],void 0,{number:!0}]])],4)}),128))])]),e("div",Og,[e("button",{class:"modal-btn cancel",onClick:m[33]||(m[33]=A=>Re.value=!1)},"Отмена"),e("button",{class:"modal-btn save",onClick:tt},"Сохранить")])])])):x("",!0)])),(s(),Ke(Tt,{to:"body"},[it.value?(s(),n("div",{key:0,class:"master-modal-overlay",onClick:m[45]||(m[45]=A=>it.value=!1)},[e("div",{class:"master-modal master-modal-wide",onClick:m[44]||(m[44]=Fe(()=>{},["stop"]))},[e("div",Hg,[m[95]||(m[95]=e("h3",null,"Редактирование навыков",-1)),e("button",{class:"modal-close-btn",onClick:m[36]||(m[36]=A=>it.value=!1)},[U(f(K),{icon:"mdi:close"})])]),e("div",jg,[e("div",zg,[Me(e("select",{"onUpdate:modelValue":m[37]||(m[37]=A=>Xe.value=A),class:"skill-select"},[m[96]||(m[96]=e("option",{value:""},"Выберите навык...",-1)),(s(!0),n(W,null,re(N.value,A=>(s(),n("option",{key:A.id,value:A.id,disabled:Oe.value.some(ze=>ze.id===A.id)}," ["+u(A.sourceType==="class"?"Класс":"Аспект")+"] "+u(A.name)+" ("+u(A.sourceName)+") ",9,Ug))),128))],512),[[Lt,Xe.value]]),Me(e("select",{"onUpdate:modelValue":m[38]||(m[38]=A=>je.value=A),class:"level-select"},[...m[97]||(m[97]=[e("option",{value:1},"Ур. 1",-1),e("option",{value:2},"Ур. 2",-1),e("option",{value:3},"Ур. 3",-1)])],512),[[Lt,je.value,void 0,{number:!0}]]),e("button",{class:"add-skill-btn",onClick:p,disabled:!Xe.value},[U(f(K),{icon:"mdi:plus"})],8,Bg)]),e("div",Wg,[z.value?(s(),n("div",qg,[Me(e("input",{"onUpdate:modelValue":m[40]||(m[40]=A=>dt.value=A),placeholder:"Название навыка",class:"custom-skill-input"},null,512),[[Be,dt.value]]),Me(e("textarea",{"onUpdate:modelValue":m[41]||(m[41]=A=>ht.value=A),placeholder:"Описание (опционально)",class:"custom-skill-textarea",rows:"2"},null,512),[[Be,ht.value]]),e("div",Vg,[e("button",{class:"modal-btn cancel",onClick:m[42]||(m[42]=A=>z.value=!1)},"Отмена"),e("button",{class:"modal-btn save",onClick:G},"Добавить")])])):(s(),n("button",{key:0,class:"add-custom-skill-btn",onClick:m[39]||(m[39]=A=>z.value=!0)},[U(f(K),{icon:"mdi:plus-circle-outline"}),m[98]||(m[98]=ke(" Добавить особый навык ",-1))]))]),Oe.value.length?(s(),n("div",Xg,[(s(!0),n(W,null,re(Oe.value,A=>{var ze,bt;return s(),n("div",{key:A.id,class:te(["skill-editor-item",{"custom-skill":A.id.startsWith("custom_")}])},[e("div",Yg,[e("span",Gg,u(A.customName||((ze=se(A.id))==null?void 0:ze.name)||A.id),1),(bt=se(A.id))!=null&&bt.sourceName?(s(),n("span",Kg,u(se(A.id).sourceName),1)):A.id.startsWith("custom_")?(s(),n("span",Qg," Особый ")):x("",!0)]),e("select",{value:A.level,onChange:Pt=>$(A.id,Pt.target.value),class:"level-select"},[...m[99]||(m[99]=[e("option",{value:1},"Ур. 1",-1),e("option",{value:2},"Ур. 2",-1),e("option",{value:3},"Ур. 3",-1)])],40,Zg),e("button",{class:"remove-skill-btn",onClick:Pt=>k(A.id)},[U(f(K),{icon:"mdi:close"})],8,Jg)],2)}),128))])):(s(),n("div",e1," Навыки не добавлены "))]),e("div",t1,[e("button",{class:"modal-btn cancel",onClick:m[43]||(m[43]=A=>it.value=!1)},"Отмена"),e("button",{class:"modal-btn save",onClick:ue},"Сохранить")])])])):x("",!0)]))],2)}}},Rn=wt(s1,[["__scopeId","data-v-c7a814cf"]]),n1={class:"tools-header"},l1={class:"tools-title"},a1={class:"tools-grid"},o1=["onClick"],i1={class:"tool-label"},r1={key:0,class:"tool-form"},c1={class:"form-group"},d1={class:"checkbox-label"},u1={class:"form-group"},f1={class:"check-type-grid"},v1=["onClick"],m1={class:"form-group"},p1={class:"difficulty-slider-container"},h1=["max"],g1={class:"difficulty-marks"},b1=["title"],y1={class:"form-group"},x1={class:"checkbox-label"},k1={class:"form-group"},w1={class:"form-group"},_1=["value"],$1={class:"form-group"},C1={key:0,class:"image-preview"},T1=["src"],S1={class:"form-group"},I1={class:"form-group"},P1={class:"form-group"},E1={class:"form-group"},M1={class:"icon-picker"},A1=["title","onClick"],D1={class:"form-group"},N1={class:"form-group"},L1={class:"form-group"},F1={key:6,class:"form-row"},R1={class:"form-group flex-1"},O1={class:"form-group quantity"},H1={class:"constraints-section"},j1={key:0,class:"constraints-badge"},z1={key:0,class:"constraints-body"},U1={class:"constraint-group"},B1={class:"chips-grid"},W1=["onClick"],q1={class:"constraint-group"},V1={class:"chips-grid"},X1=["onClick"],Y1={class:"constraint-row"},G1={class:"constraint-slider"},K1={class:"constraint-slider"},Q1={key:8,class:"send-section"},Z1={class:"recipients-grid"},J1=["disabled","onClick","title"],eb={key:1,class:"char-initial"},tb={class:"recipient-info"},sb={class:"recipient-name"},nb=["disabled"],lb={key:9,class:"send-section"},ab={class:"recipients-grid"},ob=["disabled","onClick","title"],ib={key:1,class:"char-initial"},rb={class:"recipient-info"},cb={class:"recipient-name"},db={class:"recipient-char"},ub=["disabled"],fb={key:0,class:"save-template-form"},vb={class:"template-form-header"},mb={class:"form-group"},pb={class:"form-group"},hb={class:"form-group"},gb={class:"icon-picker"},bb=["onClick","title"],yb={class:"form-group"},xb={class:"color-picker"},kb=["onClick"],wb=["disabled"],_b={__name:"MasterSceneTools",props:{compact:{type:Boolean,default:!1}},emits:["close","event-sent","templates-updated"],setup(t,{expose:o,emit:a}){const l=a,i=Ys(),d=Rt(),v=Bt();ms();const E=ss(),{connections:g}=pt(d),b=Q(null),I=[{id:"text",label:"Текст",icon:"mdi:message-text",color:"#94a3b8"},{id:"skill-check",label:"Проверка",icon:"mdi:dice-d20",color:"#f59e0b"},{id:"battle-invite",label:"В бой",icon:"mdi:sword-cross",color:"#ef4444"},{id:"image",label:"Картинка",icon:"mdi:image",color:"#8b5cf6"},{id:"important",label:"Важное",icon:"mdi:alert-circle",color:"#f59e0b"},{id:"quest",label:"Квест",icon:"mdi:map-marker-star",color:"#eab308"},{id:"item-give",label:"Предмет",icon:"mdi:gift",color:"#22c55e"},{id:"character-invite",label:"Персонаж",icon:"mdi:account-plus",color:"#3b82f6"}],M=p=>{b.value=b.value===p?null:p,D()},R=Q({text:"",isSecret:!1}),T=Q({checkType:"war",difficultyIndex:3,description:"",isSecret:!1}),F=Q({description:"",mapId:""}),Z=Q({url:"",description:""}),j=Q({title:"",text:"",icon:"mdi:alert-circle"}),oe=Q({title:"",description:"",objectives:""}),ie=Q({itemName:"",quantity:1,description:""}),ne=Q({allowedRaces:[],allowedSubraces:[],allowedClasses:[],maxWealth:5,maxEpoch:5}),O=Q(new Set),S=Q(new Set),D=()=>{R.value={text:"",isSecret:!1},T.value={checkType:"war",difficultyIndex:3,description:"",isSecret:!1},F.value={description:"",mapId:""},Z.value={url:"",description:""},j.value={title:"",text:"",icon:"mdi:alert-circle"},oe.value={title:"",description:"",objectives:""},ie.value={itemName:"",quantity:1,description:""},ne.value={allowedRaces:[],allowedSubraces:[],allowedClasses:[],maxWealth:5,maxEpoch:5},O.value=new Set,S.value=new Set},r=Q([]),h=Q(!1),_=Q(""),P=Q("mdi:file-document"),B=Q("#3b82f6"),ce=Q(""),Y=[{icon:"mdi:skull",label:"Монстр"},{icon:"mdi:spider",label:"Паук"},{icon:"mdi:snake",label:"Змея"},{icon:"mdi:bat",label:"Летучая мышь"},{icon:"mdi:ghost",label:"Призрак"},{icon:"mdi:alien",label:"Пришелец"},{icon:"mdi:paw",label:"Зверь"},{icon:"mdi:bird",label:"Птица"},{icon:"mdi:fish",label:"Рыба"},{icon:"mdi:bug",label:"Насекомое"},{icon:"mdi:castle",label:"Замок"},{icon:"mdi:home",label:"Дом"},{icon:"mdi:pine-tree",label:"Лес"},{icon:"mdi:terrain",label:"Горы"},{icon:"mdi:waves",label:"Вода"},{icon:"mdi:fire",label:"Огонь"},{icon:"mdi:weather-sunny",label:"Солнце"},{icon:"mdi:weather-night",label:"Ночь"},{icon:"mdi:city",label:"Город"},{icon:"mdi:bridge",label:"Мост"},{icon:"mdi:sword-cross",label:"Бой"},{icon:"mdi:treasure-chest",label:"Сокровище"},{icon:"mdi:map-marker",label:"Локация"},{icon:"mdi:alert-circle",label:"Важное"},{icon:"mdi:help-circle",label:"Загадка"},{icon:"mdi:account-group",label:"НПС"},{icon:"mdi:script-text",label:"Текст"},{icon:"mdi:image",label:"Картинка"},{icon:"mdi:star",label:"Особое"},{icon:"mdi:flag",label:"Квест"}],ve=["#ef4444","#f97316","#eab308","#22c55e","#14b8a6","#3b82f6","#8b5cf6","#ec4899","#64748b","#78716c"],H=Q(!1),y=X(()=>{var k,$,se;const p=ne.value;return((k=p.allowedRaces)==null?void 0:k.length)>0||(($=p.allowedClasses)==null?void 0:$.length)>0||((se=p.allowedSubraces)==null?void 0:se.length)>0||p.maxWealth<5||p.maxEpoch<5}),L=X(()=>{var $,se,G;const p=ne.value;let k=0;return(($=p.allowedRaces)==null?void 0:$.length)>0&&(k+=p.allowedRaces.length),((se=p.allowedClasses)==null?void 0:se.length)>0&&(k+=p.allowedClasses.length),((G=p.allowedSubraces)==null?void 0:G.length)>0&&(k+=p.allowedSubraces.length),p.maxWealth<5&&k++,p.maxEpoch<5&&k++,k}),le=(p,k)=>{const $=ne.value[p],se=$.indexOf(k);se===-1?$.push(k):$.splice(se,1)},V=X(()=>vs.classes.filter(p=>{var $;return(($=p.aspects)==null?void 0:$.length)!==2||!p.edges||p.edges.length===0?!1:p.edges.every(se=>se.type==="aspect")})),de=()=>{ne.value.allowedClasses=V.value.map(p=>p.id)};Ut(()=>{const p=localStorage.getItem("scene-templates-v2");if(p)try{r.value=JSON.parse(p)}catch(k){console.error("Failed to load templates:",k),r.value=[]}});const Se=()=>{localStorage.setItem("scene-templates-v2",JSON.stringify(r.value))},fe=()=>{if(!_.value.trim()||!lt.value)return;const p=tt();if(!p)return;const k={id:Date.now().toString(),name:_.value.trim(),icon:P.value,color:B.value,tags:ce.value.split(",").map($=>$.trim()).filter(Boolean),tool:b.value,data:p,sent:!1};r.value.push(k),Se(),l("templates-updated",r.value),h.value=!1,_.value="",ce.value=""},he=p=>{r.value=r.value.filter(k=>k.id!==p),Se(),l("templates-updated",r.value)},we=p=>{const k=r.value.find($=>$.id===p);k&&(k.sent=!k.sent,Se(),l("templates-updated",r.value))},De=p=>{const k=r.value.find($=>$.id===p);k&&(k.sent=!0,Se(),l("templates-updated",r.value))},ye=Q(null),xe=p=>{switch(b.value=p.tool,ye.value=p.id,p.tool){case"text":R.value={text:p.data.text||"",isSecret:p.data.isSecret||!1};break;case"skill-check":const k=qe.value.findIndex($=>$.value===p.data.difficulty);T.value={checkType:p.data.checkType||"war",difficultyIndex:k>=0?k:3,description:p.data.description||"",isSecret:p.data.isSecret||!1};break;case"image":Z.value={url:p.data.url||"",description:p.data.description||""};break;case"important":j.value={title:p.data.title||"",text:p.data.text||"",icon:p.data.icon||"mdi:alert-circle"};break;case"quest":oe.value={title:p.data.title||"",description:p.data.description||"",objectives:p.data.objectives||""};break;case"item-give":ie.value={itemName:p.data.itemName||"",quantity:p.data.quantity||1,description:p.data.description||""};break;case"battle-invite":F.value={description:p.data.description||"",mapId:p.data.mapId||""};break;case"character-invite":p.data.constraints&&(ne.value={allowedRaces:p.data.constraints.allowedRaces||[],allowedSubraces:p.data.constraints.allowedSubraces||[],allowedClasses:p.data.constraints.allowedClasses||[],maxWealth:p.data.constraints.maxWealth??5,maxEpoch:p.data.constraints.maxEpoch??5});break}},Le=X(()=>kt.aspects.map(p=>({id:p.id,name:p.check.name,color:p.color,icon:p.checkIcon}))),qe=X(()=>{const p=[];return Object.keys($t).map(Number).sort(($,se)=>$-se).forEach($=>{p.push({value:$,...$t[$]})}),p}),Qe=X(()=>{const p=T.value.difficultyIndex;return qe.value[p]||qe.value[0]}),Ve=X(()=>v.allPlayerCharacters.map(k=>{var G;const $=g.value.find(ue=>ue.userId===k.ownerId),se=((G=$==null?void 0:$.conn)==null?void 0:G.open)||!1;return{characterId:k.id,characterName:k.name,characterPortrait:k.portrait,ownerId:k.ownerId,ownerName:k.ownerNickname||($==null?void 0:$.alias)||"Игрок",online:se,sent:O.value.has(k.id)}})),Re=X(()=>d.allPlayers.map(p=>({userId:p.userId,alias:p.alias,avatar:p.avatar,online:p.online,sent:S.value.has(p.userId)}))),rt=X(()=>Re.value.length===0?!1:Re.value.every(p=>p.sent));Q(!1);const at=X(()=>Ve.value.length===0?!1:Ve.value.every(p=>p.sent)),lt=X(()=>{switch(b.value){case"text":return R.value.text.trim().length>0;case"skill-check":return!0;case"battle-invite":return!0;case"image":return Z.value.url.trim().length>0;case"important":return j.value.title.trim().length>0;case"quest":return oe.value.title.trim().length>0;case"item-give":return ie.value.itemName.trim().length>0;case"character-invite":return!0;default:return!1}}),tt=()=>{switch(b.value){case"text":return R.value.text.trim()?{type:Ee.TEXT,text:R.value.text.trim(),isSecret:R.value.isSecret}:null;case"skill-check":const p=Qe.value;return{type:Ee.SKILL_CHECK,checkType:T.value.checkType,difficulty:p.value,difficultyName:p.name,difficultyColor:p.color,isSecret:T.value.isSecret,description:T.value.description,completed:!1,result:null};case"battle-invite":return{type:Ee.BATTLE_INVITE,description:F.value.description,mapId:F.value.mapId||null};case"image":return Z.value.url.trim()?{type:Ee.IMAGE,url:Z.value.url.trim(),description:Z.value.description}:null;case"important":return j.value.title.trim()?{type:Ee.IMPORTANT,title:j.value.title.trim(),text:j.value.text,icon:j.value.icon}:null;case"quest":if(!oe.value.title.trim())return null;const k=oe.value.objectives.split(`
`).filter($=>$.trim()).map($=>({text:$.trim(),completed:!1}));return{type:Ee.QUEST,title:oe.value.title.trim(),description:oe.value.description,objectives:k};case"item-give":return ie.value.itemName.trim()?{type:Ee.ITEM_GIVE,items:[{id:crypto.randomUUID(),name:ie.value.itemName.trim(),quantity:ie.value.quantity}],description:ie.value.description,accepted:!1}:null;case"character-invite":return{type:Ee.CHARACTER_INVITE,constraints:{allowedRaces:ne.value.allowedRaces||[],allowedSubraces:ne.value.allowedSubraces||[],allowedClasses:ne.value.allowedClasses||[],maxWealth:ne.value.maxWealth??10,maxEpoch:ne.value.maxEpoch??10},accepted:!1};default:return null}},it=p=>{var ct;const k=tt();if(!k)return;const $=v.characters.find(ot=>ot.id===p);if(!$)return;const se=$.ownerId,G={...k,targetCharacterIds:[p],targetUserIds:[se],targetCharacterName:$.name,targetCharacterPortrait:$.portrait},ue=g.value.find(ot=>ot.userId===se),Ze=(ct=ue==null?void 0:ue.conn)==null?void 0:ct.open,We=i.addEvent({...G,deliveredTo:Ze?[se]:[]});Ze&&ue.conn.send({type:"scene-event",event:We}),O.value.add(p),O.value=new Set(O.value),l("event-sent",We)},Oe=()=>{const p=tt();if(!p)return;const k=Ve.value;k.map(ue=>ue.characterId);const $=k.filter(ue=>ue.online).map(ue=>ue.ownerId),se={...p,targetCharacterIds:null,targetUserIds:null,deliveredTo:$},G=i.addEvent(se);d.broadcastPayload({type:"scene-event",event:G}),ye.value&&(De(ye.value),ye.value=null),l("event-sent",G),b.value=null,D()},Xe=p=>{var We;const k=tt();if(!k||k.type!==Ee.CHARACTER_INVITE||!Re.value.find(ct=>ct.userId===p))return;const se={...k,targetUserIds:[p],targetCharacterIds:null,usedBy:[]},G=g.value.find(ct=>ct.userId===p),ue=(We=G==null?void 0:G.conn)==null?void 0:We.open,Ze=i.addEvent({...se,deliveredTo:ue?[p]:[]});ue&&G.conn.send({type:"scene-event",event:Ze}),S.value.add(p),S.value=new Set(S.value),l("event-sent",Ze)},je=()=>{const p=tt();if(!p||p.type!==Ee.CHARACTER_INVITE)return;const $=Re.value.filter(ue=>ue.online).map(ue=>ue.userId),se={...p,targetUserIds:null,targetCharacterIds:null,usedBy:[],deliveredTo:$},G=i.addEvent(se);d.broadcastPayload({type:"scene-event",event:G}),ye.value&&(De(ye.value),ye.value=null),l("event-sent",G),b.value=null,D()},dt=p=>{b.value==="image"&&(i.setSceneImage(Z.value.url.trim(),Z.value.description,d.userId),it(p))},ht=()=>{b.value==="image"&&(i.setSceneImage(Z.value.url.trim(),Z.value.description,d.userId),Oe())},z=()=>{i.clearSceneImage(),d.broadcastPayload({type:"scene-event",event:{id:crypto.randomUUID(),type:Ee.CLEAR_IMAGE,time:Date.now()}})},N=()=>{b.value=null,ye.value=null,D()},me=[{value:"mdi:alert-circle",label:"Внимание"},{value:"mdi:information",label:"Информация"},{value:"mdi:star",label:"Важно"},{value:"mdi:shield",label:"Защита"},{value:"mdi:skull",label:"Опасность"},{value:"mdi:treasure-chest",label:"Награда"}];return o({templates:r,loadTemplate:xe,deleteTemplate:he,toggleTemplateSent:we}),(p,k)=>(s(),n("div",{class:te(["master-scene-tools",{compact:t.compact}])},[e("div",n1,[e("h3",l1,[U(f(K),{icon:"mdi:broadcast"}),k[29]||(k[29]=ke(" Инструменты сцены ",-1))]),t.compact?(s(),n("button",{key:0,class:"close-btn",onClick:k[0]||(k[0]=$=>l("close"))},[U(f(K),{icon:"mdi:close"})])):x("",!0)]),e("div",a1,[(s(),n(W,null,re(I,$=>e("button",{key:$.id,class:te(["tool-btn",{active:b.value===$.id}]),style:Ne({"--tool-color":$.color}),onClick:se=>M($.id)},[U(f(K),{icon:$.icon,class:"tool-icon"},null,8,["icon"]),e("span",i1,u($.label),1)],14,o1)),64))]),U(us,{name:"slide-down"},{default:Zt(()=>[b.value?(s(),n("div",r1,[b.value==="text"?(s(),n(W,{key:0},[e("div",c1,[k[30]||(k[30]=e("label",null,"Сообщение",-1)),Me(e("textarea",{"onUpdate:modelValue":k[1]||(k[1]=$=>R.value.text=$),placeholder:"Введите текст...",rows:"3"},null,512),[[Be,R.value.text]])]),e("label",d1,[Me(e("input",{type:"checkbox","onUpdate:modelValue":k[2]||(k[2]=$=>R.value.isSecret=$)},null,512),[[zs,R.value.isSecret]]),k[31]||(k[31]=ke(" Секретно (только видевшие увидят) ",-1))])],64)):b.value==="skill-check"?(s(),n(W,{key:1},[e("div",u1,[k[32]||(k[32]=e("label",null,"Тип проверки",-1)),e("div",f1,[(s(!0),n(W,null,re(Le.value,$=>(s(),n("button",{key:$.id,type:"button",class:te(["check-type-btn",{active:T.value.checkType===$.id}]),style:Ne({"--check-color":$.color}),onClick:se=>T.value.checkType=$.id},[U(f(K),{icon:$.icon,class:"check-type-icon"},null,8,["icon"]),e("span",null,u($.name),1)],14,v1))),128))])]),e("div",m1,[e("label",null,[k[33]||(k[33]=ke(" Сложность: ",-1)),e("span",{class:"difficulty-badge",style:Ne({backgroundColor:Qe.value.color,color:Qe.value.lightText?"#fff":"#000"})},u(Qe.value.name)+" ("+u(Qe.value.value)+") ",5)]),e("div",p1,[Me(e("input",{type:"range","onUpdate:modelValue":k[3]||(k[3]=$=>T.value.difficultyIndex=$),min:0,max:qe.value.length-1,class:"difficulty-slider",style:Ne({"--slider-color":Qe.value.color})},null,12,h1),[[Be,T.value.difficultyIndex,void 0,{number:!0}]]),e("div",g1,[(s(!0),n(W,null,re(qe.value,($,se)=>(s(),n("span",{key:$.value,class:te(["difficulty-mark",{active:se===T.value.difficultyIndex}]),style:Ne({left:`${se/(qe.value.length-1)*100}%`}),title:$.name},[e("span",{class:"mark-dot",style:Ne({backgroundColor:$.color})},null,4)],14,b1))),128))])])]),e("div",y1,[k[34]||(k[34]=e("label",null,"Описание (опц.)",-1)),Me(e("input",{type:"text","onUpdate:modelValue":k[4]||(k[4]=$=>T.value.description=$),placeholder:"Что проверяем?"},null,512),[[Be,T.value.description]])]),e("label",x1,[Me(e("input",{type:"checkbox","onUpdate:modelValue":k[5]||(k[5]=$=>T.value.isSecret=$)},null,512),[[zs,T.value.isSecret]]),k[35]||(k[35]=ke(" Секретная проверка ",-1))])],64)):b.value==="battle-invite"?(s(),n(W,{key:2},[e("div",k1,[k[36]||(k[36]=e("label",null,"Описание (опц.)",-1)),Me(e("input",{type:"text","onUpdate:modelValue":k[6]||(k[6]=$=>F.value.description=$),placeholder:"Начало битвы..."},null,512),[[Be,F.value.description]])]),e("div",w1,[k[38]||(k[38]=e("label",null,"Карта сражения (опц.)",-1)),Me(e("select",{"onUpdate:modelValue":k[7]||(k[7]=$=>F.value.mapId=$)},[k[37]||(k[37]=e("option",{value:""},"Текущая карта",-1)),(s(!0),n(W,null,re(f(E).maps,$=>(s(),n("option",{key:$.id,value:$.id},u($.name||"Карта "+$.id.slice(0,6)),9,_1))),128))],512),[[Lt,F.value.mapId]])])],64)):b.value==="image"?(s(),n(W,{key:3},[e("div",$1,[k[39]||(k[39]=e("label",null,"URL изображения",-1)),Me(e("input",{type:"url","onUpdate:modelValue":k[8]||(k[8]=$=>Z.value.url=$),placeholder:"https://..."},null,512),[[Be,Z.value.url]])]),Z.value.url.trim()?(s(),n("div",C1,[e("img",{src:Z.value.url,alt:"Предпросмотр",onError:k[9]||(k[9]=$=>$.target.style.display="none"),onLoad:k[10]||(k[10]=$=>$.target.style.display="block")},null,40,T1)])):x("",!0),e("div",S1,[k[40]||(k[40]=e("label",null,"Описание",-1)),Me(e("textarea",{"onUpdate:modelValue":k[11]||(k[11]=$=>Z.value.description=$),placeholder:"Что на картинке?",rows:"2"},null,512),[[Be,Z.value.description]])]),e("button",{class:"clear-btn",onClick:z},[U(f(K),{icon:"mdi:image-off"}),k[41]||(k[41]=ke(" Очистить изображение сцены ",-1))])],64)):b.value==="important"?(s(),n(W,{key:4},[e("div",I1,[k[42]||(k[42]=e("label",null,"Заголовок",-1)),Me(e("input",{type:"text","onUpdate:modelValue":k[12]||(k[12]=$=>j.value.title=$),placeholder:"Важное событие!"},null,512),[[Be,j.value.title]])]),e("div",P1,[k[43]||(k[43]=e("label",null,"Текст",-1)),Me(e("textarea",{"onUpdate:modelValue":k[13]||(k[13]=$=>j.value.text=$),placeholder:"Подробности...",rows:"2"},null,512),[[Be,j.value.text]])]),e("div",E1,[k[44]||(k[44]=e("label",null,"Иконка",-1)),e("div",M1,[(s(),n(W,null,re(me,$=>e("button",{key:$.value,type:"button",class:te(["icon-option",{active:j.value.icon===$.value}]),title:$.label,onClick:se=>j.value.icon=$.value},[U(f(K),{icon:$.value},null,8,["icon"])],10,A1)),64))])])],64)):b.value==="quest"?(s(),n(W,{key:5},[e("div",D1,[k[45]||(k[45]=e("label",null,"Название квеста",-1)),Me(e("input",{type:"text","onUpdate:modelValue":k[14]||(k[14]=$=>oe.value.title=$),placeholder:"Найти сокровище..."},null,512),[[Be,oe.value.title]])]),e("div",N1,[k[46]||(k[46]=e("label",null,"Описание",-1)),Me(e("textarea",{"onUpdate:modelValue":k[15]||(k[15]=$=>oe.value.description=$),placeholder:"Подробности задания...",rows:"2"},null,512),[[Be,oe.value.description]])]),e("div",L1,[k[47]||(k[47]=e("label",null,"Цели (по одной на строку)",-1)),Me(e("textarea",{"onUpdate:modelValue":k[16]||(k[16]=$=>oe.value.objectives=$),placeholder:`Поговорить с NPC
Найти ключ
Открыть дверь`,rows:"3"},null,512),[[Be,oe.value.objectives]])])],64)):b.value==="item-give"?(s(),n("div",F1,[e("div",R1,[k[48]||(k[48]=e("label",null,"Предмет",-1)),Me(e("input",{type:"text","onUpdate:modelValue":k[17]||(k[17]=$=>ie.value.itemName=$),placeholder:"Зелье здоровья"},null,512),[[Be,ie.value.itemName]])]),e("div",O1,[k[49]||(k[49]=e("label",null,"Кол-во",-1)),Me(e("input",{type:"number","onUpdate:modelValue":k[18]||(k[18]=$=>ie.value.quantity=$),min:"1"},null,512),[[Be,ie.value.quantity,void 0,{number:!0}]])])])):b.value==="character-invite"?(s(),n(W,{key:7},[k[53]||(k[53]=e("p",{class:"form-hint"},"Игрок получит приглашение создать нового персонажа",-1)),e("div",H1,[e("div",{class:"constraints-header",onClick:k[19]||(k[19]=$=>H.value=!H.value)},[U(f(K),{icon:H.value?"mdi:chevron-down":"mdi:chevron-right"},null,8,["icon"]),k[50]||(k[50]=e("span",null,"Ограничения",-1)),y.value?(s(),n("span",j1,u(L.value),1)):x("",!0)]),H.value?(s(),n("div",z1,[e("div",U1,[k[51]||(k[51]=e("label",null,[ke("Разрешённые расы "),e("span",{class:"hint"},"(пусто = все)")],-1)),e("div",B1,[(s(!0),n(W,null,re(f(Zs).races,$=>(s(),n("button",{key:$.id,class:te(["chip",{active:ne.value.allowedRaces.includes($.id)}]),onClick:se=>le("allowedRaces",$.id)},u($.name),11,W1))),128))])]),e("div",q1,[e("div",{class:"constraint-header"},[k[52]||(k[52]=e("label",null,[ke("Разрешённые классы "),e("span",{class:"hint"},"(пусто = все)")],-1)),e("button",{class:"preset-btn",onClick:de,title:"Только внутренние классы (между двумя аспектами)"}," ⚙️ Внутренние ")]),e("div",V1,[(s(!0),n(W,null,re(f(vs).classes,$=>(s(),n("button",{key:$.id,class:te(["chip",{active:ne.value.allowedClasses.includes($.id)}]),onClick:se=>le("allowedClasses",$.id)},u(typeof $.name=="object"?$.name.m:$.name),11,X1))),128))])]),e("div",Y1,[e("div",G1,[e("label",null,"Благосостояние: "+u(ne.value.maxWealth),1),Me(e("input",{type:"range",min:"1",max:"10","onUpdate:modelValue":k[20]||(k[20]=$=>ne.value.maxWealth=$)},null,512),[[Be,ne.value.maxWealth,void 0,{number:!0}]])]),e("div",K1,[e("label",null,"Эпоха: "+u(ne.value.maxEpoch),1),Me(e("input",{type:"range",min:"1",max:"10","onUpdate:modelValue":k[21]||(k[21]=$=>ne.value.maxEpoch=$)},null,512),[[Be,ne.value.maxEpoch,void 0,{number:!0}]])])])])):x("",!0)])],64)):x("",!0),b.value==="character-invite"?(s(),n("div",Q1,[k[56]||(k[56]=e("div",{class:"send-label"},"Отправить игроку:",-1)),e("div",Z1,[(s(!0),n(W,null,re(Re.value,$=>(s(),n("button",{key:$.userId,class:te(["recipient-btn",{sent:$.sent,offline:!$.online}]),disabled:!lt.value||$.sent,onClick:se=>Xe($.userId),title:$.sent?`Отправлено: ${$.alias}`:`Отправить: ${$.alias}`+($.online?"":" (офлайн)")},[$.avatar?(s(),Ke(Gt,{key:0,avatar:$.avatar,size:"md",class:"player-avatar"},null,8,["avatar"])):(s(),n("div",eb,u(($.alias||"?")[0].toUpperCase()),1)),e("div",tb,[e("span",sb,u($.alias),1)]),$.sent?(s(),Ke(f(K),{key:2,icon:"mdi:check-circle",class:"sent-icon"})):$.online?x("",!0):(s(),Ke(f(K),{key:3,icon:"mdi:wifi-off",class:"offline-icon"}))],10,J1))),128))]),e("button",{class:te(["send-all-btn",{sent:rt.value}]),disabled:!lt.value,onClick:k[22]||(k[22]=$=>je())},[U(f(K),{icon:"mdi:account-group"}),k[54]||(k[54]=e("span",null,"Отправить всем",-1))],10,nb),lt.value&&!h.value?(s(),n("button",{key:0,class:"template-btn",onClick:k[23]||(k[23]=$=>h.value=!0),title:"Сохранить как шаблон"},[U(f(K),{icon:"mdi:content-save-plus"})])):x("",!0),S.value.size>0?(s(),n("button",{key:1,class:"finish-btn",onClick:N},[U(f(K),{icon:"mdi:check"}),k[55]||(k[55]=ke(" Готово ",-1))])):x("",!0)])):(s(),n("div",lb,[k[59]||(k[59]=e("div",{class:"send-label"},"Отправить:",-1)),e("div",ab,[(s(!0),n(W,null,re(Ve.value,$=>(s(),n("button",{key:$.characterId,class:te(["recipient-btn",{sent:$.sent,offline:!$.online}]),disabled:!lt.value||$.sent,onClick:se=>b.value==="image"?dt($.characterId):it($.characterId),title:$.sent?`Отправлено: ${$.characterName}`:`Отправить: ${$.characterName}`+($.online?"":" (игрок офлайн)")},[$.characterPortrait?(s(),Ke(zt,{key:0,portrait:$.characterPortrait,size:44,showBorder:!0},null,8,["portrait"])):(s(),n("div",ib,u(($.characterName||"?")[0].toUpperCase()),1)),e("div",rb,[e("span",cb,u($.characterName),1),e("span",db,u($.ownerName),1)]),$.sent?(s(),Ke(f(K),{key:2,icon:"mdi:check-circle",class:"sent-icon"})):$.online?x("",!0):(s(),Ke(f(K),{key:3,icon:"mdi:wifi-off",class:"offline-icon"}))],10,ob))),128))]),e("button",{class:te(["send-all-btn",{sent:at.value}]),disabled:!lt.value,onClick:k[24]||(k[24]=$=>b.value==="image"?ht():Oe())},[U(f(K),{icon:"mdi:account-group"}),k[57]||(k[57]=e("span",null,"Отправить всем",-1))],10,ub),lt.value&&!h.value?(s(),n("button",{key:0,class:"template-btn",onClick:k[25]||(k[25]=$=>h.value=!0),title:"Сохранить как шаблон"},[U(f(K),{icon:"mdi:content-save-plus"})])):x("",!0),O.value.size>0?(s(),n("button",{key:1,class:"finish-btn",onClick:N},[U(f(K),{icon:"mdi:check"}),k[58]||(k[58]=ke(" Готово ",-1))])):x("",!0)])),U(us,{name:"slide-down"},{default:Zt(()=>[h.value?(s(),n("div",fb,[e("div",vb,[k[60]||(k[60]=e("span",null,"Сохранить как шаблон",-1)),e("button",{class:"close-btn",onClick:k[26]||(k[26]=$=>h.value=!1)},[U(f(K),{icon:"mdi:close"})])]),e("div",mb,[k[61]||(k[61]=e("label",null,"Название",-1)),Me(e("input",{"onUpdate:modelValue":k[27]||(k[27]=$=>_.value=$),type:"text",placeholder:"Название шаблона...",class:"form-input"},null,512),[[Be,_.value]])]),e("div",pb,[k[62]||(k[62]=e("label",null,"Теги (через запятую)",-1)),Me(e("input",{"onUpdate:modelValue":k[28]||(k[28]=$=>ce.value=$),type:"text",placeholder:"монстр, босс, подземелье...",class:"form-input"},null,512),[[Be,ce.value]])]),e("div",hb,[k[63]||(k[63]=e("label",null,"Иконка",-1)),e("div",gb,[(s(),n(W,null,re(Y,$=>e("button",{key:$.icon,class:te(["icon-option",{active:P.value===$.icon}]),style:Ne({color:P.value===$.icon?B.value:void 0}),onClick:se=>P.value=$.icon,title:$.label},[U(f(K),{icon:$.icon},null,8,["icon"])],14,bb)),64))])]),e("div",yb,[k[64]||(k[64]=e("label",null,"Цвет",-1)),e("div",xb,[(s(),n(W,null,re(ve,$=>e("button",{key:$,class:te(["color-option",{active:B.value===$}]),style:Ne({background:$}),onClick:se=>B.value=$},null,14,kb)),64))])]),e("button",{class:"save-template-btn",disabled:!_.value.trim(),onClick:fe},[U(f(K),{icon:"mdi:content-save"}),k[65]||(k[65]=ke(" Сохранить шаблон ",-1))],8,wb)])):x("",!0)]),_:1})])):x("",!0)]),_:1})],2))}},$b=wt(_b,[["__scopeId","data-v-5670e115"]]),Cb={class:"bg-slate-900/60 border border-white/10 rounded-2xl p-6 space-y-4"},Tb={class:"flex items-center justify-between gap-3"},Sb={class:"text-xs px-3 py-1 rounded-full border border-white/10 uppercase tracking-wide text-slate-400"},Ib=["disabled"],Pb={key:0,class:"flex flex-col gap-3"},Eb={class:"flex items-center gap-2"},Mb={class:"flex-1 rounded-xl border border-white/10 px-4 py-3 font-mono text-xl tracking-[0.3em] text-center"},Ab=["disabled"],Db={key:1,class:"space-y-2"},Nb={class:"space-y-2"},Lb={class:"font-medium"},Fb={class:"text-xs text-slate-400"},Rb={key:2,class:"text-sm text-rose-300"},Ob={__name:"MasterTools",setup(t){const o=Rt(),{roomId:a,status:l,error:i,connections:d}=pt(o),v=X(()=>l.value==="connecting"),E=X(()=>!!a.value),g=X(()=>E.value&&!v.value),b=()=>{v.value||(E.value?o.createNewRoom():o.createRoom())},I=async()=>{if(g.value)try{await navigator.clipboard.writeText(a.value)}catch(M){console.error("Clipboard copy failed",M)}};return(M,R)=>(s(),n("div",Cb,[e("div",Tb,[R[0]||(R[0]=e("div",null,[e("p",{class:"text-sm uppercase tracking-[0.2em] text-slate-500"},"Шаг 2"),e("h2",{class:"text-xl font-semibold"},"Создайте комнату")],-1)),e("span",Sb,u(f(l)),1)]),e("button",{type:"button",class:"w-full rounded-xl bg-sky-500/20 border border-sky-400/60 py-3 text-lg font-semibold text-sky-100 hover:bg-sky-500/30 transition",disabled:v.value,onClick:b},u(E.value?"Создать новую комнату":"Создать комнату"),9,Ib),E.value?(s(),n("div",Pb,[R[1]||(R[1]=e("p",{class:"text-sm text-slate-400"},"Этим кодом делитесь с игроками:",-1)),e("div",Eb,[e("div",Mb,u(f(a)),1),e("button",{type:"button",class:"px-4 py-3 rounded-xl border border-white/20 hover:border-sky-400/70 text-sm",disabled:!g.value,onClick:I}," Копировать ",8,Ab)])])):x("",!0),f(d).length?(s(),n("div",Db,[R[2]||(R[2]=e("p",{class:"text-sm uppercase tracking-[0.2em] text-slate-500"},"Игроки",-1)),e("ul",Nb,[(s(!0),n(W,null,re(f(d),T=>(s(),n("li",{key:T.peerId,class:"flex items-center justify-between rounded-xl border border-white/5 px-4 py-2 bg-slate-950/60"},[e("span",Lb,u(T.alias),1),e("span",Fb,u(T.ready?"онлайн":"подключается"),1)]))),128))])])):x("",!0),f(i)?(s(),n("p",Rb,u(f(i)),1)):x("",!0)]))}},Hb=[{id:"hat",name:"Шляпа",emoji:"🎩",svg:"M12 2C8 2 5 4 5 7v1H4c-1 0-2 1-2 2v2h20v-2c0-1-1-2-2-2h-1V7c0-3-3-5-7-5zm-8 14v4h16v-4H4z"},{id:"boot",name:"Ботинок",emoji:"🥾",svg:"M4 18h16l-2-6H10l-2-4H4v10z"},{id:"car",name:"Машина",emoji:"🚗",svg:"M19 7h-3L13.5 3H10.5L8 7H5c-1.1 0-2 .9-2 2v5c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V9c0-1.1-.9-2-2-2zM6 12c-.83 0-1.5-.67-1.5-1.5S5.17 9 6 9s1.5.67 1.5 1.5S6.83 12 6 12zm12 0c-.83 0-1.5-.67-1.5-1.5S17.17 9 18 9s1.5.67 1.5 1.5S18.83 12 18 12z"},{id:"ship",name:"Корабль",emoji:"⛵",svg:"M12 2L4 12h4v3c0 1 1 2 2 2h4c1 0 2-1 2-2v-3h4L12 2z"},{id:"dog",name:"Собака",emoji:"🐕",svg:"M18 4c-1 0-2 1-2 2v2H8V6c0-1-1-2-2-2s-2 1-2 2v8c0 2 2 4 4 4h8c2 0 4-2 4-4V6c0-1-1-2-2-2zm-8 10c-.6 0-1-.4-1-1s.4-1 1-1 1 .4 1 1-.4 1-1 1z"},{id:"cat",name:"Кот",emoji:"🐱",svg:"M12 2C9 2 6 4 6 7v1c-2 0-3 1-3 3s1 3 3 3v4c0 2 2 4 6 4s6-2 6-4v-4c2 0 3-1 3-3s-1-3-3-3V7c0-3-3-5-6-5z"},{id:"thimble",name:"Напёрсток",emoji:"🧵",svg:"M12 2c-3 0-6 2-6 5v10c0 2 2 4 6 4s6-2 6-4V7c0-3-3-5-6-5zm0 2c2 0 4 1 4 3v1H8V7c0-2 2-3 4-3z"},{id:"iron",name:"Утюг",emoji:"🔥",svg:"M4 12h12l2-4H6l-2 4zm0 2v4h16l-2-4H4z"},{id:"dragon",name:"Дракон",emoji:"🐉",svg:"M12 2c-2 0-4 1-5 3L5 8c-2 1-3 3-3 5v4c0 2 2 4 4 4h12c2 0 4-2 4-4v-4c0-2-1-4-3-5l-2-3c-1-2-3-3-5-3z"},{id:"sword",name:"Меч",emoji:"⚔️",svg:"M14.5 2L11 5.5 5.5 11l-3 6 3 3 6-3L17 11.5 20.5 8 14.5 2z"},{id:"shield",name:"Щит",emoji:"🛡️",svg:"M12 2L4 6v6c0 5 3 9 8 10 5-1 8-5 8-10V6l-8-4z"},{id:"crown",name:"Корона",emoji:"👑",svg:"M2 16l3-8 4 4 3-6 3 6 4-4 3 8H2z"},{id:"wizard",name:"Волшебник",emoji:"🧙",svg:"M12 2l3 7h-6l3-7zm-6 9h12l-1 9H7l-1-9z"},{id:"skull",name:"Череп",emoji:"💀",svg:"M12 2C8 2 5 5 5 9c0 2 1 4 2 5v5h10v-5c1-1 2-3 2-5 0-4-3-7-7-7zm-2 8c-.6 0-1-.4-1-1s.4-1 1-1 1 .4 1 1-.4 1-1 1zm4 0c-.6 0-1-.4-1-1s.4-1 1-1 1 .4 1 1-.4 1-1 1z"},{id:"dice",name:"Кубик",emoji:"🎲",svg:"M4 4h16v16H4V4zm4 4c-.6 0-1 .4-1 1s.4 1 1 1 1-.4 1-1-.4-1-1-1zm4 4c-.6 0-1 .4-1 1s.4 1 1 1 1-.4 1-1-.4-1-1-1zm4 4c-.6 0-1 .4-1 1s.4 1 1 1 1-.4 1-1-.4-1-1-1z"},{id:"gem",name:"Самоцвет",emoji:"💎",svg:"M12 2L4 8l8 12 8-12-8-6z"}],jb=[{id:"red",name:"Красный",value:"#ef4444"},{id:"orange",name:"Оранжевый",value:"#f97316"},{id:"amber",name:"Янтарный",value:"#f59e0b"},{id:"yellow",name:"Жёлтый",value:"#eab308"},{id:"lime",name:"Лайм",value:"#84cc16"},{id:"green",name:"Зелёный",value:"#22c55e"},{id:"emerald",name:"Изумрудный",value:"#10b981"},{id:"teal",name:"Бирюзовый",value:"#14b8a6"},{id:"cyan",name:"Голубой",value:"#06b6d4"},{id:"sky",name:"Небесный",value:"#0ea5e9"},{id:"blue",name:"Синий",value:"#3b82f6"},{id:"indigo",name:"Индиго",value:"#6366f1"},{id:"violet",name:"Фиолетовый",value:"#8b5cf6"},{id:"purple",name:"Пурпурный",value:"#a855f7"},{id:"fuchsia",name:"Фуксия",value:"#d946ef"},{id:"pink",name:"Розовый",value:"#ec4899"},{id:"rose",name:"Алый",value:"#f43f5e"}],On={icons:Hb,colors:jb},zb=["title"],Ub={__name:"PlayerIcon",props:{iconId:{type:String,default:null},color:{type:String,default:null},size:{type:[Number,String],default:24},showBackground:{type:Boolean,default:!1}},setup(t){const o=t,a=X(()=>o.iconId?On.icons.find(v=>v.id===o.iconId):null),l=X(()=>{if(!o.color)return"#94a3b8";const v=On.colors.find(E=>E.id===o.color);return v?v.value:o.color}),i=X(()=>typeof o.size=="string"?parseInt(o.size,10):o.size),d=X(()=>`${i.value}px`);return(v,E)=>a.value?(s(),n("span",{key:0,class:te(["player-icon",{"with-bg":t.showBackground}]),style:Ne({color:l.value,fontSize:d.value,"--icon-color":l.value}),title:a.value.name},u(a.value.emoji),15,zb)):(s(),n("span",{key:1,class:"player-icon placeholder",style:Ne({fontSize:d.value})}," 👤 ",4))}},Hn=wt(Ub,[["__scopeId","data-v-cdbcd76b"]]),Bb=[{id:"humanoid",name:"Гуманоиды",icon:"mdi:account"},{id:"beast",name:"Звери",icon:"mdi:paw"},{id:"monster",name:"Монстры",icon:"mdi:skull"},{id:"undead",name:"Нежить",icon:"mdi:ghost"},{id:"construct",name:"Конструкты",icon:"mdi:robot"},{id:"elemental",name:"Элементали",icon:"mdi:fire"},{id:"demon",name:"Демоны",icon:"mdi:emoticon-devil"},{id:"dragon",name:"Драконы",icon:"mdi:dragon"},{id:"other",name:"Прочее",icon:"mdi:help-circle"}],Wb=[{id:"minion",name:"Миньон",color:"#64748b",description:"Слабый противник, группы по 3-5"},{id:"regular",name:"Рядовой",color:"#22c55e",description:"Обычный противник"},{id:"elite",name:"Элита",color:"#3b82f6",description:"Сильный противник"},{id:"boss",name:"Босс",color:"#a855f7",description:"Очень сильный противник"},{id:"legendary",name:"Легендарный",color:"#f59e0b",description:"Исключительно сильный противник"}],qb=[{id:"goblin",name:"Гоблин",category:"humanoid",difficulty:"minion",portrait:null,images:[],stats:{war:{min:1,max:2},knowledge:{min:0,max:1},community:{min:0,max:1},shadow:{min:2,max:3},mysticism:{min:0,max:0},nature:{min:1,max:2}},health:{type:"simple",hp:{min:3,max:5}},skills:[],equipment:{armor:["clothes","leather"],weapons:[{type:"melee",options:["dagger","club"]}]},description:"Маленький хитрый гуманоид. Слабый в одиночку, опасен в группе."},{id:"skeleton",name:"Скелет",category:"undead",difficulty:"minion",portrait:null,images:[],stats:{war:{min:2,max:3},knowledge:{min:0,max:0},community:{min:0,max:0},shadow:{min:1,max:2},mysticism:{min:0,max:0},nature:{min:0,max:0}},health:{type:"simple",hp:{min:4,max:6}},skills:[],equipment:{armor:["none"],weapons:[{type:"melee",options:["sword","axe"]}]},description:"Оживлённые кости павшего воина."},{id:"wolf",name:"Волк",category:"beast",difficulty:"regular",portrait:null,images:[],stats:{war:{min:2,max:3},knowledge:{min:0,max:0},community:{min:1,max:2},shadow:{min:2,max:3},mysticism:{min:0,max:0},nature:{min:3,max:4}},health:{type:"simple",hp:{min:6,max:8}},skills:[{id:"packTactics",level:1}],equipment:{armor:["none"],weapons:[]},naturalWeapons:[{name:"Укус",damage:"1d6",type:"piercing"}],description:"Свирепый хищник, охотящийся стаями."}],Vb={id:"",name:"",description:"",aspectId:null,maxLevel:1,levels:[{level:1,description:""}],isCustom:!0},jn={categories:Bb,difficulties:Wb,templates:qb,customSkillTemplate:Vb},Xb={class:"npc-panel"},Yb={class:"panel-header"},Gb={class:"header-info"},Kb={class:"header-title"},Qb={class:"header-count"},Zb={class:"filters"},Jb=["value"],ey=["value"],ty={class:"npc-list"},sy={class:"category-header"},ny={class:"category-count"},ly={class:"npcs-grid"},ay=["onClick"],oy={class:"npc-portrait"},iy={key:1,class:"portrait-placeholder"},ry={class:"npc-info"},cy={class:"npc-name"},dy={class:"npc-meta"},uy={key:0,class:"npc-hp"},fy={key:0,class:"npc-factions"},vy={key:0,class:"faction-more"},my=["onClick"],py=["onClick"],hy=["onClick"],gy={key:1,class:"empty-state"},by={key:0},yy={key:1},xy={__name:"NpcPanel",emits:["open-character-sheet"],setup(t,{emit:o}){const a=Bt(),l=Rt(),i=ss(),d=o,v=jn.categories,E=jn.difficulties,g=Q("all"),b=Q("all"),I=Q("");Q(!1),Q(null),Q(null);const M=X(()=>a.allNpcs),R=X(()=>{let _=M.value;if(g.value!=="all"&&(_=_.filter(P=>P.category===g.value)),b.value!=="all"&&(_=_.filter(P=>P.difficulty===b.value)),I.value.trim()){const P=I.value.toLowerCase();_=_.filter(B=>B.name.toLowerCase().includes(P))}return _}),T=X(()=>{const _={};return R.value.forEach(P=>{const B=P.category||"other";_[B]||(_[B]=[]),_[B].push(P)}),_}),F=()=>{const _=a.createNpc({name:"Новый NPC",category:"humanoid",difficulty:"regular"});l.broadcastAllCharacters(),d("open-character-sheet",_.id)},Z=_=>{d("open-character-sheet",_.id)},j=_=>{const P={..._,name:_.name+" (копия)"};delete P.id,a.createNpc(P),l.broadcastAllCharacters()},oe=_=>{if(confirm("Удалить этого NPC?")){const P=i.activeMap;P&&i.removeTokenByCharacterId(P.id,_),a.deleteNpc(_),l.sendCharacterDelete(_)}},ie=(_,P)=>{P&&l.sendSplashImage(P,{title:_.name,duration:5e3})},ne=_=>v.find(P=>P.id===_)||{name:"Прочее",icon:"mdi:help-circle"},O=_=>E.find(P=>P.id===_)||{name:"Рядовой",color:"#22c55e"},S={player:"#22c55e",enemy:"#ef4444",neutral:"#94a3b8",wildlife:"#f59e0b",undead:"#8b5cf6",guards:"#3b82f6",bandits:"#dc2626",merchants:"#eab308"},D={player:"Игроки",enemy:"Враги",neutral:"Нейтральные",wildlife:"Дикие звери",undead:"Нежить",guards:"Стража",bandits:"Бандиты",merchants:"Торговцы"},r=_=>S[_]||"#94a3b8",h=_=>_.startsWith("custom_")?_.replace("custom_","").replace(/_/g," "):D[_]||_;return(_,P)=>(s(),n("div",Xb,[e("header",Yb,[e("div",Gb,[e("h2",Kb,[U(f(K),{icon:"mdi:skull"}),P[4]||(P[4]=ke(" NPC и монстры ",-1))]),e("span",Qb,u(M.value.length),1)]),e("button",{class:"btn-create",onClick:F},[U(f(K),{icon:"mdi:plus"}),P[5]||(P[5]=e("span",null,"Создать",-1))])]),e("div",Zb,[Me(e("input",{"onUpdate:modelValue":P[0]||(P[0]=B=>I.value=B),type:"text",class:"search-input",placeholder:"Поиск по имени..."},null,512),[[Be,I.value]]),Me(e("select",{"onUpdate:modelValue":P[1]||(P[1]=B=>g.value=B),class:"filter-select"},[P[6]||(P[6]=e("option",{value:"all"},"Все категории",-1)),(s(!0),n(W,null,re(f(v),B=>(s(),n("option",{key:B.id,value:B.id},u(B.name),9,Jb))),128))],512),[[Lt,g.value]]),Me(e("select",{"onUpdate:modelValue":P[2]||(P[2]=B=>b.value=B),class:"filter-select"},[P[7]||(P[7]=e("option",{value:"all"},"Любая сложность",-1)),(s(!0),n(W,null,re(f(E),B=>(s(),n("option",{key:B.id,value:B.id},u(B.name),9,ey))),128))],512),[[Lt,b.value]])]),e("div",ty,[R.value.length>0?(s(!0),n(W,{key:0},re(T.value,(B,ce)=>(s(),n("div",{key:ce,class:"category-group"},[e("div",sy,[U(f(K),{icon:ne(ce).icon},null,8,["icon"]),e("span",null,u(ne(ce).name),1),e("span",ny,u(B.length),1)]),e("div",ly,[(s(!0),n(W,null,re(B,Y=>{var ve,H,y,L,le;return s(),n("div",{key:Y.id,class:"npc-card",onClick:V=>Z(Y)},[e("div",oy,[Y.portrait?(s(),Ke(zt,{key:0,portrait:Y.portrait,size:48},null,8,["portrait"])):(s(),n("div",iy,[U(f(K),{icon:ne(Y.category).icon},null,8,["icon"])]))]),e("div",ry,[e("div",cy,u(Y.name),1),e("div",dy,[e("span",{class:"npc-difficulty",style:Ne({color:O(Y.difficulty).color})},u(O(Y.difficulty).name),5),((ve=Y.combat)==null?void 0:ve.healthType)==="simple"?(s(),n("span",uy," ❤️ "+u((H=Y.combat)==null?void 0:H.hp)+"/"+u((y=Y.combat)==null?void 0:y.maxHp),1)):x("",!0)]),(L=Y.factions)!=null&&L.length?(s(),n("div",fy,[(s(!0),n(W,null,re(Y.factions.slice(0,3),V=>(s(),n("span",{key:V,class:"faction-badge",style:Ne({background:r(V)+"30",color:r(V)})},u(h(V)),5))),128)),Y.factions.length>3?(s(),n("span",vy," +"+u(Y.factions.length-3),1)):x("",!0)])):x("",!0)]),e("div",{class:"npc-actions",onClick:P[3]||(P[3]=Fe(()=>{},["stop"]))},[e("button",{class:"action-btn",title:"Дублировать",onClick:V=>j(Y)},[U(f(K),{icon:"mdi:content-copy"})],8,my),((le=Y.images)==null?void 0:le.length)>0?(s(),n("button",{key:0,class:"action-btn",title:"Показать игрокам",onClick:V=>ie(Y,Y.images[0])},[U(f(K),{icon:"mdi:eye"})],8,py)):x("",!0),e("button",{class:"action-btn delete",title:"Удалить",onClick:V=>oe(Y.id)},[U(f(K),{icon:"mdi:delete"})],8,hy)])],8,ay)}),128))])]))),128)):(s(),n("div",gy,[U(f(K),{icon:"mdi:ghost",class:"empty-icon"}),I.value||g.value!=="all"||b.value!=="all"?(s(),n("p",by," Нет NPC по заданным фильтрам ")):(s(),n("p",yy,[...P[8]||(P[8]=[ke(" Пока нет созданных NPC.",-1),e("br",null,null,-1),ke(" Создайте первого противника! ",-1)])])),e("button",{class:"btn-create-empty",onClick:F},[U(f(K),{icon:"mdi:plus"}),P[9]||(P[9]=ke(" Создать NPC ",-1))])]))])]))}},ky=wt(xy,[["__scopeId","data-v-c6224a47"]]),wy={class:"h-full flex flex-col bg-slate-950 text-slate-50"},_y={class:"px-6 py-4 border-b border-slate-800 bg-slate-900/50 flex-shrink-0"},$y={class:"flex gap-2"},Cy={class:"ml-1 text-xs opacity-75"},Ty={class:"ml-1 text-xs opacity-75"},Sy={class:"ml-1 text-xs opacity-75"},Iy={key:0,class:"flex-1 overflow-y-auto p-6"},Py={key:0,class:"mb-8"},Ey={class:"text-lg font-semibold text-slate-300 mb-4 flex items-center gap-2"},My={class:"text-sm text-slate-500"},Ay={class:"space-y-3"},Dy={class:"px-4 py-2 bg-slate-800/50 border-b border-slate-700 flex items-center gap-3"},Ny={class:"font-medium text-sm"},Ly={class:"divide-y divide-slate-800/50"},Fy=["onClick"],Ry={class:"flex-1 min-w-0"},Oy={class:"font-medium truncate"},Hy={class:"text-xs text-slate-500"},jy={key:1},zy={class:"text-lg font-semibold text-slate-300 mb-4 flex items-center gap-2"},Uy={class:"text-sm text-slate-500"},By={class:"grid grid-cols-1 md:grid-cols-2 gap-3"},Wy=["onClick"],qy={key:1,class:"w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center text-lg"},Vy={class:"flex-1 min-w-0"},Xy={class:"font-medium truncate"},Yy={class:"text-xs text-slate-500"},Gy={key:2,class:"text-sm text-slate-400"},Ky={key:2,class:"flex flex-col items-center justify-center h-full text-center"},Qy={key:1,class:"flex-1 overflow-y-auto p-6"},Zy={key:0,class:"flex flex-col items-center justify-center h-full text-center"},Jy={key:1,class:"space-y-6"},ex={class:"px-4 py-3 bg-slate-800/50 border-b border-slate-700 flex items-center justify-between"},tx={class:"flex items-center gap-3"},sx=["title"],nx={class:"font-medium"},lx={class:"text-sm text-slate-500"},ax={class:"divide-y divide-slate-800/50"},ox=["onClick"],ix={class:"flex items-start gap-4"},rx={class:"flex-1 min-w-0"},cx={class:"flex items-center gap-2 mb-1"},dx={class:"font-bold text-lg truncate"},ux={class:"text-xs px-2 py-0.5 rounded bg-slate-700 text-slate-300"},fx={class:"flex flex-wrap gap-3 text-sm"},vx={key:0,class:"text-slate-400"},mx={key:1,class:"text-slate-400"},px={class:"mt-3"},hx={class:"flex gap-2 mt-2"},gx=["onClick"],bx=["onClick"],yx={key:0,class:"flex flex-wrap gap-2 mt-2"},xx={class:"flex flex-col gap-1"},kx=["onClick"],wx=["title","onClick"],_x={__name:"MasterCharactersPanel",emits:["open-character-sheet"],setup(t,{emit:o}){const a=Q("all"),l=Bt(),i=Rt(),d=o,{connections:v}=pt(i),E=Q(new Set),g=Q(new Map),b=X(()=>l.allPlayerCharacters),I=X(()=>{const _={};return b.value.forEach(P=>{const B=P.ownerId||"unknown";_[B]||(_[B]={ownerId:B,ownerNickname:P.ownerNickname||"Неизвестный игрок",characters:[]}),_[B].characters.push(P)}),Object.values(_)}),M=X(()=>b.value.length),R=_=>({commander:"⚔️",warrior:"🗡️",ranger:"🏹",mage:"🔮",healer:"💚",rogue:"🗝️",bard:"🎭",paladin:"🛡️"})[_]||"👤",T=_=>({commander:"Командир",warrior:"Воин",ranger:"Следопыт",mage:"Маг",healer:"Целитель",rogue:"Плут",bard:"Бард",paladin:"Паладин"})[_]||_||"Без класса",F=_=>v.value.some(P=>P.userId===_||P.peerId===_),Z=_=>{const P=i.allPlayers.find(B=>B.userId===_);return{iconId:(P==null?void 0:P.playerIcon)||null,colorId:(P==null?void 0:P.playerColor)||null}},j=_=>{var B;const P=l.characters.find(ce=>ce.id===_);if(P!=null&&P.ownerId&&!P.isNpc){const ce=g.value.get(_);if(ce){if(((B=P.combat)==null?void 0:B.healthType)==="simple")ce.hpDelta<0?i.sendDamageEffect(P.ownerId,Math.abs(ce.hpDelta)):ce.hpDelta>0&&i.sendHealEffect(P.ownerId,ce.hpDelta);else{const Y=ce.woundChanges||{},ve=(Y.scratch||0)+(Y.light||0)*2+(Y.heavy||0)*3+(Y.deadly||0)*4,H=Math.abs(Math.min(0,Y.scratch||0))+Math.abs(Math.min(0,Y.light||0))*2+Math.abs(Math.min(0,Y.heavy||0))*3+Math.abs(Math.min(0,Y.deadly||0))*4;ve>0&&i.sendDamageEffect(P.ownerId,ve,"ран"),H>0&&i.sendHealEffect(P.ownerId,H)}g.value.delete(_)}i.sendCharacterToPlayer(_,P.ownerId),E.value.delete(_)}},oe=_=>{E.value.add(_)},ie=_=>E.value.has(_),ne=(_,P)=>{var H;const B=l.characters.find(y=>y.id===_);if(!B)return;const ce=((H=B.combat)==null?void 0:H.hp)||0,Y=P-ce;l.updateCharacter(_,{combat:{...B.combat,hp:P}});const ve=g.value.get(_)||{hpDelta:0,woundChanges:{}};ve.hpDelta+=Y,g.value.set(_,ve),oe(_)},O=(_,P)=>{l.addWound(_,P);const B=g.value.get(_)||{hpDelta:0,woundChanges:{}};B.woundChanges[P]=(B.woundChanges[P]||0)+1,g.value.set(_,B),oe(_)},S=(_,P)=>{l.removeWound(_,P);const B=g.value.get(_)||{hpDelta:0,woundChanges:{}};B.woundChanges[P]=(B.woundChanges[P]||0)-1,g.value.set(_,B),oe(_)},D=_=>{l.postCombatRecovery(_),oe(_)},r=_=>{var ce;const P=l.characters.find(Y=>Y.id===_);if(!P)return;const B=((ce=P.combat)==null?void 0:ce.healthType)==="simple"?"wounds":"simple";l.setHealthType(_,B),j(_)},h=_=>{d("open-character-sheet",_)};return(_,P)=>{var B,ce,Y;return s(),n("div",wy,[e("header",_y,[P[6]||(P[6]=e("div",{class:"flex items-center justify-between mb-3"},[e("h1",{class:"text-xl font-bold flex items-center gap-2"},[e("span",null,"👥"),e("span",null,"Персонажи")])],-1)),e("div",$y,[e("button",{onClick:P[0]||(P[0]=ve=>a.value="all"),class:te(["flex-1 px-4 py-2 rounded-lg text-sm font-medium transition-all",a.value==="all"?"bg-purple-600 text-white":"bg-slate-800 text-slate-400 hover:bg-slate-700 hover:text-slate-200"])},[P[3]||(P[3]=ke(" 📋 Все ",-1)),e("span",Cy,"("+u(M.value+(((B=f(l).allNpcs)==null?void 0:B.length)||0))+")",1)],2),e("button",{onClick:P[1]||(P[1]=ve=>a.value="players"),class:te(["flex-1 px-4 py-2 rounded-lg text-sm font-medium transition-all",a.value==="players"?"bg-sky-600 text-white":"bg-slate-800 text-slate-400 hover:bg-slate-700 hover:text-slate-200"])},[P[4]||(P[4]=ke(" 👤 Игроки ",-1)),e("span",Ty,"("+u(M.value)+")",1)],2),e("button",{onClick:P[2]||(P[2]=ve=>a.value="npcs"),class:te(["flex-1 px-4 py-2 rounded-lg text-sm font-medium transition-all",a.value==="npcs"?"bg-amber-600 text-white":"bg-slate-800 text-slate-400 hover:bg-slate-700 hover:text-slate-200"])},[P[5]||(P[5]=ke(" 👹 NPC ",-1)),e("span",Sy,"("+u(((ce=f(l).allNpcs)==null?void 0:ce.length)||0)+")",1)],2)])]),a.value==="all"?(s(),n("div",Iy,[M.value>0?(s(),n("div",Py,[e("h3",Ey,[P[7]||(P[7]=e("span",null,"👤",-1)),P[8]||(P[8]=ke(" Персонажи игроков ",-1)),e("span",My,"("+u(M.value)+")",1)]),e("div",Ay,[(s(!0),n(W,null,re(I.value,ve=>(s(),n("div",{key:ve.ownerId,class:"bg-slate-900/50 rounded-xl border border-slate-800 overflow-hidden"},[e("div",Dy,[e("div",{class:te(["w-2 h-2 rounded-full",F(ve.ownerId)?"bg-emerald-500":"bg-slate-500"])},null,2),U(Hn,{"icon-id":Z(ve.ownerId).iconId,color:Z(ve.ownerId).colorId,size:16},null,8,["icon-id","color"]),e("span",Ny,u(ve.ownerNickname),1)]),e("div",Ly,[(s(!0),n(W,null,re(ve.characters,H=>(s(),n("div",{key:H.id,class:"p-3 hover:bg-slate-800/30 transition cursor-pointer flex items-center gap-3",onClick:y=>h(H.id)},[U(zt,{portrait:H.portrait,name:H.name,combat:H.combat,stats:H.stats,size:"sm"},null,8,["portrait","name","combat","stats"]),e("div",Ry,[e("div",Oy,u(H.name),1),e("div",Hy,u(T(H.class)),1)]),U(En,{combat:H.combat,stats:H.stats,compact:"","onUpdate:hp":y=>ne(H.id,y),onAddWound:y=>O(H.id,y),onRemoveWound:y=>S(H.id,y)},null,8,["combat","stats","onUpdate:hp","onAddWound","onRemoveWound"])],8,Fy))),128))])]))),128))])])):x("",!0),((Y=f(l).allNpcs)==null?void 0:Y.length)>0?(s(),n("div",jy,[e("h3",zy,[P[9]||(P[9]=e("span",null,"👹",-1)),P[10]||(P[10]=ke(" NPC и монстры ",-1)),e("span",Uy,"("+u(f(l).allNpcs.length)+")",1)]),e("div",By,[(s(!0),n(W,null,re(f(l).allNpcs,ve=>{var H;return s(),n("div",{key:ve.id,class:"bg-slate-900/50 rounded-xl border border-slate-800 p-3 hover:bg-slate-800/30 transition cursor-pointer flex items-center gap-3",onClick:y=>h(ve.id)},[ve.portrait?(s(),Ke(zt,{key:0,portrait:ve.portrait,name:ve.name,combat:ve.combat,size:"sm"},null,8,["portrait","name","combat"])):(s(),n("div",qy," 👹 ")),e("div",Vy,[e("div",Xy,u(ve.name),1),e("div",Yy,u(ve.category),1)]),((H=ve.combat)==null?void 0:H.healthType)==="simple"?(s(),n("div",Gy," ❤️ "+u(ve.combat.hp)+"/"+u(ve.combat.maxHp),1)):x("",!0)],8,Wy)}),128))])])):x("",!0),M.value===0&&(!f(l).allNpcs||f(l).allNpcs.length===0)?(s(),n("div",Ky,[...P[11]||(P[11]=[e("div",{class:"text-6xl mb-4"},"🎭",-1),e("h2",{class:"text-xl font-medium text-slate-300 mb-2"},"Нет персонажей",-1),e("p",{class:"text-slate-500 max-w-md"},' Персонажи игроков появятся здесь когда они подключатся. NPC можно создать во вкладке "NPC". ',-1)])])):x("",!0)])):x("",!0),a.value==="players"?(s(),n("div",Qy,[M.value===0?(s(),n("div",Zy,[...P[12]||(P[12]=[e("div",{class:"text-6xl mb-4"},"🎭",-1),e("h2",{class:"text-xl font-medium text-slate-300 mb-2"},"Нет персонажей",-1),e("p",{class:"text-slate-500 max-w-md"}," Персонажи игроков появятся здесь, когда они подключатся к комнате. Убедитесь, что игроки создали персонажей перед подключением. ",-1)])])):(s(),n("div",Jy,[(s(!0),n(W,null,re(I.value,ve=>(s(),n("div",{key:ve.ownerId,class:"bg-slate-900/50 rounded-xl border border-slate-800 overflow-hidden"},[e("div",ex,[e("div",tx,[e("div",{class:te(["w-3 h-3 rounded-full",F(ve.ownerId)?"bg-emerald-500":"bg-slate-500"]),title:F(ve.ownerId)?"Онлайн":"Офлайн"},null,10,sx),U(Hn,{"icon-id":Z(ve.ownerId).iconId,color:Z(ve.ownerId).colorId,size:20},null,8,["icon-id","color"]),e("span",nx,u(ve.ownerNickname),1),e("span",lx,"("+u(ve.characters.length)+" перс.)",1)])]),e("div",ax,[(s(!0),n(W,null,re(ve.characters,H=>{var y,L,le;return s(),n("div",{key:H.id,class:"p-4 hover:bg-slate-800/30 transition cursor-pointer",onClick:V=>h(H.id)},[e("div",ix,[U(zt,{portrait:H.portrait,name:H.name,combat:H.combat,stats:H.stats,meleeDefence:f(es)(H,"melee"),rangedDefence:f(es)(H,"ranged"),showDefence:!0,defenceLayout:"left",size:"lg"},null,8,["portrait","name","combat","stats","meleeDefence","rangedDefence"]),e("div",rx,[e("div",cx,[e("h3",dx,u(H.name),1),e("span",ux,u(R(H.class))+" "+u(T(H.class)),1)]),e("div",fx,[H.race?(s(),n("div",vx," 🧬 "+u(H.race)+u(H.subrace?` (${H.subrace})`:""),1)):x("",!0),H.gender?(s(),n("div",mx,u(H.gender==="m"?"♂️":"♀️"),1)):x("",!0)]),e("div",px,[U(En,{combat:H.combat,stats:H.stats,"onUpdate:hp":V=>ne(H.id,V),onAddWound:V=>O(H.id,V),onRemoveWound:V=>S(H.id,V)},null,8,["combat","stats","onUpdate:hp","onAddWound","onRemoveWound"]),e("div",hx,[ie(H.id)?(s(),n("button",{key:0,onClick:V=>j(H.id),class:"flex-1 px-3 py-1.5 rounded-lg text-sm font-medium bg-emerald-600 hover:bg-emerald-500 text-white transition flex items-center justify-center gap-1"},[...P[13]||(P[13]=[e("span",null,"📤",-1),e("span",null,"Отправить",-1)])],8,gx)):x("",!0),((y=H.combat)==null?void 0:y.healthType)==="wounds"?(s(),n("button",{key:1,onClick:V=>D(H.id),class:"px-3 py-1.5 rounded-lg text-sm bg-slate-700 hover:bg-slate-600 text-slate-300 transition",title:"Послебоевое восстановление: раны смещаются на категорию ниже"}," 🩹 Отдых ",8,bx)):x("",!0)])]),H.stats?(s(),n("div",yx,[(s(!0),n(W,null,re(H.stats,(V,de)=>(s(),n("span",{key:de,class:te(["text-xs px-1.5 py-0.5 rounded bg-slate-800",{"text-rose-400":de==="war","text-blue-400":de==="knowledge","text-amber-400":de==="community","text-slate-400":de==="shadow","text-purple-400":de==="mysticism","text-emerald-400":de==="nature"}])},u(de.slice(0,3).toUpperCase())+": "+u(V),3))),128))])):x("",!0)]),e("div",xx,[e("button",{class:"p-2 rounded-lg hover:bg-sky-700 text-sky-400 hover:text-white transition",title:"Открыть лист персонажа",onClick:V=>h(H.id)}," 📋 ",8,kx),e("button",{class:"p-2 rounded-lg hover:bg-slate-700 text-slate-400 hover:text-white transition",title:((L=H.combat)==null?void 0:L.healthType)==="simple"?"Переключить на ранения":"Переключить на HP",onClick:V=>r(H.id)},u(((le=H.combat)==null?void 0:le.healthType)==="simple"?"📊":"❤️"),9,wx),P[14]||(P[14]=e("button",{class:"p-2 rounded-lg hover:bg-slate-700 text-slate-400 hover:text-white transition",title:"Нанести урон"}," 💥 ",-1)),P[15]||(P[15]=e("button",{class:"p-2 rounded-lg hover:bg-slate-700 text-slate-400 hover:text-white transition",title:"Исцелить"}," 💚 ",-1)),P[16]||(P[16]=e("button",{class:"p-2 rounded-lg hover:bg-slate-700 text-slate-400 hover:text-white transition",title:"Разместить на карте"}," 📍 ",-1))])])],8,ox)}),128))])]))),128))]))])):a.value==="npcs"?(s(),Ke(ky,{key:2,class:"flex-1",onOpenCharacterSheet:h})):x("",!0)])}}},$x={class:"templates-list-panel"},Cx={class:"templates-header"},Tx={class:"templates-title"},Sx={class:"templates-count"},Ix={key:0,class:"tag-filters"},Px=["onClick"],Ex=["onClick"],Mx=["onClick","title"],Ax={class:"template-info"},Dx={class:"template-name"},Nx={class:"template-meta"},Lx={key:0,class:"template-tags"},Fx={key:0,class:"mini-tag more"},Rx=["onClick"],Ox={key:0,class:"empty-templates"},Hx={key:0},jx={key:1},zn="scene-templates-scroll",zx={__name:"SceneTemplatesList",props:{templates:{type:Array,default:()=>[]}},emits:["select-template","delete-template","toggle-sent"],setup(t,{emit:o}){const a=t,l=o,i=Q([]),d=Q(null),v=X(()=>{const F=new Set;return a.templates.forEach(Z=>{var j;(j=Z.tags)==null||j.forEach(oe=>F.add(oe))}),Array.from(F).sort()}),E=X(()=>i.value.length===0?a.templates:a.templates.filter(F=>i.value.some(Z=>{var j;return(j=F.tags)==null?void 0:j.includes(Z)}))),g=F=>{const Z=i.value.indexOf(F);Z===-1?i.value.push(F):i.value.splice(Z,1)},b=F=>({text:"mdi:message-text","skill-check":"mdi:dice-d20","battle-invite":"mdi:sword-cross",image:"mdi:image",important:"mdi:alert-circle",quest:"mdi:map-marker-star","item-give":"mdi:gift","character-invite":"mdi:account-plus"})[F]||"mdi:file-document",I=()=>{d.value&&localStorage.setItem(zn,d.value.scrollTop.toString())},M=()=>{const F=localStorage.getItem(zn);F&&d.value&&(d.value.scrollTop=parseInt(F,10))},R=(F,Z)=>{F.stopPropagation(),l("toggle-sent",Z.id)};Ut(()=>{Mt(()=>{M()})});const T=()=>{I()};return(F,Z)=>(s(),n("div",$x,[e("div",Cx,[e("h4",Tx,[U(f(K),{icon:"mdi:bookmark-multiple"}),Z[0]||(Z[0]=ke(" Шаблоны ",-1))]),e("span",Sx,u(t.templates.length),1)]),v.value.length>0?(s(),n("div",Ix,[(s(!0),n(W,null,re(v.value,j=>(s(),n("button",{key:j,class:te(["tag-filter",{active:i.value.includes(j)}]),onClick:oe=>g(j)},u(j),11,Px))),128))])):x("",!0),e("div",{ref_key:"listContainer",ref:d,class:"templates-scroll",onScroll:T},[(s(!0),n(W,null,re(E.value,j=>{var oe;return s(),n("div",{key:j.id,class:te(["template-item",{sent:j.sent}]),style:Ne({"--template-color":j.color}),onClick:ie=>l("select-template",j)},[e("div",{class:"template-icon-wrapper",onClick:ie=>R(ie,j),title:j.sent?"Отмечен как отправленный (клик - сбросить)":"Клик - отметить как отправленный"},[U(f(K),{icon:j.icon,class:"template-icon",style:Ne({color:j.color})},null,8,["icon","style"]),j.sent?(s(),Ke(f(K),{key:0,icon:"mdi:check-circle",class:"sent-badge"})):x("",!0)],8,Mx),e("div",Ax,[e("div",Dx,u(j.name),1),e("div",Nx,[U(f(K),{icon:b(j.tool),class:"tool-type-icon"},null,8,["icon"]),(oe=j.tags)!=null&&oe.length?(s(),n("span",Lx,[(s(!0),n(W,null,re(j.tags.slice(0,2),ie=>(s(),n("span",{key:ie,class:"mini-tag"},u(ie),1))),128)),j.tags.length>2?(s(),n("span",Fx,"+"+u(j.tags.length-2),1)):x("",!0)])):x("",!0)])]),e("button",{class:"template-delete-btn",onClick:Fe(ie=>l("delete-template",j.id),["stop"]),title:"Удалить шаблон"},[U(f(K),{icon:"mdi:delete-outline"})],8,Rx)],14,Ex)}),128)),E.value.length===0?(s(),n("div",Ox,[U(f(K),{icon:"mdi:bookmark-off-outline"}),t.templates.length===0?(s(),n("span",Hx,"Нет шаблонов")):(s(),n("span",jx,"Нет шаблонов с выбранными тегами"))])):x("",!0)],544)]))}},Ux=wt(zx,[["__scopeId","data-v-a5c0d703"]]),Bx={key:0,class:"collapsed-header scene-image-preview"},Wx=["src","alt"],qx={class:"collapsed-name"},Vx={class:"panel-header"},Xx={class:"panel-title"},Yx=["src","alt"],Gx={key:0,class:"collapsed-header"},Kx={class:"panel-header"},Qx={class:"workspace"},Zx={class:"master-scene-layout"},Jx={class:"master-scene-tools-column"},e2={class:"master-scene-templates-column"},t2={class:"master-scene-log"},s2={key:0,class:"pending-action"},n2={class:"action-info"},l2={class:"action-controls"},a2=["disabled"],o2={key:1,class:"action-buttons"},i2=["onClick"],r2={class:"btn-label"},c2={key:1,class:"sheet-tabs"},d2=["onClick"],u2={class:"tab-label"},f2={key:2,class:"scene-filters"},v2=["onClick"],m2={class:"filter-label"},p2={class:"nav-bar"},h2={class:"nav-tabs"},g2=["onClick"],b2={class:"status-text"},y2={class:"menu-section"},x2={class:"room-code"},k2={key:0,class:"copy-hint"},w2={class:"menu-section"},_2={class:"layout-switcher"},$2={__name:"GameLayout",props:{isMaster:{type:Boolean,default:!1},character:{type:Object,default:null},characters:{type:Array,default:()=>[]},selectedToken:{type:Object,default:null},selectedHex:{type:Object,default:null},playerFacing:{type:Number,default:0},playerTokenPosition:{type:Object,default:null},connectionStatus:{type:String,default:"disconnected"},currentTurn:{type:Object,default:null},isPlayerTurn:{type:Boolean,default:!1},pendingAction:{type:Object,default:null},reactionPrompt:{type:Object,default:null}},emits:["leave-room","set-view","select-action","confirm-action","cancel-action","switch-equipment","reaction-accept","reaction-decline","open-character-sheet","move-to-hex","token-selected","hex-selected","hex-double-tap","hex-long-press-move","hex-long-press-confirm","token-rotate","action-target-selected","create-character"],setup(t,{emit:o}){const a=t,l=o,i=Bt();ss();const d=ms(),v=Ys(),E=Rt(),{roomId:g}=pt(E),b=Q(!1),I=async()=>{if(g.value)try{await navigator.clipboard.writeText(g.value),b.value=!0,setTimeout(()=>{b.value=!1},2e3)}catch(se){console.error("Не удалось скопировать:",se)}},{myCharacters:M,activeCharacter:R,activeCharacterId:T}=pt(i),{activeFilter:F,hasActiveImage:Z,currentImage:j}=pt(v),{layoutPreference:oe}=pt(d),ie=Q(window.innerWidth),ne=X(()=>jv()),O=X(()=>oe.value==="mobile"?"mobile":oe.value==="desktop"?"desktop":ne.value?"mobile":"desktop"),S=X(()=>O.value==="mobile"),D=X(()=>O.value==="desktop"),r=()=>{ie.value=window.innerWidth};Ut(()=>{if(window.addEventListener("resize",r),a.isMaster){const se=localStorage.getItem("scene-templates-v2");if(se)try{Y.value=JSON.parse(se)}catch(G){console.error("Failed to load templates:",G)}}}),Xs(()=>{window.removeEventListener("resize",r)});const h=X(()=>a.isMaster?["battle-map","chat","master-tools","characters","character-sheet"]:["battle-map","character-sheet","chat"]),_=Q(d.mobileActiveScreen||"battle-map"),P=X(()=>h.value.indexOf(_.value)),B=X(()=>h.value.length),ce=Q(null),Y=Q([]),ve=se=>{Y.value=se},H=se=>{ce.value&&ce.value.loadTemplate(se)},y=se=>{ce.value&&ce.value.deleteTemplate(se)},L=se=>{ce.value&&ce.value.toggleTemplateSent(se)},le=[{id:"main",label:"Личность",icon:"mdi:account-heart"},{id:"items",label:"Инвентарь",icon:"mdi:backpack"},{id:"social",label:"Социум",icon:"mdi:account-group"},{id:"magic",label:"Магия",icon:"mdi:auto-fix"}],V=Q("main"),de=X(()=>a.isMaster?[{id:"battle-map",label:"Карта",icon:"mdi:map"},{id:"chat",label:"Сцена",icon:"mdi:drama-masks"},{id:"master-tools",label:"Инструменты",icon:"mdi:cog"},{id:"characters",label:"Все персонажи",icon:"mdi:account-group"}]:[{id:"battle-map",label:"Карта",icon:"mdi:map"},{id:"character-sheet",label:"Персонаж",icon:"mdi:account"},{id:"chat",label:"Сцена",icon:"mdi:drama-masks"}]),Se=[{id:is.ALL,label:"Всё",icon:"mdi:format-list-bulleted"},{id:is.CHECKS,label:"Проверки",icon:"mdi:dice-d20"},{id:is.COMBAT,label:"Бой",icon:"mdi:sword-cross"},{id:is.QUESTS,label:"Квесты",icon:"mdi:map-marker-star"},{id:is.ITEMS,label:"Вещи",icon:"mdi:treasure-chest"}],fe=X({get:()=>!d.getInfoPanelOpen(_.value),set:se=>{d.setInfoPanelOpen(_.value,!se)}}),he=Q(!1),we=se=>{se&&se.url&&v.setSceneImage(se.url,se.description,se.senderUserId),d.setInfoPanelOpen("chat",!0),v.touchInfoPanel()},De=()=>{v.clearSceneImage(),d.setInfoPanelOpen("chat",!1)},ye=()=>{v.touchInfoPanel(),d.setInfoPanelOpen("chat",!0)},xe=Q({startX:0,startY:0,currentX:0,isDragging:!1,threshold:80}),Le=X(()=>{if(xe.value.isDragging){const se=xe.value.currentX-xe.value.startX,G=100;return Math.max(-G,Math.min(G,se))}return 0}),qe=se=>{xe.value.startX=se.touches[0].clientX,xe.value.startY=se.touches[0].clientY,xe.value.currentX=se.touches[0].clientX,xe.value.isDragging=!1},Qe=se=>{const G=se.touches[0].clientX-xe.value.startX,ue=se.touches[0].clientY-xe.value.startY;Math.abs(G)>Math.abs(ue)&&Math.abs(G)>15&&(se.preventDefault(),xe.value.isDragging=!0,xe.value.currentX=se.touches[0].clientX)},Ve=()=>{if(!xe.value.isDragging)return;const se=xe.value.currentX-xe.value.startX;if(Math.abs(se)>50){const G=P.value;se>0&&G>0?(_.value=h[G-1],d.setMobileActiveScreen(_.value),l("set-view",h[G-1])):se<0&&G<h.length-1&&(_.value=h[G+1],d.setMobileActiveScreen(_.value),l("set-view",h[G+1]))}xe.value.isDragging=!1},Re=se=>{_.value=se,d.setMobileActiveScreen(se),l("set-view",se)},rt=se=>{i.setActiveCharacter(se),Re("character-sheet")},at=()=>{he.value=!he.value},lt=()=>{fe.value=!fe.value},tt=X(()=>a.connectionStatus==="in-room"?"connected":a.connectionStatus==="connecting"?"connecting":"disconnected"),it=X(()=>a.connectionStatus==="in-room"?"онлайн":a.connectionStatus==="connecting"?"подкл...":"офлайн"),Oe=X(()=>_.value==="battle-map"?"map":_.value==="character-sheet"?"character":"chat"),Xe=X(()=>!(a.isMaster&&_.value==="chat")),je=[{id:"move",label:"Движение",icon:"mdi:walk"},{id:"attack",label:"Атака",icon:"mdi:sword"},{id:"defend",label:"Защита",icon:"mdi:shield"},{id:"skill",label:"Навык",icon:"mdi:auto-fix"}],dt=se=>{l("select-action",se)},ht=se=>{l("token-selected",se)},z=se=>{l("hex-selected",se)},N=se=>{l("hex-double-tap",se)},me=se=>{l("hex-long-press-move",se)},p=se=>{l("hex-long-press-confirm",se)},k=se=>{l("token-rotate",se)},$=se=>{l("action-target-selected",se)};return(se,G)=>(s(),n("div",{class:te(["game-layout",{"player-turn":t.isPlayerTurn,"mobile-layout":S.value,"desktop-layout":D.value,"master-mode":t.isMaster,"no-info-panel":!Xe.value}])},[Xe.value?(s(),n("div",{key:0,class:te(["info-panel-overlay",{collapsed:fe.value,"scene-mode":Oe.value==="chat","has-image":Oe.value==="chat"&&f(Z)}])},[Oe.value==="map"?(s(),Ke(Ln,{key:0,"selected-token":t.selectedToken,"selected-hex":t.selectedHex,"player-character":t.character,"player-facing":t.playerFacing,collapsed:fe.value,"is-player-turn":t.isPlayerTurn,"player-token-position":t.playerTokenPosition,"is-master":t.isMaster,onToggleCollapse:G[0]||(G[0]=ue=>fe.value=!fe.value),onOpenCharacterSheet:G[1]||(G[1]=ue=>{l("open-character-sheet",ue),_.value="character-sheet"}),onSwitchEquipment:G[2]||(G[2]=ue=>se.$emit("switch-equipment")),onMoveToHex:G[3]||(G[3]=ue=>se.$emit("move-to-hex",ue))},null,8,["selected-token","selected-hex","player-character","player-facing","collapsed","is-player-turn","player-token-position","is-master"])):Oe.value==="character"?(s(),Ke(Ln,{key:1,"selected-token":t.selectedToken,"selected-hex":null,"player-character":f(R),"player-facing":t.playerFacing,collapsed:fe.value,"is-player-turn":t.isPlayerTurn,"player-token-position":null,"always-show-player":!0,"is-master":t.isMaster,onToggleCollapse:G[4]||(G[4]=ue=>fe.value=!fe.value),onOpenCharacterSheet:G[5]||(G[5]=ue=>l("open-character-sheet",ue)),onSwitchEquipment:G[6]||(G[6]=ue=>se.$emit("switch-equipment"))},null,8,["selected-token","player-character","player-facing","collapsed","is-player-turn","is-master"])):(s(),n("div",{key:2,class:"info-panel-content scene-info",onClick:ye},[f(Z)&&f(j)?(s(),n(W,{key:0},[fe.value?(s(),n("div",Bx,[e("img",{src:f(j).url,alt:f(j).description,class:"preview-thumbnail"},null,8,Wx),e("span",qx,u(f(j).description||"Изображение сцены"),1),U(f(K),{icon:"mdi:chevron-down",class:"collapse-icon"})])):(s(),n(W,{key:1},[e("div",Vx,[e("button",{class:"collapse-btn",onClick:Fe(lt,["stop"])},[U(f(K),{icon:"mdi:chevron-up"})]),e("span",Xx,u(f(j).description||"Сцена"),1)]),e("div",{class:"scene-image-container",onClick:G[7]||(G[7]=Fe(()=>{},["stop"])),onTouchstart:ye},[e("img",{src:f(j).url,alt:f(j).description,class:"scene-full-image"},null,8,Yx)],32)],64))],64)):(s(),n(W,{key:1},[fe.value?(s(),n("div",Gx,[U(f(K),{icon:"mdi:drama-masks",class:"collapsed-chat-icon"}),G[25]||(G[25]=e("span",{class:"collapsed-name"},"Сцена",-1)),U(f(K),{icon:"mdi:chevron-down",class:"collapse-icon"})])):(s(),n(W,{key:1},[e("div",Kx,[e("button",{class:"collapse-btn",onClick:Fe(lt,["stop"])},[U(f(K),{icon:"mdi:chevron-up"})]),G[26]||(G[26]=e("span",{class:"panel-title"},"Сцена",-1))]),e("div",{class:"chat-info-expanded",onClick:G[8]||(G[8]=Fe(()=>{},["stop"])),onTouchstart:ye},[...G[27]||(G[27]=[e("p",{class:"chat-hint"},"Лог событий, проверки и квесты",-1)])],32)],64))],64))]))],2)):x("",!0),e("div",Qx,[e("div",{class:te(["screens-container",{"master-screens":t.isMaster}]),style:Ne({width:`${B.value*100}%`,transform:`translateX(calc(-${P.value*(100/B.value)}% + ${Le.value}px))`,transition:xe.value.isDragging?"none":"transform 300ms ease-out"})},[e("div",{class:"screen screen-map",style:Ne({width:`${100/B.value}%`})},[U(Hv,{readonly:!t.isMaster&&!t.isPlayerTurn,"is-master":t.isMaster,"mobile-mode":!0,"pending-action":t.pendingAction,onActionTargetSelected:$,onTokenSelected:ht,onHexSelected:z,onHexDoubleTap:N,onHexLongPressMove:me,onHexLongPressConfirm:p,onTokenRotate:k},null,8,["readonly","is-master","pending-action"])],4),t.isMaster?(s(),n(W,{key:1},[e("div",{class:"screen screen-scene-master",style:Ne({width:`${100/B.value}%`})},[e("div",Zx,[e("div",Jx,[U($b,{ref_key:"masterSceneToolsRef",ref:ce,onTemplatesUpdated:ve},null,512)]),e("div",e2,[U(Ux,{templates:Y.value,onSelectTemplate:H,onDeleteTemplate:y,onToggleSent:L},null,8,["templates"])]),e("div",t2,[U(Fn,{onGoToBattle:G[13]||(G[13]=ue=>Re("battle-map")),onViewImage:we,onHideImage:De})])])],4),e("div",{class:"screen screen-master-tools",style:Ne({width:`${100/B.value}%`})},[U(Ob)],4),e("div",{class:"screen screen-characters",style:Ne({width:`${100/B.value}%`})},[U(_x,{onOpenCharacterSheet:rt})],4),e("div",{class:"screen screen-character",style:Ne({width:`${100/B.value}%`})},[U(Rn,{embedded:!0,"active-tab":V.value,"onUpdate:activeTab":G[14]||(G[14]=ue=>V.value=ue),onGoToCharacters:G[15]||(G[15]=ue=>Re("characters"))},null,8,["active-tab"])],4)],64)):(s(),n(W,{key:0},[e("div",{class:"screen screen-character",style:Ne({width:`${100/B.value}%`})},[U(Rn,{embedded:!0,"active-tab":V.value,"onUpdate:activeTab":G[9]||(G[9]=ue=>V.value=ue),onCreateCharacter:G[10]||(G[10]=ue=>l("create-character",ue))},null,8,["active-tab"])],4),e("div",{class:"screen screen-chat",style:Ne({width:`${100/B.value}%`})},[U(Fn,{onGoToBattle:G[11]||(G[11]=ue=>Re("battle-map")),onCreateCharacter:G[12]||(G[12]=ue=>l("create-character",ue)),onViewImage:we,onHideImage:De})],4)],64))],6)]),e("div",{class:"action-panel",onTouchstart:qe,onTouchmove:Qe,onTouchend:Ve},[_.value==="battle-map"?(s(),n(W,{key:0},[t.pendingAction?(s(),n("div",s2,[e("div",n2,[U(f(K),{icon:t.pendingAction.icon,class:"action-icon"},null,8,["icon"]),e("span",null,u(t.pendingAction.title),1)]),e("div",l2,[e("button",{class:"btn-cancel",onClick:G[16]||(G[16]=ue=>l("cancel-action"))},"Отмена"),e("button",{class:"btn-confirm",disabled:!t.pendingAction.canConfirm,onClick:G[17]||(G[17]=ue=>l("confirm-action"))},"OK",8,a2)])])):(s(),n("div",o2,[(s(),n(W,null,re(je,ue=>e("button",{key:ue.id,class:"action-btn",onClick:Ze=>dt(ue)},[U(f(K),{icon:ue.icon,class:"btn-icon"},null,8,["icon"]),e("span",r2,u(ue.label),1)],8,i2)),64))]))],64)):_.value==="character-sheet"?(s(),n("div",c2,[t.isMaster?(s(),n("button",{key:0,class:"sheet-tab back-btn",onClick:G[18]||(G[18]=ue=>Re("characters"))},[U(f(K),{icon:"mdi:arrow-left",class:"tab-icon"}),G[28]||(G[28]=e("span",{class:"tab-label"},"Назад",-1))])):x("",!0),(s(),n(W,null,re(le,ue=>e("button",{key:ue.id,class:te(["sheet-tab",{active:V.value===ue.id}]),onClick:Ze=>V.value=ue.id},[U(f(K),{icon:ue.icon,class:"tab-icon"},null,8,["icon"]),e("span",u2,u(ue.label),1)],10,d2)),64))])):(s(),n("div",f2,[(s(),n(W,null,re(Se,ue=>e("button",{key:ue.id,class:te(["scene-filter-btn",{active:f(F)===ue.id}]),onClick:Ze=>f(v).setFilter(ue.id)},[U(f(K),{icon:ue.icon,class:"filter-icon"},null,8,["icon"]),e("span",m2,u(ue.label),1)],10,v2)),64))]))],32),e("div",p2,[e("button",{class:"menu-btn",onClick:at},[U(f(K),{icon:"mdi:menu"})]),e("div",h2,[(s(!0),n(W,null,re(de.value,ue=>(s(),n("button",{key:ue.id,class:te(["nav-tab",{active:_.value===ue.id}]),onClick:Ze=>Re(ue.id)},[U(f(K),{icon:ue.icon,class:"nav-icon"},null,8,["icon"])],10,g2))),128))]),e("div",{class:te(["connection-status",tt.value])},[e("span",b2,u(it.value),1),G[29]||(G[29]=e("div",{class:"status-dot"},null,-1))],2)]),U(us,{name:"menu-fade"},{default:Zt(()=>[he.value?(s(),n("div",{key:0,class:"menu-overlay",onClick:G[24]||(G[24]=ue=>he.value=!1)},[e("div",{class:"menu-content",onClick:G[23]||(G[23]=Fe(()=>{},["stop"]))},[t.isMaster&&f(g)?(s(),n(W,{key:0},[e("div",y2,[G[30]||(G[30]=e("div",{class:"menu-section-title"},"Код комнаты",-1)),e("button",{class:"room-code-btn",onClick:I},[e("span",x2,u(f(g)),1),U(f(K),{icon:b.value?"mdi:check":"mdi:content-copy",class:"copy-icon"},null,8,["icon"])]),b.value?(s(),n("p",k2,"Скопировано!")):x("",!0)]),G[31]||(G[31]=e("div",{class:"menu-divider"},null,-1))],64)):x("",!0),e("div",w2,[G[35]||(G[35]=e("div",{class:"menu-section-title"},"Режим отображения",-1)),e("div",_2,[e("button",{class:te(["layout-option",{active:f(oe)==="auto"}]),onClick:G[19]||(G[19]=ue=>f(d).setLayoutPreference("auto"))},[U(f(K),{icon:"mdi:cellphone-link"}),G[32]||(G[32]=e("span",null,"Авто",-1))],2),e("button",{class:te(["layout-option",{active:f(oe)==="mobile"}]),onClick:G[20]||(G[20]=ue=>f(d).setLayoutPreference("mobile"))},[U(f(K),{icon:"mdi:cellphone"}),G[33]||(G[33]=e("span",null,"Мобильный",-1))],2),e("button",{class:te(["layout-option",{active:f(oe)==="desktop"}]),onClick:G[21]||(G[21]=ue=>f(d).setLayoutPreference("desktop"))},[U(f(K),{icon:"mdi:monitor"}),G[34]||(G[34]=e("span",null,"Десктоп",-1))],2)])]),G[37]||(G[37]=e("div",{class:"menu-divider"},null,-1)),e("button",{class:"menu-item exit",onClick:G[22]||(G[22]=ue=>{l("leave-room"),he.value=!1})},[U(f(K),{icon:"mdi:exit-to-app"}),G[36]||(G[36]=e("span",null,"Выйти из комнаты",-1))])])])):x("",!0)]),_:1})],2))}},A2=wt($2,[["__scopeId","data-v-ba2f18a9"]]);export{A2 as G,K as I,wt as _,kt as a,Hl as b,vs as c,I2 as d,P2 as e,On as f,E2 as g,jv as h,Ft as i,Ol as p,Zs as r,M2 as s};
