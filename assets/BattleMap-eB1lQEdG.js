import{a as rn,s as Xe,r as j,n as W,m as Qe,c as p,d as h,e as r,t as R,i as A,F as G,p as ae,x as oe,f as ts,h as Me,v as He,H as ze,I as ns,J as ss,o as cn,E as un,K as Wt,g as S,q as Se,L as Ce,l as os,M as as,w as $e,N as ft,y as ls,k as Ht}from"./index-ClSw7B1m.js";import{_ as is}from"./UserAvatar-DsX_AuS6.js";import{a as dn,e as lt,f as rs,F as ge,C as we,d as fn,b as cs,u as us,H as Ut,M as Ne,g as ds,S as fs,T as Ve,L as je,h as ve,i as _e,j as Oe,k as pt}from"./fillProfile-R3rbkG_o.js";const ps={class:"flex flex-col h-full bg-slate-950"},hs={key:0,class:"h-full flex items-center justify-center"},ms={class:"text-center max-w-md"},vs={class:"text-slate-600 text-sm"},gs={class:"flex items-center justify-between text-xs text-slate-400 mb-1"},bs={class:"font-semibold text-slate-200"},ys={class:"text-base text-slate-100 whitespace-pre-line"},xs={class:"border-t border-white/10 bg-slate-900/80 backdrop-blur px-6 py-4"},ks={class:"flex gap-3 items-end max-w-4xl mx-auto"},ws=["disabled"],_s=["disabled"],$r={__name:"ChatPanel",setup(e){const t=dn(),n=rn(),{messages:s,status:o,role:l,userProfiles:i}=Xe(t),c=j(""),d=j(null),f=W(()=>s.value.filter(_=>_.type!=="system")),u=_=>{if(_===n.userId)return{nickname:n.nickname||"Гость",avatar:n.avatar};const w=i.value.get(_);return w?{nickname:w.nickname||"Гость",avatar:w.avatar}:{nickname:"Неизвестный",avatar:null}},g=W(()=>l.value==="master"?["ready","in-room"].includes(o.value):o.value==="in-room");Qe(()=>f.value.length,()=>{ze(()=>{d.value&&(d.value.scrollTop=d.value.scrollHeight)})});const v=()=>{g.value&&(t.sendMessage(c.value),c.value="")},P=_=>{_.key==="Enter"&&!_.shiftKey&&(_.preventDefault(),v())},O=_=>new Date(_).toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"});return(_,w)=>(p(),h("div",ps,[r("div",{ref_key:"listRef",ref:d,class:"flex-1 overflow-y-auto px-6 py-6 space-y-4"},[f.value.length===0?(p(),h("div",hs,[r("div",ms,[w[1]||(w[1]=r("p",{class:"text-slate-500 text-lg mb-2"},"Чат пуст",-1)),r("p",vs,R(g.value?"Отправьте первое сообщение, чтобы начать переписку.":"Подключитесь к комнате, чтобы начать общение."),1)])])):A("",!0),(p(!0),h(G,null,ae(f.value,B=>(p(),h("article",{key:B.id,class:oe(["flex gap-3 items-start max-w-2xl",[B.senderRole==="master"?"ml-0 mr-auto":"",B.senderRole==="player"?"mr-0 ml-auto flex-row-reverse":""]])},[ts(is,{avatar:u(B.userId).avatar,name:u(B.userId).nickname,size:"md"},null,8,["avatar","name"]),r("div",{class:oe(["rounded-xl px-5 py-3 border flex-1",[B.senderRole==="master"?"bg-sky-500/10 border-sky-400/30":"",B.senderRole==="player"?"bg-emerald-500/10 border-emerald-400/20":""]])},[r("header",gs,[r("span",bs,R(u(B.userId).nickname),1),r("time",null,R(O(B.time)),1)]),r("p",ys,R(B.text),1)],2)],2))),128))],512),r("footer",xs,[r("div",ks,[Me(r("textarea",{"onUpdate:modelValue":w[0]||(w[0]=B=>c.value=B),class:"flex-1 min-h-[56px] max-h-[200px] rounded-xl border border-white/10 bg-slate-950/60 px-4 py-3 text-base text-slate-50 resize-none",placeholder:"Напишите сообщение...",disabled:!g.value,onKeydown:P,rows:"1"},null,40,ws),[[He,c.value]]),r("button",{type:"button",class:"h-[56px] px-6 rounded-xl bg-sky-500/20 border border-sky-400/60 font-semibold text-sky-100 hover:bg-sky-500/30 disabled:opacity-40 transition flex-shrink-0",disabled:!g.value||!c.value.trim(),onClick:v}," Отправить ",8,_s)])])]))}},Le=e=>{const t="/TriP/";return e.startsWith("/")?t.endsWith("/")?t+e.slice(1):t+e:t.endsWith("/")?t+e:t+"/"+e},Ts=e=>Le(`/images/presets/${e}.png`),Er=e=>Le(`/images/classes/${e}.png`),Ir=e=>Le(`/images/items/${e}.png`),Ar=(e,t,n="base")=>Le(`/images/races/${e}/${t}/${n}.png`),Mr=e=>Le(`/images/gender/${e}.png`),pn=/^[a-z0-9]+(-[a-z0-9]+)*$/,it=(e,t,n,s="")=>{const o=e.split(":");if(e.slice(0,1)==="@"){if(o.length<2||o.length>3)return null;s=o.shift().slice(1)}if(o.length>3||!o.length)return null;if(o.length>1){const c=o.pop(),d=o.pop(),f={provider:o.length>0?o[0]:s,prefix:d,name:c};return t&&!tt(f)?null:f}const l=o[0],i=l.split("-");if(i.length>1){const c={provider:s,prefix:i.shift(),name:i.join("-")};return t&&!tt(c)?null:c}if(n&&s===""){const c={provider:s,prefix:"",name:l};return t&&!tt(c,n)?null:c}return null},tt=(e,t)=>e?!!((t&&e.prefix===""||e.prefix)&&e.name):!1,hn=Object.freeze({left:0,top:0,width:16,height:16}),ot=Object.freeze({rotate:0,vFlip:!1,hFlip:!1}),rt=Object.freeze({...hn,...ot}),xt=Object.freeze({...rt,body:"",hidden:!1});function Cs(e,t){const n={};!e.hFlip!=!t.hFlip&&(n.hFlip=!0),!e.vFlip!=!t.vFlip&&(n.vFlip=!0);const s=((e.rotate||0)+(t.rotate||0))%4;return s&&(n.rotate=s),n}function qt(e,t){const n=Cs(e,t);for(const s in xt)s in ot?s in e&&!(s in n)&&(n[s]=ot[s]):s in t?n[s]=t[s]:s in e&&(n[s]=e[s]);return n}function Ss(e,t){const n=e.icons,s=e.aliases||Object.create(null),o=Object.create(null);function l(i){if(n[i])return o[i]=[];if(!(i in o)){o[i]=null;const c=s[i]&&s[i].parent,d=c&&l(c);d&&(o[i]=[c].concat(d))}return o[i]}return Object.keys(n).concat(Object.keys(s)).forEach(l),o}function Ps(e,t,n){const s=e.icons,o=e.aliases||Object.create(null);let l={};function i(c){l=qt(s[c]||o[c],l)}return i(t),n.forEach(i),qt(e,l)}function mn(e,t){const n=[];if(typeof e!="object"||typeof e.icons!="object")return n;e.not_found instanceof Array&&e.not_found.forEach(o=>{t(o,null),n.push(o)});const s=Ss(e);for(const o in s){const l=s[o];l&&(t(o,Ps(e,o,l)),n.push(o))}return n}const $s={provider:"",aliases:{},not_found:{},...hn};function ht(e,t){for(const n in t)if(n in e&&typeof e[n]!=typeof t[n])return!1;return!0}function vn(e){if(typeof e!="object"||e===null)return null;const t=e;if(typeof t.prefix!="string"||!e.icons||typeof e.icons!="object"||!ht(e,$s))return null;const n=t.icons;for(const o in n){const l=n[o];if(!o||typeof l.body!="string"||!ht(l,xt))return null}const s=t.aliases||Object.create(null);for(const o in s){const l=s[o],i=l.parent;if(!o||typeof i!="string"||!n[i]&&!s[i]||!ht(l,xt))return null}return t}const Vt=Object.create(null);function Es(e,t){return{provider:e,prefix:t,icons:Object.create(null),missing:new Set}}function Ue(e,t){const n=Vt[e]||(Vt[e]=Object.create(null));return n[t]||(n[t]=Es(e,t))}function gn(e,t){return vn(t)?mn(t,(n,s)=>{s?e.icons[n]=s:e.missing.add(n)}):[]}function Is(e,t,n){try{if(typeof n.body=="string")return e.icons[t]={...n},!0}catch{}return!1}let Je=!1;function bn(e){return typeof e=="boolean"&&(Je=e),Je}function As(e){const t=typeof e=="string"?it(e,!0,Je):e;if(t){const n=Ue(t.provider,t.prefix),s=t.name;return n.icons[s]||(n.missing.has(s)?null:void 0)}}function Ms(e,t){const n=it(e,!0,Je);if(!n)return!1;const s=Ue(n.provider,n.prefix);return t?Is(s,n.name,t):(s.missing.add(n.name),!0)}function Ds(e,t){if(typeof e!="object")return!1;if(typeof t!="string"&&(t=e.provider||""),Je&&!t&&!e.prefix){let o=!1;return vn(e)&&(e.prefix="",mn(e,(l,i)=>{Ms(l,i)&&(o=!0)})),o}const n=e.prefix;if(!tt({prefix:n,name:"a"}))return!1;const s=Ue(t,n);return!!gn(s,e)}const yn=Object.freeze({width:null,height:null}),xn=Object.freeze({...yn,...ot}),Ls=/(-?[0-9.]*[0-9]+[0-9.]*)/g,Rs=/^-?[0-9.]*[0-9]+[0-9.]*$/g;function Gt(e,t,n){if(t===1)return e;if(n=n||100,typeof e=="number")return Math.ceil(e*t*n)/n;if(typeof e!="string")return e;const s=e.split(Ls);if(s===null||!s.length)return e;const o=[];let l=s.shift(),i=Rs.test(l);for(;;){if(i){const c=parseFloat(l);isNaN(c)?o.push(l):o.push(Math.ceil(c*t*n)/n)}else o.push(l);if(l=s.shift(),l===void 0)return o.join("");i=!i}}function Fs(e,t="defs"){let n="";const s=e.indexOf("<"+t);for(;s>=0;){const o=e.indexOf(">",s),l=e.indexOf("</"+t);if(o===-1||l===-1)break;const i=e.indexOf(">",l);if(i===-1)break;n+=e.slice(o+1,l).trim(),e=e.slice(0,s).trim()+e.slice(i+1)}return{defs:n,content:e}}function Ns(e,t){return e?"<defs>"+e+"</defs>"+t:t}function Os(e,t,n){const s=Fs(e);return Ns(s.defs,t+s.content+n)}const zs=e=>e==="unset"||e==="undefined"||e==="none";function Bs(e,t){const n={...rt,...e},s={...xn,...t},o={left:n.left,top:n.top,width:n.width,height:n.height};let l=n.body;[n,s].forEach(_=>{const w=[],B=_.hFlip,te=_.vFlip;let Y=_.rotate;B?te?Y+=2:(w.push("translate("+(o.width+o.left).toString()+" "+(0-o.top).toString()+")"),w.push("scale(-1 1)"),o.top=o.left=0):te&&(w.push("translate("+(0-o.left).toString()+" "+(o.height+o.top).toString()+")"),w.push("scale(1 -1)"),o.top=o.left=0);let k;switch(Y<0&&(Y-=Math.floor(Y/4)*4),Y=Y%4,Y){case 1:k=o.height/2+o.top,w.unshift("rotate(90 "+k.toString()+" "+k.toString()+")");break;case 2:w.unshift("rotate(180 "+(o.width/2+o.left).toString()+" "+(o.height/2+o.top).toString()+")");break;case 3:k=o.width/2+o.left,w.unshift("rotate(-90 "+k.toString()+" "+k.toString()+")");break}Y%2===1&&(o.left!==o.top&&(k=o.left,o.left=o.top,o.top=k),o.width!==o.height&&(k=o.width,o.width=o.height,o.height=k)),w.length&&(l=Os(l,'<g transform="'+w.join(" ")+'">',"</g>"))});const i=s.width,c=s.height,d=o.width,f=o.height;let u,g;i===null?(g=c===null?"1em":c==="auto"?f:c,u=Gt(g,d/f)):(u=i==="auto"?d:i,g=c===null?Gt(u,f/d):c==="auto"?f:c);const v={},P=(_,w)=>{zs(w)||(v[_]=w.toString())};P("width",u),P("height",g);const O=[o.left,o.top,d,f];return v.viewBox=O.join(" "),{attributes:v,viewBox:O,body:l}}const js=/\sid="(\S+)"/g,Ws="IconifyId"+Date.now().toString(16)+(Math.random()*16777216|0).toString(16);let Hs=0;function Us(e,t=Ws){const n=[];let s;for(;s=js.exec(e);)n.push(s[1]);if(!n.length)return e;const o="suffix"+(Math.random()*16777216|Date.now()).toString(16);return n.forEach(l=>{const i=typeof t=="function"?t(l):t+(Hs++).toString(),c=l.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");e=e.replace(new RegExp('([#;"])('+c+')([")]|\\.[a-z])',"g"),"$1"+i+o+"$3")}),e=e.replace(new RegExp(o,"g"),""),e}const kt=Object.create(null);function qs(e,t){kt[e]=t}function wt(e){return kt[e]||kt[""]}function Tt(e){let t;if(typeof e.resources=="string")t=[e.resources];else if(t=e.resources,!(t instanceof Array)||!t.length)return null;return{resources:t,path:e.path||"/",maxURL:e.maxURL||500,rotate:e.rotate||750,timeout:e.timeout||5e3,random:e.random===!0,index:e.index||0,dataAfterTimeout:e.dataAfterTimeout!==!1}}const Ct=Object.create(null),Ge=["https://api.simplesvg.com","https://api.unisvg.com"],nt=[];for(;Ge.length>0;)Ge.length===1||Math.random()>.5?nt.push(Ge.shift()):nt.push(Ge.pop());Ct[""]=Tt({resources:["https://api.iconify.design"].concat(nt)});function Vs(e,t){const n=Tt(t);return n===null?!1:(Ct[e]=n,!0)}function St(e){return Ct[e]}const Gs=()=>{let e;try{if(e=fetch,typeof e=="function")return e}catch{}};let Yt=Gs();function Ys(e,t){const n=St(e);if(!n)return 0;let s;if(!n.maxURL)s=0;else{let o=0;n.resources.forEach(i=>{o=Math.max(o,i.length)});const l=t+".json?icons=";s=n.maxURL-o-n.path.length-l.length}return s}function Xs(e){return e===404}const Qs=(e,t,n)=>{const s=[],o=Ys(e,t),l="icons";let i={type:l,provider:e,prefix:t,icons:[]},c=0;return n.forEach((d,f)=>{c+=d.length+1,c>=o&&f>0&&(s.push(i),i={type:l,provider:e,prefix:t,icons:[]},c=d.length),i.icons.push(d)}),s.push(i),s};function Ks(e){if(typeof e=="string"){const t=St(e);if(t)return t.path}return"/"}const Js=(e,t,n)=>{if(!Yt){n("abort",424);return}let s=Ks(t.provider);switch(t.type){case"icons":{const l=t.prefix,c=t.icons.join(","),d=new URLSearchParams({icons:c});s+=l+".json?"+d.toString();break}case"custom":{const l=t.uri;s+=l.slice(0,1)==="/"?l.slice(1):l;break}default:n("abort",400);return}let o=503;Yt(e+s).then(l=>{const i=l.status;if(i!==200){setTimeout(()=>{n(Xs(i)?"abort":"next",i)});return}return o=501,l.json()}).then(l=>{if(typeof l!="object"||l===null){setTimeout(()=>{l===404?n("abort",l):n("next",o)});return}setTimeout(()=>{n("success",l)})}).catch(()=>{n("next",o)})},Zs={prepare:Qs,send:Js};function eo(e){const t={loaded:[],missing:[],pending:[]},n=Object.create(null);e.sort((o,l)=>o.provider!==l.provider?o.provider.localeCompare(l.provider):o.prefix!==l.prefix?o.prefix.localeCompare(l.prefix):o.name.localeCompare(l.name));let s={provider:"",prefix:"",name:""};return e.forEach(o=>{if(s.name===o.name&&s.prefix===o.prefix&&s.provider===o.provider)return;s=o;const l=o.provider,i=o.prefix,c=o.name,d=n[l]||(n[l]=Object.create(null)),f=d[i]||(d[i]=Ue(l,i));let u;c in f.icons?u=t.loaded:i===""||f.missing.has(c)?u=t.missing:u=t.pending;const g={provider:l,prefix:i,name:c};u.push(g)}),t}function kn(e,t){e.forEach(n=>{const s=n.loaderCallbacks;s&&(n.loaderCallbacks=s.filter(o=>o.id!==t))})}function to(e){e.pendingCallbacksFlag||(e.pendingCallbacksFlag=!0,setTimeout(()=>{e.pendingCallbacksFlag=!1;const t=e.loaderCallbacks?e.loaderCallbacks.slice(0):[];if(!t.length)return;let n=!1;const s=e.provider,o=e.prefix;t.forEach(l=>{const i=l.icons,c=i.pending.length;i.pending=i.pending.filter(d=>{if(d.prefix!==o)return!0;const f=d.name;if(e.icons[f])i.loaded.push({provider:s,prefix:o,name:f});else if(e.missing.has(f))i.missing.push({provider:s,prefix:o,name:f});else return n=!0,!0;return!1}),i.pending.length!==c&&(n||kn([e],l.id),l.callback(i.loaded.slice(0),i.missing.slice(0),i.pending.slice(0),l.abort))})}))}let no=0;function so(e,t,n){const s=no++,o=kn.bind(null,n,s);if(!t.pending.length)return o;const l={id:s,icons:t,callback:e,abort:o};return n.forEach(i=>{(i.loaderCallbacks||(i.loaderCallbacks=[])).push(l)}),o}function oo(e,t=!0,n=!1){const s=[];return e.forEach(o=>{const l=typeof o=="string"?it(o,t,n):o;l&&s.push(l)}),s}var ao={resources:[],index:0,timeout:2e3,rotate:750,random:!1,dataAfterTimeout:!1};function lo(e,t,n,s){const o=e.resources.length,l=e.random?Math.floor(Math.random()*o):e.index;let i;if(e.random){let $=e.resources.slice(0);for(i=[];$.length>1;){const x=Math.floor(Math.random()*$.length);i.push($[x]),$=$.slice(0,x).concat($.slice(x+1))}i=i.concat($)}else i=e.resources.slice(l).concat(e.resources.slice(0,l));const c=Date.now();let d="pending",f=0,u,g=null,v=[],P=[];typeof s=="function"&&P.push(s);function O(){g&&(clearTimeout(g),g=null)}function _(){d==="pending"&&(d="aborted"),O(),v.forEach($=>{$.status==="pending"&&($.status="aborted")}),v=[]}function w($,x){x&&(P=[]),typeof $=="function"&&P.push($)}function B(){return{startTime:c,payload:t,status:d,queriesSent:f,queriesPending:v.length,subscribe:w,abort:_}}function te(){d="failed",P.forEach($=>{$(void 0,u)})}function Y(){v.forEach($=>{$.status==="pending"&&($.status="aborted")}),v=[]}function k($,x,T){const D=x!=="success";switch(v=v.filter(U=>U!==$),d){case"pending":break;case"failed":if(D||!e.dataAfterTimeout)return;break;default:return}if(x==="abort"){u=T,te();return}if(D){u=T,v.length||(i.length?N():te());return}if(O(),Y(),!e.random){const U=e.resources.indexOf($.resource);U!==-1&&U!==e.index&&(e.index=U)}d="completed",P.forEach(U=>{U(T)})}function N(){if(d!=="pending")return;O();const $=i.shift();if($===void 0){if(v.length){g=setTimeout(()=>{O(),d==="pending"&&(Y(),te())},e.timeout);return}te();return}const x={status:"pending",resource:$,callback:(T,D)=>{k(x,T,D)}};v.push(x),f++,g=setTimeout(N,e.rotate),n($,t,x.callback)}return setTimeout(N),B}function wn(e){const t={...ao,...e};let n=[];function s(){n=n.filter(c=>c().status==="pending")}function o(c,d,f){const u=lo(t,c,d,(g,v)=>{s(),f&&f(g,v)});return n.push(u),u}function l(c){return n.find(d=>c(d))||null}return{query:o,find:l,setIndex:c=>{t.index=c},getIndex:()=>t.index,cleanup:s}}function Xt(){}const mt=Object.create(null);function io(e){if(!mt[e]){const t=St(e);if(!t)return;const n=wn(t),s={config:t,redundancy:n};mt[e]=s}return mt[e]}function ro(e,t,n){let s,o;if(typeof e=="string"){const l=wt(e);if(!l)return n(void 0,424),Xt;o=l.send;const i=io(e);i&&(s=i.redundancy)}else{const l=Tt(e);if(l){s=wn(l);const i=e.resources?e.resources[0]:"",c=wt(i);c&&(o=c.send)}}return!s||!o?(n(void 0,424),Xt):s.query(t,o,n)().abort}function Qt(){}function co(e){e.iconsLoaderFlag||(e.iconsLoaderFlag=!0,setTimeout(()=>{e.iconsLoaderFlag=!1,to(e)}))}function uo(e){const t=[],n=[];return e.forEach(s=>{(s.match(pn)?t:n).push(s)}),{valid:t,invalid:n}}function Ye(e,t,n){function s(){const o=e.pendingIcons;t.forEach(l=>{o&&o.delete(l),e.icons[l]||e.missing.add(l)})}if(n&&typeof n=="object")try{if(!gn(e,n).length){s();return}}catch(o){console.error(o)}s(),co(e)}function Kt(e,t){e instanceof Promise?e.then(n=>{t(n)}).catch(()=>{t(null)}):t(e)}function fo(e,t){e.iconsToLoad?e.iconsToLoad=e.iconsToLoad.concat(t).sort():e.iconsToLoad=t,e.iconsQueueFlag||(e.iconsQueueFlag=!0,setTimeout(()=>{e.iconsQueueFlag=!1;const{provider:n,prefix:s}=e,o=e.iconsToLoad;if(delete e.iconsToLoad,!o||!o.length)return;const l=e.loadIcon;if(e.loadIcons&&(o.length>1||!l)){Kt(e.loadIcons(o,s,n),u=>{Ye(e,o,u)});return}if(l){o.forEach(u=>{const g=l(u,s,n);Kt(g,v=>{const P=v?{prefix:s,icons:{[u]:v}}:null;Ye(e,[u],P)})});return}const{valid:i,invalid:c}=uo(o);if(c.length&&Ye(e,c,null),!i.length)return;const d=s.match(pn)?wt(n):null;if(!d){Ye(e,i,null);return}d.prepare(n,s,i).forEach(u=>{ro(n,u,g=>{Ye(e,u.icons,g)})})}))}const po=(e,t)=>{const n=oo(e,!0,bn()),s=eo(n);if(!s.pending.length){let d=!0;return t&&setTimeout(()=>{d&&t(s.loaded,s.missing,s.pending,Qt)}),()=>{d=!1}}const o=Object.create(null),l=[];let i,c;return s.pending.forEach(d=>{const{provider:f,prefix:u}=d;if(u===c&&f===i)return;i=f,c=u,l.push(Ue(f,u));const g=o[f]||(o[f]=Object.create(null));g[u]||(g[u]=[])}),s.pending.forEach(d=>{const{provider:f,prefix:u,name:g}=d,v=Ue(f,u),P=v.pendingIcons||(v.pendingIcons=new Set);P.has(g)||(P.add(g),o[f][u].push(g))}),l.forEach(d=>{const f=o[d.provider][d.prefix];f.length&&fo(d,f)}),t?so(t,s,l):Qt};function ho(e,t){const n={...e};for(const s in t){const o=t[s],l=typeof o;s in yn?(o===null||o&&(l==="string"||l==="number"))&&(n[s]=o):l===typeof n[s]&&(n[s]=s==="rotate"?o%4:o)}return n}const mo=/[\s,]+/;function vo(e,t){t.split(mo).forEach(n=>{switch(n.trim()){case"horizontal":e.hFlip=!0;break;case"vertical":e.vFlip=!0;break}})}function go(e,t=0){const n=e.replace(/^-?[0-9.]*/,"");function s(o){for(;o<0;)o+=4;return o%4}if(n===""){const o=parseInt(e);return isNaN(o)?0:s(o)}else if(n!==e){let o=0;switch(n){case"%":o=25;break;case"deg":o=90}if(o){let l=parseFloat(e.slice(0,e.length-n.length));return isNaN(l)?0:(l=l/o,l%1===0?s(l):0)}}return t}function bo(e,t){let n=e.indexOf("xlink:")===-1?"":' xmlns:xlink="http://www.w3.org/1999/xlink"';for(const s in t)n+=" "+s+'="'+t[s]+'"';return'<svg xmlns="http://www.w3.org/2000/svg"'+n+">"+e+"</svg>"}function yo(e){return e.replace(/"/g,"'").replace(/%/g,"%25").replace(/#/g,"%23").replace(/</g,"%3C").replace(/>/g,"%3E").replace(/\s+/g," ")}function xo(e){return"data:image/svg+xml,"+yo(e)}function ko(e){return'url("'+xo(e)+'")'}const Jt={...xn,inline:!1},wo={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink","aria-hidden":!0,role:"img"},_o={display:"inline-block"},_t={backgroundColor:"currentColor"},_n={backgroundColor:"transparent"},Zt={Image:"var(--svg)",Repeat:"no-repeat",Size:"100% 100%"},en={webkitMask:_t,mask:_t,background:_n};for(const e in en){const t=en[e];for(const n in Zt)t[e+n]=Zt[n]}const st={};["horizontal","vertical"].forEach(e=>{const t=e.slice(0,1)+"Flip";st[e+"-flip"]=t,st[e.slice(0,1)+"-flip"]=t,st[e+"Flip"]=t});function tn(e){return e+(e.match(/^[-0-9.]+$/)?"px":"")}const nn=(e,t)=>{const n=ho(Jt,t),s={...wo},o=t.mode||"svg",l={},i=t.style,c=typeof i=="object"&&!(i instanceof Array)?i:{};for(let _ in t){const w=t[_];if(w!==void 0)switch(_){case"icon":case"style":case"onLoad":case"mode":case"ssr":break;case"inline":case"hFlip":case"vFlip":n[_]=w===!0||w==="true"||w===1;break;case"flip":typeof w=="string"&&vo(n,w);break;case"color":l.color=w;break;case"rotate":typeof w=="string"?n[_]=go(w):typeof w=="number"&&(n[_]=w);break;case"ariaHidden":case"aria-hidden":w!==!0&&w!=="true"&&delete s["aria-hidden"];break;default:{const B=st[_];B?(w===!0||w==="true"||w===1)&&(n[B]=!0):Jt[_]===void 0&&(s[_]=w)}}}const d=Bs(e,n),f=d.attributes;if(n.inline&&(l.verticalAlign="-0.125em"),o==="svg"){s.style={...l,...c},Object.assign(s,f);let _=0,w=t.id;return typeof w=="string"&&(w=w.replace(/-/g,"_")),s.innerHTML=Us(d.body,w?()=>w+"ID"+_++:"iconifyVue"),Wt("svg",s)}const{body:u,width:g,height:v}=e,P=o==="mask"||(o==="bg"?!1:u.indexOf("currentColor")!==-1),O=bo(u,{...f,width:g+"",height:v+""});return s.style={...l,"--svg":ko(O),width:tn(f.width),height:tn(f.height),..._o,...P?_t:_n,...c},Wt("span",s)};bn(!0);qs("",Zs);if(typeof document<"u"&&typeof window<"u"){const e=window;if(e.IconifyPreload!==void 0){const t=e.IconifyPreload,n="Invalid IconifyPreload syntax.";typeof t=="object"&&t!==null&&(t instanceof Array?t:[t]).forEach(s=>{try{(typeof s!="object"||s===null||s instanceof Array||typeof s.icons!="object"||typeof s.prefix!="string"||!Ds(s))&&console.error(n)}catch{console.error(n)}})}if(e.IconifyProviders!==void 0){const t=e.IconifyProviders;if(typeof t=="object"&&t!==null)for(let n in t){const s="IconifyProviders["+n+"] is invalid.";try{const o=t[n];if(typeof o!="object"||!o||o.resources===void 0)continue;Vs(n,o)||console.error(s)}catch{console.error(s)}}}}const To={...rt,body:""},Dr=ns((e,{emit:t})=>{const n=j(null);function s(){var f,u;n.value&&((u=(f=n.value).abort)==null||u.call(f),n.value=null)}const o=j(!!e.ssr),l=j(""),i=ss(null);function c(){const f=e.icon;if(typeof f=="object"&&f!==null&&typeof f.body=="string")return l.value="",{data:f};let u;if(typeof f!="string"||(u=it(f,!1,!0))===null)return null;let g=As(u);if(!g){const O=n.value;return(!O||O.name!==f)&&(g===null?n.value={name:f}:n.value={name:f,abort:po([u],d)}),null}s(),l.value!==f&&(l.value=f,ze(()=>{t("load",f)}));const v=e.customise;if(v){g=Object.assign({},g);const O=v(g.body,u.name,u.prefix,u.provider);typeof O=="string"&&(g.body=O)}const P=["iconify"];return u.prefix!==""&&P.push("iconify--"+u.prefix),u.provider!==""&&P.push("iconify--"+u.provider),{data:g,classes:P}}function d(){var u;const f=c();f?f.data!==((u=i.value)==null?void 0:u.data)&&(i.value=f):i.value=null}return o.value?d():cn(()=>{o.value=!0,d()}),Qe(()=>e.icon,d),un(s),()=>{const f=i.value;if(!f)return nn(To,e);let u=e;return f.classes&&(u={...e,class:f.classes.join(" ")}),nn({...rt,...f.data},u)}},{props:["icon","mode","ssr","width","height","style","color","inline","rotate","hFlip","horizontalFlip","vFlip","verticalFlip","flip","id","ariaHidden","customise","title"],emits:["load"]}),Co=[{id:"war",name:"Война",nameEn:"War",description:"Физическая сила, боевые навыки, агрессия и доминирование",characteristic:{name:"Мощь",nameEn:"Might",abbreviation:"MIG"},check:{name:"Конфликт",nameEn:"Conflict",description:"Проверки прямого противостояния, боя и физической силы"},color:"#dc2626",colorName:"red",icon:"game-icons:crossed-swords",characteristicIcon:"game-icons:embrassed-energy",checkIcon:"game-icons:arrow-scope",position:{angle:330,corner:"top-left",description:"Верхний левый угол шестиугольника"},neighbors:["nature","knowledge"],opposite:"shadow",axis:{id:"power",name:"Сила",nameEn:"Power",pole:"active"}},{id:"knowledge",name:"Знание",nameEn:"Knowledge",description:"Интеллект, логика, наука и аналитическое мышление",characteristic:{name:"Разум",nameEn:"Reason",abbreviation:"REA"},check:{name:"Порядок",nameEn:"Order",description:"Проверки знаний, логики и систематического подхода"},color:"#3b82f7",colorName:"blue",icon:"game-icons:open-book",characteristicIcon:"game-icons:inspiration",checkIcon:"game-icons:materials-science",position:{angle:30,corner:"top-right",description:"Верхний правый угол шестиугольника"},neighbors:["war","community"],opposite:"mysticism",axis:{id:"progress",name:"Развитие",nameEn:"Progress",pole:"rational"}},{id:"community",name:"Общество",nameEn:"Community",description:"Социальные связи, лидерство, убеждение и дипломатия",characteristic:{name:"Харизма",nameEn:"Charisma",abbreviation:"CHA"},check:{name:"Влияние",nameEn:"Influence",description:"Проверки социального взаимодействия и убеждения"},color:"#f59e0b",colorName:"amber",icon:"game-icons:human-pyramid",characteristicIcon:"game-icons:cheerful",checkIcon:"game-icons:caesar",position:{angle:90,corner:"right",description:"Правый угол шестиугольника"},neighbors:["knowledge","shadow"],opposite:"nature",axis:{id:"path",name:"Путь",nameEn:"Path",pole:"civilization"}},{id:"shadow",name:"Тень",nameEn:"Shadow",description:"Скрытность, обман, манипуляция и тайные действия",characteristic:{name:"Хитрость",nameEn:"Cunning",abbreviation:"CUN"},check:{name:"Коварство",nameEn:"Treachery",description:"Проверки скрытности, обмана и манипуляций"},color:"#374151",colorName:"gray",icon:"game-icons:cowled",characteristicIcon:"game-icons:domino-mask",checkIcon:"game-icons:hooded-figure",position:{angle:150,corner:"bottom-right",description:"Нижний правый угол шестиугольника"},neighbors:["community","mysticism"],opposite:"war",axis:{id:"power",name:"Сила",nameEn:"Power",pole:"subtle"}},{id:"mysticism",name:"Мистика",nameEn:"Mysticism",description:"Магия, духовность, интуиция и связь с потусторонним",characteristic:{name:"Интуиция",nameEn:"Intuition",abbreviation:"INT"},check:{name:"Хаос",nameEn:"Chaos",description:"Проверки магии, интуиции и духовной связи"},color:"#9333ea",colorName:"purple",icon:"game-icons:pentacle",characteristicIcon:"game-icons:coiling-curl",checkIcon:"game-icons:small-fire",position:{angle:210,corner:"bottom-left",description:"Нижний левый угол шестиугольника"},neighbors:["shadow","nature"],opposite:"knowledge",axis:{id:"progress",name:"Развитие",nameEn:"Progress",pole:"intuitive"}},{id:"nature",name:"Природа",nameEn:"Nature",description:"Связь с природой, выживание, животные инстинкты и гармония",characteristic:{name:"Восприятие",nameEn:"Perception",abbreviation:"PER"},check:{name:"Поиск",nameEn:"Search",description:"Проверки наблюдательности, выживания и связи с природой"},color:"#22c55e",colorName:"green",icon:"game-icons:curled-leaf",characteristicIcon:"game-icons:semi-closed-eye",checkIcon:"game-icons:spyglass",position:{angle:270,corner:"left",description:"Левый угол шестиугольника"},neighbors:["mysticism","war"],opposite:"community",axis:{id:"path",name:"Путь",nameEn:"Path",pole:"wilderness"}}],So=[{id:"power",name:"Сила",nameEn:"Power",description:"Ось силы: от прямой физической мощи до скрытого влияния",aspects:["war","shadow"],poles:{active:{aspect:"war",description:"Прямое действие, открытая сила, доминирование"},subtle:{aspect:"shadow",description:"Скрытое влияние, манипуляция, тайные действия"}}},{id:"progress",name:"Развитие",nameEn:"Progress",description:"Ось развития: от рационального познания до интуитивного понимания",aspects:["knowledge","mysticism"],poles:{rational:{aspect:"knowledge",description:"Логика, наука, аналитическое мышление"},intuitive:{aspect:"mysticism",description:"Интуиция, магия, духовное познание"}}},{id:"path",name:"Путь",nameEn:"Path",description:"Ось пути: от дикой природы до цивилизованного общества",aspects:["nature","community"],poles:{wilderness:{aspect:"nature",description:"Природа, инстинкты, гармония с окружением"},civilization:{aspect:"community",description:"Общество, культура, социальные структуры"}}}],Po={systemName:"triP",systemFullName:"Triple P System",systemDescription:"Система трёх осей: Power (Сила), Progress (Развитие), Path (Путь)",version:"1.0",aspectCount:6,axisCount:3,circularOrder:["war","knowledge","community","shadow","mysticism","nature"]},$o={aspects:Co,axes:So,metadata:Po},Eo=[{id:"clothes",category:"armor",subcat:"light",name:"Обычная одежда",desc:"Надевать такую в бой - довольно сомнительная затея. Однако на полях сражений нередко оказывались те, кто не смог себе позволить вовсе никакую броню. А иногда и серьёзных воинов нападение заставало не готовыми, погружёнными в обычные бытовые проблемы.",price:1,epoch:1,defence:0,resist:0,movement:0,bursts:0},{id:"makeshift_light_armor",category:"armor",subcat:"light",name:"Крепкая одежда",desc:"Некоторые виды одежды лучше других держат удар, что позволяет использовать их в качестве импровизированной брони. Это может быть куртка из толстой кожи, шкура зверя или вовсе обычные одеяния, на которые нашили твёрдые элементы.",price:3,epoch:2,defence:3,resist:0,movement:0,bursts:0},{id:"makeshift_heavy_armor",category:"armor",subcat:"heavy",name:"Кустарная тяжёлая броня",desc:"Хорошенько потрудившись, можно сделать из обычной одежды некое подобие брони. Обилие нашитых элементов здорово сковывает движение, зато такой доспех снижает входящий урон и (главное), очень дёшев в производстве.",price:3,epoch:2,defence:0,resist:1,movement:-1,bursts:-1},{id:"light_armor",category:"armor",subcat:"light",name:"Лёгкая броня",desc:"Лёгкая броня не сковывает движений и даёт кое-какую защиту - попасть в уязвимое место противнику становится значительно сложнее.",price:5,epoch:4,defence:6,resist:0,movement:0,bursts:0},{id:"heavy_armor",category:"armor",subcat:"heavy",name:"Тяжёлая броня",desc:"Хорошая тяжёлая броня лишь немного сковывает движения, но уворачиваться в ней уже гораздо сложнее. Зато, если по Вам всё же попали, урона Вы получите значительно меньше.",price:5,epoch:4,defence:0,resist:1,movement:-1,bursts:0},{id:"late_light_armor",category:"armor",subcat:"light",name:"Поздняя лёгкая броня",desc:"Позволить себе такой шедевр мастерства бронников могут не многие, зато живут на поле боя эти счастливчики гораздо дольше других. Защищённых областей на теле больше, а маневренность при этом никак не страдает.",price:7,epoch:6,defence:12,resist:0,movement:0,bursts:0},{id:"late_medium_armor",category:"armor",subcat:"middle",name:"Поздняя средняя броня",desc:"Хороший компромисс между подвижностью и защищённостью, но по совершенно бескомпромиссной цене.",price:7,epoch:6,defence:3,resist:1,movement:0,bursts:0},{id:"late_heavy_armor",category:"armor",subcat:"heavy",name:"Поздняя тяжёлая броня",desc:"Для тех, кто хочет почувствовать себя настоящим танком на поле боя - беспрецедентный уровень защищённости при минимальной подвижности. Несмотря на огромную цену этих доспехов, вряд ли найдётся идиот, который захочет сразиться с Вами ради такого трофея.",price:7,epoch:6,defence:0,resist:2,movement:-1,bursts:0},{id:"simple_spear",category:"weapon",subcat:"spears",name:"Простое копьё",desc:"",length:2,hands:1,price:2,epoch:2,attack:4,defence:3,damageType:"Колющий",armorPen:0,damage:{0:"Царапина",3:"Лёгкий урон",6:"Точный удар"}},{id:"iron_spear",category:"weapon",subcat:"spears",name:"Железное копьё",desc:"",length:2,hands:1,price:4,epoch:4,attack:5,defence:3,damageType:"Колющий",armorPen:0,damage:{0:"Царапина",2:"Лёгкий урон",4:"Точный удар",6:"Тяжёлый урон"}},{id:"steel_spear",category:"weapon",subcat:"spears",name:"Стальное копьё",desc:"",length:2,hands:1,price:6,epoch:6,attack:6,defence:4,damageType:"Колющий",armorPen:0,damage:{0:"Царапина",2:"Лёгкий урон",4:"Точный удар",6:"Тяжёлый урон",9:"Огромный урон"}},{id:"iron_glaive",category:"weapon",subcat:"spears",name:"Глефа",desc:"",length:2,hands:2,price:5,epoch:5,attack:6,defence:2,damageType:"Рубящий",armorPen:0,damage:{0:"Лёгкий урон",3:"Тяжёлый урон",6:"Точный удар",9:"Огромный урон"}},{id:"steel_glaive",category:"weapon",subcat:"spears",name:"Стальная глефа",desc:"",length:2,hands:2,price:7,epoch:7,attack:8,defence:4,damageType:"Рубящий",armorPen:0,damage:{0:"Лёгкий урон",2:"Тяжёлый урон",4:"Точный удар",8:"Огромный урон"}},{id:"iron_halberd",category:"weapon",subcat:"spears",name:"Алебарда",desc:"",length:2,hands:2,price:5,epoch:5,attack:4,defence:3,damageType:"Рубящий",armorPen:0,damage:{0:"Лёгкий урон",2:"Тяжёлый урон",6:"Огромный урон"}},{id:"steel_halberd",category:"weapon",subcat:"spears",name:"Стальная алебарда",desc:"",length:2,hands:2,price:7,epoch:7,attack:5,defence:4,damageType:"Рубящий",armorPen:0,damage:{0:"Лёгкий урон",2:"Тяжёлый урон",6:"Огромный урон"}},{id:"simple_bow",category:"weapon",subcat:"bows",name:"Короткий лук",desc:"",spec:"Нельзя стрелять с порывом",length:2,hands:2,price:3,epoch:2,attack:6,defence:0,damageType:"Колющий",armorPen:0,damage:{0:"Царапина",3:"Лёгкий урон",6:"Точный удар"}},{id:"strong_bow",category:"weapon",subcat:"bows",name:"Боевой лук",desc:"",spec:"",length:2,hands:2,price:4,epoch:4,attack:6,defence:0,damageType:"Колющий",armorPen:0,damage:{0:"Царапина",3:"Лёгкий урон",6:"Точный удар",9:"Тяжёлый урон"}},{id:"longbow",category:"weapon",subcat:"bows",name:"Длинный лук",desc:"",spec:"Нельзя стрелять без порыва. Можно вкладывать в выстрел второй порыв, тогда игнорирует единицу брони.",length:2,hands:2,price:5,epoch:4,attack:6,defence:0,damageType:"Колющий",armorPen:0,damage:{0:"Лёгкий урон",3:"Точный удар",6:"Тяжёлый урон",12:"Огромный урон"}},{id:"stone_knife",category:"weapon",subcat:"daggers",name:"Простой нож",desc:"",length:1,hands:.5,price:1,epoch:1,attack:2,defence:0,damageType:"Колющий",armorPen:0,damage:{0:"Царапина",3:"Лёгкий урон",5:"Точный удар"}},{id:"knife",category:"weapon",subcat:"daggers",name:"Добротный нож",desc:"",length:1,hands:.5,price:2,epoch:2,attack:2,defence:1,damageType:"Колющий",armorPen:0,damage:{0:"Царапина",2:"Лёгкий урон",3:"Точный удар"}},{id:"steel_dagger",category:"weapon",subcat:"daggers",name:"Cтальной кинжал",desc:"",length:1,hands:.5,price:5,epoch:4,attack:3,defence:1,damageType:"Колющий",armorPen:0,damage:{0:"Царапина",2:"Лёгкий урон",3:"Точный удар",4:"Тяжёлый урон"}},{id:"stiletto",category:"weapon",subcat:"daggers",name:"Стилет",desc:"Стилет не особенно то удобен в бою, зато замечательно пронзает многие виды доспехов.",length:1,hands:.5,price:6,epoch:5,attack:2,defence:0,damageType:"Колющий",armorPen:2,damage:{0:"Царапина",2:"Лёгкий урон",3:"Точный удар",6:"Тяжёлый урон"}},{id:"main_gauche",category:"weapon",subcat:"daggers",name:"Дага",desc:"Дага - преимущественно защитный кинжал во вторую руку, тем не менее может применяться и для нанесения серьёзных ударов. Особенно, если вражеская защита пробита. Атаки дагой во второй руке могут наносить ту же категорию ранения, что и атаки основным оружием, а не на категорию ниже, как обычно.",length:1,hands:1,price:6,epoch:5,attack:2,defence:4,damageType:"Колющий",armorPen:0,damage:{0:"Царапина",2:"Лёгкий урон",3:"Точный удар",6:"Тяжёлый урон"}},{id:"wooden_flail",category:"weapon",subcat:"flails",name:"Цеп",desc:"",length:1,hands:1,price:1,epoch:2,attack:6,defence:0,damageType:"Дробящий",armorPen:1,damage:{0:"Царапина",3:"Лёгкий урон"}},{id:"iron_flail",category:"weapon",subcat:"flails",name:"Железный цеп",desc:"",length:2,hands:1,price:5,epoch:4,attack:8,defence:0,damageType:"Дробящий",armorPen:1,damage:{0:"Царапина",6:"Лёгкий урон",12:"Тяжёлый урон",15:"Точный удар"}},{id:"steel_flail",category:"weapon",subcat:"flails",name:"Стальной цеп",desc:"",length:2,hands:1,price:6,epoch:6,attack:9,defence:0,damageType:"Дробящий",armorPen:1,damage:{0:"Царапина",6:"Лёгкий урон",9:"Тяжёлый урон",12:"Точный удар"}},{id:"wooden_club",category:"weapon",subcat:"maces",name:"Дубинка",desc:"",length:1,hands:1,price:1,epoch:1,attack:2,defence:2,damageType:"Дробящий",armorPen:1,damage:{0:"Царапина",6:"Лёгкий урон"}},{id:"simple_staff",category:"weapon",subcat:"maces",name:"Простой посох",desc:"",length:2,hands:2,price:1,epoch:1,attack:2,defence:2,damageType:"Дробящий",armorPen:0,damage:{0:"Царапина",6:"Лёгкий урон"}},{id:"battle_staff",category:"weapon",subcat:"maces",name:"Боевой посох",desc:"",length:2,hands:2,price:3,epoch:3,attack:4,defence:2,damageType:"Дробящий",armorPen:0,damage:{0:"Царапина",5:"Лёгкий урон",10:"Тяжёлый урон"}},{id:"steel_staff",category:"weapon",subcat:"maces",name:"Стальной посох",desc:"",length:2,hands:2,price:5,epoch:5,attack:4,defence:4,damageType:"Дробящий",armorPen:1,damage:{0:"Царапина",5:"Лёгкий урон",10:"Тяжёлый урон"}},{id:"iron_mace",category:"weapon",subcat:"maces",name:"Булава",desc:"",length:1,hands:1,price:5,epoch:4,attack:4,defence:2,damageType:"Дробящий",armorPen:1,damage:{0:"Царапина",6:"Тяжёлый урон",12:"Точный удар"}},{id:"steel_mace",category:"weapon",subcat:"maces",name:"Стальная булава",desc:"",length:1,hands:1,price:7,epoch:6,attack:5,defence:3,damageType:"Дробящий",armorPen:1,damage:{0:"Царапина",2:"Лёгкий урон",4:"Тяжёлый урон",6:"Точный удар"}},{id:"simple_axe",category:"weapon",subcat:"axes",name:"Плотницкий топор",desc:"",length:1,hands:1,price:2,epoch:1,attack:4,defence:2,damageType:"Режущий",armorPen:0,damage:{0:"Царапина",8:"Тяжёлый урон",9:"Точный удар"}},{id:"battle_axe",category:"weapon",subcat:"axes",name:"Боевой топорик",desc:"",length:1,hands:1,price:5,epoch:4,attack:6,defence:3,damageType:"Режущий",armorPen:0,damage:{0:"Царапина",3:"Лёгкий урон",6:"Точный удар",9:"Тяжёлый урон"}},{id:"steel_axe",category:"weapon",subcat:"axes",name:"Стальной топор",desc:"",length:1,hands:1,price:6,epoch:7,attack:8,defence:3,damageType:"Режущий",armorPen:0,damage:{0:"Царапина",2:"Лёгкий урон",4:"Точный удар",6:"Тяжёлый урон"}},{id:"battle_greataxe",category:"weapon",subcat:"axes",name:"Двуручный топор",desc:"",length:2,hands:2,price:6,epoch:5,attack:6,defence:3,damageType:"Режущий",armorPen:0,damage:{0:"Лёгкий урон",3:"Тяжёлый урон",9:"Огромный урон",12:"Точный удар"}},{id:"steel_greataxe",category:"weapon",subcat:"axes",name:"Стальной двуручный топор",desc:"",length:2,hands:2,price:7,epoch:7,attack:8,defence:3,damageType:"Режущий",armorPen:0,damage:{0:"Лёгкий урон",2:"Тяжёлый урон",8:"Огромный урон",10:"Точный удар"}},{id:"stone_hammer",category:"weapon",subcat:"maces",name:"Каменный молоток",desc:"",length:1,hands:1,price:2,epoch:2,attack:2,defence:0,damageType:"Дробящий",armorPen:1,damage:{0:"Лёгкий урон",6:"Тяжёлый урон",12:"Точный удар"}},{id:"stone_greathammer",category:"weapon",subcat:"maces",name:"Каменная кувалда",desc:"",length:2,hands:2,price:2,epoch:2,attack:0,defence:0,damageType:"Дробящий",armorPen:1,damage:{0:"Тяжёлый урон",6:"Огромный урон"}},{id:"iron_hammer",category:"weapon",subcat:"maces",name:"Железный молот",desc:"",length:1,hands:1,price:3,epoch:3,attack:3,defence:0,damageType:"Дробящий",armorPen:1,damage:{0:"Лёгкий урон",5:"Тяжёлый урон",10:"Точный удар"}},{id:"iron_greathammer",category:"weapon",subcat:"maces",name:"Железная кувалда",desc:"",length:2,hands:2,price:5,epoch:4,attack:0,defence:0,damageType:"Дробящий",armorPen:1,damage:{0:"Тяжёлый урон",5:"Огромный урон"}},{id:"iron_warhammer",category:"weapon",subcat:"maces",name:"Железный боевой молот",desc:"",length:1,hands:1,price:4,epoch:4,attack:4,defence:0,damageType:"Дробящий",armorPen:2,damage:{0:"Лёгкий урон",6:"Тяжёлый урон",12:"Точный удар"}},{id:"iron_greatwarhammer",category:"weapon",subcat:"maces",name:"Двуручный боевой молот",desc:"",length:2,hands:2,price:6,epoch:5,attack:2,defence:0,damageType:"Дробящий",armorPen:2,damage:{0:"Тяжёлый урон",6:"Огромный урон",12:"Точный удар"}},{id:"steel_warhammer",category:"weapon",subcat:"maces",name:"Стальной боевой молот",desc:"",length:1,hands:1,price:6,epoch:7,attack:5,defence:2,damageType:"Дробящий",armorPen:2,damage:{0:"Лёгкий урон",4:"Тяжёлый урон",8:"Точный удар"}},{id:"steel_greatwarhammer",category:"weapon",subcat:"maces",name:"Длинный стальной боевой молот",desc:"",length:2,hands:2,price:7,epoch:7,attack:3,defence:2,damageType:"Дробящий",armorPen:2,damage:{0:"Тяжёлый урон",4:"Огромный урон",8:"Точный удар"}},{id:"wooden_buckler",category:"shield",subcat:"shields",name:"Деревянный баклер",desc:"",spec:"Баклер может использоваться для атак, как второе оружие.",length:0,hands:.5,price:5,epoch:4,attack:1,defence:{front:{melee:3,ranged:3},side:{melee:3,ranged:0}}},{id:"wooden_shield",category:"shield",subcat:"shields",name:"Деревянный щит",desc:"",spec:"Небольшим щитом можно толкать противника, затратив один порыв.",length:0,hands:1,price:4,epoch:3,attack:1,defence:{front:{melee:6,ranged:6}}},{id:"large_wooden_shield",category:"shield",subcat:"shields",name:"Большой деревянный щит",desc:"",length:0,hands:1,price:5,epoch:3,defence:{front:{melee:6,ranged:9}}},{id:"wooden_tower_shield",category:"shield",subcat:"shields",name:"Деревянный башенный щит",desc:"",length:0,hands:1,price:5,epoch:3,movement:-1,attack:-3,defence:{front:{melee:9,ranged:12}}},{id:"metal_buckler",category:"shield",subcat:"shields",name:"Стальной баклер",desc:"",spec:"Баклер может использоваться для атак, как второе оружие.",length:0,hands:.5,price:6,epoch:6,attack:3,defence:{front:{melee:6,ranged:3},side:{melee:6,ranged:0}}},{id:"metal_shield",category:"shield",subcat:"shields",name:"Стальной щит",desc:"",spec:"Небольшим щитом можно толкать противника, затратив один порыв.",length:0,hands:1,price:7,epoch:6,attack:3,defence:{front:{melee:6,ranged:6}}},{id:"large_metal_shield",category:"shield",subcat:"shields",name:"Большой стальной щит",desc:"",length:0,hands:1,price:5,epoch:7,attack:1,defence:{front:{melee:9,ranged:9}}},{id:"metal_tower_shield",category:"shield",subcat:"shields",name:"Cтальной башенный щит",desc:"",length:0,hands:1,price:7,epoch:7,defence:{front:{melee:12,ranged:12}}},{id:"iron_shortsword",category:"weapon",subcat:"swords",name:"Короткий меч",desc:"",length:1,hands:1,price:4,epoch:3,attack:3,defence:5,damageType:"Режущий",armorPen:0,damage:{0:"Царапина",4:"Лёгкий урон",8:"Точный удар",12:"Тяжёлый урон"}},{id:"iron_sword",category:"weapon",subcat:"swords",name:"Меч пехотинца",desc:"",length:2,hands:1,price:4,epoch:4,attack:5,defence:5,damageType:"Режущий",armorPen:0,damage:{0:"Царапина",3:"Лёгкий урон",6:"Точный удар",10:"Тяжёлый урон"}},{id:"iron_falchion",category:"weapon",subcat:"swords",name:"Фальшион",desc:"",length:1,hands:1,price:4,epoch:4,attack:7,defence:4,damageType:"Режущий",armorPen:0,damage:{0:"Царапина",3:"Лёгкий урон",6:"Точный удар",10:"Тяжёлый урон"}},{id:"iron_greatsword",category:"weapon",subcat:"swords",name:"Двуручный меч",desc:"",length:2,hands:2,price:5,epoch:4,attack:6,defence:3,damageType:"Режущий",armorPen:0,damage:{0:"Лёгкий урон",4:"Тяжёлый урон",8:"Огромный урон"}},{id:"steel_shortsword",category:"weapon",subcat:"swords",name:"Стальной короткий меч",desc:"",length:1,hands:1,price:6,epoch:6,attack:4,defence:5,damageType:"Режущий",armorPen:0,damage:{0:"Царапина",3:"Лёгкий урон",6:"Точный удар",9:"Тяжёлый урон"}},{id:"steel_sword",category:"weapon",subcat:"swords",name:"Стальной меч",desc:"",length:2,hands:1,price:7,epoch:6,attack:6,defence:6,damageType:"Режущий",armorPen:0,damage:{0:"Царапина",2:"Лёгкий урон",4:"Точный удар",8:"Тяжёлый урон"}},{id:"steel_saber",category:"weapon",subcat:"swords",name:"Сабля",desc:"",length:2,hands:1,price:7,epoch:7,attack:8,defence:3,damageType:"Режущий",armorPen:0,damage:{0:"Царапина",3:"Лёгкий урон",6:"Тяжёлый урон",8:"Точный удар"}},{id:"steel_scimitar",category:"weapon",subcat:"swords",name:"Скимитар",desc:"",length:2,hands:1,price:7,epoch:7,attack:9,defence:2,damageType:"Режущий",armorPen:0,damage:{0:"Царапина",3:"Лёгкий урон",6:"Тяжёлый урон",9:"Точный удар"}},{id:"steel_greatsword",category:"weapon",subcat:"swords",name:"Качественный двуручный меч",desc:"",length:2,hands:2,price:7,epoch:6,attack:7,defence:4,damageType:"Режущий",armorPen:0,damage:{0:"Лёгкий урон",4:"Тяжёлый урон",6:"Огромный урон"}},{id:"rapier",category:"weapon",subcat:"swords",name:"Рапира",desc:"",length:2,hands:1.5,price:6,epoch:7,attack:7,defence:3,damageType:"Колющий",armorPen:0,damage:{0:"Царапина",2:"Лёгкий урон",6:"Точный удар",8:"Тяжёлый урон"}},{id:"hand_crossbow",category:"weapon",subcat:"crossbows",name:"Ручной арбалет",desc:"Требует порыва на перезарядку",length:2,hands:1.5,price:5,epoch:5,attack:4,defence:0,damageType:"Колющий",armorPen:0,damage:{0:"Царапина",5:"Лёгкий урон"}},{id:"crossbow",category:"weapon",subcat:"crossbows",name:"Арбалет",desc:"Требуется два порыва или полное основное действие на перезарядку",length:2,hands:2,price:6,epoch:5,attack:6,defence:0,damageType:"Колющий",armorPen:0,damage:{0:"Царапина",4:"Лёгкий урон",6:"Точный удар",8:"Тяжёлый урон"}},{id:"heavy_crossbow",category:"weapon",subcat:"crossbows",name:"Тяжёлый арбалет",desc:"Требуется полное действие и один порыв на перезарядку, в процессе нельзя передвигаться.",length:2,hands:2,price:6,epoch:5,attack:8,defence:0,damageType:"Колющий",armorPen:1,damage:{0:"Царапина",4:"Лёгкий урон",6:"Точный удар",8:"Тяжёлый урон"}},{id:"sling",category:"weapon",subcat:"slings",name:"Простая праща",desc:"",spec:"Нельзя стрелять с порывом",length:2,hands:2,price:2,epoch:2,attack:3,defence:0,damageType:"Дробящий",armorPen:0,damage:{0:"Царапина",3:"Лёгкий урон"}},{id:"heavy_sling",category:"weapon",subcat:"slings",name:"Боевая праща",desc:"",spec:"Нельзя стрелять без порыва",length:2,hands:2,price:4,epoch:3,attack:4,defence:0,damageType:"Дробящий",armorPen:0,damage:{0:"Царапина",3:"Лёгкий урон",9:"Тяжёлый урон"}}],Io={systemName:"triP Items",version:"1.0",totalItems:110},vt={items:Eo,metadata:Io},Pt=(e,t)=>{const n=e.__vccOpts||e;for(const[s,o]of t)n[s]=o;return n},at={3:{name:"Ниже простой",short:"НП",level:1,modifier:"below",color:"#00DDFF",lightText:!1,linetype:"dashed"},6:{name:"Простая",short:"П",level:1,modifier:"base",color:"#00DDFF",lightText:!1,linetype:"single"},9:{name:"Выше простой",short:"ВП",level:1,modifier:"above",color:"#00DDFF",lightText:!1,linetype:"double"},12:{name:"Ниже лёгкой",short:"НЛ",level:2,modifier:"below",color:"#00CC44",lightText:!1,linetype:"dashed"},15:{name:"Лёгкая",short:"Л",level:2,modifier:"base",color:"#00CC44",lightText:!1,linetype:"single"},18:{name:"Выше лёгкой",short:"ВЛ",level:2,modifier:"above",color:"#00CC44",lightText:!1,linetype:"double"},21:{name:"Ниже средней",short:"НС",level:3,modifier:"below",color:"#FFEE00",lightText:!1,linetype:"dashed"},24:{name:"Средняя",short:"С",level:3,modifier:"base",color:"#FFEE00",lightText:!1,linetype:"single"},27:{name:"Выше средней",short:"ВС",level:3,modifier:"above",color:"#FFEE00",lightText:!1,linetype:"double"},30:{name:"Ниже тяжёлой",short:"НТ",level:4,modifier:"below",color:"#FF8800",lightText:!1,linetype:"dashed"},33:{name:"Тяжёлая",short:"Т",level:4,modifier:"base",color:"#FF8800",lightText:!1,linetype:"single"},36:{name:"Выше тяжёлой",short:"ВТ",level:4,modifier:"above",color:"#FF8800",lightText:!1,linetype:"double"},39:{name:"Ниже жестокой",short:"НЖ",level:5,modifier:"below",color:"#CC0000",lightText:!0,linetype:"dashed"},42:{name:"Жестокая",short:"Ж",level:5,modifier:"base",color:"#CC0000",lightText:!0,linetype:"single"},45:{name:"Выше жестокой",short:"ВЖ",level:5,modifier:"above",color:"#CC0000",lightText:!0,linetype:"double"},48:{name:"Ниже кошмарной",short:"НК",level:6,modifier:"below",color:"#440066",lightText:!0,linetype:"dashed"},51:{name:"Кошмарная",short:"К",level:6,modifier:"base",color:"#440066",lightText:!0,linetype:"single"},54:{name:"Выше кошмарной",short:"ВК",level:6,modifier:"above",color:"#440066",lightText:!0,linetype:"double"},60:{name:"Невозможная",short:"Н",level:7,modifier:"base",color:"#000000",lightText:!0,linetype:"single"}},Ao={key:0,class:"hp-display"},Mo={key:0,class:"hp-compact"},Do={class:"hp-text"},Lo={key:0,class:"hp-penalty"},Ro={key:1,class:"hp-full"},Fo={class:"hp-header"},No={class:"hp-value"},Oo={key:0,class:"hp-penalty-badge"},zo={class:"hp-groups"},Bo=["onClick"],jo={key:1,class:"wounds-display"},Wo={key:0,class:"wounds-compact"},Ho={key:0,class:"wound-healthy"},Uo={key:1,class:"wounds-full"},qo=["onClick","onContextmenu","onTouchstart","onTouchend"],Vo={class:"wound-header"},Go={class:"wound-icon"},Yo={class:"wound-label"},Xo={class:"wound-slots"},Qo={class:"wound-count"},Ko=500,Jo={__name:"HealthDisplay",props:{combat:{type:Object,required:!0},stats:{type:Object,default:()=>({})},compact:{type:Boolean,default:!1},readonly:{type:Boolean,default:!1}},emits:["update:hp","add-wound","remove-wound","toggle-health-type"],setup(e,{emit:t}){const n=e,s=t,o=W(()=>{var k;return((k=n.combat)==null?void 0:k.healthType)||"simple"}),l=W(()=>{var k;return((k=n.combat)==null?void 0:k.hp)||0}),i=W(()=>{var k;return((k=n.combat)==null?void 0:k.maxHp)||8}),c=W(()=>{const k=[],$=i.value,x=$%3;let T=0;if(x>0){const D=[];for(let U=0;U<x;U++)D.push({index:T,filled:T<l.value}),T++;k.push(D)}for(;T<$;){const D=[];for(let U=0;U<3&&T<$;U++)D.push({index:T,filled:T<l.value}),T++;k.push(D)}return k}),d=W(()=>{const k=i.value-l.value;return Math.floor(k/3)}),f=W(()=>{var k;return((k=n.combat)==null?void 0:k.wounds)||{scratch:0,light:0,heavy:0,deadly:0}}),u=W(()=>{var k;return((k=n.combat)==null?void 0:k.bonusDeadlySlots)||0}),g=W(()=>{const k=lt(n.stats,u.value);return{scratch:{...k.scratch,total:k.scratch.base+k.scratch.bonus,filled:f.value.scratch,label:"Царапины",icon:"🩹",color:"amber"},light:{...k.light,total:k.light.base+k.light.bonus,filled:f.value.light,label:"Лёгкие",icon:"🩸",color:"orange"},heavy:{...k.heavy,total:k.heavy.base+k.heavy.bonus,filled:f.value.heavy,label:"Тяжёлые",icon:"💔",color:"rose"},deadly:{...k.deadly,total:k.deadly.base+k.deadly.bonus,filled:f.value.deadly,label:"Смертельные",icon:"💀",color:"red"}}}),v=["scratch","light","heavy","deadly"],P=k=>{const N=g.value[k],$=[];N.bonus+N.base;const x=N.filled;for(let T=0;T<N.bonus;T++)$.push({index:T,isBonus:!0,filled:T<x});for(let T=0;T<N.base;T++)$.push({index:N.bonus+T,isBonus:!1,filled:N.bonus+T<x});return $};let O=null;const _=k=>{n.readonly||(k<l.value?s("update:hp",l.value-1):s("update:hp",Math.min(i.value,l.value+1)))},w=(k,N)=>{n.readonly||(N.preventDefault(),s("add-wound",k))},B=(k,N)=>{n.readonly||(N.preventDefault(),s("remove-wound",k))},te=(k,N)=>{n.readonly||(O=setTimeout(()=>{s("remove-wound",k),O=null},Ko))},Y=(k,N)=>{n.readonly||O&&(clearTimeout(O),O=null,s("add-wound",k))};return(k,N)=>(p(),h("div",{class:oe(["health-display",{compact:e.compact}])},[o.value==="simple"?(p(),h("div",Ao,[e.compact?(p(),h("div",Mo,[N[0]||(N[0]=r("span",{class:"hp-icon"},"❤️",-1)),r("span",Do,R(l.value)+"/"+R(i.value),1),d.value>0?(p(),h("span",Lo,"-"+R(d.value),1)):A("",!0)])):(p(),h("div",Ro,[r("div",Fo,[N[1]||(N[1]=r("span",{class:"hp-label"},"HP",-1)),r("span",No,R(l.value)+"/"+R(i.value),1),d.value>0?(p(),h("span",Oo,"штраф: -"+R(d.value),1)):A("",!0)]),r("div",zo,[(p(!0),h(G,null,ae(c.value,($,x)=>(p(),h("div",{key:x,class:"hp-group"},[(p(!0),h(G,null,ae($,T=>(p(),h("div",{key:T.index,class:oe(["hp-cell",{filled:T.filled,clickable:!e.readonly}]),onClick:D=>_(T.index)},null,10,Bo))),128))]))),128))])]))])):(p(),h("div",jo,[e.compact?(p(),h("div",Wo,[(p(),h(G,null,ae(v,$=>(p(),h(G,{key:$},[g.value[$].filled>0?(p(),h("span",{key:0,class:oe(["wound-badge",`wound-${g.value[$].color}`])},R(g.value[$].icon)+" "+R(g.value[$].filled),3)):A("",!0)],64))),64)),Object.values(f.value).every($=>$===0)?(p(),h("span",Ho," ✓ Здоров ")):A("",!0)])):(p(),h("div",Uo,[(p(),h(G,null,ae(v,$=>r("div",{key:$,class:oe(["wound-column",[`wound-column-${g.value[$].color}`,`wound-column-${$}`,{clickable:!e.readonly}]]),onClick:x=>w($,x),onContextmenu:x=>B($,x),onTouchstart:x=>te($),onTouchend:x=>Y($)},[r("div",Vo,[r("span",Go,R(g.value[$].icon),1),r("span",Yo,R(g.value[$].label),1)]),r("div",Xo,[(p(!0),h(G,null,ae(P($),x=>(p(),h("div",{key:x.index,class:oe(["wound-slot",{filled:x.filled,bonus:x.isBonus}])},null,2))),128))]),r("div",Qo,R(g.value[$].filled)+"/"+R(g.value[$].total),1)],42,qo)),64))]))]))],2))}},Lr=Pt(Jo,[["__scopeId","data-v-2d19fffd"]]),Zo={class:"portrait-image"},ea=["src","alt"],ta={key:1,class:"portrait-fallback"},na={key:3,class:"death-overlay"},sa=["viewBox","width","height"],oa=["transform"],aa={key:0,class:"melee-defence"},la=["d"],ia=["d"],ra=["d"],ca=["d"],ua=["d"],da=["d"],fa={key:1,class:"ranged-defence"},pa=["d"],ha=["d"],ma=["d"],va=["d"],ga=["d"],ba=["d"],ya=["viewBox","width","height"],xa=["d","stroke"],ka=["cx","cy","r","fill"],We=2,wa={__name:"CharacterPortrait",props:{portrait:{type:String,default:null},name:{type:String,default:""},combat:{type:Object,default:()=>({})},stats:{type:Object,default:()=>({})},meleeDefence:{type:Object,default:null},rangedDefence:{type:Object,default:null},defenceMode:{type:String,default:"all",validator:e=>["all","melee","ranged","none"].includes(e)},defenceLayout:{type:String,default:"left",validator:e=>["left","both"].includes(e)},defenceRotation:{type:Number,default:0},highlightSegment:{type:Object,default:null},showDefence:{type:Boolean,default:!1},size:{type:String,default:"md",validator:e=>["sm","md","lg","xl"].includes(e)},showWounds:{type:Boolean,default:!0}},setup(e){const t=e,n={sm:48,md:80,lg:120,xl:160},s=W(()=>n[t.size]),o=W(()=>{var m;return((m=t.combat)==null?void 0:m.healthType)||"simple"}),l=W(()=>{var m;return((m=t.combat)==null?void 0:m.wounds)||{scratch:0,light:0,heavy:0,deadly:0}}),i=W(()=>{var m;return o.value!=="wounds"?null:lt(t.stats,((m=t.combat)==null?void 0:m.bonusDeadlySlots)||0)}),c=W(()=>{if(!i.value)return[];const m=i.value.scratch.base+i.value.scratch.bonus,I=i.value.scratch.bonus,C=l.value.scratch;if(C===0)return[];const F=10,K=(360-m*F)/m,ie=180-(C*K+(C-1)*F)/2,ce=[];for(let le=0;le<C;le++){const re=ie+le*(K+F);ce.push({index:le,startAngle:re,endAngle:re+K,filled:!0,isBonus:le<I})}return ce}),d=(m,I,C,F)=>{const H=s.value,K=H/2,pe=H/2,ie=C,ce=(m-90)*Math.PI/180,le=(I-90)*Math.PI/180,re=K+ie*Math.cos(ce),de=pe+ie*Math.sin(ce),Te=K+ie*Math.cos(le),me=pe+ie*Math.sin(le),Ee=I-m>180?1:0;return`M ${re} ${de} A ${ie} ${ie} 0 ${Ee} 1 ${Te} ${me}`},f=W(()=>{if(!i.value)return[];const m=i.value.light.bonus,I=l.value.light;if(I===0)return[];const C=[],F=s.value,H=F*.08,K=F/2,pe=F/2,ie=F/2,ce=25,re=90+(I-1)*ce/2;for(let de=0;de<I;de++){const me=(re-de*ce)*Math.PI/180;C.push({index:de,cx:pe+K*Math.cos(me),cy:ie+K*Math.sin(me),r:H,filled:!0,isBonus:de<m})}return C}),u=W(()=>{if(!i.value)return 0;const m=i.value.heavy.base+i.value.heavy.bonus,I=l.value.heavy;return m===0||I===0?0:I/m*70}),g=W(()=>{if(!i.value)return 0;const m=i.value.deadly.base+i.value.deadly.bonus,I=l.value.deadly;return m===0?0:I/m}),v=W(()=>g.value>0),P=W(()=>g.value>=1),O=W(()=>{var C,F;if(o.value!=="simple")return 100;const m=((C=t.combat)==null?void 0:C.hp)||0,I=((F=t.combat)==null?void 0:F.maxHp)||1;return m/I*100}),_=W(()=>Math.max(0,100-O.value)*.7),w=W(()=>{var m,I;return((I=(m=t.name)==null?void 0:m.charAt(0))==null?void 0:I.toUpperCase())||"?"}),B=m=>{const I=Object.entries(at.default||at).map(([F,H])=>({value:parseInt(F),...H})).filter(F=>F.value>=0).sort((F,H)=>F.value-H.value);let C=I[0];for(const F of I)if(F.value<=m)C=F;else break;return C},te=m=>{if(!t.meleeDefence)return null;const I=t.meleeDefence[m];return I==null?null:B(I)},Y=m=>{if(!t.rangedDefence)return null;const I=t.rangedDefence[m];return I==null?null:B(I)},k=W(()=>!t.showDefence||!t.meleeDefence||t.defenceMode==="none"||t.defenceMode==="ranged"?null:{front:te("front"),flank:te("flank"),back:te("back")}),N=W(()=>!t.showDefence||!t.rangedDefence||t.defenceMode==="none"||t.defenceMode==="melee"?null:{front:Y("front"),flank:Y("flank"),back:Y("back")}),$=(m,I)=>t.highlightSegment?t.highlightSegment.type===m&&t.highlightSegment.direction===I:!1,x=W(()=>t.highlightSegment!==null),T=W(()=>{if(t.defenceRotation===0)return"";const m=s.value,I=L.value,C=m/2+I,F=m/2+I;return`rotate(${t.defenceRotation} ${C} ${F})`}),D=(m,I=0)=>{const C=s.value,F=L.value,H=C/2+F,K=C/2+F,pe=C/2+14+I,ie=Te=>{const me=(Te-90)*Math.PI/180;return{x:H+pe*Math.cos(me),y:K+pe*Math.sin(me)}},ce=ie(0),le=ie(180),re=ie(240),de=ie(300);return m==="front"?`M ${ce.x} ${ce.y} L ${de.x} ${de.y}`:m==="flank"?`M ${de.x} ${de.y} L ${re.x} ${re.y}`:m==="back"?`M ${re.x} ${re.y} L ${le.x} ${le.y}`:""},U=(m,I=0,C="left")=>{const F=s.value,H=L.value,K=F/2+H,pe=F/2+H,ce=F/2+14+8+I;let le,re;if(C==="left")if(m==="front")le=300,re=360;else if(m==="flank")le=240,re=300;else if(m==="back")le=180,re=240;else return"";else if(m==="front")le=0,re=60;else if(m==="flank")le=60,re=120;else if(m==="back")le=120,re=180;else return"";const de=(le-90)*Math.PI/180,Te=(re-90)*Math.PI/180,me=K+ce*Math.cos(de),Ee=pe+ce*Math.sin(de),xe=K+ce*Math.cos(Te),Pe=pe+ce*Math.sin(Te);return`M ${me} ${Ee} A ${ce} ${ce} 0 0 1 ${xe} ${Pe}`},ue=m=>{if(!m)return{};const I=m.linetype||"single",F={stroke:m.color||"#FFFFFF","stroke-width":2,fill:"none","stroke-linecap":"butt"};return I==="dashed"?{...F,"stroke-dasharray":"4 3"}:F},q=m=>!m||m.linetype!=="double"?null:{stroke:m.color||"#FFFFFF","stroke-width":2,fill:"none","stroke-linecap":"butt","stroke-dasharray":"4 3"},L=W(()=>t.showDefence?28:0),Q=W(()=>s.value+L.value*2);return(m,I)=>(p(),h("div",{class:oe(["character-portrait",[`size-${e.size}`,{dying:v.value,dead:P.value,"with-defence":e.showDefence}]]),style:Se({width:`${Q.value}px`,height:`${Q.value}px`})},[r("div",{class:"portrait-container",style:Se({width:`${s.value}px`,height:`${s.value}px`,position:"absolute",top:`${L.value}px`,left:`${L.value}px`})},[r("div",Zo,[e.portrait?(p(),h("img",{key:0,src:S(Ts)(e.portrait),alt:e.name,class:"portrait-img",onError:I[0]||(I[0]=C=>C.target.style.display="none")},null,40,ea)):(p(),h("div",ta,R(w.value),1))]),e.showWounds&&o.value==="wounds"&&u.value>0?(p(),h("div",{key:0,class:"heavy-overlay",style:Se({height:`${u.value}%`})},null,4)):A("",!0),e.showWounds&&o.value==="simple"&&_.value>0?(p(),h("div",{key:1,class:"hp-damage-overlay",style:Se({height:`${_.value}%`})},null,4)):A("",!0),e.showWounds&&v.value?(p(),h("div",{key:2,class:"deadly-overlay",style:Se({opacity:g.value*.8})},null,4)):A("",!0),P.value?(p(),h("div",na,[...I[1]||(I[1]=[r("span",{class:"death-icon"},"💀",-1)])])):A("",!0)],4),e.showDefence&&(k.value||N.value)?(p(),h("svg",{key:0,class:"defence-overlay",viewBox:`0 0 ${Q.value} ${Q.value}`,width:Q.value,height:Q.value,style:{position:"absolute",top:"0",left:"0"}},[r("g",{transform:T.value},[k.value?(p(),h("g",aa,[!x.value||$("melee","front")?(p(),h(G,{key:0},[k.value.front?(p(),h("path",Ce({key:0,d:D("front",0)},ue(k.value.front)),null,16,la)):A("",!0),q(k.value.front)?(p(),h("path",Ce({key:1,d:D("front",We)},q(k.value.front)),null,16,ia)):A("",!0)],64)):A("",!0),!x.value||$("melee","flank")?(p(),h(G,{key:1},[k.value.flank?(p(),h("path",Ce({key:0,d:D("flank",0)},ue(k.value.flank)),null,16,ra)):A("",!0),q(k.value.flank)?(p(),h("path",Ce({key:1,d:D("flank",We)},q(k.value.flank)),null,16,ca)):A("",!0)],64)):A("",!0),!x.value||$("melee","back")?(p(),h(G,{key:2},[k.value.back?(p(),h("path",Ce({key:0,d:D("back",0)},ue(k.value.back)),null,16,ua)):A("",!0),q(k.value.back)?(p(),h("path",Ce({key:1,d:D("back",We)},q(k.value.back)),null,16,da)):A("",!0)],64)):A("",!0)])):A("",!0),N.value?(p(),h("g",fa,[!x.value||$("ranged","front")?(p(),h(G,{key:0},[N.value.front?(p(),h("path",Ce({key:0,d:U("front",0,e.defenceLayout)},ue(N.value.front)),null,16,pa)):A("",!0),q(N.value.front)?(p(),h("path",Ce({key:1,d:U("front",We,e.defenceLayout)},q(N.value.front)),null,16,ha)):A("",!0)],64)):A("",!0),!x.value||$("ranged","flank")?(p(),h(G,{key:1},[N.value.flank?(p(),h("path",Ce({key:0,d:U("flank",0,e.defenceLayout)},ue(N.value.flank)),null,16,ma)):A("",!0),q(N.value.flank)?(p(),h("path",Ce({key:1,d:U("flank",We,e.defenceLayout)},q(N.value.flank)),null,16,va)):A("",!0)],64)):A("",!0),!x.value||$("ranged","back")?(p(),h(G,{key:2},[N.value.back?(p(),h("path",Ce({key:0,d:U("back",0,e.defenceLayout)},ue(N.value.back)),null,16,ga)):A("",!0),q(N.value.back)?(p(),h("path",Ce({key:1,d:U("back",We,e.defenceLayout)},q(N.value.back)),null,16,ba)):A("",!0)],64)):A("",!0)])):A("",!0)],8,oa)],8,sa)):A("",!0),e.showWounds?(p(),h("svg",{key:1,class:"wounds-overlay",viewBox:`0 0 ${s.value} ${s.value}`,width:s.value,height:s.value,style:Se({position:"absolute",top:e.showDefence?`${L.value}px`:"0",left:e.showDefence?`${L.value}px`:"0",overflow:"visible"})},[(p(!0),h(G,null,ae(c.value,C=>(p(),h("path",{key:`scratch-${C.index}`,d:d(C.startAngle,C.endAngle,s.value/2-3),fill:"none",stroke:C.isBonus?"#a855f7":"#fbbf24","stroke-width":"3","stroke-linecap":"round",class:"scratch-arc filled"},null,8,xa))),128)),(p(!0),h(G,null,ae(f.value,C=>(p(),h("circle",{key:`light-${C.index}`,cx:C.cx,cy:C.cy,r:C.r,fill:C.isBonus?"#a855f7":"#ef4444",stroke:"#1f2937","stroke-width":"1.5",class:"light-dot filled"},null,8,ka))),128))],12,ya)):A("",!0)],6))}},Rr=Pt(wa,[["__scopeId","data-v-4eba6bfd"]]),Tn={};$o.aspects.forEach(e=>{Tn[e.id]=e});const _a=e=>Tn[e]||null,Ta=e=>{var i,c,d,f,u,g;const t=(e==null?void 0:e.stats)||{},n=((i=e==null?void 0:e.combat)==null?void 0:i.wounds)||(e==null?void 0:e.wounds)||{};if(!n.scratch&&!n.light&&!n.heavy&&!n.deadly)return 0;const s={scratch:{current:typeof n.scratch=="number"?n.scratch:((c=n.scratch)==null?void 0:c.current)||0},light:{current:typeof n.light=="number"?n.light:((d=n.light)==null?void 0:d.current)||0},heavy:{current:typeof n.heavy=="number"?n.heavy:((f=n.heavy)==null?void 0:f.current)||0},deadly:{current:typeof n.deadly=="number"?n.deadly:((u=n.deadly)==null?void 0:u.current)||0}},o=((g=e==null?void 0:e.combat)==null?void 0:g.bonusDeadlySlots)||0,l=lt(t,o);return-rs(s,l)},Ca=e=>{let t=0;return t-=Ta(e),t},Sa=(e,t)=>{const n=_a(t);if(!n)return 0;const s=(e==null?void 0:e.stats)||{},o=s[t]||0,l=n.neighbors||[],i=s[l[0]]||0,c=s[l[1]]||0,d=s[n.opposite]||0,f=Math.floor(o+i/2+c/2),u=Math.floor(d/2),g=Math.max(f,u),v=Ca(e);return g+v},$t={};Object.keys(vt).forEach(e=>{Array.isArray(vt[e])&&vt[e].forEach(t=>{$t[t.id]=t})});const Pa=e=>Sa(e,"shadow"),$a=e=>{var n;const t=(n=e==null?void 0:e.equipment)==null?void 0:n.armor;return t&&$t[t]||null},Ea=(e,t,n)=>{var c,d;const s=((c=e==null?void 0:e.equipment)==null?void 0:c.activeSetIndex)??0,l=(((d=e==null?void 0:e.equipment)==null?void 0:d.weaponSets)||[])[s];if(!l||!l.weapons)return 0;let i=0;for(const f of l.weapons){const u=$t[f];u&&(u.type==="shield"&&t==="front"&&(n==="melee"?i+=u.defenceMelee||0:n==="ranged"&&(i+=u.defenceRanged||0)),u.parry&&t==="front"&&n==="melee"&&(i+=u.parry||0))}return i},gt=(e,t,n)=>{const s=Pa(e),o=Math.floor(s/2),l=$a(e),i=(l==null?void 0:l.defence)||0,c=Ea(e,t,n);let d=0,f=0;return t==="front"?(d=6,f=s):t==="flank"?(d=3,f=o):t==="back"&&(d=0,f=o),Math.max(0,d+f+i+c)},sn=(e,t)=>({front:gt(e,"front",t),flank:gt(e,"flank",t),back:gt(e,"back",t)}),Ia=[{id:"plains",name:"Равнина",color:"#8BC34A"},{id:"forest",name:"Лес",color:"#2E7D32"},{id:"desert",name:"Пустыня",color:"#FDD835"},{id:"swamp",name:"Болото",color:"#5D4037"},{id:"mountain",name:"Горы",color:"#78909C"},{id:"water",name:"Вода",color:"#1E88E5"},{id:"snow",name:"Снег",color:"#ECEFF1"},{id:"volcanic",name:"Вулкан",color:"#BF360C"},{id:"urban",name:"Город",color:"#616161"},{id:"underground",name:"Подземелье",color:"#37474F"}],Aa=[{id:"open",name:"Открытая",description:"Полностью просматривается",value:0},{id:"partial",name:"Частичная",description:"Маскирует (высокая трава, кусты)",value:1},{id:"blocking",name:"Блокирующая",description:"Блокирует обзор (стена, скала)",value:2}],Ma=[{id:"grass",name:"Трава",description:"Обычный луг",biome:"plains",color:"#4CAF50",image:null,visibility:"open",movementCost:1,meleeAdvantage:0,tags:["природа","базовый"]},{id:"tall_grass",name:"Высокая трава",description:"Высокая трава, скрывающая присевших",biome:"plains",color:"#7CB342",image:null,visibility:"partial",movementCost:1,meleeAdvantage:0,tags:["природа","укрытие"]},{id:"forest_light",name:"Редколесье",description:"Редкие деревья и кустарники",biome:"forest",color:"#66BB6A",image:null,visibility:"partial",movementCost:2,meleeAdvantage:0,tags:["природа","лес","укрытие"]},{id:"forest_dense",name:"Густой лес",description:"Плотный лес с густым подлеском",biome:"forest",color:"#2E7D32",image:null,visibility:"blocking",movementCost:3,meleeAdvantage:-1,tags:["природа","лес","труднопроходимый"]},{id:"sand",name:"Песок",description:"Рыхлый песок",biome:"desert",color:"#FFD54F",image:null,visibility:"open",movementCost:2,meleeAdvantage:-1,tags:["природа","пустыня"]},{id:"dunes",name:"Дюны",description:"Песчаные холмы",biome:"desert",color:"#FFC107",image:null,visibility:"partial",movementCost:3,meleeAdvantage:1,tags:["природа","пустыня","возвышенность"]},{id:"shallow_water",name:"Мелководье",description:"Неглубокая вода по колено",biome:"water",color:"#4FC3F7",image:null,visibility:"open",movementCost:2,meleeAdvantage:-1,tags:["вода"]},{id:"deep_water",name:"Глубокая вода",description:"Глубокая вода, нужно плыть",biome:"water",color:"#1565C0",image:null,visibility:"open",movementCost:4,meleeAdvantage:-2,tags:["вода","опасность"]},{id:"swamp",name:"Болото",description:"Топкое болото",biome:"swamp",color:"#6D4C41",image:null,visibility:"partial",movementCost:3,meleeAdvantage:-1,tags:["природа","болото","опасность"]},{id:"rocks",name:"Камни",description:"Каменистая местность",biome:"mountain",color:"#90A4AE",image:null,visibility:"partial",movementCost:2,meleeAdvantage:0,tags:["природа","горы"]},{id:"cliff",name:"Утёс",description:"Крутой обрыв или возвышенность",biome:"mountain",color:"#607D8B",image:null,visibility:"blocking",movementCost:5,meleeAdvantage:2,tags:["природа","горы","возвышенность"]},{id:"snow",name:"Снег",description:"Заснеженная местность",biome:"snow",color:"#ECEFF1",image:null,visibility:"open",movementCost:2,meleeAdvantage:-1,tags:["природа","холод"]},{id:"ice",name:"Лёд",description:"Скользкий лёд",biome:"snow",color:"#B3E5FC",image:null,visibility:"open",movementCost:1,meleeAdvantage:-2,tags:["природа","холод","опасность"]},{id:"lava",name:"Лава",description:"Раскалённая лава",biome:"volcanic",color:"#FF5722",image:null,visibility:"open",movementCost:5,meleeAdvantage:-2,tags:["опасность","огонь"]},{id:"volcanic_rock",name:"Вулканический камень",description:"Застывшая лава",biome:"volcanic",color:"#3E2723",image:null,visibility:"open",movementCost:2,meleeAdvantage:0,tags:["природа","горы"]},{id:"road_dirt",name:"Грунтовая дорога",description:"Утоптанная тропа",biome:"plains",color:"#A1887F",image:null,visibility:"open",movementCost:1,meleeAdvantage:0,tags:["дорога"]},{id:"road_stone",name:"Каменная дорога",description:"Мощёная дорога",biome:"urban",color:"#9E9E9E",image:null,visibility:"open",movementCost:1,meleeAdvantage:0,tags:["дорога","город"]},{id:"floor_wood",name:"Деревянный пол",description:"Деревянный настил",biome:"urban",color:"#8D6E63",image:null,visibility:"open",movementCost:1,meleeAdvantage:0,tags:["город","здание"]},{id:"floor_stone",name:"Каменный пол",description:"Каменные плиты",biome:"urban",color:"#757575",image:null,visibility:"open",movementCost:1,meleeAdvantage:0,tags:["город","здание"]},{id:"wall",name:"Стена",description:"Непроходимая стена",biome:"urban",color:"#424242",image:null,visibility:"blocking",movementCost:5,meleeAdvantage:0,tags:["город","здание","преграда"]},{id:"dungeon_floor",name:"Пол подземелья",description:"Холодный каменный пол",biome:"underground",color:"#455A64",image:null,visibility:"open",movementCost:1,meleeAdvantage:0,tags:["подземелье"]},{id:"dungeon_wall",name:"Стена подземелья",description:"Массивная каменная стена",biome:"underground",color:"#263238",image:null,visibility:"blocking",movementCost:5,meleeAdvantage:0,tags:["подземелье","преграда"]},{id:"void",name:"Пустота",description:"Пустое пространство",biome:"underground",color:"#0D1117",image:null,visibility:"blocking",movementCost:5,meleeAdvantage:0,tags:["специальный"]}],bt={biomes:Ia,visibility:Aa,terrains:Ma},Cn=os("terrain",()=>{const e=j(bt.terrains),t=j([]),n=j(bt.biomes),s=j(bt.visibility),o=j(new Map),l=j({search:"",biome:null,visibility:null,movementCostMin:1,movementCostMax:5,meleeAdvantageMin:-2,meleeAdvantageMax:2,tags:[]}),i=W(()=>[...e.value,...t.value]),c=W(()=>{const x=new Set;return i.value.forEach(T=>{var D;(D=T.tags)==null||D.forEach(U=>x.add(U))}),Array.from(x).sort()}),d=W(()=>i.value.filter(x=>{var T;if(l.value.search){const D=l.value.search.toLowerCase(),U=x.name.toLowerCase().includes(D),ue=(T=x.description)==null?void 0:T.toLowerCase().includes(D);if(!U&&!ue)return!1}if(l.value.biome&&x.biome!==l.value.biome||l.value.visibility&&x.visibility!==l.value.visibility||x.movementCost<l.value.movementCostMin||x.movementCost>l.value.movementCostMax||x.meleeAdvantage<l.value.meleeAdvantageMin||x.meleeAdvantage>l.value.meleeAdvantageMax)return!1;if(l.value.tags.length>0){const D=new Set(x.tags||[]);if(!l.value.tags.every(ue=>D.has(ue)))return!1}return!0})),f=W(()=>{const x={};return n.value.forEach(T=>{x[T.id]={biome:T,terrains:d.value.filter(D=>D.biome===T.id)}}),x});function u(x){return i.value.find(T=>T.id===x)||null}function g(x={}){const{biome:T=null,visibility:D=null,passabilityMin:U=0,passabilityMax:ue=5,meleeAdvantageMin:q=-2,meleeAdvantageMax:L=2,search:Q="",tags:m=[]}=x;return i.value.filter(I=>{var H;if(Q){const K=Q.toLowerCase(),pe=I.name.toLowerCase().includes(K),ie=(H=I.description)==null?void 0:H.toLowerCase().includes(K);if(!pe&&!ie)return!1}if(T&&I.biome!==T||D&&I.visibility!==D)return!1;const C=I.movementCost??1;if(C<U||C>ue)return!1;const F=I.meleeAdvantage??0;if(F<q||F>L)return!1;if(m.length>0){const K=new Set(I.tags||[]);if(!m.every(pe=>K.has(pe)))return!1}return!0})}function v(x){return n.value.find(T=>T.id===x)||null}function P(x){const T=u(x);if(!T)return"#888888";if(T.color)return T.color;const D=v(T.biome);return(D==null?void 0:D.color)||"#888888"}function O(x){const T=u(x);return(T==null?void 0:T.image)||null}async function _(x){return o.value.has(x)?o.value.get(x):new Promise((T,D)=>{const U=new Image;U.onload=()=>{o.value.set(x,U),T(U)},U.onerror=D,U.src=x})}function w(x){const D={id:`custom_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,name:x.name||"Новый террейн",description:x.description||"",biome:x.biome||"plains",color:x.color||"#888888",image:x.image||null,visibility:x.visibility||"open",movementCost:Math.max(1,Math.min(5,x.movementCost||1)),meleeAdvantage:Math.max(-2,Math.min(2,x.meleeAdvantage||0)),tags:x.tags||[],isCustom:!0,createdAt:Date.now()};return t.value.push(D),D}function B(x,T){const D=t.value.findIndex(U=>U.id===x);return D===-1?!1:(t.value[D]={...t.value[D],...T,updatedAt:Date.now()},!0)}function te(x){const T=t.value.findIndex(D=>D.id===x);return T===-1?!1:(t.value.splice(T,1),!0)}function Y(x){l.value={...l.value,...x}}function k(){l.value={search:"",biome:null,visibility:null,movementCostMin:1,movementCostMax:5,meleeAdvantageMin:-2,meleeAdvantageMax:2,tags:[]}}function N(){return JSON.stringify(t.value,null,2)}function $(x){try{const T=JSON.parse(x);if(!Array.isArray(T))throw new Error("Invalid format");return T.forEach(D=>{w(D)}),!0}catch(T){return console.error("Failed to import terrains:",T),!1}}return{baseTerrains:e,customTerrains:t,biomes:n,visibilityTypes:s,imageCache:o,filters:l,allTerrains:i,allTags:c,filteredTerrains:d,terrainsByBiome:f,getTerrainById:u,getFilteredTerrains:g,getBiomeById:v,getTerrainColor:P,getTerrainImage:O,loadImage:_,addCustomTerrain:w,updateCustomTerrain:B,removeCustomTerrain:te,setFilters:Y,resetFilters:k,exportCustomTerrains:N,importCustomTerrains:$}},{persist:{key:"trip-terrains",paths:["customTerrains"]}});class Da{constructor(t=null){this.seed=t??Date.now(),this.current=this.seed}next(){return this.current=this.current*1103515245+12345&2147483647,this.current/2147483647}nextInt(t,n){return Math.floor(this.next()*(n-t+1))+t}shuffle(t){const n=[...t];for(let s=n.length-1;s>0;s--){const o=this.nextInt(0,s);[n[s],n[o]]=[n[o],n[s]]}return n}}function La(e,t){return[{q:e+1,r:t},{q:e+1,r:t-1},{q:e,r:t-1},{q:e-1,r:t},{q:e-1,r:t+1},{q:e,r:t+1}]}function Ra(e){const[t,n]=e.split(",").map(Number);return{q:t,r:n}}function Fa(e,t){return`${e},${t}`}function Na(e,t,n){if(!e||e.type===ge.NONE)return!0;const{type:s,operator:o,value:l,minValue:i,maxValue:c}=e;let d;switch(s){case ge.TERRAIN_ID:d=t==null?void 0:t.id;break;case ge.TERRAIN_BIOME:d=t==null?void 0:t.biome;break;case ge.VISIBILITY:d=t==null?void 0:t.visibility;break;case ge.MOVEMENT_COST:d=(t==null?void 0:t.movementCost)??1;break;case ge.MELEE_ADVANTAGE:d=(t==null?void 0:t.meleeAdvantage)??0;break;case ge.TAG:d=(t==null?void 0:t.tags)||[];break;case ge.RANDOM:return!0;default:return!0}switch(o){case we.EQUALS:return d===l;case we.NOT_EQUALS:return d!==l;case we.GREATER:return d>l;case we.GREATER_EQUALS:return d>=l;case we.LESS:return d<l;case we.LESS_EQUALS:return d<=l;case we.CONTAINS:return Array.isArray(d)?d.includes(l):String(d).includes(String(l));default:return!0}}function Oa(e,t,n){return!e.conditions||e.conditions.length===0?!0:e.conditions.every(s=>Na(s,t))}function za(e,t,n,s){if(e.length===0)return new Set;const o=Math.round(e.length*(t/100));if(o===0)return new Set;const l=new Set,i=new Set(e),c=n/100,d=Math.max(1,Math.round(o*(1-c*.8))),f=s.shuffle([...i]);for(f.slice(0,Math.min(d,f.length)).forEach(g=>{l.add(g),i.delete(g)});l.size<o&&i.size>0;)if(s.next()<c){const v=[...l],P=s.shuffle(v);let O=!1;for(const _ of P){const{q:w,r:B}=Ra(_),te=La(w,B),Y=s.shuffle(te);for(const k of Y){const N=Fa(k.q,k.r);if(i.has(N)){l.add(N),i.delete(N),O=!0;break}}if(O)break}if(!O&&i.size>0){const _=s.shuffle([...i])[0];l.add(_),i.delete(_)}}else{const v=s.shuffle([...i])[0];l.add(v),i.delete(v)}return l}function Sn(e,t,n,s={}){const{previewOnly:o=!1,customSeed:l=null}=s;if(!e||!t||t.length===0)return new Map;const i=l??e.seed??Date.now(),c=new Da(i),d=new Map;for(const u of t)d.set(u,e.baseTerrain);const f=[...e.layers].filter(u=>u.enabled&&u.terrainId).sort((u,g)=>u.priority-g.priority);for(const u of f){const g=[];for(const P of t){const O=d.get(P),_=n.getTerrainById(O);Oa(u,_)&&g.push(P)}const v=za(g,u.density,u.clustering,c);for(const P of v)d.set(P,u.terrainId)}return d}function Ba(e,t){const n={total:e.size,byTerrain:{}};return e.forEach((s,o)=>{if(!n.byTerrain[s]){const l=t.getTerrainById(s);n.byTerrain[s]={id:s,name:(l==null?void 0:l.name)||s,count:0,percent:0}}n.byTerrain[s].count++}),Object.values(n.byTerrain).forEach(s=>{s.percent=Math.round(s.count/n.total*100)}),n}function ja(e,t,n,s=null){return Sn(e,t,n,{previewOnly:!0,customSeed:s??Date.now()})}const Ke=new Map,Pn=e=>e==null?null:typeof e=="number"?Le(`/images/presets/${e}.png`):typeof e!="string"?Le(`/images/presets/${String(e)}.png`):e.startsWith("http://")||e.startsWith("https://")||e.startsWith("data:")||e.startsWith("blob:")?e:e.startsWith("/")?Le(e):Le(`/images/presets/${e}.png`),Wa=e=>e?Ke.has(e)?Promise.resolve(Ke.get(e)):new Promise((t,n)=>{const s=new Image;!e.startsWith("data:")&&!e.startsWith("blob:")&&(s.crossOrigin="anonymous"),s.onload=()=>{Ke.set(e,s),t(s)},s.onerror=o=>{console.warn("Failed to load image:",e,o),t(null)},s.src=e}):Promise.resolve(null),Ha=async e=>{const t=e.filter(n=>{var s;return(s=n.character)==null?void 0:s.portrait}).map(n=>{const s=Pn(n.character.portrait);return Wa(s).catch(()=>null)});await Promise.all(t)},on=e=>{const t=Object.entries(at.default||at).map(([s,o])=>({value:parseInt(s),...o})).filter(s=>s.value>=0).sort((s,o)=>s.value-o.value);let n=t[0];for(const s of t)if(s.value<=e)n=s;else break;return n},De=(e,t,n,s)=>{const o=(s-90)*Math.PI/180;return{x:e+n*Math.cos(o),y:t+n*Math.sin(o)}},Ua=(e,t,n,s,o,l,i,c)=>{var f;e.save();const d=Pn(o);if(e.beginPath(),e.arc(t,n,s,0,Math.PI*2),e.clip(),e.fillStyle="#1e293b",e.fill(),d&&Ke.has(d)){const u=Ke.get(d),g=u.width/u.height;let v,P,O,_;g>1?(P=s*2,v=P*g,O=t-v/2,_=n-s):(v=s*2,P=v/g,O=t-s,_=n-P/2),e.drawImage(u,O,_,v,P)}else e.fillStyle="#64748b",e.font=`bold ${s}px sans-serif`,e.textAlign="center",e.textBaseline="middle",e.fillText(((f=l==null?void 0:l.charAt(0))==null?void 0:f.toUpperCase())||"?",t,n);if(i&&c&&i.heavy>0){const u=c.heavy.base+c.heavy.bonus,g=i.heavy/u*.7,v=e.createLinearGradient(t,n+s,t,n-s);v.addColorStop(0,"rgba(220, 38, 38, 0.8)"),v.addColorStop(g,"rgba(220, 38, 38, 0.4)"),v.addColorStop(g+.01,"transparent"),e.fillStyle=v,e.fillRect(t-s,n-s,s*2,s*2)}if(i&&c&&i.deadly>0){const u=c.deadly.base+c.deadly.bonus,g=i.deadly/u;if(g>=1)e.fillStyle="rgba(0, 0, 0, 0.7)",e.fillRect(t-s,n-s,s*2,s*2);else{const v=e.createRadialGradient(t,n,0,t,n,s);v.addColorStop(0,"transparent"),v.addColorStop(.7,"transparent"),v.addColorStop(1,`rgba(220, 38, 38, ${.3+g*.5})`),e.fillStyle=v,e.fillRect(t-s,n-s,s*2,s*2)}}e.restore(),e.beginPath(),e.arc(t,n,s,0,Math.PI*2),e.strokeStyle="rgba(255, 255, 255, 0.3)",e.lineWidth=2,e.stroke()},qa=(e,t,n,s,o,l)=>{if(!o||!l||o.scratch===0)return;const i=l.scratch.base+l.scratch.bonus,c=o.scratch,d=10,f=(360-i*d)/i,g=180-(c*f+(c-1)*d)/2,v=s+4;e.strokeStyle="#fbbf24",e.lineWidth=2,e.lineCap="round";for(let P=0;P<c;P++){const O=g+P*(f+d),_=(O-90)*Math.PI/180,w=(O+f-90)*Math.PI/180;e.beginPath(),e.arc(t,n,v,_,w),e.stroke()}},Va=(e,t,n,s,o,l)=>{if(!o||!l||o.light===0)return;const i=o.light,c=25,d=s*.1,u=90+(i-1)*c/2;e.fillStyle="#dc2626";for(let g=0;g<i;g++){const P=(u-g*c)*Math.PI/180;e.beginPath(),e.arc(t+s*Math.cos(P),n+s*Math.sin(P),d,0,Math.PI*2),e.fill()}},an=(e,t,n,s,o,l,i=0,c="left")=>{if(!l)return;const d=l.color||"#FFFFFF",f=l.linetype||"single";let u;c==="left"?u={top:0,upper:300,lower:240,bottom:180}:u={top:0,upper:60,lower:120,bottom:180};const g=De(t,n,s,u.top+i),v=De(t,n,s,u.upper+i),P=De(t,n,s,u.lower+i),O=De(t,n,s,u.bottom+i);let _,w;if(o==="front")_=g,w=v;else if(o==="flank")_=v,w=P;else if(o==="back")_=P,w=O;else return;if(e.lineCap="butt",e.strokeStyle=d,f==="dashed")e.setLineDash([4,5]),e.lineWidth=1.5,e.beginPath(),e.moveTo(_.x,_.y),e.lineTo(w.x,w.y),e.stroke(),e.setLineDash([]);else if(f==="double"){e.lineWidth=1.5,e.beginPath(),e.moveTo(_.x,_.y),e.lineTo(w.x,w.y),e.stroke();const B=s+1.5,te=De(t,n,B,(o==="front"?u.top:o==="flank"?u.upper:u.lower)+i),Y=De(t,n,B,(o==="front"?u.upper:o==="flank"?u.lower:u.bottom)+i);e.setLineDash([4,5]),e.lineWidth=1.5,e.beginPath(),e.moveTo(te.x,te.y),e.lineTo(Y.x,Y.y),e.stroke(),e.setLineDash([])}else e.lineWidth=1.5,e.beginPath(),e.moveTo(_.x,_.y),e.lineTo(w.x,w.y),e.stroke()},ln=(e,t,n,s,o,l,i=0,c="left")=>{if(!l)return;const d=l.color||"#FFFFFF",f=l.linetype||"single";let u,g;if(c==="left")if(o==="front")u=300,g=360;else if(o==="flank")u=240,g=300;else if(o==="back")u=180,g=240;else return;else if(o==="front")u=0,g=60;else if(o==="flank")u=60,g=120;else if(o==="back")u=120,g=180;else return;u+=i,g+=i;const v=(u-90)*Math.PI/180,P=(g-90)*Math.PI/180;e.lineCap="butt",e.strokeStyle=d,f==="dashed"?(e.setLineDash([4,5]),e.lineWidth=1.5,e.beginPath(),e.arc(t,n,s,v,P),e.stroke(),e.setLineDash([])):f==="double"?(e.lineWidth=1.5,e.beginPath(),e.arc(t,n,s,v,P),e.stroke(),e.setLineDash([4,5]),e.lineWidth=1.5,e.beginPath(),e.arc(t,n,s+1.5,v,P),e.stroke(),e.setLineDash([])):(e.lineWidth=1.5,e.beginPath(),e.arc(t,n,s,v,P),e.stroke())},Ga=(e,t,n,s,o,l,i=0,c={})=>{const{bothSides:d=!1}=c,f=s+14,u=f+6;if(o)for(const g of["front","flank","back"]){const v=o[g];if(v!=null){const P=on(v);an(e,t,n,f,g,P,i,"left"),d&&an(e,t,n,f,g,P,i,"right")}}if(l)for(const g of["front","flank","back"]){const v=l[g];if(v!=null){const P=on(v);ln(e,t,n,u,g,P,i,"left"),d&&ln(e,t,n,u,g,P,i,"right")}}},Ya=(e,t,n,s,o=0)=>{const l=De(t,n,s+8,o),i=De(t,n,s,o-15),c=De(t,n,s,o+15);e.beginPath(),e.moveTo(l.x,l.y),e.lineTo(i.x,i.y),e.lineTo(c.x,c.y),e.closePath(),e.fillStyle="rgba(250, 204, 21, 0.9)",e.fill(),e.strokeStyle="rgba(0, 0, 0, 0.5)",e.lineWidth=1,e.stroke()},Xa=(e,t,n={})=>{var $,x;const{tokenSize:s=48,showDefence:o=!1,showFacing:l=!0,isHovered:i=!1,isSelected:c=!1,canSeeDefence:d=!1}=n,{character:f,pixelX:u,pixelY:g,facing:v=0,meleeDefence:P,rangedDefence:O}=t;if(!f)return;const _=u,w=g,B=s/2,te=v*60,Y=($=f.combat)==null?void 0:$.wounds,k=f.woundSlots||(f.stats?lt(f.stats,((x=f.combat)==null?void 0:x.bonusDeadlySlots)||0):null),N=(i||c)&&d&&(P||O);if(N&&Qa(e,_,w,B,te),Ua(e,_,w,B,f.portrait,f.name,Y,k),Y&&k&&(qa(e,_,w,B,Y,k),Va(e,_,w,B,Y,k)),(c||i)&&Ka(e,_,w,B,c,i,N),N&&Ga(e,_,w,B,P,O,te,{bothSides:!0}),l){const T=B+(N?28:8);Ya(e,_,w,T,te)}},Qa=(e,t,n,s,o=0)=>{e.save();const l=s+35,i=e.createRadialGradient(t,n,s-5,t,n,l);i.addColorStop(0,"rgba(15, 23, 42, 0.95)"),i.addColorStop(.6,"rgba(15, 23, 42, 0.85)"),i.addColorStop(1,"rgba(15, 23, 42, 0)"),e.beginPath(),e.arc(t,n,l,0,Math.PI*2),e.fillStyle=i,e.fill(),e.beginPath(),e.arc(t,n,l-2,0,Math.PI*2),e.strokeStyle="rgba(148, 163, 184, 0.3)",e.lineWidth=1,e.stroke(),e.restore()},Ka=(e,t,n,s,o,l,i=!1)=>{e.save();const c=i?s+22:s;o?(e.beginPath(),e.arc(t,n,c+2,0,Math.PI*2),e.strokeStyle="rgba(250, 204, 21, 0.9)",e.lineWidth=3,e.stroke()):l&&(e.beginPath(),e.arc(t,n,c+1,0,Math.PI*2),e.strokeStyle="rgba(56, 189, 248, 0.8)",e.lineWidth=2,e.stroke()),e.restore()},Ja=(e,t,n={})=>{var d,f,u;const{hoveredTokenId:s=null,selectedTokenId:o=null,currentUserId:l=null,isMaster:i=!1,draggingTokenId:c=null}=n;for(const g of t){const v=g.id===s||g.characterId===s,P=g.id===o||g.characterId===o,O=g.id===c||g.characterId===c,_=((d=g.character)==null?void 0:d.ownerId)===l,w=((u=(f=g.character)==null?void 0:f.combat)==null?void 0:u.showDefenceToOthers)||!1,B=i||_||w;O&&(e.save(),e.globalAlpha=.7),Xa(e,g,{...n,isHovered:v,isSelected:P,canSeeDefence:B}),O&&e.restore()}},Za=(e,t,n,s)=>{const o=e-n.pixelX,l=t-n.pixelY,i=s/2;return o*o+l*l<=i*i},el=(e,t,n,s)=>{for(let o=n.length-1;o>=0;o--){const l=n[o];if(Za(e,t,l,s))return l}return null},yt=(e,t,n)=>({x:(e-n.x)/n.zoom,y:(t-n.y)/n.zoom}),tl={class:"fill-profile-panel flex flex-col h-full bg-slate-800 text-white"},nl={class:"flex items-center justify-between px-3 py-2 border-b border-white/10"},sl={class:"flex border-b border-white/10"},ol=["onClick"],al={class:"flex-1 overflow-y-auto p-3"},ll={class:"space-y-2"},il={class:"flex items-center justify-between mb-2"},rl={class:"flex gap-1"},cl={key:0,class:"p-2 bg-slate-700/50 rounded-lg mb-2"},ul={class:"flex gap-1"},dl=["onClick"],fl={class:"flex items-center justify-between"},pl={class:"text-sm font-medium"},hl={class:"text-xs text-slate-400"},ml=["onClick"],vl={key:1,class:"text-center text-slate-500 text-xs py-4"},gl={key:0,class:"mt-4 pt-4 border-t border-white/10"},bl={class:"grid grid-cols-5 gap-1 max-h-32 overflow-y-auto"},yl=["title","onClick"],xl={key:1,class:"space-y-2"},kl={class:"flex items-center justify-between mb-2"},wl={class:"text-xs text-slate-400"},_l=["onClick"],Tl={class:"flex items-center gap-2"},Cl=["checked","onChange"],Sl={class:"text-sm"},Pl={class:"flex items-center gap-1"},$l={class:"text-xs text-slate-400"},El=["onClick"],Il={key:0,class:"mt-3 pt-3 border-t border-white/10 space-y-3"},Al=["value","onInput"],Ml={class:"grid grid-cols-6 gap-1 mt-1 max-h-24 overflow-y-auto"},Dl=["title","onClick"],Ll={class:"flex items-center justify-between"},Rl={class:"text-xs text-sky-400"},Fl=["value","onInput"],Nl={class:"flex items-center justify-between"},Ol={class:"text-xs text-sky-400"},zl={class:"flex items-center gap-2 text-[10px] text-slate-500"},Bl=["value","onInput"],jl={class:"flex items-center justify-between mb-1"},Wl=["onClick"],Hl={key:0,class:"text-xs text-slate-500 italic"},Ul=["value","onChange"],ql=["value"],Vl=["value","onChange"],Gl=["value"],Yl=["value","onInput"],Xl=["onClick"],Ql={key:0,class:"text-center text-slate-500 text-xs py-4"},Kl={key:2,class:"text-center py-8"},Jl={key:3,class:"text-center text-slate-500 text-xs py-8"},Zl={key:0,class:"p-3 border-t border-white/10"},ei={__name:"FillProfilePanel",emits:["apply","preview","close"],setup(e,{emit:t}){const n=t,s=fn(),o=Cn(),{profiles:l,currentProfile:i,sortedProfiles:c}=Xe(s),d=j("profile"),f=j(null),u=j(!1),g=j(""),v=W(()=>[...o.baseTerrains,...o.customTerrains]),P=q=>v.value.find(L=>L.id===q)||{name:q,color:"#888"},O=()=>{g.value.trim()&&(s.createProfile({name:g.value.trim()}),g.value="",u.value=!1)},_=q=>{s.selectProfile(q),f.value=null},w=q=>{confirm("Удалить профиль?")&&s.deleteProfile(q)},B=()=>{var L;if(!i.value)return;const q=s.addLayer(i.value.id,{name:`Слой ${(((L=i.value.layers)==null?void 0:L.length)||0)+1}`});q&&(f.value=q.id,d.value="layers")},te=q=>{i.value&&(s.removeLayer(i.value.id,q),f.value===q&&(f.value=null))},Y=(q,L,Q)=>{i.value&&s.updateLayer(i.value.id,q,{[L]:Q})},k=q=>{i.value&&s.updateProfile(i.value.id,{baseTerrain:q})},N=q=>{i.value&&s.addCondition(i.value.id,q,{type:ge.NONE})},$=(q,L)=>{i.value&&s.removeCondition(i.value.id,q,L)},x=()=>{i.value&&n("apply",i.value)},T=()=>{i.value&&n("preview",i.value)},D=()=>{s.createDefaultProfile()},U={[ge.NONE]:"Без условия",[ge.TERRAIN_ID]:"Террейн",[ge.TERRAIN_BIOME]:"Биом",[ge.VISIBILITY]:"Видимость",[ge.MOVEMENT_COST]:"Проходимость",[ge.MELEE_ADVANTAGE]:"Бонус ближ. боя",[ge.TAG]:"Тег"},ue={[we.EQUALS]:"=",[we.NOT_EQUALS]:"≠",[we.GREATER]:">",[we.GREATER_EQUALS]:"≥",[we.LESS]:"<",[we.LESS_EQUALS]:"≤",[we.CONTAINS]:"содержит"};return(q,L)=>{var Q;return p(),h("div",tl,[r("header",nl,[L[5]||(L[5]=r("h3",{class:"text-sm font-medium"},"Профили заливки",-1)),r("button",{type:"button",class:"text-slate-400 hover:text-white transition",onClick:L[0]||(L[0]=m=>n("close"))}," ✕ ")]),r("div",sl,[(p(),h(G,null,ae([{id:"profile",label:"📋 Профиль"},{id:"layers",label:"📚 Слои"},{id:"preview",label:"👁 Превью"}],m=>r("button",{key:m.id,type:"button",class:oe(["flex-1 px-3 py-2 text-xs transition",d.value===m.id?"bg-sky-500/20 text-sky-400 border-b-2 border-sky-400":"text-slate-400 hover:text-white hover:bg-white/5"]),onClick:I=>d.value=m.id},R(m.label),11,ol)),64))]),r("div",al,[d.value==="profile"?(p(),h(G,{key:0},[r("div",ll,[r("div",il,[L[6]||(L[6]=r("span",{class:"text-xs text-slate-400"},"Сохранённые профили",-1)),r("div",rl,[r("button",{type:"button",class:"px-2 py-1 text-xs bg-sky-500/20 text-sky-400 rounded hover:bg-sky-500/30 transition",onClick:L[1]||(L[1]=m=>u.value=!0)}," + Новый "),S(l).length===0?(p(),h("button",{key:0,type:"button",class:"px-2 py-1 text-xs bg-emerald-500/20 text-emerald-400 rounded hover:bg-emerald-500/30 transition",onClick:D}," Пример ")):A("",!0)])]),u.value?(p(),h("div",cl,[Me(r("input",{"onUpdate:modelValue":L[2]||(L[2]=m=>g.value=m),type:"text",placeholder:"Название профиля...",class:"w-full px-2 py-1 text-xs bg-slate-900/50 border border-white/10 rounded mb-2 focus:outline-none focus:border-sky-400/50",onKeyup:as(O,["enter"])},null,544),[[He,g.value]]),r("div",ul,[r("button",{type:"button",class:"flex-1 px-2 py-1 text-xs bg-sky-500 text-white rounded hover:bg-sky-600 transition",onClick:O}," Создать "),r("button",{type:"button",class:"px-2 py-1 text-xs text-slate-400 hover:text-white transition",onClick:L[3]||(L[3]=m=>{u.value=!1,g.value=""})}," Отмена ")])])):A("",!0),(p(!0),h(G,null,ae(S(c),m=>{var I,C;return p(),h("div",{key:m.id,class:oe(["p-2 rounded-lg border transition cursor-pointer",((I=S(i))==null?void 0:I.id)===m.id?"bg-sky-500/20 border-sky-400/60":"bg-slate-700/30 border-white/10 hover:border-white/20"]),onClick:F=>_(m.id)},[r("div",fl,[r("div",null,[r("div",pl,R(m.name),1),r("div",hl,R(((C=m.layers)==null?void 0:C.length)||0)+" слоёв • База: "+R(P(m.baseTerrain).name),1)]),r("button",{type:"button",class:"p-1 text-slate-400 hover:text-red-400 transition",onClick:$e(F=>w(m.id),["stop"])}," 🗑 ",8,ml)])],10,dl)}),128)),S(l).length===0?(p(),h("div",vl," Нет сохранённых профилей ")):A("",!0)]),S(i)?(p(),h("div",gl,[L[7]||(L[7]=r("div",{class:"text-xs text-slate-400 mb-2"},"Базовый террейн",-1)),r("div",bl,[(p(!0),h(G,null,ae(v.value,m=>(p(),h("button",{key:m.id,type:"button",class:oe(["w-10 h-10 rounded border transition",S(i).baseTerrain===m.id?"border-sky-400 ring-2 ring-sky-400/50":"border-white/10 hover:border-white/30"]),style:Se({backgroundColor:m.color||"#888"}),title:m.name,onClick:I=>k(m.id)},null,14,yl))),128))])])):A("",!0)],64)):A("",!0),d.value==="layers"&&S(i)?(p(),h("div",xl,[r("div",kl,[r("span",wl,'Слои профиля "'+R(S(i).name)+'"',1),r("button",{type:"button",class:"px-2 py-1 text-xs bg-sky-500/20 text-sky-400 rounded hover:bg-sky-500/30 transition",onClick:B}," + Слой ")]),(p(!0),h(G,null,ae(S(i).layers,m=>{var I;return p(),h("div",{key:m.id,class:oe(["p-2 rounded-lg border transition",f.value===m.id?"bg-sky-500/10 border-sky-400/60":"bg-slate-700/30 border-white/10"])},[r("div",{class:"flex items-center justify-between cursor-pointer",onClick:C=>f.value=f.value===m.id?null:m.id},[r("div",Tl,[r("input",{type:"checkbox",checked:m.enabled,class:"rounded",onClick:L[4]||(L[4]=$e(()=>{},["stop"])),onChange:C=>Y(m.id,"enabled",C.target.checked)},null,40,Cl),r("span",{class:"w-4 h-4 rounded",style:Se({backgroundColor:P(m.terrainId).color||"#888"})},null,4),r("span",Sl,R(m.name),1)]),r("div",Pl,[r("span",$l,R(m.density)+"%",1),r("button",{type:"button",class:"p-1 text-slate-400 hover:text-red-400 transition",onClick:$e(C=>te(m.id),["stop"])}," ✕ ",8,El)])],8,_l),f.value===m.id?(p(),h("div",Il,[r("div",null,[L[8]||(L[8]=r("label",{class:"text-xs text-slate-400"},"Название",-1)),r("input",{value:m.name,type:"text",class:"w-full px-2 py-1 text-xs bg-slate-900/50 border border-white/10 rounded mt-1 focus:outline-none focus:border-sky-400/50",onInput:C=>Y(m.id,"name",C.target.value)},null,40,Al)]),r("div",null,[L[9]||(L[9]=r("label",{class:"text-xs text-slate-400"},"Террейн",-1)),r("div",Ml,[(p(!0),h(G,null,ae(v.value,C=>(p(),h("button",{key:C.id,type:"button",class:oe(["w-8 h-8 rounded border transition",m.terrainId===C.id?"border-sky-400 ring-2 ring-sky-400/50":"border-white/10 hover:border-white/30"]),style:Se({backgroundColor:C.color||"#888"}),title:C.name,onClick:F=>Y(m.id,"terrainId",C.id)},null,14,Dl))),128))])]),r("div",null,[r("div",Ll,[L[10]||(L[10]=r("label",{class:"text-xs text-slate-400"},"Плотность",-1)),r("span",Rl,R(m.density)+"%",1)]),r("input",{value:m.density,type:"range",min:"0",max:"100",class:"w-full mt-1",onInput:C=>Y(m.id,"density",Number(C.target.value))},null,40,Fl)]),r("div",null,[r("div",Nl,[L[11]||(L[11]=r("label",{class:"text-xs text-slate-400"},"Группировка",-1)),r("span",Ol,R(m.clustering)+"%",1)]),r("div",zl,[L[12]||(L[12]=r("span",null,"Разброс",-1)),r("input",{value:m.clustering,type:"range",min:"0",max:"100",class:"flex-1",onInput:C=>Y(m.id,"clustering",Number(C.target.value))},null,40,Bl),L[13]||(L[13]=r("span",null,"Кластеры",-1))])]),r("div",null,[r("div",jl,[L[14]||(L[14]=r("label",{class:"text-xs text-slate-400"},"Условия",-1)),r("button",{type:"button",class:"text-xs text-sky-400 hover:text-sky-300",onClick:C=>N(m.id)}," + Условие ",8,Wl)]),((I=m.conditions)==null?void 0:I.length)===0?(p(),h("div",Hl," Нет условий (применяется везде) ")):A("",!0),(p(!0),h(G,null,ae(m.conditions,C=>(p(),h("div",{key:C.id,class:"flex items-center gap-1 mt-1 p-1 bg-slate-900/30 rounded text-xs"},[r("select",{value:C.type,class:"flex-1 px-1 py-0.5 bg-slate-800 border border-white/10 rounded text-xs",onChange:F=>S(s).updateLayer(S(i).id,m.id,{conditions:m.conditions.map(H=>H.id===C.id?{...H,type:F.target.value}:H)})},[(p(),h(G,null,ae(U,(F,H)=>r("option",{key:H,value:H},R(F),9,ql)),64))],40,Ul),C.type!==S(ge).NONE?(p(),h("select",{key:0,value:C.operator,class:"px-1 py-0.5 bg-slate-800 border border-white/10 rounded text-xs",onChange:F=>S(s).updateLayer(S(i).id,m.id,{conditions:m.conditions.map(H=>H.id===C.id?{...H,operator:F.target.value}:H)})},[(p(),h(G,null,ae(ue,(F,H)=>r("option",{key:H,value:H},R(F),9,Gl)),64))],40,Vl)):A("",!0),C.type!==S(ge).NONE?(p(),h("input",{key:1,value:C.value,type:"text",placeholder:"значение",class:"w-16 px-1 py-0.5 bg-slate-800 border border-white/10 rounded text-xs",onInput:F=>S(s).updateLayer(S(i).id,m.id,{conditions:m.conditions.map(H=>H.id===C.id?{...H,value:F.target.value}:H)})},null,40,Yl)):A("",!0),r("button",{type:"button",class:"text-slate-400 hover:text-red-400",onClick:F=>$(m.id,C.id)}," ✕ ",8,Xl)]))),128))])])):A("",!0)],2)}),128)),(Q=S(i).layers)!=null&&Q.length?A("",!0):(p(),h("div",Ql," Добавьте слои для настройки заливки "))])):A("",!0),d.value==="preview"&&S(i)?(p(),h("div",Kl,[L[15]||(L[15]=r("div",{class:"text-slate-400 text-sm mb-4"},' Выделите область на карте и нажмите "Превью" чтобы увидеть результат ',-1)),r("button",{type:"button",class:"px-4 py-2 bg-amber-500/20 text-amber-400 rounded-lg hover:bg-amber-500/30 transition",onClick:T}," 👁 Показать превью ")])):A("",!0),!S(i)&&d.value!=="profile"?(p(),h("div",Jl," Выберите или создайте профиль ")):A("",!0)]),S(i)?(p(),h("footer",Zl,[r("button",{type:"button",class:"w-full py-2 bg-emerald-500 text-white rounded-lg font-medium hover:bg-emerald-600 transition",onClick:x}," 🎲 Применить к выделению ")])):A("",!0)])}}},ti=Pt(ei,[["__scopeId","data-v-f9b9add9"]]),ni={class:"h-full bg-slate-950 text-slate-50 flex flex-col overflow-hidden relative"},si={class:"bg-slate-900/90 backdrop-blur border-b border-white/10 px-4 py-2 flex items-center justify-between flex-shrink-0 gap-2 relative z-20"},oi={class:"flex items-center gap-2"},ai={key:0,class:"relative"},li={class:"font-medium truncate max-w-32"},ii=["onClick"],ri={class:"text-sm font-medium"},ci={class:"text-xs text-slate-400"},ui={key:0,class:"text-xs text-emerald-400"},di={key:0,class:"border-t border-white/10 mt-1 pt-1"},fi={key:1,class:"flex items-center gap-2"},pi={key:0,class:"px-3 py-1.5 rounded-lg bg-slate-800 border border-white/10 text-sm font-medium"},hi={key:1,class:"px-3 py-1.5 rounded-lg bg-slate-800/50 border border-white/10 text-sm text-slate-400"},mi={key:2,class:"text-xs px-2 py-1 rounded bg-slate-800 border border-white/10"},vi={key:3,class:"text-xs px-2 py-1 rounded bg-slate-700 text-slate-400"},gi={key:0,class:"flex items-center gap-1"},bi=["title","onClick"],yi={class:"flex items-center gap-1"},xi=["title","onClick"],ki={key:0,class:"text-xs text-slate-500 italic"},wi={class:"relative"},_i={class:"mb-3"},Ti={class:"flex gap-1"},Ci=["title","onClick"],Si={class:"mb-3"},Pi={class:"flex gap-1"},$i=["title","onClick"],Ei={class:"mb-3"},Ii={class:"flex gap-1"},Ai=["title","onClick"],Mi={class:"text-[10px] text-slate-500 mt-1"},Di={key:0},Li={class:"text-xs text-slate-400 mb-1"},Ri=["value"],Fi={class:"text-xs text-slate-400 px-1"},Ni={class:"relative"},Oi={class:"text-xs"},zi={class:"p-2 border-b border-white/10"},Bi={class:"flex items-center gap-2"},ji={key:0,class:"mt-2 space-y-2"},Wi={class:"flex items-center gap-2"},Hi=["value"],Ui={class:"flex items-center gap-2"},qi=["value"],Vi={class:"flex items-center gap-2"},Gi={class:"text-xs text-slate-300 w-8"},Yi={class:"p-2 max-h-64 overflow-y-auto"},Xi={key:0,class:"grid grid-cols-5 gap-1"},Qi=["title","onClick"],Ki={class:"absolute bottom-0 left-0 right-0 flex justify-center gap-0.5 p-0.5 bg-black/50 opacity-0 group-hover:opacity-100 transition"},Ji={key:0,class:"text-[8px]"},Zi={key:1,class:"text-[8px]"},er={key:2,class:"text-[8px]"},tr={key:3,class:"text-[8px]"},nr={key:4,class:"text-[8px] text-green-400"},sr={key:5,class:"text-[8px] text-red-400"},or={key:1,class:"text-center text-xs text-slate-400 py-4"},ar={key:2,class:"mt-2 pt-2 border-t border-white/10"},lr={class:"grid grid-cols-5 gap-1"},ir=["title","onClick"],rr={class:"flex items-center gap-2"},cr=["title"],ur={class:"flex-1 flex overflow-hidden"},dr=["width","height"],fr=["width","height"],pr=["width","height"],hr={key:0,class:"absolute bottom-4 left-4 px-3 py-1.5 rounded-lg bg-slate-900/90 border border-white/10 text-xs font-mono pointer-events-none"},mr={class:"absolute bottom-4 right-4 px-3 py-1.5 rounded-lg bg-slate-900/90 border border-white/10 text-xs pointer-events-none"},vr={class:"bg-slate-900/80 backdrop-blur border-t border-white/10 px-4 py-2 flex-shrink-0 relative z-10"},gr={class:"flex items-center justify-between text-sm"},br={class:"text-slate-400 text-xs"},yr={class:"flex items-center gap-2"},xr={class:"bg-slate-800 border border-white/10 rounded-xl p-6 w-full max-w-md shadow-2xl"},kr={class:"space-y-4"},wr={class:"flex gap-2"},_r=["value"],Tr={class:"flex justify-end gap-2 mt-6"},Fr={__name:"BattleMap",props:{readonly:{type:Boolean,default:!1}},setup(e){const t=e,n=cs(),s=Cn();fn();const o=dn(),l=us(),i=rn(),{activeMap:c,editingMap:d,editorMode:f,selectedTerrain:u,activeLayerId:g,camera:v,maps:P,publishedMaps:O,selection:_}=Xe(n),{isMaster:w}=Xe(o),{characters:B}=Xe(l),te=W(()=>t.readonly||!w.value),Y=W(()=>!te.value),k=j(null),N=j(null),$=j(null),x=j(null),T=j({width:800,height:600}),D=j(!1),U=j(!1),ue=j(!1),q=j(!1),L=j(!1),Q=j(null),m=j(null),I=j(null),C=j(!1),F=j(!1),H=j(!1),K=j(null),pe=j({x:0,y:0}),ie=j(null),ce=j(""),le=j(null),re=j(null),de=j({min:1,max:5}),Te=j(!1),me=j(!1),Ee=j(null),xe=j(null),Pe=j([]),fe=j(new Set),Ze=j({x:0,y:0}),be=j({name:"",orientation:Ut.FLAT,scale:Ne.BATTLE,hexSize:32}),he=W(()=>{const y=c.value;return y?new ds({orientation:y.orientation,hexSize:y.hexSize,origin:{x:0,y:0}}):null}),ct=W(()=>{if(!c.value||!he.value)return[];const y=n.getAllTokens(c.value.id),a=he.value;return y.map(E=>{const M=l.getCharacterById(E.characterId);if(!M)return null;const J=a.hexToPixel(E.q,E.r);return{...E,character:M,pixelX:J.x,pixelY:J.y,meleeDefence:sn(M,"melee"),rangedDefence:sn(M,"ranged")}}).filter(Boolean)}),Et=W(()=>c.value?Math.floor(c.value.hexSize*1.6):48),Be=W(()=>he.value?new fs(he.value):null),It=W(()=>s.getFilteredTerrains({biome:le.value,visibility:re.value,passabilityMin:de.value.min,passabilityMax:de.value.max,search:ce.value})),$n=W(()=>[...s.baseTerrains,...s.customTerrains]),ut=W(()=>{const y=$n.value.find(a=>a.id===u.value);if(y)return y;if(Ve[u.value]){const a=Ve[u.value];return{id:u.value,name:a.name,fallbackColor:a.color,passability:a.passable?1:0}}return{id:"void",name:"Пустота",fallbackColor:"#0d1117",passability:0}});cn(()=>{At(),Y.value&&(P.value.length===0?Nt():c.value||n.setActiveMap(P.value[0].id)),et(),ze(()=>{Ie()}),window.addEventListener("resize",Mt)}),un(()=>{window.removeEventListener("resize",Mt)}),Qe([c,v],()=>{ze(()=>{Ie()})},{deep:!0}),Qe(ct,async y=>{y.length>0&&(await Ha(y),ke())},{immediate:!0});let dt=null;Qe(()=>{var y;return(y=c.value)==null?void 0:y.updatedAt},(y,a)=>{!w.value||!y||(dt&&clearTimeout(dt),dt=setTimeout(()=>{o.broadcastMap()},500))},{flush:"post"});const At=()=>{if(k.value){const y=k.value.getBoundingClientRect();T.value={width:Math.floor(y.width)||800,height:Math.floor(y.height)||600}}},et=()=>{n.$patch({camera:{x:T.value.width/2,y:T.value.height/2,zoom:1}})},Ie=()=>{Fe(),qe(),ke()},Fe=()=>{const y=N.value;if(!y||!c.value||!he.value)return;const a=y.getContext("2d"),E=c.value,M=he.value;a.clearRect(0,0,y.width,y.height),a.save(),a.translate(v.value.x,v.value.y),a.scale(v.value.zoom,v.value.zoom);const J=E.layers.find(ne=>ne.type===je.TERRAIN);if(!J){a.restore();return}J.data.forEach((ne,b)=>{const[z,V]=b.split(",").map(Number),X=M.hexToPixel(z,V),Z=M.getHexCorners(X.x,X.y);let ee=(ne==null?void 0:ne.terrain)||"void",se=!1;ie.value&&ie.value.has(b)&&(ee=ie.value.get(b),se=!0);let ye="#0d1117";const Re=s.getTerrainById(ee);Re?ye=Re.fallbackColor||Re.color||ye:Ve[ee]&&(ye=Ve[ee].color),a.beginPath(),a.moveTo(Z[0].x,Z[0].y);for(let Ae=1;Ae<6;Ae++)a.lineTo(Z[Ae].x,Z[Ae].y);a.closePath(),a.fillStyle=ye,a.fill(),se&&(a.strokeStyle="rgba(255, 255, 0, 0.6)",a.lineWidth=2/v.value.zoom,a.stroke())}),a.restore()},qe=()=>{const y=$.value;if(!y||!c.value||!he.value)return;const a=y.getContext("2d"),E=c.value,M=he.value;if(a.clearRect(0,0,y.width,y.height),!E.visibility.showGrid)return;a.save(),a.translate(v.value.x,v.value.y),a.scale(v.value.zoom,v.value.zoom);const J=E.layers.find(b=>b.type===je.TERRAIN);if(!J){a.restore();return}a.strokeStyle="rgba(255, 255, 255, 0.2)",a.lineWidth=1/v.value.zoom,J.data.forEach((b,z)=>{const[V,X]=z.split(",").map(Number),Z=M.hexToPixel(V,X),ee=M.getHexCorners(Z.x,Z.y);a.beginPath(),a.moveTo(ee[0].x,ee[0].y);for(let se=1;se<6;se++)a.lineTo(ee[se].x,ee[se].y);a.closePath(),a.stroke()});const ne=M.hexToPixel(0,0);a.beginPath(),a.arc(ne.x,ne.y,4/v.value.zoom,0,Math.PI*2),a.fillStyle="rgba(250, 204, 21, 0.8)",a.fill(),a.restore()},ke=()=>{var J,ne,b;const y=x.value;if(!y||!c.value||!he.value)return;const a=y.getContext("2d"),E=he.value;if(a.clearRect(0,0,y.width,y.height),a.save(),a.translate(v.value.x,v.value.y),a.scale(v.value.zoom,v.value.zoom),fe.value.size>0&&fe.value.forEach(z=>{const[V,X]=z.split(",").map(Number),Z=E.hexToPixel(V,X),ee=E.getHexCorners(Z.x,Z.y);a.beginPath(),a.moveTo(ee[0].x,ee[0].y);for(let se=1;se<6;se++)a.lineTo(ee[se].x,ee[se].y);a.closePath(),a.fillStyle="rgba(250, 204, 21, 0.25)",a.fill(),a.strokeStyle="rgba(250, 204, 21, 0.8)",a.lineWidth=2/v.value.zoom,a.stroke()}),Pe.value.length>0&&me.value){const z=_.value.mode;let V,X;if(z===_e.ADD?(V="rgba(34, 197, 94, 0.3)",X="rgba(34, 197, 94, 0.9)"):z===_e.SUBTRACT?(V="rgba(239, 68, 68, 0.3)",X="rgba(239, 68, 68, 0.9)"):(V="rgba(56, 189, 248, 0.3)",X="rgba(56, 189, 248, 0.9)"),Pe.value.forEach(Z=>{const ee=E.hexToPixel(Z.q,Z.r),se=E.getHexCorners(ee.x,ee.y);a.beginPath(),a.moveTo(se[0].x,se[0].y);for(let ye=1;ye<6;ye++)a.lineTo(se[ye].x,se[ye].y);a.closePath(),a.fillStyle=V,a.fill(),a.strokeStyle=X,a.lineWidth=1.5/v.value.zoom,a.stroke()}),xe.value&&Q.value){const Z=_.value.shape,ee=xe.value,se=E.hexToPixel(Q.value.q,Q.value.r);if(a.setLineDash([5/v.value.zoom,5/v.value.zoom]),a.strokeStyle=X,a.lineWidth=2/v.value.zoom,Z===ve.RECTANGLE){const ye=Math.min(ee.x,se.x),Re=Math.max(ee.x,se.x),Ae=Math.min(ee.y,se.y),es=Math.max(ee.y,se.y);a.strokeRect(ye,Ae,Re-ye,es-Ae)}else if(Z===ve.CIRCLE||Z===ve.HEXAGON){const ye=se.x-ee.x,Re=se.y-ee.y,Ae=Math.sqrt(ye*ye+Re*Re);a.beginPath(),a.arc(ee.x,ee.y,Ae,0,Math.PI*2),a.stroke()}else Z===ve.LINE&&(a.beginPath(),a.moveTo(ee.x,ee.y),a.lineTo(se.x,se.y),a.stroke());a.setLineDash([])}}if(xe.value&&me.value){const z=xe.value;a.beginPath(),a.arc(z.x,z.y,6/v.value.zoom,0,Math.PI*2),a.fillStyle="rgba(250, 204, 21, 0.9)",a.fill(),a.strokeStyle="rgba(0, 0, 0, 0.5)",a.lineWidth=1/v.value.zoom,a.stroke()}if(Q.value&&!me.value){const z=E.hexToPixel(Q.value.q,Q.value.r),V=E.getHexCorners(z.x,z.y);a.beginPath(),a.moveTo(V[0].x,V[0].y);for(let X=1;X<6;X++)a.lineTo(V[X].x,V[X].y);a.closePath(),a.fillStyle="rgba(56, 189, 248, 0.3)",a.fill(),a.strokeStyle="rgba(56, 189, 248, 0.8)",a.lineWidth=2,a.stroke()}const M=ct.value;if(M.length>0&&Ja(a,M,{tokenSize:Et.value,showFacing:!0,hoveredTokenId:((J=m.value)==null?void 0:J.characterId)||null,selectedTokenId:((ne=I.value)==null?void 0:ne.characterId)||null,currentUserId:i.userId,isMaster:w.value,draggingTokenId:H.value?(b=K.value)==null?void 0:b.characterId:null}),H.value&&K.value&&he.value){const z=he.value.pixelToHex(K.value.pixelX,K.value.pixelY),V=he.value.hexToPixel(z.q,z.r);a.beginPath();const X=he.value.getHexCorners(V.x,V.y);a.moveTo(X[0].x,X[0].y);for(let Z=1;Z<X.length;Z++)a.lineTo(X[Z].x,X[Z].y);a.closePath(),a.fillStyle="rgba(250, 204, 21, 0.3)",a.fill(),a.strokeStyle="rgba(250, 204, 21, 0.8)",a.lineWidth=2,a.stroke()}a.restore()},Mt=()=>{At(),ze(()=>{Ie()})},En=y=>{if(!he.value||!x.value)return null;const a=x.value.getBoundingClientRect(),E=(y.clientX-a.left-v.value.x)/v.value.zoom,M=(y.clientY-a.top-v.value.y)/v.value.zoom;return he.value.pixelToHex(E,M)},Dt=y=>{if(!x.value)return null;const a=x.value.getBoundingClientRect(),E=(y.clientX-a.left-v.value.x)/v.value.zoom,M=(y.clientY-a.top-v.value.y)/v.value.zoom;return{x:E,y:M}},Lt=y=>{if(!he.value||!Q.value)return null;const a=Dt(y);if(!a)return null;const E=he.value,M=Q.value,J=E.hexToPixel(M.q,M.r),ne=E.getHexCorners(J.x,J.y),b=[{x:J.x,y:J.y,type:"center"},...ne.map((X,Z)=>({x:X.x,y:X.y,type:`corner${Z}`}))];let z=1/0,V=b[0];for(const X of b){const Z=X.x-a.x,ee=X.y-a.y,se=Z*Z+ee*ee;se<z&&(z=se,V=X)}return{x:V.x,y:V.y}},In=y=>{if(C.value){const z=y.clientX-Ze.value.x,V=y.clientY-Ze.value.y;n.panCamera(z,V),Ze.value={x:y.clientX,y:y.clientY},Ie();return}if(H.value&&K.value){const z=y.target.getBoundingClientRect(),V=y.clientX-z.left,X=y.clientY-z.top,Z=yt(V,X,v.value);K.value.pixelX=Z.x-pe.value.x,K.value.pixelY=Z.y-pe.value.y,ke();return}const a=En(y);a?(Q.value=a,me.value&&Ee.value&&Be.value&&Rn(a,y),F.value&&d.value&&f.value!=="select"&&Rt(a)):Q.value=null;const E=y.target.getBoundingClientRect(),M=y.clientX-E.left,J=y.clientY-E.top,ne=yt(M,J,v.value),b=el(ne.x,ne.y,ct.value,Et.value);b!==m.value&&(m.value=b),ke()},An=y=>{var a;if(D.value=!1,ue.value=!1,q.value=!1,y.button===1||y.button===0&&y.shiftKey){C.value=!0,Ze.value={x:y.clientX,y:y.clientY},y.preventDefault();return}if(y.button===0&&m.value&&w.value){H.value=!0,K.value=m.value,I.value=m.value;const E=y.target.getBoundingClientRect(),M=y.clientX-E.left,J=y.clientY-E.top,ne=yt(M,J,v.value);pe.value={x:ne.x-m.value.pixelX,y:ne.y-m.value.pixelY},y.preventDefault();return}if(y.button===0&&m.value){((a=I.value)==null?void 0:a.characterId)===m.value.characterId?I.value=null:I.value=m.value,ke();return}if(y.button===0&&!m.value&&I.value&&(I.value=null,ke()),!te.value&&y.button===0&&Q.value&&d.value)if(f.value==="select"){me.value=!0,Ee.value={...Q.value};const E=Lt(y);xe.value=E,Pe.value=[{...Q.value}]}else f.value==="token"?(fe.value.clear(),fe.value.add(`${Q.value.q},${Q.value.r}`),ke()):(F.value=!0,Rt(Q.value))},Mn=y=>{if(H.value&&K.value&&he.value&&c.value){const a=he.value.pixelToHex(K.value.pixelX,K.value.pixelY),E=K.value.q,M=K.value.r;(E!==a.q||M!==a.r)&&(n.moveToken(c.value.id,E,M,a.q,a.r)?o.broadcastMapTokenMove(c.value.id,K.value.characterId,a.q,a.r):console.warn("Failed to move token - target hex may be occupied")),H.value=!1,K.value=null,pe.value={x:0,y:0},ke();return}me.value&&Ee.value&&Q.value&&Fn(),C.value=!1,F.value=!1,me.value=!1,Ee.value=null,xe.value=null,Pe.value=[],ke()},Dn=()=>{Q.value=null,m.value=null,C.value=!1,F.value=!1,H.value&&(H.value=!1,K.value=null,pe.value={x:0,y:0}),me.value&&(me.value=!1,Ee.value=null,xe.value=null,Pe.value=[]),ke()},Ln=y=>{y.preventDefault();const a=x.value.getBoundingClientRect(),E=y.clientX-a.left,M=y.clientY-a.top,J=v.value.zoom,ne=y.deltaY>0?.9:1.1,b=Math.max(.25,Math.min(4,J*ne)),z=(E-v.value.x)/J,V=(M-v.value.y)/J;n.$patch({camera:{x:E-z*b,y:M-V*b,zoom:b}}),Ie()},Rt=y=>{if(d.value){if(f.value==="paint")n.setHexTerrain(d.value.id,y.q,y.r,u.value),Fe(),qe();else if(f.value==="erase"){const a=c.value,E=a==null?void 0:a.layers.find(M=>M.type===je.TERRAIN);if(E){const M=pt(y.q,y.r);E.data.delete(M),a.updatedAt=Date.now(),Fe(),qe()}}}},Rn=(y,a=null)=>{if(!Be.value||!xe.value)return;const E=_.value.shape,M=_.value.behavior,J=_.value.lineWidth,ne=c.value,b=ne==null?void 0:ne.layers.find(Z=>Z.type===je.TERRAIN),z=b?b.data:new Map,V=a?Lt(a)||Dt(a):null;if(!V)return;let X=[];switch(E){case ve.RECTANGLE:X=Be.value.calculateRectanglePreviewPixel(xe.value,V,z,M);break;case ve.CIRCLE:X=Be.value.calculateCirclePreviewPixel(xe.value,V,z,M);break;case ve.HEXAGON:X=Be.value.calculateHexagonPreviewPixel(xe.value,V,z,M);break;case ve.LINE:X=Be.value.calculateLinePreviewPixel(xe.value,V,J,z,M);break}Pe.value=X},Fn=()=>{if(Pe.value.length===0)return;const y=_.value.mode,a=new Set(fe.value);Pe.value.forEach(E=>{const M=pt(E.q,E.r);switch(y){case _e.REPLACE:a.size===fe.value.size&&a.clear(),a.add(M);break;case _e.ADD:a.add(M);break;case _e.SUBTRACT:a.delete(M);break}}),y===_e.REPLACE?fe.value=new Set(Pe.value.map(E=>pt(E.q,E.r))):fe.value=a},Ft=()=>{fe.value=new Set,ke()},Nn=()=>{fe.value.size===0||!d.value||(fe.value.forEach(y=>{const[a,E]=y.split(",").map(Number);n.setHexTerrain(d.value.id,a,E,u.value)}),Fe(),qe())},On=()=>{if(fe.value.size===0||!c.value)return;const y=c.value.layers.find(a=>a.type===je.TERRAIN);y&&(fe.value.forEach(a=>{y.data.delete(a)}),c.value.updatedAt=Date.now(),Ft(),Fe(),qe())},Nt=()=>{const y=n.createMap({name:be.value.name||"Новая карта",orientation:be.value.orientation,scale:be.value.scale,hexSize:be.value.hexSize}),a=5;for(let E=-a;E<=a;E++)for(let M=-a;M<=a;M++)(Math.abs(E)+Math.abs(E+M)+Math.abs(M))/2<=a&&n.setHexTerrain(y.id,E,M,"grass");n.startEditing(y.id),U.value=!1,be.value.name="",ze(()=>{et(),Ie()})},zn=y=>{n.setActiveMap(y),D.value=!1,ze(()=>{et(),Ie()})},Bn=()=>{d.value?n.stopEditing():c.value&&n.startEditing(c.value.id)},Ot=y=>{n.selectTerrain(y),f.value!=="select"&&n.setEditorMode("paint"),ue.value=!1},jn=()=>{c.value&&n.toggleMapPublished(c.value.id)},Wn=()=>{c.value&&confirm(`Удалить карту "${c.value.name}"?`)&&n.deleteMap(c.value.id)},Hn=y=>{if(!y||fe.value.size===0){alert("Сначала выделите область на карте");return}const a=[...fe.value],E=ja(y,a,s);ie.value=E,Fe(),ke()},Un=y=>{if(!y||fe.value.size===0){alert("Сначала выделите область на карте");return}const a=[...fe.value],E=Sn(y,a,s);E.forEach((J,ne)=>{const[b,z]=ne.split(",").map(Number);n.setHexTerrain(c.value.id,b,z,J)});const M=Ba(E,s);console.log("Заливка применена:",M),ie.value=null,fe.value=new Set,L.value=!1,Ie()},qn=()=>{ie.value=null,Fe(),ke()},Vn=(y,a,E)=>{if(!c.value)return!1;const M=n.placeToken(c.value.id,y,a,E,0);return M&&ke(),M},Gn=y=>{let a=null;if(fe.value.size>0){const E=fe.value.values().next().value,[M,J]=E.split(",").map(Number);a={q:M,r:J}}else Q.value&&(a=Q.value);return a?Vn(y,a.q,a.r):(console.warn("No hex selected for token placement"),!1)},Yn=W(()=>{const y=c.value;if(!y)return 0;const a=y.layers.find(E=>E.type===je.TERRAIN);return(a==null?void 0:a.data.size)||0}),Xn=W(()=>c.value?c.value.orientation===Ut.FLAT?"Flat-top ⬡":"Pointy-top ⬢":""),zt={[Ne.BATTLE]:"Бой",[Ne.LOCATION]:"Локация",[Ne.DISTRICT]:"Район",[Ne.CITY]:"Город",[Ne.REGION]:"Регион",[Ne.WORLD]:"Мир"},Bt={[ve.RECTANGLE]:"▭",[ve.CIRCLE]:"○",[ve.HEXAGON]:"⬡",[ve.LINE]:"╱"},Qn={[ve.RECTANGLE]:"Прямоугольник",[ve.CIRCLE]:"Круг",[ve.HEXAGON]:"Шестиугольник",[ve.LINE]:"Линия"},Kn={[_e.REPLACE]:"⬚",[_e.ADD]:"+",[_e.SUBTRACT]:"−"},Jn={[_e.REPLACE]:"Заменить",[_e.ADD]:"Добавить",[_e.SUBTRACT]:"Вычесть"},Zn={[Oe.AGGRESSIVE]:"Все",[Oe.STANDARD]:"Станд.",[Oe.PASSIVE]:"Связн."},jt={[Oe.AGGRESSIVE]:"Все гексы в геометрической области",[Oe.STANDARD]:"Все гексы в геометрической области",[Oe.PASSIVE]:"Только связные существующие гексы (flood-fill)"};return(y,a)=>{var E,M,J,ne;return p(),h("div",ni,[r("header",si,[r("div",oi,[Y.value?(p(),h("div",ai,[r("button",{type:"button",class:"flex items-center gap-2 px-3 py-1.5 rounded-lg bg-slate-800 border border-white/10 hover:bg-slate-700 transition text-sm",onClick:a[0]||(a[0]=$e(b=>{D.value=!D.value,ue.value=!1},["stop"]))},[r("span",li,R(((E=S(c))==null?void 0:E.name)||"Выбрать карту"),1),a[25]||(a[25]=r("span",{class:"text-slate-400"},"▼",-1))]),D.value?(p(),h("div",{key:0,class:"absolute top-full left-0 mt-1 w-64 bg-slate-800 border border-white/10 rounded-lg shadow-xl z-50 py-1 max-h-80 overflow-y-auto",onClick:a[2]||(a[2]=$e(()=>{},["stop"]))},[(p(!0),h(G,null,ae(S(P),b=>{var z,V;return p(),h("div",{key:b.id,class:oe(["px-3 py-2 hover:bg-slate-700 cursor-pointer flex items-center justify-between",b.id===((z=S(c))==null?void 0:z.id)?"bg-sky-500/20":""]),onClick:X=>zn(b.id)},[r("div",null,[r("p",ri,R(b.name),1),r("p",ci,R(zt[b.scale]),1)]),(V=b.visibility)!=null&&V.published?(p(),h("span",ui,"●")):A("",!0)],10,ii)}),128)),Y.value?(p(),h("div",di,[r("button",{type:"button",class:"w-full px-3 py-2 text-left text-sm text-sky-400 hover:bg-slate-700",onClick:a[1]||(a[1]=b=>{U.value=!0,D.value=!1})}," + Создать карту ")])):A("",!0)])):A("",!0)])):(p(),h("div",fi,[S(c)?(p(),h("span",pi," 🗺️ "+R(S(c).name),1)):(p(),h("span",hi," ⏳ Ожидание карты... "))])),S(c)?(p(),h("span",mi,R(Yn.value)+" гексов • "+R(Xn.value),1)):A("",!0),te.value&&S(c)?(p(),h("span",vi," 👁️ Просмотр ")):A("",!0)]),S(d)&&Y.value?(p(),h("div",gi,[(p(),h(G,null,ae(["select","paint","erase","token"],b=>r("button",{key:b,type:"button",class:oe(["w-9 h-9 rounded-lg border flex items-center justify-center text-sm transition",S(f)===b?"bg-sky-500/30 border-sky-400/60 text-sky-100":"border-white/10 hover:bg-white/5 text-slate-300"]),title:b==="select"?"Выбор":b==="paint"?"Рисовать":b==="erase"?"Стереть":"Токены",onClick:z=>S(n).setEditorMode(b)},R(b==="select"?"👆":b==="paint"?"🖌️":b==="erase"?"🧹":"👤"),11,bi)),64)),S(f)==="token"?(p(),h(G,{key:0},[a[27]||(a[27]=r("div",{class:"w-px h-6 bg-white/10 mx-1"},null,-1)),r("div",yi,[a[26]||(a[26]=r("span",{class:"text-xs text-slate-400 mr-1"},"Персонажи:",-1)),(p(!0),h(G,null,ae(S(B),b=>{var z,V;return p(),h("button",{key:b.id,type:"button",class:oe(["px-2 py-1 rounded text-xs border border-white/10 hover:bg-white/10 transition truncate max-w-24",S(n).findTokenPosition((z=S(c))==null?void 0:z.id,b.id)?"bg-emerald-500/20 border-emerald-400/40":""]),title:b.name+(S(n).findTokenPosition((V=S(c))==null?void 0:V.id,b.id)?" (на карте)":" - клик для размещения"),onClick:X=>Gn(b.id)},R(b.name),11,xi)}),128)),S(B).length?A("",!0):(p(),h("span",ki,"Нет персонажей"))])],64)):A("",!0),S(f)==="select"?(p(),h(G,{key:1},[a[32]||(a[32]=r("div",{class:"w-px h-6 bg-white/10 mx-1"},null,-1)),r("div",wi,[r("button",{type:"button",class:"flex items-center gap-1 px-2 py-1.5 rounded-lg border border-white/10 hover:bg-white/5 transition text-xs",onClick:a[3]||(a[3]=$e(b=>{q.value=!q.value,ue.value=!1,D.value=!1},["stop"]))},[r("span",null,R(Bt[S(_).shape]),1),a[28]||(a[28]=r("span",{class:"text-slate-400"},"▼",-1))]),q.value?(p(),h("div",{key:0,class:"absolute top-full left-0 mt-1 w-56 bg-slate-800 border border-white/10 rounded-lg shadow-xl z-50 p-3",onClick:a[5]||(a[5]=$e(()=>{},["stop"]))},[r("div",_i,[a[29]||(a[29]=r("p",{class:"text-xs text-slate-400 mb-1.5"},"Форма",-1)),r("div",Ti,[(p(!0),h(G,null,ae(Object.values(S(ve)),b=>(p(),h("button",{key:b,type:"button",class:oe(["flex-1 py-1.5 rounded border text-sm transition",S(_).shape===b?"bg-sky-500/20 border-sky-400/60":"border-white/10 hover:bg-white/5"]),title:Qn[b],onClick:z=>S(n).setSelectionShape(b)},R(Bt[b]),11,Ci))),128))])]),r("div",Si,[a[30]||(a[30]=r("p",{class:"text-xs text-slate-400 mb-1.5"},"Режим",-1)),r("div",Pi,[(p(!0),h(G,null,ae(Object.values(S(_e)),b=>(p(),h("button",{key:b,type:"button",class:oe(["flex-1 py-1.5 rounded border text-xs transition",S(_).mode===b?"bg-sky-500/20 border-sky-400/60":"border-white/10 hover:bg-white/5"]),title:Jn[b],onClick:z=>S(n).setSelectionMode(b)},R(Kn[b]),11,$i))),128))])]),r("div",Ei,[a[31]||(a[31]=r("p",{class:"text-xs text-slate-400 mb-1.5"},"Поведение",-1)),r("div",Ii,[(p(!0),h(G,null,ae(Object.values(S(Oe)),b=>(p(),h("button",{key:b,type:"button",class:oe(["flex-1 py-1 rounded border text-[10px] transition",S(_).behavior===b?"bg-sky-500/20 border-sky-400/60":"border-white/10 hover:bg-white/5"]),title:jt[b],onClick:z=>S(n).setSelectionBehavior(b)},R(Zn[b]),11,Ai))),128))]),r("p",Mi,R(jt[S(_).behavior]),1)]),S(_).shape===S(ve).LINE?(p(),h("div",Di,[r("p",Li,"Ширина линии: "+R(S(_).lineWidth),1),r("input",{type:"range",min:"1",max:"5",value:S(_).lineWidth,class:"w-full",onInput:a[4]||(a[4]=b=>S(n).setSelectionLineWidth(Number(b.target.value)))},null,40,Ri)])):A("",!0)])):A("",!0)]),fe.value.size>0?(p(),h(G,{key:0},[r("span",Fi,R(fe.value.size)+" выбрано",1),r("button",{type:"button",class:"px-2 py-1.5 rounded-lg border border-emerald-400/60 bg-emerald-500/20 text-emerald-100 text-xs hover:bg-emerald-500/30 transition",title:"Заполнить выбранным террейном",onClick:Nn}," 🎨 Залить "),r("button",{type:"button",class:"px-2 py-1.5 rounded-lg border border-amber-400/60 bg-amber-500/20 text-amber-100 text-xs hover:bg-amber-500/30 transition",title:"Рандомная заливка по профилю",onClick:a[6]||(a[6]=b=>{L.value=!L.value,ue.value=!1,q.value=!1})}," 🎲 Рандом "),r("button",{type:"button",class:"px-2 py-1.5 rounded-lg border border-rose-400/60 bg-rose-500/20 text-rose-100 text-xs hover:bg-rose-500/30 transition",title:"Удалить выбранные гексы",onClick:On}," 🗑️ "),r("button",{type:"button",class:"px-2 py-1.5 rounded-lg border border-white/10 text-slate-300 text-xs hover:bg-white/5 transition",title:"Снять выделение",onClick:Ft}," ✕ ")],64)):A("",!0)],64)):A("",!0),a[39]||(a[39]=r("div",{class:"w-px h-6 bg-white/10 mx-1"},null,-1)),r("div",Ni,[r("button",{type:"button",class:"flex items-center gap-2 px-2 py-1.5 rounded-lg border border-white/10 hover:bg-white/5 transition text-sm",onClick:a[7]||(a[7]=$e(b=>{ue.value=!ue.value,D.value=!1,q.value=!1},["stop"]))},[r("span",{class:"w-5 h-5 rounded",style:Se({backgroundColor:ut.value.fallbackColor||ut.value.color||"#888"})},null,4),r("span",Oi,R(ut.value.name||S(u)),1)]),ue.value?(p(),h("div",{key:0,class:"absolute top-full left-0 mt-1 w-80 bg-slate-800 border border-white/10 rounded-lg shadow-xl z-50 overflow-hidden",onClick:a[14]||(a[14]=$e(()=>{},["stop"]))},[r("div",zi,[r("div",Bi,[Me(r("input",{"onUpdate:modelValue":a[8]||(a[8]=b=>ce.value=b),type:"text",placeholder:"Поиск террейна...",class:"flex-1 px-2 py-1 text-xs bg-slate-900/50 border border-white/10 rounded focus:outline-none focus:border-sky-400/50"},null,512),[[He,ce.value]]),r("button",{type:"button",class:oe(["p-1 rounded hover:bg-white/10 transition text-xs",Te.value?"bg-sky-500/20 text-sky-400":"text-slate-400"]),onClick:a[9]||(a[9]=b=>Te.value=!Te.value),title:"Показать фильтры"}," ⚙ ",2)]),Te.value?(p(),h("div",ji,[r("div",Wi,[a[34]||(a[34]=r("span",{class:"text-xs text-slate-400 w-16"},"Биом:",-1)),Me(r("select",{"onUpdate:modelValue":a[10]||(a[10]=b=>le.value=b),class:"flex-1 px-2 py-1 text-xs bg-slate-900/50 border border-white/10 rounded focus:outline-none"},[a[33]||(a[33]=r("option",{value:null},"Все биомы",-1)),(p(!0),h(G,null,ae(S(s).biomes,b=>(p(),h("option",{key:b.id,value:b.id},R(b.name),9,Hi))),128))],512),[[ft,le.value]])]),r("div",Ui,[a[36]||(a[36]=r("span",{class:"text-xs text-slate-400 w-16"},"Обзор:",-1)),Me(r("select",{"onUpdate:modelValue":a[11]||(a[11]=b=>re.value=b),class:"flex-1 px-2 py-1 text-xs bg-slate-900/50 border border-white/10 rounded focus:outline-none"},[a[35]||(a[35]=r("option",{value:null},"Любой",-1)),(p(!0),h(G,null,ae(S(s).visibilityTypes,b=>(p(),h("option",{key:b.id,value:b.id},R(b.name),9,qi))),128))],512),[[ft,re.value]])]),r("div",Vi,[a[37]||(a[37]=r("span",{class:"text-xs text-slate-400 w-16"},"Проход:",-1)),Me(r("input",{"onUpdate:modelValue":a[12]||(a[12]=b=>de.value.max=b),type:"range",min:"1",max:"5",step:"1",class:"flex-1"},null,512),[[He,de.value.max,void 0,{number:!0}]]),r("span",Gi,"≤"+R(de.value.max),1)]),r("button",{type:"button",class:"w-full px-2 py-1 text-xs bg-slate-700/50 hover:bg-slate-700 rounded transition",onClick:a[13]||(a[13]=b=>{le.value=null,re.value=null,de.value={min:1,max:5},ce.value=""})}," Сбросить фильтры ")])):A("",!0)]),r("div",Yi,[It.value.length>0?(p(),h("div",Xi,[(p(!0),h(G,null,ae(It.value,b=>(p(),h("button",{key:b.id,type:"button",class:oe(["w-12 h-12 rounded border border-white/10 hover:border-white/30 transition relative group",S(u)===b.id?"ring-2 ring-sky-400":""]),style:Se({backgroundColor:b.color||b.fallbackColor||"#888"}),title:`${b.name}
Проход: ${b.movementCost??1}
Ближ. бой: ${(b.meleeAdvantage??0)>0?"+":""}${b.meleeAdvantage??0}`,onClick:z=>Ot(b.id)},[r("div",Ki,[b.movementCost>=5?(p(),h("span",Ji,"🚫")):b.movementCost>2?(p(),h("span",Zi,"⚠")):A("",!0),b.visibility==="blocking"?(p(),h("span",er,"🔲")):b.visibility==="partial"?(p(),h("span",tr,"🌿")):A("",!0),(b.meleeAdvantage??0)>0?(p(),h("span",nr,"+"+R(b.meleeAdvantage),1)):(b.meleeAdvantage??0)<0?(p(),h("span",sr,R(b.meleeAdvantage),1)):A("",!0)])],14,Qi))),128))])):(p(),h("div",or," Террейны не найдены ")),!ce.value&&!le.value&&!re.value?(p(),h("div",ar,[a[38]||(a[38]=r("div",{class:"text-xs text-slate-500 mb-1"},"Базовые (совместимость):",-1)),r("div",lr,[(p(!0),h(G,null,ae(S(Ve),(b,z)=>(p(),h("button",{key:z,type:"button",class:oe(["w-12 h-12 rounded border border-white/10 hover:border-white/30 transition",S(u)===z?"ring-2 ring-sky-400":""]),style:Se({backgroundColor:b.color}),title:b.name,onClick:V=>Ot(z)},null,14,ir))),128))])])):A("",!0)])])):A("",!0)])])):A("",!0),r("div",rr,[S(w)?(p(),h(G,{key:0},[r("button",{type:"button",class:oe(["px-3 py-1.5 rounded-lg border text-xs transition",S(d)?"bg-emerald-500/20 border-emerald-400/60 text-emerald-100":"border-white/10 hover:bg-white/5 text-slate-300"]),onClick:Bn},R(S(d)?"✓ Готово":"✏️ Редактировать"),3),S(c)?(p(),h("button",{key:0,type:"button",class:oe(["px-3 py-1.5 rounded-lg border text-xs transition",(M=S(c).visibility)!=null&&M.published?"bg-emerald-500/20 border-emerald-400/60 text-emerald-100":"border-white/10 hover:bg-white/5 text-slate-300"]),title:(J=S(c).visibility)!=null&&J.published?"Карта видна игрокам":"Карта скрыта",onClick:jn},R((ne=S(c).visibility)!=null&&ne.published?"👁 Видима":"🙈 Скрыта"),11,cr)):A("",!0)],64)):A("",!0),r("button",{type:"button",class:"w-9 h-9 rounded-lg border border-white/10 hover:bg-white/5 flex items-center justify-center text-sm",title:"Центрировать (0,0)",onClick:a[15]||(a[15]=b=>{et(),Ie()})}," 🎯 ")])]),r("div",ur,[r("div",{ref_key:"canvasContainer",ref:k,class:"flex-1 overflow-hidden relative bg-slate-900/40 z-0"},[r("canvas",{ref_key:"terrainCanvas",ref:N,class:"absolute top-0 left-0",width:T.value.width,height:T.value.height},null,8,dr),r("canvas",{ref_key:"gridCanvas",ref:$,class:"absolute top-0 left-0",width:T.value.width,height:T.value.height},null,8,fr),r("canvas",{ref_key:"uiCanvas",ref:x,class:oe(["absolute top-0 left-0",C.value?"cursor-grabbing":S(d)?"cursor-crosshair":"cursor-grab"]),width:T.value.width,height:T.value.height,onMousemove:In,onMousedown:An,onMouseup:Mn,onMouseleave:Dn,onWheel:Ln,onContextmenu:a[16]||(a[16]=$e(()=>{},["prevent"]))},null,42,pr),Q.value?(p(),h("div",hr," q: "+R(Q.value.q)+", r: "+R(Q.value.r),1)):A("",!0),r("div",mr,R(Math.round(S(v).zoom*100))+"% ",1)],512),L.value?(p(),ls(ti,{key:0,class:"flex-shrink-0 border-l border-white/10",onClose:a[17]||(a[17]=b=>{L.value=!1,qn()}),onPreview:Hn,onApply:Un})):A("",!0)]),r("footer",vr,[r("div",gr,[r("p",br,[S(d)?(p(),h(G,{key:0},[Ht(" Рисуйте кликом/перетаскиванием • Shift+drag для навигации • Колёсико для зума • 🎯 центр (0,0) ")],64)):(p(),h(G,{key:1},[Ht(R(S(w)?'Нажмите "Редактировать" для изменения карты':"Shift+перетаскивание для навигации"),1)],64))]),r("div",yr,[S(w)&&S(c)?(p(),h("button",{key:0,type:"button",class:"px-2 py-1 rounded text-xs text-rose-400 hover:bg-rose-500/10 transition",onClick:Wn}," 🗑️ Удалить ")):A("",!0)])])]),U.value?(p(),h("div",{key:0,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/60",onClick:a[24]||(a[24]=$e(b=>U.value=!1,["self"]))},[r("div",xr,[a[45]||(a[45]=r("h3",{class:"text-lg font-semibold mb-4"},"Создать карту",-1)),r("div",kr,[r("div",null,[a[40]||(a[40]=r("label",{class:"block text-sm text-slate-400 mb-1"},"Название",-1)),Me(r("input",{"onUpdate:modelValue":a[18]||(a[18]=b=>be.value.name=b),type:"text",class:"w-full px-3 py-2 rounded-lg bg-slate-900 border border-white/10 text-sm",placeholder:"Новая карта"},null,512),[[He,be.value.name]])]),r("div",null,[a[41]||(a[41]=r("label",{class:"block text-sm text-slate-400 mb-1"},"Ориентация гексов",-1)),r("div",wr,[r("button",{type:"button",class:oe(["flex-1 py-2 rounded-lg border text-sm transition",be.value.orientation==="flat"?"bg-sky-500/20 border-sky-400/60":"border-white/10 hover:bg-white/5"]),onClick:a[19]||(a[19]=b=>be.value.orientation="flat")}," Flat-top ⬡ ",2),r("button",{type:"button",class:oe(["flex-1 py-2 rounded-lg border text-sm transition",be.value.orientation==="pointy"?"bg-sky-500/20 border-sky-400/60":"border-white/10 hover:bg-white/5"]),onClick:a[20]||(a[20]=b=>be.value.orientation="pointy")}," Pointy-top ⬢ ",2)])]),r("div",null,[a[42]||(a[42]=r("label",{class:"block text-sm text-slate-400 mb-1"},"Масштаб",-1)),Me(r("select",{"onUpdate:modelValue":a[21]||(a[21]=b=>be.value.scale=b),class:"w-full px-3 py-2 rounded-lg bg-slate-900 border border-white/10 text-sm"},[(p(),h(G,null,ae(zt,(b,z)=>r("option",{key:z,value:z},R(b),9,_r)),64))],512),[[ft,be.value.scale]])]),r("div",null,[a[43]||(a[43]=r("label",{class:"block text-sm text-slate-400 mb-1"},"Размер гекса (пиксели)",-1)),Me(r("input",{"onUpdate:modelValue":a[22]||(a[22]=b=>be.value.hexSize=b),type:"number",min:"16",max:"64",class:"w-full px-3 py-2 rounded-lg bg-slate-900 border border-white/10 text-sm"},null,512),[[He,be.value.hexSize,void 0,{number:!0}]])]),a[44]||(a[44]=r("p",{class:"text-xs text-slate-500"}," Карта не имеет фиксированных границ — она расширяется по мере рисования. Центр карты находится в координатах (0, 0). ",-1))]),r("div",Tr,[r("button",{type:"button",class:"px-4 py-2 rounded-lg border border-white/10 hover:bg-white/5 text-sm",onClick:a[23]||(a[23]=b=>U.value=!1)}," Отмена "),r("button",{type:"button",class:"px-4 py-2 rounded-lg bg-sky-500 hover:bg-sky-600 text-sm font-medium",onClick:Nt}," Создать ")])])])):A("",!0)])}}};export{Rr as C,Lr as H,Dr as I,Pt as _,$o as a,Ir as b,Er as c,Sa as d,sn as e,at as f,Mr as g,gt as h,vt as i,$r as j,Fr as k,Ts as p,Ar as r};
