import{l as Gt,r as O,m as Se,n as B,c as s,d as o,e,f as M,g as a,i as T,F,p as J,q as ue,t as u,k as I,x as te,y as Me,z as Jt,w as Xe,T as tt,h as st,v as lt,o as Rt,A as Zt,a as pt,B as Kt,s as Le,j as Qt,C as It,D as es,u as ts,E as Ct}from"./index-CduOqXut.js";import{u as Vt,a as mt,c as ss,b as ls,d as os}from"./fillProfile-dB6AUmU-.js";import{c as Dt,I as D,a as ot,_ as Pe,i as ft,b as vt,p as ht,g as St,d as Mt,r as ns,e as ut,f as At,s as as,G as is,h as Tt}from"./GameLayout-DxnqB2Sj.js";import"./UserAvatar-CwDA-9dA.js";const cs=Gt("characterCreation",{state:()=>({step:1,constraints:{allowedRaces:[],allowedSubraces:[],allowedClasses:[],maxWealth:10,maxEpoch:10},formData:{name:"",portrait:null,gender:null,race:null,subrace:null,class:null,stats:{war:0,knowledge:0,community:0,shadow:0,mysticism:0,nature:0},skills:{fromClass:null,fromAspect1:null,fromAspect2:null},equipment:{armor:"clothes",weapons:[],wealth:5,epoch:10}}}),persist:{key:"trip-character-creation-v3",paths:["step","formData","constraints"]},getters:{isComplete:_=>_.step===7&&_.formData.gender&&_.formData.race&&_.formData.class,isRaceAllowed:_=>Z=>!_.constraints.allowedRaces||_.constraints.allowedRaces.length===0?!0:_.constraints.allowedRaces.includes(Z),isSubraceAllowed:_=>Z=>!_.constraints.allowedSubraces||_.constraints.allowedSubraces.length===0?!0:_.constraints.allowedSubraces.includes(Z),isClassAllowed:_=>Z=>!_.constraints.allowedClasses||_.constraints.allowedClasses.length===0?!0:_.constraints.allowedClasses.includes(Z),maxWealth:_=>_.constraints.maxWealth??10,maxEpoch:_=>_.constraints.maxEpoch??10,hasConstraints:_=>{var y,$,m;const Z=_.constraints;return((y=Z.allowedRaces)==null?void 0:y.length)>0||(($=Z.allowedSubraces)==null?void 0:$.length)>0||((m=Z.allowedClasses)==null?void 0:m.length)>0||Z.maxWealth<10||Z.maxEpoch<10}},actions:{setStep(_){this.step=_},setConstraints(_){this.constraints={allowedRaces:_.allowedRaces||[],allowedSubraces:_.allowedSubraces||[],allowedClasses:_.allowedClasses||[],maxWealth:_.maxWealth??10,maxEpoch:_.maxEpoch??10}},setName(_){this.formData.name=_},setPortrait(_){this.formData.portrait=_},setGender(_){this.formData.gender=_},setRace(_){this.formData.race=_},setSubrace(_){this.formData.subrace=_},setClass(_){this.formData.class=_},setStats(_){this.formData.stats={...this.formData.stats,..._}},setSkills(_){this.formData.skills=_},setEquipment(_){this.formData.equipment=_},reset(){this.step=1,this.constraints={allowedRaces:[],allowedSubraces:[],allowedClasses:[],maxWealth:10,maxEpoch:10},this.formData={name:"",portrait:null,gender:null,race:null,subrace:null,class:null,stats:{war:0,knowledge:0,community:0,shadow:0,mysticism:0,nature:0},skills:{fromClass:null,fromAspect1:null,fromAspect2:null},equipment:{armor:"clothes",weapons:[],wealth:5,epoch:10}}}}}),rs={class:"space-y-6"},us={key:0},ds={class:"flex items-center justify-between mb-3"},vs={class:"space-y-2"},hs={class:"flex items-center gap-3 flex-1"},ps={class:"flex-1"},ms={class:"text-sm font-medium text-slate-200"},fs={class:"text-xs text-slate-400"},gs={class:"flex items-center gap-3"},_s={class:"text-right"},ys={class:"flex items-center gap-3 flex-1"},xs={class:"flex-1"},bs={class:"text-sm font-medium text-slate-300"},ks={class:"text-xs text-slate-500"},$s={class:"flex items-center gap-3"},ws={class:"flex items-center gap-2 px-2.5 py-1.5 rounded-lg border border-slate-700/40 bg-slate-800/40"},Cs={class:"text-right"},Ss={class:"text-[10px] uppercase font-medium tracking-wide text-slate-500"},Ms={class:"text-sm font-bold text-slate-400"},As={class:"text-xl font-semibold text-slate-400 px-3 py-1"},Ts={class:"flex items-center gap-3 flex-1"},Ps={class:"flex-1"},Es={class:"text-sm font-medium text-slate-500"},Rs={class:"text-xs text-slate-600"},Vs={class:"flex items-center gap-3"},Ds={class:"flex items-center gap-2 px-2.5 py-1.5 rounded-lg border border-slate-800/50 bg-slate-900/40"},Ys={class:"text-right"},js={class:"text-[10px] uppercase font-medium tracking-wide text-slate-600"},Xs={class:"text-sm font-bold text-slate-600"},Bs={key:1},qs={class:"space-y-3"},zs={class:"text-xs font-medium text-slate-400 mb-2 flex items-center gap-2"},Ns={class:"grid grid-cols-1 gap-2"},Os=["onClick"],Ls={class:"flex items-start justify-between gap-2"},Us={class:"flex-1 min-w-0"},Ws={class:"text-sm font-medium text-slate-200 mb-1"},Fs={class:"text-xs text-slate-500 leading-relaxed"},Hs={key:0,class:"border-t border-slate-700/30"},Gs=["onClick"],Js={key:0,class:"px-3 pb-3 space-y-2 bg-slate-900/30"},Zs={class:"text-xs font-medium text-slate-300 mb-1"},Ks={class:"text-xs text-slate-400"},Qs={class:"grid grid-cols-1 gap-2"},Is=["onClick"],el={class:"flex items-start justify-between gap-2"},tl={class:"flex-1 min-w-0"},sl={class:"text-sm font-medium text-slate-200 mb-1"},ll={class:"text-xs text-slate-500 leading-relaxed"},ol={key:0,class:"border-t border-slate-700/30"},nl=["onClick"],al={key:0,class:"px-3 pb-3 space-y-2 bg-slate-900/30"},il={class:"text-xs font-medium text-slate-300 mb-1"},cl={class:"text-xs text-slate-400"},rl={class:"grid grid-cols-1 gap-2"},ul=["onClick"],dl={class:"flex items-start justify-between gap-2"},vl={class:"flex-1 min-w-0"},hl={class:"text-sm font-medium text-slate-200 mb-1"},pl={class:"text-xs text-slate-500 leading-relaxed"},ml={key:0,class:"border-t border-slate-700/30"},fl=["onClick"],gl={key:0,class:"px-3 pb-3 space-y-2 bg-slate-900/30"},_l={class:"text-xs font-medium text-slate-300 mb-1"},yl={class:"text-xs text-slate-400"},xl={__name:"ClassStatsAndSkills",props:{classId:{type:String,required:!0},modelValue:{type:Object,required:!0},showStats:{type:Boolean,default:!0},showSkills:{type:Boolean,default:!0}},emits:["update:modelValue"],setup(_,{expose:Z,emit:y}){const $=_,m=y,r=ot.aspects,l=Dt.classes,f=O({...$.modelValue.stats}),p=O({...$.modelValue.skills}),C=O(!1),P=O(new Set);Se(()=>$.modelValue,v=>{if(!C.value){const g=JSON.stringify(f.value)!==JSON.stringify(v.stats),W=JSON.stringify(p.value)!==JSON.stringify(v.skills);g&&(f.value={...v.stats}),W&&(p.value={...v.skills})}},{deep:!0,flush:"post"}),Se([f,p],()=>{C.value||m("update:modelValue",{stats:{...f.value},skills:{...p.value}})},{deep:!0,flush:"post"});const X=B(()=>l.find(v=>v.id===$.classId)),j=B(()=>X.value?X.value.aspects:[]),Y=B(()=>{if(j.value.length!==2)return!1;const v=A(j.value[0]);return A(j.value[1]),(v==null?void 0:v.opposite)===j.value[1]}),S=B(()=>{var W,K;if(!X.value)return[];const v=r.map(se=>se.id),g=j.value;if(Y.value)return v.filter(se=>!g.includes(se));{const se=(W=A(g[0]))==null?void 0:W.opposite,ie=(K=A(g[1]))==null?void 0:K.opposite,fe=[se,ie].filter(Boolean);return v.filter(be=>!g.includes(be)&&!fe.includes(be))}}),ae=B(()=>{var K,se;if(Y.value)return[];if(!X.value)return[];const v=j.value,g=(K=A(v[0]))==null?void 0:K.opposite,W=(se=A(v[1]))==null?void 0:se.opposite;return[g,W].filter(Boolean)}),V=B(()=>{var v;return((v=X.value)==null?void 0:v.traits)||[]}),b=B(()=>{if(!X.value)return[[],[]];const v=r.find(se=>se.id===j.value[0]),g=r.find(se=>se.id===j.value[1]),W=(v==null?void 0:v.traits)||[],K=(g==null?void 0:g.traits)||[];return[W,K]});function A(v){return r.find(g=>g.id===v)}function x(v){var g;return((g=A(v))==null?void 0:g.color)||"#64748b"}const d=B(()=>{const v={};return r.forEach(W=>{var pe;const K=f.value[W.id]||0,se=W.neighbors||[],ie=W.opposite,fe=f.value[se[0]]||0,be=f.value[se[1]]||0,h=Math.floor(K+fe/2+be/2+0),H=f.value[ie]||0,le=Math.floor(H/2),ne=Math.max(h,le);v[W.id]={bonus:ne,checkName:((pe=W.check)==null?void 0:pe.name)||"",checkIcon:W.checkIcon}}),v});Se(()=>$.classId,v=>{if(!v)return;C.value=!0;const g={war:0,knowledge:0,community:0,shadow:0,mysticism:0,nature:0},W=j.value,K=S.value,se=ae.value;W.length===2&&(Y.value?(g[W[0]]=6,g[W[1]]=4,K.forEach(ie=>{g[ie]=1})):(g[W[0]]=6,g[W[1]]=4,K.forEach(ie=>{g[ie]=2}),se.forEach(ie=>{g[ie]=0}))),f.value=g,setTimeout(()=>{C.value=!1,m("update:modelValue",{stats:{...f.value},skills:{...p.value}})},0)},{immediate:!0});function q(){const v=f.value[j.value[0]];f.value[j.value[0]]=f.value[j.value[1]],f.value[j.value[1]]=v}function E(v,g){p.value[v]=g}function U(v){P.value.has(v)?P.value.delete(v):P.value.add(v)}const k=B(()=>p.value.fromClass&&p.value.fromAspect1&&p.value.fromAspect2);return Z({allSkillsSelected:k,swapStats:q}),(v,g)=>{var W,K,se,ie,fe,be;return s(),o("div",rs,[_.showStats?(s(),o("div",us,[e("div",ds,[g[1]||(g[1]=e("h4",{class:"text-xs font-semibold text-slate-400 uppercase tracking-wider"},"Характеристики",-1)),j.value.length===2?(s(),o("button",{key:0,onClick:q,class:"flex items-center gap-1.5 px-3 py-1.5 text-xs rounded bg-slate-700/50 hover:bg-slate-700 border border-slate-600/50 text-slate-300 transition"},[M(a(D),{icon:"mdi:swap-horizontal",class:"w-4 h-4"}),g[0]||(g[0]=e("span",null,"Поменять местами",-1))])):T("",!0)]),e("div",vs,[(s(!0),o(F,null,J(j.value,(h,H)=>{var le,ne,pe,ge,_e,N;return s(),o("div",{key:h,class:"flex items-center justify-between p-3 rounded-lg border transition-colors",style:ue({backgroundColor:x(h)+"15",borderColor:x(h)+"40"})},[e("div",hs,[M(a(D),{icon:((le=A(h))==null?void 0:le.characteristicIcon)||"mdi:star",class:"w-6 h-6",style:ue({color:x(h)})},null,8,["icon","style"]),e("div",ps,[e("div",ms,u((ne=A(h))==null?void 0:ne.characteristic.name),1),e("div",fs,u((pe=A(h))==null?void 0:pe.name),1)])]),e("div",gs,[e("div",{class:"flex items-center gap-2 px-2.5 py-1.5 rounded-lg border",style:ue({backgroundColor:x(h)+"15",borderColor:x(h)+"30"})},[M(a(D),{icon:(ge=d.value[h])==null?void 0:ge.checkIcon,class:"w-4 h-4",style:ue({color:x(h)+"aa"})},null,8,["icon","style"]),e("div",_s,[e("div",{class:"text-[10px] uppercase font-medium tracking-wide",style:ue({color:x(h)+"cc"})},u((_e=d.value[h])==null?void 0:_e.checkName),5),e("div",{class:"text-sm font-bold",style:ue({color:x(h)})}," +"+u((N=d.value[h])==null?void 0:N.bonus),5)])],4),e("div",{class:"text-2xl font-bold px-3 py-1 rounded",style:ue({color:x(h),backgroundColor:x(h)+"20"})},u(f.value[h]),5)])],4)}),128)),(s(!0),o(F,null,J(S.value,h=>{var H,le,ne,pe,ge,_e;return s(),o("div",{key:h,class:"flex items-center justify-between p-3 rounded-lg bg-slate-800/30 border border-slate-700/30"},[e("div",ys,[M(a(D),{icon:((H=A(h))==null?void 0:H.characteristicIcon)||"mdi:star",class:"w-6 h-6 text-slate-400"},null,8,["icon"]),e("div",xs,[e("div",bs,u((le=A(h))==null?void 0:le.characteristic.name),1),e("div",ks,u((ne=A(h))==null?void 0:ne.name),1)])]),e("div",$s,[e("div",ws,[M(a(D),{icon:(pe=d.value[h])==null?void 0:pe.checkIcon,class:"w-4 h-4 text-slate-500"},null,8,["icon"]),e("div",Cs,[e("div",Ss,u((ge=d.value[h])==null?void 0:ge.checkName),1),e("div",Ms," +"+u((_e=d.value[h])==null?void 0:_e.bonus),1)])]),e("div",As,u(f.value[h]),1)])])}),128)),(s(!0),o(F,null,J(ae.value,h=>{var H,le,ne,pe,ge,_e;return s(),o("div",{key:h,class:"flex items-center justify-between p-3 rounded-lg bg-slate-900/50 border border-slate-800/50 opacity-60"},[e("div",Ts,[M(a(D),{icon:((H=A(h))==null?void 0:H.characteristicIcon)||"mdi:star",class:"w-6 h-6 text-slate-600"},null,8,["icon"]),e("div",Ps,[e("div",Es,u((le=A(h))==null?void 0:le.characteristic.name),1),e("div",Rs,u((ne=A(h))==null?void 0:ne.name),1)])]),e("div",Vs,[e("div",Ds,[M(a(D),{icon:(pe=d.value[h])==null?void 0:pe.checkIcon,class:"w-4 h-4 text-slate-600"},null,8,["icon"]),e("div",Ys,[e("div",js,u((ge=d.value[h])==null?void 0:ge.checkName),1),e("div",Xs," +"+u((_e=d.value[h])==null?void 0:_e.bonus),1)])]),g[2]||(g[2]=e("div",{class:"text-xl font-semibold text-slate-600 px-3 py-1"}," 0 ",-1))])])}),128))])])):T("",!0),_.showSkills?(s(),o("div",Bs,[g[3]||(g[3]=e("h4",{class:"text-sm font-semibold text-slate-300 mb-3"},"Выбор навыков (3 из 9)",-1)),e("div",qs,[e("div",null,[e("div",zs,[M(a(D),{icon:"game-icons:skills",class:"w-4 h-4"}),I(" Навык класса (1 из "+u(V.value.length)+") ",1)]),e("div",Ns,[(s(!0),o(F,null,J(V.value,h=>(s(),o("div",{key:h.id,class:te(["rounded-lg border transition-all overflow-hidden",p.value.fromClass===h.id?"bg-slate-700/40 border-slate-500/60 ring-2 ring-slate-500/30":"bg-slate-800/30 border-slate-700/30 hover:bg-slate-800/40 hover:border-slate-700/40"])},[e("button",{onClick:H=>E("fromClass",h.id),class:"w-full text-left p-3 transition"},[e("div",Ls,[e("div",Us,[e("div",Ws,u(h.name),1),e("div",Fs,u(h.levels[0].text),1)]),p.value.fromClass===h.id?(s(),Me(a(D),{key:0,icon:"mdi:check-circle",class:"w-5 h-5 text-slate-300 flex-shrink-0"})):T("",!0)])],8,Os),h.levels.length>1?(s(),o("div",Hs,[e("button",{onClick:H=>U(h.id),class:"w-full px-3 py-2 text-xs text-slate-400 hover:text-slate-300 hover:bg-white/5 transition flex items-center gap-1.5"},[M(a(D),{icon:P.value.has(h.id)?"mdi:chevron-up":"mdi:chevron-down",class:"w-4 h-4"},null,8,["icon"]),e("span",null,u(P.value.has(h.id)?"Скрыть":"Показать")+" уровни 2-3",1)],8,Gs),P.value.has(h.id)?(s(),o("div",Js,[(s(!0),o(F,null,J(h.levels.slice(1),(H,le)=>(s(),o("div",{key:le,class:"p-2 rounded bg-slate-800/50 border border-slate-700/50"},[e("div",Zs,"Уровень "+u(le+2),1),e("div",Ks,u(H.text),1)]))),128))])):T("",!0)])):T("",!0)],2))),128))])]),e("div",null,[e("div",{class:"text-xs font-medium mb-2 flex items-center gap-2",style:ue({color:x(j.value[0])})},[M(a(D),{icon:(W=A(j.value[0]))==null?void 0:W.icon,class:"w-4 h-4"},null,8,["icon"]),I(" Навык аспекта "+u((K=A(j.value[0]))==null?void 0:K.name)+" (1 из "+u(((se=b.value[0])==null?void 0:se.length)||0)+") ",1)],4),e("div",Qs,[(s(!0),o(F,null,J(b.value[0],h=>(s(),o("div",{key:h.id,class:te(["rounded-lg border transition-all overflow-hidden",p.value.fromAspect1===h.id?"bg-slate-700/40 border-slate-500/60 ring-2 ring-slate-500/30":"bg-slate-800/30 border-slate-700/30 hover:bg-slate-800/40 hover:border-slate-700/40"])},[e("button",{onClick:H=>E("fromAspect1",h.id),class:"w-full text-left p-3 transition"},[e("div",el,[e("div",tl,[e("div",sl,u(h.name),1),e("div",ll,u(h.levels[0].text),1)]),p.value.fromAspect1===h.id?(s(),Me(a(D),{key:0,icon:"mdi:check-circle",class:"w-5 h-5 text-slate-300 flex-shrink-0"})):T("",!0)])],8,Is),h.levels.length>1?(s(),o("div",ol,[e("button",{onClick:H=>U(h.id),class:"w-full px-3 py-2 text-xs text-slate-400 hover:text-slate-300 hover:bg-white/5 transition flex items-center gap-1.5"},[M(a(D),{icon:P.value.has(h.id)?"mdi:chevron-up":"mdi:chevron-down",class:"w-4 h-4"},null,8,["icon"]),e("span",null,u(P.value.has(h.id)?"Скрыть":"Показать")+" уровни 2-3",1)],8,nl),P.value.has(h.id)?(s(),o("div",al,[(s(!0),o(F,null,J(h.levels.slice(1),(H,le)=>(s(),o("div",{key:le,class:"p-2 rounded border bg-slate-800/50 border-slate-700/50"},[e("div",il,"Уровень "+u(le+2),1),e("div",cl,u(H.text),1)]))),128))])):T("",!0)])):T("",!0)],2))),128))])]),e("div",null,[e("div",{class:"text-xs font-medium mb-2 flex items-center gap-2",style:ue({color:x(j.value[1])})},[M(a(D),{icon:(ie=A(j.value[1]))==null?void 0:ie.icon,class:"w-4 h-4"},null,8,["icon"]),I(" Навык аспекта "+u((fe=A(j.value[1]))==null?void 0:fe.name)+" (1 из "+u(((be=b.value[1])==null?void 0:be.length)||0)+") ",1)],4),e("div",rl,[(s(!0),o(F,null,J(b.value[1],h=>(s(),o("div",{key:h.id,class:te(["rounded-lg border transition-all overflow-hidden",p.value.fromAspect2===h.id?"bg-slate-700/40 border-slate-500/60 ring-2 ring-slate-500/30":"bg-slate-800/30 border-slate-700/30 hover:bg-slate-800/40 hover:border-slate-700/40"])},[e("button",{onClick:H=>E("fromAspect2",h.id),class:"w-full text-left p-3 transition"},[e("div",dl,[e("div",vl,[e("div",hl,u(h.name),1),e("div",pl,u(h.levels[0].text),1)]),p.value.fromAspect2===h.id?(s(),Me(a(D),{key:0,icon:"mdi:check-circle",class:"w-5 h-5 text-slate-300 flex-shrink-0"})):T("",!0)])],8,ul),h.levels.length>1?(s(),o("div",ml,[e("button",{onClick:H=>U(h.id),class:"w-full px-3 py-2 text-xs text-slate-400 hover:text-slate-300 hover:bg-white/5 transition flex items-center gap-1.5"},[M(a(D),{icon:P.value.has(h.id)?"mdi:chevron-up":"mdi:chevron-down",class:"w-4 h-4"},null,8,["icon"]),e("span",null,u(P.value.has(h.id)?"Скрыть":"Показать")+" уровни 2-3",1)],8,fl),P.value.has(h.id)?(s(),o("div",gl,[(s(!0),o(F,null,J(h.levels.slice(1),(H,le)=>(s(),o("div",{key:le,class:"p-2 rounded border bg-slate-800/50 border-slate-700/50"},[e("div",_l,"Уровень "+u(le+2),1),e("div",yl,u(H.text),1)]))),128))])):T("",!0)])):T("",!0)],2))),128))])])])])):T("",!0)])}}},bl={class:"flex flex-col items-center gap-4"},kl={class:"flex items-center gap-2 bg-slate-800/50 rounded-lg p-1 border border-slate-700/50"},$l=["width","height","viewBox"],wl={key:0},Cl=["points","stroke","stroke-width"],Sl={key:1},Ml=["cx","cy","r","stroke","stroke-width"],Al=["x1","y1","x2","y2"],Tl=["points"],Pl=["points"],El=["cx","cy","fill","stroke"],Rl=["cx","cy","fill","stroke"],Vl=["x","y"],Dl={class:"w-full h-full flex items-center justify-center",xmlns:"http://www.w3.org/1999/xhtml"},Yl=["title"],jl=["x","y"],Xl={class:"flex items-center justify-center",xmlns:"http://www.w3.org/1999/xhtml"},Bl=["x","y"],ql={class:"flex items-center justify-center",xmlns:"http://www.w3.org/1999/xhtml"},zl={__name:"AspectChart",props:{stats:{type:Object,required:!0},size:{type:Number,default:340}},emits:["swap-stats"],setup(_,{emit:Z}){const y=_,{stats:$}=Jt(y),m=ot.aspects,r=O("stats"),l=B(()=>y.size/2),f=B(()=>y.size/2*.6),p=B(()=>{const A={};return m.forEach(x=>{A[x.id]=x.color}),A}),C=B(()=>{const A={};return m.forEach(d=>{var ie;const q=$.value[d.id]||0,E=d.neighbors||[],U=d.opposite,k=$.value[E[0]]||0,v=$.value[E[1]]||0,g=Math.floor(q+k/2+v/2+0),W=$.value[U]||0,K=Math.floor(W/2),se=Math.max(g,K);A[d.id]={bonus:se,checkName:((ie=d.check)==null?void 0:ie.name)||"",checkIcon:d.checkIcon}}),A});function P(A,x){const q=(A*60-120)*(Math.PI/180),E=f.value*x/10;return{x:l.value+E*Math.cos(q),y:l.value+E*Math.sin(q)}}function X(A,x){const d=(A*60-120)*(Math.PI/180),q=j(x);return{x:l.value+q*Math.cos(d),y:l.value+q*Math.sin(d)}}function j(A){return f.value*A/12}function Y(A){const x=(A*60-120)*(Math.PI/180),d=f.value;return{x:l.value+d*Math.cos(x),y:l.value+d*Math.sin(x)}}function S(A){const x=[];for(let d=0;d<6;d++){const q=P(d,A);x.push(`${q.x},${q.y}`)}return x.join(" ")}function ae(){const A=[];return m.forEach((x,d)=>{const q=$.value[x.id]||0,E=P(d,q);A.push(`${E.x},${E.y}`)}),A.join(" ")}function V(){const A=[];return m.forEach((x,d)=>{var U;const q=((U=C.value[x.id])==null?void 0:U.bonus)||0,E=X(d,q);A.push(`${E.x},${E.y}`)}),A.join(" ")}function b(A){const x=(A*60-120)*(Math.PI/180),d=f.value*1.25;return{x:l.value+d*Math.cos(x),y:l.value+d*Math.sin(x)}}return(A,x)=>(s(),o("div",bl,[e("div",kl,[e("button",{onClick:x[0]||(x[0]=d=>r.value="stats"),class:te(["px-4 py-2 rounded-md text-sm font-medium transition-all",r.value==="stats"?"bg-sky-500/20 text-sky-200 border border-sky-400/40":"text-slate-400 hover:text-slate-300"])},[M(a(D),{icon:"game-icons:embrassed-energy",class:"w-4 h-4 inline mr-1.5"}),x[2]||(x[2]=I(" Характеристики ",-1))],2),e("button",{onClick:x[1]||(x[1]=d=>r.value="checks"),class:te(["px-4 py-2 rounded-md text-sm font-medium transition-all",r.value==="checks"?"bg-purple-500/20 text-purple-200 border border-purple-400/40":"text-slate-400 hover:text-slate-300"])},[M(a(D),{icon:"mdi:dice-d20",class:"w-4 h-4 inline mr-1.5"}),x[3]||(x[3]=I(" Бонусы проверок ",-1))],2)]),e("div",{class:"relative",style:ue({width:_.size+"px",height:_.size+"px"})},[(s(),o("svg",{width:_.size,height:_.size,viewBox:`0 0 ${_.size} ${_.size}`},[r.value==="stats"?(s(),o("g",wl,[(s(),o(F,null,J([0,2,4,6,8,10],d=>e("g",{key:d},[e("polygon",{points:S(d),fill:"none",stroke:d===10?"rgba(148, 163, 184, 0.3)":"rgba(148, 163, 184, 0.1)","stroke-width":d===10?1.5:1},null,8,Cl)])),64))])):(s(),o("g",Sl,[(s(),o(F,null,J([0,2,4,6,8,10,12],d=>e("g",{key:d},[e("circle",{cx:l.value,cy:l.value,r:j(d),fill:"none",stroke:d===12?"rgba(148, 163, 184, 0.3)":"rgba(148, 163, 184, 0.1)","stroke-width":d===12?1.5:1},null,8,Ml)])),64))])),(s(!0),o(F,null,J(a(m),(d,q)=>(s(),o("g",{key:d.id},[e("line",{x1:l.value,y1:l.value,x2:Y(q).x,y2:Y(q).y,stroke:"rgba(148, 163, 184, 0.2)","stroke-width":"1"},null,8,Al)]))),128)),r.value==="stats"?(s(),o("polygon",{key:2,points:ae(),fill:"rgba(56, 189, 248, 0.3)",stroke:"rgba(56, 189, 248, 0.7)","stroke-width":"2",class:"transition-all duration-300"},null,8,Tl)):(s(),o("polygon",{key:3,points:V(),fill:"rgba(139, 92, 246, 0.2)",stroke:"rgba(139, 92, 246, 0.6)","stroke-width":"2",class:"transition-all duration-300"},null,8,Pl)),(s(!0),o(F,null,J(a(m),(d,q)=>{var E,U;return s(),o("g",{key:"point-"+d.id},[r.value==="stats"&&a($)[d.id]>0?(s(),o("circle",{key:0,cx:P(q,a($)[d.id]).x,cy:P(q,a($)[d.id]).y,r:4,fill:p.value[d.id],stroke:p.value[d.id],"stroke-width":"2",class:"transition-all duration-300"},null,8,El)):r.value==="checks"?(s(),o("circle",{key:1,cx:X(q,((E=C.value[d.id])==null?void 0:E.bonus)||0).x,cy:X(q,((U=C.value[d.id])==null?void 0:U.bonus)||0).y,r:5,fill:p.value[d.id],stroke:p.value[d.id],"stroke-width":"2",class:"transition-all duration-300"},null,8,Rl)):T("",!0)])}),128)),(s(!0),o(F,null,J(a(m),(d,q)=>{var E,U,k;return s(),o("g",{key:"label-"+d.id},[e("g",null,[e("title",null,u(r.value==="stats"?d.characteristic.name:(E=d.check)==null?void 0:E.name),1),(s(),o("foreignObject",{x:Y(q).x-20,y:Y(q).y-20,width:"40",height:"40"},[e("div",Dl,[e("div",{class:"w-10 h-10 rounded-full flex items-center justify-center shadow-lg",style:ue({backgroundColor:p.value[d.id]+"25",borderColor:p.value[d.id]+"70",borderWidth:"2px"}),title:r.value==="stats"?d.characteristic.name:(U=d.check)==null?void 0:U.name},[M(a(D),{icon:r.value==="stats"?d.characteristicIcon:d.checkIcon,class:"w-6 h-6",style:ue({color:p.value[d.id]})},null,8,["icon","style"])],12,Yl)])],8,Vl))]),r.value==="stats"?(s(),o("foreignObject",{key:0,x:b(q).x-20,y:b(q).y-16,width:"40",height:"32"},[e("div",Xl,[e("div",{class:"text-lg font-bold text-center min-w-[36px]",style:ue({color:p.value[d.id]})},u(a($)[d.id]),5)])],8,jl)):T("",!0),r.value==="checks"?(s(),o("foreignObject",{key:1,x:b(q).x-22,y:b(q).y-16,width:"44",height:"32"},[e("div",ql,[e("div",{class:"text-lg font-bold text-center min-w-[40px]",style:ue({color:p.value[d.id]})},u(((k=C.value[d.id])==null?void 0:k.bonus)||0),5)])],8,Bl)):T("",!0)])}),128))],8,$l))],4)]))}},gt={1:{name:"Каменный век"},2:{name:"Железный век"},3:{name:"Тёмные века"},4:{name:"Античность"},5:{name:"Раннее средневековье"},6:{name:"Средние века"},7:{name:"Ренессанс"},8:{name:"Век пара"},9:{name:"Век дизеля"},10:{name:"Современность"},11:{name:"Кибер век"}},Nl={class:"armor-carousel"},Ol=["disabled"],Ll={class:"armor-display"},Ul={class:"armor-header"},Wl={class:"text-2xl font-bold text-slate-100"},Fl={class:"armor-image-container"},Hl=["src","alt"],Gl={class:"stats-grid"},Jl={class:"stat-item"},Zl={class:"stat-label"},Kl={class:"stat-value"},Ql={class:"stat-item"},Il={class:"stat-label"},eo={class:"stat-value"},to={class:"stat-item"},so={class:"stat-label"},lo={class:"stat-item"},oo={class:"stat-label"},no={class:"price-epoch-row"},ao={class:"price-box"},io={class:"value"},co={class:"epoch-box"},ro={class:"value"},uo={class:"armor-description"},vo={key:0,class:"availability-warning"},ho=["disabled"],po={__name:"ArmorCarousel",props:{modelValue:{type:String,default:"clothes"},wealth:{type:Number,default:5},epoch:{type:Number,default:10}},emits:["update:modelValue"],setup(_,{emit:Z}){const y=_,$=Z,m=gt,r=ft.items.filter(Y=>Y.category==="armor"),l=O(r.findIndex(Y=>Y.id===y.modelValue));Se(()=>y.modelValue,Y=>{const S=r.findIndex(ae=>ae.id===Y);S!==-1&&(l.value=S)});const f=B(()=>r[l.value]),p=()=>{l.value>0&&(l.value--,$("update:modelValue",f.value.id))},C=()=>{l.value<r.length-1&&(l.value++,$("update:modelValue",f.value.id))},P=Y=>Y.price<=y.wealth,X=Y=>{const S=Y.price-y.wealth;return S<0?"availability-green":S===0?"availability-yellow":S===1?"availability-orange":"availability-red"},j=Y=>{const S=Y.price-y.wealth;return S<0?"Незначительная":S===0?"Значительная":S===1?"Огромная":"Запредельная"};return(Y,S)=>{var ae;return s(),o("div",Nl,[e("button",{onClick:p,class:"nav-button left",disabled:l.value===0},[M(a(D),{icon:"mdi:chevron-left",class:"w-6 h-6"})],8,Ol),e("div",Ll,[e("div",Ul,[e("h3",Wl,u(f.value.name),1),e("div",{class:te(["availability-badge",X(f.value)])},u(j(f.value)),3)]),e("div",Fl,[e("img",{src:a(vt)(f.value.id),alt:f.value.name,class:"armor-image",onError:S[0]||(S[0]=V=>V.target.style.display="none")},null,40,Hl)]),e("div",Gl,[e("div",Jl,[e("div",Zl,[M(a(D),{icon:"mdi:shield",class:"w-5 h-5"}),S[1]||(S[1]=I(" Защита ",-1))]),e("div",Kl,u(f.value.defence),1)]),e("div",Ql,[e("div",Il,[M(a(D),{icon:"mdi:shield-check",class:"w-5 h-5"}),S[2]||(S[2]=I(" Снижение ",-1))]),e("div",eo,u(f.value.resist),1)]),e("div",to,[e("div",so,[M(a(D),{icon:"mdi:run-fast",class:"w-5 h-5"}),S[3]||(S[3]=I(" Скорость ",-1))]),e("div",{class:te(["stat-value",f.value.movement<0?"text-red-400":"text-slate-300"])},u(f.value.movement),3)]),e("div",lo,[e("div",oo,[M(a(D),{icon:"mdi:lightning-bolt",class:"w-5 h-5"}),S[4]||(S[4]=I(" Порывы ",-1))]),e("div",{class:te(["stat-value",f.value.bursts<0?"text-red-400":"text-slate-300"])},u(f.value.bursts),3)])]),e("div",no,[e("div",ao,[M(a(D),{icon:"mdi:gold",class:"w-5 h-5"}),S[5]||(S[5]=e("span",{class:"label"},"Цена",-1)),e("span",io,u(f.value.price),1)]),e("div",co,[M(a(D),{icon:"mdi:clock-outline",class:"w-5 h-5"}),S[6]||(S[6]=e("span",{class:"label"},"Эпоха",-1)),e("span",ro,u((ae=a(m)[f.value.epoch])==null?void 0:ae.name),1)])]),e("div",uo,u(f.value.desc),1),P(f.value)?T("",!0):(s(),o("div",vo,[M(a(D),{icon:"mdi:alert",class:"w-5 h-5"}),e("span",null,[S[7]||(S[7]=I("Цена для Вас: ",-1)),e("strong",null,u(j(f.value)),1)]),M(a(D),{icon:"mdi:content-copy",class:"w-4 h-4 ml-auto"})]))]),e("button",{onClick:C,class:"nav-button right",disabled:l.value===a(r).length-1},[M(a(D),{icon:"mdi:chevron-right",class:"w-6 h-6"})],8,ho)])}}},mo=Pe(po,[["__scopeId","data-v-ed08f348"]]),fo={class:"weapons-grid"},go=["onClick"],_o={class:"weapon-image-container"},yo=["src","alt"],xo={class:"weapon-info"},bo={class:"weapon-name"},ko={class:"weapon-quick-stats"},$o={class:"epoch"},wo={key:0,class:"selected-indicator"},Co={key:1,class:"locked-overlay"},So={class:"modal-header"},Mo={class:"text-2xl font-bold text-slate-100"},Ao={class:"modal-body"},To={class:"modal-weapon-image"},Po=["src","alt"],Eo={class:"stats-grid"},Ro={key:0,class:"stat-box"},Vo={class:"stat-label"},Do={class:"stat-value"},Yo={key:1,class:"stat-box"},jo={class:"stat-label"},Xo={class:"stat-value"},Bo={key:2,class:"stat-box"},qo={class:"stat-label"},zo={class:"stat-value"},No={key:3,class:"stat-box"},Oo={class:"stat-label"},Lo={class:"stat-value"},Uo={key:0,class:"damage-section"},Wo={class:"section-title"},Fo={class:"overflow-x-auto"},Ho={class:"w-full text-sm bg-slate-950/30 rounded-lg overflow-hidden"},Go={key:0,class:"border-t border-slate-800"},Jo={class:"text-center p-3"},Zo={class:"text-emerald-400 font-bold text-lg"},Ko={class:"text-center p-3"},Qo={class:"text-sky-400 font-bold text-lg"},Io={key:1,class:"border-t border-slate-800"},en={class:"text-center p-3"},tn={class:"text-emerald-400 font-bold text-lg"},sn={class:"text-center p-3"},ln={class:"text-sky-400 font-bold text-lg"},on={key:2,class:"border-t border-slate-800"},nn={class:"text-center p-3"},an={class:"text-emerald-400 font-bold text-lg"},cn={class:"text-center p-3"},rn={class:"text-sky-400 font-bold text-lg"},un={class:"price-epoch-row"},dn={class:"info-box"},vn={class:"value"},hn={class:"info-box"},pn={class:"value"},mn={class:"damage-section"},fn={class:"section-title"},gn={class:"damage-table"},_n={class:"threshold"},yn={class:"effect"},xn={key:1,class:"description-box"},bn={class:"modal-footer"},kn=["disabled"],$n={__name:"WeaponSelector",props:{modelValue:{type:Array,default:()=>[]},wealth:{type:Number,default:5},epoch:{type:Number,default:10},categoryFilter:{type:String,default:null}},emits:["update:modelValue"],setup(_,{emit:Z}){const y=_,$=Z,m=gt,r=ft.items.filter(V=>V.category==="weapon"||V.category==="shield"),l=O(null),f=B(()=>y.categoryFilter?r.filter(V=>V.subcat===y.categoryFilter):r),p=V=>{l.value=V},C=()=>{l.value=null},P=V=>y.modelValue.includes(V),X=V=>{const b=V.price-y.wealth,A=V.epoch<=y.epoch;return b<=1&&A},j=V=>{const b=V.price-y.wealth;return b<0?"price-green":b===0?"price-yellow":b===1?"price-orange":"price-red"},Y=V=>{const b=P(V.id),A=X(V);return b?"card-selected":A?"card-available":"card-locked"},S=()=>{l.value&&X(l.value)&&($("update:modelValue",[...y.modelValue,l.value.id]),C())},ae=()=>{if(l.value){const V=y.modelValue.filter(b=>b!==l.value.id);$("update:modelValue",V),C()}};return(V,b)=>{var A;return s(),o("div",null,[e("div",fo,[(s(!0),o(F,null,J(f.value,x=>{var d;return s(),o("div",{key:x.id,onClick:q=>p(x),class:te(["weapon-card",Y(x)])},[e("div",_o,[e("img",{src:a(vt)(x.id),alt:x.name,class:"weapon-image",onError:b[0]||(b[0]=q=>q.target.style.display="none")},null,40,yo)]),e("div",xo,[e("h4",bo,u(x.name),1),e("div",ko,[e("span",{class:te(["price",j(x)])},[M(a(D),{icon:"mdi:gold",class:"w-3.5 h-3.5"}),I(" "+u(x.price),1)],2),e("span",$o,u((d=a(m)[x.epoch])==null?void 0:d.name.substring(0,10)),1)])]),P(x.id)?(s(),o("div",wo,[M(a(D),{icon:"mdi:check",class:"w-5 h-5"})])):T("",!0),X(x)?T("",!0):(s(),o("div",Co,[M(a(D),{icon:"mdi:lock",class:"w-8 h-8"})]))],10,go)}),128))]),(s(),Me(tt,{to:"body"},[l.value?(s(),o("div",{key:0,class:"modal-overlay",onClick:C},[e("div",{class:"modal-content",onClick:b[2]||(b[2]=Xe(()=>{},["stop"]))},[e("div",So,[e("h2",Mo,u(l.value.name),1),e("button",{onClick:C,class:"close-button"},[M(a(D),{icon:"mdi:close",class:"w-6 h-6"})])]),e("div",Ao,[e("div",To,[e("img",{src:a(vt)(l.value.id),alt:l.value.name,class:"w-full h-full object-contain",onError:b[1]||(b[1]=x=>x.target.style.display="none")},null,40,Po)]),e("div",Eo,[l.value.attack!==void 0&&typeof l.value.defence!="object"?(s(),o("div",Ro,[e("div",Vo,[M(a(D),{icon:"mdi:sword",class:"w-5 h-5"}),b[3]||(b[3]=I(" Атака ",-1))]),e("div",Do,u(l.value.attack),1)])):T("",!0),l.value.defence!==void 0&&typeof l.value.defence!="object"?(s(),o("div",Yo,[e("div",jo,[M(a(D),{icon:"mdi:shield",class:"w-5 h-5"}),b[4]||(b[4]=I(" Защита ",-1))]),e("div",Xo,u(l.value.defence),1)])):T("",!0),l.value.length!==void 0?(s(),o("div",Bo,[e("div",qo,[M(a(D),{icon:"mdi:arrow-expand-horizontal",class:"w-5 h-5"}),b[5]||(b[5]=I(" Дальность ",-1))]),e("div",zo,u(l.value.length),1)])):T("",!0),l.value.hands!==void 0?(s(),o("div",No,[e("div",Oo,[M(a(D),{icon:"mdi:hand-back-left",class:"w-5 h-5"}),b[6]||(b[6]=I(" Руки ",-1))]),e("div",Lo,u(l.value.hands),1)])):T("",!0)]),typeof l.value.defence=="object"?(s(),o("div",Uo,[e("h3",Wo,[M(a(D),{icon:"mdi:shield",class:"w-5 h-5"}),b[7]||(b[7]=I(" Защита щита ",-1))]),e("div",Fo,[e("table",Ho,[b[11]||(b[11]=e("thead",null,[e("tr",{class:"bg-slate-900/50"},[e("th",{class:"text-left text-slate-400 p-3"},"Направление"),e("th",{class:"text-center text-slate-400 p-3"},"Ближний бой"),e("th",{class:"text-center text-slate-400 p-3"},"Дальний бой")])],-1)),e("tbody",null,[l.value.defence.front?(s(),o("tr",Go,[b[8]||(b[8]=e("td",{class:"p-3 text-slate-300 font-medium"},"Спереди",-1)),e("td",Jo,[e("span",Zo,u(l.value.defence.front.melee||0),1)]),e("td",Ko,[e("span",Qo,u(l.value.defence.front.ranged||0),1)])])):T("",!0),l.value.defence.side?(s(),o("tr",Io,[b[9]||(b[9]=e("td",{class:"p-3 text-slate-300 font-medium"},"С фланга",-1)),e("td",en,[e("span",tn,u(l.value.defence.side.melee||0),1)]),e("td",sn,[e("span",ln,u(l.value.defence.side.ranged||0),1)])])):T("",!0),l.value.defence.back?(s(),o("tr",on,[b[10]||(b[10]=e("td",{class:"p-3 text-slate-300 font-medium"},"Сзади",-1)),e("td",nn,[e("span",an,u(l.value.defence.back.melee||0),1)]),e("td",cn,[e("span",rn,u(l.value.defence.back.ranged||0),1)])])):T("",!0)])])])])):T("",!0),e("div",un,[e("div",dn,[M(a(D),{icon:"mdi:gold",class:"w-5 h-5"}),b[12]||(b[12]=e("span",{class:"label"},"Цена",-1)),e("span",vn,u(l.value.price),1)]),e("div",hn,[M(a(D),{icon:"mdi:clock-outline",class:"w-5 h-5"}),b[13]||(b[13]=e("span",{class:"label"},"Эпоха",-1)),e("span",pn,u((A=a(m)[l.value.epoch])==null?void 0:A.name),1)])]),e("div",mn,[e("h3",fn,[M(a(D),{icon:"mdi:sword-cross",class:"w-5 h-5"}),b[14]||(b[14]=I(" Превышение защиты ",-1))]),e("div",gn,[(s(!0),o(F,null,J(l.value.damage,(x,d)=>(s(),o("div",{key:d,class:"damage-row"},[e("div",_n,u(d),1),e("div",yn,u(x),1)]))),128))])]),l.value.desc?(s(),o("div",xn,u(l.value.desc),1)):T("",!0)]),e("div",bn,[P(l.value.id)?(s(),o("button",{key:1,onClick:ae,class:"action-button remove"},[M(a(D),{icon:"mdi:close-circle",class:"w-5 h-5"}),b[16]||(b[16]=I(" Убрать ",-1))])):(s(),o("button",{key:0,onClick:S,class:"action-button take",disabled:!X(l.value)},[M(a(D),{icon:"mdi:plus-circle",class:"w-5 h-5"}),b[15]||(b[15]=I(" Взять ",-1))],8,kn)),e("button",{onClick:C,class:"action-button close"}," Закрыть ")])])])):T("",!0)]))])}}},wn=Pe($n,[["__scopeId","data-v-5a343b7c"]]),Cn={spears:{name:"Копья",nameEn:"Spears",icon:"game-icons:broadhead-arrow"},swords:{name:"Мечи",nameEn:"Swords",icon:"game-icons:croc-sword"},daggers:{name:"Кинжалы",nameEn:"Daggers",icon:"game-icons:plain-dagger"},bows:{name:"Луки",nameEn:"Bows",icon:"game-icons:bow-arrow"},crossbows:{name:"Арбалеты",nameEn:"Crossbows",icon:"game-icons:crossbow"},slings:{name:"Пращи",nameEn:"Slings",icon:"game-icons:sling"},axes:{name:"Топоры",nameEn:"Axes",icon:"game-icons:battered-axe"},maces:{name:"Булавы",nameEn:"Maces",icon:"game-icons:flanged-mace"},flails:{name:"Цепы",nameEn:"Flails",icon:"game-icons:flail"},shields:{name:"Щиты",nameEn:"Shields",icon:"game-icons:round-shield"}},Sn={light:{name:"Лёгкая",nameEn:"Light"},middle:{name:"Средняя",nameEn:"Medium"},heavy:{name:"Тяжёлая",nameEn:"Heavy"}},Mn={piercing:{name:"Колющий",nameEn:"Piercing"},slashing:{name:"Режущий",nameEn:"Slashing"},bludgeoning:{name:"Дробящий",nameEn:"Bludgeoning"}},An={weaponTypes:Cn,armorTypes:Sn,damageTypes:Mn},Tn={1:{name:"Крайняя бедность"},2:{name:"Бедность"},3:{name:"Умеренная бедность"},4:{name:"Ниже среднего"},5:{name:"Среднее благополучие"},6:{name:"Выше среднего"},7:{name:"Небольшое богатство"},8:{name:"Богатство"},9:{name:"Огромное богатство"},10:{name:"Умопомрачительное богатство"}},Pn={class:"equipment-selector"},En={class:"grid grid-cols-1 md:grid-cols-2 gap-6 mb-6"},Rn={class:"selector-card"},Vn={class:"card-title"},Dn={class:"space-y-4"},Yn={class:"value-display"},jn={class:"value-number"},Xn={class:"value-name"},Bn={class:"hint-text"},qn={class:"highlight"},zn={class:"selector-card"},Nn={class:"card-title"},On={class:"space-y-4"},Ln={class:"value-display"},Un={class:"value-number"},Wn={class:"value-name"},Fn={class:"selector-card mb-6"},Hn={class:"card-title"},Gn={class:"selector-card"},Jn={class:"card-title"},Zn={class:"filter-buttons"},Kn=["onClick"],Qn={class:"selection-summary"},In={class:"summary-item"},ea={class:"summary-value"},ta={class:"summary-item"},sa={class:"summary-value green"},la={class:"summary-item"},oa={class:"summary-value yellow"},na={class:"summary-item"},aa={class:"summary-value orange"},ia={key:0,class:"validation-warnings"},ca={key:1,class:"no-weapon-warning"},ra={__name:"EquipmentSelector",props:{modelValue:{type:Object,default:()=>({armor:"clothes",weapons:[],wealth:5,epoch:10})}},emits:["update:modelValue","validation-change"],setup(_,{emit:Z}){var d,q,E,U;const y=_,$=Z,m=O(((d=y.modelValue)==null?void 0:d.wealth)??5),r=O(((q=y.modelValue)==null?void 0:q.epoch)??10),l=O(((E=y.modelValue)==null?void 0:E.armor)??"clothes"),f=O(((U=y.modelValue)==null?void 0:U.weapons)??[]),p=O(null),C=An.weaponTypes,P=gt,X=Tn,j=ft.items,Y=B(()=>{var k;return((k=X[m.value])==null?void 0:k.name)||""}),S=B(()=>{var k;return((k=P[r.value])==null?void 0:k.name)||""});Se(()=>y.modelValue,k=>{k&&(k.wealth!==void 0&&(m.value=k.wealth),k.epoch!==void 0&&(r.value=k.epoch),k.armor!==void 0&&(l.value=k.armor),k.weapons!==void 0&&(f.value=k.weapons))},{deep:!0});const ae=B(()=>f.value.filter(k=>{const v=j.find(g=>g.id===k);return v&&v.price<m.value}).length),V=B(()=>f.value.filter(k=>{const v=j.find(g=>g.id===k);return v&&v.price===m.value}).length),b=B(()=>f.value.filter(k=>{const v=j.find(g=>g.id===k);return v&&v.price===m.value+1}).length),A=B(()=>{const k=[];return V.value>2&&k.push(`Предметов "жёлтой" доступности не может быть больше двух (у вас: ${V.value})`),b.value>0&&V.value>0&&k.push('Если взят предмет "оранжевой" доступности, нельзя брать "жёлтые" предметы'),b.value>1&&k.push(`Предмет "оранжевой" доступности может быть только один (у вас: ${b.value})`),k}),x=B(()=>A.value.length===0);return Se([m,r,l,f],()=>{$("update:modelValue",{armor:l.value,weapons:f.value,wealth:m.value,epoch:r.value})},{deep:!0}),Se(x,k=>{$("validation-change",k)}),$("validation-change",x.value),(k,v)=>(s(),o("div",Pn,[e("div",En,[e("div",Rn,[e("h3",Vn,[M(a(D),{icon:"mdi:gold",class:"w-6 h-6 text-amber-400"}),v[5]||(v[5]=I(" Уровень благосостояния ",-1))]),e("div",Dn,[st(e("input",{type:"range",min:"1",max:"10","onUpdate:modelValue":v[0]||(v[0]=g=>m.value=g),class:"wealth-slider"},null,512),[[lt,m.value,void 0,{number:!0}]]),e("div",Yn,[e("span",jn,u(m.value),1),v[6]||(v[6]=e("span",{class:"value-separator"},"-",-1)),e("span",Xn,u(Y.value),1)]),e("p",Bn,[v[7]||(v[7]=I(" Максимальная цена: ",-1)),e("span",qn,u(m.value),1)])])]),e("div",zn,[e("h3",Nn,[M(a(D),{icon:"mdi:clock-outline",class:"w-6 h-6 text-sky-400"}),v[8]||(v[8]=I(" Максимальная эпоха ",-1))]),e("div",On,[st(e("input",{type:"range",min:"1",max:"10","onUpdate:modelValue":v[1]||(v[1]=g=>r.value=g),class:"epoch-slider"},null,512),[[lt,r.value,void 0,{number:!0}]]),e("div",Ln,[e("span",Un,u(r.value),1),v[9]||(v[9]=e("span",{class:"value-separator"},"-",-1)),e("span",Wn,u(S.value),1)])])])]),e("div",Fn,[e("h3",Hn,[M(a(D),{icon:"mdi:shield",class:"w-6 h-6 text-emerald-400"}),v[10]||(v[10]=I(" Выбор доспеха ",-1))]),v[11]||(v[11]=e("p",{class:"card-description"}," В бой Вы сможете брать только два набора снаряжения и один доспех. Например, лук со стрелами для дальнего боя и меч с щитом для ближнего. ",-1)),M(mo,{modelValue:l.value,"onUpdate:modelValue":v[2]||(v[2]=g=>l.value=g),wealth:m.value,epoch:r.value},null,8,["modelValue","wealth","epoch"])]),e("div",Gn,[e("h3",Jn,[M(a(D),{icon:"mdi:sword-cross",class:"w-6 h-6 text-red-400"}),v[12]||(v[12]=I(" Выбор оружия ",-1))]),e("div",Zn,[e("button",{onClick:v[3]||(v[3]=g=>p.value=null),class:te(["filter-btn",{active:p.value===null}])}," Всё ",2),(s(!0),o(F,null,J(a(C),(g,W)=>(s(),o("button",{key:W,onClick:K=>p.value=W,class:te(["filter-btn",{active:p.value===W}])},[M(a(D),{icon:g.icon,class:"w-4 h-4"},null,8,["icon"]),I(" "+u(g.name),1)],10,Kn))),128))]),M(wn,{modelValue:f.value,"onUpdate:modelValue":v[4]||(v[4]=g=>f.value=g),wealth:m.value,epoch:r.value,"category-filter":p.value},null,8,["modelValue","wealth","epoch","category-filter"]),e("div",Qn,[e("div",In,[v[13]||(v[13]=e("span",{class:"summary-label"},"Выбрано предметов:",-1)),e("span",ea,u(f.value.length),1)]),e("div",ta,[v[14]||(v[14]=e("span",{class:"summary-label"},"Зелёных:",-1)),e("span",sa,u(ae.value),1)]),e("div",la,[v[15]||(v[15]=e("span",{class:"summary-label"},"Жёлтых:",-1)),e("span",oa,u(V.value),1)]),e("div",na,[v[16]||(v[16]=e("span",{class:"summary-label"},"Оранжевых:",-1)),e("span",aa,u(b.value),1)])]),A.value.length>0?(s(),o("div",ia,[(s(!0),o(F,null,J(A.value,(g,W)=>(s(),o("div",{key:W,class:"warning-message"},[M(a(D),{icon:"mdi:alert",class:"w-5 h-5"}),I(" "+u(g),1)]))),128))])):T("",!0),f.value.length===0?(s(),o("div",ca,[M(a(D),{icon:"mdi:alert-outline",class:"w-5 h-5"}),v[17]||(v[17]=I(" Вы не взяли с собой никакого оружия. Уверены, что хотите продолжить? ",-1))])):T("",!0)])]))}},ua=Pe(ra,[["__scopeId","data-v-fde3c527"]]),da={class:"finalization-step"},va={class:"content-wrapper"},ha={class:"grid grid-cols-1 lg:grid-cols-2 gap-8"},pa={class:"space-y-6"},ma={class:"input-card"},fa={class:"input-label"},ga={class:"char-counter"},_a={class:"preview-card"},ya={class:"preview-title"},xa={class:"selected-portrait-container"},ba=["src","alt"],ka={key:1,class:"no-portrait-placeholder"},$a={key:0,class:"portrait-number"},wa={class:"portraits-section"},Ca={class:"portraits-header"},Sa={class:"portraits-title"},Ma={class:"portraits-grid-container"},Aa={class:"portraits-grid"},Ta=["onClick"],Pa=["src","alt"],Ea={key:0,class:"portrait-check"},Ra={class:"portrait-overlay"},Va={class:"portrait-num"},Da={key:0,class:"summary-card"},Ya={class:"summary-text"},ja={class:"text-slate-100"},Pt=96,Xa={__name:"CharacterFinalization",props:{name:{type:String,default:""},portrait:{type:Number,default:null}},emits:["update:name","update:portrait"],setup(_,{emit:Z}){const y=_,$=Z,m=O(y.name||""),r=O(y.portrait||null);Se(()=>y.name,f=>{m.value=f}),Se(()=>y.portrait,f=>{r.value=f});const l=f=>{r.value=f,$("update:portrait",f)};return(f,p)=>(s(),o("div",da,[e("div",va,[p[8]||(p[8]=e("div",{class:"text-center mb-8"},[e("h2",{class:"text-3xl font-bold text-slate-100 mb-2"},"Последние штрихи"),e("p",{class:"text-slate-400"},"Выберите имя и портрет для вашего персонажа")],-1)),e("div",ha,[e("div",pa,[e("div",ma,[e("label",fa,[M(a(D),{icon:"mdi:account",class:"w-5 h-5"}),p[2]||(p[2]=I(" Имя персонажа ",-1))]),st(e("input",{"onUpdate:modelValue":p[0]||(p[0]=C=>m.value=C),type:"text",placeholder:"Введите имя...",maxlength:"50",class:"name-input",onInput:p[1]||(p[1]=C=>$("update:name",m.value))},null,544),[[lt,m.value]]),e("div",ga,u(m.value.length)+" / 50 ",1)]),e("div",_a,[e("h3",ya,[M(a(D),{icon:"mdi:image",class:"w-5 h-5"}),p[3]||(p[3]=I(" Выбранный портрет ",-1))]),e("div",xa,[r.value?(s(),o("img",{key:0,src:a(ht)(r.value),alt:`Портрет ${r.value}`,class:"selected-portrait-image"},null,8,ba)):(s(),o("div",ka,[M(a(D),{icon:"mdi:account-circle",class:"w-24 h-24 text-slate-600"}),p[4]||(p[4]=e("p",{class:"text-slate-500 text-sm mt-2"},"Выберите портрет",-1))]))]),r.value?(s(),o("div",$a," #"+u(r.value),1)):T("",!0)])]),e("div",wa,[e("div",Ca,[e("h3",Sa,[M(a(D),{icon:"mdi:view-grid",class:"w-5 h-5"}),p[5]||(p[5]=I(" Галерея портретов ",-1))]),e("div",{class:"portraits-count"},u(Pt)+" доступно ")]),e("div",Ma,[e("div",Aa,[(s(),o(F,null,J(Pt,C=>e("div",{key:C,onClick:P=>l(C),class:te(["portrait-card",{selected:r.value===C}])},[e("img",{src:a(ht)(C),alt:`Портрет ${C}`,class:"portrait-image",loading:"lazy"},null,8,Pa),r.value===C?(s(),o("div",Ea,[M(a(D),{icon:"mdi:check-circle",class:"w-6 h-6"})])):T("",!0),e("div",Ra,[e("span",Va,"#"+u(C),1)])],10,Ta)),64))])])])]),m.value&&r.value?(s(),o("div",Da,[M(a(D),{icon:"mdi:check-circle",class:"w-6 h-6 text-emerald-400"}),e("div",Ya,[p[6]||(p[6]=e("span",{class:"text-slate-300"},"Персонаж",-1)),e("strong",ja,u(m.value),1),p[7]||(p[7]=e("span",{class:"text-slate-300"},"готов к созданию!",-1))])])):T("",!0)])]))}},Ba=Pe(Xa,[["__scopeId","data-v-d510e8c7"]]),qa=[{id:"storm",name:"Грозные",nameEn:"Storm",aspect:"war",description:"Те, кто связан с аспектом Войны"},{id:"light",name:"Светлые",nameEn:"Light",aspect:"knowledge",description:"Те, кто связан с аспектом Знания"},{id:"high",name:"Высшие",nameEn:"High",aspect:"community",description:"Те, кто связан с аспектом Общества"},{id:"dusk",name:"Сумеречные",nameEn:"Dusk",aspect:"shadow",description:"Те, кто связан с аспектом Тени"},{id:"moon",name:"Лунные",nameEn:"Moon",aspect:"mysticism",description:"Те, кто связан с аспектом Мистики"},{id:"wild",name:"Вольные",nameEn:"Wild",aspect:"nature",description:"Те, кто связан с аспектом Природы"}],za={subraces:qa},Na={class:"fixed inset-0 z-50 flex flex-col lg:flex-row bg-slate-950 select-none"},Oa=["viewBox"],La=["id"],Ua=["points"],Wa={id:"clip-center-race"},Fa=["points"],Ha=["transform"],Ga={key:0,class:"gender-selection"},Ja=["x","y","href"],Za=["x","y","href"],Ka={key:1,class:"aspects"},Qa=["cx","cy","fill","fill-opacity","onClick"],Ia=["cx","cy","stroke"],ei=["x","y"],ti=["x","y"],si={key:2,class:"race-aspect-connections"},li=["x1","y1","x2","y2","stroke","stroke-opacity"],oi=["x1","y1","x2","y2","stroke","stroke-opacity"],ni={key:3,class:"races"},ai=["onClick","onMouseenter"],ii=["transform"],ci=["clip-path"],ri=["href","onError"],ui=["points","stroke","stroke-width","opacity"],di={key:4,class:"subrace-selection"},vi=["x1","y1","x2","y2","stroke"],hi=["cx","cy","fill","fill-opacity","stroke","stroke-opacity"],pi=["x","y"],mi={class:"flex items-center justify-center w-full h-full opacity-70"},fi=["x","y"],gi=["transform"],_i={"clip-path":"url(#clip-center-race)"},yi=["href"],xi=["points","stroke","stroke-width","opacity"],bi=["cx","cy","onClick","onMouseenter"],ki=["cx","cy"],$i=["cx","cy","fill"],wi=["cx","cy","stroke"],Ci={key:5,class:"class-selection"},Si=["cx","cy","r"],Mi=["cx","cy","fill","fill-opacity"],Ai=["x","y"],Ti=["d","stroke"],Pi=["d","stroke","stroke-opacity","stroke-width"],Ei=["id","gradientTransform"],Ri=["stop-color"],Vi=["stop-color"],Di=["stop-color"],Yi=["stop-color"],ji=["id"],Xi=["points"],Bi=["transform","onClick","onMouseenter"],qi=["fill","fill-opacity","clip-path"],zi=["points","stroke-opacity"],Ni=["x","y","width","height"],Oi=["src"],Li={key:1,class:"pointer-events-none"},Ui=["cx","cy","stroke"],Wi={class:"flex-1 bg-slate-900 border-t lg:border-t-0 lg:border-l border-white/10 flex flex-col relative overflow-hidden"},Fi={class:"sticky top-0 z-20 bg-slate-900/95 backdrop-blur-sm px-6 py-4 border-b border-slate-700/50"},Hi={class:"flex items-center justify-between"},Gi={key:1},Ji={class:"flex-1 overflow-y-auto p-6 pb-0"},Zi={key:0,class:"mb-4"},Ki={class:"text-2xl font-bold text-slate-100"},Qi={class:"text-sm text-slate-400 mt-1"},Ii={class:"pb-6"},ec={key:0,class:"space-y-4"},tc={class:"text-lg font-semibold text-slate-100 mb-2"},sc={class:"text-sm text-slate-300"},lc={class:"flex flex-wrap gap-2"},oc={key:1,class:"space-y-4"},nc={class:"text-lg font-semibold text-slate-100 mb-2"},ac={class:"text-sm text-slate-300"},ic={key:2,class:"space-y-6"},cc={key:0,class:"step-4-container"},rc={class:"step-4-grid gap-8 mb-6"},uc={class:"step-4-left-column space-y-4"},dc={class:"text-2xl font-bold text-slate-100 mb-1"},vc={class:"text-sm text-slate-400"},hc=["src","alt"],pc={class:"flex items-center justify-center"},mc={class:"bg-slate-800/30 border border-slate-700/50 rounded-lg p-5 mb-6"},fc={class:"flex items-start justify-between gap-6 flex-wrap"},gc={key:0,class:"bg-slate-800/20 border border-slate-700/30 rounded-lg p-5 mb-6"},_c={class:"text-sm text-slate-400 leading-relaxed italic"},yc={key:3},xc={key:4},bc={class:"p-6 pt-4 border-t border-white/5 bg-slate-900 flex gap-3 flex-shrink-0"},kc=["disabled"],$c=["disabled"],Et=6,G=800,we=1600,et=5,dt=300,wc={__name:"CharacterCreationCanvas",props:{constraints:{type:Object,default:null}},emits:["close","created"],setup(_,{emit:Z}){const y=_,$=Z,m=cs();Rt(()=>{y.constraints&&m.setConstraints(y.constraints)});const r=B({get:()=>m.step,set:n=>m.setStep(n)}),l=B(()=>m.formData),f=n=>m.isRaceAllowed(n),p=n=>m.isSubraceAllowed(n),C=n=>m.isClassAllowed(n),P=O(1.9),X=O({x:0,y:0}),j=O(!1),Y=O({x:0,y:0}),S=O(!1),ae=O(0),V=O(1),b=O({x:0,y:0}),A=O(null),x=O(null),d=O(null),q=O(null),E=O(!1),U=O("forward"),k=O(!1),v=O(0),g=O(null),W=O(null),K=O({stats:{...m.formData.stats},skills:{...m.formData.skills}}),se=O(!0),ie=ns.races,fe=ot.aspects,be=ot.metadata.circularOrder,h=Dt.classes,H=B(()=>ie.find(n=>n.id===l.value.race)),le=B(()=>{var R;if(!H.value||!l.value.subrace)return null;const n=l.value.subrace.split("-");if(n.length!==2)return null;const[i,w]=n,L=za.subraces.find(Q=>Q.aspect===w);if(!L)return null;const t=(R=H.value.subraceAliases)==null?void 0:R[w];return{...L,id:l.value.subrace,name:(t==null?void 0:t.name)||`${L.name} ${H.value.name.toLowerCase()}`,description:(t==null?void 0:t.description)||L.description}}),ne=B(()=>{if(!l.value.subrace)return null;const n=l.value.subrace.split("-");return n.length===2?n[1]:null}),pe=B(()=>{if(r.value!==2||!l.value.race||E.value)return[];const n=ie.find(i=>i.id===l.value.race);return(n==null?void 0:n.position.aspects)||[]}),ge=B(()=>r.value!==2||!d.value||E.value?[]:ie.filter(n=>n.position.aspects.includes(d.value)).map(n=>n.id)),_e=B(()=>{switch(r.value){case 1:return l.value.gender!==null;case 2:return l.value.race!==null;case 3:return l.value.subrace!==null;case 4:{if(!l.value.class)return!1;const n=K.value.skills;return n.fromClass&&n.fromAspect1&&n.fromAspect2}case 5:return se.value&&l.value.equipment.armor!==null;case 6:return l.value.name.trim().length>0&&l.value.portrait!==null;default:return!1}}),N=n=>{const i=fe.find(ee=>ee.id===n);if(!i)return{x:0,y:0};const w=i.position.angle,L=G*.32,t=(w-90)*(Math.PI/180),R=G/2+L*Math.cos(t),Q=G/2+L*Math.sin(t);return{x:R,y:Q}},Ae=n=>{const[i,w]=n.position.aspects,L=N(i),t=N(w);return{x:(L.x+t.x)/2,y:(L.y+t.y)/2}},he=n=>{const i=fe.find(w=>w.id===n);return(i==null?void 0:i.color)||"#666"},Ue=n=>({war:"w",knowledge:"k",community:"c",shadow:"s",mysticism:"m",nature:"n"})[n]||n,We=(n,i,w=null)=>{if(w){const L=Ue(w);return ut(n,i,L)}return ut(n,i,"base")},Fe=(n,i,w,L=null)=>{const t=n.target;if(!t)return;const R=t.src||"",Q=L?Ue(L):null;if(L&&Q&&R.includes(`/${i}/${w}/${Q}.png`)){console.log(`Subrace portrait not found: ${i}/${w}/${Q}.png (aspect: ${L}), falling back to base`),t.src=ut(i,w,"base");return}if(R.includes(`/${i}/${w}/base.png`)){console.error(`Base portrait not found for ${i} (${w}), hiding image`),t.style.display="none";return}console.error(`Unexpected image load error for ${i} (${w})`,R),t.style.display="none"},Te=(n,i,w)=>{const L=[];for(let t=0;t<6;t++){const R=Math.PI/3*t,Q=n+w*Math.cos(R),ee=i+w*Math.sin(R);L.push(`${Q},${ee}`)}return L.join(" ")},He=n=>n.edges.filter(w=>w.type==="aspect").length===1,nt=n=>{if(He(n)){const de=n.aspects[0],re=N(de),ve=G/2,me=G/2,ye=re.x-ve,$e=re.y-me;let xe=Math.atan2($e,ye)*(180/Math.PI);return xe<0&&(xe+=360),xe}const i=n.aspects[0],w=n.aspects[1],L=N(i),t=N(w),R=t.x-L.x,Q=t.y-L.y;let ee=Math.atan2(Q,R)*(180/Math.PI);return ee<0&&(ee+=360),ee},Ve=n=>{const i=G/2,w=G/2;if(He(n)){const Ce=n.aspects[0],De=N(Ce),Ye=De.x-i,je=De.y-w,_t=Math.sqrt(Ye*Ye+je*je),Ut=Ye/_t,Wt=je/_t,Ie=G*.43;let yt=i+Ut*Ie,xt=w+Wt*Ie;if(n.edges.some(qe=>qe.type==="class")){const qe=n.edges.find(ze=>ze.type==="class"),Ft=qe==null?void 0:qe.id,bt=h.find(ze=>ze.id===Ft);if(bt){const ze=bt.aspects[0],kt=fe.find(Ne=>Ne.id===Ce),$t=fe.find(Ne=>Ne.id===ze);if(kt&&$t){const Ne=kt.position.angle;let Oe=$t.position.angle-Ne;for(;Oe>180;)Oe-=360;for(;Oe<-180;)Oe+=360;const Ht=(Oe>0?14:-14)*(Math.PI/180),wt=Math.atan2(je,Ye)+Ht;yt=i+Math.cos(wt)*Ie,xt=w+Math.sin(wt)*Ie}}}return{x:yt,y:xt}}const L=n.aspects[0],t=n.aspects[1],R=N(L),Q=N(t),ee=n.edges.find(Ce=>Ce.id===L),de=n.edges.find(Ce=>Ce.id===t),re=(ee==null?void 0:ee.cost)||3,ve=(de==null?void 0:de.cost)||3,me=re+ve,ye=re/me;let $e=R.x+(Q.x-R.x)*ye,xe=R.y+(Q.y-R.y)*ye;if(re===2&&ve===4||re===4&&ve===2){const Ce=$e-i,De=xe-w;$e=i+Ce*.875,xe=w+De*.875}const Re=60;return n.id==="seeker"?xe-=Re:n.id==="heretic"?($e+=Re*Math.cos(-Math.PI/6),xe+=Re*Math.sin(Math.PI/6)):n.id==="cutthroat"&&($e+=Re*Math.cos(5*Math.PI/6),xe+=Re*Math.sin(Math.PI/6)),{x:$e,y:xe}},Ge=(n,i,w=.15)=>{const L=i.x-n.x,t=i.y-n.y,R=Math.sqrt(L*L+t*t),Q=L/R,ee=t/R,de=30,re=18,ve=n.x+Q*de,me=n.y+ee*de,ye=i.x-Q*re,$e=i.y-ee*re,xe=-ee,Re=Q,Ce=(ve+ye)/2,De=(me+$e)/2,Ye=Ce+xe*R*w,je=De+Re*R*w;return`M ${ve},${me} Q ${Ye},${je} ${ye},${$e}`},at=n=>{const i=Ae(n),w=l.value.race===n.id,L=ge.value.includes(n.id);if(E.value&&w){const t=G/2,R=G/2;return`translate(${t}, ${R}) scale(2.5)`}return ke.value&&w&&!E.value?`translate(${i.x}, ${i.y}) scale(1.2)`:ke.value&&L&&!E.value?`translate(${i.x}, ${i.y}) scale(1.1)`:`translate(${i.x}, ${i.y})`},Je=n=>{n.preventDefault();const w=n.currentTarget.getBoundingClientRect(),L=n.clientX-w.left,t=n.clientY-w.top,R=-n.deltaY*.001,Q=Math.max(1,Math.min(4,P.value+R));if(Q!==P.value){const ee=L/w.width*we,de=t/w.height*we,re=we/2,ve=G/2,me=(ee-re-X.value.x)/P.value+ve,ye=(de-re-X.value.y)/P.value+ve;X.value={x:ee-re-(me-ve)*Q,y:de-re-(ye-ve)*Q},P.value=Q}},it=n=>{if(n.button===0){S.value=!1;const i={x:n.clientX,y:n.clientY};j.value=!0,Y.value={x:n.clientX-X.value.x,y:n.clientY-X.value.y,initialX:i.x,initialY:i.y}}else(n.button===1||n.button===2)&&(n.preventDefault(),S.value=!1,j.value=!0,Y.value={x:n.clientX-X.value.x,y:n.clientY-X.value.y,initialX:n.clientX,initialY:n.clientY})},ct=n=>{if(j.value){const i=n.clientX-Y.value.initialX,w=n.clientY-Y.value.initialY;!S.value&&(Math.abs(i)>et||Math.abs(w)>et)&&(S.value=!0),S.value&&(X.value={x:n.clientX-Y.value.x,y:n.clientY-Y.value.y})}},c=()=>{j.value=!1,setTimeout(()=>{S.value=!1},10)},z=n=>{if(n.touches.length===1){const i=n.touches[0];j.value=!0,S.value=!1,Y.value={x:i.clientX-X.value.x,y:i.clientY-X.value.y,initialX:i.clientX,initialY:i.clientY}}else if(n.touches.length===2){const i=n.touches[0],w=n.touches[1],L=Math.hypot(w.clientX-i.clientX,w.clientY-i.clientY);ae.value=L,V.value=P.value,b.value={...X.value},S.value=!1}},oe=n=>{if(n.preventDefault(),n.touches.length===1&&j.value){const i=n.touches[0],w=i.clientX-Y.value.initialX,L=i.clientY-Y.value.initialY;!S.value&&(Math.abs(w)>et||Math.abs(L)>et)&&(S.value=!0),S.value&&(X.value={x:i.clientX-Y.value.x,y:i.clientY-Y.value.y})}else if(n.touches.length===2){const i=n.touches[0],w=n.touches[1],L=Math.hypot(w.clientX-i.clientX,w.clientY-i.clientY),t=n.currentTarget.closest("svg");if(!t)return;const R=t.getBoundingClientRect(),Q=(i.clientX+w.clientX)/2,ee=(i.clientY+w.clientY)/2,de=(Q-R.left)/R.width*we,re=(ee-R.top)/R.height*we,ve=Math.max(1,Math.min(4,V.value*(L/ae.value))),me=we/2,ye=G/2,$e=(de-me-b.value.x)/V.value+ye,xe=(re-me-b.value.y)/V.value+ye;X.value={x:de-me-($e-ye)*ve,y:re-me-(xe-ye)*ve},P.value=ve,S.value=!0}},ce=()=>{j.value=!1,setTimeout(()=>{S.value=!1},10)},Be=B(()=>{const n=we/2,i=G/2;return`translate(${n+X.value.x}, ${n+X.value.y}) scale(${P.value}) translate(${-i}, ${-i})`}),Ze=()=>{m.reset(),$("close")},Ke=()=>{$("created",l.value),m.reset()},Ee=n=>{S.value||(m.setGender(n),k.value=!0,setTimeout(()=>{rt(),setTimeout(()=>{k.value=!1},100)},400))},Yt=n=>{if(S.value||!f(n))return;const i=Date.now(),w=g.value===n&&i-v.value<dt;v.value=i,g.value=n,w&&r.value===2?(m.setRace(n),d.value=null,Qe()):(m.setRace(n),d.value=null)},jt=n=>{S.value||(r.value===2?d.value===n?d.value=null:(d.value=n,m.setRace(null)):r.value===3&&m.setSubrace(`${l.value.race}-${n}`))},Xt=n=>{if(S.value)return;const i=`${l.value.race}-${n}`;if(!p(i))return;const w=Date.now(),L=g.value===`subrace-${n}`&&w-v.value<dt;v.value=w,g.value=`subrace-${n}`,L&&r.value===3?(m.setSubrace(i),Qe()):m.setSubrace(i)},Bt=n=>{if(S.value||!C(n))return;const i=Date.now(),w=g.value===`class-${n}`&&i-v.value<dt;v.value=i,g.value=`class-${n}`,w&&r.value===4?(m.setClass(n),Qe()):m.setClass(n)},qt=n=>{S.value||r.value===2&&(m.setRace(null),d.value=null)},zt=n=>{if(S.value)return;const i=n.currentTarget.closest("svg");if(!i)return;const w=i.getBoundingClientRect(),L=n.clientX-w.left,t=n.clientY-w.top,R=L/w.width*we,Q=t/w.height*we,ee=we/2,de=G/2,re=(R-ee-X.value.x)/P.value+de,ve=(Q-ee-X.value.y)/P.value+de,me=P.value<2.5?3.2:1.9;X.value={x:R-ee-(re-de)*me,y:Q-ee-(ve-de)*me},P.value=me},rt=()=>{_e.value&&r.value<Et&&r.value++},Nt=()=>{r.value>1&&(r.value===3&&l.value.race?(E.value=!0,U.value="backward",setTimeout(()=>{E.value=!1,r.value--},600)):r.value--)},Qe=()=>{_e.value&&(r.value===4&&(m.setStats(K.value.stats),m.setSkills(K.value.skills)),r.value===2&&l.value.race||r.value===3&&l.value.subrace||r.value===4&&l.value.class?(E.value=!0,U.value="forward",setTimeout(()=>{rt(),setTimeout(()=>{E.value=!1},100)},600)):rt())};B(()=>{if(r.value<3||!H.value)return null;const n=Ae(H.value),i=G/2,w=G/2;return{translateX:i-n.x,translateY:w-n.y,scale:2.5}});const Ot=B(()=>r.value===1),ke=B(()=>r.value===2),Lt=B(()=>r.value===3);return B(()=>r.value===4),(n,i)=>{var w,L;return s(),o("div",Na,[e("div",{class:"canvas-container relative overflow-hidden touch-none bg-slate-950 flex-shrink-0",onWheel:Je,onMousedown:it,onMousemove:ct,onMouseup:c,onMouseleave:c,onTouchstart:z,onTouchmove:oe,onTouchend:ce,onContextmenu:i[7]||(i[7]=Xe(()=>{},["prevent"]))},[(s(),o("svg",{viewBox:`0 0 ${we} ${we}`,class:"w-full h-full",preserveAspectRatio:"xMidYMid meet"},[e("defs",null,[(s(!0),o(F,null,J(a(ie),t=>(s(),o("clipPath",{key:`clip-${t.id}`,id:`clip-${t.id}`},[e("polygon",{points:Te(0,0,48)},null,8,Ua)],8,La))),128)),e("clipPath",Wa,[e("polygon",{points:Te(0,0,120)},null,8,Fa)])]),e("g",{transform:Be.value,class:te(["canvas-group",{panning:j.value}])},[e("rect",{x:"0",y:"0",width:G,height:G,fill:"#0f172a",class:"cursor-default",onClick:qt,onDblclick:zt},null,32),Ot.value||k.value?(s(),o("g",Ga,[e("g",{class:te(["gender-option",{"gender-sliding-left":k.value}])},[e("image",{x:G/4-280,y:G/2-350,width:"560",height:"700",href:a(St)("male"),class:te(["cursor-pointer opacity-90 hover:opacity-100 transition-opacity",{"brightness-110":l.value.gender==="m"}]),onClick:i[0]||(i[0]=t=>Ee("m"))},null,10,Ja)],2),e("g",{class:te(["gender-option",{"gender-sliding-right":k.value}])},[e("image",{x:G*3/4-280,y:G/2-350,width:"560",height:"700",href:a(St)("female"),class:te(["cursor-pointer opacity-90 hover:opacity-100 transition-opacity",{"brightness-110":l.value.gender==="f"}]),onClick:i[1]||(i[1]=t=>Ee("f"))},null,10,Za)],2)])):T("",!0),r.value>=2&&r.value!==3&&r.value!==4?(s(),o("g",Ka,[(s(!0),o(F,null,J(a(fe),t=>(s(),o("g",{key:t.id},[e("circle",{cx:N(t.id).x,cy:N(t.id).y,r:"32",fill:t.color,"fill-opacity":d.value===t.id?.8:pe.value.includes(t.id)?.7:.4,class:"transition-all duration-300 cursor-pointer",onClick:Xe(R=>jt(t.id),["stop"])},null,8,Qa),d.value===t.id?(s(),o("circle",{key:0,cx:N(t.id).x,cy:N(t.id).y,r:"36",fill:"none",stroke:t.color,"stroke-width":"2",opacity:"0.9",class:"pointer-events-none animate-pulse"},null,8,Ia)):T("",!0),(s(),o("foreignObject",{x:N(t.id).x-16,y:N(t.id).y-16,width:"32",height:"32",class:"pointer-events-none"},[e("div",{class:te(["flex items-center justify-center w-full h-full transition-opacity duration-300",d.value===t.id?"opacity-90":pe.value.includes(t.id)?"opacity-80":"opacity-50"])},[M(a(D),{icon:t.icon,class:"text-2xl"},null,8,["icon"])],2)],8,ei)),e("text",{x:N(t.id).x,y:N(t.id).y+G*.055,"text-anchor":"middle",class:te(["text-xs font-medium select-none transition-all duration-300 pointer-events-none",d.value===t.id?"fill-white font-semibold":pe.value.includes(t.id)?"fill-slate-100":"fill-slate-300"])},u(t.name),11,ti)]))),128))])):T("",!0),ke.value&&!E.value?(s(),o("g",si,[(s(!0),o(F,null,J(a(ie),t=>(s(),o("line",{key:`line1-${t.id}`,x1:Ae(t).x,y1:Ae(t).y,x2:N(t.position.aspects[0]).x,y2:N(t.position.aspects[0]).y,stroke:he(t.position.aspects[0]),"stroke-opacity":l.value.race===t.id?.5:.15,"stroke-width":"2",class:"transition-all duration-300"},null,8,li))),128)),(s(!0),o(F,null,J(a(ie),t=>(s(),o("line",{key:`line2-${t.id}`,x1:Ae(t).x,y1:Ae(t).y,x2:N(t.position.aspects[1]).x,y2:N(t.position.aspects[1]).y,stroke:he(t.position.aspects[1]),"stroke-opacity":l.value.race===t.id?.5:.15,"stroke-width":"2",class:"transition-all duration-300"},null,8,oi))),128))])):T("",!0),ke.value||E.value?(s(),o("g",ni,[(s(!0),o(F,null,J(a(ie),t=>(s(),o("g",{key:t.id,class:te([f(t.id)?"cursor-pointer":"cursor-not-allowed",E.value?"":"transition-all duration-300"]),style:ue([E.value&&l.value.race!==t.id&&U.value==="forward"?"opacity: 0; transition: opacity 600ms ease-out;":E.value&&U.value==="backward"&&l.value.race!==t.id?"opacity: 0; transition: opacity 600ms ease-in;":E.value&&U.value==="backward"&&l.value.race===t.id?"opacity: 1;":"",f(t.id)?"":"filter: grayscale(100%); opacity: 0.5;"].filter(Boolean).join(" ")),onClick:R=>Yt(t.id),onMouseenter:R=>A.value=t.id,onMouseleave:i[2]||(i[2]=R=>A.value=null)},[e("g",{transform:at(t),style:ue(E.value&&l.value.race===t.id?"transition: transform 600ms cubic-bezier(0.4, 0, 0.2, 1);":!E.value&&(l.value.race===t.id||ge.value.includes(t.id))?"transition: transform 200ms ease-out;":"")},[e("g",{"clip-path":`url(#clip-${t.id})`},[e("image",{href:We(t.id,l.value.gender),x:"-48",y:"-48",width:"96",height:"96",preserveAspectRatio:"xMidYMid slice",onError:R=>Fe(R,t.id,l.value.gender)},null,40,ri)],8,ci),e("polygon",{points:Te(0,0,48),fill:"none",stroke:l.value.race===t.id&&ke.value?"white":ge.value.includes(t.id)&&ke.value?"#fbbf24":A.value===t.id&&ke.value?"#64748b":"#1e293b","stroke-width":l.value.race===t.id&&ke.value||ge.value.includes(t.id)&&ke.value?2.5:2,opacity:l.value.race===t.id&&ke.value?.9:ge.value.includes(t.id)&&ke.value?.85:A.value===t.id&&ke.value?.8:.6,class:"transition-all duration-200"},null,8,ui)],12,ii)],46,ai))),128))])):T("",!0),Lt.value&&H.value?(s(),o("g",di,[ne.value?(s(),o("line",{key:0,x1:G/2,y1:G/2,x2:N(ne.value).x,y2:N(ne.value).y,stroke:he(ne.value),"stroke-width":"3",opacity:"0.5",class:"transition-all duration-300"},null,8,vi)):T("",!0),(s(!0),o(F,null,J(a(be),t=>(s(),o("g",{key:`aspect-bg-${t}`,class:"pointer-events-none"},[e("circle",{cx:N(t).x,cy:N(t).y,r:"36",fill:he(t),"fill-opacity":ne.value===t?.6:.3,stroke:he(t),"stroke-opacity":ne.value===t?.4:.2,"stroke-width":"1",class:"transition-all duration-300"},null,8,hi)]))),128)),(s(!0),o(F,null,J(a(fe),t=>(s(),o("g",{key:`aspect-full-${t.id}`,class:"pointer-events-none"},[(s(),o("foreignObject",{x:N(t.id).x-16,y:N(t.id).y-16,width:"32",height:"32"},[e("div",mi,[M(a(D),{icon:t.icon,class:"text-2xl"},null,8,["icon"])])],8,pi)),e("text",{x:N(t.id).x,y:N(t.id).y+G*.055,"text-anchor":"middle",class:"text-xs font-medium fill-slate-200 select-none"},u(t.name),9,fi)]))),128)),e("g",{transform:`translate(${G/2}, ${G/2})`},[e("g",_i,[e("image",{href:We(H.value.id,l.value.gender,ne.value),x:"-120",y:"-120",width:"240",height:"240",preserveAspectRatio:"xMidYMid slice",onError:i[3]||(i[3]=t=>Fe(t,H.value.id,l.value.gender,ne.value)),class:"transition-opacity duration-300"},null,40,yi)]),e("polygon",{points:Te(0,0,120),fill:"none",stroke:ne.value?he(ne.value):"white","stroke-width":ne.value?5:3,opacity:ne.value?.95:.7,class:"transition-all duration-300"},null,8,xi)],8,gi),(s(!0),o(F,null,J(a(be),t=>(s(),o("g",{key:`subrace-${t}`},[e("circle",{cx:N(t).x,cy:N(t).y,r:"40",fill:"transparent",class:te(p(`${l.value.race}-${t}`)?"cursor-pointer":"cursor-not-allowed"),style:ue(p(`${l.value.race}-${t}`)?"":"opacity: 0.3;"),onClick:R=>Xt(t),onMouseenter:R=>x.value=t,onMouseleave:i[4]||(i[4]=R=>x.value=null)},null,46,bi),p(`${l.value.race}-${t}`)?T("",!0):(s(),o("circle",{key:0,cx:N(t).x,cy:N(t).y,r:"36",fill:"gray",opacity:"0.4",class:"pointer-events-none"},null,8,ki)),x.value===t&&ne.value!==t&&p(`${l.value.race}-${t}`)?(s(),o("circle",{key:1,cx:N(t).x,cy:N(t).y,r:"36",fill:he(t),opacity:"0.5",class:"pointer-events-none"},null,8,$i)):T("",!0),ne.value===t?(s(),o("circle",{key:2,cx:N(t).x,cy:N(t).y,r:"38",fill:"none",stroke:he(t),"stroke-width":"3",opacity:"0.8",class:"pointer-events-none"},null,8,wi)):T("",!0)]))),128))])):T("",!0),r.value===4?(s(),o("g",Ci,[e("rect",{x:"0",y:"0",width:G,height:G,fill:"transparent",class:"cursor-default",onClick:i[5]||(i[5]=()=>{l.value.class&&a(m).setClass(null)})}),e("circle",{cx:G/2,cy:G/2,r:G*.32,fill:"none",stroke:"#ffffff","stroke-width":"8",opacity:"0.075",class:"pointer-events-none"},null,8,Si),(s(!0),o(F,null,J(a(fe),t=>{var R,Q;return s(),o("g",{key:`aspect-bg-${t.id}`},[e("circle",{cx:N(t.id).x,cy:N(t.id).y,r:"18",fill:he(t.id),"fill-opacity":l.value.class?(R=a(h).find(ee=>ee.id===l.value.class))!=null&&R.aspects.includes(t.id)?.35:.15:.4,class:"pointer-events-none transition-all duration-300"},null,8,Mi),(s(),o("foreignObject",{x:N(t.id).x-16,y:N(t.id).y-16,width:"32",height:"32",class:"pointer-events-none"},[e("div",{class:te(["flex items-center justify-center w-full h-full transition-opacity duration-300",l.value.class?(Q=a(h).find(ee=>ee.id===l.value.class))!=null&&Q.aspects.includes(t.id)?"opacity-60":"opacity-30":"opacity-70"])},[M(a(D),{icon:t.icon,class:"text-2xl"},null,8,["icon"])],2)],8,Ai))])}),128)),(s(!0),o(F,null,J(a(h),t=>(s(),o("g",{key:`class-lines-${t.id}`,class:"pointer-events-none"},[(s(!0),o(F,null,J(t.edges.filter(R=>R.type==="aspect"),R=>(s(),o(F,{key:`edge-${t.id}-${R.id}`},[l.value.class===t.id?(s(),o("path",{key:0,d:Ge(Ve(t),N(R.id)),stroke:he(R.id),"stroke-opacity":"0.6","stroke-width":"8",fill:"none",class:"transition-all duration-300",style:{filter:"blur(4px)"}},null,8,Ti)):T("",!0),e("path",{d:Ge(Ve(t),N(R.id)),stroke:l.value.class===t.id?he(R.id):q.value===t.id?"#64748b":"#475569","stroke-opacity":l.value.class===t.id?.9:q.value===t.id?.5:.2,"stroke-width":l.value.class===t.id?3:q.value===t.id?2:1.5,fill:"none",class:"transition-all duration-300"},null,8,Pi)],64))),128))]))),128)),l.value.class?(s(),o("rect",{key:0,x:"0",y:"0",width:G,height:G,fill:"#0a0f1a",opacity:"0.85",class:"transition-opacity duration-300 pointer-events-none"})):T("",!0),(s(!0),o(F,null,J(a(h),t=>(s(),o("g",{key:`class-${t.id}`},[e("defs",null,[e("linearGradient",{id:`class-gradient-${t.id}`,gradientTransform:`rotate(${nt(t)}, 0.5, 0.5)`},[e("stop",{offset:"0%","stop-color":he(t.aspects[0])},null,8,Ri),e("stop",{offset:"15%","stop-color":he(t.aspects[0])},null,8,Vi),e("stop",{offset:"85%","stop-color":he(t.aspects[t.aspects.length>1?1:0])},null,8,Di),e("stop",{offset:"100%","stop-color":he(t.aspects[t.aspects.length>1?1:0])},null,8,Yi)],8,Ei),e("clipPath",{id:`hexclip-${t.id}`},[e("polygon",{points:Te(0,0,30)},null,8,Xi)],8,ji)]),e("g",{transform:`translate(${Ve(t).x}, ${Ve(t).y}) scale(${l.value.class===t.id?1.5:1})`,class:te([C(t.id)?"cursor-pointer":"cursor-not-allowed","transition-all duration-300",{"opacity-100":!l.value.class||l.value.class===t.id,"opacity-40":l.value.class&&l.value.class!==t.id}]),style:ue(C(t.id)?"":"filter: grayscale(100%); opacity: 0.35 !important;"),onClick:R=>Bt(t.id),onMouseenter:R=>q.value=t.id,onMouseleave:i[6]||(i[6]=R=>q.value=null)},[e("circle",{cx:"0",cy:"0",r:"30",fill:`url(#class-gradient-${t.id})`,"fill-opacity":l.value.class===t.id?.4:.25,"clip-path":`url(#hexclip-${t.id})`,class:"transition-all duration-300"},null,8,qi),e("polygon",{points:Te(0,0,30),fill:"none",stroke:"#ffffff","stroke-opacity":l.value.class===t.id?.3:.15,"stroke-width":"1",class:"transition-all duration-300"},null,8,zi),(s(),o("foreignObject",{x:l.value.class===t.id?-38:-30,y:l.value.class===t.id?-38:-30,width:l.value.class===t.id?76:60,height:l.value.class===t.id?76:60,class:"pointer-events-none transition-all duration-300"},[e("img",{src:a(Mt)(t.id),style:{width:"100%",height:"100%",opacity:1,transition:"all 0.3s"}},null,8,Oi)],8,Ni))],46,Bi)]))),128)),l.value.class?(s(),o("g",Li,[(s(!0),o(F,null,J(((w=a(h).find(t=>t.id===l.value.class))==null?void 0:w.aspects)||[],t=>(s(),o("g",{key:`highlight-${t}`},[e("circle",{cx:N(t).x,cy:N(t).y,r:"22",fill:"none",stroke:he(t),"stroke-width":"2.5",opacity:"0.9",class:"transition-all duration-300"},null,8,Ui)]))),128))])):T("",!0)])):T("",!0)],10,Ha)],8,Oa))],32),e("div",Wi,[e("div",Fi,[e("div",Hi,[r.value>1?(s(),o("button",{key:0,onClick:Nt,class:"flex items-center gap-2 px-4 py-2 rounded-lg bg-slate-800/50 hover:bg-slate-700 border border-slate-700/50 text-slate-300 transition"},[M(a(D),{icon:"mdi:arrow-left",class:"w-5 h-5"}),i[15]||(i[15]=e("span",{class:"text-sm font-medium"},"Назад",-1))])):(s(),o("div",Gi)),e("button",{onClick:Ze,class:"flex items-center gap-2 px-4 py-2 rounded-lg bg-red-900/20 hover:bg-red-900/30 border border-red-700/50 text-red-300 transition"},[M(a(D),{icon:"mdi:close",class:"w-5 h-5"}),i[16]||(i[16]=e("span",{class:"text-sm font-medium"},"Закрыть",-1))])])]),e("div",Ji,[r.value!==4&&r.value!==5?(s(),o("div",Zi,[e("h2",Ki,u(r.value===1?"Выберите пол":r.value===2?"Выберите расу":r.value===3?"Выберите подрасу":"Выберите навыки"),1),e("p",Qi,u(r.value===1?"Выберите пол персонажа для начала":r.value===2?"Выберите расу, расположенную между двумя аспектами":r.value===3?"Подраса добавляет связь с одним из аспектов":"Выберите навыки персонажа"),1)])):T("",!0),e("div",Ii,[r.value===2&&H.value?(s(),o("div",ec,[e("div",null,[e("h3",tc,u(H.value.name),1),e("p",sc,u(H.value.description),1)]),e("div",null,[i[17]||(i[17]=e("h4",{class:"text-sm font-semibold text-slate-400 mb-2"},"Особенности:",-1)),e("div",lc,[(s(!0),o(F,null,J(H.value.traits,t=>(s(),o("span",{key:t,class:"px-2 py-1 rounded text-xs bg-sky-500/20 text-sky-300"},u(t),1))),128))])])])):T("",!0),r.value===3&&le.value?(s(),o("div",oc,[e("div",null,[e("h3",nc,u(le.value.name),1),e("p",ac,u(le.value.description),1)])])):T("",!0),r.value===4&&l.value.class?(s(),o("div",ic,[a(h).find(t=>t.id===l.value.class)?(s(),o("div",cc,[e("div",rc,[e("div",uc,[e("div",null,[e("h3",dc,u(a(h).find(t=>t.id===l.value.class).name[l.value.gender]),1),e("p",vc,u(a(h).find(t=>t.id===l.value.class).nameEn),1)]),e("img",{src:a(Mt)(l.value.class),alt:a(h).find(t=>t.id===l.value.class).name[l.value.gender],class:"w-full aspect-square object-cover rounded-lg border-2 border-slate-700"},null,8,hc)]),e("div",pc,[M(zl,{stats:K.value.stats,size:360,onSwapStats:i[8]||(i[8]=t=>{var R;return(R=W.value)==null?void 0:R.swapStats()})},null,8,["stats"])])]),e("div",mc,[e("div",fc,[i[19]||(i[19]=Zt('<div class="flex-1 text-sm text-slate-400 leading-relaxed min-w-[280px]" data-v-6ed4564a><p class="font-semibold text-slate-300 mb-2" data-v-6ed4564a>Как рассчитываются бонусы проверок:</p><p class="mb-2" data-v-6ed4564a> Каждая проверка связана с аспектом и имеет соседние аспекты. Бонус проверки равен максимуму из двух формул: </p><ul class="list-disc list-inside space-y-1 ml-2" data-v-6ed4564a><li data-v-6ed4564a><span class="font-mono text-sky-300" data-v-6ed4564a>Основной</span>: полное значение аспекта + половина (округлённая вниз) каждого соседнего</li><li data-v-6ed4564a><span class="font-mono text-purple-300" data-v-6ed4564a>Альтернативный</span>: половина (округлённая вниз) противоположного аспекта</li></ul></div>',1)),e("button",{onClick:i[9]||(i[9]=t=>{var R;return(R=W.value)==null?void 0:R.swapStats()}),class:"flex-shrink-0 flex items-center gap-2 px-4 py-2.5 rounded-lg bg-slate-700/50 hover:bg-slate-700 border border-slate-600/50 text-slate-300 transition"},[M(a(D),{icon:"mdi:swap-horizontal",class:"w-5 h-5"}),i[18]||(i[18]=e("span",{class:"text-sm font-medium"},"Поменять 6 ↔ 4",-1))])])]),(L=a(h).find(t=>t.id===l.value.class))!=null&&L.description?(s(),o("div",gc,[e("p",_c,u(a(h).find(t=>t.id===l.value.class).description),1)])):T("",!0),M(xl,{"class-id":l.value.class,modelValue:K.value,"onUpdate:modelValue":i[10]||(i[10]=t=>K.value=t),ref_key:"statsAndSkillsRef",ref:W,"show-stats":!1,"show-skills":!0},null,8,["class-id","modelValue"])])):T("",!0)])):T("",!0),r.value===5?(s(),o("div",yc,[M(ua,{modelValue:l.value.equipment,"onUpdate:modelValue":i[11]||(i[11]=t=>l.value.equipment=t),onValidationChange:i[12]||(i[12]=t=>se.value=t)},null,8,["modelValue"])])):T("",!0),r.value===6?(s(),o("div",xc,[M(Ba,{name:l.value.name,portrait:l.value.portrait,"onUpdate:name":i[13]||(i[13]=t=>a(m).setName(t)),"onUpdate:portrait":i[14]||(i[14]=t=>a(m).setPortrait(t))},null,8,["name","portrait"])])):T("",!0)])]),e("div",bc,[r.value<Et?(s(),o("button",{key:0,type:"button",class:te(["flex-1 px-4 py-2 rounded-lg font-semibold transition",_e.value?"bg-sky-500/20 border border-sky-400/60 text-sky-100 hover:bg-sky-500/30":"bg-slate-800 border border-slate-700 text-slate-500 cursor-not-allowed"]),disabled:!_e.value,onClick:Qe},u(r.value===2?"Подтвердить расу":r.value===3?"Подтвердить подрасу":r.value===4?"Подтвердить класс":r.value===5?"Подтвердить снаряжение":r.value===6?"Завершить":"Далее"),11,kc)):(s(),o("button",{key:1,type:"button",class:"flex-1 px-4 py-2 rounded-lg bg-emerald-500/20 border border-emerald-400/60 text-emerald-100 font-semibold hover:bg-emerald-500/30 transition",disabled:!_e.value,onClick:Ke}," Создать персонажа ",8,$c))])])])}}},Cc=Pe(wc,[["__scopeId","data-v-6ed4564a"]]),Sc={__name:"CharacterWizard",props:{constraints:{type:Object,default:null},inviteId:{type:String,default:null}},emits:["close","created"],setup(_,{emit:Z}){const y=Z,$=pt(),m=Vt(),r=mt(),l=p=>{const C=p.portrait?ht(p.portrait):Kt(p.name||"Unknown"),P=p.equipment||{},X=P.weapons||[];X.slice(0,2),X.slice(2).map(S=>({id:S,category:"weapon",equipped:!1}));const j=ss(p.stats||{}),Y=m.createFromWizard($.userId,$.nickname,{name:p.name||"Безымянный",portrait:p.portrait,gender:p.gender,race:p.race,subrace:p.subrace,class:p.class,avatar:C,stats:p.stats,skills:p.skills,equipment:{armor:P.armor||"clothes",weapons:X,items:[],wealth:P.wealth||5},combat:{hp:j,maxHp:j,mp:0,maxMp:0}});setTimeout(()=>{r.sendCharactersToMaster()},100),y("created",Y),y("close")},f=()=>{$.closeCharacterWizard(),y("close")};return(p,C)=>(s(),Me(Cc,{constraints:_.constraints,onClose:f,onCreated:l},null,8,["constraints"]))}},Mc={key:0,class:"splash-damage-content"},Ac={class:"damage-icon"},Tc={class:"damage-amount"},Pc={key:0,class:"damage-source"},Ec={key:1,class:"splash-heal-content"},Rc={class:"heal-icon"},Vc={class:"heal-amount"},Dc={key:2,class:"splash-effect-content"},Yc={class:"effect-text"},jc={key:3,class:"splash-notification-content"},Xc={class:"notification-text"},Bc={key:4,class:"splash-image-content"},qc={key:1,class:"image-title"},zc={class:"image-container"},Nc=["src","alt"],Oc={key:2,class:"image-caption"},Lc={key:0,class:"note-title"},Uc={class:"note-text"},Wc={__name:"SplashOverlay",setup(_){const Z=mt(),{currentSplash:y}=Le(Z),$=()=>{var C;((C=y.value)==null?void 0:C.dismissible)!==!1&&Z.dismissSplash()},m=B(()=>{if(!y.value)return"";const C=y.value.splashType,P="splash-overlay";switch(C){case"damage":return`${P} splash-damage`;case"heal":return`${P} splash-heal`;case"effect":return`${P} splash-effect`;case"notification":return`${P} splash-notification`;case"image":return`${P} splash-image`;case"note":return`${P} splash-note`;default:return P}}),r=["💥","⚔️","🔥","⚡","💀"],l=["✨","💚","🌿","💫"],f=B(()=>r[Math.floor(Math.random()*r.length)]),p=B(()=>l[Math.floor(Math.random()*l.length)]);return(C,P)=>(s(),Me(tt,{to:"body"},[M(It,{name:"splash"},{default:Qt(()=>{var X,j,Y,S,ae,V,b,A,x,d;return[a(y)?(s(),o("div",{key:0,class:te(m.value),onClick:$},[a(y).splashType==="damage"?(s(),o("div",Mc,[e("div",Ac,u(f.value),1),e("div",Tc,"-"+u(((X=a(y).content)==null?void 0:X.amount)||"?"),1),(j=a(y).content)!=null&&j.source?(s(),o("div",Pc,u(a(y).content.source),1)):T("",!0)])):a(y).splashType==="heal"?(s(),o("div",Ec,[e("div",Rc,u(p.value),1),e("div",Vc,"+"+u(((Y=a(y).content)==null?void 0:Y.amount)||"?"),1)])):a(y).splashType==="effect"?(s(),o("div",Dc,[e("div",Yc,u(a(y).content),1)])):a(y).splashType==="notification"?(s(),o("div",jc,[e("div",Xc,u(a(y).content),1)])):a(y).splashType==="image"?(s(),o("div",Bc,[a(y).dismissible!==!1?(s(),o("button",{key:0,class:"image-close-btn",onClick:Xe($,["stop"])}," ✕ ")):T("",!0),(S=a(y).content)!=null&&S.title?(s(),o("h2",qc,u(a(y).content.title),1)):T("",!0),e("div",zc,[e("img",{src:(ae=a(y).content)==null?void 0:ae.url,alt:((V=a(y).content)==null?void 0:V.caption)||"",class:"splash-img"},null,8,Nc)]),(b=a(y).content)!=null&&b.caption?(s(),o("p",Oc,u(a(y).content.caption),1)):T("",!0)])):a(y).splashType==="note"?(s(),o("div",{key:5,class:te(["splash-note-content",`note-style-${((A=a(y).content)==null?void 0:A.style)||"parchment"}`])},[e("button",{class:"note-close-btn",onClick:Xe($,["stop"])}," ✕ "),(x=a(y).content)!=null&&x.title?(s(),o("h2",Lc,u(a(y).content.title),1)):T("",!0),e("div",Uc,u((d=a(y).content)==null?void 0:d.text),1)],2)):T("",!0)],2)):T("",!0)]}),_:1})]))}},Fc=Pe(Wc,[["__scopeId","data-v-b1027c6f"]]),Hc={class:"profile-setup-modal"},Gc={class:"form-section"},Jc={class:"form-section"},Zc={class:"icons-grid"},Kc=["onClick","title"],Qc={class:"icon-emoji"},Ic={key:0,class:"taken-badge"},er={class:"form-section"},tr={class:"colors-grid"},sr=["onClick","title"],lr={key:0,class:"taken-x"},or={key:0,class:"preview-section"},nr={class:"preview-emoji"},ar={class:"preview-name"},ir={class:"modal-actions"},cr=["disabled"],rr={__name:"PlayerProfileSetup",props:{takenIcons:{type:Array,default:()=>[]}},emits:["complete","cancel"],setup(_,{emit:Z}){const y=_,$=Z,m=pt(),{nickname:r,playerIcon:l,playerColor:f}=Le(m),p=O(r.value||""),C=O(l.value||null),P=O(f.value||null);Se(()=>r.value,E=>{!p.value&&E&&(p.value=E)},{immediate:!0});const X=B(()=>At.icons),j=B(()=>At.colors),Y=(E,U)=>y.takenIcons.some(k=>k.iconId===E&&k.colorId===U),S=(E,U)=>{const k=y.takenIcons.find(v=>v.iconId===E&&v.colorId===U);return(k==null?void 0:k.playerName)||null},ae=B(()=>X.value.find(E=>E.id===C.value)),V=B(()=>j.value.find(E=>E.id===P.value)),b=B(()=>!(!p.value.trim()||!C.value||!P.value||Y(C.value,P.value))),A=E=>{C.value=E},x=E=>{C.value&&Y(C.value,E)||(P.value=E)},d=()=>{b.value&&(m.setFullProfile({nickname:p.value.trim(),playerIcon:C.value,playerColor:P.value}),$("complete",{nickname:p.value.trim(),iconId:C.value,colorId:P.value}))},q=()=>{$("cancel")};return(E,U)=>(s(),o("div",{class:"profile-setup-overlay",onClick:Xe(q,["self"])},[e("div",Hc,[U[5]||(U[5]=e("div",{class:"modal-header"},[e("h2",{class:"modal-title"},"Настройка профиля"),e("p",{class:"modal-subtitle"},"Выберите имя, иконку и цвет для игры")],-1)),e("div",Gc,[U[1]||(U[1]=e("label",{class:"section-label"},"Ваше имя",-1)),st(e("input",{"onUpdate:modelValue":U[0]||(U[0]=k=>p.value=k),type:"text",placeholder:"Введите имя...",class:"name-input",maxlength:"20"},null,512),[[lt,p.value]])]),e("div",Jc,[U[2]||(U[2]=e("label",{class:"section-label"},"Выберите фигурку",-1)),e("div",Zc,[(s(!0),o(F,null,J(X.value,k=>{var v;return s(),o("button",{key:k.id,class:te(["icon-option",{selected:C.value===k.id,taken:P.value&&Y(k.id,P.value)}]),onClick:g=>A(k.id),title:k.name},[e("span",Qc,u(k.emoji),1),P.value&&Y(k.id,P.value)?(s(),o("span",Ic,u(((v=S(k.id,P.value))==null?void 0:v.slice(0,1))||"?"),1)):T("",!0)],10,Kc)}),128))])]),e("div",er,[U[3]||(U[3]=e("label",{class:"section-label"},"Выберите цвет",-1)),e("div",tr,[(s(!0),o(F,null,J(j.value,k=>(s(),o("button",{key:k.id,class:te(["color-option",{selected:P.value===k.id,taken:C.value&&Y(C.value,k.id)}]),style:ue({backgroundColor:k.value}),onClick:v=>x(k.id),title:C.value&&Y(C.value,k.id)?`Занято: ${S(C.value,k.id)}`:k.name},[C.value&&Y(C.value,k.id)?(s(),o("span",lr,"✕")):T("",!0)],14,sr))),128))])]),ae.value&&V.value?(s(),o("div",or,[U[4]||(U[4]=e("div",{class:"preview-label"},"Ваша фигурка:",-1)),e("div",{class:"preview-icon",style:ue({color:V.value.value})},[e("span",nr,u(ae.value.emoji),1),e("span",ar,u(p.value||"Игрок"),1)],4)])):T("",!0),e("div",ir,[e("button",{type:"button",class:"btn-cancel",onClick:q}," Отмена "),e("button",{type:"button",class:"btn-save",disabled:!b.value,onClick:d}," Начать игру ",8,cr)])])]))}},ur=Pe(rr,[["__scopeId","data-v-923476e7"]]),dr={class:"h-screen bg-slate-950 text-slate-50 flex flex-col overflow-hidden"},vr={key:0,class:"flex-1 flex items-center justify-center"},hr={key:1,class:"flex-1 flex items-center justify-center"},pr={class:"text-center"},mr={class:"text-rose-400 mb-4"},fr={key:0,class:"character-creator-modal"},gr={__name:"PlayerRoom",setup(_){const Z=es(),y=ts(),$=mt(),m=pt(),r=Vt(),l=ls(),f=os(),{roomId:p,status:C,connections:P}=Le($);Le(m);const{characters:X}=Le(r);B(()=>C.value==="in-room"||C.value==="ready"),B(()=>C.value==="connecting"?"Подключение...":C.value==="in-room"?"● Подключено":C.value==="error"?"○ Ошибка":"○ Отключено"),B(()=>C.value==="in-room"?"bg-emerald-500/20 text-emerald-400":C.value==="connecting"?"bg-amber-500/20 text-amber-400":"bg-rose-500/20 text-rose-400");const j=O("battle-map"),Y=O(!0),S=O(""),ae=O(Tt()),V=O(null),b=O(!1),A=B(()=>($.allPlayers||[]).filter(z=>z.id!==m.userId&&z.playerIcon&&z.playerColor).map(z=>({iconId:z.playerIcon,colorId:z.playerColor,playerName:z.name||"Игрок"}))),x=O(!1),d=O(null),q=O(null),E=O(null),U=O(null),k=B(()=>{if(!g.value)return 0;const c=l.activeMapId;if(!c)return 0;const z=l.findTokenPosition(c,g.value.id);return(z==null?void 0:z.facing)||0}),v=B(()=>{if(!g.value)return null;const c=l.activeMapId;return c?l.findTokenPosition(c,g.value.id):null}),g=B(()=>{const c=m.userId;console.log("Поиск персонажа игрока:",{userId:c,characters:X.value.length});const z=X.value.find(oe=>oe.ownerId===c);return console.log("Найденный персонаж:",z),z}),W=O(null),K=B(()=>!0);Rt(async()=>{const c=Z.params.roomId;if(!c){y.push("/");return}ae.value&&as(),m.isProfileComplete||(b.value=!0);try{$.joinRoom(c),Y.value=!1,ct()}catch{S.value="Не удалось подключиться к комнате",Y.value=!1}const z=()=>{ae.value=Tt()};window.addEventListener("resize",z),Ct(()=>{window.removeEventListener("resize",z)})}),Ct(()=>{$.leaveRoom()});const se=c=>{j.value=c},ie=()=>{$.leaveRoom(),y.push("/")},fe=c=>{b.value=!1},be=()=>{b.value=!1},h=c=>{V.value={id:c.id,title:c.label,description:_e(c.id),icon:c.icon,canConfirm:!1}},H=()=>{V.value&&V.value.target&&(console.log("Выполняем действие:",V.value.id,"цель:",V.value.target),V.value.id==="move"&&V.value.target.type==="hex"?le(V.value.target.hex):V.value.id==="attack"&&V.value.target.characterId&&ne(V.value.target),V.value=null)},le=(c,z=null)=>{var Ke;const oe=g.value;if(!oe){console.warn("Персонаж игрока не найден");return}console.log(`Перемещаем персонажа ${oe.name} на гекс q:${c.q}, r:${c.r}, facing:${z}`);const ce=l.activeMapId;if(!ce){console.warn("Нет активной карты для перемещения");return}if(console.log("Активная карта:",ce),!l.moveTokenByCharacterId(ce,oe.id,c.q,c.r))console.log("Токен не найден на карте, размещаем впервые"),l.placeToken(ce,oe.id,c.q,c.r,z||0)?console.log("Токен успешно размещен на карте"):console.warn("Не удалось разместить токен на карте. Возможно гекс занят.");else if(console.log("Токен перемещен на существующей карте"),z!==null){const Ee=l.findTokenPosition(ce,oe.id);Ee&&l.rotateToken(ce,Ee.q,Ee.r,z)}(Ke=oe.combat)!=null&&Ke.position?r.moveOnMap(oe.id,c.q,c.r):r.placeOnMap(oe.id,ce,c.q,c.r);const Ze=$.role==="player"&&$.status==="in-room";console.log("Проверка сессии для отправки:",{role:$.role,status:$.status,isConnectedToMaster:Ze}),Ze&&(console.log("Отправляем перемещение мастеру..."),$.broadcastCharacterMove(oe.id,c.q,c.r,z))},ne=c=>{console.log("Атакуем цель:",c.characterId)},pe=c=>{var z;V.value&&(V.value.target=c,V.value.canConfirm=!0,c.type==="hex"?V.value.description=`Переместиться на гекс (${c.hex.q}, ${c.hex.r})`:c.characterId&&(V.value.description=`Цель: ${((z=c.character)==null?void 0:z.name)||"Неизвестный"}`))},ge=()=>{V.value=null},_e=c=>({move:"Выберите место для перемещения",attack:"Выберите цель для атаки",defend:"Выберите сектор защиты",skill:"Выберите навык и цель",ready:"Сигнализировать о готовности",help:"Показать справку"})[c]||"Выберите действие",N=c=>{q.value=c,c&&(E.value=null)},Ae=c=>{E.value=c},he=c=>{c&&(console.log("Перемещение на гекс из инфокарточки:",c),le(c),E.value=null)},Ue=c=>{c&&K.value&&(console.log("Двойной тап по гексу - перемещение:",c),le(c),E.value=null)},We=c=>{c!=null&&c.hex&&K.value&&(console.log("Long press move - перемещение с выбором направления:",c),le(c.hex,c.facing))},Fe=c=>{if(!(c!=null&&c.hex)||!K.value)return;console.log("Long press confirm - финальное направление:",c);const z=g.value;if(!z)return;const oe=l.activeMapId;if(!oe)return;const ce=l.findTokenPosition(oe,z.id);ce&&(l.rotateToken(oe,ce.q,ce.r,c.facing),console.log(`Направление персонажа обновлено на ${c.facing}`),$.role==="player"&&$.status==="in-room"&&$.broadcastCharacterMove(z.id,ce.q,ce.r,c.facing)),E.value=null},Te=c=>{if(!c||!K.value)return;console.log("Token rotate - поворот на месте:",c);const z=g.value;if(!z)return;const oe=l.activeMapId;if(!oe)return;const ce=l.findTokenPosition(oe,z.id);ce&&(l.rotateToken(oe,ce.q,ce.r,c.facing),console.log(`Направление персонажа обновлено на ${c.facing}`),$.role==="player"&&$.status==="in-room"&&$.broadcastCharacterMove(z.id,ce.q,ce.r,c.facing))},He=()=>{console.log("Смена снаряжения")},nt=c=>{c&&r.setActiveCharacter(c),se("character-sheet")},Ve=c=>{console.log("Игрок принял реакцию:",c),$.status==="in-room"&&$.sendReactionResponse(c,!0),U.value=null},Ge=c=>{console.log("Игрок отклонил реакцию:",c),$.status==="in-room"&&$.sendReactionResponse(c,!1),U.value=null},at=c=>{d.value=c||null,x.value=!0},Je=()=>{x.value=!1,d.value=null},it=c=>{var z;if(console.log("Персонаж создан:",c),(z=d.value)!=null&&z.inviteId&&c){const oe=d.value.inviteId;f.markInviteUsed(oe,{userId:m.userId,characterId:c.id,characterName:c.name,characterPortrait:c.portrait}),$.sendInviteUsed(oe,{userId:m.userId,characterId:c.id,characterName:c.name,characterPortrait:c.portrait})}Je()},ct=()=>{$.onMessage("reaction-prompt",c=>{console.log("Получено предложение реакции:",c),U.value={id:c.id,title:c.title||"Реакция!",description:c.description||"Можете использовать реакцию",timeoutSeconds:c.timeoutSeconds||5,startedAt:Date.now()}}),$.onMessage("scene-event",c=>{console.log("Получено событие сцены:",c),c.event&&f.handleIncomingEvent(c.event)}),$.onMessage("scene-sync",c=>{var z;console.log("Получена синхронизация событий сцены:",((z=c.events)==null?void 0:z.length)||0,"событий"),c.events&&Array.isArray(c.events)&&f.syncEvents(c.events),c.currentImage&&f.setSceneImage(c.currentImage.url,c.currentImage.description,c.currentImage.sentBy)}),$.onMessage("scene-event-hide",c=>{console.log("Мастер скрыл событие:",c.eventId),c.eventId&&f.removeEvent(c.eventId)})};return(c,z)=>{var oe,ce;return s(),o("div",dr,[Y.value?(s(),o("div",vr,[...z[1]||(z[1]=[e("div",{class:"text-center"},[e("div",{class:"animate-spin text-4xl mb-4"},"⏳"),e("p",{class:"text-slate-400"},"Подключение к комнате...")],-1)])])):S.value?(s(),o("div",hr,[e("div",pr,[z[2]||(z[2]=e("div",{class:"text-4xl mb-4"},"😔",-1)),e("p",mr,u(S.value),1),e("button",{type:"button",class:"px-4 py-2 bg-sky-500 text-white rounded-lg hover:bg-sky-600 transition",onClick:z[0]||(z[0]=Be=>a(y).push("/"))}," Вернуться ")])])):(s(),o(F,{key:2},[M(is,{character:g.value,characters:a(X),"selected-token":q.value,"selected-hex":E.value,"player-facing":k.value,"player-token-position":v.value,"is-master":!1,"connection-status":a(C),"current-turn":W.value,"is-player-turn":K.value,"pending-action":V.value,"reaction-prompt":U.value,onSetView:se,onLeaveRoom:ie,onSelectAction:h,onConfirmAction:H,onCancelAction:ge,onSwitchEquipment:He,onReactionAccept:Ve,onReactionDecline:Ge,onOpenCharacterSheet:nt,onMoveToHex:he,onTokenSelected:N,onHexSelected:Ae,onHexDoubleTap:Ue,onHexLongPressMove:We,onHexLongPressConfirm:Fe,onTokenRotate:Te,onActionTargetSelected:pe,onCreateCharacter:at},null,8,["character","characters","selected-token","selected-hex","player-facing","player-token-position","connection-status","current-turn","is-player-turn","pending-action","reaction-prompt"]),(s(),Me(tt,{to:"body"},[x.value?(s(),o("div",fr,[M(Sc,{constraints:(oe=d.value)==null?void 0:oe.constraints,"invite-id":(ce=d.value)==null?void 0:ce.inviteId,onClose:Je,onCreated:it},null,8,["constraints","invite-id"])])):T("",!0)])),(s(),Me(tt,{to:"body"},[b.value?(s(),Me(ur,{key:0,"taken-icons":A.value,onComplete:fe,onCancel:be},null,8,["taken-icons"])):T("",!0)]))],64)),M(Fc)])}}},Cr=Pe(gr,[["__scopeId","data-v-d1ed31c7"]]);export{Cr as default};
