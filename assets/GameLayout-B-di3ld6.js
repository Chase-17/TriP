import{q as Xn,r as R,l as ne,s as jt,b as s,c as n,d as e,F as ee,y as me,n as Q,t as h,f as i,h as _,g as De,v as je,G as ks,w as lt,z as Qe,H as la,I as oa,o as rs,x as Gt,E as ln,J as $l,K as fs,m as st,e as A,i as ys,k as Ce,T as Ps,p as Vt,j as on,L as Kt,M as Zt,N as aa,O as hn,P as On}from"./index-gQaYO5ct.js";import{p as _l,h as is,f as co,F as _t,C as Ot,g as Us,i as ia,e as wn,u as cs,b as xs,a as ws,j as ra,S as Bt,k as qt,l as os,m as $s,M as _s,H as ca,n as da,T as Xs,L as Fs,o as ua,q as ma,d as Zn,r as tt,s as Zs}from"./fillProfile-BtIfjwhZ.js";import{usePointerStore as Cn,POINTER_TOOLS as mt,POINTER_COLORS as hs}from"./pointer-D6QFUiDV.js";import{s as St,a as Ut,_ as Os}from"./safeStoreRefs-BFQqCsTa.js";const va=[{id:"plains",name:"Равнина",color:"#8BC34A"},{id:"forest",name:"Лес",color:"#2E7D32"},{id:"desert",name:"Пустыня",color:"#FDD835"},{id:"swamp",name:"Болото",color:"#5D4037"},{id:"mountain",name:"Горы",color:"#78909C"},{id:"water",name:"Вода",color:"#1E88E5"},{id:"snow",name:"Снег",color:"#ECEFF1"},{id:"volcanic",name:"Вулкан",color:"#BF360C"},{id:"urban",name:"Город",color:"#616161"},{id:"underground",name:"Подземелье",color:"#37474F"}],fa=[{id:"open",name:"Открытая",description:"Полностью просматривается",value:0},{id:"partial",name:"Частичная",description:"Маскирует (высокая трава, кусты)",value:1},{id:"blocking",name:"Блокирующая",description:"Блокирует обзор (стена, скала)",value:2}],Aa=[{id:"open",name:"Свободно",description:"Проходимо без ограничений"},{id:"difficult",name:"Труднопроходимо",description:"Замедляет движение, но проходимо"},{id:"liquid",name:"Жидкость",description:"Требует плавания или полёта",requiredAbility:"swimming"},{id:"solid",name:"Твёрдое",description:"Непроходимо без особых способностей",requiredAbility:"phasing"},{id:"void",name:"Пустота",description:"Абсолютно непроходимо"}],pa=[{id:"grass",name:"Трава",description:"Обычный луг",biome:"plains",color:"#4CAF50",image:null,visibility:"open",passability:"open",movementCost:1,meleeAdvantage:0,tags:["природа","базовый"]},{id:"tall_grass",name:"Высокая трава",description:"Высокая трава, скрывающая присевших",biome:"plains",color:"#7CB342",image:null,visibility:"partial",passability:"open",movementCost:1,meleeAdvantage:0,tags:["природа","укрытие"]},{id:"forest_light",name:"Редколесье",description:"Редкие деревья и кустарники",biome:"forest",color:"#66BB6A",image:null,visibility:"partial",passability:"difficult",movementCost:2,meleeAdvantage:0,tags:["природа","лес","укрытие"]},{id:"forest_dense",name:"Густой лес",description:"Плотный лес с густым подлеском",biome:"forest",color:"#2E7D32",image:null,visibility:"blocking",passability:"difficult",movementCost:3,meleeAdvantage:-1,tags:["природа","лес","труднопроходимый"]},{id:"sand",name:"Песок",description:"Рыхлый песок",biome:"desert",color:"#FFD54F",image:null,visibility:"open",passability:"difficult",movementCost:2,meleeAdvantage:-1,tags:["природа","пустыня"]},{id:"dunes",name:"Дюны",description:"Песчаные холмы",biome:"desert",color:"#FFC107",image:null,visibility:"partial",passability:"difficult",movementCost:3,meleeAdvantage:1,tags:["природа","пустыня","возвышенность"]},{id:"shallow_water",name:"Мелководье",description:"Неглубокая вода по колено",biome:"water",color:"#4FC3F7",image:null,visibility:"open",passability:"difficult",movementCost:2,meleeAdvantage:-1,tags:["вода"]},{id:"deep_water",name:"Глубокая вода",description:"Глубокая вода, нужно плыть",biome:"water",color:"#1565C0",image:null,visibility:"open",passability:"liquid",movementCost:4,meleeAdvantage:-2,tags:["вода","опасность"]},{id:"swamp",name:"Болото",description:"Топкое болото",biome:"swamp",color:"#6D4C41",image:null,visibility:"partial",passability:"difficult",movementCost:3,meleeAdvantage:-1,tags:["природа","болото","опасность"]},{id:"rocks",name:"Камни",description:"Каменистая местность",biome:"mountain",color:"#90A4AE",image:null,visibility:"partial",passability:"difficult",movementCost:2,meleeAdvantage:0,tags:["природа","горы"]},{id:"cliff",name:"Утёс",description:"Крутой обрыв или возвышенность",biome:"mountain",color:"#607D8B",image:null,visibility:"blocking",passability:"solid",movementCost:1,meleeAdvantage:2,tags:["природа","горы","возвышенность"]},{id:"snow",name:"Снег",description:"Заснеженная местность",biome:"snow",color:"#ECEFF1",image:null,visibility:"open",passability:"difficult",movementCost:2,meleeAdvantage:-1,tags:["природа","холод"]},{id:"ice",name:"Лёд",description:"Скользкий лёд",biome:"snow",color:"#B3E5FC",image:null,visibility:"open",passability:"open",movementCost:1,meleeAdvantage:-2,tags:["природа","холод","опасность"]},{id:"lava",name:"Лава",description:"Раскалённая лава",biome:"volcanic",color:"#FF5722",image:null,visibility:"open",passability:"liquid",movementCost:4,meleeAdvantage:-2,tags:["опасность","огонь"]},{id:"volcanic_rock",name:"Вулканический камень",description:"Застывшая лава",biome:"volcanic",color:"#3E2723",image:null,visibility:"open",passability:"difficult",movementCost:2,meleeAdvantage:0,tags:["природа","горы"]},{id:"road_dirt",name:"Грунтовая дорога",description:"Утоптанная тропа",biome:"plains",color:"#A1887F",image:null,visibility:"open",passability:"open",movementCost:1,meleeAdvantage:0,tags:["дорога"]},{id:"road_stone",name:"Каменная дорога",description:"Мощёная дорога",biome:"urban",color:"#9E9E9E",image:null,visibility:"open",passability:"open",movementCost:1,meleeAdvantage:0,tags:["дорога","город"]},{id:"floor_wood",name:"Деревянный пол",description:"Деревянный настил",biome:"urban",color:"#8D6E63",image:null,visibility:"open",passability:"open",movementCost:1,meleeAdvantage:0,tags:["город","здание"]},{id:"floor_stone",name:"Каменный пол",description:"Каменные плиты",biome:"urban",color:"#757575",image:null,visibility:"open",passability:"open",movementCost:1,meleeAdvantage:0,tags:["город","здание"]},{id:"wall",name:"Стена",description:"Непроходимая стена",biome:"urban",color:"#424242",image:null,visibility:"blocking",passability:"solid",movementCost:1,meleeAdvantage:0,tags:["город","здание","преграда"]},{id:"dungeon_floor",name:"Пол подземелья",description:"Холодный каменный пол",biome:"underground",color:"#455A64",image:null,visibility:"open",passability:"open",movementCost:1,meleeAdvantage:0,tags:["подземелье"]},{id:"dungeon_wall",name:"Стена подземелья",description:"Массивная каменная стена",biome:"underground",color:"#263238",image:null,visibility:"blocking",passability:"solid",movementCost:1,meleeAdvantage:0,tags:["подземелье","преграда"]},{id:"void",name:"Пустота",description:"Пустое пространство",biome:"underground",color:"#0D1117",image:null,visibility:"blocking",passability:"void",movementCost:1,meleeAdvantage:0,tags:["специальный"]}],Mn={biomes:va,visibility:fa,passability:Aa,terrains:pa},an=Xn("terrain",()=>{const t=R(Mn.terrains),l=R([]),o=R(Mn.biomes),a=R(Mn.visibility),r=R(new Map),c=R({search:"",biome:null,visibility:null,movementCostMin:1,movementCostMax:5,meleeAdvantageMin:-2,meleeAdvantageMax:2,tags:[]}),f=ne(()=>[...t.value,...l.value]),k=ne(()=>{const U=new Set;return f.value.forEach(D=>{var b;(b=D.tags)==null||b.forEach(d=>U.add(d))}),Array.from(U).sort()}),w=ne(()=>f.value.filter(U=>{var D;if(c.value.search){const b=c.value.search.toLowerCase(),d=U.name.toLowerCase().includes(b),oe=(D=U.description)==null?void 0:D.toLowerCase().includes(b);if(!d&&!oe)return!1}if(c.value.biome&&U.biome!==c.value.biome||c.value.visibility&&U.visibility!==c.value.visibility||U.movementCost<c.value.movementCostMin||U.movementCost>c.value.movementCostMax||U.meleeAdvantage<c.value.meleeAdvantageMin||U.meleeAdvantage>c.value.meleeAdvantageMax)return!1;if(c.value.tags.length>0){const b=new Set(U.tags||[]);if(!c.value.tags.every(oe=>b.has(oe)))return!1}return!0})),x=ne(()=>{const U={};return o.value.forEach(D=>{U[D.id]={biome:D,terrains:w.value.filter(b=>b.biome===D.id)}}),U});function T(U){return f.value.find(D=>D.id===U)||null}function y(U={}){const{biome:D=null,visibility:b=null,passabilityMin:d=0,passabilityMax:oe=5,meleeAdvantageMin:he=-2,meleeAdvantageMax:M=2,search:de="",tags:H=[]}=U;return f.value.filter(z=>{var C;if(de){const L=de.toLowerCase(),$e=z.name.toLowerCase().includes(L),Ae=(C=z.description)==null?void 0:C.toLowerCase().includes(L);if(!$e&&!Ae)return!1}if(D&&z.biome!==D||b&&z.visibility!==b)return!1;const q=z.movementCost??1;if(q<d||q>oe)return!1;const Ie=z.meleeAdvantage??0;if(Ie<he||Ie>M)return!1;if(H.length>0){const L=new Set(z.tags||[]);if(!H.every($e=>L.has($e)))return!1}return!0})}function B(U){return o.value.find(D=>D.id===U)||null}function m(U){const D=T(U);if(!D)return"#888888";if(D.color)return D.color;const b=B(D.biome);return(b==null?void 0:b.color)||"#888888"}function Y(U){const D=T(U);return(D==null?void 0:D.image)||null}async function j(U){return r.value.has(U)?r.value.get(U):new Promise((D,b)=>{const d=new Image;d.onload=()=>{r.value.set(U,d),D(d)},d.onerror=b,d.src=U})}function F(U){const b={id:`custom_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,name:U.name||"Новый террейн",description:U.description||"",biome:U.biome||"plains",color:U.color||"#888888",image:U.image||null,visibility:U.visibility||"open",movementCost:Math.max(1,Math.min(5,U.movementCost||1)),meleeAdvantage:Math.max(-2,Math.min(2,U.meleeAdvantage||0)),tags:U.tags||[],isCustom:!0,createdAt:Date.now()};return l.value.push(b),b}function ie(U,D){const b=l.value.findIndex(d=>d.id===U);return b===-1?!1:(l.value[b]={...l.value[b],...D,updatedAt:Date.now()},!0)}function W(U){const D=l.value.findIndex(b=>b.id===U);return D===-1?!1:(l.value.splice(D,1),!0)}function S(U){c.value={...c.value,...U}}function Z(){c.value={search:"",biome:null,visibility:null,movementCostMin:1,movementCostMax:5,meleeAdvantageMin:-2,meleeAdvantageMax:2,tags:[]}}function K(){return JSON.stringify(l.value,null,2)}function X(U){try{const D=JSON.parse(U);if(!Array.isArray(D))throw new Error("Invalid format");return D.forEach(b=>{F(b)}),!0}catch(D){return console.error("Failed to import terrains:",D),!1}}return{baseTerrains:t,customTerrains:l,biomes:o,visibilityTypes:a,imageCache:r,filters:c,allTerrains:f,allTags:k,filteredTerrains:w,terrainsByBiome:x,getTerrainById:T,getFilteredTerrains:y,getBiomeById:B,getTerrainColor:m,getTerrainImage:Y,loadImage:j,addCustomTerrain:F,updateCustomTerrain:ie,removeCustomTerrain:W,setFilters:S,resetFilters:Z,exportCustomTerrains:K,importCustomTerrains:X}},{persist:{key:"trip-terrains",paths:["customTerrains"]}});class ha{constructor(l=null){this.seed=l??Date.now(),this.current=this.seed}next(){return this.current=this.current*1103515245+12345&2147483647,this.current/2147483647}nextInt(l,o){return Math.floor(this.next()*(o-l+1))+l}shuffle(l){const o=[...l];for(let a=o.length-1;a>0;a--){const r=this.nextInt(0,a);[o[a],o[r]]=[o[r],o[a]]}return o}}function Tl(t,l){return co.map(o=>({q:t+o.q,r:l+o.r}))}function ga(t,l,o){if(!t||t.type===_t.NONE)return!0;const{type:a,operator:r,value:c,minValue:f,maxValue:k}=t;let w;switch(a){case _t.TERRAIN_ID:w=l==null?void 0:l.id;break;case _t.TERRAIN_BIOME:w=l==null?void 0:l.biome;break;case _t.VISIBILITY:w=l==null?void 0:l.visibility;break;case _t.MOVEMENT_COST:w=(l==null?void 0:l.movementCost)??1;break;case _t.MELEE_ADVANTAGE:w=(l==null?void 0:l.meleeAdvantage)??0;break;case _t.TAG:w=(l==null?void 0:l.tags)||[];break;case _t.RANDOM:return!0;default:return!0}switch(r){case Ot.EQUALS:return w===c;case Ot.NOT_EQUALS:return w!==c;case Ot.GREATER:return w>c;case Ot.GREATER_EQUALS:return w>=c;case Ot.LESS:return w<c;case Ot.LESS_EQUALS:return w<=c;case Ot.CONTAINS:return Array.isArray(w)?w.includes(c):String(w).includes(String(c));default:return!0}}function ya(t,l,o){return!t.conditions||t.conditions.length===0?!0:t.conditions.every(a=>ga(a,l))}function ba(t,l,o,a,r=!1){if(t.length===0)return new Set;const c=new Set;if(r){const B=l/100;if(o<=10)for(const m of t)a.next()<B&&c.add(m);else{const m=o/100,Y=new Set(t),j=a.shuffle([...t]);for(const F of j){if(!Y.has(F))continue;const ie=B*(1-m*.5);if(a.next()<ie){c.add(F),Y.delete(F);const W=Math.max(1,Math.round(1/(1-m*.8)));let S=0;const Z=[F];for(;Z.length>0&&S<W;){const K=Z.shift(),{q:X,r:U}=_l(K),D=a.shuffle(Tl(X,U));for(const b of D){const d=is(b.q,b.r);if(Y.has(d)&&a.next()<m&&(c.add(d),Y.delete(d),Z.push(d),S++,S>=W))break}}}}}return c}const f=Math.round(t.length*(l/100));if(f===0)return new Set;const k=new Set(t),w=o/100,x=Math.max(1,Math.round(f*(1-w*.8))),T=a.shuffle([...k]);for(T.slice(0,Math.min(x,T.length)).forEach(B=>{c.add(B),k.delete(B)});c.size<f&&k.size>0;)if(a.next()<w){const m=[...c],Y=a.shuffle(m);let j=!1;for(const F of Y){const{q:ie,r:W}=_l(F),S=Tl(ie,W),Z=a.shuffle(S);for(const K of Z){const X=is(K.q,K.r);if(k.has(X)){c.add(X),k.delete(X),j=!0;break}}if(j)break}if(!j&&k.size>0){const F=a.shuffle([...k])[0];c.add(F),k.delete(F)}}else{const m=a.shuffle([...k])[0];c.add(m),k.delete(m)}return c}function Hn(t,l,o,a={}){const{previewOnly:r=!1,customSeed:c=null,probabilistic:f=!1}=a;if(!t||!l||l.length===0)return new Map;const k=c??t.seed??Date.now(),w=new ha(k),x=new Map;if(t.baseTerrain)for(const y of l)x.set(y,t.baseTerrain);const T=[...t.layers||[]].filter(y=>y.enabled&&y.terrainId).sort((y,B)=>y.priority-B.priority);for(const y of T){const B=[];for(const Y of l){const j=x.get(Y),F=o.getTerrainById(j);ya(y,F)&&B.push(Y)}const m=ba(B,y.density,y.clustering,w,f);for(const Y of m)x.set(Y,y.terrainId)}return x}function ka(t,l){const o={total:t.size,byTerrain:{}};return t.forEach((a,r)=>{if(!o.byTerrain[a]){const c=l.getTerrainById(a);o.byTerrain[a]={id:a,name:(c==null?void 0:c.name)||a,count:0,percent:0}}o.byTerrain[a].count++}),Object.values(o.byTerrain).forEach(a=>{a.percent=Math.round(a.count/o.total*100)}),o}function xa(t,l,o,a=null){return Hn(t,l,o,{previewOnly:!0,customSeed:a??Date.now()})}const Is={OPEN:"open",DIFFICULT:"difficult",LIQUID:"liquid",SOLID:"solid",VOID:"void"};function wa(t,l={}){switch(l=l||{},t){case Is.OPEN:case Is.DIFFICULT:return!0;case Is.LIQUID:return!!(l.flight||l.swimming);case Is.SOLID:return!!l.phasing;case Is.VOID:return!1;default:return!0}}function qn(t,l={}){if(!t)return 1;if(l=l||{},t.passable!==void 0){if(!t.passable)return 1/0;let k=t.movementCost??1;return l.injured&&(k*=l.injured),l.exhausted&&(k*=l.exhausted),l.heavyLoad&&(k*=l.heavyLoad),l.costMultiplier&&(k*=l.costMultiplier),Math.max(.5,k)}const o=t.terrain||t,a=o.passability||Is.OPEN;if(!wa(a,l))return 1/0;let c=t.movementCost??o.movementCost??1;l.flight&&a===Is.DIFFICULT&&(c=1);const f=o.biome||t.biome;return f==="forest"&&l.forestKnowledge&&(c=Math.max(1,c*l.forestKnowledge)),f==="swamp"&&l.swampWalker&&(c=Math.max(1,c*l.swampWalker)),f==="mountain"&&l.climbing&&(c=Math.max(1,c*l.climbing)),l.injured&&(c*=l.injured),l.exhausted&&(c*=l.exhausted),l.heavyLoad&&(c*=l.heavyLoad),l.costMultiplier&&(c*=l.costMultiplier),Math.max(.5,c)}function uo(t,l){return co.map(o=>({q:t+o.q,r:l+o.r}))}function Il(t,l,o,a){return(Math.abs(t-o)+Math.abs(t+l-o-a)+Math.abs(l-a))/2}class mo{constructor(){this.items=[]}enqueue(l,o){this.items.push({item:l,priority:o}),this.bubbleUp(this.items.length-1)}dequeue(){if(this.items.length===0)return null;const l=this.items[0],o=this.items.pop();return this.items.length>0&&(this.items[0]=o,this.bubbleDown(0)),l.item}bubbleUp(l){for(;l>0;){const o=Math.floor((l-1)/2);if(this.items[o].priority<=this.items[l].priority)break;[this.items[o],this.items[l]]=[this.items[l],this.items[o]],l=o}}bubbleDown(l){for(;;){const o=2*l+1,a=2*l+2;let r=l;if(o<this.items.length&&this.items[o].priority<this.items[r].priority&&(r=o),a<this.items.length&&this.items[a].priority<this.items[r].priority&&(r=a),r===l)break;[this.items[l],this.items[r]]=[this.items[r],this.items[l]],l=r}}isEmpty(){return this.items.length===0}has(l){return this.items.some(o=>o.item.key===l)}}function Jn(t,l,o,a={}){const{modifiers:r={},blockedHexes:c=new Set,maxCost:f=100,maxIterations:k=1e4}=a||{},w=r||{},x=is(t.q,t.r),T=is(l.q,l.r);if(x===T)return{path:[{...t,cost:0}],totalCost:0,found:!0};const y=o(l.q,l.r);if(qn(y,w)===1/0)return{path:[],totalCost:1/0,found:!1};const m=new mo,Y=new Map,j=new Map,F=new Map;j.set(x,0),F.set(x,Il(t.q,t.r,l.q,l.r)),m.enqueue({...t,key:x},F.get(x));let ie=0;for(;!m.isEmpty()&&ie<k;){ie++;const W=m.dequeue(),S=W.key;if(S===T)return Ca(Y,W,j);const Z=j.get(S);if(Z>f)continue;const K=uo(W.q,W.r);for(const X of K){const U=is(X.q,X.r);if(c.has(U)&&U!==T)continue;const D=o(X.q,X.r),b=qn(D,w);if(b===1/0)continue;const d=Z+b;if(d>f)continue;const oe=j.get(U);if(oe===void 0||d<oe){Y.set(U,W),j.set(U,d);const he=Il(X.q,X.r,l.q,l.r),M=d+he;F.set(U,M),m.enqueue({...X,key:U},M)}}}return{path:[],totalCost:1/0,found:!1}}function Ca(t,l,o){const a=[];let r=l;for(;r;){const c=o.get(r.key)||0;a.unshift({q:r.q,r:r.r,cost:c}),r=t.get(r.key)}return{path:a,totalCost:o.get(l.key)||0,found:!0}}function Sl(t,l,o,a={}){const{modifiers:r={},blockedHexes:c=new Set,maxIterations:f=5e3}=a||{},k=r||{},w=is(t.q,t.r),x=new Map,T=new Set,y=new mo;x.set(w,{q:t.q,r:t.r,cost:0}),y.enqueue({q:t.q,r:t.r,cost:0,key:w},0);let B=0;for(;!y.isEmpty()&&B<f;){B++;const m=y.dequeue(),Y=m.key;if(T.has(Y))continue;T.add(Y);const j=uo(m.q,m.r);for(const F of j){const ie=is(F.q,F.r);if(T.has(ie)||c.has(ie))continue;const W=o(F.q,F.r),S=qn(W,k);if(S===1/0)continue;const Z=m.cost+S;if(Z>l)continue;const K=x.get(ie);if(!K||Z<K.cost){const X={q:F.q,r:F.r,cost:Z};x.set(ie,X),y.enqueue({...X,key:ie},Z)}}}return x}function El(t){return Array.from(t.values())}const Ts={MOVEMENT:"movement",SURGE_1:"surge_1",SURGE_2:"surge_2",SURGE_3:"surge_3",SURGE_4:"surge_4",UNREACHABLE:"unreachable"};function $a(t,l){if(!t||t.length<2)return{segments:[],usedResources:{movement:0,surges:0},reachable:!0};const{movement:o=5,surges:a=2,movementPerSurge:r=2}=l||{},c=[];let f=0,k=0;const w=m=>{if(m<=o)return Ts.MOVEMENT;let Y=o;for(let j=0;j<a;j++)if(Y+=r,m<=Y)return j===0?Ts.SURGE_1:j===1?Ts.SURGE_2:j===2?Ts.SURGE_3:Ts.SURGE_4;return Ts.UNREACHABLE};let x={type:w(.01),path:[t[0]],startCost:0,endCost:0,hasEndpoint:!1,isFinal:!1};for(let m=1;m<t.length;m++){const Y=t[m],j=t[m-1],F=w(Y.cost),ie=w(j.cost);F!==ie?(x.endCost=j.cost,x.hasEndpoint=!0,c.push(x),x={type:F,path:[j,Y],startCost:j.cost,endCost:Y.cost,hasEndpoint:!1,isFinal:!1}):(x.path.push(Y),x.endCost=Y.cost)}x.hasEndpoint=!0,x.isFinal=!0,c.push(x);const T=t[t.length-1].cost;if(T<=o)f=T;else{f=o;const m=T-o;k=Math.min(a,Math.ceil(m/r))}const y=c[c.length-1],B=(y==null?void 0:y.type)!==Ts.UNREACHABLE;return{segments:c,usedResources:{movement:f,surges:k},reachable:B}}function _a(t){return t<.5?4*t*t*t:1-Math.pow(-2*t+2,3)/2}function Pl(t,l,o){return t+(l-t)*o}function Un(t,l){if(t.length<2)return t[0]||{x:0,y:0};if(t.length===2)return{x:Pl(t[0].x,t[1].x,l),y:Pl(t[0].y,t[1].y,l)};const o=t.length-1,a=l*o,r=Math.min(Math.floor(a),o-1),c=a-r,f=t[Math.max(0,r-1)],k=t[r],w=t[Math.min(t.length-1,r+1)],x=t[Math.min(t.length-1,r+2)],T=c*c,y=T*c,B=.5*(2*k.x+(-f.x+w.x)*c+(2*f.x-5*k.x+4*w.x-x.x)*T+(-f.x+3*k.x-3*w.x+x.x)*y),m=.5*(2*k.y+(-f.y+w.y)*c+(2*f.y-5*k.y+4*w.y-x.y)*T+(-f.y+3*k.y-3*w.y+x.y)*y);return{x:B,y:m}}function Ta(t,l){const a=Math.max(0,l-.01),r=Math.min(1,l+.01),c=Un(t,a),f=Un(t,r);return Math.atan2(f.y-c.y,f.x-c.x)}function Ia(t,l=!0){let o=t*(180/Math.PI);for(;o<0;)o+=360;for(;o>=360;)o-=360;let a=Math.floor((o+15)/30)%12;return l&&(a=(a+3)%12),a}class Sa{constructor(l={}){this.characterId=l.characterId,this.path=l.path||[],this.pixelPath=l.pixelPath||[],this.duration=l.duration||500,this.startTimestamp=l.startTimestamp||Date.now(),this.onUpdate=l.onUpdate||(()=>{}),this.onComplete=l.onComplete||(()=>{}),this.onHexChange=l.onHexChange||(()=>{}),this.isPointy=l.isPointy!==!1,this.startTime=null,this.isRunning=!1,this.animationFrameId=null,this.lastHexIndex=0,this.lastFacing=0}start(){if(this.pixelPath.length<2){this.onComplete();return}this.startTime=performance.now(),this.isRunning=!0,this.lastHexIndex=0,this.tick()}tick(){if(!this.isRunning)return;const o=performance.now()-this.startTime,a=Math.min(o/this.duration,1),r=_a(a),c=Un(this.pixelPath,r),f=Ta(this.pixelPath,r),k=Ia(f,this.isPointy);this.lastFacing=k;const w=Math.min(Math.floor(r*(this.path.length-1)),this.path.length-1);w!==this.lastHexIndex&&w<this.path.length&&(this.onHexChange(this.path[w],w),this.lastHexIndex=w),this.onUpdate(c.x,c.y,k,r),a<1?this.animationFrameId=requestAnimationFrame(()=>this.tick()):this.complete()}complete(){this.isRunning=!1,this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.onComplete()}stop(){this.isRunning=!1,this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}}class Ea{constructor(){this.animations=new Map,this.animatedPositions=new Map,this.onRenderCallback=null,this.renderLoopId=null}setRenderCallback(l){this.onRenderCallback=l}startRenderLoop(){if(this.renderLoopId)return;const l=()=>{this.animations.size>0?(this.onRenderCallback&&this.onRenderCallback(),this.renderLoopId=requestAnimationFrame(l)):this.renderLoopId=null};this.renderLoopId=requestAnimationFrame(l)}stopRenderLoop(){this.renderLoopId&&(cancelAnimationFrame(this.renderLoopId),this.renderLoopId=null)}animate(l){const{characterId:o,path:a,hexToPixel:r,duration:c=100*a.length,isPointy:f=!0,onHexChange:k=()=>{},onComplete:w=()=>{}}=l;this.stop(o);const x=a.map(y=>r(y.q,y.r)),T=new Sa({characterId:o,path:a,pixelPath:x,duration:c,isPointy:f,onUpdate:(y,B,m,Y)=>{this.animatedPositions.set(o,{x:y,y:B,facing:m})},onHexChange:k,onComplete:()=>{const y=T.lastFacing;this.animations.delete(o),this.animatedPositions.delete(o),w(y)}});return this.animations.set(o,T),T.start(),this.startRenderLoop(),T}stop(l){const o=this.animations.get(l);o&&(o.stop(),this.animations.delete(l),this.animatedPositions.delete(l))}getAnimatedPosition(l){return this.animatedPositions.get(l)||null}isAnimating(l){return this.animations.has(l)}stopAll(){for(const l of this.animations.values())l.stop();this.animations.clear(),this.animatedPositions.clear()}}const Ss=new Ea;function Pa(t){const{characterId:l,path:o,hexToPixel:a,moveToken:r,rotateToken:c,onComplete:f=()=>{},duration:k,isPointy:w=!0}=t;return!o||o.length<2?(f(0),null):Ss.animate({characterId:l,path:o,hexToPixel:a,duration:k||100*o.length,isPointy:w,onHexChange:(x,T)=>{r(x.q,x.r)},onComplete:x=>{const T=o[o.length-1];r(T.q,T.r),f(x)}})}function Ma(t){const{characterId:l,path:o,hexToPixel:a,moveToken:r,duration:c,startTime:f,finalFacing:k=0,isPointy:w=!0,onComplete:x=()=>{}}=t;if(!o||o.length<2){const ie=(o==null?void 0:o[o.length-1])||(o==null?void 0:o[0]);return ie&&r(ie.q,ie.r),x(k),null}const T=Date.now()-f,y=2e3;if(console.log("[Animation Remote] elapsed:",T,"duration:",c),T>=c+y){console.log("[Animation Remote] Animation definitely finished, snapping to final position");const ie=o[o.length-1];return r(ie.q,ie.r),x(k),null}let B=Math.max(0,Math.min(T,c-100));T<0&&(B=0);const m=c-B,Y=B/c,j=Math.floor(Y*(o.length-1)),F=o.slice(j);if(F.length<2){const ie=o[o.length-1];return r(ie.q,ie.r),x(k),null}return console.log(`[Animation Remote] Starting animation from index ${j}, remaining duration: ${m}ms`),Ss.animate({characterId:l,path:F,hexToPixel:a,duration:m,isPointy:w,onHexChange:(ie,W)=>{r(ie.q,ie.r)},onComplete:ie=>{const W=o[o.length-1];r(W.q,W.r),x(ie)}})}function Ml(t){const{characterId:l,currentPos:o,targetHex:a,facing:r,mapId:c,isPointy:f,grid:k,getTerrainAt:w,pathfindingOptions:x={modifiers:{},maxCost:100},battleMapStore:T,onBeforeAnimate:y,onComplete:B}=t;if(!l)return{success:!1,error:"characterId is required"};if(!o)return{success:!1,error:"currentPos is required"};if(!a)return{success:!1,error:"targetHex is required"};if(!c)return{success:!1,error:"mapId is required"};if(!k)return{success:!1,error:"grid is required for animation"};if(!w)return{success:!1,error:"getTerrainAt function is required"};if(!T)return{success:!1,error:"battleMapStore is required"};if(o.q===a.q&&o.r===a.r)return r!=null&&T.rotateToken(c,o.q,o.r,r),{success:!0,path:[],cost:0,rotateOnly:!0};const m=Jn({q:o.q,r:o.r},{q:a.q,r:a.r},w,x);if(!m.found)return console.warn("[useTokenMovement] Путь до целевого гекса не найден"),{success:!1,error:"path_not_found"};console.log("[useTokenMovement] Найден путь:",m.path.length,"шагов, стоимость:",m.totalCost);const Y=r,j=200*m.path.length;return y&&y({characterId:l,path:m.path.map(F=>({q:F.q,r:F.r})),duration:j,facing:Y??0}),Pa({characterId:l,path:m.path,hexToPixel:(F,ie)=>k.hexToPixel(F,ie),duration:j,isPointy:f,moveToken:(F,ie)=>{const W=T.findTokenPosition(c,l);W&&T.moveToken(c,W.q,W.r,F,ie)},onComplete:F=>{console.log("[useTokenMovement] Анимация завершена, lastFacing:",F,"finalFacing:",Y);const ie=Y??F??0,W=T.findTokenPosition(c,l);W&&T.rotateToken(c,W.q,W.r,ie),B&&B({lastFacing:F,finalFacing:ie,targetHex:a,path:m.path})}}),{success:!0,path:m.path,cost:m.totalCost,duration:j}}function B_({battleMapStore:t,terrainStore:l,getHexGrid:o}){const a=(c,f=new Set)=>(k,w)=>{const x=t.activeMapId;return t.getHexPathfindingData(x,k,w,l,{viewerId:c,characterTags:f})};return{moveToken:c=>{const{characterId:f,targetHex:k,facing:w=null,pathfindingOptions:x,onBeforeAnimate:T,onComplete:y}=c,B=t.activeMap;if(!B)return console.warn("[useTokenMovement] Нет активной карты"),{success:!1,error:"no_active_map"};const m=B.id,Y=B.orientation==="pointy",j=t.findTokenPosition(m,f);if(!j)return console.warn("[useTokenMovement] Токен не найден на карте"),{success:!1,error:"token_not_found"};const F=o();if(!F)return console.warn("[useTokenMovement] HexGrid не доступен"),{success:!1,error:"no_grid"};const ie=a(f);return Ml({characterId:f,currentPos:j,targetHex:k,facing:w,mapId:m,isPointy:Y,grid:F,getTerrainAt:ie,pathfindingOptions:x,battleMapStore:t,onBeforeAnimate:T,onComplete:y})},createGetTerrainAt:a,moveTokenWithAnimation:Ml}}function Da(t){const{payload:l,myUserId:o,battleMapStore:a,getHexGrid:r,getActiveMap:c,onComplete:f}=t;if(l.userId===o)return console.log("[useTokenMovement] Пропускаем свою анимацию"),{success:!1,error:"own_animation"};const k=c(),w=k==null?void 0:k.id;if(!w||!l.path||l.path.length<2)return{success:!1,error:"invalid_payload"};const x=r();if(!x)return{success:!1,error:"no_grid"};const T=k.orientation==="pointy";return console.log("[useTokenMovement] Воспроизводим удалённую анимацию:",l.characterId),Ma({characterId:l.characterId,path:l.path,hexToPixel:(y,B)=>x.hexToPixel(y,B),duration:l.duration,startTime:l.startTime,finalFacing:l.finalFacing||0,isPointy:T,moveToken:(y,B)=>{const m=a.findTokenPosition(w,l.characterId);m?a.moveToken(w,m.q,m.r,y,B):a.placeToken(w,l.characterId,y,B,l.finalFacing||0)},onComplete:y=>{console.log("[useTokenMovement] Удалённая анимация завершена для",l.characterId,"lastFacing:",y);const B=l.finalFacing??y??0,m=l.path[l.path.length-1];a.rotateToken(w,m.q,m.r,B),f&&f({lastFacing:y,finalFacing:B,targetHex:m})}}),{success:!0}}const Pt={IDLE:"idle",TOKEN_SELECTED:"token-selected",PATH_SHOWN:"path-shown",DRAGGING_FACING:"dragging-facing",DRAGGING_TOKEN:"dragging-token"},us={CENTER:"center",DIRECTION:"direction",CANCEL:"cancel"},Dl=.3,Ba=1.5,Bl=3,$n=Xn("interaction",{state:()=>({state:Pt.IDLE,selectedTokenId:null,selectedTokenPosition:null,targetHex:null,currentPath:null,suggestedFacing:null,selectedFacing:null,dragState:{isActive:!1,startX:0,startY:0,currentX:0,currentY:0,zone:us.CENTER,source:null},showDefencePreview:!1,defencePreviewFacing:null,isMasterMode:!1,battlePanelExpanded:!1}),getters:{hasSelection:t=>t.selectedTokenId!==null,showMovementRange:t=>t.state===Pt.TOKEN_SELECTED||t.state===Pt.PATH_SHOWN||t.state===Pt.DRAGGING_FACING,showPath:t=>t.state===Pt.PATH_SHOWN||t.state===Pt.DRAGGING_FACING,finalFacing:t=>t.selectedFacing??t.suggestedFacing??0,canConfirmMove:t=>t.state===Pt.PATH_SHOWN&&t.targetHex!==null,isDragging:t=>t.dragState.isActive},actions:{reset(){this.state=Pt.IDLE,this.selectedTokenId=null,this.selectedTokenPosition=null,this.targetHex=null,this.currentPath=null,this.suggestedFacing=null,this.selectedFacing=null,this.dragState={isActive:!1,startX:0,startY:0,currentX:0,currentY:0,zone:us.CENTER,source:null},this.showDefencePreview=!1,this.defencePreviewFacing=null},selectToken(t,l,o=!0){return this.selectedTokenId===t&&this.state!==Pt.IDLE?(this.reset(),!1):(this.selectedTokenId=t,this.selectedTokenPosition=l?{...l}:null,this.targetHex=null,this.currentPath=null,this.suggestedFacing=null,this.selectedFacing=null,o&&l?this.state=Pt.TOKEN_SELECTED:this.state=Pt.TOKEN_SELECTED,!0)},setPath(t,l,o){var a,r;return this.state===Pt.PATH_SHOWN&&((a=this.targetHex)==null?void 0:a.q)===t.q&&((r=this.targetHex)==null?void 0:r.r)===t.r?{action:"confirm",facing:this.finalFacing}:(this.targetHex={...t},this.currentPath=l?[...l]:null,this.suggestedFacing=o??0,this.selectedFacing=null,this.state=Pt.PATH_SHOWN,{action:"show"})},startDrag(t,l,o){this.dragState={isActive:!0,startX:t,startY:l,currentX:t,currentY:l,zone:us.CENTER,source:o},o==="path-end"?(this.state=Pt.DRAGGING_FACING,this.showDefencePreview=!0):o==="token"&&(this.state=Pt.DRAGGING_TOKEN)},updateDrag(t,l,o,a){if(!this.dragState.isActive)return null;this.dragState.currentX=t,this.dragState.currentY=l;const r=t-a.x,c=l-a.y,f=Math.sqrt(r*r+c*c),k=o*Dl,w=o*Bl;let x=us.CENTER;if(f>w?x=us.CANCEL:f>k&&(x=us.DIRECTION),this.dragState.zone=x,x===us.DIRECTION){let T=Math.atan2(c,r)*(180/Math.PI);for(;T<0;)T+=360;return{zone:x,angle:T,distance:f}}return{zone:x,angle:null,distance:f}},setFacing(t){this.selectedFacing=t,this.defencePreviewFacing=t},endDrag(){if(!this.dragState.isActive)return null;const{zone:t,source:l}=this.dragState,o=this.selectedFacing??this.suggestedFacing??0;let a;return t===us.CANCEL?(a={action:"cancel",cancelled:!0},this.targetHex=null,this.currentPath=null,this.suggestedFacing=null,this.selectedFacing=null,this.state=this.selectedTokenId?Pt.TOKEN_SELECTED:Pt.IDLE):l==="path-end"&&(a={action:"move",facing:o}),this.dragState={isActive:!1,startX:0,startY:0,currentX:0,currentY:0,zone:us.CENTER,source:null},this.showDefencePreview=!1,a},cancel(){this.state===Pt.DRAGGING_FACING?this.endDrag():this.state===Pt.PATH_SHOWN?(this.targetHex=null,this.currentPath=null,this.suggestedFacing=null,this.selectedFacing=null,this.state=this.selectedTokenId?Pt.TOKEN_SELECTED:Pt.IDLE):this.reset()},setMasterMode(t){this.isMasterMode=t},getDragDistance(){if(!this.dragState.isActive)return 0;const t=this.dragState.currentX-this.dragState.startX,l=this.dragState.currentY-this.dragState.startY;return Math.sqrt(t*t+l*l)},getDragZoneConfig(t){return{centerRadius:t*Dl,directionRadius:t*Ba,cancelRadius:t*Bl}},toggleBattlePanel(){this.battlePanelExpanded=!this.battlePanelExpanded},setBattlePanelExpanded(t){this.battlePanelExpanded=t}}}),Ra=[{id:"clothes",category:"armor",subcat:"light",name:"Обычная одежда",desc:"Надевать такую в бой - довольно сомнительная затея. Однако на полях сражений нередко оказывались те, кто не смог себе позволить вовсе никакую броню. А иногда и серьёзных воинов нападение заставало не готовыми, погружёнными в обычные бытовые проблемы.",price:1,epoch:1,defence:0,resist:0,movement:0,bursts:0},{id:"makeshift_light_armor",category:"armor",subcat:"light",name:"Крепкая одежда",desc:"Некоторые виды одежды лучше других держат удар, что позволяет использовать их в качестве импровизированной брони. Это может быть куртка из толстой кожи, шкура зверя или вовсе обычные одеяния, на которые нашили твёрдые элементы.",price:3,epoch:2,defence:3,resist:0,movement:0,bursts:0},{id:"makeshift_heavy_armor",category:"armor",subcat:"heavy",name:"Кустарная тяжёлая броня",desc:"Хорошенько потрудившись, можно сделать из обычной одежды некое подобие брони. Обилие нашитых элементов здорово сковывает движение, зато такой доспех снижает входящий урон и (главное), очень дёшев в производстве.",price:3,epoch:2,defence:0,resist:1,movement:-1,bursts:-1},{id:"light_armor",category:"armor",subcat:"light",name:"Лёгкая броня",desc:"Лёгкая броня не сковывает движений и даёт кое-какую защиту - попасть в уязвимое место противнику становится значительно сложнее.",price:5,epoch:4,defence:6,resist:0,movement:0,bursts:0},{id:"heavy_armor",category:"armor",subcat:"heavy",name:"Тяжёлая броня",desc:"Хорошая тяжёлая броня лишь немного сковывает движения, но уворачиваться в ней уже гораздо сложнее. Зато, если по Вам всё же попали, урона Вы получите значительно меньше.",price:5,epoch:4,defence:0,resist:1,movement:-1,bursts:0},{id:"late_light_armor",category:"armor",subcat:"light",name:"Поздняя лёгкая броня",desc:"Позволить себе такой шедевр мастерства бронников могут не многие, зато живут на поле боя эти счастливчики гораздо дольше других. Защищённых областей на теле больше, а маневренность при этом никак не страдает.",price:7,epoch:6,defence:12,resist:0,movement:0,bursts:0},{id:"late_medium_armor",category:"armor",subcat:"middle",name:"Поздняя средняя броня",desc:"Хороший компромисс между подвижностью и защищённостью, но по совершенно бескомпромиссной цене.",price:7,epoch:6,defence:3,resist:1,movement:0,bursts:0},{id:"late_heavy_armor",category:"armor",subcat:"heavy",name:"Поздняя тяжёлая броня",desc:"Для тех, кто хочет почувствовать себя настоящим танком на поле боя - беспрецедентный уровень защищённости при минимальной подвижности. Несмотря на огромную цену этих доспехов, вряд ли найдётся идиот, который захочет сразиться с Вами ради такого трофея.",price:7,epoch:6,defence:0,resist:2,movement:-1,bursts:0},{id:"simple_spear",category:"weapon",subcat:"spears",name:"Простое копьё",desc:"",length:2,hands:1,price:2,epoch:2,attack:{short:-2,long:4},defence:3,damageType:"Колющий",armorPen:0,damage:{t:0,l:3}},{id:"iron_spear",category:"weapon",subcat:"spears",name:"Железное копьё",desc:"",length:2,hands:1,price:4,epoch:4,attack:{short:-1,long:5},defence:3,damageType:"Колющий",armorPen:0,damage:{t:0,l:2,m:6}},{id:"steel_spear",category:"weapon",subcat:"spears",name:"Стальное копьё",desc:"",length:2,hands:1,price:6,epoch:6,attack:{short:0,long:6},defence:4,damageType:"Колющий",armorPen:0,damage:{t:0,l:2,m:6,h:9}},{id:"iron_glaive",category:"weapon",subcat:"spears",name:"Глефа",desc:"",length:2,hands:2,price:5,epoch:5,attack:{short:0,long:6},defence:2,damageType:"Рубящий",armorPen:0,damage:{l:0,m:3,h:9}},{id:"steel_glaive",category:"weapon",subcat:"spears",name:"Стальная глефа",desc:"",length:2,hands:2,price:7,epoch:7,attack:{short:1,long:7},defence:4,damageType:"Рубящий",armorPen:0,damage:{l:0,m:2,h:8}},{id:"iron_halberd",category:"weapon",subcat:"spears",name:"Алебарда",desc:"",length:2,hands:2,price:5,epoch:5,attack:{short:0,long:4},defence:3,damageType:"Рубящий",armorPen:0,damage:{l:0,m:2,h:6}},{id:"steel_halberd",category:"weapon",subcat:"spears",name:"Стальная алебарда",desc:"",length:2,hands:2,price:7,epoch:7,attack:{short:1,long:5},defence:4,damageType:"Рубящий",armorPen:0,damage:{l:0,m:2,h:6}},{id:"simple_bow",category:"weapon",subcat:"bows",name:"Короткий лук",desc:"",spec:"Нельзя стрелять с порывом",length:2,hands:2,price:3,epoch:2,attack:{long:3,ranged:6},defence:0,damageType:"Колющий",armorPen:0,damage:{t:0,l:3}},{id:"strong_bow",category:"weapon",subcat:"bows",name:"Боевой лук",desc:"",spec:"",length:2,hands:2,price:4,epoch:4,attack:{long:0,ranged:6},defence:0,damageType:"Колющий",armorPen:0,damage:{t:0,l:3,m:9}},{id:"longbow",category:"weapon",subcat:"bows",name:"Длинный лук",desc:"",spec:"Нельзя стрелять без порыва. Можно вкладывать в выстрел второй порыв, тогда игнорирует единицу брони.",length:2,hands:2,price:5,epoch:4,attack:{long:-3,ranged:6},defence:0,damageType:"Колющий",armorPen:0,damage:{l:0,m:6,h:12}},{id:"stone_knife",category:"weapon",subcat:"daggers",name:"Простой нож",desc:"",length:1,hands:.5,price:1,epoch:1,attack:{short:2,long:-6},defence:0,damageType:"Колющий",armorPen:0,damage:{t:0,l:3}},{id:"knife",category:"weapon",subcat:"daggers",name:"Добротный нож",desc:"",length:1,hands:.5,price:2,epoch:2,attack:{short:2,long:-4},defence:1,damageType:"Колющий",armorPen:0,damage:{t:0,l:2}},{id:"steel_dagger",category:"weapon",subcat:"daggers",name:"Cтальной кинжал",desc:"",length:1,hands:.5,price:5,epoch:4,attack:{short:3,long:-4},defence:1,damageType:"Колющий",armorPen:0,damage:{t:0,l:2,m:4}},{id:"stiletto",category:"weapon",subcat:"daggers",name:"Стилет",desc:"Стилет не особенно то удобен в бою, зато замечательно пронзает многие виды доспехов.",length:1,hands:.5,price:6,epoch:5,attack:{short:2,long:-4},defence:0,damageType:"Колющий",armorPen:2,damage:{t:0,l:2,m:6}},{id:"main_gauche",category:"weapon",subcat:"daggers",name:"Дага",desc:"Дага - преимущественно защитный кинжал во вторую руку, тем не менее может применяться и для нанесения серьёзных ударов. Особенно, если вражеская защита пробита. Атаки дагой во второй руке могут наносить ту же категорию ранения, что и атаки основным оружием, а не на категорию ниже, как обычно.",length:1,hands:1,price:6,epoch:5,attack:{short:2,long:-2},defence:4,damageType:"Колющий",armorPen:0,damage:{t:0,l:2,m:6}},{id:"wooden_flail",category:"weapon",subcat:"flails",name:"Цеп",desc:"",length:1,hands:1,price:1,epoch:2,attack:{short:6,long:4},defence:0,damageType:"Дробящий",armorPen:1,damage:{t:0,l:3}},{id:"iron_flail",category:"weapon",subcat:"flails",name:"Железный цеп",desc:"",length:2,hands:1,price:5,epoch:4,attack:{short:8,long:4},defence:0,damageType:"Дробящий",armorPen:1,damage:{t:0,l:6,m:12}},{id:"steel_flail",category:"weapon",subcat:"flails",name:"Стальной цеп",desc:"",length:2,hands:1,price:6,epoch:6,attack:{short:10,long:5},defence:0,damageType:"Дробящий",armorPen:1,damage:{t:0,l:6,m:9}},{id:"wooden_club",category:"weapon",subcat:"maces",name:"Дубинка",desc:"",length:1,hands:1,price:1,epoch:1,attack:{short:2,long:-2},defence:2,damageType:"Дробящий",armorPen:1,damage:{t:0,l:6}},{id:"simple_staff",category:"weapon",subcat:"maces",name:"Простой посох",desc:"",length:2,hands:2,price:1,epoch:1,attack:{short:-2,long:4},defence:2,damageType:"Дробящий",armorPen:0,damage:{t:0,l:6}},{id:"battle_staff",category:"weapon",subcat:"maces",name:"Боевой посох",desc:"",length:2,hands:2,price:3,epoch:3,attack:{short:-2,long:4},defence:2,damageType:"Дробящий",armorPen:0,damage:{t:0,l:5,m:10}},{id:"steel_staff",category:"weapon",subcat:"maces",name:"Стальной посох",desc:"",length:2,hands:2,price:5,epoch:5,attack:{short:-2,long:4},defence:4,damageType:"Дробящий",armorPen:1,damage:{t:0,l:5,m:10}},{id:"iron_mace",category:"weapon",subcat:"maces",name:"Булава",desc:"",length:1,hands:1,price:5,epoch:4,attack:{short:4,long:-2},defence:2,damageType:"Дробящий",armorPen:1,damage:{t:0,m:6}},{id:"steel_mace",category:"weapon",subcat:"maces",name:"Стальная булава",desc:"",length:1,hands:1,price:7,epoch:6,attack:{short:5,long:-1},defence:3,damageType:"Дробящий",armorPen:1,damage:{t:0,l:2,m:4}},{id:"simple_axe",category:"weapon",subcat:"axes",name:"Плотницкий топор",desc:"",length:1,hands:1,price:2,epoch:1,attack:{short:4,long:-2},defence:2,damageType:"Режущий",armorPen:0,damage:{t:0,m:8}},{id:"battle_axe",category:"weapon",subcat:"axes",name:"Боевой топорик",desc:"",length:1,hands:1,price:5,epoch:4,attack:{short:6,long:0},defence:3,damageType:"Режущий",armorPen:0,damage:{t:0,l:3,m:9}},{id:"steel_axe",category:"weapon",subcat:"axes",name:"Стальной топор",desc:"",length:1,hands:1,price:6,epoch:7,attack:{short:8,long:2},defence:3,damageType:"Режущий",armorPen:0,damage:{t:0,l:2,m:6}},{id:"battle_greataxe",category:"weapon",subcat:"axes",name:"Двуручный топор",desc:"",length:2,hands:2,price:6,epoch:5,attack:{short:0,long:6},defence:3,damageType:"Режущий",armorPen:0,damage:{l:0,m:3,h:9}},{id:"steel_greataxe",category:"weapon",subcat:"axes",name:"Стальной двуручный топор",desc:"",length:2,hands:2,price:7,epoch:7,attack:{short:2,long:8},defence:3,damageType:"Режущий",armorPen:0,damage:{l:0,m:2,h:8}},{id:"stone_hammer",category:"weapon",subcat:"maces",name:"Каменный молоток",desc:"",length:1,hands:1,price:2,epoch:2,attack:{short:2,long:-4},defence:0,damageType:"Дробящий",armorPen:1,damage:{l:0,m:6}},{id:"stone_greathammer",category:"weapon",subcat:"maces",name:"Каменная кувалда",desc:"",length:2,hands:2,price:2,epoch:2,attack:{short:-4,long:0},defence:0,damageType:"Дробящий",armorPen:1,damage:{m:0,h:6}},{id:"iron_hammer",category:"weapon",subcat:"maces",name:"Железный молот",desc:"",length:1,hands:1,price:3,epoch:3,attack:{short:3,long:-1},defence:0,damageType:"Дробящий",armorPen:1,damage:{l:0,m:5}},{id:"iron_greathammer",category:"weapon",subcat:"maces",name:"Железная кувалда",desc:"",length:2,hands:2,price:5,epoch:4,attack:{short:-6,long:0},defence:0,damageType:"Дробящий",armorPen:1,damage:{m:0,h:5}},{id:"iron_warhammer",category:"weapon",subcat:"maces",name:"Железный боевой молот",desc:"",length:1,hands:1,price:4,epoch:4,attack:{short:4,long:-2},defence:0,damageType:"Дробящий",armorPen:2,damage:{l:0,m:6}},{id:"iron_greatwarhammer",category:"weapon",subcat:"maces",name:"Двуручный боевой молот",desc:"",length:2,hands:2,price:6,epoch:5,attack:{short:-2,long:2},defence:0,damageType:"Дробящий",armorPen:2,damage:{m:0,h:6}},{id:"steel_warhammer",category:"weapon",subcat:"maces",name:"Стальной боевой молот",desc:"",length:1,hands:1,price:6,epoch:7,attack:{short:5,long:1},defence:2,damageType:"Дробящий",armorPen:2,damage:{l:0,m:4}},{id:"steel_greatwarhammer",category:"weapon",subcat:"maces",name:"Длинный стальной боевой молот",desc:"",length:2,hands:2,price:7,epoch:7,attack:{short:-2,long:3},defence:2,damageType:"Дробящий",armorPen:2,damage:{m:0,h:4}},{id:"wooden_buckler",category:"shield",subcat:"shields",name:"Деревянный баклер",desc:"",spec:"Баклер может использоваться для атак, как второе оружие.",length:0,hands:.5,price:5,epoch:4,attack:{short:1},defence:{front:{melee:3,ranged:3},side:{melee:3,ranged:0}}},{id:"wooden_shield",category:"shield",subcat:"shields",name:"Деревянный щит",desc:"",spec:"Небольшим щитом можно толкать противника, затратив один порыв.",length:0,hands:1,price:4,epoch:3,attack:{short:1},defence:{front:{melee:6,ranged:6}}},{id:"large_wooden_shield",category:"shield",subcat:"shields",name:"Большой деревянный щит",desc:"",length:0,hands:1,price:5,epoch:3,defence:{front:{melee:6,ranged:9}}},{id:"wooden_tower_shield",category:"shield",subcat:"shields",name:"Деревянный башенный щит",desc:"",length:0,hands:1,price:5,epoch:3,movement:-1,attack:{short:-3},defence:{front:{melee:9,ranged:12}}},{id:"metal_buckler",category:"shield",subcat:"shields",name:"Стальной баклер",desc:"",spec:"Баклер может использоваться для атак, как второе оружие.",length:0,hands:.5,price:6,epoch:6,attack:{short:3},defence:{front:{melee:6,ranged:3},side:{melee:6,ranged:0}}},{id:"metal_shield",category:"shield",subcat:"shields",name:"Стальной щит",desc:"",spec:"Небольшим щитом можно толкать противника, затратив один порыв.",length:0,hands:1,price:7,epoch:6,attack:{short:3},defence:{front:{melee:6,ranged:6}}},{id:"large_metal_shield",category:"shield",subcat:"shields",name:"Большой стальной щит",desc:"",length:0,hands:1,price:5,epoch:7,attack:{short:1},defence:{front:{melee:9,ranged:9}}},{id:"metal_tower_shield",category:"shield",subcat:"shields",name:"Cтальной башенный щит",desc:"",length:0,hands:1,price:7,epoch:7,defence:{front:{melee:12,ranged:12}}},{id:"iron_shortsword",category:"weapon",subcat:"swords",name:"Короткий меч",desc:"",length:1,hands:1,price:4,epoch:3,attack:{short:3,long:3},defence:5,damageType:"Режущий",armorPen:0,damage:{t:0,l:4,m:12}},{id:"iron_sword",category:"weapon",subcat:"swords",name:"Меч пехотинца",desc:"",length:2,hands:1,price:4,epoch:4,attack:{short:4,long:6},defence:5,damageType:"Режущий",armorPen:0,damage:{t:0,l:3,m:10}},{id:"iron_falchion",category:"weapon",subcat:"swords",name:"Фальшион",desc:"",length:1,hands:1,price:4,epoch:4,attack:{short:5,long:7},defence:4,damageType:"Режущий",armorPen:0,damage:{t:0,l:3,m:10}},{id:"iron_greatsword",category:"weapon",subcat:"swords",name:"Двуручный меч",desc:"",length:2,hands:2,price:5,epoch:4,attack:{short:2,long:6},defence:3,damageType:"Режущий",armorPen:0,damage:{l:0,m:4,h:8}},{id:"steel_shortsword",category:"weapon",subcat:"swords",name:"Стальной короткий меч",desc:"",length:1,hands:1,price:6,epoch:6,attack:{short:4,long:4},defence:5,damageType:"Режущий",armorPen:0,damage:{t:0,l:3,m:9}},{id:"steel_sword",category:"weapon",subcat:"swords",name:"Стальной меч",desc:"",length:2,hands:1,price:7,epoch:6,attack:{short:6,long:6},defence:6,damageType:"Режущий",armorPen:0,damage:{t:0,l:2,m:8}},{id:"steel_saber",category:"weapon",subcat:"swords",name:"Сабля",desc:"",length:2,hands:1,price:7,epoch:7,attack:{short:2,long:8},defence:3,damageType:"Режущий",armorPen:0,damage:{t:0,l:3,m:6}},{id:"steel_scimitar",category:"weapon",subcat:"swords",name:"Скимитар",desc:"",length:2,hands:1,price:7,epoch:7,attack:{short:4,long:7},defence:2,damageType:"Режущий",armorPen:0,damage:{t:0,l:3,m:6}},{id:"steel_greatsword",category:"weapon",subcat:"swords",name:"Качественный двуручный меч",desc:"",length:2,hands:2,price:7,epoch:6,attack:{short:3,long:7},defence:4,damageType:"Режущий",armorPen:0,damage:{l:0,m:4,h:6}},{id:"rapier",category:"weapon",subcat:"swords",name:"Рапира",desc:"",length:2,hands:1.5,price:6,epoch:7,attack:{short:2,long:7},defence:3,damageType:"Колющий",armorPen:0,damage:{t:0,l:2,m:8}},{id:"hand_crossbow",category:"weapon",subcat:"crossbows",name:"Ручной арбалет",desc:"Требует порыва на перезарядку",length:2,hands:1.5,price:5,epoch:5,attack:{short:2,long:4,ranged:4},defence:0,damageType:"Колющий",armorPen:0,damage:{t:0,l:5}},{id:"crossbow",category:"weapon",subcat:"crossbows",name:"Арбалет",desc:"Требуется два порыва или полное основное действие на перезарядку",length:2,hands:2,price:6,epoch:5,attack:{short:0,long:6,ranged:6},defence:0,damageType:"Колющий",armorPen:0,damage:{t:0,l:4,m:8}},{id:"heavy_crossbow",category:"weapon",subcat:"crossbows",name:"Тяжёлый арбалет",desc:"Требуется полное действие и один порыв на перезарядку, в процессе нельзя передвигаться.",length:2,hands:2,price:6,epoch:5,attack:{long:0,ranged:8},defence:0,damageType:"Колющий",armorPen:1,damage:{t:0,l:4,m:8}},{id:"sling",category:"weapon",subcat:"slings",name:"Простая праща",desc:"",spec:"Нельзя стрелять с порывом",length:2,hands:2,price:2,epoch:2,attack:{long:2,ranged:3},defence:0,damageType:"Дробящий",armorPen:0,damage:{t:0,l:3}},{id:"heavy_sling",category:"weapon",subcat:"slings",name:"Боевая праща",desc:"",spec:"Нельзя стрелять без порыва",length:2,hands:2,price:4,epoch:3,attack:{long:2,ranged:4},defence:0,damageType:"Дробящий",armorPen:0,damage:{t:0,l:3,m:9}}],Fa={systemName:"triP Items",version:"1.0",totalItems:110},en={items:Ra,metadata:Fa},La=[{id:"war",name:"Война",nameEn:"War",description:"Физическая сила, боевые навыки, агрессия и доминирование",characteristic:{name:"Мощь",nameEn:"Might",abbreviation:"MIG"},check:{name:"Конфликт",nameEn:"Conflict",description:"Проверки прямого противостояния, боя и физической силы"},mode:{name:"Напористо",nameEn:"Assertive",icon:"game-icons:fist",description:"Действуйте решительно и прямолинейно",bonuses:[]},color:"#dc2626",colorName:"red",icon:"game-icons:crossed-swords",characteristicIcon:"game-icons:embrassed-energy",checkIcon:"game-icons:arrow-scope",position:{angle:330,corner:"top-left",description:"Верхний левый угол шестиугольника"},neighbors:["nature","knowledge"],opposite:"shadow",axis:{id:"power",name:"Сила",nameEn:"Power",pole:"active"},traits:[{id:"firstStrike",name:"Первый удар",levels:[{text:"Противник не может отреагировать на Ваше передвижение, если Вы атакуете сразу после сближения. Тем не менее, он может отреагировать после.",effect:{}},{text:"Противник, по которому Вы попали после сближения, теряет один порыв прямо перед атакой. Если у него не оставалось порывов, его защита ниже на одну категорию до конца Вашей атаки.",effect:{}},{text:"Противник, которого Вы атакуете сразу после сближения, теряет два порыва и не может отреагировать даже после атаки. Если у него не хватает порывов, он теряет по одной категории защиты за каждый, эффект длится до начала Вашего следующего хода",effect:{}}]},{id:"flurryOfBlows",name:"Шквал ударов",levels:[{text:"Потратив два порыва, Вы можете провести одну атаку.",effect:{}},{text:"Потратив два порыва, Вы можете провести одну атаку, при этом Вы добавляете к броску кость порыва.",effect:{}},{text:"В свой ход Вы можете проводить дополнительную атаку, затратив всего одну кость порыва. Кость порыва к броску при этом не добавляется.",effect:{}}]},{id:"suppression",name:"Подавление",levels:[{text:"Ваши атаки мешают противнику действовать, даже если они не попадают по цели. Тот, кого Вы атаковали в свой ход с порывом считается подавленным до конца Вашего следующего хода. Он получает штраф к передвижению в одну клетку, атаке и защите - в одну категорию. Эти штрафы не складываются.",effect:{}},{text:"Противнику приходится тратить всё больше времени и внимания, чтобы бороться с Вашим напором. Каждая атака с порывом по уже подавленному противнику забирает у него один порыв (если он есть), или понижает защиту на две категории вместо одной (если порывы закончились)",effect:{}},{text:"Вы достигли мастерства в подавлении противника. Вам больше не обязательно вкладывать порывы в свои атаки, чтобы подавление сработало.",effect:{}}]}]},{id:"knowledge",name:"Знание",nameEn:"Knowledge",description:"Интеллект, логика, наука и аналитическое мышление",characteristic:{name:"Разум",nameEn:"Reason",abbreviation:"REA"},check:{name:"Порядок",nameEn:"Order",description:"Проверки знаний, логики и систематического подхода"},mode:{name:"Рассудительно",nameEn:"Deliberate",icon:"game-icons:brain",description:"Анализируйте и планируйте каждый шаг",bonuses:[]},color:"#3b82f7",colorName:"blue",icon:"game-icons:open-book",characteristicIcon:"game-icons:inspiration",checkIcon:"game-icons:materials-science",position:{angle:30,corner:"top-right",description:"Верхний правый угол шестиугольника"},neighbors:["war","community"],opposite:"mysticism",axis:{id:"progress",name:"Развитие",nameEn:"Progress",pole:"rational"},traits:[{id:"education",name:"Образование",levels:[{text:"Получив хорошую обучающую книгу о каком-то навыке, Вы можете научиться его первому уровню, затратив на это не менее месяца времени. Обучение обойдётся Вам в одно очко повышения, если у Вас нет необходимого класса или бесплатно, если он есть. Вы не можете таким образом изучать навыки противоположных аспектов (или их смежные)",effect:{}},{text:"Найдя хорошего мастера навыка (владеющего его третьей ступенью), Вы можете научиться второму уровню. На это Вам и Вашему учителю придётся потратить как минимум месяц времени. Это обойдётся Вам в два очка повышения, если у Вас нет необходимого класса или бесплатно, если он есть.",effect:{}},{text:'Вы можете обучать других тем навыкам, которыми владеете сами. Вам и Вашему ученику потребуется не менее месяца, а обучаемый так же потратит одно очко повышения за уровень навыка, если у него нет необходимого класса. Вашему ученику не обязательно иметь навык "Образование". На этом уровне Вы можете обучаться навыкам противоположных аспектов.',effect:{}}]},{id:"quickWit",name:"Живой ум",levels:[{text:"Ваш пытливый ум позволяет Вам быстрее разбираться в любых сферах знаний, которыми владеют разумные. Поиск информации в книгах и библиотеках для Вас на две категории проще. Вы хорошо читаете карты, Вам на одну категорию проще планировать маршрут так, чтобы избежать опасностей или выйти на желаемую точку боевой карты.",effect:{}},{text:"Вы постоянно подмечаете и запоминаете, Ваш разум анализирует и раскладывает по полочкам. Если Вы видите за работой специалиста гражданского профиля на протяжении хотя бы нескольких часов, все Ваши проверки по его профессии впоследствии на одну категорию проще. Если он взялся обучать Вас и на это был затрачен хотя бы один день, проверки на две категории проще. Кроме того, Вы хорошо разбираетесь в общеизвестной истории, в курсе новейших открытий и изобретений.",effect:{}},{text:"Вы знаете и понимаете так много, что зачастую можете дать полезную подсказку даже хорошему специалисту. Если он готов принять Вашу помощь и делится своими планами или соображениями, Вы можете снизить сложность проверки на одну категорию или даже на две, если область знания принадлежит Вашему классу или смежному.",effect:{}}]},{id:"inMasterHands",name:"В руках мастера",levels:[{text:"Пока для других механизмы - просто инструмент достижения целей, для Вас это ещё и загадка, которую хочется разгадать. Починка механических устройств и обезвреживание механических ловушек с Вашей помощью легче на две категории. Кроме того, Вы можете потратить некоторое время на то, чтобы аккуратно разобрать устройство и понять, как создавать подобные в будущем. Для этого Вам нужно будет пройти проверку, тем более сложную, чем более сложное оборудование Вы разбираете. Это умение не распространяется на магические предметы и артефакты.",effect:{}},{text:"Большой опыт в работе с различными механизмами дал свои плоды - затратив достаточно времени Вы можете сами изобрести некое механическое устройство. Придуманный Вами предмет должен быть принципиально возможным в этом мире и должен опережать технический уровень общества не слишком сильно. Сложность проверки для попытки изобрести нечто определяется мастером. Теперь Вы можете разбирать чтобы изучить и магические предметы, а также Ваш бонус на починку и обезвреживание теперь распространяется и на магические устройства и ловушки. Вы можете создавать простые механические ловушки.",effect:{}},{text:"Теперь Вы можете изобретать и магические устройства и ловушки. Ваше глубокое понимание магии также даёт Вам значительный бонус к заклинаниям - теперь вызов заклинания основным действием всегда работает так, как будто Вы так же затратили один порыв.",effect:{}}]}]},{id:"community",name:"Общество",nameEn:"Community",description:"Социальные связи, лидерство, убеждение и дипломатия",characteristic:{name:"Харизма",nameEn:"Charisma",abbreviation:"CHA"},check:{name:"Влияние",nameEn:"Influence",description:"Проверки социального взаимодействия и убеждения"},mode:{name:"Выразительно",nameEn:"Expressive",icon:"game-icons:conversation",description:"Общайтесь открыто и убедительно",bonuses:[]},color:"#f59e0b",colorName:"amber",icon:"game-icons:human-pyramid",characteristicIcon:"game-icons:cheerful",checkIcon:"game-icons:caesar",position:{angle:90,corner:"right",description:"Правый угол шестиугольника"},neighbors:["knowledge","shadow"],opposite:"nature",axis:{id:"path",name:"Путь",nameEn:"Path",pole:"civilization"},traits:[{id:"everythingSells",name:"Всё продаётся",levels:[{text:"Вы тонко чувствуете потребности окружающих и что они готовы отдать за желаемое. Если Вы пытаетесь выяснить мотивацию персонажа или распознать ложь, Ваши проверки на две категории проще (6). Занимаясь любой работой, Вы можете подняться на одну ступень Богатства выше, чем остальные. Скорость набора Богатства, впрочем, остаётся прежней. Если Вы живёте в городе, Ваш уровень Богатства никогда не опускается ниже Среднего (5)",effect:{}},{text:"Продавая добычу после боевого похода Вы можете выручить на две категории больше. Занимаясь любой работой, Вы набираете Богатство вдвое быстрее других.",effect:{}},{text:"Один раз в месяц Вы можете покупать предмет выше своего уровня Богатства на 1 без затрат, либо на 2 уровня, потеряв при этом только один уровень Богатства",effect:{}}]},{id:"strongConnections",name:"Прочные связи",levels:[{text:"Большинство окружающих, которым Вы не чинили явного зла, считают Вас как минимум приятелем (Симпатия, 1). Вы знаете как найти выходы на всех влиятельных людей Вашего поселения, а также можете за несколько дней найти общих знакомых с специалистом какой-то профессии, если он есть в Вашем поселении. Вы можете давать взятки на одну категорию меньшие, чтобы добиться того же эффекта.",effect:{}},{text:"Проведя хотя бы три месяца в поселении, Вы обретаете влияние, с которым приходится считаться. Ваши просьбы и угрозы звучат гораздо весомее. Вам также значительно проще искать что-то в обществе - будь это скрывающийся человек или особый товар. Проверки проще на две категории (6). Даже если Вам не удаётся найти искомое, велика вероятность что Вам дадут хотя бы наводку на того, кто может знать ответ. Помогать Вам будут только те силы и фракции, с которыми Вы как минимум не враждуете. Затраты Влияния на значительные услуги снижены на одну категорию.",effect:{}},{text:"Если Вы проводите в поселении хотя бы полгода, Вам удаётся наладить контакт со всеми лидерами фракций (Значительное Влияние, 3) кроме тех что к Вам враждебны. Ваше Влияние на фракции растёт с удвоенной скоростью и никогда не опускается ниже Значительного (3). Когда Вы впервые посещаете поселения, которые активно контактируют с Вашим, Вы сразу получаете преимущества второго уровня этого умения. Преимущества третьего Вы можете получить, проведя в нём месяц. Вам легче внедрять свои задумки в другие фракции, ведь во всех (даже во враждебных) у Вас есть свои люди. Эти проверки проще на две категории.",effect:{}}]},{id:"friendOfAFriend",name:"Друг моего друга",levels:[{text:"Имея как минимум Высокое (5) влияние на фракцию, Вы можете попросить их порекомендовать Вас кому-то. При этом Вы потратите два уровня Репутации, но приобретёте один у цели. Для этого Ваша цель должна быть в хороших отношениях с фракцией.",effect:{}},{text:"Вам удаётся поддерживать связь даже со знакомыми в других поселениях и государствах. Вы можете найти знакомого или знакомого знакомого почти в любом крупном поселении. В результате Ваши проверки на Поиск в других поселениях проще на две категории. Кроме того, Вы получаете информацию и новости из далёких земель значительно раньше других.",effect:{}},{text:"Ваш круг знакомых и друзей превращается в настоящую паутину. Ваша Репутация у невраждебных фракций в других поселениях как минимум Неплохая (2), проверки на Порядок и Диверсию проще на категорию. Если Ваш уровень Богатства как минимум Зажиточный (7), проверки становятся проще ещё на одну категорию.",effect:{}}]}]},{id:"shadow",name:"Тень",nameEn:"Shadow",description:"Скрытность, обман, манипуляция и тайные действия",characteristic:{name:"Хитрость",nameEn:"Cunning",abbreviation:"CUN"},check:{name:"Коварство",nameEn:"Treachery",description:"Проверки скрытности, обмана и манипуляций"},mode:{name:"Скрытно",nameEn:"Stealthy",icon:"game-icons:ninja-mask",description:"Действуйте незаметно и осторожно",bonuses:[]},color:"#374151",colorName:"gray",icon:"game-icons:cowled",characteristicIcon:"game-icons:domino-mask",checkIcon:"game-icons:hooded-figure",position:{angle:150,corner:"bottom-right",description:"Нижний правый угол шестиугольника"},neighbors:["community","mysticism"],opposite:"war",axis:{id:"power",name:"Сила",nameEn:"Power",pole:"subtle"},traits:[{id:"cunningPlan",name:"Хитрый план",levels:[{text:"Один раз в месяц Вы можете добавить облегчить свою проверку социального Влияния, используя свою Хитрость. Сложность снижается на одну категорию за каждые три полные единицы в параметре Хитрость. Есть некая верятность, что местные власти сочтут Ваши действия незаконными.",effect:{}},{text:"Вы можете использовать эту способность два раза в месяц.",effect:{}},{text:"Теперь Вы можете использовать эту способность на проверках Диверсии",effect:{}}]},{id:"militaryCunning",name:"Военная хитрость",levels:[{text:"Проводя первую атаку по противнику за свой ход, Вы добавляете к броску кость порыва, не затрачивая порыв, если сразу после этого разрываете дистанцию (ближний бой) или скрываетесь из виду (дальний бой).",effect:{}},{text:"Вы учитесь использовать быстрый отскок - затратив один порыв, Вы можете отскочить назад на две клетки. Такое действие не вызывает срабатывания реакций.",effect:{}},{text:"В бою Вы можете двигаться боком с полной скоростью. Кроме того, если Вы видите как противник пытается атаковать Вас, Вы можете отреагировать за мгновение до этой атаки, если Ваша Защита превосходит его Атаку. Это распространяется даже на дистанционные атаки.",effect:{}}]},{id:"floatLikeButterfly",name:"Порхай как бабочка",levels:[{text:"Вы научились наносить невероятно точные удары. Максимальное количество костей порыва, которые Вы можете использовать в броске атаки увеличивается до двух.",effect:{}},{text:"Ваша скорость передвижения увеличивается на единицу. Доступное Вам максимальное количество порывов также увеличивается на единицу.",effect:{}},{text:"Идеальный способ обезопасить себя - закончить бой одним невероятно точным ударом. Максимальное количество костей порыва, которые Вы можете использовать в броске атаки увеличивается до трёх.",effect:{}}]}]},{id:"mysticism",name:"Мистика",nameEn:"Mysticism",description:"Магия, духовность, интуиция и связь с потусторонним",characteristic:{name:"Интуиция",nameEn:"Intuition",abbreviation:"INT"},check:{name:"Хаос",nameEn:"Chaos",description:"Проверки магии, интуиции и духовной связи"},mode:{name:"Чутко",nameEn:"Intuitive",icon:"game-icons:third-eye",description:"Доверьтесь интуиции и предчувствиям",bonuses:[]},color:"#9333ea",colorName:"purple",icon:"game-icons:pentacle",characteristicIcon:"game-icons:coiling-curl",checkIcon:"game-icons:small-fire",position:{angle:210,corner:"bottom-left",description:"Нижний левый угол шестиугольника"},neighbors:["shadow","nature"],opposite:"knowledge",axis:{id:"progress",name:"Развитие",nameEn:"Progress",pole:"intuitive"},traits:[{id:"spiritualPractices",name:"Духовные практики",levels:[{text:"Вы чувствуете мир иначе чем другие и можете находить связь там где другие её не увидят. Вы можете повысить любую характеристику на 1, пока следуете некоторой духовной практике. Это может быть аскеза, обет, небольшой ежедневный ритуал. Объясните, как эта практика мистически связана с пользой, которую Вы получаете. Вы начинаете получать преимущества когда использовали практику как минимум месяц.",effect:{}},{text:"Вы можете одновременно получать пользу от двух духовных практик направленных на две разные характеристики, или от одной более сложной, повышающей характеристику на 2. В обоих случаях это уже не может быть чем-то небольшим, никак не влияющим на Ваш уровень комфорта.",effect:{}},{text:"Погружаясь в практики всё дальше, Вы можете использовать 3 очков повышения, распределив их как угодно по трём характеристикам, выбирая значения 1, 2 или 3. Такой уровень погружения требует значительных затрат времени и ресурсов, может вызывать непонимание в обществе и иногда создавать значительные проблемы.",effect:{}}]},{id:"impossibleKnowledge",name:"Невозможные знания",levels:[{text:"Иногда Вы просто знаете то, чего никак не могли знать. В боевых ситуациях один раз в день Вы можете задать вопрос, в ответ на который Вам явится подсказка. Вопрос должен касаться того, с чем Вы взаимодействуете или как минимум находитесь на расстоянии нескольких минут движения пешком. Подсказка должна быть правдивой, но не всегда будет точно отвечать на Ваш вопрос, иногда лишь касаться его косвенно.",effect:{}},{text:"Вы научились взывать к таинственному источнику знаний вселенной и вне напряжённых боевых ситуаций. Затратив месяц на поиск и обучение, Вы можете получить навык чужого аспекта или класса по обычной цене, а своего аспекта или класса - на одно очко дешевле. Вы всё ещё не можете изучать противоположные аспекты и их классы.",effect:{}},{text:"Направляя свой взор всё глубже внутрь себя Вы получаете всё больше знаний из таинственного источника. Любая местность для Вас - как минимум Знакомая (3). Теперь Вы можете задавать вопрос мирозданию до трёх раз в боевую сцену или за месяц другой деятельности. Вы можете потратить использование такого вопроса чтобы получить информацию о слабых местах противника, снижая его защиту от Ваших будущих атак на две категории или о слабых местах фракции или организации чтобы облегчить проверки Порядка или Диверсии на две категории",effect:{}}]},{id:"dropsOfOneSea",name:"Капли одного моря",levels:[{text:"Вы чувствуете необъяснимое родство с другими разумными, даже если Ваши взгляды и цели расходятся. Иногда Вы ощущаете небольшие отблески их мыслей и чувств, и умеете воспользоваться этим себе на пользу. Окружающие оценивают это как удачу, но Вы точно знаете что это навык, доступный немногим. Если на Вашем кубе д12 выпадает 3 или меньше в вопросах связанных с разумными, один раз за боевую сцену или за месяц другой деятельности Вы можете его перебросить.",effect:{}},{text:"Теперь Вы ощущаете подобное родство даже с дикими животными. Количество использований навыка увеличено до двух, а помимо разумных он теперь распространяется на любых живых существ.",effect:{}},{text:"Вы чувствуете мир вокруг как своё продолжение. Всё вокруг - лишь разные узоры на волнах единого моря реальности. Количество использований навыка увеличено до трёх, теперь Вы можете использовать его в любых проверках, в том числе связанных с магией, стихиями, духами и прочим.",effect:{}}]}]},{id:"nature",name:"Природа",nameEn:"Nature",description:"Связь с природой, выживание, животные инстинкты и гармония",characteristic:{name:"Восприятие",nameEn:"Perception",abbreviation:"PER"},check:{name:"Поиск",nameEn:"Search",description:"Проверки наблюдательности, выживания и связи с природой"},mode:{name:"Внимательно",nameEn:"Watchful",icon:"game-icons:eagle-emblem",description:"Наблюдайте и замечайте детали",bonuses:[]},color:"#22c55e",colorName:"green",icon:"game-icons:curled-leaf",characteristicIcon:"game-icons:semi-closed-eye",checkIcon:"game-icons:spyglass",position:{angle:270,corner:"left",description:"Левый угол шестиугольника"},neighbors:["mysticism","war"],opposite:"community",axis:{id:"path",name:"Путь",nameEn:"Path",pole:"wilderness"},traits:[{id:"lawsOfExistence",name:"Законы бытия",levels:[{text:"Вы принимаете природу вокруг себя - и она отвечает Вам тем же. Вы можете комфортно жить и выживать в диких условиях, если там вообще могут выживать разумные Вашего вида. На это Вам нужно тратить всё своё время, но вы не нуждаетесь в припасах, добывая их самостоятельно, а Ваше снаряжение почти не ветшает. При этом Вы изучаете данную местность с удвоенной скоростью.",effect:{}},{text:"Вы можете комфортно выживать даже в агрессивных средах, где разумные Вашего вида не живут (пустыни, пещеры и прочее подобное), но не в тех, которые обусловлены магическими эффектами. В обычной дикой местности (такой как лес или степь) Вы теперь можете выживать, практически не тратя на это времени. Скорость освоения местности так же удвоена.",effect:{}},{text:"Глубоко понимая порядки каждой экосистемы, Вы мастерски находите в них место для себя. Вы можете комфортно выживать даже в магических аномалиях, если это вообще возможно для существа с Вашими способностями. Вы должны тратить всё своё время на это только до уровня Изученная (5). Магические аномалии Вы изучаете с обычной скоростью.",effect:{}}]},{id:"ingredientGathering",name:"Сбор ингредиентов",levels:[{text:"Если Ваш уровень знания местности хотя бы 5, Вы можете каждый ход выращивать или собирать одну меру качественных немагических ингредиентов, характерных для этой местности, потратив на это всё своё время.",effect:{}},{text:"Вы можете собирать ингредиенты, не затрачивая на это времени, если живёте в этой местности.",effect:{}},{text:"Вы можете собирать качественные магические ингредиенты, в количестве двух мер за один ход, если живёте в этой местности.",effect:{}}]},{id:"likeAFishInWater",name:"Как рыба в воде",levels:[{text:"Если Ваш уровень знания местности как минимум 3, Вы получаете дополнительную скорость передвижения в 1 клетку.",effect:{}},{text:"Если Ваш уровень знания местности как минимум 5, Вы можете проходить через сложную местность без дополнительных трат передвижения. Подходящие объекты Вы также можете использовать как укрытия или подспорье в бою",effect:{}},{text:"Если Ваш уровень знания местности как минимум 7, вы получаете дополнительный порыв, а обнаружить Вас сложнее на три категории (9)",effect:{}}]}]}],Na=[{id:"power",name:"Сила",nameEn:"Power",description:"Ось силы: от прямой физической мощи до скрытого влияния",aspects:["war","shadow"],poles:{active:{aspect:"war",description:"Прямое действие, открытая сила, доминирование"},subtle:{aspect:"shadow",description:"Скрытое влияние, манипуляция, тайные действия"}}},{id:"progress",name:"Развитие",nameEn:"Progress",description:"Ось развития: от рационального познания до интуитивного понимания",aspects:["knowledge","mysticism"],poles:{rational:{aspect:"knowledge",description:"Логика, наука, аналитическое мышление"},intuitive:{aspect:"mysticism",description:"Интуиция, магия, духовное познание"}}},{id:"path",name:"Путь",nameEn:"Path",description:"Ось пути: от дикой природы до цивилизованного общества",aspects:["nature","community"],poles:{wilderness:{aspect:"nature",description:"Природа, инстинкты, гармония с окружением"},civilization:{aspect:"community",description:"Общество, культура, социальные структуры"}}}],Oa={systemName:"triP",systemFullName:"Triple P System",systemDescription:"Система трёх осей: Power (Сила), Progress (Развитие), Path (Путь)",version:"1.0",aspectCount:6,axisCount:3,circularOrder:["war","knowledge","community","shadow","mysticism","nature"]},Yt={aspects:La,axes:Na,metadata:Oa},vo={};Yt.aspects.forEach(t=>{vo[t.id]=t});const Ha=t=>vo[t]||null,qa=t=>{var f,k,w,x,T,y;const l=(t==null?void 0:t.stats)||{},o=((f=t==null?void 0:t.combat)==null?void 0:f.wounds)||(t==null?void 0:t.wounds)||{};if(!o.scratch&&!o.light&&!o.heavy&&!o.deadly)return 0;const a={scratch:{current:typeof o.scratch=="number"?o.scratch:((k=o.scratch)==null?void 0:k.current)||0},light:{current:typeof o.light=="number"?o.light:((w=o.light)==null?void 0:w.current)||0},heavy:{current:typeof o.heavy=="number"?o.heavy:((x=o.heavy)==null?void 0:x.current)||0},deadly:{current:typeof o.deadly=="number"?o.deadly:((T=o.deadly)==null?void 0:T.current)||0}},r=((y=t==null?void 0:t.combat)==null?void 0:y.bonusDeadlySlots)||0,c=Us(l,r);return-ia(a,c)},Ua=t=>{let l=0;return l-=qa(t),l},Kn=(t,l)=>{const o=Ha(l);if(!o)return 0;const a=(t==null?void 0:t.stats)||{},r=a[l]||0,c=o.neighbors||[],f=a[c[0]]||0,k=a[c[1]]||0,w=a[o.opposite]||0,x=Math.floor(r+f/2+k/2),T=Math.floor(w/2),y=Math.max(x,T),B=Ua(t);return y+B},el={};Object.keys(en).forEach(t=>{Array.isArray(en[t])&&en[t].forEach(l=>{el[l.id]=l})});const Wa=t=>Kn(t,"shadow"),za=t=>{var o;const l=(o=t==null?void 0:t.equipment)==null?void 0:o.armor;return l&&el[l]||null},Va=(t,l,o)=>{var k,w;const a=((k=t==null?void 0:t.equipment)==null?void 0:k.activeSetIndex)??0,c=(((w=t==null?void 0:t.equipment)==null?void 0:w.weaponSets)||[])[a];if(!c||!c.weapons)return 0;let f=0;for(const x of c.weapons){const T=el[x];T&&(T.type==="shield"&&l==="front"&&(o==="melee"?f+=T.defenceMelee||0:o==="ranged"&&(f+=T.defenceRanged||0)),T.parry&&l==="front"&&o==="melee"&&(f+=T.parry||0))}return f},Dn=(t,l,o)=>{const a=Wa(t),r=Math.floor(a/2),c=za(t),f=(c==null?void 0:c.defence)||0,k=Va(t,l,o);let w=0,x=0;return l==="front"?(w=6,x=a):l==="flank"?(w=3,x=r):l==="back"&&(w=0,x=r),Math.max(0,w+x+f+k)},gs=(t,l)=>({front:Dn(t,"front",l),flank:Dn(t,"flank",l),back:Dn(t,"back",l)}),ss={3:{name:"Ниже простой",short:"НП",level:1,modifier:"below",color:"#00DDFF",lightText:!1,linetype:"dashed"},6:{name:"Простая",short:"П",level:1,modifier:"base",color:"#00DDFF",lightText:!1,linetype:"single"},9:{name:"Выше простой",short:"ВП",level:1,modifier:"above",color:"#00DDFF",lightText:!1,linetype:"double"},12:{name:"Ниже лёгкой",short:"НЛ",level:2,modifier:"below",color:"#00CC44",lightText:!1,linetype:"dashed"},15:{name:"Лёгкая",short:"Л",level:2,modifier:"base",color:"#00CC44",lightText:!1,linetype:"single"},18:{name:"Выше лёгкой",short:"ВЛ",level:2,modifier:"above",color:"#00CC44",lightText:!1,linetype:"double"},21:{name:"Ниже средней",short:"НС",level:3,modifier:"below",color:"#FFEE00",lightText:!1,linetype:"dashed"},24:{name:"Средняя",short:"С",level:3,modifier:"base",color:"#FFEE00",lightText:!1,linetype:"single"},27:{name:"Выше средней",short:"ВС",level:3,modifier:"above",color:"#FFEE00",lightText:!1,linetype:"double"},30:{name:"Ниже тяжёлой",short:"НТ",level:4,modifier:"below",color:"#FF8800",lightText:!1,linetype:"dashed"},33:{name:"Тяжёлая",short:"Т",level:4,modifier:"base",color:"#FF8800",lightText:!1,linetype:"single"},36:{name:"Выше тяжёлой",short:"ВТ",level:4,modifier:"above",color:"#FF8800",lightText:!1,linetype:"double"},39:{name:"Ниже жестокой",short:"НЖ",level:5,modifier:"below",color:"#CC0000",lightText:!0,linetype:"dashed"},42:{name:"Жестокая",short:"Ж",level:5,modifier:"base",color:"#CC0000",lightText:!0,linetype:"single"},45:{name:"Выше жестокой",short:"ВЖ",level:5,modifier:"above",color:"#CC0000",lightText:!0,linetype:"double"},48:{name:"Ниже кошмарной",short:"НК",level:6,modifier:"below",color:"#440066",lightText:!0,linetype:"dashed"},51:{name:"Кошмарная",short:"К",level:6,modifier:"base",color:"#440066",lightText:!0,linetype:"single"},54:{name:"Выше кошмарной",short:"ВК",level:6,modifier:"above",color:"#440066",lightText:!0,linetype:"double"},60:{name:"Невозможная",short:"Н",level:7,modifier:"base",color:"#000000",lightText:!0,linetype:"single"}},es=t=>{const l="/TriP/";return t.startsWith("/")?l.endsWith("/")?l+t.slice(1):l+t:l.endsWith("/")?l+t:l+"/"+t},Qa=t=>es(`/images/presets/${t}.png`),R_=t=>es(`/images/classes/${t}.png`),Jt=t=>es(`/images/items/${t}.png`),F_=(t,l,o="base")=>es(`/images/races/${t}/${l}/${o}.png`),L_=t=>es(`/images/gender/${t}.png`),Hs=new Map,as=t=>t==null?null:typeof t=="number"?es(`/images/presets/${t}.png`):typeof t!="string"?es(`/images/presets/${String(t)}.png`):t.startsWith("http://")||t.startsWith("https://")||t.startsWith("data:")||t.startsWith("blob:")?t:t.startsWith("/")?es(t):es(`/images/presets/${t}.png`),fo=t=>{if(!t)return Promise.resolve(null);if(Hs.has(t))return Promise.resolve(Hs.get(t));const l=t.startsWith("http://")||t.startsWith("https://"),o=t.startsWith("data:")||t.startsWith("blob:");return new Promise((a,r)=>{const c=new Image,f=()=>{const k=new Image;k.onload=()=>{Hs.set(t,k),a(k)},k.onerror=()=>{console.warn("Failed to load image (no CORS):",t),a(null)},k.src=t};o||(c.crossOrigin="anonymous"),c.onload=()=>{Hs.set(t,c),a(c)},c.onerror=k=>{l?(console.warn("CORS failed for image, trying without:",t),f()):(console.warn("Failed to load image:",t,k),a(null))},c.src=t})},ja=async t=>{const l=t.filter(o=>{var a;return(a=o.character)==null?void 0:a.portrait}).map(o=>{const a=as(o.character.portrait);return fo(a).catch(()=>null)});await Promise.all(l)},Rl=t=>{const l=Object.entries(ss.default||ss).map(([a,r])=>({value:parseInt(a),...r})).filter(a=>a.value>=0).sort((a,r)=>a.value-r.value);let o=l[0];for(const a of l)if(a.value<=t)o=a;else break;return o},vs=(t,l,o,a)=>{const r=(a-90)*Math.PI/180;return{x:t+o*Math.cos(r),y:l+o*Math.sin(r)}},_n=(t,l,o,a,r,c,f,k)=>{var x;t.save();const w=as(r);if(t.beginPath(),t.arc(l,o,a,0,Math.PI*2),t.clip(),t.fillStyle="#1e293b",t.fill(),w&&Hs.has(w)){const T=Hs.get(w),y=T.width/T.height;let B,m,Y,j;y>1?(m=a*2,B=m*y,Y=l-B/2,j=o-a):(B=a*2,m=B/y,Y=l-a,j=o-m/2),t.drawImage(T,Y,j,B,m)}else t.fillStyle="#64748b",t.font=`bold ${a}px sans-serif`,t.textAlign="center",t.textBaseline="middle",t.fillText(((x=c==null?void 0:c.charAt(0))==null?void 0:x.toUpperCase())||"?",l,o);if(f&&k&&f.heavy>0){const T=k.heavy.base+k.heavy.bonus,y=f.heavy/T*.7,B=t.createLinearGradient(l,o+a,l,o-a);B.addColorStop(0,"rgba(220, 38, 38, 0.8)"),B.addColorStop(y,"rgba(220, 38, 38, 0.4)"),B.addColorStop(y+.01,"transparent"),t.fillStyle=B,t.fillRect(l-a,o-a,a*2,a*2)}if(f&&k&&f.deadly>0){const T=k.deadly.base+k.deadly.bonus,y=f.deadly/T;if(y>=1)t.fillStyle="rgba(0, 0, 0, 0.7)",t.fillRect(l-a,o-a,a*2,a*2);else{const B=t.createRadialGradient(l,o,0,l,o,a);B.addColorStop(0,"transparent"),B.addColorStop(.7,"transparent"),B.addColorStop(1,`rgba(220, 38, 38, ${.3+y*.5})`),t.fillStyle=B,t.fillRect(l-a,o-a,a*2,a*2)}}t.restore(),t.beginPath(),t.arc(l,o,a,0,Math.PI*2),t.strokeStyle="rgba(255, 255, 255, 0.3)",t.lineWidth=2,t.stroke()},tl=(t,l,o,a,r,c)=>{if(!r||!c||r.scratch===0)return;const f=c.scratch.base+c.scratch.bonus,k=r.scratch,w=10,x=(360-f*w)/f,y=180-(k*x+(k-1)*w)/2,B=a+4;t.strokeStyle="#fbbf24",t.lineWidth=2,t.lineCap="round";for(let m=0;m<k;m++){const Y=y+m*(x+w),j=(Y-90)*Math.PI/180,F=(Y+x-90)*Math.PI/180;t.beginPath(),t.arc(l,o,B,j,F),t.stroke()}},sl=(t,l,o,a,r,c)=>{if(!r||!c||r.light===0)return;const f=r.light,k=25,w=a*.1,T=90+(f-1)*k/2;t.fillStyle="#dc2626";for(let y=0;y<f;y++){const m=(T-y*k)*Math.PI/180;t.beginPath(),t.arc(l+a*Math.cos(m),o+a*Math.sin(m),w,0,Math.PI*2),t.fill()}},Fl=(t,l,o,a,r,c,f=0,k="left")=>{if(!c)return;const w=c.color||"#FFFFFF",x=c.linetype||"single";let T;k==="left"?T={top:0,upper:300,lower:240,bottom:180}:T={top:0,upper:60,lower:120,bottom:180};const y=vs(l,o,a,T.top+f),B=vs(l,o,a,T.upper+f),m=vs(l,o,a,T.lower+f),Y=vs(l,o,a,T.bottom+f);let j,F;if(r==="front")j=y,F=B;else if(r==="flank")j=B,F=m;else if(r==="back")j=m,F=Y;else return;if(t.lineCap="butt",t.strokeStyle=w,x==="dashed")t.setLineDash([4,5]),t.lineWidth=1.5,t.beginPath(),t.moveTo(j.x,j.y),t.lineTo(F.x,F.y),t.stroke(),t.setLineDash([]);else if(x==="double"){t.lineWidth=1.5,t.beginPath(),t.moveTo(j.x,j.y),t.lineTo(F.x,F.y),t.stroke();const ie=a+1.5,W=vs(l,o,ie,(r==="front"?T.top:r==="flank"?T.upper:T.lower)+f),S=vs(l,o,ie,(r==="front"?T.upper:r==="flank"?T.lower:T.bottom)+f);t.setLineDash([4,5]),t.lineWidth=1.5,t.beginPath(),t.moveTo(W.x,W.y),t.lineTo(S.x,S.y),t.stroke(),t.setLineDash([])}else t.lineWidth=1.5,t.beginPath(),t.moveTo(j.x,j.y),t.lineTo(F.x,F.y),t.stroke()},Ll=(t,l,o,a,r,c,f=0,k="left")=>{if(!c)return;const w=c.color||"#FFFFFF",x=c.linetype||"single";let T,y;if(k==="left")if(r==="front")T=300,y=360;else if(r==="flank")T=240,y=300;else if(r==="back")T=180,y=240;else return;else if(r==="front")T=0,y=60;else if(r==="flank")T=60,y=120;else if(r==="back")T=120,y=180;else return;T+=f,y+=f;const B=(T-90)*Math.PI/180,m=(y-90)*Math.PI/180;t.lineCap="butt",t.strokeStyle=w,x==="dashed"?(t.setLineDash([4,5]),t.lineWidth=1.5,t.beginPath(),t.arc(l,o,a,B,m),t.stroke(),t.setLineDash([])):x==="double"?(t.lineWidth=1.5,t.beginPath(),t.arc(l,o,a,B,m),t.stroke(),t.setLineDash([4,5]),t.lineWidth=1.5,t.beginPath(),t.arc(l,o,a+1.5,B,m),t.stroke(),t.setLineDash([])):(t.lineWidth=1.5,t.beginPath(),t.arc(l,o,a,B,m),t.stroke())},nl=(t,l,o,a,r,c,f=0,k={})=>{const{bothSides:w=!1}=k,x=a+14,T=x+6;if(r)for(const y of["front","flank","back"]){const B=r[y];if(B!=null){const m=Rl(B);Fl(t,l,o,x,y,m,f,"left"),w&&Fl(t,l,o,x,y,m,f,"right")}}if(c)for(const y of["front","flank","back"]){const B=c[y];if(B!=null){const m=Rl(B);Ll(t,l,o,T,y,m,f,"left"),w&&Ll(t,l,o,T,y,m,f,"right")}}},Ao=(t,l,o,a,r=0)=>{const c=vs(l,o,a+8,r),f=vs(l,o,a,r-15),k=vs(l,o,a,r+15);t.beginPath(),t.moveTo(c.x,c.y),t.lineTo(f.x,f.y),t.lineTo(k.x,k.y),t.closePath(),t.fillStyle="rgba(250, 204, 21, 0.9)",t.fill(),t.strokeStyle="rgba(0, 0, 0, 0.5)",t.lineWidth=1,t.stroke()},Ga=(t,l,o={})=>{var S,Z;const{tokenSize:a=48,isHovered:r=!1,isSelected:c=!1,canSeeDefence:f=!1,facingOffset:k=0}=o,{character:w,pixelX:x,pixelY:T,facing:y=0,meleeDefence:B,rangedDefence:m}=l;if(!w)return;const Y=x,j=T,F=a/2,ie=y*30+k;if((r||c)&&f&&(B||m)){const K=(S=w.combat)==null?void 0:S.wounds,X=w.woundSlots||(w.stats?Us(w.stats,((Z=w.combat)==null?void 0:Z.bonusDeadlySlots)||0):null);ho(t,Y,j,F,ie,c,r),nl(t,Y,j,F,B,m,ie,{bothSides:!0}),_n(t,Y,j,F,w.portrait,w.name,K,X),K&&X&&(tl(t,Y,j,F,K,X),sl(t,Y,j,F,K,X));const U=F+28;Ao(t,Y,j,U,ie)}},po=(t,l,o={})=>{var U,D;const{tokenSize:a=48,showDefence:r=!1,showFacing:c=!0,isHovered:f=!1,isSelected:k=!1,canSeeDefence:w=!1,facingOffset:x=0}=o,{character:T,pixelX:y,pixelY:B,facing:m=0,meleeDefence:Y,rangedDefence:j}=l;if(!T)return;const F=y,ie=B,W=a/2,S=m*30+x,Z=(U=T.combat)==null?void 0:U.wounds,K=T.woundSlots||(T.stats?Us(T.stats,((D=T.combat)==null?void 0:D.bonusDeadlySlots)||0):null),X=(f||k)&&w&&(Y||j);if(X&&ho(t,F,ie,W,S,k,f),_n(t,F,ie,W,T.portrait,T.name,Z,K),Z&&K&&(tl(t,F,ie,W,Z,K),sl(t,F,ie,W,Z,K)),X&&nl(t,F,ie,W,Y,j,S,{bothSides:!0}),c){const b=W+(X?28:8);Ao(t,F,ie,b,S)}},ho=(t,l,o,a,r=0,c=!1,f=!1)=>{t.save();const k=a+35,w=t.createRadialGradient(l,o,a-5,l,o,k);c?(w.addColorStop(0,"rgba(45, 35, 15, 0.95)"),w.addColorStop(.6,"rgba(35, 28, 12, 0.85)"),w.addColorStop(1,"rgba(25, 20, 8, 0)")):f?(w.addColorStop(0,"rgba(15, 30, 45, 0.95)"),w.addColorStop(.6,"rgba(12, 25, 38, 0.85)"),w.addColorStop(1,"rgba(8, 18, 28, 0)")):(w.addColorStop(0,"rgba(15, 23, 42, 0.95)"),w.addColorStop(.6,"rgba(15, 23, 42, 0.85)"),w.addColorStop(1,"rgba(15, 23, 42, 0)")),t.beginPath(),t.arc(l,o,k,0,Math.PI*2),t.fillStyle=w,t.fill(),t.beginPath(),t.arc(l,o,k-2,0,Math.PI*2),c?t.strokeStyle="rgba(250, 204, 21, 0.4)":f?t.strokeStyle="rgba(56, 189, 248, 0.4)":t.strokeStyle="rgba(148, 163, 184, 0.3)",t.lineWidth=1,t.stroke(),t.restore()},Ya=(t,l,o={})=>{const{hoveredTokenId:a=null,selectedTokenId:r=null,currentUserId:c=null,isMaster:f=!1,draggingTokenId:k=null,facingOffset:w=0}=o,x=l.map(y=>{var W,S,Z;const B=y.id===a||y.characterId===a,m=y.id===r||y.characterId===r,Y=y.id===k||y.characterId===k,j=((W=y.character)==null?void 0:W.ownerId)===c,F=((Z=(S=y.character)==null?void 0:S.combat)==null?void 0:Z.showDefenceToOthers)||!1;return{token:y,isHovered:B,isSelected:m,isDragging:Y,canSeeDefence:f||j||F}});for(const{token:y,isHovered:B,isSelected:m,isDragging:Y,canSeeDefence:j}of x)Y&&(t.save(),t.globalAlpha=.7),po(t,y,{...o,isHovered:!1,isSelected:!1,canSeeDefence:j}),Y&&t.restore();const T=x.filter(y=>y.isHovered||y.isSelected);T.sort((y,B)=>y.isHovered&&!B.isHovered?1:!y.isHovered&&B.isHovered?-1:0);for(const{token:y,isHovered:B,isSelected:m,canSeeDefence:Y}of T)Ga(t,y,{...o,isHovered:B,isSelected:m,canSeeDefence:Y})},Xa=(t,l,o,a)=>{const r=t-o.pixelX,c=l-o.pixelY,f=a/2;return r*r+c*c<=f*f},Ls=(t,l,o,a)=>{for(let r=o.length-1;r>=0;r--){const c=o[r];if(Xa(t,l,c,a))return c}return null},ms=(t,l,o)=>({x:(t-o.x)/o.zoom,y:(l-o.y)/o.zoom}),zt=(t,l)=>{const o=t.__vccOpts||t;for(const[a,r]of l)o[a]=r;return o},Za={class:"fill-profile-panel flex flex-col h-full bg-slate-800 text-white"},Ja={class:"flex items-center justify-between px-3 py-2 border-b border-white/10"},Ka={class:"flex border-b border-white/10"},ei=["onClick"],ti={class:"flex-1 overflow-y-auto p-3"},si={class:"space-y-2"},ni={class:"flex items-center justify-between mb-2"},li={class:"flex gap-1"},oi={key:0,class:"p-2 bg-slate-700/50 rounded-lg mb-2"},ai={class:"flex gap-1"},ii=["onClick"],ri={class:"flex items-center justify-between"},ci={class:"text-sm font-medium"},di={class:"text-xs text-slate-400"},ui=["onClick"],mi={key:1,class:"text-center text-slate-500 text-xs py-4"},vi={key:0,class:"mt-4 pt-4 border-t border-white/10"},fi={class:"grid grid-cols-5 gap-1 max-h-32 overflow-y-auto"},Ai=["title","onClick"],pi={key:1,class:"space-y-2"},hi={class:"flex items-center justify-between mb-2"},gi={class:"text-xs text-slate-400"},yi=["onClick"],bi={class:"flex items-center gap-2"},ki=["checked","onChange"],xi={class:"text-sm"},wi={class:"flex items-center gap-1"},Ci={class:"text-xs text-slate-400"},$i=["onClick"],_i={key:0,class:"mt-3 pt-3 border-t border-white/10 space-y-3"},Ti=["value","onInput"],Ii={class:"grid grid-cols-6 gap-1 mt-1 max-h-24 overflow-y-auto"},Si=["title","onClick"],Ei={class:"flex items-center justify-between"},Pi={class:"text-xs text-sky-400"},Mi=["value","onInput"],Di={class:"flex items-center justify-between"},Bi={class:"text-xs text-sky-400"},Ri={class:"flex items-center gap-2 text-[10px] text-slate-500"},Fi=["value","onInput"],Li={class:"flex items-center justify-between mb-1"},Ni=["onClick"],Oi={key:0,class:"text-xs text-slate-500 italic"},Hi=["value","onChange"],qi=["value"],Ui=["value","onChange"],Wi=["value"],zi=["value","onInput"],Vi=["onClick"],Qi={key:0,class:"text-center text-slate-500 text-xs py-4"},ji={key:2,class:"text-center py-8"},Gi={key:3,class:"text-center text-slate-500 text-xs py-8"},Yi={key:0,class:"p-3 border-t border-white/10"},Xi={__name:"FillProfilePanel",emits:["apply","preview","close"],setup(t,{emit:l}){const o=l,a=wn(),r=an(),{profiles:c,currentProfile:f,sortedProfiles:k}=jt(a),w=R("profile"),x=R(null),T=R(!1),y=R(""),B=ne(()=>[...r.baseTerrains,...r.customTerrains]),m=he=>B.value.find(M=>M.id===he)||{name:he,color:"#888"},Y=()=>{y.value.trim()&&(a.createProfile({name:y.value.trim()}),y.value="",T.value=!1)},j=he=>{a.selectProfile(he),x.value=null},F=he=>{confirm("Удалить профиль?")&&a.deleteProfile(he)},ie=()=>{var M;if(!f.value)return;const he=a.addLayer(f.value.id,{name:`Слой ${(((M=f.value.layers)==null?void 0:M.length)||0)+1}`});he&&(x.value=he.id,w.value="layers")},W=he=>{f.value&&(a.removeLayer(f.value.id,he),x.value===he&&(x.value=null))},S=(he,M,de)=>{f.value&&a.updateLayer(f.value.id,he,{[M]:de})},Z=he=>{f.value&&a.updateProfile(f.value.id,{baseTerrain:he})},K=he=>{f.value&&a.addCondition(f.value.id,he,{type:_t.NONE})},X=(he,M)=>{f.value&&a.removeCondition(f.value.id,he,M)},U=()=>{f.value&&o("apply",f.value)},D=()=>{f.value&&o("preview",f.value)},b=()=>{a.createDefaultProfile()},d={[_t.NONE]:"Без условия",[_t.TERRAIN_ID]:"Террейн",[_t.TERRAIN_BIOME]:"Биом",[_t.VISIBILITY]:"Видимость",[_t.MOVEMENT_COST]:"Проходимость",[_t.MELEE_ADVANTAGE]:"Бонус ближ. боя",[_t.TAG]:"Тег"},oe={[Ot.EQUALS]:"=",[Ot.NOT_EQUALS]:"≠",[Ot.GREATER]:">",[Ot.GREATER_EQUALS]:"≥",[Ot.LESS]:"<",[Ot.LESS_EQUALS]:"≤",[Ot.CONTAINS]:"содержит"};return(he,M)=>{var de;return s(),n("div",Za,[e("header",Ja,[M[5]||(M[5]=e("h3",{class:"text-sm font-medium"},"Профили заливки",-1)),e("button",{type:"button",class:"text-slate-400 hover:text-white transition",onClick:M[0]||(M[0]=H=>o("close"))}," ✕ ")]),e("div",Ka,[(s(),n(ee,null,me([{id:"profile",label:"📋 Профиль"},{id:"layers",label:"📚 Слои"},{id:"preview",label:"👁 Превью"}],H=>e("button",{key:H.id,type:"button",class:Q(["flex-1 px-3 py-2 text-xs transition",w.value===H.id?"bg-sky-500/20 text-sky-400 border-b-2 border-sky-400":"text-slate-400 hover:text-white hover:bg-white/5"]),onClick:z=>w.value=H.id},h(H.label),11,ei)),64))]),e("div",ti,[w.value==="profile"?(s(),n(ee,{key:0},[e("div",si,[e("div",ni,[M[6]||(M[6]=e("span",{class:"text-xs text-slate-400"},"Сохранённые профили",-1)),e("div",li,[e("button",{type:"button",class:"px-2 py-1 text-xs bg-sky-500/20 text-sky-400 rounded hover:bg-sky-500/30 transition",onClick:M[1]||(M[1]=H=>T.value=!0)}," + Новый "),i(c).length===0?(s(),n("button",{key:0,type:"button",class:"px-2 py-1 text-xs bg-emerald-500/20 text-emerald-400 rounded hover:bg-emerald-500/30 transition",onClick:b}," Пример ")):_("",!0)])]),T.value?(s(),n("div",oi,[De(e("input",{"onUpdate:modelValue":M[2]||(M[2]=H=>y.value=H),type:"text",placeholder:"Название профиля...",class:"w-full px-2 py-1 text-xs bg-slate-900/50 border border-white/10 rounded mb-2 focus:outline-none focus:border-sky-400/50",onKeyup:ks(Y,["enter"])},null,544),[[je,y.value]]),e("div",ai,[e("button",{type:"button",class:"flex-1 px-2 py-1 text-xs bg-sky-500 text-white rounded hover:bg-sky-600 transition",onClick:Y}," Создать "),e("button",{type:"button",class:"px-2 py-1 text-xs text-slate-400 hover:text-white transition",onClick:M[3]||(M[3]=H=>{T.value=!1,y.value=""})}," Отмена ")])])):_("",!0),(s(!0),n(ee,null,me(i(k),H=>{var z,q;return s(),n("div",{key:H.id,class:Q(["p-2 rounded-lg border transition cursor-pointer",((z=i(f))==null?void 0:z.id)===H.id?"bg-sky-500/20 border-sky-400/60":"bg-slate-700/30 border-white/10 hover:border-white/20"]),onClick:Ie=>j(H.id)},[e("div",ri,[e("div",null,[e("div",ci,h(H.name),1),e("div",di,h(((q=H.layers)==null?void 0:q.length)||0)+" слоёв • База: "+h(m(H.baseTerrain).name),1)]),e("button",{type:"button",class:"p-1 text-slate-400 hover:text-red-400 transition",onClick:lt(Ie=>F(H.id),["stop"])}," 🗑 ",8,ui)])],10,ii)}),128)),i(c).length===0?(s(),n("div",mi," Нет сохранённых профилей ")):_("",!0)]),i(f)?(s(),n("div",vi,[M[7]||(M[7]=e("div",{class:"text-xs text-slate-400 mb-2"},"Базовый террейн",-1)),e("div",fi,[(s(!0),n(ee,null,me(B.value,H=>(s(),n("button",{key:H.id,type:"button",class:Q(["w-10 h-10 rounded border transition",i(f).baseTerrain===H.id?"border-sky-400 ring-2 ring-sky-400/50":"border-white/10 hover:border-white/30"]),style:Qe({backgroundColor:H.color||"#888"}),title:H.name,onClick:z=>Z(H.id)},null,14,Ai))),128))])])):_("",!0)],64)):_("",!0),w.value==="layers"&&i(f)?(s(),n("div",pi,[e("div",hi,[e("span",gi,'Слои профиля "'+h(i(f).name)+'"',1),e("button",{type:"button",class:"px-2 py-1 text-xs bg-sky-500/20 text-sky-400 rounded hover:bg-sky-500/30 transition",onClick:ie}," + Слой ")]),(s(!0),n(ee,null,me(i(f).layers,H=>{var z;return s(),n("div",{key:H.id,class:Q(["p-2 rounded-lg border transition",x.value===H.id?"bg-sky-500/10 border-sky-400/60":"bg-slate-700/30 border-white/10"])},[e("div",{class:"flex items-center justify-between cursor-pointer",onClick:q=>x.value=x.value===H.id?null:H.id},[e("div",bi,[e("input",{type:"checkbox",checked:H.enabled,class:"rounded",onClick:M[4]||(M[4]=lt(()=>{},["stop"])),onChange:q=>S(H.id,"enabled",q.target.checked)},null,40,ki),e("span",{class:"w-4 h-4 rounded",style:Qe({backgroundColor:m(H.terrainId).color||"#888"})},null,4),e("span",xi,h(H.name),1)]),e("div",wi,[e("span",Ci,h(H.density)+"%",1),e("button",{type:"button",class:"p-1 text-slate-400 hover:text-red-400 transition",onClick:lt(q=>W(H.id),["stop"])}," ✕ ",8,$i)])],8,yi),x.value===H.id?(s(),n("div",_i,[e("div",null,[M[8]||(M[8]=e("label",{class:"text-xs text-slate-400"},"Название",-1)),e("input",{value:H.name,type:"text",class:"w-full px-2 py-1 text-xs bg-slate-900/50 border border-white/10 rounded mt-1 focus:outline-none focus:border-sky-400/50",onInput:q=>S(H.id,"name",q.target.value)},null,40,Ti)]),e("div",null,[M[9]||(M[9]=e("label",{class:"text-xs text-slate-400"},"Террейн",-1)),e("div",Ii,[(s(!0),n(ee,null,me(B.value,q=>(s(),n("button",{key:q.id,type:"button",class:Q(["w-8 h-8 rounded border transition",H.terrainId===q.id?"border-sky-400 ring-2 ring-sky-400/50":"border-white/10 hover:border-white/30"]),style:Qe({backgroundColor:q.color||"#888"}),title:q.name,onClick:Ie=>S(H.id,"terrainId",q.id)},null,14,Si))),128))])]),e("div",null,[e("div",Ei,[M[10]||(M[10]=e("label",{class:"text-xs text-slate-400"},"Плотность",-1)),e("span",Pi,h(H.density)+"%",1)]),e("input",{value:H.density,type:"range",min:"0",max:"100",class:"w-full mt-1",onInput:q=>S(H.id,"density",Number(q.target.value))},null,40,Mi)]),e("div",null,[e("div",Di,[M[11]||(M[11]=e("label",{class:"text-xs text-slate-400"},"Группировка",-1)),e("span",Bi,h(H.clustering)+"%",1)]),e("div",Ri,[M[12]||(M[12]=e("span",null,"Разброс",-1)),e("input",{value:H.clustering,type:"range",min:"0",max:"100",class:"flex-1",onInput:q=>S(H.id,"clustering",Number(q.target.value))},null,40,Fi),M[13]||(M[13]=e("span",null,"Кластеры",-1))])]),e("div",null,[e("div",Li,[M[14]||(M[14]=e("label",{class:"text-xs text-slate-400"},"Условия",-1)),e("button",{type:"button",class:"text-xs text-sky-400 hover:text-sky-300",onClick:q=>K(H.id)}," + Условие ",8,Ni)]),((z=H.conditions)==null?void 0:z.length)===0?(s(),n("div",Oi," Нет условий (применяется везде) ")):_("",!0),(s(!0),n(ee,null,me(H.conditions,q=>(s(),n("div",{key:q.id,class:"flex items-center gap-1 mt-1 p-1 bg-slate-900/30 rounded text-xs"},[e("select",{value:q.type,class:"flex-1 px-1 py-0.5 bg-slate-800 border border-white/10 rounded text-xs",onChange:Ie=>i(a).updateLayer(i(f).id,H.id,{conditions:H.conditions.map(C=>C.id===q.id?{...C,type:Ie.target.value}:C)})},[(s(),n(ee,null,me(d,(Ie,C)=>e("option",{key:C,value:C},h(Ie),9,qi)),64))],40,Hi),q.type!==i(_t).NONE?(s(),n("select",{key:0,value:q.operator,class:"px-1 py-0.5 bg-slate-800 border border-white/10 rounded text-xs",onChange:Ie=>i(a).updateLayer(i(f).id,H.id,{conditions:H.conditions.map(C=>C.id===q.id?{...C,operator:Ie.target.value}:C)})},[(s(),n(ee,null,me(oe,(Ie,C)=>e("option",{key:C,value:C},h(Ie),9,Wi)),64))],40,Ui)):_("",!0),q.type!==i(_t).NONE?(s(),n("input",{key:1,value:q.value,type:"text",placeholder:"значение",class:"w-16 px-1 py-0.5 bg-slate-800 border border-white/10 rounded text-xs",onInput:Ie=>i(a).updateLayer(i(f).id,H.id,{conditions:H.conditions.map(C=>C.id===q.id?{...C,value:Ie.target.value}:C)})},null,40,zi)):_("",!0),e("button",{type:"button",class:"text-slate-400 hover:text-red-400",onClick:Ie=>X(H.id,q.id)}," ✕ ",8,Vi)]))),128))])])):_("",!0)],2)}),128)),(de=i(f).layers)!=null&&de.length?_("",!0):(s(),n("div",Qi," Добавьте слои для настройки заливки "))])):_("",!0),w.value==="preview"&&i(f)?(s(),n("div",ji,[M[15]||(M[15]=e("div",{class:"text-slate-400 text-sm mb-4"},' Выделите область на карте и нажмите "Превью" чтобы увидеть результат ',-1)),e("button",{type:"button",class:"px-4 py-2 bg-amber-500/20 text-amber-400 rounded-lg hover:bg-amber-500/30 transition",onClick:D}," 👁 Показать превью ")])):_("",!0),!i(f)&&w.value!=="profile"?(s(),n("div",Gi," Выберите или создайте профиль ")):_("",!0)]),i(f)?(s(),n("footer",Yi,[e("button",{type:"button",class:"w-full py-2 bg-emerald-500 text-white rounded-lg font-medium hover:bg-emerald-600 transition",onClick:U}," 🎲 Применить к выделению ")])):_("",!0)])}}},Zi=zt(Xi,[["__scopeId","data-v-db9db805"]]),go=/^[a-z0-9]+(-[a-z0-9]+)*$/,Tn=(t,l,o,a="")=>{const r=t.split(":");if(t.slice(0,1)==="@"){if(r.length<2||r.length>3)return null;a=r.shift().slice(1)}if(r.length>3||!r.length)return null;if(r.length>1){const k=r.pop(),w=r.pop(),x={provider:r.length>0?r[0]:a,prefix:w,name:k};return l&&!yn(x)?null:x}const c=r[0],f=c.split("-");if(f.length>1){const k={provider:a,prefix:f.shift(),name:f.join("-")};return l&&!yn(k)?null:k}if(o&&a===""){const k={provider:a,prefix:"",name:c};return l&&!yn(k,o)?null:k}return null},yn=(t,l)=>t?!!((l&&t.prefix===""||t.prefix)&&t.name):!1,yo=Object.freeze({left:0,top:0,width:16,height:16}),xn=Object.freeze({rotate:0,vFlip:!1,hFlip:!1}),In=Object.freeze({...yo,...xn}),Wn=Object.freeze({...In,body:"",hidden:!1});function Ji(t,l){const o={};!t.hFlip!=!l.hFlip&&(o.hFlip=!0),!t.vFlip!=!l.vFlip&&(o.vFlip=!0);const a=((t.rotate||0)+(l.rotate||0))%4;return a&&(o.rotate=a),o}function Nl(t,l){const o=Ji(t,l);for(const a in Wn)a in xn?a in t&&!(a in o)&&(o[a]=xn[a]):a in l?o[a]=l[a]:a in t&&(o[a]=t[a]);return o}function Ki(t,l){const o=t.icons,a=t.aliases||Object.create(null),r=Object.create(null);function c(f){if(o[f])return r[f]=[];if(!(f in r)){r[f]=null;const k=a[f]&&a[f].parent,w=k&&c(k);w&&(r[f]=[k].concat(w))}return r[f]}return Object.keys(o).concat(Object.keys(a)).forEach(c),r}function er(t,l,o){const a=t.icons,r=t.aliases||Object.create(null);let c={};function f(k){c=Nl(a[k]||r[k],c)}return f(l),o.forEach(f),Nl(t,c)}function bo(t,l){const o=[];if(typeof t!="object"||typeof t.icons!="object")return o;t.not_found instanceof Array&&t.not_found.forEach(r=>{l(r,null),o.push(r)});const a=Ki(t);for(const r in a){const c=a[r];c&&(l(r,er(t,r,c)),o.push(r))}return o}const tr={provider:"",aliases:{},not_found:{},...yo};function Bn(t,l){for(const o in l)if(o in t&&typeof t[o]!=typeof l[o])return!1;return!0}function ko(t){if(typeof t!="object"||t===null)return null;const l=t;if(typeof l.prefix!="string"||!t.icons||typeof t.icons!="object"||!Bn(t,tr))return null;const o=l.icons;for(const r in o){const c=o[r];if(!r||typeof c.body!="string"||!Bn(c,Wn))return null}const a=l.aliases||Object.create(null);for(const r in a){const c=a[r],f=c.parent;if(!r||typeof f!="string"||!o[f]&&!a[f]||!Bn(c,Wn))return null}return l}const Ol=Object.create(null);function sr(t,l){return{provider:t,prefix:l,icons:Object.create(null),missing:new Set}}function qs(t,l){const o=Ol[t]||(Ol[t]=Object.create(null));return o[l]||(o[l]=sr(t,l))}function xo(t,l){return ko(l)?bo(l,(o,a)=>{a?t.icons[o]=a:t.missing.add(o)}):[]}function nr(t,l,o){try{if(typeof o.body=="string")return t.icons[l]={...o},!0}catch{}return!1}let tn=!1;function wo(t){return typeof t=="boolean"&&(tn=t),tn}function lr(t){const l=typeof t=="string"?Tn(t,!0,tn):t;if(l){const o=qs(l.provider,l.prefix),a=l.name;return o.icons[a]||(o.missing.has(a)?null:void 0)}}function or(t,l){const o=Tn(t,!0,tn);if(!o)return!1;const a=qs(o.provider,o.prefix);return l?nr(a,o.name,l):(a.missing.add(o.name),!0)}function ar(t,l){if(typeof t!="object")return!1;if(typeof l!="string"&&(l=t.provider||""),tn&&!l&&!t.prefix){let r=!1;return ko(t)&&(t.prefix="",bo(t,(c,f)=>{or(c,f)&&(r=!0)})),r}const o=t.prefix;if(!yn({prefix:o,name:"a"}))return!1;const a=qs(l,o);return!!xo(a,t)}const Co=Object.freeze({width:null,height:null}),$o=Object.freeze({...Co,...xn}),ir=/(-?[0-9.]*[0-9]+[0-9.]*)/g,rr=/^-?[0-9.]*[0-9]+[0-9.]*$/g;function Hl(t,l,o){if(l===1)return t;if(o=o||100,typeof t=="number")return Math.ceil(t*l*o)/o;if(typeof t!="string")return t;const a=t.split(ir);if(a===null||!a.length)return t;const r=[];let c=a.shift(),f=rr.test(c);for(;;){if(f){const k=parseFloat(c);isNaN(k)?r.push(c):r.push(Math.ceil(k*l*o)/o)}else r.push(c);if(c=a.shift(),c===void 0)return r.join("");f=!f}}function cr(t,l="defs"){let o="";const a=t.indexOf("<"+l);for(;a>=0;){const r=t.indexOf(">",a),c=t.indexOf("</"+l);if(r===-1||c===-1)break;const f=t.indexOf(">",c);if(f===-1)break;o+=t.slice(r+1,c).trim(),t=t.slice(0,a).trim()+t.slice(f+1)}return{defs:o,content:t}}function dr(t,l){return t?"<defs>"+t+"</defs>"+l:l}function ur(t,l,o){const a=cr(t);return dr(a.defs,l+a.content+o)}const mr=t=>t==="unset"||t==="undefined"||t==="none";function vr(t,l){const o={...In,...t},a={...$o,...l},r={left:o.left,top:o.top,width:o.width,height:o.height};let c=o.body;[o,a].forEach(j=>{const F=[],ie=j.hFlip,W=j.vFlip;let S=j.rotate;ie?W?S+=2:(F.push("translate("+(r.width+r.left).toString()+" "+(0-r.top).toString()+")"),F.push("scale(-1 1)"),r.top=r.left=0):W&&(F.push("translate("+(0-r.left).toString()+" "+(r.height+r.top).toString()+")"),F.push("scale(1 -1)"),r.top=r.left=0);let Z;switch(S<0&&(S-=Math.floor(S/4)*4),S=S%4,S){case 1:Z=r.height/2+r.top,F.unshift("rotate(90 "+Z.toString()+" "+Z.toString()+")");break;case 2:F.unshift("rotate(180 "+(r.width/2+r.left).toString()+" "+(r.height/2+r.top).toString()+")");break;case 3:Z=r.width/2+r.left,F.unshift("rotate(-90 "+Z.toString()+" "+Z.toString()+")");break}S%2===1&&(r.left!==r.top&&(Z=r.left,r.left=r.top,r.top=Z),r.width!==r.height&&(Z=r.width,r.width=r.height,r.height=Z)),F.length&&(c=ur(c,'<g transform="'+F.join(" ")+'">',"</g>"))});const f=a.width,k=a.height,w=r.width,x=r.height;let T,y;f===null?(y=k===null?"1em":k==="auto"?x:k,T=Hl(y,w/x)):(T=f==="auto"?w:f,y=k===null?Hl(T,x/w):k==="auto"?x:k);const B={},m=(j,F)=>{mr(F)||(B[j]=F.toString())};m("width",T),m("height",y);const Y=[r.left,r.top,w,x];return B.viewBox=Y.join(" "),{attributes:B,viewBox:Y,body:c}}const fr=/\sid="(\S+)"/g,Ar="IconifyId"+Date.now().toString(16)+(Math.random()*16777216|0).toString(16);let pr=0;function hr(t,l=Ar){const o=[];let a;for(;a=fr.exec(t);)o.push(a[1]);if(!o.length)return t;const r="suffix"+(Math.random()*16777216|Date.now()).toString(16);return o.forEach(c=>{const f=typeof l=="function"?l(c):l+(pr++).toString(),k=c.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");t=t.replace(new RegExp('([#;"])('+k+')([")]|\\.[a-z])',"g"),"$1"+f+r+"$3")}),t=t.replace(new RegExp(r,"g"),""),t}const zn=Object.create(null);function gr(t,l){zn[t]=l}function Vn(t){return zn[t]||zn[""]}function ll(t){let l;if(typeof t.resources=="string")l=[t.resources];else if(l=t.resources,!(l instanceof Array)||!l.length)return null;return{resources:l,path:t.path||"/",maxURL:t.maxURL||500,rotate:t.rotate||750,timeout:t.timeout||5e3,random:t.random===!0,index:t.index||0,dataAfterTimeout:t.dataAfterTimeout!==!1}}const ol=Object.create(null),Js=["https://api.simplesvg.com","https://api.unisvg.com"],bn=[];for(;Js.length>0;)Js.length===1||Math.random()>.5?bn.push(Js.shift()):bn.push(Js.pop());ol[""]=ll({resources:["https://api.iconify.design"].concat(bn)});function yr(t,l){const o=ll(l);return o===null?!1:(ol[t]=o,!0)}function al(t){return ol[t]}const br=()=>{let t;try{if(t=fetch,typeof t=="function")return t}catch{}};let ql=br();function kr(t,l){const o=al(t);if(!o)return 0;let a;if(!o.maxURL)a=0;else{let r=0;o.resources.forEach(f=>{r=Math.max(r,f.length)});const c=l+".json?icons=";a=o.maxURL-r-o.path.length-c.length}return a}function xr(t){return t===404}const wr=(t,l,o)=>{const a=[],r=kr(t,l),c="icons";let f={type:c,provider:t,prefix:l,icons:[]},k=0;return o.forEach((w,x)=>{k+=w.length+1,k>=r&&x>0&&(a.push(f),f={type:c,provider:t,prefix:l,icons:[]},k=w.length),f.icons.push(w)}),a.push(f),a};function Cr(t){if(typeof t=="string"){const l=al(t);if(l)return l.path}return"/"}const $r=(t,l,o)=>{if(!ql){o("abort",424);return}let a=Cr(l.provider);switch(l.type){case"icons":{const c=l.prefix,k=l.icons.join(","),w=new URLSearchParams({icons:k});a+=c+".json?"+w.toString();break}case"custom":{const c=l.uri;a+=c.slice(0,1)==="/"?c.slice(1):c;break}default:o("abort",400);return}let r=503;ql(t+a).then(c=>{const f=c.status;if(f!==200){setTimeout(()=>{o(xr(f)?"abort":"next",f)});return}return r=501,c.json()}).then(c=>{if(typeof c!="object"||c===null){setTimeout(()=>{c===404?o("abort",c):o("next",r)});return}setTimeout(()=>{o("success",c)})}).catch(()=>{o("next",r)})},_r={prepare:wr,send:$r};function Tr(t){const l={loaded:[],missing:[],pending:[]},o=Object.create(null);t.sort((r,c)=>r.provider!==c.provider?r.provider.localeCompare(c.provider):r.prefix!==c.prefix?r.prefix.localeCompare(c.prefix):r.name.localeCompare(c.name));let a={provider:"",prefix:"",name:""};return t.forEach(r=>{if(a.name===r.name&&a.prefix===r.prefix&&a.provider===r.provider)return;a=r;const c=r.provider,f=r.prefix,k=r.name,w=o[c]||(o[c]=Object.create(null)),x=w[f]||(w[f]=qs(c,f));let T;k in x.icons?T=l.loaded:f===""||x.missing.has(k)?T=l.missing:T=l.pending;const y={provider:c,prefix:f,name:k};T.push(y)}),l}function _o(t,l){t.forEach(o=>{const a=o.loaderCallbacks;a&&(o.loaderCallbacks=a.filter(r=>r.id!==l))})}function Ir(t){t.pendingCallbacksFlag||(t.pendingCallbacksFlag=!0,setTimeout(()=>{t.pendingCallbacksFlag=!1;const l=t.loaderCallbacks?t.loaderCallbacks.slice(0):[];if(!l.length)return;let o=!1;const a=t.provider,r=t.prefix;l.forEach(c=>{const f=c.icons,k=f.pending.length;f.pending=f.pending.filter(w=>{if(w.prefix!==r)return!0;const x=w.name;if(t.icons[x])f.loaded.push({provider:a,prefix:r,name:x});else if(t.missing.has(x))f.missing.push({provider:a,prefix:r,name:x});else return o=!0,!0;return!1}),f.pending.length!==k&&(o||_o([t],c.id),c.callback(f.loaded.slice(0),f.missing.slice(0),f.pending.slice(0),c.abort))})}))}let Sr=0;function Er(t,l,o){const a=Sr++,r=_o.bind(null,o,a);if(!l.pending.length)return r;const c={id:a,icons:l,callback:t,abort:r};return o.forEach(f=>{(f.loaderCallbacks||(f.loaderCallbacks=[])).push(c)}),r}function Pr(t,l=!0,o=!1){const a=[];return t.forEach(r=>{const c=typeof r=="string"?Tn(r,l,o):r;c&&a.push(c)}),a}var Mr={resources:[],index:0,timeout:2e3,rotate:750,random:!1,dataAfterTimeout:!1};function Dr(t,l,o,a){const r=t.resources.length,c=t.random?Math.floor(Math.random()*r):t.index;let f;if(t.random){let X=t.resources.slice(0);for(f=[];X.length>1;){const U=Math.floor(Math.random()*X.length);f.push(X[U]),X=X.slice(0,U).concat(X.slice(U+1))}f=f.concat(X)}else f=t.resources.slice(c).concat(t.resources.slice(0,c));const k=Date.now();let w="pending",x=0,T,y=null,B=[],m=[];typeof a=="function"&&m.push(a);function Y(){y&&(clearTimeout(y),y=null)}function j(){w==="pending"&&(w="aborted"),Y(),B.forEach(X=>{X.status==="pending"&&(X.status="aborted")}),B=[]}function F(X,U){U&&(m=[]),typeof X=="function"&&m.push(X)}function ie(){return{startTime:k,payload:l,status:w,queriesSent:x,queriesPending:B.length,subscribe:F,abort:j}}function W(){w="failed",m.forEach(X=>{X(void 0,T)})}function S(){B.forEach(X=>{X.status==="pending"&&(X.status="aborted")}),B=[]}function Z(X,U,D){const b=U!=="success";switch(B=B.filter(d=>d!==X),w){case"pending":break;case"failed":if(b||!t.dataAfterTimeout)return;break;default:return}if(U==="abort"){T=D,W();return}if(b){T=D,B.length||(f.length?K():W());return}if(Y(),S(),!t.random){const d=t.resources.indexOf(X.resource);d!==-1&&d!==t.index&&(t.index=d)}w="completed",m.forEach(d=>{d(D)})}function K(){if(w!=="pending")return;Y();const X=f.shift();if(X===void 0){if(B.length){y=setTimeout(()=>{Y(),w==="pending"&&(S(),W())},t.timeout);return}W();return}const U={status:"pending",resource:X,callback:(D,b)=>{Z(U,D,b)}};B.push(U),x++,y=setTimeout(K,t.rotate),o(X,l,U.callback)}return setTimeout(K),ie}function To(t){const l={...Mr,...t};let o=[];function a(){o=o.filter(k=>k().status==="pending")}function r(k,w,x){const T=Dr(l,k,w,(y,B)=>{a(),x&&x(y,B)});return o.push(T),T}function c(k){return o.find(w=>k(w))||null}return{query:r,find:c,setIndex:k=>{l.index=k},getIndex:()=>l.index,cleanup:a}}function Ul(){}const Rn=Object.create(null);function Br(t){if(!Rn[t]){const l=al(t);if(!l)return;const o=To(l),a={config:l,redundancy:o};Rn[t]=a}return Rn[t]}function Rr(t,l,o){let a,r;if(typeof t=="string"){const c=Vn(t);if(!c)return o(void 0,424),Ul;r=c.send;const f=Br(t);f&&(a=f.redundancy)}else{const c=ll(t);if(c){a=To(c);const f=t.resources?t.resources[0]:"",k=Vn(f);k&&(r=k.send)}}return!a||!r?(o(void 0,424),Ul):a.query(l,r,o)().abort}function Wl(){}function Fr(t){t.iconsLoaderFlag||(t.iconsLoaderFlag=!0,setTimeout(()=>{t.iconsLoaderFlag=!1,Ir(t)}))}function Lr(t){const l=[],o=[];return t.forEach(a=>{(a.match(go)?l:o).push(a)}),{valid:l,invalid:o}}function Ks(t,l,o){function a(){const r=t.pendingIcons;l.forEach(c=>{r&&r.delete(c),t.icons[c]||t.missing.add(c)})}if(o&&typeof o=="object")try{if(!xo(t,o).length){a();return}}catch(r){console.error(r)}a(),Fr(t)}function zl(t,l){t instanceof Promise?t.then(o=>{l(o)}).catch(()=>{l(null)}):l(t)}function Nr(t,l){t.iconsToLoad?t.iconsToLoad=t.iconsToLoad.concat(l).sort():t.iconsToLoad=l,t.iconsQueueFlag||(t.iconsQueueFlag=!0,setTimeout(()=>{t.iconsQueueFlag=!1;const{provider:o,prefix:a}=t,r=t.iconsToLoad;if(delete t.iconsToLoad,!r||!r.length)return;const c=t.loadIcon;if(t.loadIcons&&(r.length>1||!c)){zl(t.loadIcons(r,a,o),T=>{Ks(t,r,T)});return}if(c){r.forEach(T=>{const y=c(T,a,o);zl(y,B=>{const m=B?{prefix:a,icons:{[T]:B}}:null;Ks(t,[T],m)})});return}const{valid:f,invalid:k}=Lr(r);if(k.length&&Ks(t,k,null),!f.length)return;const w=a.match(go)?Vn(o):null;if(!w){Ks(t,f,null);return}w.prepare(o,a,f).forEach(T=>{Rr(o,T,y=>{Ks(t,T.icons,y)})})}))}const Or=(t,l)=>{const o=Pr(t,!0,wo()),a=Tr(o);if(!a.pending.length){let w=!0;return l&&setTimeout(()=>{w&&l(a.loaded,a.missing,a.pending,Wl)}),()=>{w=!1}}const r=Object.create(null),c=[];let f,k;return a.pending.forEach(w=>{const{provider:x,prefix:T}=w;if(T===k&&x===f)return;f=x,k=T,c.push(qs(x,T));const y=r[x]||(r[x]=Object.create(null));y[T]||(y[T]=[])}),a.pending.forEach(w=>{const{provider:x,prefix:T,name:y}=w,B=qs(x,T),m=B.pendingIcons||(B.pendingIcons=new Set);m.has(y)||(m.add(y),r[x][T].push(y))}),c.forEach(w=>{const x=r[w.provider][w.prefix];x.length&&Nr(w,x)}),l?Er(l,a,c):Wl};function Hr(t,l){const o={...t};for(const a in l){const r=l[a],c=typeof r;a in Co?(r===null||r&&(c==="string"||c==="number"))&&(o[a]=r):c===typeof o[a]&&(o[a]=a==="rotate"?r%4:r)}return o}const qr=/[\s,]+/;function Ur(t,l){l.split(qr).forEach(o=>{switch(o.trim()){case"horizontal":t.hFlip=!0;break;case"vertical":t.vFlip=!0;break}})}function Wr(t,l=0){const o=t.replace(/^-?[0-9.]*/,"");function a(r){for(;r<0;)r+=4;return r%4}if(o===""){const r=parseInt(t);return isNaN(r)?0:a(r)}else if(o!==t){let r=0;switch(o){case"%":r=25;break;case"deg":r=90}if(r){let c=parseFloat(t.slice(0,t.length-o.length));return isNaN(c)?0:(c=c/r,c%1===0?a(c):0)}}return l}function zr(t,l){let o=t.indexOf("xlink:")===-1?"":' xmlns:xlink="http://www.w3.org/1999/xlink"';for(const a in l)o+=" "+a+'="'+l[a]+'"';return'<svg xmlns="http://www.w3.org/2000/svg"'+o+">"+t+"</svg>"}function Vr(t){return t.replace(/"/g,"'").replace(/%/g,"%25").replace(/#/g,"%23").replace(/</g,"%3C").replace(/>/g,"%3E").replace(/\s+/g," ")}function Qr(t){return"data:image/svg+xml,"+Vr(t)}function jr(t){return'url("'+Qr(t)+'")'}const Vl={...$o,inline:!1},Gr={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink","aria-hidden":!0,role:"img"},Yr={display:"inline-block"},Qn={backgroundColor:"currentColor"},Io={backgroundColor:"transparent"},Ql={Image:"var(--svg)",Repeat:"no-repeat",Size:"100% 100%"},jl={webkitMask:Qn,mask:Qn,background:Io};for(const t in jl){const l=jl[t];for(const o in Ql)l[t+o]=Ql[o]}const kn={};["horizontal","vertical"].forEach(t=>{const l=t.slice(0,1)+"Flip";kn[t+"-flip"]=l,kn[t.slice(0,1)+"-flip"]=l,kn[t+"Flip"]=l});function Gl(t){return t+(t.match(/^[-0-9.]+$/)?"px":"")}const Yl=(t,l)=>{const o=Hr(Vl,l),a={...Gr},r=l.mode||"svg",c={},f=l.style,k=typeof f=="object"&&!(f instanceof Array)?f:{};for(let j in l){const F=l[j];if(F!==void 0)switch(j){case"icon":case"style":case"onLoad":case"mode":case"ssr":break;case"inline":case"hFlip":case"vFlip":o[j]=F===!0||F==="true"||F===1;break;case"flip":typeof F=="string"&&Ur(o,F);break;case"color":c.color=F;break;case"rotate":typeof F=="string"?o[j]=Wr(F):typeof F=="number"&&(o[j]=F);break;case"ariaHidden":case"aria-hidden":F!==!0&&F!=="true"&&delete a["aria-hidden"];break;default:{const ie=kn[j];ie?(F===!0||F==="true"||F===1)&&(o[ie]=!0):Vl[j]===void 0&&(a[j]=F)}}}const w=vr(t,o),x=w.attributes;if(o.inline&&(c.verticalAlign="-0.125em"),r==="svg"){a.style={...c,...k},Object.assign(a,x);let j=0,F=l.id;return typeof F=="string"&&(F=F.replace(/-/g,"_")),a.innerHTML=hr(w.body,F?()=>F+"ID"+j++:"iconifyVue"),$l("svg",a)}const{body:T,width:y,height:B}=t,m=r==="mask"||(r==="bg"?!1:T.indexOf("currentColor")!==-1),Y=zr(T,{...x,width:y+"",height:B+""});return a.style={...c,"--svg":jr(Y),width:Gl(x.width),height:Gl(x.height),...Yr,...m?Qn:Io,...k},$l("span",a)};wo(!0);gr("",_r);if(typeof document<"u"&&typeof window<"u"){const t=window;if(t.IconifyPreload!==void 0){const l=t.IconifyPreload,o="Invalid IconifyPreload syntax.";typeof l=="object"&&l!==null&&(l instanceof Array?l:[l]).forEach(a=>{try{(typeof a!="object"||a===null||a instanceof Array||typeof a.icons!="object"||typeof a.prefix!="string"||!ar(a))&&console.error(o)}catch{console.error(o)}})}if(t.IconifyProviders!==void 0){const l=t.IconifyProviders;if(typeof l=="object"&&l!==null)for(let o in l){const a="IconifyProviders["+o+"] is invalid.";try{const r=l[o];if(typeof r!="object"||!r||r.resources===void 0)continue;yr(o,r)||console.error(a)}catch{console.error(a)}}}}const Xr={...In,body:""},p=la((t,{emit:l})=>{const o=R(null);function a(){var x,T;o.value&&((T=(x=o.value).abort)==null||T.call(x),o.value=null)}const r=R(!!t.ssr),c=R(""),f=oa(null);function k(){const x=t.icon;if(typeof x=="object"&&x!==null&&typeof x.body=="string")return c.value="",{data:x};let T;if(typeof x!="string"||(T=Tn(x,!1,!0))===null)return null;let y=lr(T);if(!y){const Y=o.value;return(!Y||Y.name!==x)&&(y===null?o.value={name:x}:o.value={name:x,abort:Or([T],w)}),null}a(),c.value!==x&&(c.value=x,fs(()=>{l("load",x)}));const B=t.customise;if(B){y=Object.assign({},y);const Y=B(y.body,T.name,T.prefix,T.provider);typeof Y=="string"&&(y.body=Y)}const m=["iconify"];return T.prefix!==""&&m.push("iconify--"+T.prefix),T.provider!==""&&m.push("iconify--"+T.provider),{data:y,classes:m}}function w(){var T;const x=k();x?x.data!==((T=f.value)==null?void 0:T.data)&&(f.value=x):f.value=null}return r.value?w():rs(()=>{r.value=!0,w()}),Gt(()=>t.icon,w),ln(a),()=>{const x=f.value;if(!x)return Yl(Xr,t);let T=t;return x.classes&&(T={...t,class:x.classes.join(" ")}),Yl({...In,...x.data},T)}},{props:["icon","mode","ssr","width","height","style","color","inline","rotate","hFlip","horizontalFlip","vFlip","verticalFlip","flip","id","ariaHidden","customise","title"],emits:["load"]}),Zr={class:"modal-container"},Jr={class:"modal-header"},Kr={class:"header-title"},ec={class:"modal-content"},tc={class:"profiles-sidebar"},sc={class:"sidebar-header"},nc={class:"filter-box"},lc={key:0,class:"new-profile-dialog"},oc={class:"new-profile-actions"},ac={class:"profiles-list"},ic=["onClick"],rc={class:"profile-item-main"},cc={class:"profile-name"},dc={class:"profile-meta"},uc=["onClick"],mc={key:0,class:"empty-list"},vc={class:"profile-editor"},fc={class:"editor-section"},Ac={class:"section-title"},pc={class:"form-grid"},hc={class:"form-group"},gc=["value"],yc={class:"form-group"},bc=["value"],kc={class:"editor-section"},xc={class:"section-title"},wc={class:"terrain-grid"},Cc={class:"terrain-color no-terrain-color"},$c=["title","onClick"],_c={class:"terrain-name"},Tc={class:"editor-section layers-section"},Ic={class:"section-header-row"},Sc={class:"section-title"},Ec={key:0,class:"layers-list"},Pc=["onClick"],Mc={class:"layer-info"},Dc={class:"layer-index"},Bc=["onUpdate:modelValue","onInput"],Rc=["title"],Fc={class:"layer-actions"},Lc={class:"layer-density"},Nc={type:"button",class:"layer-toggle"},Oc=["onClick"],Hc={key:0,class:"layer-details"},qc={class:"layer-form-grid"},Uc={class:"form-group"},Wc=["value","onChange"],zc=["value"],Vc={class:"form-group"},Qc=["value","onInput"],jc={class:"form-group"},Gc=["value","onInput"],Yc={class:"layer-conditions"},Xc={class:"conditions-header"},Zc=["onClick"],Jc={key:0,class:"conditions-list"},Kc=["value","onChange"],ed=["value"],td=["value","onChange"],sd=["value"],nd=["value","onInput"],ld=["onClick"],od={key:1,class:"no-conditions"},ad={key:1,class:"empty-layers"},id={key:1,class:"empty-editor"},rd={key:0,class:"modal-footer"},cd={__name:"ProfileEditorModal",props:{visible:{type:Boolean,default:!1}},emits:["close","select"],setup(t,{emit:l}){const o=l,a=St(wn,"fillProfile"),r=St(an,"terrain"),{profiles:c=R([]),currentProfile:f=R(null),sortedProfiles:k=R([])}=Ut(a,"fillProfile"),w=R(!1),x=R(""),T=R(null),y=R(""),B=ne(()=>{if(!y.value)return k.value;const z=y.value.toLowerCase();return k.value.filter(q=>{var Ie;return q.name.toLowerCase().includes(z)||((Ie=q.description)==null?void 0:Ie.toLowerCase().includes(z))})}),m=ne(()=>r.allTerrains||[]),Y=z=>m.value.find(q=>q.id===z)||{name:z,color:"#888"},j=()=>{x.value.trim()&&(a.createProfile({name:x.value.trim()}),x.value="",w.value=!1)},F=z=>{a.selectProfile(z),T.value=null},ie=z=>{confirm("Удалить профиль?")&&a.deleteProfile(z)},W=z=>{f.value&&a.updateProfile(f.value.id,{name:z})},S=z=>{f.value&&a.updateProfile(f.value.id,{description:z})},Z=z=>{f.value&&a.updateProfile(f.value.id,{baseTerrain:z})},K=()=>{var q;if(!f.value)return;const z=a.addLayer(f.value.id,{name:`Слой ${(((q=f.value.layers)==null?void 0:q.length)||0)+1}`});z&&(T.value=z.id)},X=z=>{f.value&&(a.removeLayer(f.value.id,z),T.value===z&&(T.value=null))},U=(z,q)=>{f.value&&a.updateLayer(f.value.id,z,q)},D=z=>{f.value&&a.addCondition(f.value.id,z,{type:_t.NONE})},b=(z,q)=>{f.value&&a.removeCondition(f.value.id,z,q)},d={[_t.NONE]:"Без условия",[_t.TERRAIN_ID]:"Террейн",[_t.TERRAIN_BIOME]:"Биом",[_t.VISIBILITY]:"Видимость",[_t.MOVEMENT_COST]:"Проходимость",[_t.MELEE_ADVANTAGE]:"Бонус ближ. боя",[_t.TAG]:"Тег",[_t.RANDOM]:"Случайно"},oe={[Ot.EQUALS]:"=",[Ot.NOT_EQUALS]:"≠",[Ot.GREATER]:">",[Ot.GREATER_EQUALS]:"≥",[Ot.LESS]:"<",[Ot.LESS_EQUALS]:"≤",[Ot.CONTAINS]:"содержит"},he=()=>{f.value&&(o("select",f.value),M())},M=()=>{o("close")},de=z=>{z.target===z.currentTarget&&M()},H=z=>{z.key==="Escape"&&M()};return(z,q)=>(s(),st(Vt,{to:"body"},[A(Ps,{name:"modal"},{default:ys(()=>{var Ie;return[t.visible?(s(),n("div",{key:0,class:"modal-backdrop",onClick:de,onKeydown:H},[e("div",Zr,[e("header",Jr,[e("div",Kr,[A(i(p),{icon:"mdi:dice-multiple",class:"header-icon"}),q[9]||(q[9]=e("h2",null,"Профили заливки",-1))]),e("button",{type:"button",class:"close-btn",onClick:M},[A(i(p),{icon:"mdi:close"})])]),e("div",ec,[e("aside",tc,[e("div",sc,[q[10]||(q[10]=e("h3",null,"Профили",-1)),e("button",{type:"button",class:"add-btn",onClick:q[0]||(q[0]=C=>w.value=!0)},[A(i(p),{icon:"mdi:plus"})])]),e("div",nc,[A(i(p),{icon:"mdi:magnify",class:"filter-icon"}),De(e("input",{"onUpdate:modelValue":q[1]||(q[1]=C=>y.value=C),type:"text",placeholder:"Поиск...",class:"filter-input"},null,512),[[je,y.value]])]),w.value?(s(),n("div",lc,[De(e("input",{"onUpdate:modelValue":q[2]||(q[2]=C=>x.value=C),type:"text",placeholder:"Название профиля...",class:"new-profile-input",onKeyup:ks(j,["enter"])},null,544),[[je,x.value]]),e("div",oc,[e("button",{type:"button",class:"btn-primary",onClick:j}," Создать "),e("button",{type:"button",class:"btn-secondary",onClick:q[3]||(q[3]=C=>{w.value=!1,x.value=""})}," Отмена ")])])):_("",!0),e("div",ac,[(s(!0),n(ee,null,me(B.value,C=>{var L,$e;return s(),n("button",{key:C.id,type:"button",class:Q(["profile-item",{selected:((L=i(f))==null?void 0:L.id)===C.id}]),onClick:Ae=>F(C.id)},[e("div",rc,[e("span",cc,h(C.name),1),e("span",dc,[e("span",{class:"base-dot",style:Qe({backgroundColor:Y(C.baseTerrain).color})},null,4),Ce(" "+h((($e=C.layers)==null?void 0:$e.length)||0)+" слоёв ",1)])]),e("button",{type:"button",class:"delete-btn",onClick:lt(Ae=>ie(C.id),["stop"])},[A(i(p),{icon:"mdi:delete-outline"})],8,uc)],10,ic)}),128)),B.value.length===0?(s(),n("div",mc,[q[11]||(q[11]=e("p",null,"Нет профилей",-1)),e("button",{type:"button",class:"btn-primary",onClick:q[4]||(q[4]=C=>w.value=!0)}," Создать первый ")])):_("",!0)])]),e("main",vc,[i(f)?(s(),n(ee,{key:0},[e("section",fc,[e("h3",Ac,[A(i(p),{icon:"mdi:cog"}),q[12]||(q[12]=Ce(" Основные настройки ",-1))]),e("div",pc,[e("div",hc,[q[13]||(q[13]=e("label",null,"Название",-1)),e("input",{type:"text",value:i(f).name,class:"form-input",onInput:q[5]||(q[5]=C=>W(C.target.value))},null,40,gc)]),e("div",yc,[q[14]||(q[14]=e("label",null,"Описание",-1)),e("input",{type:"text",value:i(f).description,placeholder:"Опционально...",class:"form-input",onInput:q[6]||(q[6]=C=>S(C.target.value))},null,40,bc)])])]),e("section",kc,[e("h3",xc,[A(i(p),{icon:"mdi:terrain"}),q[15]||(q[15]=Ce(" Базовый террейн ",-1)),q[16]||(q[16]=e("span",{class:"section-hint"},"Заполняет все гексы в области",-1))]),e("div",wc,[e("button",{type:"button",class:Q(["terrain-tile no-terrain",{selected:!i(f).baseTerrain}]),title:"Без базового террейна — только слои",onClick:q[7]||(q[7]=C=>Z(null))},[e("span",Cc,[A(i(p),{icon:"mdi:texture-box"})]),q[17]||(q[17]=e("span",{class:"terrain-name"},"Нет",-1))],2),(s(!0),n(ee,null,me(m.value,C=>(s(),n("button",{key:C.id,type:"button",class:Q(["terrain-tile",{selected:i(f).baseTerrain===C.id}]),title:C.name,onClick:L=>Z(C.id)},[e("span",{class:"terrain-color",style:Qe({backgroundColor:C.color||C.fallbackColor})},null,4),e("span",_c,h(C.name),1)],10,$c))),128))])]),e("section",Tc,[e("div",Ic,[e("h3",Sc,[A(i(p),{icon:"mdi:layers-triple"}),q[18]||(q[18]=Ce(" Слои ",-1)),q[19]||(q[19]=e("span",{class:"section-hint"},"Накладываются поверх базового",-1))]),e("button",{type:"button",class:"btn-add-layer",onClick:K},[A(i(p),{icon:"mdi:plus"}),q[20]||(q[20]=Ce(" Добавить слой ",-1))])]),(Ie=i(f).layers)!=null&&Ie.length?(s(),n("div",Ec,[(s(!0),n(ee,null,me(i(f).layers,(C,L)=>{var $e;return s(),n("div",{key:C.id,class:Q(["layer-card",{expanded:T.value===C.id}])},[e("div",{class:"layer-header",onClick:Ae=>T.value=T.value===C.id?null:C.id},[e("div",Mc,[e("span",Dc,"#"+h(L+1),1),De(e("input",{"onUpdate:modelValue":Ae=>C.name=Ae,type:"text",class:"layer-name-input",onClick:q[8]||(q[8]=lt(()=>{},["stop"])),onInput:Ae=>U(C.id,{name:Ae.target.value})},null,40,Bc),[[je,C.name]]),e("span",{class:"layer-terrain-preview",style:Qe({backgroundColor:Y(C.terrainId).color}),title:Y(C.terrainId).name},null,12,Rc)]),e("div",Fc,[e("span",Lc,h(C.density)+"%",1),e("button",Nc,[A(i(p),{icon:T.value===C.id?"mdi:chevron-up":"mdi:chevron-down"},null,8,["icon"])]),e("button",{type:"button",class:"layer-delete",onClick:lt(Ae=>X(C.id),["stop"])},[A(i(p),{icon:"mdi:delete-outline"})],8,Oc)])],8,Pc),T.value===C.id?(s(),n("div",Hc,[e("div",qc,[e("div",Uc,[q[22]||(q[22]=e("label",null,"Террейн",-1)),e("select",{value:C.terrainId,class:"form-select",onChange:Ae=>U(C.id,{terrainId:Ae.target.value})},[q[21]||(q[21]=e("option",{value:""},"Не выбран",-1)),(s(!0),n(ee,null,me(m.value,Ae=>(s(),n("option",{key:Ae.id,value:Ae.id},h(Ae.name),9,zc))),128))],40,Wc)]),e("div",Vc,[e("label",null,"Плотность: "+h(C.density)+"%",1),e("input",{type:"range",min:"0",max:"100",value:C.density,class:"form-range",onInput:Ae=>U(C.id,{density:Number(Ae.target.value)})},null,40,Qc)]),e("div",jc,[e("label",null,"Группировка: "+h(C.clustering)+"%",1),e("input",{type:"range",min:"0",max:"100",value:C.clustering,class:"form-range",onInput:Ae=>U(C.id,{clustering:Number(Ae.target.value)})},null,40,Gc)])]),e("div",Yc,[e("div",Xc,[q[23]||(q[23]=e("span",null,"Условия применения",-1)),e("button",{type:"button",class:"btn-add-condition",onClick:Ae=>D(C.id)},[A(i(p),{icon:"mdi:plus"})],8,Zc)]),($e=C.conditions)!=null&&$e.length?(s(),n("div",Jc,[(s(!0),n(ee,null,me(C.conditions,Ae=>(s(),n("div",{key:Ae.id,class:"condition-row"},[e("select",{value:Ae.type,class:"condition-type",onChange:Ee=>U(C.id,{conditions:C.conditions.map(Se=>Se.id===Ae.id?{...Se,type:Ee.target.value}:Se)})},[(s(),n(ee,null,me(d,(Ee,Se)=>e("option",{key:Se,value:Se},h(Ee),9,ed)),64))],40,Kc),Ae.type!==i(_t).NONE?(s(),n("select",{key:0,value:Ae.operator,class:"condition-operator",onChange:Ee=>U(C.id,{conditions:C.conditions.map(Se=>Se.id===Ae.id?{...Se,operator:Ee.target.value}:Se)})},[(s(),n(ee,null,me(oe,(Ee,Se)=>e("option",{key:Se,value:Se},h(Ee),9,sd)),64))],40,td)):_("",!0),Ae.type!==i(_t).NONE?(s(),n("input",{key:1,value:Ae.value,type:"text",placeholder:"значение",class:"condition-value",onInput:Ee=>U(C.id,{conditions:C.conditions.map(Se=>Se.id===Ae.id?{...Se,value:Ee.target.value}:Se)})},null,40,nd)):_("",!0),e("button",{type:"button",class:"condition-delete",onClick:Ee=>b(C.id,Ae.id)},[A(i(p),{icon:"mdi:close"})],8,ld)]))),128))])):(s(),n("p",od,"Нет условий — слой применяется везде"))])])):_("",!0)],2)}),128))])):(s(),n("div",ad,[A(i(p),{icon:"mdi:layers-off",class:"empty-icon"}),q[25]||(q[25]=e("p",null,"Добавьте слои для создания сложных паттернов",-1)),e("button",{type:"button",class:"btn-primary",onClick:K},[A(i(p),{icon:"mdi:plus"}),q[24]||(q[24]=Ce(" Добавить первый слой ",-1))])]))])],64)):(s(),n("div",id,[A(i(p),{icon:"mdi:arrow-left",class:"empty-icon"}),q[26]||(q[26]=e("p",null,"Выберите профиль слева или создайте новый",-1))]))])]),i(f)?(s(),n("footer",rd,[e("button",{type:"button",class:"btn-secondary",onClick:M}," Закрыть "),e("button",{type:"button",class:"btn-primary",onClick:he},[A(i(p),{icon:"mdi:check"}),q[27]||(q[27]=Ce(" Выбрать ",-1))])])):_("",!0)])],32)):_("",!0)]}),_:1})]))}},dd=zt(cd,[["__scopeId","data-v-67e0e094"]]),ud=["width","height"],md={__name:"MapPointer",props:{width:{type:Number,required:!0},height:{type:Number,required:!0},camera:{type:Object,required:!0},hexGrid:{type:Object,default:null},selectedTokenPosition:{type:Object,default:null},tokenSize:{type:Number,default:48}},emits:["tool-change"],setup(t,{expose:l,emit:o}){const a=t,r=o,c=St(Cn,"pointer"),f=St(cs,"session"),k=St($n,"interaction"),{isMaster:w=R(!1)}=Ut(f,"session"),{state:x=R("idle"),dragState:T=R(null),selectedFacing:y=R(null),defencePreviewFacing:B=R(null)}=Ut(k,"interaction"),{activeTool:m=R("none"),activeColor:Y=R("#ffffff"),lineWidth:j=R(3),masterPointer:F=R(null),pings:ie=R([]),drawings:W=R([]),shapes:S=R([]),currentDrawing:Z=R(null),currentShape:K=R(null),measurement:X=R(null),rangeDisplay:U=R(null),movementRange:D=R(null)}=Ut(c,"pointer"),b=R(null);let d=null,oe=null;const he=()=>{!b.value||!d||(d.clearRect(0,0,a.width,a.height),d.save(),d.translate(a.camera.x,a.camera.y),d.scale(a.camera.zoom,a.camera.zoom),He(),Ne(),Se(),Ee(),H(),q(),de(),M(),d.restore(),oe=requestAnimationFrame(he))},M=()=>{if(!F.value)return;const{x:xe,y:Me}=F.value,Pe=12/a.camera.zoom;d.save(),d.translate(xe,Me),d.shadowColor="rgba(0, 0, 0, 0.5)",d.shadowBlur=4,d.shadowOffsetX=2,d.shadowOffsetY=2,d.beginPath(),d.moveTo(0,0),d.lineTo(Pe*.8,Pe*.6),d.lineTo(Pe*.3,Pe*.7),d.lineTo(Pe*.4,Pe*1.2),d.lineTo(0,Pe*.85),d.lineTo(-Pe*.1,Pe*1.2),d.lineTo(0,Pe*.7),d.closePath(),d.fillStyle="#facc15",d.fill(),d.strokeStyle="#000",d.lineWidth=1.5/a.camera.zoom,d.stroke(),d.restore()},de=()=>{const xe=Date.now();ie.value.forEach(Me=>{const Re=(xe-Me.time)/Me.lifetime;if(Re>=1)return;const{x:ke,y:ge,color:ae}=Me,Xe=20/a.camera.zoom,Ze=40/a.camera.zoom;for(let vt=0;vt<3;vt++){const te=(Re+vt*.3)%1,J=Xe+(Ze-Xe)*te,Te=(1-te)*.6;d.beginPath(),d.arc(ke,ge,J,0,Math.PI*2),d.strokeStyle=ae,d.globalAlpha=Te,d.lineWidth=3/a.camera.zoom,d.stroke(),d.globalAlpha=1}d.beginPath(),d.arc(ke,ge,6/a.camera.zoom,0,Math.PI*2),d.fillStyle=ae,d.fill(),d.strokeStyle="#000",d.lineWidth=1.5/a.camera.zoom,d.stroke()})},H=()=>{W.value.forEach(xe=>{z(xe.points,xe.color,xe.width)}),Z.value&&Z.value.points.length>1&&z(Z.value.points,Z.value.color,Z.value.width)},z=(xe,Me,Pe)=>{if(xe.length<2)return;d.beginPath(),d.moveTo(xe[0].x,xe[0].y);for(let ke=1;ke<xe.length-1;ke++){const ge=(xe[ke].x+xe[ke+1].x)/2,ae=(xe[ke].y+xe[ke+1].y)/2;d.quadraticCurveTo(xe[ke].x,xe[ke].y,ge,ae)}const Re=xe[xe.length-1];d.lineTo(Re.x,Re.y),d.strokeStyle=Me,d.lineWidth=Pe/a.camera.zoom,d.lineCap="round",d.lineJoin="round",d.stroke()},q=()=>{S.value.forEach(xe=>{Ie(xe)}),K.value&&Ie(K.value)},Ie=xe=>{const{type:Me,start:Pe,end:Re,color:ke}=xe;switch(d.strokeStyle=ke,d.fillStyle=ke+"33",d.lineWidth=3/a.camera.zoom,Me){case mt.ARROW:C(Pe,Re,ke);break;case mt.CIRCLE:L(Pe,Re,ke);break;case mt.CONE:$e(Pe,Re,ke);break;case mt.LINE:Ae(Pe,Re,ke);break}},C=(xe,Me,Pe)=>{const Re=Me.x-xe.x,ke=Me.y-xe.y,ge=Math.atan2(ke,Re),ae=Math.sqrt(Re*Re+ke*ke),Xe=Math.min(20/a.camera.zoom,ae*.3),Ze=Math.PI/6;d.beginPath(),d.moveTo(xe.x,xe.y),d.lineTo(Me.x,Me.y),d.strokeStyle=Pe,d.lineWidth=3/a.camera.zoom,d.stroke(),d.beginPath(),d.moveTo(Me.x,Me.y),d.lineTo(Me.x-Xe*Math.cos(ge-Ze),Me.y-Xe*Math.sin(ge-Ze)),d.lineTo(Me.x-Xe*Math.cos(ge+Ze),Me.y-Xe*Math.sin(ge+Ze)),d.closePath(),d.fillStyle=Pe,d.fill()},L=(xe,Me,Pe)=>{const Re=Me.x-xe.x,ke=Me.y-xe.y,ge=Math.sqrt(Re*Re+ke*ke);d.beginPath(),d.arc(xe.x,xe.y,ge,0,Math.PI*2),d.fillStyle=Pe+"33",d.fill(),d.strokeStyle=Pe,d.lineWidth=3/a.camera.zoom,d.stroke()},$e=(xe,Me,Pe)=>{const Re=Me.x-xe.x,ke=Me.y-xe.y,ge=Math.atan2(ke,Re),ae=Math.sqrt(Re*Re+ke*ke),Xe=Math.PI/4;d.beginPath(),d.moveTo(xe.x,xe.y),d.lineTo(xe.x+ae*Math.cos(ge-Xe/2),xe.y+ae*Math.sin(ge-Xe/2)),d.arc(xe.x,xe.y,ae,ge-Xe/2,ge+Xe/2),d.closePath(),d.fillStyle=Pe+"33",d.fill(),d.strokeStyle=Pe,d.lineWidth=3/a.camera.zoom,d.stroke()},Ae=(xe,Me,Pe)=>{d.beginPath(),d.moveTo(xe.x,xe.y),d.lineTo(Me.x,Me.y),d.strokeStyle=Pe,d.lineWidth=3/a.camera.zoom,d.lineCap="round",d.stroke()},Ee=()=>{if(!X.value)return;const{start:xe,end:Me,distance:Pe,path:Re}=X.value;if(Re&&Re.length>0&&a.hexGrid&&(d.fillStyle="rgba(59, 130, 246, 0.2)",d.strokeStyle="rgba(59, 130, 246, 0.6)",d.lineWidth=2/a.camera.zoom,Re.forEach(ke=>{const ge=a.hexGrid.hexToPixel(ke.q,ke.r),ae=a.hexGrid.getHexCorners(ge.x,ge.y);d.beginPath(),d.moveTo(ae[0].x,ae[0].y);for(let Xe=1;Xe<6;Xe++)d.lineTo(ae[Xe].x,ae[Xe].y);d.closePath(),d.fill(),d.stroke()})),d.beginPath(),d.moveTo(xe.x,xe.y),d.lineTo(Me.x,Me.y),d.strokeStyle="#3b82f6",d.lineWidth=3/a.camera.zoom,d.setLineDash([10/a.camera.zoom,5/a.camera.zoom]),d.stroke(),d.setLineDash([]),d.beginPath(),d.arc(xe.x,xe.y,6/a.camera.zoom,0,Math.PI*2),d.fillStyle="#3b82f6",d.fill(),d.strokeStyle="#fff",d.lineWidth=2/a.camera.zoom,d.stroke(),d.beginPath(),d.arc(Me.x,Me.y,6/a.camera.zoom,0,Math.PI*2),d.fillStyle="#3b82f6",d.fill(),d.strokeStyle="#fff",d.lineWidth=2/a.camera.zoom,d.stroke(),Pe>0){const ke=(xe.x+Me.x)/2,ge=(xe.y+Me.y)/2,ae=14/a.camera.zoom;d.font=`bold ${ae}px sans-serif`,d.textAlign="center",d.textBaseline="middle";const Xe=`${Pe} гекс${Pe===1?"":Pe<5?"а":"ов"}`,Ze=d.measureText(Xe),vt=4/a.camera.zoom;d.fillStyle="rgba(0, 0, 0, 0.8)",d.fillRect(ke-Ze.width/2-vt,ge-ae/2-vt,Ze.width+vt*2,ae+vt*2),d.fillStyle="#fff",d.fillText(Xe,ke,ge)}},Se=()=>{if(!U.value||!a.hexGrid)return;const{center:xe,radius:Me,hexes:Pe}=U.value,Re=Pe.reduce((ge,ae)=>Math.max(ge,ae.cost||0),1);Pe.forEach(ge=>{const ae=a.hexGrid.hexToPixel(ge.q,ge.r),Xe=a.hexGrid.getHexCorners(ae.x,ae.y),Ze=ge.cost??0,vt=1-Ze/(Re+1);d.beginPath(),d.moveTo(Xe[0].x,Xe[0].y);for(let te=1;te<6;te++)d.lineTo(Xe[te].x,Xe[te].y);if(d.closePath(),d.fillStyle=`rgba(34, 197, 94, ${.1+vt*.25})`,d.fill(),d.strokeStyle=`rgba(34, 197, 94, ${.3+vt*.4})`,d.lineWidth=1/a.camera.zoom,d.stroke(),Ze>0&&a.camera.zoom>=.5){d.font=`bold ${12/a.camera.zoom}px sans-serif`,d.textAlign="center",d.textBaseline="middle",d.fillStyle="rgba(255, 255, 255, 0.9)",d.strokeStyle="rgba(0, 0, 0, 0.5)",d.lineWidth=2/a.camera.zoom;const te=Ze%1===0?Ze.toString():Ze.toFixed(1);d.strokeText(te,ae.x,ae.y),d.fillText(te,ae.x,ae.y)}});const ke=a.hexGrid.hexToPixel(xe.q,xe.r);d.beginPath(),d.arc(ke.x,ke.y,8/a.camera.zoom,0,Math.PI*2),d.fillStyle="#22c55e",d.fill(),d.strokeStyle="#fff",d.lineWidth=2/a.camera.zoom,d.stroke()},Be=xe=>{if(!a.hexGrid||xe.length===0)return[];const Me=new Set(xe.map(ae=>`${ae.q},${ae.r}`)),Pe=a.hexGrid,ke=Pe.orientation==="pointy"?0:1,ge=[];return xe.forEach(ae=>{const Xe=Pe.hexToPixel(ae.q,ae.r),Ze=Pe.getHexCorners(Xe.x,Xe.y),vt=Pe.getNeighbors(ae.q,ae.r);for(let te=0;te<6;te++){const J=vt[te],Te=`${J.q},${J.r}`;if(!Me.has(Te)){const $=(6-te+ke)%6,P=(5-te+ke+6)%6;ge.push({start:{x:Ze[$].x,y:Ze[$].y},end:{x:Ze[P].x,y:Ze[P].y}})}}}),ge},He=()=>{if(!D.value||!a.hexGrid)return;const{hexes:xe,maxCost:Me}=D.value;if(!xe||xe.length===0)return;xe.forEach(Re=>{const ke=a.hexGrid.hexToPixel(Re.q,Re.r),ge=a.hexGrid.getHexCorners(ke.x,ke.y);d.beginPath(),d.moveTo(ge[0].x,ge[0].y);for(let Ze=1;Ze<6;Ze++)d.lineTo(ge[Ze].x,ge[Ze].y);d.closePath();const ae=Re.cost??0,Xe=Me-ae;Xe>=Me*.6?d.fillStyle="rgba(56, 189, 248, 0.15)":Xe>=Me*.3?d.fillStyle="rgba(14, 165, 233, 0.15)":d.fillStyle="rgba(2, 132, 199, 0.15)",d.fill()});const Pe=Be(xe);Pe.length>0&&(d.beginPath(),Pe.forEach(Re=>{d.moveTo(Re.start.x,Re.start.y),d.lineTo(Re.end.x,Re.end.y)}),d.strokeStyle="rgba(0, 0, 0, 0.4)",d.lineWidth=6/a.camera.zoom,d.lineCap="round",d.lineJoin="round",d.stroke(),d.beginPath(),Pe.forEach(Re=>{d.moveTo(Re.start.x,Re.start.y),d.lineTo(Re.end.x,Re.end.y)}),d.strokeStyle="rgba(56, 189, 248, 0.7)",d.lineWidth=4/a.camera.zoom,d.stroke(),d.beginPath(),Pe.forEach(Re=>{d.moveTo(Re.start.x,Re.start.y),d.lineTo(Re.end.x,Re.end.y)}),d.strokeStyle="rgba(255, 255, 255, 0.5)",d.lineWidth=1/a.camera.zoom,d.stroke())},Ne=()=>{const xe=c.hoveredPath;if(!xe||!a.hexGrid)return;const{segments:Me,targetHex:Pe}=xe;if(!Me||Me.length===0)return;const Re={movement:{line:"rgba(56, 189, 248, 0.9)",shadow:"rgba(0, 0, 0, 0.5)",point:"rgba(56, 189, 248, 1)"},surge_1:{line:"rgba(250, 204, 21, 0.9)",shadow:"rgba(0, 0, 0, 0.5)",point:"rgba(250, 204, 21, 1)"},surge_2:{line:"rgba(251, 146, 60, 0.9)",shadow:"rgba(0, 0, 0, 0.5)",point:"rgba(251, 146, 60, 1)"},surge_3:{line:"rgba(248, 113, 113, 0.85)",shadow:"rgba(0, 0, 0, 0.5)",point:"rgba(248, 113, 113, 1)"},surge_4:{line:"rgba(239, 68, 68, 0.8)",shadow:"rgba(0, 0, 0, 0.4)",point:"rgba(239, 68, 68, 1)"},unreachable:{line:"rgba(239, 68, 68, 0.5)",shadow:"rgba(0, 0, 0, 0.3)",point:"rgba(239, 68, 68, 0.8)"}},ke=4/a.camera.zoom,ge=8/a.camera.zoom;Me.forEach((ae,Xe)=>{const{type:Ze,path:vt,hasEndpoint:te,isFinal:J}=ae;if(!vt||vt.length<2)return;const Te=Re[Ze]||Re.movement,$=vt.map(P=>a.hexGrid.hexToPixel(P.q,P.r));d.beginPath(),d.moveTo($[0].x,$[0].y);for(let P=1;P<$.length;P++)d.lineTo($[P].x,$[P].y);d.strokeStyle=Te.shadow,d.lineWidth=ge,d.lineCap="round",d.lineJoin="round",d.stroke(),d.beginPath(),d.moveTo($[0].x,$[0].y);for(let P=1;P<$.length;P++)d.lineTo($[P].x,$[P].y);if(d.strokeStyle=Te.line,d.lineWidth=ke,d.lineCap="round",d.lineJoin="round",d.stroke(),te&&!J&&$.length>1){const P=$[$.length-1],N=6/a.camera.zoom;d.beginPath(),d.arc(P.x,P.y,N+2/a.camera.zoom,0,Math.PI*2),d.fillStyle=Te.shadow,d.fill(),d.beginPath(),d.arc(P.x,P.y,N,0,Math.PI*2),d.fillStyle=Te.point,d.fill(),d.beginPath(),d.arc(P.x,P.y,2/a.camera.zoom,0,Math.PI*2),d.fillStyle="rgba(255, 255, 255, 0.7)",d.fill()}if(J&&$.length>1){const P=$[$.length-1],N=4/a.camera.zoom;d.beginPath(),d.arc(P.x,P.y,N,0,Math.PI*2),d.fillStyle=Te.point,d.fill()}})};return rs(()=>{b.value&&(d=b.value.getContext("2d"),he())}),ln(()=>{oe&&cancelAnimationFrame(oe)}),Gt([()=>a.width,()=>a.height],()=>{oe&&cancelAnimationFrame(oe),he()}),Gt([x,T,y],()=>{},{deep:!0}),l({tools:mt,colors:hs,setTool:xe=>{c.setTool(xe),r("tool-change",xe)},setColor:xe=>{c.setColor(xe)},clearAll:()=>{c.clearAll()}}),(xe,Me)=>(s(),n("canvas",{ref_key:"canvas",ref:b,class:"absolute top-0 left-0 pointer-events-none",width:t.width,height:t.height},null,8,ud))}},vd={class:"flex items-center gap-2 p-2 bg-slate-800/90 rounded-lg border border-white/10 backdrop-blur"},fd={class:"flex items-center gap-1"},Ad=["title","onClick"],pd={class:"flex items-center gap-1"},hd=["title","onClick"],gd={key:0,class:"flex items-center gap-2"},yd=["value"],bd={class:"text-xs text-white/80 w-4"},kd={key:1,class:"w-px h-6 bg-white/20"},xd={key:2,class:"ml-auto px-2 py-1 text-xs rounded bg-amber-500/20 text-amber-300"},wd={__name:"PointerToolbar",setup(t){const l=St(Cn,"pointer"),{activeTool:o=R("none"),activeColor:a=R("#ffffff"),lineWidth:r=R(3)}=Ut(l,"pointer"),c=[{id:mt.POINTER,icon:"👆",label:"Указка",title:"Указка - курсор виден всем",group:"pointer"},{id:mt.PING,icon:"📍",label:"Пинг",title:"Пинг - временный маркер",group:"pointer"},{id:mt.MEASURE,icon:"📐",label:"Линейка",title:"Измерить расстояние",group:"measure"},{id:mt.RANGE,icon:"🎯",label:"Радиус",title:"Показать зону досягаемости",group:"measure"},{id:mt.DRAW,icon:"✏️",label:"Рисовать",title:"Свободное рисование",group:"draw"},{id:mt.ARROW,icon:"➡️",label:"Стрелка",title:"Нарисовать стрелку",group:"draw"},{id:mt.CIRCLE,icon:"⭕",label:"Круг",title:"Нарисовать круг",group:"draw"},{id:mt.CONE,icon:"🔺",label:"Конус",title:"Нарисовать конус",group:"draw"},{id:mt.LINE,icon:"📏",label:"Линия",title:"Нарисовать линию",group:"draw"}],f=[{id:hs.RED,label:"Красный"},{id:hs.ORANGE,label:"Оранжевый"},{id:hs.YELLOW,label:"Жёлтый"},{id:hs.GREEN,label:"Зелёный"},{id:hs.BLUE,label:"Синий"},{id:hs.PURPLE,label:"Фиолетовый"},{id:hs.WHITE,label:"Белый"}],k=ne(()=>o.value!==mt.NONE),w=m=>{o.value===m?l.setTool(mt.NONE):l.setTool(m)},x=m=>{l.setColor(m)},T=m=>{l.setLineWidth(parseInt(m.target.value))},y=()=>{l.clearAll()},B=()=>{l.clearDrawings()};return(m,Y)=>{var j;return s(),n("div",vd,[e("div",fd,[(s(),n(ee,null,me(c,F=>e("button",{key:F.id,title:F.title,class:Q(["w-8 h-8 flex items-center justify-center rounded transition-all text-lg",i(o)===F.id?"bg-amber-500/30 ring-2 ring-amber-400":"hover:bg-white/10"]),onClick:ie=>w(F.id)},h(F.icon),11,Ad)),64))]),Y[1]||(Y[1]=e("div",{class:"w-px h-6 bg-white/20"},null,-1)),e("div",pd,[(s(),n(ee,null,me(f,F=>e("button",{key:F.id,title:F.label,class:Q(["w-6 h-6 rounded-full border-2 transition-all",i(a)===F.id?"border-white scale-110":"border-transparent hover:border-white/50"]),style:Qe({backgroundColor:F.id}),onClick:ie=>x(F.id)},null,14,hd)),64))]),Y[2]||(Y[2]=e("div",{class:"w-px h-6 bg-white/20"},null,-1)),i(o)==="draw"||i(o)==="line"?(s(),n("div",gd,[Y[0]||(Y[0]=e("span",{class:"text-xs text-white/60"},"Толщина:",-1)),e("input",{type:"range",min:"1",max:"15",value:i(r),class:"w-16 h-1 bg-white/20 rounded appearance-none cursor-pointer",onInput:T},null,40,yd),e("span",bd,h(i(r)),1)])):_("",!0),i(o)==="draw"||i(o)==="line"?(s(),n("div",kd)):_("",!0),e("div",{class:"flex items-center gap-1"},[e("button",{title:"Очистить рисунки",class:"px-2 py-1 text-xs rounded bg-white/5 hover:bg-white/10 transition-colors",onClick:B}," 🗑️ Рисунки "),e("button",{title:"Очистить всё",class:"px-2 py-1 text-xs rounded bg-red-500/20 hover:bg-red-500/30 text-red-300 transition-colors",onClick:y}," 🗑️ Всё ")]),k.value?(s(),n("div",xd,h(((j=c.find(F=>F.id===i(o)))==null?void 0:j.label)||"Активно"),1)):_("",!0)])}}},Cd={class:"map-control-panel"},$d={class:"panel-left"},_d={class:"map-selector"},Td=["value"],Id=["value"],Sd={class:"panel-center"},Ed=["title"],Pd={class:"hide-mobile"},Md={class:"panel-right"},Dd={class:"zoom-indicator"},Bd={__name:"MapControlPanel",props:{editingMap:{type:Boolean,default:!1},zoom:{type:Number,default:1}},emits:["toggle-editing","toggle-visibility","delete-map","create-map","select-map","center-camera"],setup(t,{emit:l}){const o=l,a=St(xs,"battleMap"),{maps:r=R([]),activeMapId:c=R(null),activeMap:f=R(null)}=Ut(a,"battleMap"),k=ne(()=>r.value.length),w=ne(()=>{var x,T;return((T=(x=f.value)==null?void 0:x.visibility)==null?void 0:T.published)??!1});return(x,T)=>(s(),n("div",Cd,[e("div",$d,[e("div",_d,[k.value>0?(s(),n("select",{key:0,value:i(c),class:"map-select",onChange:T[0]||(T[0]=y=>o("select-map",y.target.value))},[(s(!0),n(ee,null,me(i(r),y=>(s(),n("option",{key:y.id,value:y.id},h(y.name||"Без названия"),9,Id))),128))],40,Td)):_("",!0),e("button",{type:"button",class:"control-btn create-btn",onClick:T[1]||(T[1]=lt(y=>o("create-map"),["stop"])),title:"Создать карту"},[A(i(p),{icon:"mdi:plus"})])])]),e("div",Sd,[e("button",{type:"button",class:Q(["control-btn",{active:t.editingMap}]),onClick:T[2]||(T[2]=y=>o("toggle-editing"))},[A(i(p),{icon:t.editingMap?"mdi:check":"mdi:pencil"},null,8,["icon"]),e("span",null,h(t.editingMap?"Готово":"Редактировать"),1)],2),i(f)?(s(),n("button",{key:0,type:"button",class:Q(["control-btn",{active:w.value}]),onClick:T[3]||(T[3]=y=>o("toggle-visibility")),title:w.value?"Скрыть от игроков":"Показать игрокам"},[A(i(p),{icon:w.value?"mdi:eye":"mdi:eye-off"},null,8,["icon"]),e("span",Pd,h(w.value?"Видима":"Скрыта"),1)],10,Ed)):_("",!0)]),e("div",Md,[e("span",Dd,h(Math.round(t.zoom*100))+"%",1),e("button",{type:"button",class:"control-btn",title:"Центрировать (0,0)",onClick:T[4]||(T[4]=y=>o("center-camera"))},[A(i(p),{icon:"mdi:crosshairs-gps"})]),i(f)?(s(),n("button",{key:0,type:"button",class:"control-btn danger-btn",title:"Удалить карту",onClick:T[5]||(T[5]=y=>o("delete-map"))},[A(i(p),{icon:"mdi:delete"})])):_("",!0)])]))}},Rd=zt(Bd,[["__scopeId","data-v-2f0f5807"]]),Fd={class:"panel-content"},Ld={class:"panel-section"},Nd={class:"section-header"},Od={key:0,class:"queue-badge"},Hd={class:"section-content queue-controls"},qd={class:"panel-section"},Ud={class:"section-header"},Wd={class:"section-content pointer-tools"},zd={class:"panel-section tokens-section"},Vd={class:"section-header"},Qd={class:"section-content tokens-list"},jd=["onClick"],Gd={class:"token-info"},Yd={class:"token-name"},Xd={class:"token-pos"},Zd={class:"token-hp"},Jd=["onClick"],Kd={class:"hp-text"},eu={key:0,class:"empty-state"},tu={__name:"BattleControlPanel",props:{selectedToken:{type:Object,default:null},topOffset:{type:Number,default:60}},emits:["select-token","open-character-sheet"],setup(t,{emit:l}){const o=t,a=l,r=St(ws,"characters"),c=St(cs,"session"),f=St(Cn,"pointer"),k=St($n,"interaction"),{characters:w=R([])}=Ut(r,"characters"),{isQueuePaused:x=R(!1),messageQueue:T=R([])}=Ut(c,"session"),{battlePanelExpanded:y=R(!0)}=Ut(k,"interaction"),B=ne(()=>w.value.filter(D=>{var b;return(b=D.combat)==null?void 0:b.position})),m=R(null),Y=R(0),j=()=>{k.toggleBattlePanel()},F=D=>{m.value=D,Y.value=0},ie=()=>{m.value&&Y.value!==0&&r.modifyHP(m.value,Y.value),m.value=null,Y.value=0},W=()=>{m.value=null,Y.value=0},S=()=>{x.value?c.flushQueue({sequential:!1}):c.pauseQueue()},Z=()=>{c.flushQueue({sequential:!0,delay:200})},K=()=>{c.clearQueue()},X=ne(()=>f.currentTool),U=D=>{f.setTool(D)};return(D,b)=>(s(),n("div",{class:Q(["battle-control-panel",{expanded:i(y)}]),style:Qe({top:`${o.topOffset}px`})},[e("button",{class:"panel-toggle",onClick:j},[A(i(p),{icon:i(y)?"mdi:chevron-right":"mdi:chevron-left"},null,8,["icon"])]),e("div",Fd,[b[8]||(b[8]=e("div",{class:"panel-header"},[e("h3",null,"Управление боем")],-1)),e("div",Ld,[e("div",Nd,[A(i(p),{icon:"mdi:playlist-play"}),b[5]||(b[5]=e("span",null,"Планирование",-1)),i(T).length>0?(s(),n("span",Od,h(i(T).length),1)):_("",!0)]),e("div",Hd,[e("button",{class:Q(["queue-btn",{active:i(x)}]),onClick:S},[A(i(p),{icon:i(x)?"mdi:play":"mdi:pause"},null,8,["icon"]),e("span",null,h(i(x)?"Отправить":"Накапливать"),1)],2),i(x)&&i(T).length>0?(s(),n("button",{key:0,class:"queue-btn",onClick:Z},[A(i(p),{icon:"mdi:playlist-check"}),b[6]||(b[6]=e("span",null,"По очереди",-1))])):_("",!0),i(T).length>0?(s(),n("button",{key:1,class:"queue-btn danger",onClick:K},[A(i(p),{icon:"mdi:delete-sweep"})])):_("",!0)])]),e("div",qd,[e("div",Ud,[A(i(p),{icon:"mdi:cursor-default-click"}),b[7]||(b[7]=e("span",null,"Указка",-1))]),e("div",Wd,[e("button",{class:Q(["tool-btn",{active:X.value===i(mt).POINT}]),onClick:b[0]||(b[0]=d=>U(i(mt).POINT)),title:"Указать"},[A(i(p),{icon:"mdi:cursor-default"})],2),e("button",{class:Q(["tool-btn",{active:X.value===i(mt).DRAW}]),onClick:b[1]||(b[1]=d=>U(i(mt).DRAW)),title:"Рисовать"},[A(i(p),{icon:"mdi:pencil"})],2),e("button",{class:Q(["tool-btn",{active:X.value===i(mt).MEASURE}]),onClick:b[2]||(b[2]=d=>U(i(mt).MEASURE)),title:"Измерить"},[A(i(p),{icon:"mdi:ruler"})],2),X.value!==i(mt).NONE?(s(),n("button",{key:0,class:"tool-btn",onClick:b[3]||(b[3]=d=>U(i(mt).NONE)),title:"Выключить"},[A(i(p),{icon:"mdi:close"})])):_("",!0)])]),e("div",zd,[e("div",Vd,[A(i(p),{icon:"mdi:account-group"}),e("span",null,"На карте ("+h(B.value.length)+")",1)]),e("div",Qd,[(s(!0),n(ee,null,me(B.value,d=>{var oe,he,M,de,H;return s(),n("div",{key:d.id,class:Q(["token-item",{selected:((oe=t.selectedToken)==null?void 0:oe.characterId)===d.id}]),onClick:z=>a("select-token",d)},[e("div",Gd,[e("span",Yd,h(d.name),1),e("span",Xd," ("+h(d.combat.position.q)+", "+h(d.combat.position.r)+") ",1)]),e("div",Zd,[m.value===d.id?(s(),n(ee,{key:0},[De(e("input",{"onUpdate:modelValue":b[4]||(b[4]=z=>Y.value=z),type:"number",class:"hp-input",placeholder:"±HP",onKeyup:[ks(ie,["enter"]),ks(W,["escape"])]},null,544),[[je,Y.value,void 0,{number:!0}]]),e("button",{class:"hp-btn confirm",onClick:ie},[A(i(p),{icon:"mdi:check"})]),e("button",{class:"hp-btn cancel",onClick:W},[A(i(p),{icon:"mdi:close"})])],64)):(s(),n("div",{key:1,class:"hp-bar",onClick:lt(z=>F(d.id),["stop"])},[e("div",{class:"hp-fill",style:Qe({width:`${Math.min(100,(((he=d.hp)==null?void 0:he.current)||0)/(((M=d.hp)==null?void 0:M.max)||1)*100)}%`})},null,4),e("span",Kd,h(((de=d.hp)==null?void 0:de.current)||0)+"/"+h(((H=d.hp)==null?void 0:H.max)||"?"),1)],8,Jd))])],10,jd)}),128)),B.value.length===0?(s(),n("div",eu," Нет токенов на карте ")):_("",!0)])])])],6))}},su=zt(tu,[["__scopeId","data-v-34576bae"]]),nu={class:"panel-content"},lu={key:0,class:"panel-section"},ou={class:"section-header"},au={class:"section-content"},iu={class:"tools-grid"},ru=["title","onClick"],cu={class:"tool-label"},du={key:1,class:"panel-section undo-redo-section"},uu={class:"section-content"},mu={class:"undo-redo-buttons"},vu=["disabled"],fu=["disabled"],Au={class:"panel-section"},pu={class:"section-header"},hu={class:"section-content"},gu={class:"shape-grid"},yu=["title","onClick"],bu={class:"panel-section"},ku={class:"section-header"},xu={key:0,class:"modifier-hint"},wu={class:"section-content"},Cu={class:"mode-list"},$u=["title","onClick"],_u={key:0,class:"panel-section"},Tu={class:"section-header"},Iu={class:"value-badge"},Su={class:"section-content"},Eu=["value"],Pu={key:1,class:"panel-section selection-actions"},Mu={class:"section-header"},Du={class:"section-content"},Bu={class:"section-header sub-header"},Ru={class:"brush-type-list"},Fu=["onClick"],Lu={class:"action-row",style:{"margin-top":"0.5rem"}},Nu=["title"],Ou={class:"panel-section"},Hu={class:"section-header"},qu={class:"value-badge"},Uu={class:"section-content"},Wu=["value"],zu={class:"panel-section"},Vu={class:"section-header"},Qu={class:"section-content"},ju={class:"brush-type-list"},Gu=["onClick"],Yu={key:4,class:"panel-section"},Xu={class:"section-header"},Zu={class:"value-badge"},Ju={class:"section-content"},Ku=["value"],em={key:5,class:"panel-section terrain-section"},tm={class:"section-header"},sm={class:"terrain-count"},nm={class:"section-content terrain-content"},lm={class:"terrain-display-modes"},om=["title","onClick"],am={class:"terrain-filter"},im={class:"terrain-grid-compact"},rm=["title","onClick"],cm={class:"tile-label"},dm={key:6,class:"panel-section profile-section"},um={class:"section-header"},mm={class:"terrain-count"},vm={class:"section-content profile-content"},fm={class:"terrain-filter"},Am={class:"profile-list"},pm=["onClick"],hm={class:"profile-card-header"},gm={class:"profile-name"},ym={class:"profile-card-meta"},bm={class:"profile-base"},km={class:"profile-layers"},xm=["onClick"],wm={key:7,class:"empty-state"},Cm={__name:"EditorToolsPanel",props:{editingMap:{type:Boolean,default:!1},editorMode:{type:String,default:"select"},topOffset:{type:Number,default:60},selectedTerrain:{type:String,default:null},selectedHexCount:{type:Number,default:0}},emits:["set-editor-mode","toggle-editing","select-terrain","select-profile","edit-profile","fill-selection","fill-profile","delete-selection","clear-selection","undo","redo"],setup(t,{emit:l}){const o=t,a=l,r=St(xs,"battleMap"),c=St(an,"terrain"),f=St(wn,"fillProfile"),k=St(ra,"mapHistory"),{selection:w=R(null),brush:x=R(null)}=Ut(r,"battleMap"),{canUndo:T=R(!1),canRedo:y=R(!1)}=Ut(k,"mapHistory"),{allTerrains:B=R([])}=Ut(c,"terrain"),{sortedProfiles:m=R([]),currentProfile:Y=R(null)}=Ut(f,"fillProfile"),j=R(!0);R(!1);const F=R(""),ie=R("name"),W=R(""),S=R("terrain"),Z=[{id:"terrain",icon:"mdi:terrain",label:"Террейн"},{id:"profile",icon:"mdi:dice-multiple",label:"Профиль"}],K=[{id:"terrain",icon:"mdi:terrain",label:"Террейн"},{id:"profile",icon:"mdi:dice-multiple",label:"Профиль"}],X=ne(()=>{const C=m.value||[];if(!W.value)return C;const L=W.value.toLowerCase();return C.filter($e=>{var Ae;return $e.name.toLowerCase().includes(L)||((Ae=$e.description)==null?void 0:Ae.toLowerCase().includes(L))})}),U=ne(()=>{if(!F.value)return B.value;const C=F.value.toLowerCase();return B.value.filter(L=>{var $e,Ae;return L.name.toLowerCase().includes(C)||(($e=L.biome)==null?void 0:$e.toLowerCase().includes(C))||((Ae=L.tags)==null?void 0:Ae.some(Ee=>Ee.toLowerCase().includes(C)))})});ne(()=>o.selectedTerrain?c.getTerrainById(o.selectedTerrain)||{name:o.selectedTerrain,color:"#888"}:{name:"Выберите",color:"#888"});const D=C=>{var L;switch(ie.value){case"cost":return((L=C.movementCost)==null?void 0:L.toString())||"?";case"visibility":return C.visibility==="open"?"○":C.visibility==="partial"?"◐":C.visibility==="blocking"?"●":"?";case"name":default:return C.name}},b=[{id:"name",icon:"mdi:format-title",label:"Имя"},{id:"cost",icon:"mdi:run-fast",label:"Ход"},{id:"visibility",icon:"mdi:eye",label:"Обзор"}],d=[{id:"select",icon:"mdi:cursor-default",label:"Выбор",description:"Выделение областей"},{id:"paint",icon:"mdi:brush",label:"Кисть",description:"Рисование террейна"},{id:"erase",icon:"mdi:eraser",label:"Ластик",description:"Удаление гексов"}],oe=[{id:Bt.RECTANGLE,icon:"mdi:rectangle-outline",label:"Прямоугольник"},{id:Bt.CIRCLE,icon:"mdi:circle-outline",label:"Круг"},{id:Bt.HEXAGON,icon:"mdi:hexagon-outline",label:"Шестиугольник"},{id:Bt.LINE,icon:"mdi:vector-line",label:"Линия"}],he=[{id:qt.REPLACE,icon:"mdi:selection",label:"Новое",description:"Заменить выделение"},{id:qt.ADD,icon:"mdi:selection-ellipse-arrow-inside",label:"Добавить",description:"Shift: добавить к выделению"},{id:qt.SUBTRACT,icon:"mdi:selection-remove",label:"Вычесть",description:"Alt: вычесть из выделения"}];os.AGGRESSIVE,os.STANDARD,os.PASSIVE;const M=R({shift:!1,alt:!1}),de=ne(()=>M.value.shift&&M.value.alt?null:M.value.shift?qt.ADD:M.value.alt?qt.SUBTRACT:qt.REPLACE);Gt(de,C=>{var L;C&&((L=w.value)==null?void 0:L.mode)!==C&&r.setSelectionMode(C)});const H=C=>{var $e;let L=!1;C.key==="Shift"&&!M.value.shift&&(M.value.shift=!0,L=!0),C.key==="Alt"&&!M.value.alt&&(M.value.alt=!0,L=!0),L&&de.value&&(($e=w.value)==null?void 0:$e.mode)!==de.value&&r.setSelectionMode(de.value)},z=C=>{var $e;let L=!1;C.key==="Shift"&&M.value.shift&&(M.value.shift=!1,L=!0),C.key==="Alt"&&M.value.alt&&(M.value.alt=!1,L=!0),L&&de.value&&(($e=w.value)==null?void 0:$e.mode)!==de.value&&r.setSelectionMode(de.value)},q=()=>{(M.value.shift||M.value.alt)&&(M.value.shift=!1,M.value.alt=!1,r.setSelectionMode(qt.REPLACE))};rs(()=>{window.addEventListener("keydown",H),window.addEventListener("keyup",z),window.addEventListener("blur",q)}),ln(()=>{window.removeEventListener("keydown",H),window.removeEventListener("keyup",z),window.removeEventListener("blur",q)});const Ie=()=>{j.value=!j.value};return(C,L)=>{var $e,Ae,Ee,Se,Be,He,Ne,ot,We;return s(),n("div",{class:Q(["editor-tools-panel",{expanded:j.value,"editing-active":t.editingMap}]),style:Qe({top:`${o.topOffset}px`})},[e("button",{class:"panel-toggle",onClick:Ie},[A(i(p),{icon:j.value?"mdi:chevron-left":"mdi:chevron-right"},null,8,["icon"])]),e("div",nu,[t.editingMap?(s(),n("div",lu,[e("div",ou,[A(i(p),{icon:"mdi:tools"}),L[13]||(L[13]=e("span",null,"Инструмент",-1))]),e("div",au,[e("div",iu,[(s(),n(ee,null,me(d,ce=>e("button",{key:ce.id,type:"button",class:Q(["tool-tile",{active:t.editorMode===ce.id}]),title:ce.description,onClick:Je=>a("set-editor-mode",ce.id)},[A(i(p),{icon:ce.icon,class:"tool-icon"},null,8,["icon"]),e("span",cu,h(ce.label),1)],10,ru)),64))])])])):_("",!0),t.editingMap?(s(),n("div",du,[e("div",uu,[e("div",mu,[e("button",{type:"button",class:Q(["undo-redo-btn",{disabled:!i(T)}]),disabled:!i(T),title:"Отменить (Ctrl+Z)",onClick:L[0]||(L[0]=ce=>a("undo"))},[A(i(p),{icon:"mdi:undo"}),L[14]||(L[14]=e("span",null,"Отмена",-1))],10,vu),e("button",{type:"button",class:Q(["undo-redo-btn",{disabled:!i(y)}]),disabled:!i(y),title:"Повторить (Ctrl+Y)",onClick:L[1]||(L[1]=ce=>a("redo"))},[A(i(p),{icon:"mdi:redo"}),L[15]||(L[15]=e("span",null,"Повтор",-1))],10,fu)])])])):_("",!0),t.editingMap&&t.editorMode==="select"?(s(),n(ee,{key:2},[e("div",Au,[e("div",pu,[A(i(p),{icon:"mdi:shape-outline"}),L[16]||(L[16]=e("span",null,"Форма",-1))]),e("div",hu,[e("div",gu,[(s(),n(ee,null,me(oe,ce=>{var Je;return e("button",{key:ce.id,type:"button",class:Q(["shape-btn",{active:((Je=i(w))==null?void 0:Je.shape)===ce.id}]),title:ce.label,onClick:Ke=>i(r).setSelectionShape(ce.id)},[A(i(p),{icon:ce.icon},null,8,["icon"])],10,yu)}),64))])])]),e("div",bu,[e("div",ku,[A(i(p),{icon:"mdi:selection-multiple"}),L[17]||(L[17]=e("span",null,"Режим",-1)),M.value.shift||M.value.alt?(s(),n("span",xu,h(M.value.shift?"Shift":"")+h(M.value.shift&&M.value.alt?"+":"")+h(M.value.alt?"Alt":""),1)):_("",!0)]),e("div",wu,[e("div",Cu,[(s(),n(ee,null,me(he,ce=>{var Je,Ke;return e("button",{key:ce.id,type:"button",class:Q(["selection-mode-btn",{active:((Je=i(w))==null?void 0:Je.mode)===ce.id,"temp-active":de.value===ce.id&&de.value!==((Ke=i(w))==null?void 0:Ke.mode)}]),title:ce.description,onClick:xe=>i(r).setSelectionMode(ce.id)},[A(i(p),{icon:ce.icon},null,8,["icon"]),e("span",null,h(ce.label),1)],10,$u)}),64))]),L[18]||(L[18]=e("p",{class:"hint-text"},"Shift: добавить • Alt: вычесть",-1))])]),(($e=i(w))==null?void 0:$e.shape)===i(Bt).LINE?(s(),n("div",_u,[e("div",Tu,[A(i(p),{icon:"mdi:arrow-expand-horizontal"}),L[19]||(L[19]=e("span",null,"Ширина линии",-1)),e("span",Iu,h(((Ae=i(w))==null?void 0:Ae.lineWidth)??1),1)]),e("div",Su,[e("input",{type:"range",min:"1",max:"5",value:((Ee=i(w))==null?void 0:Ee.lineWidth)??1,class:"width-slider",onInput:L[2]||(L[2]=ce=>i(r).setSelectionLineWidth(Number(ce.target.value)))},null,40,Eu),L[20]||(L[20]=e("div",{class:"slider-labels"},[e("span",null,"1"),e("span",null,"5")],-1))])])):_("",!0),t.selectedHexCount>0?(s(),n("div",Pu,[e("div",Mu,[A(i(p),{icon:"mdi:hexagon-multiple"}),e("span",null,"Выделено: "+h(t.selectedHexCount),1)]),e("div",Du,[e("div",Bu,[A(i(p),{icon:"mdi:format-color-fill"}),L[21]||(L[21]=e("span",null,"Заливать",-1))]),e("div",Ru,[(s(),n(ee,null,me(K,ce=>e("button",{key:ce.id,type:"button",class:Q(["brush-type-btn",{active:S.value===ce.id}]),onClick:Je=>S.value=ce.id},[A(i(p),{icon:ce.icon},null,8,["icon"]),e("span",null,h(ce.label),1)],10,Fu)),64))]),e("div",Lu,[e("button",{type:"button",class:"action-btn primary-btn",title:S.value==="terrain"?"Залить террейном":"Залить профилем",onClick:L[3]||(L[3]=ce=>S.value==="terrain"?a("fill-selection"):a("fill-profile"))},[A(i(p),{icon:"mdi:format-color-fill"}),L[22]||(L[22]=e("span",null,"Залить",-1))],8,Nu),e("button",{type:"button",class:"action-btn danger-btn",title:"Удалить выбранные гексы",onClick:L[4]||(L[4]=ce=>a("delete-selection"))},[A(i(p),{icon:"mdi:delete"})]),e("button",{type:"button",class:"action-btn",title:"Снять выделение",onClick:L[5]||(L[5]=ce=>a("clear-selection"))},[A(i(p),{icon:"mdi:close"})])])])])):_("",!0)],64)):_("",!0),t.editingMap&&t.editorMode==="paint"?(s(),n(ee,{key:3},[e("div",Ou,[e("div",Hu,[A(i(p),{icon:"mdi:radius-outline"}),L[23]||(L[23]=e("span",null,"Размер кисти",-1)),e("span",qu,h(((Se=i(x))==null?void 0:Se.size)??1),1)]),e("div",Uu,[e("input",{type:"range",min:"1",max:"5",value:((Be=i(x))==null?void 0:Be.size)??1,class:"width-slider",onInput:L[6]||(L[6]=ce=>i(r).setBrushSize(Number(ce.target.value)))},null,40,Wu),L[24]||(L[24]=e("div",{class:"slider-labels"},[e("span",null,"1"),e("span",null,"5")],-1))])]),e("div",zu,[e("div",Vu,[A(i(p),{icon:"mdi:brush-variant"}),L[25]||(L[25]=e("span",null,"Рисовать",-1))]),e("div",Qu,[e("div",ju,[(s(),n(ee,null,me(Z,ce=>{var Je;return e("button",{key:ce.id,type:"button",class:Q(["brush-type-btn",{active:(((Je=i(x))==null?void 0:Je.type)??"terrain")===ce.id}]),onClick:Ke=>i(r).setBrushType(ce.id)},[A(i(p),{icon:ce.icon},null,8,["icon"]),e("span",null,h(ce.label),1)],10,Gu)}),64))])])])],64)):_("",!0),t.editingMap&&t.editorMode==="erase"?(s(),n("div",Yu,[e("div",Xu,[A(i(p),{icon:"mdi:radius-outline"}),L[26]||(L[26]=e("span",null,"Размер ластика",-1)),e("span",Zu,h(((He=i(x))==null?void 0:He.size)??1),1)]),e("div",Ju,[e("input",{type:"range",min:"1",max:"5",value:((Ne=i(x))==null?void 0:Ne.size)??1,class:"width-slider",onInput:L[7]||(L[7]=ce=>i(r).setBrushSize(Number(ce.target.value)))},null,40,Ku),L[27]||(L[27]=e("div",{class:"slider-labels"},[e("span",null,"1"),e("span",null,"5")],-1))])])):_("",!0),t.editingMap&&(t.editorMode==="paint"&&(((ot=i(x))==null?void 0:ot.type)??"terrain")==="terrain"||t.editorMode==="select"&&S.value==="terrain")?(s(),n("div",em,[e("div",tm,[A(i(p),{icon:"mdi:palette"}),L[28]||(L[28]=e("span",null,"Террейн",-1)),e("span",sm,h(U.value.length),1)]),e("div",nm,[e("div",lm,[(s(),n(ee,null,me(b,ce=>e("button",{key:ce.id,type:"button",class:Q(["display-mode-btn",{active:ie.value===ce.id}]),title:ce.label,onClick:Je=>ie.value=ce.id},[A(i(p),{icon:ce.icon},null,8,["icon"])],10,om)),64))]),e("div",am,[A(i(p),{icon:"mdi:magnify",class:"filter-icon"}),De(e("input",{"onUpdate:modelValue":L[8]||(L[8]=ce=>F.value=ce),type:"text",placeholder:"Поиск...",class:"filter-input"},null,512),[[je,F.value]]),F.value?(s(),n("button",{key:0,class:"filter-clear",onClick:L[9]||(L[9]=ce=>F.value="")},[A(i(p),{icon:"mdi:close"})])):_("",!0)]),e("div",im,[(s(!0),n(ee,null,me(U.value,ce=>(s(),n("button",{key:ce.id,type:"button",class:Q(["terrain-tile-compact",{selected:t.selectedTerrain===ce.id}]),title:`${ce.name} • Ход: ${ce.movementCost} • ${ce.visibility==="open"?"Открытая":ce.visibility==="partial"?"Частичная":"Блокирующая"}`,onClick:Je=>a("select-terrain",ce.id)},[e("span",{class:"tile-bg",style:Qe({backgroundColor:ce.fallbackColor||ce.color})},[e("span",cm,h(D(ce)),1)],4)],10,rm))),128))])])])):_("",!0),t.editingMap&&(t.editorMode==="paint"&&(((We=i(x))==null?void 0:We.type)??"terrain")==="profile"||t.editorMode==="select"&&S.value==="profile")?(s(),n("div",dm,[e("div",um,[A(i(p),{icon:"mdi:dice-multiple"}),L[29]||(L[29]=e("span",null,"Профиль",-1)),e("span",mm,h(X.value.length),1)]),e("div",vm,[e("div",fm,[A(i(p),{icon:"mdi:magnify",class:"filter-icon"}),De(e("input",{"onUpdate:modelValue":L[10]||(L[10]=ce=>W.value=ce),type:"text",placeholder:"Поиск...",class:"filter-input"},null,512),[[je,W.value]]),W.value?(s(),n("button",{key:0,class:"filter-clear",onClick:L[11]||(L[11]=ce=>W.value="")},[A(i(p),{icon:"mdi:close"})])):_("",!0)]),e("div",Am,[(s(!0),n(ee,null,me(X.value,ce=>{var Je,Ke,xe;return s(),n("div",{key:ce.id,class:Q(["profile-card",{selected:i(r).selectedProfileId===ce.id}])},[e("button",{type:"button",class:"profile-card-main",onClick:Me=>{a("select-profile",ce.id),i(r).setSelectedProfile(ce.id),i(f).selectProfile(ce.id)}},[e("div",hm,[A(i(p),{icon:"mdi:dice-multiple",class:"profile-icon"}),e("span",gm,h(ce.name),1)]),e("div",ym,[e("span",bm,[e("span",{class:"base-color-dot",style:Qe({backgroundColor:((Je=i(c).getTerrainById(ce.baseTerrain))==null?void 0:Je.color)||"#888"})},null,4),Ce(" "+h(((Ke=i(c).getTerrainById(ce.baseTerrain))==null?void 0:Ke.name)||ce.baseTerrain),1)]),e("span",km,"+"+h(((xe=ce.layers)==null?void 0:xe.length)||0)+" сл.",1)])],8,pm),e("button",{type:"button",class:"profile-edit-btn",title:"Редактировать профиль",onClick:Me=>{i(f).selectProfile(ce.id),a("edit-profile",ce.id)}},[A(i(p),{icon:"mdi:pencil"})],8,xm)],2)}),128))]),e("button",{type:"button",class:"create-profile-btn",onClick:L[12]||(L[12]=ce=>i(f).createProfile({name:"Новый профиль"}))},[A(i(p),{icon:"mdi:plus"}),L[30]||(L[30]=e("span",null,"Новый профиль",-1))])])])):_("",!0),t.editingMap?_("",!0):(s(),n("div",wm,[A(i(p),{icon:"mdi:pencil-off",class:"empty-icon"}),L[31]||(L[31]=e("p",null,'Нажмите "Редактировать" для доступа к инструментам',-1))]))])],6)}}},$m=zt(Cm,[["__scopeId","data-v-59cd4009"]]),_m={class:"h-full bg-slate-950 text-slate-50 flex flex-col overflow-hidden relative"},Tm={key:0,class:"bg-slate-900/90 backdrop-blur border-b border-white/10 px-4 py-2 flex items-center justify-between flex-shrink-0 gap-2 relative z-20"},Im={class:"flex items-center gap-2"},Sm={key:0,class:"relative"},Em={class:"font-medium truncate max-w-32"},Pm=["onClick"],Mm={class:"text-sm font-medium"},Dm={class:"text-xs text-slate-400"},Bm={key:0,class:"text-xs text-emerald-400"},Rm={key:0,class:"border-t border-white/10 mt-1 pt-1"},Fm={key:1,class:"flex items-center gap-2"},Lm={key:0,class:"px-3 py-1.5 rounded-lg bg-slate-800 border border-white/10 text-sm font-medium"},Nm={key:1,class:"px-3 py-1.5 rounded-lg bg-slate-800/50 border border-white/10 text-sm text-slate-400"},Om={key:0,class:"text-xs px-2 py-1 rounded bg-slate-800 border border-white/10"},Hm={key:1,class:"text-xs px-2 py-1 rounded bg-slate-700 text-slate-400"},qm={key:0,class:"flex items-center gap-1"},Um=["title","onClick"],Wm={class:"relative"},zm={class:"p-2 border-b border-white/10"},Vm={class:"overflow-y-auto flex-1 p-2"},Qm={key:0,class:"mb-3"},jm={class:"grid grid-cols-2 gap-1"},Gm=["onClick"],Ym={class:"w-5 h-5 rounded-full bg-slate-700 flex items-center justify-center text-[10px] flex-shrink-0 overflow-hidden"},Xm=["src"],Zm={key:1},Jm={class:"truncate flex-1"},Km={key:0,class:"text-emerald-400"},ev={key:1},tv={class:"grid grid-cols-2 gap-1"},sv=["onClick"],nv={class:"w-5 h-5 rounded-full bg-slate-700 flex items-center justify-center text-[10px] flex-shrink-0 overflow-hidden"},lv=["src"],ov={key:1},av={class:"truncate flex-1"},iv={key:0,class:"text-emerald-400"},rv={key:2,class:"text-xs text-slate-500 italic text-center py-4"},cv={class:"relative"},dv={class:"mb-3"},uv={class:"flex gap-1"},mv=["title","onClick"],vv={class:"mb-3"},fv={class:"flex gap-1"},Av=["title","onClick"],pv={class:"mb-3"},hv={class:"flex gap-1"},gv=["title","onClick"],yv={class:"text-[10px] text-slate-500 mt-1"},bv={key:0},kv={class:"text-xs text-slate-400 mb-1"},xv=["value"],wv={class:"text-xs text-slate-400 px-1"},Cv={class:"relative"},$v={class:"text-xs"},_v={class:"p-2 border-b border-white/10"},Tv={class:"flex items-center gap-2"},Iv={key:0,class:"mt-2 space-y-2"},Sv={class:"flex items-center gap-2"},Ev=["value"],Pv={class:"flex items-center gap-2"},Mv=["value"],Dv={class:"flex items-center gap-2"},Bv={class:"text-xs text-slate-300 w-8"},Rv={class:"p-2 max-h-64 overflow-y-auto"},Fv={key:0,class:"grid grid-cols-5 gap-1"},Lv=["title","onClick"],Nv={class:"absolute bottom-0 left-0 right-0 flex justify-center gap-0.5 p-0.5 bg-black/50 opacity-0 group-hover:opacity-100 transition"},Ov={key:0,class:"text-[8px]"},Hv={key:1,class:"text-[8px]"},qv={key:2,class:"text-[8px]"},Uv={key:3,class:"text-[8px]"},Wv={key:4,class:"text-[8px] text-green-400"},zv={key:5,class:"text-[8px] text-red-400"},Vv={key:1,class:"text-center text-xs text-slate-400 py-4"},Qv={key:2,class:"mt-2 pt-2 border-t border-white/10"},jv={class:"grid grid-cols-5 gap-1"},Gv=["title","onClick"],Yv={class:"flex items-center gap-2"},Xv=["title"],Zv={class:"flex-1 flex overflow-hidden"},Jv=["width","height"],Kv=["width","height"],ef=["width","height"],tf={key:0,class:"absolute top-2 left-1/2 -translate-x-1/2 z-20"},sf={key:3,class:"absolute bottom-4 left-4 px-3 py-1.5 rounded-lg bg-slate-900/90 border border-white/10 text-xs font-mono pointer-events-none"},nf={key:4,class:"absolute bottom-4 right-4 px-3 py-1.5 rounded-lg bg-slate-900/90 border border-white/10 text-xs pointer-events-none"},lf={class:"relative z-30"},of={key:1,class:"bg-slate-900/80 backdrop-blur border-t border-white/10 px-4 py-2 flex-shrink-0 relative z-10"},af={class:"flex items-center justify-between text-sm"},rf={class:"text-slate-400 text-xs"},cf={class:"bg-slate-800 border border-white/10 rounded-xl p-6 w-full max-w-md shadow-2xl"},df={class:"space-y-4"},uf={class:"flex gap-2"},mf=["value"],vf={class:"flex justify-end gap-2 mt-6"},Xl=5,ff=80,Af=25,gn=45,Zl=15,pf={__name:"BattleMap",props:{readonly:{type:Boolean,default:!1},mobileMode:{type:Boolean,default:!1},pendingAction:{type:Object,default:null}},emits:["action-target-selected","token-selected","hex-selected","hex-double-tap","hex-long-press-move","hex-long-press-confirm","token-rotate"],setup(t,{expose:l,emit:o}){const a=t,r=o,c=St(xs,"battleMap"),f=St(an,"terrain"),k=St(wn,"fillProfile"),w=St(cs,"session"),x=St(ws,"characters"),T=St(on,"user"),y=St(Cn,"pointer"),B=St($n,"interaction"),{activeMap:m=R(null),editingMap:Y=R(null),editorMode:j=R(null),selectedTerrain:F=R(null),activeLayerId:ie=R(null),camera:W=R({x:0,y:0,zoom:1}),maps:S=R([]),publishedMaps:Z=R([]),selection:K=R(null),brush:X=R(null)}=Ut(c,"battleMap"),{activeTool:U=R("none")}=Ut(y,"pointer"),{isMaster:D=R(!1)}=Ut(w,"session"),{characters:b=R([]),npcs:d=R([]),otherTokens:oe=R([])}=Ut(x,"characters"),{state:he=R("idle"),targetHex:M=R(null),selectedFacing:de=R(null)}=Ut(B,"interaction"),H=ne(()=>{const g=[...b.value||[]];return D.value&&(d.value||[]).forEach(se=>{g.push({...se,isNpc:!0})}),g}),z=g=>{var v;return g?D.value?!0:((v=g.character)==null?void 0:v.ownerId)===T.userId:!1},q=ne(()=>a.readonly||!D.value),Ie=ne(()=>!q.value),C=ne(()=>!!Y.value),L=ne(()=>{var v;return((v=T.infoPanelState)==null?void 0:v["battle-map"])??!1?200:56}),$e=ne(()=>L.value-50),Ae=R(null),Ee=R(null),Se=R(null),Be=R(null),He=R(null),Ne=R({width:800,height:600}),ot=R(!1),We=R(!1),ce=R(!1),Je=R(!1),Ke=R(!1),xe=R(!1),Me=R(!1),Pe=R(!1),Re=R(""),ke=R(null),ge=R(null),ae=R(null),Xe=R(!1),Ze=R(!1),vt=R(new Set),te=R(!1),J=R(null),Te=R({x:0,y:0}),$=R(null),P=R(null),N=R(""),Ge=R(null),rt=R(null),ft=R({min:1,max:5}),Et=R(!1),At=R(!1),dt=R(null),$t=R(null),re=R([]),ye=R(new Set),pe=R(null),Ue=R({x:0,y:0}),Wt=R(!1),Rt=R(null),gt=R({x:0,y:0}),bt=R({name:"",orientation:$s.FLAT,scale:_s.BATTLE,hexSize:32}),Ye=ne(()=>{const g=m.value;return g?new ca({orientation:g.orientation,hexSize:g.hexSize,origin:{x:0,y:0}}):null}),Ms=(g,v,se,le)=>(Math.abs(g-se)+Math.abs(g+v-se-le)+Math.abs(v-le))/2,fe=(g,v,se,le)=>{const we=Ms(g,v,se,le);if(we===0)return[{q:g,r:v}];const Le=[];for(let E=0;E<=we;E++){const ve=E/we,ue=g+(se-g)*ve,_e=v+(le-v)*ve,qe=-g-v,Ve=-se-le,pt=qe+(Ve-qe)*ve;let nt=Math.round(ue),it=Math.round(_e),at=Math.round(pt);const yt=Math.abs(nt-ue),Ct=Math.abs(it-_e),wt=Math.abs(at-pt);yt>Ct&&yt>wt?nt=-it-at:Ct>wt&&(it=-nt-at),Le.push({q:nt,r:it})}return Le},I=(g,v,se,le)=>{var Ve;const we=se-g,Le=le-v;let E=Math.atan2(Le,we)*(180/Math.PI);for(E=E+180+90;E<0;)E+=360;for(;E>=360;)E-=360;const ue=((Ve=Ye.value)==null?void 0:Ve.orientation)==="pointy"?0:90;let _e=E-ue;for(;_e<0;)_e+=360;return Math.floor((_e+15)/30)%12},Fe=(g=null)=>{const v=m.value;if(!v)return()=>null;const se=new Set;if(g){const le=g.movementModifiers||g.abilities||{};le.flight&&se.add("flight"),le.swimming&&se.add("swimming"),le.phasing&&se.add("phasing"),le.climbing&&se.add("climbing"),g.movementTags&&g.movementTags.forEach(we=>se.add(we))}return(le,we)=>c.getHexPathfindingData(v.id,le,we,f,{viewerId:g==null?void 0:g.id,characterTags:se})},et=(g,v,se=6,le=null)=>{const we=Fe(),Le=Sl({q:g,r:v},se,we,{modifiers:le}),E=El(Le);y.showRange(g,v,se,E)},O=g=>{var ve,ue,_e,qe,Ve;if(!g||!m.value){y.hideMovementRange();return}if(!(((ve=g.character)==null?void 0:ve.ownerId)===T.userId)&&!D.value){y.hideMovementRange();return}const se=c.findTokenPosition(m.value.id,g.characterId);if(!se){y.hideMovementRange();return}let le=x.getAvailableMovement(g.characterId);if(le===0&&(le=((qe=(_e=(ue=g.character)==null?void 0:ue.combat)==null?void 0:_e.movement)==null?void 0:qe.current)??5),console.log("📍 showMovementRangeForToken:",{characterId:g.characterId,position:se,movementPoints:le}),le<=0){y.hideMovementRange();return}const we=Fe(),Le=Sl(se,le,we,{modifiers:((Ve=g.character)==null?void 0:Ve.movementModifiers)||{}}),E=El(Le);y.showMovementRange(g.characterId,se,E,le)},u=ne(()=>{if(!m.value||!Ye.value)return[];d.value,b.value,oe.value;const g=c.getAllTokens(m.value.id),v=Ye.value;return g.map(se=>{const le=x.getCharacterById(se.characterId);if(!le)return null;const we=Ss.getAnimatedPosition(se.characterId);let Le,E,ve;if(we)Le=we.x,E=we.y,ve=we.facing;else{const ue=v.hexToPixel(se.q,se.r);Le=ue.x,E=ue.y,ve=se.facing}return{...se,character:le,pixelX:Le,pixelY:E,facing:ve,isAnimating:!!we,meleeDefence:gs(le,"melee"),rangedDefence:gs(le,"ranged")}}).filter(Boolean)}),be=ne(()=>m.value?Math.floor(m.value.hexSize*1.6):48),ze=ne(()=>Ye.value?new da(Ye.value):null),ut=ne(()=>f.getFilteredTerrains({biome:Ge.value,visibility:rt.value,passabilityMin:ft.value.min,passabilityMax:ft.value.max,search:N.value})),xt=ne(()=>[...f.baseTerrains,...f.customTerrains]),Dt=ne(()=>{const g=xt.value.find(v=>v.id===F.value);if(g)return g;if(Xs[F.value]){const v=Xs[F.value];return{id:F.value,name:v.name,fallbackColor:v.color,passability:v.passable?1:0}}return{id:"void",name:"Пустота",fallbackColor:"#0d1117",passability:0}}),Ht=g=>{if(!g||!m.value)return g;const v=c.getHexTerrain(m.value.id,g.q,g.r),se=f.getTerrainById(v);return{q:g.q,r:g.r,terrain:se||null}},ns=g=>{console.log("[BattleMap] Получена анимация токена:",g,"myUserId:",T.userId,"isMaster:",D.value),Da({payload:g,myUserId:T.userId,battleMapStore:c,getHexGrid:()=>Ye.value,getActiveMap:()=>m.value})};rs(()=>{Ws(),Ss.setRenderCallback(()=>{Nt()}),w.onMessage("token-animation",ns),window.addEventListener("keydown",Ft),Ie.value&&(S.value.length===0?ml():m.value||c.setActiveMap(S.value[0].id)),As(),fs(()=>{Nt()}),window.addEventListener("resize",zs)}),ln(()=>{window.removeEventListener("resize",zs),window.removeEventListener("keydown",Ft),Ss.setRenderCallback(null),Ss.stopAll()});const Ft=g=>{const v=g.code;if((g.ctrlKey||g.metaKey)&&v==="KeyZ"&&!g.shiftKey&&j.value){c.undo(),Nt(),g.preventDefault();return}if((g.ctrlKey||g.metaKey)&&(v==="KeyY"||v==="KeyZ"&&g.shiftKey)&&j.value){c.redo(),Nt(),g.preventDefault();return}if(g.key==="Escape"){if(ct.value.showFacingPicker){fn(),g.preventDefault();return}if(B.state!==Pt.IDLE){B.cancel(),B.state===Pt.IDLE?(ae.value=null,Tt.value=null,y.hideHoveredPath(),y.hideMovementRange(),r("token-selected",null)):B.state===Pt.TOKEN_SELECTED&&(Tt.value=null,y.hideHoveredPath()),kt(),g.preventDefault();return}ae.value&&(ae.value=null,Tt.value=null,y.hideHoveredPath(),y.hideMovementRange(),r("token-selected",null),kt(),g.preventDefault())}};Gt([m,W],()=>{fs(()=>{Nt()})},{deep:!0}),Gt(u,async g=>{g.length>0&&(await ja(g),kt())},{immediate:!0});let V=null;Gt(()=>{var g;return(g=m.value)==null?void 0:g.updatedAt},(g,v)=>{!D.value||!g||(V&&clearTimeout(V),V=setTimeout(()=>{w.broadcastMap()},500))},{flush:"post"}),Gt(ae,g=>{g&&z(g)?O(g):y.hideMovementRange()},{immediate:!0});const ht=ne(()=>{const g=ae.value;return g?x.getAvailableMovement(g.characterId):null});Gt(ht,(g,v)=>{ae.value&&z(ae.value)&&g!==v&&(O(ae.value),y.hideHoveredPath(),Tt.value=null,kt())});const Tt=R(null),Qt=g=>{if(!g||!ae.value||!z(ae.value))return y.hideHoveredPath(),Tt.value=null,B.cancel(),null;const v=ae.value,se=m.value;if(!se)return y.hideHoveredPath(),null;const le=c.findTokenPosition(se.id,v.characterId);if(!le)return y.hideHoveredPath(),null;if(g.q===le.q&&g.r===le.r)return y.hideHoveredPath(),Tt.value=null,null;const we=x.characters.find(nt=>nt.id===v.characterId)||x.npcs.find(nt=>nt.id===v.characterId),Le=Fe(we),E=Jn({q:le.q,r:le.r},{q:g.q,r:g.r},Le,{modifiers:(we==null?void 0:we.movementModifiers)||{},maxCost:100});if(!E.found)return y.showHoveredPath([],1/0,g,{}),null;const ve=x.getMovementResources(v.characterId),{segments:ue,usedResources:_e,reachable:qe}=$a(E.path,{movement:ve.movement.current,surges:ve.surges.current,movementPerSurge:ve.surges.movementPerSurge});let Ve=null;if(E.path.length>=2&&Ye.value){const nt=E.path[E.path.length-1],it=E.path[E.path.length-2],at=Ye.value.hexToPixel(nt.q,nt.r),yt=Ye.value.hexToPixel(it.q,it.r),Ct=at.x-yt.x,wt=at.y-yt.y,It=Math.atan2(wt,Ct);let Lt=It*(180/Math.PI);for(;Lt<0;)Lt+=360;for(;Lt>=360;)Lt-=360;let Xt=Math.floor((Lt+15)/30)%12;const ts=Ye.value.orientation==="pointy";ts&&(Xt=(Xt+3)%12),Ve=Xt,console.log("[showPathToHex] suggestedFacing:",Ve,"angle:",(It*180/Math.PI).toFixed(1)+"°","isPointy:",ts)}const pt=B.setPath(g,E.path,Ve);return Tt.value=g,y.showHoveredPath(ue,E.totalCost,g,_e,Ve),pt},rn=g=>{var it;const v=y.hoveredPath;if(!v||!v.targetHex||!Ye.value)return;const{targetHex:se,suggestedFacing:le}=v,we=Ye.value,Le=g.target.getBoundingClientRect(),E=g.clientX-Le.left,ve=g.clientY-Le.top,ue=ms(E,ve,W.value),_e=we.hexToPixel(se.q,se.r),qe=ue.x-_e.x,Ve=ue.y-_e.y;if(Math.sqrt(qe*qe+Ve*Ve)<30){let yt=Math.atan2(Ve,qe)*(180/Math.PI);for(((it=m.value)==null?void 0:it.orientation)==="pointy"||(yt-=90);yt<0;)yt+=360;for(;yt>=360;)yt-=360;const wt=Math.round(yt/30)%12,It=le??0,Lt=(wt-It+6+12)%12-6,Xt=Math.max(-2,Math.min(2,Lt)),ts=((It+Xt)%12+12)%12;y.setPathFacing(ts)}else v.selectedFacing!==null&&y.setPathFacing(null)},Ws=()=>{if(Ae.value){const g=Ae.value.getBoundingClientRect();Ne.value={width:Math.floor(g.width)||800,height:Math.floor(g.height)||600}}},As=()=>{c.$patch({camera:{x:Ne.value.width/2,y:Ne.value.height/2,zoom:1}})},Nt=()=>{ls(),ps(),kt()},ls=()=>{const g=Ee.value;if(!g||!m.value||!Ye.value)return;const v=g.getContext("2d"),se=m.value,le=Ye.value;v.clearRect(0,0,g.width,g.height),v.save(),v.translate(W.value.x,W.value.y),v.scale(W.value.zoom,W.value.zoom);const we=se.layers.find(Le=>Le.type===Fs.TERRAIN);if(!we){v.restore();return}we.data.forEach((Le,E)=>{const[ve,ue]=E.split(",").map(Number),_e=le.hexToPixel(ve,ue),qe=le.getHexCorners(_e.x,_e.y);let Ve=(Le==null?void 0:Le.terrain)||"void",pt=!1;P.value&&P.value.has(E)&&(Ve=P.value.get(E),pt=!0);let nt="#0d1117";const it=f.getTerrainById(Ve);it?nt=it.fallbackColor||it.color||nt:Xs[Ve]&&(nt=Xs[Ve].color),v.beginPath(),v.moveTo(qe[0].x,qe[0].y);for(let at=1;at<6;at++)v.lineTo(qe[at].x,qe[at].y);v.closePath(),v.fillStyle=nt,v.fill(),pt&&(v.strokeStyle="rgba(255, 255, 0, 0.6)",v.lineWidth=2/W.value.zoom,v.stroke())}),v.restore()},ps=()=>{const g=Se.value;if(!g||!m.value||!Ye.value)return;const v=g.getContext("2d"),se=m.value,le=Ye.value;if(v.clearRect(0,0,g.width,g.height),!se.visibility.showGrid)return;v.save(),v.translate(W.value.x,W.value.y),v.scale(W.value.zoom,W.value.zoom);const we=se.layers.find(E=>E.type===Fs.TERRAIN);if(!we){v.restore();return}v.strokeStyle="rgba(255, 255, 255, 0.2)",v.lineWidth=1/W.value.zoom,we.data.forEach((E,ve)=>{const[ue,_e]=ve.split(",").map(Number),qe=le.hexToPixel(ue,_e),Ve=le.getHexCorners(qe.x,qe.y);v.beginPath(),v.moveTo(Ve[0].x,Ve[0].y);for(let pt=1;pt<6;pt++)v.lineTo(Ve[pt].x,Ve[pt].y);v.closePath(),v.stroke()});const Le=le.hexToPixel(0,0);v.beginPath(),v.arc(Le.x,Le.y,4/W.value.zoom,0,Math.PI*2),v.fillStyle="rgba(250, 204, 21, 0.8)",v.fill(),v.restore()},kt=()=>{var ve,ue,_e,qe,Ve,pt;const g=Be.value;if(!g||!m.value||!Ye.value)return;const v=g.getContext("2d"),se=Ye.value;if(v.clearRect(0,0,g.width,g.height),v.save(),v.translate(W.value.x,W.value.y),v.scale(W.value.zoom,W.value.zoom),ye.value.size>0&&ye.value.forEach(nt=>{const[it,at]=nt.split(",").map(Number),yt=se.hexToPixel(it,at),Ct=se.getHexCorners(yt.x,yt.y);v.beginPath(),v.moveTo(Ct[0].x,Ct[0].y);for(let wt=1;wt<6;wt++)v.lineTo(Ct[wt].x,Ct[wt].y);v.closePath(),v.fillStyle="rgba(250, 204, 21, 0.25)",v.fill(),v.strokeStyle="rgba(250, 204, 21, 0.8)",v.lineWidth=2/W.value.zoom,v.stroke()}),re.value.length>0&&At.value){const nt=K.value.mode;let it,at;if(nt===qt.ADD?(it="rgba(34, 197, 94, 0.3)",at="rgba(34, 197, 94, 0.9)"):nt===qt.SUBTRACT?(it="rgba(239, 68, 68, 0.3)",at="rgba(239, 68, 68, 0.9)"):(it="rgba(56, 189, 248, 0.3)",at="rgba(56, 189, 248, 0.9)"),re.value.forEach(yt=>{const Ct=se.hexToPixel(yt.q,yt.r),wt=se.getHexCorners(Ct.x,Ct.y);v.beginPath(),v.moveTo(wt[0].x,wt[0].y);for(let It=1;It<6;It++)v.lineTo(wt[It].x,wt[It].y);v.closePath(),v.fillStyle=it,v.fill(),v.strokeStyle=at,v.lineWidth=1.5/W.value.zoom,v.stroke()}),$t.value&&ke.value){const yt=K.value.shape,Ct=$t.value,wt=se.hexToPixel(ke.value.q,ke.value.r);if(v.setLineDash([5/W.value.zoom,5/W.value.zoom]),v.strokeStyle=at,v.lineWidth=2/W.value.zoom,yt===Bt.RECTANGLE){const It=Math.min(Ct.x,wt.x),Lt=Math.max(Ct.x,wt.x),Xt=Math.min(Ct.y,wt.y),ts=Math.max(Ct.y,wt.y);v.strokeRect(It,Xt,Lt-It,ts-Xt)}else if(yt===Bt.CIRCLE||yt===Bt.HEXAGON){const It=wt.x-Ct.x,Lt=wt.y-Ct.y,Xt=Math.sqrt(It*It+Lt*Lt);v.beginPath(),v.arc(Ct.x,Ct.y,Xt,0,Math.PI*2),v.stroke()}else yt===Bt.LINE&&(v.beginPath(),v.moveTo(Ct.x,Ct.y),v.lineTo(wt.x,wt.y),v.stroke());v.setLineDash([])}}if($t.value&&At.value){const nt=$t.value;v.beginPath(),v.arc(nt.x,nt.y,6/W.value.zoom,0,Math.PI*2),v.fillStyle="rgba(250, 204, 21, 0.9)",v.fill(),v.strokeStyle="rgba(0, 0, 0, 0.5)",v.lineWidth=1/W.value.zoom,v.stroke()}if(ke.value&&!At.value){const nt=se.hexToPixel(ke.value.q,ke.value.r),it=se.getHexCorners(nt.x,nt.y);v.beginPath(),v.moveTo(it[0].x,it[0].y);for(let at=1;at<6;at++)v.lineTo(it[at].x,it[at].y);v.closePath(),v.fillStyle="rgba(56, 189, 248, 0.3)",v.fill(),v.strokeStyle="rgba(56, 189, 248, 0.8)",v.lineWidth=2,v.stroke()}const le=Oe.value.isRotateInPlace||Rt.value==="ring",we=Wt.value&&le?de.value:null,Le=Wt.value&&le&&ae.value?ae.value.characterId:null,E=u.value.map(nt=>{const it=Ss.getAnimatedPosition(nt.characterId),yt=nt.characterId===Le&&we!==null?we:(it==null?void 0:it.facing)??nt.facing;return it?{...nt,pixelX:it.x,pixelY:it.y,facing:yt,isAnimating:!0}:{...nt,facing:yt}});if(E.length>0){const it=((ve=m.value)==null?void 0:ve.orientation)===$s.POINTY?0:90;Ya(v,E,{tokenSize:be.value,showFacing:!0,hoveredTokenId:((ue=ge.value)==null?void 0:ue.characterId)||null,selectedTokenId:((_e=ae.value)==null?void 0:_e.characterId)||null,currentUserId:T.userId,isMaster:D.value,draggingTokenId:te.value?(qe=J.value)==null?void 0:qe.characterId:null,facingOffset:it})}if(M.value&&ae.value&&Ye.value){const it=((Ve=m.value)==null?void 0:Ve.orientation)===$s.POINTY?0:90,at=de.value??((pt=y.hoveredPath)==null?void 0:pt.suggestedFacing)??ae.value.facing??0,yt=Ye.value.hexToPixel(M.value.q,M.value.r),Ct=Ye.value.hexToPixel(ae.value.q,ae.value.r);if(!(Math.abs(yt.x-Ct.x)<1&&Math.abs(yt.y-Ct.y)<1)){v.save(),v.globalAlpha=.6;const It=ae.value.character||x.characters.find(Lt=>Lt.id===ae.value.characterId)||x.npcs.find(Lt=>Lt.id===ae.value.characterId);if(It){const Lt={characterId:ae.value.characterId,character:It,pixelX:yt.x,pixelY:yt.y,facing:at,meleeDefence:gs(It,"melee"),rangedDefence:gs(It,"ranged")};po(v,Lt,{tokenSize:be.value,showFacing:!0,showDefence:!0,canSeeDefence:!0,isSelected:!0,facingOffset:it})}v.restore()}}if(te.value&&J.value&&Ye.value){const nt=Ye.value.pixelToHex(J.value.pixelX,J.value.pixelY),it=Ye.value.hexToPixel(nt.q,nt.r);v.beginPath();const at=Ye.value.getHexCorners(it.x,it.y);v.moveTo(at[0].x,at[0].y);for(let yt=1;yt<at.length;yt++)v.lineTo(at[yt].x,at[yt].y);v.closePath(),v.fillStyle="rgba(250, 204, 21, 0.3)",v.fill(),v.strokeStyle="rgba(250, 204, 21, 0.8)",v.lineWidth=2,v.stroke()}v.restore(),ct.value.showFacingPicker&&ct.value.targetHex&&Ye.value&&Fo(v)},zs=()=>{Ws(),fs(()=>{Nt()})},Ds=g=>{if(!Ye.value||!Be.value)return null;const v=Be.value.getBoundingClientRect(),se=(g.clientX-v.left-W.value.x)/W.value.zoom,le=(g.clientY-v.top-W.value.y)/W.value.zoom;return Ye.value.pixelToHex(se,le)},Cs=g=>{if(!Be.value)return null;const v=Be.value.getBoundingClientRect(),se=(g.clientX-v.left-W.value.x)/W.value.zoom,le=(g.clientY-v.top-W.value.y)/W.value.zoom;return{x:se,y:le}},Vs=g=>{if(!Ye.value||!ke.value)return null;const v=Cs(g);if(!v)return null;const se=Ye.value,le=ke.value,we=se.hexToPixel(le.q,le.r),Le=se.getHexCorners(we.x,we.y),E=[{x:we.x,y:we.y,type:"center"},...Le.map((_e,qe)=>({x:_e.x,y:_e.y,type:`corner${qe}`}))];let ve=1/0,ue=E[0];for(const _e of E){const qe=_e.x-v.x,Ve=_e.y-v.y,pt=qe*qe+Ve*Ve;pt<ve&&(ve=pt,ue=_e)}return{x:ue.x,y:ue.y}},cn=g=>{if(D.value&&U.value!==mt.NONE){const ve=Cs(g),ue=Ds(g);if(ve)if(U.value===mt.POINTER)y.updatePointer(ve.x,ve.y);else if(U.value===mt.DRAW&&y.currentDrawing)y.continueDrawing(ve.x,ve.y);else if(U.value===mt.MEASURE&&y.measurement&&ue){const _e=y.measurement.start,qe=Ms(_e.q,_e.r,ue.q,ue.r),Ve=fe(_e.q,_e.r,ue.q,ue.r);y.updateMeasurement(ve.x,ve.y,ue.q,ue.r,qe,Ve)}else y.currentShape&&y.updateShape(ve.x,ve.y)}if(ct.value.showFacingPicker){rl(g.clientX,g.clientY);return}if(Wt.value){const ve=I(gt.value.x,gt.value.y,g.clientX,g.clientY);B.setFacing(ve);const ue=Ye.value?Ye.value.hexSize*W.value.zoom:32;B.updateDrag(g.clientX,g.clientY,ue,gt.value),kt();return}if(Xe.value){const ve=g.clientX-Ue.value.x,ue=g.clientY-Ue.value.y;c.panCamera(ve,ue),Ue.value={x:g.clientX,y:g.clientY},Nt();return}if($.value&&!te.value){const ve=g.clientX-$.value.startX,ue=g.clientY-$.value.startY;Math.hypot(ve,ue)>=Xl&&(te.value=!0,J.value=$.value.token,Te.value=$.value.offset,B.startDrag(g.clientX,g.clientY,"token"),y.hideMovementRange(),y.hideHoveredPath(),B.reset(),console.log("[BattleMap] Начат drag токена после порога",Xl,"px"))}if(te.value&&J.value){const ve=g.target.getBoundingClientRect(),ue=g.clientX-ve.left,_e=g.clientY-ve.top,qe=ms(ue,_e,W.value);J.value.pixelX=qe.x-Te.value.x,J.value.pixelY=qe.y-Te.value.y,kt();return}const v=Ds(g);v?(ke.value=v,At.value&&dt.value&&ze.value&&ds(v,g),Ze.value&&Y.value&&j.value!=="select"&&Mt(v),rn(g)):ke.value=null;const se=g.target.getBoundingClientRect(),le=g.clientX-se.left,we=g.clientY-se.top,Le=ms(le,we,W.value),E=Ls(Le.x,Le.y,u.value,be.value);E!==ge.value&&(ge.value=E),kt()},Bs=R({x:0,y:0,time:0}),dn=g=>{var E,ve;ot.value=!1,ce.value=!1,Je.value=!1;const v=g.target.getBoundingClientRect(),se=g.clientX-v.left,le=g.clientY-v.top,we=ms(se,le,W.value),Le=Ls(we.x,we.y,u.value,be.value);if(Le!==ge.value&&(ge.value=Le),D.value&&g.button===0&&U.value!==mt.NONE){const ue=Cs(g),_e=Ds(g);if(ue){if(U.value===mt.PING){y.addPing(ue.x,ue.y);return}else if(U.value===mt.DRAW){y.startDrawing(ue.x,ue.y);return}else if(U.value===mt.MEASURE&&_e){y.startMeasurement(ue.x,ue.y,_e.q,_e.r);return}else if(U.value===mt.RANGE&&_e){et(_e.q,_e.r);return}else if([mt.ARROW,mt.CIRCLE,mt.CONE,mt.LINE].includes(U.value)){y.startShape(ue.x,ue.y);return}}}if(ct.value.showFacingPicker){cl(),g.preventDefault();return}if(g.button===0&&!g.ctrlKey&&he.value===Pt.PATH_SHOWN&&M.value&&!ge.value){console.log("[BattleMap] Начинаем drag для выбора направления (путь показан)"),Wt.value=!0,Rt.value="path-end";const ue=g.target.getBoundingClientRect(),_e=Ye.value.hexToPixel(M.value.q,M.value.r);gt.value={x:_e.x*W.value.zoom+W.value.x+ue.left,y:_e.y*W.value.zoom+W.value.y+ue.top};const qe=I(gt.value.x,gt.value.y,g.clientX,g.clientY);B.setFacing(qe),B.startDrag(g.clientX,g.clientY,"path-end"),g.preventDefault();return}if(g.button===1||g.button===0&&g.ctrlKey&&!ge.value){Xe.value=!0,Ue.value={x:g.clientX,y:g.clientY},g.preventDefault();return}if(g.button===0&&ge.value&&D.value&&g.ctrlKey){const ue=g.target.getBoundingClientRect(),_e=g.clientX-ue.left,qe=g.clientY-ue.top,Ve=ms(_e,qe,W.value);$.value={token:ge.value,startX:g.clientX,startY:g.clientY,offset:{x:Ve.x-ge.value.pixelX,y:Ve.y-ge.value.pixelY}},ae.value=ge.value,r("token-selected",ge.value),B.selectToken(ge.value.characterId,{q:ge.value.q,r:ge.value.r},!0),O(ge.value),g.preventDefault(),kt();return}if(g.button===0&&ge.value&&D.value&&!g.ctrlKey){if(((E=ae.value)==null?void 0:E.characterId)===ge.value.characterId){console.log("[BattleMap] Мастер кликает на выбранный токен - начинаем разворот на месте"),Wt.value=!0,Rt.value="ring";const ue=g.target.getBoundingClientRect(),_e=Ye.value.hexToPixel(ge.value.q,ge.value.r);gt.value={x:_e.x*W.value.zoom+W.value.x+ue.left,y:_e.y*W.value.zoom+W.value.y+ue.top},B.startDrag(g.clientX,g.clientY,"ring"),g.preventDefault();return}ae.value=ge.value,r("token-selected",ge.value),B.selectToken(ge.value.characterId,{q:ge.value.q,r:ge.value.r},!0),O(ge.value),g.preventDefault(),kt();return}if(g.button===0&&ge.value){if(a.mobileMode&&a.pendingAction&&(a.pendingAction.id==="attack"||a.pendingAction.id==="skill")){r("action-target-selected",ge.value);return}if(((ve=ae.value)==null?void 0:ve.characterId)===ge.value.characterId)ae.value=null,B.reset(),y.hideMovementRange(),y.hideHoveredPath(),r("token-selected",null);else{ae.value=ge.value,r("token-selected",ge.value);const ue=z(ge.value);B.selectToken(ge.value.characterId,{q:ge.value.q,r:ge.value.r},ue),ue&&O(ge.value)}kt();return}if(g.button===0&&!ge.value){if(a.mobileMode&&a.pendingAction&&a.pendingAction.id==="move"&&ke.value){r("action-target-selected",{type:"hex",hex:Ht(ke.value)});return}if(ke.value&&ae.value&&z(ae.value)&&Qt(ke.value)){console.log("[BattleMap] Mousedown на гекс с выбранным токеном - начинаем drag"),Wt.value=!0,Rt.value="path-end";const _e=g.target.getBoundingClientRect(),qe=Ye.value.hexToPixel(ke.value.q,ke.value.r);gt.value={x:qe.x*W.value.zoom+W.value.x+_e.left,y:qe.y*W.value.zoom+W.value.y+_e.top},B.startDrag(g.clientX,g.clientY,"path-end"),r("hex-selected",Ht(ke.value)),g.preventDefault();return}if(ke.value){const ue=Date.now(),_e=Bs.value,qe=g.clientX-_e.x,Ve=g.clientY-_e.y;if(Math.hypot(qe,Ve)<20&&ue-_e.time<400){ct.value.startPos={x:g.clientX,y:g.clientY},ct.value.targetHex=ke.value,Ro(!1),Bs.value={x:0,y:0,time:0};return}Bs.value={x:g.clientX,y:g.clientY,time:ue},r("hex-selected",Ht(ke.value))}else ae.value&&(ae.value=null,Tt.value=null,y.hideHoveredPath(),y.hideMovementRange(),B.reset(),r("token-selected",null),kt())}if(!q.value&&g.button===0&&ke.value&&Y.value)if(j.value==="select"){At.value=!0,dt.value={...ke.value};const ue=Vs(g);$t.value=ue,re.value=[{...ke.value}]}else if(j.value==="token")ye.value.clear(),ye.value.add(`${ke.value.q},${ke.value.r}`),kt();else{Ze.value=!0;const ue=j.value==="erase"?"ERASE_STROKE":"BRUSH_STROKE";c.beginHistoryTransaction(ue,Y.value.id),Mt(ke.value)}},un=g=>{if(D.value&&U.value!==mt.NONE)if(U.value===mt.DRAW&&y.currentDrawing){y.finishDrawing();return}else{if(U.value===mt.MEASURE&&y.measurement)return;if(y.currentShape){y.finishShape();return}}if(Wt.value){const v=B.getDragDistance(),se=v>10,le=se?B.selectedFacing??B.suggestedFacing??0:B.suggestedFacing??0;console.log("[BattleMap] Завершаем drag для направления:",Rt.value,"facing:",le,"dragDistance:",v,"isRealDrag:",se),Rt.value==="ring"?ae.value&&m.value&&(c.rotateToken(m.value.id,ae.value.q,ae.value.r,le),w.status==="in-room"&&w.broadcastCharacterMove(ae.value.characterId,ae.value.q,ae.value.r,le),r("token-rotate",{facing:le})):Rt.value==="path-end"&&M.value&&(r("hex-double-tap",{q:M.value.q,r:M.value.r,facing:le,wasDrag:se}),Tt.value=null,y.hideHoveredPath(),B.reset()),Wt.value=!1,Rt.value=null,B.endDrag(),kt();return}if(te.value&&J.value&&Ye.value&&m.value){const v=Ye.value.pixelToHex(J.value.pixelX,J.value.pixelY),se=J.value.q,le=J.value.r;(se!==v.q||le!==v.r)&&(c.moveToken(m.value.id,se,le,v.q,v.r)?w.broadcastMapTokenMove(m.value.id,J.value.characterId,v.q,v.r):console.warn("Failed to move token - target hex may be occupied")),te.value=!1,J.value=null,Te.value={x:0,y:0},$.value=null,kt();return}$.value&&(console.log("[BattleMap] Клик по токену (без drag) - токен выбран"),$.value=null),At.value&&dt.value&&ke.value&&Qs(),Ze.value&&c.endHistoryTransaction(),Xe.value=!1,Ze.value=!1,vt.value=new Set,At.value=!1,dt.value=null,$t.value=null,re.value=[],kt()},mn=()=>{ke.value=null,ge.value=null,Xe.value=!1,Ze.value&&c.endHistoryTransaction(),Ze.value=!1,vt.value=new Set,D.value&&U.value===mt.POINTER&&y.clearPointer(),y.currentDrawing&&y.cancelDrawing(),y.currentShape&&y.cancelShape(),te.value&&(te.value=!1,J.value=null,Te.value={x:0,y:0}),$.value=null,At.value&&(At.value=!1,dt.value=null,$t.value=null,re.value=[]),kt()},G=g=>{g.preventDefault();const v=Be.value.getBoundingClientRect(),se=g.clientX-v.left,le=g.clientY-v.top,we=W.value.zoom,Le=g.deltaY>0?.9:1.1,E=Math.max(.25,Math.min(4,we*Le)),ve=(se-W.value.x)/we,ue=(le-W.value.y)/we;c.$patch({camera:{x:se-ve*E,y:le-ue*E,zoom:E}}),Nt()},Mt=g=>{var we,Le;if(!Y.value)return;const v=((we=X.value)==null?void 0:we.size)??1,se=Ye.value;if(!se)return;const le=se.getHexesInRadius(g.q,g.r,v);if(j.value==="paint"){const E=((Le=X.value)==null?void 0:Le.type)??"terrain";if(E==="terrain")for(const ve of le)c.setHexTerrain(Y.value.id,ve.q,ve.r,F.value);else if(E==="profile"){const ve=k.currentProfile;if(ve){const ue=le.filter(Ve=>{const pt=`${Ve.q},${Ve.r}`;return!vt.value.has(pt)});if(ue.length===0)return;for(const Ve of ue)vt.value.add(`${Ve.q},${Ve.r}`);const _e=ue.map(Ve=>`${Ve.q},${Ve.r}`);Hn(ve,_e,f,{probabilistic:!0}).forEach((Ve,pt)=>{const[nt,it]=pt.split(",").map(Number);c.setHexTerrain(Y.value.id,nt,it,Ve)})}}ls(),ps()}else if(j.value==="erase"){const E=m.value,ve=E==null?void 0:E.layers.find(ue=>ue.type===Fs.TERRAIN);if(ve){for(const ue of le){const _e=is(ue.q,ue.r);ve.data.delete(_e)}E.updatedAt=Date.now(),ls(),ps()}}},ds=(g,v=null)=>{if(!ze.value||!$t.value)return;const se=K.value.shape,le=K.value.behavior,we=K.value.lineWidth,Le=m.value,E=Le==null?void 0:Le.layers.find(qe=>qe.type===Fs.TERRAIN),ve=E?E.data:new Map,ue=v?Vs(v)||Cs(v):null;if(!ue)return;let _e=[];switch(se){case Bt.RECTANGLE:_e=ze.value.calculateRectanglePreviewPixel($t.value,ue,ve,le);break;case Bt.CIRCLE:_e=ze.value.calculateCirclePreviewPixel($t.value,ue,ve,le);break;case Bt.HEXAGON:_e=ze.value.calculateHexagonPreviewPixel($t.value,ue,ve,le);break;case Bt.LINE:_e=ze.value.calculateLinePreviewPixel($t.value,ue,we,ve,le);break}re.value=_e},Qs=()=>{if(re.value.length===0)return;const g=K.value.mode,v=new Set(ye.value);re.value.forEach(se=>{const le=is(se.q,se.r);switch(g){case qt.REPLACE:v.size===ye.value.size&&v.clear(),v.add(le);break;case qt.ADD:v.add(le);break;case qt.SUBTRACT:v.delete(le);break}}),g===qt.REPLACE?ye.value=new Set(re.value.map(se=>is(se.q,se.r))):ye.value=v},Rs=()=>{ye.value=new Set,kt()},js=()=>{ye.value.size===0||!Y.value||(c.beginHistoryTransaction("FILL_TERRAIN",Y.value.id),ye.value.forEach(g=>{const[v,se]=g.split(",").map(Number);c.setHexTerrain(Y.value.id,v,se,F.value)}),c.endHistoryTransaction(),ls(),ps())},Gs=()=>{ye.value.size===0||!m.value||!m.value.layers.find(v=>v.type===Fs.TERRAIN)||(c.beginHistoryTransaction("DELETE_HEXES",m.value.id),ye.value.forEach(v=>{const[se,le]=v.split(",").map(Number);c.setHexTerrain(m.value.id,se,le,null)}),c.endHistoryTransaction(),Rs(),ls(),ps())},Mo=()=>{c.undo(),Nt()},Do=()=>{c.redo(),Nt()},Oe=R({touches:[],lastTap:null,isMultiTouch:!1,isPanning:!1,wasZooming:!1,initialDistance:0,initialZoom:1}),ct=R({isActive:!1,timer:null,startPos:null,targetHex:null,showFacingPicker:!1,previewFacing:null,originalFacing:0,isDraggingFacing:!1,movedToHex:!1,isRotateInPlace:!1,activeToken:null}),vn=g=>{const v=m.value;return!v||v.orientation===$s.POINTY?g%2===0:g%2===1},Bo=g=>{let se=((g%360+360)%360+90)%360;const le=m.value,Le=le&&le.orientation===$s.POINTY?0:90;let E=(se-Le+360)%360;const ve=Math.round(E/30)%12,_e=vn(ve)?gn/2:Zl/2,qe=ve*30;let Ve=Math.abs(E-qe);if(Ve>180&&(Ve=360-Ve),Ve<=_e)return ve;const pt=(ve-1+12)%12,nt=(ve+1)%12;if(vn(pt)){const it=pt*30;let at=Math.abs(E-it);if(at>180&&(at=360-at),at<=gn/2)return pt}if(vn(nt)){const it=nt*30;let at=Math.abs(E-it);if(at>180&&(at=360-at),at<=gn/2)return nt}return ve},Sn=()=>{ct.value.timer&&(clearTimeout(ct.value.timer),ct.value.timer=null),ct.value.isActive=!1},fn=()=>{Sn(),ct.value={isActive:!1,timer:null,startPos:null,targetHex:null,showFacingPicker:!1,previewFacing:null,originalFacing:0,isDraggingFacing:!1,movedToHex:!1,isRotateInPlace:!1,activeToken:null},kt()},Ro=(g=!1)=>{const v=ct.value.targetHex;if(!v)return;ct.value.isActive=!0,ct.value.showFacingPicker=!0,ct.value.isDraggingFacing=!0,ct.value.isRotateInPlace=g;let se;D.value?g?se=u.value.find(le=>le.q===v.q&&le.r===v.r):se=ae.value:se=u.value.find(le=>{var we;return((we=le.character)==null?void 0:we.ownerId)===T.userId}),ct.value.originalFacing=(se==null?void 0:se.facing)||0,ct.value.previewFacing=ct.value.originalFacing,ct.value.activeToken=se,g||(r("hex-long-press-move",{hex:Ht(v),facing:ct.value.originalFacing}),ct.value.movedToHex=!0),navigator.vibrate&&navigator.vibrate(50),kt()},rl=(g,v)=>{if(!ct.value.showFacingPicker||!ct.value.targetHex||!Be.value)return;const se=ct.value.targetHex,le=Ye.value;if(!le)return;const we=Be.value.getBoundingClientRect(),Le=g-we.left,E=v-we.top,ve=le.hexToPixel(se.q,se.r),ue=dl(ve.x,ve.y),_e=Le-ue.x,qe=E-ue.y;if(Math.sqrt(_e*_e+qe*qe)<Af){ct.value.previewFacing=ct.value.originalFacing,kt();return}let pt=Math.atan2(qe,_e)*180/Math.PI;pt<0&&(pt+=360);const nt=Bo(pt);ct.value.previewFacing=nt,kt()},cl=()=>{if(!ct.value.showFacingPicker)return;const g=ct.value.previewFacing,v=g!==null?g:ct.value.originalFacing||0;if(D.value&&ct.value.isRotateInPlace){const se=ct.value.activeToken;se&&m.value&&c.rotateToken(m.value.id,se.q,se.r,v),fn();return}if(D.value&&!ct.value.isRotateInPlace){const se=ct.value.activeToken,le=ct.value.targetHex;se&&m.value&&le&&c.moveToken(m.value.id,se.q,se.r,le.q,le.r)&&c.rotateToken(m.value.id,le.q,le.r,v),fn();return}ct.value.isRotateInPlace?r("token-rotate",{facing:v}):(r("hex-long-press-confirm",{hex:ct.value.targetHex,facing:v}),y.hideHoveredPath(),Tt.value=null),fn()},dl=(g,v)=>({x:g*W.value.zoom+W.value.x,y:v*W.value.zoom+W.value.y}),Fo=g=>{const v=ct.value.targetHex,se=Ye.value;if(!v||!se)return;const le=ct.value.activeToken||u.value.find(at=>{var yt;return((yt=at.character)==null?void 0:yt.ownerId)===T.userId}),we=le==null?void 0:le.character,Le=se.hexToPixel(v.q,v.r),E=dl(Le.x,Le.y),ve=35,ue=ff,_e=ct.value.previewFacing,qe=m.value,pt=qe&&qe.orientation===$s.POINTY?0:90,it=(_e!==null?_e:ct.value.originalFacing)*30+pt;g.beginPath(),g.arc(E.x,E.y,ue+30,0,Math.PI*2),g.fillStyle="rgba(15, 23, 42, 0.85)",g.fill(),g.beginPath(),g.arc(E.x,E.y,ue,0,Math.PI*2),g.strokeStyle="rgba(148, 163, 184, 0.5)",g.lineWidth=2,g.stroke();for(let at=0;at<12;at++){const Ct=at*30+pt,wt=(Ct-90)*Math.PI/180,It=vn(at),Lt=_e===at,Xt=It?gn:Zl,ts=ue-15;if(Lt){const Cl=Xt/2,sa=(Ct-90-Cl)*Math.PI/180,na=(Ct-90+Cl)*Math.PI/180;g.beginPath(),g.moveTo(E.x,E.y),g.arc(E.x,E.y,ue,sa,na),g.closePath(),g.fillStyle="rgba(250, 204, 21, 0.3)",g.fill()}const bl=It?ts+10:ts+4,An=It?ts-10:ts-4,pn=It?15:6,kl={x:E.x+Math.cos(wt)*bl,y:E.y+Math.sin(wt)*bl},xl={x:E.x+Math.cos(wt-pn*Math.PI/180)*An,y:E.y+Math.sin(wt-pn*Math.PI/180)*An},wl={x:E.x+Math.cos(wt+pn*Math.PI/180)*An,y:E.y+Math.sin(wt+pn*Math.PI/180)*An};g.beginPath(),g.moveTo(kl.x,kl.y),g.lineTo(xl.x,xl.y),g.lineTo(wl.x,wl.y),g.closePath();const ta=Lt?1:It?.7:.35;Lt?(g.fillStyle="rgba(250, 204, 21, 0.95)",g.strokeStyle="rgba(0, 0, 0, 0.5)"):(g.fillStyle=`rgba(148, 163, 184, ${ta})`,g.strokeStyle="rgba(0, 0, 0, 0.3)"),g.fill(),g.lineWidth=1,g.stroke()}we?_n(g,E.x,E.y,ve,we.portrait,we.name):(g.beginPath(),g.arc(E.x,E.y,ve,0,Math.PI*2),g.fillStyle="rgba(30, 41, 59, 0.9)",g.fill(),g.strokeStyle="rgba(148, 163, 184, 0.5)",g.lineWidth=2,g.stroke(),g.font="16px system-ui, sans-serif",g.textAlign="center",g.textBaseline="middle",g.fillStyle="rgba(148, 163, 184, 0.8)",g.fillText("↻",E.x,E.y)),le&&(le.meleeDefence||le.rangedDefence)&&nl(g,E.x,E.y,ve,le.meleeDefence,le.rangedDefence,it,{bothSides:!0})},Lo=g=>{g.preventDefault();const v=Array.from(g.touches);if(Oe.value.touches=v,Oe.value.isMultiTouch=v.length>1,v.length===1){const se=v[0];Oe.value.lastTap={x:se.clientX,y:se.clientY,time:Date.now()},Oe.value.isPanning=!1;const le=g.target.getBoundingClientRect(),we=se.clientX-le.left,Le=se.clientY-le.top,E=ms(we,Le,W.value);let ve=null;Ye.value&&(ve=Ye.value.pixelToHex(E.x,E.y));const ue=Ls(E.x,E.y,u.value,be.value);if(ae.value&&z(ae.value)){Oe.value.dragStartHex=ve,Oe.value.dragStartWorld={x:E.x,y:E.y},Oe.value.isDragForFacing=!0,Wt.value=!0,ve&&ve.q===ae.value.q&&ve.r===ae.value.r?Oe.value.isRotateInPlace=!0:Oe.value.isRotateInPlace=!1,console.log("[BattleMap] Touch start с выбранным токеном:",{touchHex:ve,tokenPos:{q:ae.value.q,r:ae.value.r},isRotateInPlace:Oe.value.isRotateInPlace});return}ue&&(Oe.value.tappedToken=ue)}else if(v.length===2){Oe.value.isDragForFacing=!1,Oe.value.isRotateInPlace=!1,Wt.value=!1,Sn();const se=v[0],le=v[1],we=Math.hypot(le.clientX-se.clientX,le.clientY-se.clientY);Oe.value.initialDistance=we,Oe.value.initialZoom=W.value.zoom,Oe.value.isPanning=!1,Oe.value.wasZooming=!0}},No=g=>{g.preventDefault();const v=Array.from(g.touches);if(Oe.value.touches=v,ct.value.showFacingPicker&&v.length===1){const se=v[0];rl(se.clientX,se.clientY);return}if(v.length===1&&!Oe.value.isMultiTouch&&!Oe.value.wasZooming){const se=v[0];if(Oe.value.isDragForFacing&&ae.value&&z(ae.value)){const le=se.clientX-Oe.value.lastTap.x,we=se.clientY-Oe.value.lastTap.y;if(Math.hypot(le,we)>10){!Oe.value.isRotateInPlace&&Oe.value.dragStartHex&&(Oe.value.pathShown||(Qt(Oe.value.dragStartHex),Oe.value.pathShown=!0));const E=I(Oe.value.lastTap.x,Oe.value.lastTap.y,se.clientX,se.clientY);B.setFacing(E),y.setPathFacing(E),kt()}return}if(Oe.value.lastTap&&!Oe.value.isPanning){const le=se.clientX-Oe.value.lastTap.x,we=se.clientY-Oe.value.lastTap.y;Math.hypot(le,we)>10&&(Oe.value.isPanning=!0)}if(Oe.value.isPanning&&Oe.value.lastTap){const le=se.clientX-Oe.value.lastTap.x,we=se.clientY-Oe.value.lastTap.y;c.$patch({camera:{x:W.value.x+le,y:W.value.y+we,zoom:W.value.zoom}}),Oe.value.lastTap={x:se.clientX,y:se.clientY,time:Date.now()},Nt()}}else if(v.length===2){const se=v[0],le=v[1],we=Math.hypot(le.clientX-se.clientX,le.clientY-se.clientY);if(Oe.value.initialDistance>0){const Le=we/Oe.value.initialDistance,E=Math.max(.25,Math.min(4,Oe.value.initialZoom*Le)),ve=(se.clientX+le.clientX)/2,ue=(se.clientY+le.clientY)/2,_e=Be.value.getBoundingClientRect(),qe=ve-_e.left,Ve=ue-_e.top,pt=(qe-W.value.x)/W.value.zoom,nt=(Ve-W.value.y)/W.value.zoom;c.$patch({camera:{x:qe-pt*E,y:Ve-nt*E,zoom:E}}),Nt()}}if(v.length===1&&!Oe.value.isPanning){const se=v[0],le=g.target.getBoundingClientRect(),we=se.clientX-le.left,Le=se.clientY-le.top,E=ms(we,Le,W.value);if(Ye.value){const ue=Ye.value.pixelToHex(E.x,E.y);ke.value=ue}const ve=Ls(E.x,E.y,u.value,be.value);ve!==ge.value&&(ge.value=ve),kt()}},Oo=g=>{g.preventDefault();const v=Array.from(g.changedTouches),se=Array.from(g.touches);if(Oe.value.touches=se,se.length>0){Oe.value.isMultiTouch=se.length>1;return}if(ct.value.showFacingPicker){cl(),Ys();return}if(Oe.value.isDragForFacing&&ae.value&&z(ae.value)){const le=v[0],we=g.target.getBoundingClientRect();if(!le||le.clientX<we.left||le.clientX>we.right||le.clientY<we.top||le.clientY>we.bottom){console.log("[BattleMap] Touch end вне canvas — сбрасываем выбор"),ae.value=null,Tt.value=null,y.hideHoveredPath(),y.hideMovementRange(),B.reset(),r("token-selected",null),Ys(),kt();return}const E=B.selectedFacing??B.suggestedFacing??0,ve=le.clientX-Oe.value.lastTap.x,ue=le.clientY-Oe.value.lastTap.y;if(Math.hypot(ve,ue)>10)console.log("[BattleMap] Touch drag завершён, facing:",E,"isRotateInPlace:",Oe.value.isRotateInPlace),Oe.value.isRotateInPlace?m.value&&(c.rotateToken(m.value.id,ae.value.q,ae.value.r,E),w.status==="in-room"&&w.broadcastCharacterMove(ae.value.characterId,ae.value.q,ae.value.r,E),r("token-rotate",{facing:E})):Oe.value.dragStartHex&&(r("hex-double-tap",{q:Oe.value.dragStartHex.q,r:Oe.value.dragStartHex.r,facing:E,wasDrag:!0}),Tt.value=null,y.hideHoveredPath(),B.reset());else{const qe=le.clientX-we.left,Ve=le.clientY-we.top,pt=ms(qe,Ve,W.value);let nt=null;Ye.value&&(nt=Ye.value.pixelToHex(pt.x,pt.y));const it=Ls(pt.x,pt.y,u.value,be.value);ul(it,nt)}Ys(),kt();return}if(Sn(),!Oe.value.isPanning&&Oe.value.lastTap&&Date.now()-Oe.value.lastTap.time<300){const we=v[0];if(!we){Ys();return}const Le=g.target.getBoundingClientRect(),E=we.clientX-Le.left,ve=we.clientY-Le.top,ue=ms(E,ve,W.value);let _e=null;Ye.value&&(_e=Ye.value.pixelToHex(ue.x,ue.y),ke.value=_e);const qe=Ls(ue.x,ue.y,u.value,be.value);ge.value=qe,ul(qe,_e)}Ys(),kt()},Ys=()=>{Oe.value.touches=[],Oe.value.lastTap=null,Oe.value.isMultiTouch=!1,Oe.value.isPanning=!1,Oe.value.wasZooming=!1,Oe.value.initialDistance=0,Oe.value.initialZoom=1,Oe.value.isDragForFacing=!1,Oe.value.isRotateInPlace=!1,Oe.value.dragStartHex=null,Oe.value.dragStartWorld=null,Oe.value.pathShown=!1,Oe.value.tappedToken=null,Wt.value=!1,kt()},ul=(g,v)=>{var se,le,we;if(g){if(a.mobileMode&&a.pendingAction&&(a.pendingAction.id==="attack"||a.pendingAction.id==="skill")){r("action-target-selected",g);return}if(((se=ae.value)==null?void 0:se.characterId)===g.characterId)ae.value=null,B.reset(),y.hideMovementRange(),y.hideHoveredPath(),r("token-selected",null);else{ae.value=g,r("token-selected",g);const Le=z(g);B.selectToken(g.characterId,{q:g.q,r:g.r},Le),Le&&O(g)}kt();return}if(!g&&v){if(a.mobileMode&&a.pendingAction&&a.pendingAction.id==="move"){r("action-target-selected",{type:"hex",hex:Ht(v)});return}if(r("hex-selected",Ht(v)),ae.value&&z(ae.value)){if(he.value===Pt.PATH_SHOWN&&((le=M.value)==null?void 0:le.q)===v.q&&((we=M.value)==null?void 0:we.r)===v.r){console.log("[BattleMap] Touch: повторный тап на путь — подтверждаем перемещение");const Le=y.getPathFacing()??B.finalFacing;r("hex-double-tap",{...Ht(v),facing:Le,wasDrag:!1}),Tt.value=null,y.hideHoveredPath(),B.reset();return}Qt(v),kt();return}if(a.mobileMode){const Le=Date.now(),E=pe.value;if(E&&E.q===v.q&&E.r===v.r&&Le-E.time<500){const ve=y.getPathFacing();r("hex-double-tap",{...Ht(v),facing:ve,wasDrag:!1}),pe.value=null;return}pe.value={q:v.q,r:v.r,time:Le}}return}!g&&!v&&ae.value&&(ae.value=null,Tt.value=null,y.hideHoveredPath(),y.hideMovementRange(),B.reset(),r("token-selected",null),kt())},ml=()=>{const g=c.createMap({name:bt.value.name||"Новая карта",orientation:bt.value.orientation,scale:bt.value.scale,hexSize:bt.value.hexSize}),v=5;for(let se=-v;se<=v;se++)for(let le=-v;le<=v;le++)(Math.abs(se)+Math.abs(se+le)+Math.abs(le))/2<=v&&c.setHexTerrain(g.id,se,le,"grass");c.startEditing(g.id),We.value=!1,bt.value.name="",fs(()=>{As(),Nt()})},vl=g=>{c.setActiveMap(g),ot.value=!1,fs(()=>{As(),Nt()})},En=()=>{Y.value?c.stopEditing():m.value&&c.startEditing(m.value.id)},Ho=g=>{c.setEditorMode(g),g==="fill"&&(Ke.value=!0)},Pn=g=>{c.selectTerrain(g),j.value!=="select"&&j.value!=="fill"&&c.setEditorMode("paint"),ce.value=!1},qo=g=>{c.setSelectedProfile(g),k.selectProfile(g)},fl=()=>{m.value&&c.toggleMapPublished(m.value.id)},Uo=g=>{const v=u.value.find(se=>se.characterId===g.id);v&&(ae.value=v,r("token-selected",v),B.selectToken(v.characterId,{q:v.q,r:v.r},!0),O(v),kt())},Wo=()=>{m.value&&confirm(`Удалить карту "${m.value.name}"?`)&&c.deleteMap(m.value.id)},zo=g=>{if(!g||ye.value.size===0){alert("Сначала выделите область на карте");return}const v=[...ye.value],se=xa(g,v,f);P.value=se,ls(),kt()},Al=g=>{if(!g||ye.value.size===0){alert("Сначала выделите область на карте");return}const v=[...ye.value],se=Hn(g,v,f);c.beginHistoryTransaction("FILL_PROFILE",m.value.id),se.forEach((we,Le)=>{const[E,ve]=Le.split(",").map(Number);c.setHexTerrain(m.value.id,E,ve,we)}),c.endHistoryTransaction();const le=ka(se,f);console.log("Заливка применена:",le),P.value=null,ye.value=new Set,Ke.value=!1,Nt()},Vo=g=>{g&&(k.selectProfile(g.id),c.setBrushType("profile"),xe.value=!1)},Qo=()=>{const g=k.currentProfile;if(!g){xe.value=!0;return}if(ye.value.size===0){alert("Сначала выделите область на карте");return}Al(g)},jo=()=>{P.value=null,ls(),kt()},Go=(g,v,se)=>{if(!m.value)return!1;const le=c.placeToken(m.value.id,g,v,se,0);return le&&(kt(),D.value&&(w.broadcastMap(),w.broadcastTokens())),le},pl=g=>{let v=null;if(ye.value.size>0){const se=ye.value.values().next().value,[le,we]=se.split(",").map(Number);v={q:le,r:we}}else ke.value&&(v=ke.value);return v?Go(g,v.q,v.r):(console.warn("No hex selected for token placement"),!1)},Yo=ne(()=>{const g=m.value;if(!g)return 0;const v=g.layers.find(se=>se.type===Fs.TERRAIN);return(v==null?void 0:v.data.size)||0}),Xo=ne(()=>m.value?m.value.orientation===$s.FLAT?"Flat-top ⬡":"Pointy-top ⬢":""),hl={[_s.BATTLE]:"Бой",[_s.LOCATION]:"Локация",[_s.DISTRICT]:"Район",[_s.CITY]:"Город",[_s.REGION]:"Регион",[_s.WORLD]:"Мир"},gl={[Bt.RECTANGLE]:"▭",[Bt.CIRCLE]:"○",[Bt.HEXAGON]:"⬡",[Bt.LINE]:"╱"},Zo={[Bt.RECTANGLE]:"Прямоугольник",[Bt.CIRCLE]:"Круг",[Bt.HEXAGON]:"Шестиугольник",[Bt.LINE]:"Линия"},Jo={[qt.REPLACE]:"⬚",[qt.ADD]:"+",[qt.SUBTRACT]:"−"},Ko={[qt.REPLACE]:"Заменить",[qt.ADD]:"Добавить",[qt.SUBTRACT]:"Вычесть"},ea={[os.AGGRESSIVE]:"Все",[os.STANDARD]:"Станд.",[os.PASSIVE]:"Связн."},yl={[os.AGGRESSIVE]:"Все гексы в геометрической области",[os.STANDARD]:"Все гексы в геометрической области",[os.PASSIVE]:"Только связные существующие гексы (flood-fill)"};return l({hexGrid:Ye,renderAll:Nt}),(g,v)=>{var se,le,we,Le;return s(),n("div",_m,[!t.mobileMode&&!i(D)||t.mobileMode&&i(D)?(s(),n("header",Tm,[e("div",Im,[Ie.value?(s(),n("div",Sm,[e("button",{type:"button",class:"flex items-center gap-2 px-3 py-1.5 rounded-lg bg-slate-800 border border-white/10 hover:bg-slate-700 transition text-sm",onClick:v[0]||(v[0]=lt(E=>{ot.value=!ot.value,ce.value=!1},["stop"]))},[e("span",Em,h(((se=i(m))==null?void 0:se.name)||"Выбрать карту"),1),v[35]||(v[35]=e("span",{class:"text-slate-400"},"▼",-1))]),ot.value?(s(),n("div",{key:0,class:"absolute top-full left-0 mt-1 w-64 bg-slate-800 border border-white/10 rounded-lg shadow-xl z-50 py-1 max-h-80 overflow-y-auto",onClick:v[2]||(v[2]=lt(()=>{},["stop"]))},[(s(!0),n(ee,null,me(i(S),E=>{var ve,ue;return s(),n("div",{key:E.id,class:Q(["px-3 py-2 hover:bg-slate-700 cursor-pointer flex items-center justify-between",E.id===((ve=i(m))==null?void 0:ve.id)?"bg-sky-500/20":""]),onClick:_e=>vl(E.id)},[e("div",null,[e("p",Mm,h(E.name),1),e("p",Dm,h(hl[E.scale]),1)]),(ue=E.visibility)!=null&&ue.published?(s(),n("span",Bm,"●")):_("",!0)],10,Pm)}),128)),Ie.value?(s(),n("div",Rm,[e("button",{type:"button",class:"w-full px-3 py-2 text-left text-sm text-sky-400 hover:bg-slate-700",onClick:v[1]||(v[1]=E=>{We.value=!0,ot.value=!1})}," + Создать карту ")])):_("",!0)])):_("",!0)])):(s(),n("div",Fm,[i(m)?(s(),n("span",Lm," 🗺️ "+h(i(m).name),1)):(s(),n("span",Nm," ⏳ Ожидание карты... "))])),i(D)?(s(),n(ee,{key:2},[i(m)?(s(),n("span",Om,h(Yo.value)+" гексов • "+h(Xo.value),1)):_("",!0),q.value&&i(m)?(s(),n("span",Hm," 👁️ Просмотр ")):_("",!0)],64)):_("",!0)]),i(Y)&&Ie.value?(s(),n("div",qm,[(s(),n(ee,null,me(["select","paint","erase","token"],E=>e("button",{key:E,type:"button",class:Q(["w-9 h-9 rounded-lg border flex items-center justify-center text-sm transition",i(j)===E?"bg-sky-500/30 border-sky-400/60 text-sky-100":"border-white/10 hover:bg-white/5 text-slate-300"]),title:E==="select"?"Выбор":E==="paint"?"Рисовать":E==="erase"?"Стереть":"Токены",onClick:ve=>i(c).setEditorMode(E)},h(E==="select"?"👆":E==="paint"?"🖌️":E==="erase"?"🧹":"👤"),11,Um)),64)),i(j)==="token"?(s(),n(ee,{key:0},[v[40]||(v[40]=e("div",{class:"w-px h-6 bg-white/10 mx-1"},null,-1)),e("div",Wm,[e("button",{type:"button",class:Q(["flex items-center gap-1 px-2 py-1.5 rounded-lg border border-white/10 hover:bg-white/5 transition text-xs",Me.value?"bg-sky-500/20 border-sky-400/60":""]),onClick:v[3]||(v[3]=lt(E=>{Me.value=!Me.value,ce.value=!1,Je.value=!1,ot.value=!1},["stop"]))},[v[36]||(v[36]=e("span",null,"👤",-1)),e("span",null,"Токены ("+h(H.value.length)+")",1),v[37]||(v[37]=e("span",{class:"text-slate-400"},"▼",-1))],2),Me.value?(s(),n("div",{key:0,class:"absolute top-full left-0 mt-1 w-72 bg-slate-800 border border-white/10 rounded-lg shadow-xl z-50 max-h-96 overflow-hidden flex flex-col",onClick:v[5]||(v[5]=lt(()=>{},["stop"]))},[e("div",zm,[De(e("input",{"onUpdate:modelValue":v[4]||(v[4]=E=>Re.value=E),type:"text",class:"w-full px-2 py-1.5 rounded bg-slate-900 border border-white/10 text-xs placeholder-slate-500",placeholder:"Поиск по имени..."},null,512),[[je,Re.value]])]),e("div",Vm,[H.value.filter(E=>!E.isNpc).length?(s(),n("div",Qm,[v[38]||(v[38]=e("p",{class:"text-xs text-slate-400 mb-1.5 px-1"},"👥 Игроки",-1)),e("div",jm,[(s(!0),n(ee,null,me(H.value.filter(E=>!E.isNpc&&(!Re.value||E.name.toLowerCase().includes(Re.value.toLowerCase()))),E=>{var ve,ue,_e,qe;return s(),n("button",{key:E.id,type:"button",class:Q(["flex items-center gap-2 px-2 py-1.5 rounded text-xs border border-white/10 hover:bg-white/10 transition text-left",i(c).findTokenPosition((ve=i(m))==null?void 0:ve.id,E.id)?"bg-emerald-500/20 border-emerald-400/40":""]),onClick:Ve=>pl(E.id)},[e("span",Ym,[E.portrait?(s(),n("img",{key:0,src:i(as)(E.portrait),class:"w-full h-full object-cover"},null,8,Xm)):(s(),n("span",Zm,h((_e=(ue=E.name)==null?void 0:ue.charAt(0))==null?void 0:_e.toUpperCase()),1))]),e("span",Jm,h(E.name),1),i(c).findTokenPosition((qe=i(m))==null?void 0:qe.id,E.id)?(s(),n("span",Km,"✓")):_("",!0)],10,Gm)}),128))])])):_("",!0),H.value.filter(E=>E.isNpc).length?(s(),n("div",ev,[v[39]||(v[39]=e("p",{class:"text-xs text-slate-400 mb-1.5 px-1"},"👹 NPC",-1)),e("div",tv,[(s(!0),n(ee,null,me(H.value.filter(E=>E.isNpc&&(!Re.value||E.name.toLowerCase().includes(Re.value.toLowerCase()))),E=>{var ve,ue,_e,qe;return s(),n("button",{key:E.id,type:"button",class:Q(["flex items-center gap-2 px-2 py-1.5 rounded text-xs border border-amber-500/30 hover:bg-amber-500/10 transition text-left",i(c).findTokenPosition((ve=i(m))==null?void 0:ve.id,E.id)?"bg-emerald-500/20 border-emerald-400/40":""]),onClick:Ve=>pl(E.id)},[e("span",nv,[E.portrait?(s(),n("img",{key:0,src:i(as)(E.portrait),class:"w-full h-full object-cover"},null,8,lv)):(s(),n("span",ov,h((_e=(ue=E.name)==null?void 0:ue.charAt(0))==null?void 0:_e.toUpperCase()),1))]),e("span",av,h(E.name),1),i(c).findTokenPosition((qe=i(m))==null?void 0:qe.id,E.id)?(s(),n("span",iv,"✓")):_("",!0)],10,sv)}),128))])])):_("",!0),H.value.length?_("",!0):(s(),n("p",rv,"Нет персонажей"))])])):_("",!0)])],64)):_("",!0),i(j)==="select"?(s(),n(ee,{key:1},[v[45]||(v[45]=e("div",{class:"w-px h-6 bg-white/10 mx-1"},null,-1)),e("div",cv,[e("button",{type:"button",class:"flex items-center gap-1 px-2 py-1.5 rounded-lg border border-white/10 hover:bg-white/5 transition text-xs",onClick:v[6]||(v[6]=lt(E=>{Je.value=!Je.value,ce.value=!1,ot.value=!1},["stop"]))},[e("span",null,h(gl[i(K).shape]),1),v[41]||(v[41]=e("span",{class:"text-slate-400"},"▼",-1))]),Je.value?(s(),n("div",{key:0,class:"absolute top-full left-0 mt-1 w-56 bg-slate-800 border border-white/10 rounded-lg shadow-xl z-50 p-3",onClick:v[8]||(v[8]=lt(()=>{},["stop"]))},[e("div",dv,[v[42]||(v[42]=e("p",{class:"text-xs text-slate-400 mb-1.5"},"Форма",-1)),e("div",uv,[(s(!0),n(ee,null,me(Object.values(i(Bt)),E=>(s(),n("button",{key:E,type:"button",class:Q(["flex-1 py-1.5 rounded border text-sm transition",i(K).shape===E?"bg-sky-500/20 border-sky-400/60":"border-white/10 hover:bg-white/5"]),title:Zo[E],onClick:ve=>i(c).setSelectionShape(E)},h(gl[E]),11,mv))),128))])]),e("div",vv,[v[43]||(v[43]=e("p",{class:"text-xs text-slate-400 mb-1.5"},"Режим",-1)),e("div",fv,[(s(!0),n(ee,null,me(Object.values(i(qt)),E=>(s(),n("button",{key:E,type:"button",class:Q(["flex-1 py-1.5 rounded border text-xs transition",i(K).mode===E?"bg-sky-500/20 border-sky-400/60":"border-white/10 hover:bg-white/5"]),title:Ko[E],onClick:ve=>i(c).setSelectionMode(E)},h(Jo[E]),11,Av))),128))])]),e("div",pv,[v[44]||(v[44]=e("p",{class:"text-xs text-slate-400 mb-1.5"},"Поведение",-1)),e("div",hv,[(s(!0),n(ee,null,me(Object.values(i(os)),E=>(s(),n("button",{key:E,type:"button",class:Q(["flex-1 py-1 rounded border text-[10px] transition",i(K).behavior===E?"bg-sky-500/20 border-sky-400/60":"border-white/10 hover:bg-white/5"]),title:yl[E],onClick:ve=>i(c).setSelectionBehavior(E)},h(ea[E]),11,gv))),128))]),e("p",yv,h(yl[i(K).behavior]),1)]),i(K).shape===i(Bt).LINE?(s(),n("div",bv,[e("p",kv,"Ширина линии: "+h(i(K).lineWidth),1),e("input",{type:"range",min:"1",max:"5",value:i(K).lineWidth,class:"w-full",onInput:v[7]||(v[7]=E=>i(c).setSelectionLineWidth(Number(E.target.value)))},null,40,xv)])):_("",!0)])):_("",!0)]),ye.value.size>0?(s(),n(ee,{key:0},[e("span",wv,h(ye.value.size)+" выбрано",1),e("button",{type:"button",class:"px-2 py-1.5 rounded-lg border border-emerald-400/60 bg-emerald-500/20 text-emerald-100 text-xs hover:bg-emerald-500/30 transition",title:"Заполнить выбранным террейном",onClick:js}," 🎨 Залить "),e("button",{type:"button",class:"px-2 py-1.5 rounded-lg border border-amber-400/60 bg-amber-500/20 text-amber-100 text-xs hover:bg-amber-500/30 transition",title:"Рандомная заливка по профилю",onClick:v[9]||(v[9]=E=>{Ke.value=!Ke.value,ce.value=!1,Je.value=!1})}," 🎲 Рандом "),e("button",{type:"button",class:"px-2 py-1.5 rounded-lg border border-rose-400/60 bg-rose-500/20 text-rose-100 text-xs hover:bg-rose-500/30 transition",title:"Удалить выбранные гексы",onClick:Gs}," 🗑️ "),e("button",{type:"button",class:"px-2 py-1.5 rounded-lg border border-white/10 text-slate-300 text-xs hover:bg-white/5 transition",title:"Снять выделение",onClick:Rs}," ✕ ")],64)):_("",!0)],64)):_("",!0),v[52]||(v[52]=e("div",{class:"w-px h-6 bg-white/10 mx-1"},null,-1)),e("div",Cv,[e("button",{type:"button",class:"flex items-center gap-2 px-2 py-1.5 rounded-lg border border-white/10 hover:bg-white/5 transition text-sm",onClick:v[10]||(v[10]=lt(E=>{ce.value=!ce.value,ot.value=!1,Je.value=!1},["stop"]))},[e("span",{class:"w-5 h-5 rounded",style:Qe({backgroundColor:Dt.value.fallbackColor||Dt.value.color||"#888"})},null,4),e("span",$v,h(Dt.value.name||i(F)),1)]),ce.value?(s(),n("div",{key:0,class:"absolute top-full left-0 mt-1 w-80 bg-slate-800 border border-white/10 rounded-lg shadow-xl z-50 overflow-hidden",onClick:v[17]||(v[17]=lt(()=>{},["stop"]))},[e("div",_v,[e("div",Tv,[De(e("input",{"onUpdate:modelValue":v[11]||(v[11]=E=>N.value=E),type:"text",placeholder:"Поиск террейна...",class:"flex-1 px-2 py-1 text-xs bg-slate-900/50 border border-white/10 rounded focus:outline-none focus:border-sky-400/50"},null,512),[[je,N.value]]),e("button",{type:"button",class:Q(["p-1 rounded hover:bg-white/10 transition text-xs",Et.value?"bg-sky-500/20 text-sky-400":"text-slate-400"]),onClick:v[12]||(v[12]=E=>Et.value=!Et.value),title:"Показать фильтры"}," ⚙ ",2)]),Et.value?(s(),n("div",Iv,[e("div",Sv,[v[47]||(v[47]=e("span",{class:"text-xs text-slate-400 w-16"},"Биом:",-1)),De(e("select",{"onUpdate:modelValue":v[13]||(v[13]=E=>Ge.value=E),class:"flex-1 px-2 py-1 text-xs bg-slate-900/50 border border-white/10 rounded focus:outline-none"},[v[46]||(v[46]=e("option",{value:null},"Все биомы",-1)),(s(!0),n(ee,null,me(i(f).biomes,E=>(s(),n("option",{key:E.id,value:E.id},h(E.name),9,Ev))),128))],512),[[Kt,Ge.value]])]),e("div",Pv,[v[49]||(v[49]=e("span",{class:"text-xs text-slate-400 w-16"},"Обзор:",-1)),De(e("select",{"onUpdate:modelValue":v[14]||(v[14]=E=>rt.value=E),class:"flex-1 px-2 py-1 text-xs bg-slate-900/50 border border-white/10 rounded focus:outline-none"},[v[48]||(v[48]=e("option",{value:null},"Любой",-1)),(s(!0),n(ee,null,me(i(f).visibilityTypes,E=>(s(),n("option",{key:E.id,value:E.id},h(E.name),9,Mv))),128))],512),[[Kt,rt.value]])]),e("div",Dv,[v[50]||(v[50]=e("span",{class:"text-xs text-slate-400 w-16"},"Проход:",-1)),De(e("input",{"onUpdate:modelValue":v[15]||(v[15]=E=>ft.value.max=E),type:"range",min:"1",max:"5",step:"1",class:"flex-1"},null,512),[[je,ft.value.max,void 0,{number:!0}]]),e("span",Bv,"≤"+h(ft.value.max),1)]),e("button",{type:"button",class:"w-full px-2 py-1 text-xs bg-slate-700/50 hover:bg-slate-700 rounded transition",onClick:v[16]||(v[16]=E=>{Ge.value=null,rt.value=null,ft.value={min:1,max:5},N.value=""})}," Сбросить фильтры ")])):_("",!0)]),e("div",Rv,[ut.value.length>0?(s(),n("div",Fv,[(s(!0),n(ee,null,me(ut.value,E=>(s(),n("button",{key:E.id,type:"button",class:Q(["w-12 h-12 rounded border border-white/10 hover:border-white/30 transition relative group",i(F)===E.id?"ring-2 ring-sky-400":""]),style:Qe({backgroundColor:E.color||E.fallbackColor||"#888"}),title:`${E.name}
Проход: ${E.movementCost??1}
Ближ. бой: ${(E.meleeAdvantage??0)>0?"+":""}${E.meleeAdvantage??0}`,onClick:ve=>Pn(E.id)},[e("div",Nv,[E.movementCost>=5?(s(),n("span",Ov,"🚫")):E.movementCost>2?(s(),n("span",Hv,"⚠")):_("",!0),E.visibility==="blocking"?(s(),n("span",qv,"🔲")):E.visibility==="partial"?(s(),n("span",Uv,"🌿")):_("",!0),(E.meleeAdvantage??0)>0?(s(),n("span",Wv,"+"+h(E.meleeAdvantage),1)):(E.meleeAdvantage??0)<0?(s(),n("span",zv,h(E.meleeAdvantage),1)):_("",!0)])],14,Lv))),128))])):(s(),n("div",Vv," Террейны не найдены ")),!N.value&&!Ge.value&&!rt.value?(s(),n("div",Qv,[v[51]||(v[51]=e("div",{class:"text-xs text-slate-500 mb-1"},"Базовые (совместимость):",-1)),e("div",jv,[(s(!0),n(ee,null,me(i(Xs),(E,ve)=>(s(),n("button",{key:ve,type:"button",class:Q(["w-12 h-12 rounded border border-white/10 hover:border-white/30 transition",i(F)===ve?"ring-2 ring-sky-400":""]),style:Qe({backgroundColor:E.color}),title:E.name,onClick:ue=>Pn(ve)},null,14,Gv))),128))])])):_("",!0)])])):_("",!0)])])):_("",!0),e("div",Yv,[i(D)?(s(),n(ee,{key:0},[e("button",{type:"button",class:Q(["px-3 py-1.5 rounded-lg border text-xs transition",i(Y)?"bg-emerald-500/20 border-emerald-400/60 text-emerald-100":"border-white/10 hover:bg-white/5 text-slate-300"]),onClick:En},h(i(Y)?"✓ Готово":"✏️ Редактировать"),3),i(m)?(s(),n("button",{key:0,type:"button",class:Q(["px-3 py-1.5 rounded-lg border text-xs transition",(le=i(m).visibility)!=null&&le.published?"bg-emerald-500/20 border-emerald-400/60 text-emerald-100":"border-white/10 hover:bg-white/5 text-slate-300"]),title:(we=i(m).visibility)!=null&&we.published?"Карта видна игрокам":"Карта скрыта",onClick:fl},h((Le=i(m).visibility)!=null&&Le.published?"👁 Видима":"🙈 Скрыта"),11,Xv)):_("",!0)],64)):_("",!0),e("button",{type:"button",class:"w-9 h-9 rounded-lg border border-white/10 hover:bg-white/5 flex items-center justify-center text-sm",title:"Центрировать (0,0)",onClick:v[18]||(v[18]=E=>{As(),Nt()})}," 🎯 ")])])):_("",!0),e("div",Zv,[e("div",{ref_key:"canvasContainer",ref:Ae,class:"flex-1 overflow-hidden relative bg-slate-900/40 z-0"},[e("canvas",{ref_key:"terrainCanvas",ref:Ee,class:"absolute top-0 left-0",width:Ne.value.width,height:Ne.value.height},null,8,Jv),e("canvas",{ref_key:"gridCanvas",ref:Se,class:"absolute top-0 left-0",width:Ne.value.width,height:Ne.value.height},null,8,Kv),e("canvas",{ref_key:"uiCanvas",ref:Be,class:Q(["absolute top-0 left-0",Xe.value?"cursor-grabbing":i(U)!==i(mt).NONE||i(Y)?"cursor-crosshair":"cursor-grab"]),width:Ne.value.width,height:Ne.value.height,onMousemove:cn,onMousedown:dn,onMouseup:un,onMouseleave:mn,onWheel:G,onTouchstart:Lo,onTouchmove:No,onTouchend:Oo,onContextmenu:v[19]||(v[19]=lt(()=>{},["prevent"]))},null,42,ef),A(md,{ref_key:"mapPointerRef",ref:He,width:Ne.value.width,height:Ne.value.height,camera:i(W),"hex-grid":Ye.value,"selected-token-position":null,"token-size":be.value},null,8,["width","height","camera","hex-grid","token-size"]),i(D)&&Pe.value?(s(),n("div",tf,[A(wd)])):_("",!0),i(D)&&!Pe.value?(s(),n("button",{key:1,type:"button",class:"absolute top-2 left-1/2 -translate-x-1/2 z-20 px-3 py-1.5 rounded-lg bg-slate-800/90 border border-white/10 hover:bg-slate-700 transition text-sm flex items-center gap-2",onClick:v[20]||(v[20]=E=>Pe.value=!0)}," 👆 Указка ")):_("",!0),i(D)&&Pe.value?(s(),n("button",{key:2,type:"button",class:"absolute top-14 left-1/2 -translate-x-1/2 z-20 px-2 py-1 rounded bg-slate-800/80 border border-white/10 hover:bg-slate-700 transition text-xs",onClick:v[21]||(v[21]=E=>{Pe.value=!1,i(y).setTool(i(mt).NONE)})}," ✕ Закрыть ")):_("",!0),ke.value&&(!t.mobileMode||i(D))?(s(),n("div",sf," q: "+h(ke.value.q)+", r: "+h(ke.value.r),1)):_("",!0),!i(D)&&!t.mobileMode?(s(),n("div",nf,h(Math.round(i(W).zoom*100))+"% ",1)):_("",!0),i(D)&&!t.mobileMode?(s(),st($m,{key:5,"editing-map":C.value,"editor-mode":i(j),"top-offset":$e.value,"selected-terrain":i(F),"selected-hex-count":ye.value.size,onSetEditorMode:Ho,onToggleEditing:En,onSelectTerrain:Pn,onSelectProfile:qo,onEditProfile:v[22]||(v[22]=E=>xe.value=!0),onFillSelection:js,onFillProfile:Qo,onDeleteSelection:Gs,onClearSelection:Rs,onUndo:Mo,onRedo:Do},null,8,["editing-map","editor-mode","top-offset","selected-terrain","selected-hex-count"])):_("",!0),i(D)?(s(),st(su,{key:6,"selected-token":ae.value,"top-offset":$e.value,onSelectToken:Uo,onOpenCharacterSheet:v[23]||(v[23]=E=>g.$emit("open-character-sheet",E))},null,8,["selected-token","top-offset"])):_("",!0)],512)]),e("div",lf,[A(Ps,{name:"slide-up"},{default:ys(()=>[Ke.value&&i(D)&&!t.mobileMode?(s(),st(Zi,{key:0,class:"absolute bottom-full left-0 right-0 max-h-[60vh] overflow-y-auto border-t border-white/10 shadow-2xl",onClose:v[24]||(v[24]=E=>{Ke.value=!1,jo()}),onPreview:zo,onApply:Al})):_("",!0)]),_:1}),i(D)&&!t.mobileMode?(s(),st(Rd,{key:0,"editing-map":C.value,zoom:i(W).zoom,onToggleEditing:En,onToggleVisibility:fl,onDeleteMap:Wo,onCreateMap:v[25]||(v[25]=E=>We.value=!0),onSelectMap:vl,onCenterCamera:v[26]||(v[26]=E=>{As(),Nt()})},null,8,["editing-map","zoom"])):_("",!0)]),!i(D)&&!t.mobileMode?(s(),n("footer",of,[e("div",af,[e("p",rf,[i(Y)?(s(),n(ee,{key:0},[Ce(" Рисуйте кликом/перетаскиванием • Ctrl+drag для навигации • Колёсико для зума • 🎯 центр (0,0) ")],64)):(s(),n(ee,{key:1},[Ce(" Ctrl+перетаскивание для навигации ")],64))])])])):_("",!0),(s(),st(Vt,{to:"body"},[We.value?(s(),n("div",{key:0,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/60",onClick:v[33]||(v[33]=lt(E=>We.value=!1,["self"]))},[e("div",cf,[v[58]||(v[58]=e("h3",{class:"text-lg font-semibold mb-4"},"Создать карту",-1)),e("div",df,[e("div",null,[v[53]||(v[53]=e("label",{class:"block text-sm text-slate-400 mb-1"},"Название",-1)),De(e("input",{"onUpdate:modelValue":v[27]||(v[27]=E=>bt.value.name=E),type:"text",class:"w-full px-3 py-2 rounded-lg bg-slate-900 border border-white/10 text-sm",placeholder:"Новая карта"},null,512),[[je,bt.value.name]])]),e("div",null,[v[54]||(v[54]=e("label",{class:"block text-sm text-slate-400 mb-1"},"Ориентация гексов",-1)),e("div",uf,[e("button",{type:"button",class:Q(["flex-1 py-2 rounded-lg border text-sm transition",bt.value.orientation==="flat"?"bg-sky-500/20 border-sky-400/60":"border-white/10 hover:bg-white/5"]),onClick:v[28]||(v[28]=E=>bt.value.orientation="flat")}," Flat-top ⬡ ",2),e("button",{type:"button",class:Q(["flex-1 py-2 rounded-lg border text-sm transition",bt.value.orientation==="pointy"?"bg-sky-500/20 border-sky-400/60":"border-white/10 hover:bg-white/5"]),onClick:v[29]||(v[29]=E=>bt.value.orientation="pointy")}," Pointy-top ⬢ ",2)])]),e("div",null,[v[55]||(v[55]=e("label",{class:"block text-sm text-slate-400 mb-1"},"Масштаб",-1)),De(e("select",{"onUpdate:modelValue":v[30]||(v[30]=E=>bt.value.scale=E),class:"w-full px-3 py-2 rounded-lg bg-slate-900 border border-white/10 text-sm"},[(s(),n(ee,null,me(hl,(E,ve)=>e("option",{key:ve,value:ve},h(E),9,mf)),64))],512),[[Kt,bt.value.scale]])]),e("div",null,[v[56]||(v[56]=e("label",{class:"block text-sm text-slate-400 mb-1"},"Размер гекса (пиксели)",-1)),De(e("input",{"onUpdate:modelValue":v[31]||(v[31]=E=>bt.value.hexSize=E),type:"number",min:"16",max:"64",class:"w-full px-3 py-2 rounded-lg bg-slate-900 border border-white/10 text-sm"},null,512),[[je,bt.value.hexSize,void 0,{number:!0}]])]),v[57]||(v[57]=e("p",{class:"text-xs text-slate-500"}," Карта не имеет фиксированных границ — она расширяется по мере рисования. Центр карты находится в координатах (0, 0). ",-1))]),e("div",vf,[e("button",{type:"button",class:"px-4 py-2 rounded-lg border border-white/10 hover:bg-white/5 text-sm",onClick:v[32]||(v[32]=E=>We.value=!1)}," Отмена "),e("button",{type:"button",class:"px-4 py-2 rounded-lg bg-sky-500 hover:bg-sky-600 text-sm font-medium",onClick:ml}," Создать ")])])])):_("",!0)])),A(dd,{visible:xe.value,onClose:v[34]||(v[34]=E=>xe.value=!1),onSelect:Vo},null,8,["visible"])])}}},hf=zt(pf,[["__scopeId","data-v-2430408d"]]);var gf={webm:"data:video/webm;base64,GkXfowEAAAAAAAAfQoaBAUL3gQFC8oEEQvOBCEKChHdlYm1Ch4EEQoWBAhhTgGcBAAAAAAAVkhFNm3RALE27i1OrhBVJqWZTrIHfTbuMU6uEFlSua1OsggEwTbuMU6uEHFO7a1OsghV17AEAAAAAAACkAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAVSalmAQAAAAAAAEUq17GDD0JATYCNTGF2ZjU1LjMzLjEwMFdBjUxhdmY1NS4zMy4xMDBzpJBlrrXf3DCDVB8KcgbMpcr+RImIQJBgAAAAAAAWVK5rAQAAAAAAD++uAQAAAAAAADLXgQFzxYEBnIEAIrWcg3VuZIaFVl9WUDiDgQEj44OEAmJaAOABAAAAAAAABrCBsLqBkK4BAAAAAAAPq9eBAnPFgQKcgQAitZyDdW5khohBX1ZPUkJJU4OBAuEBAAAAAAAAEZ+BArWIQOdwAAAAAABiZIEgY6JPbwIeVgF2b3JiaXMAAAAAAoC7AAAAAAAAgLUBAAAAAAC4AQN2b3JiaXMtAAAAWGlwaC5PcmcgbGliVm9yYmlzIEkgMjAxMDExMDEgKFNjaGF1ZmVudWdnZXQpAQAAABUAAABlbmNvZGVyPUxhdmM1NS41Mi4xMDIBBXZvcmJpcyVCQ1YBAEAAACRzGCpGpXMWhBAaQlAZ4xxCzmvsGUJMEYIcMkxbyyVzkCGkoEKIWyiB0JBVAABAAACHQXgUhIpBCCGEJT1YkoMnPQghhIg5eBSEaUEIIYQQQgghhBBCCCGERTlokoMnQQgdhOMwOAyD5Tj4HIRFOVgQgydB6CCED0K4moOsOQghhCQ1SFCDBjnoHITCLCiKgsQwuBaEBDUojILkMMjUgwtCiJqDSTX4GoRnQXgWhGlBCCGEJEFIkIMGQcgYhEZBWJKDBjm4FITLQagahCo5CB+EIDRkFQCQAACgoiiKoigKEBqyCgDIAAAQQFEUx3EcyZEcybEcCwgNWQUAAAEACAAAoEiKpEiO5EiSJFmSJVmSJVmS5omqLMuyLMuyLMsyEBqyCgBIAABQUQxFcRQHCA1ZBQBkAAAIoDiKpViKpWiK54iOCISGrAIAgAAABAAAEDRDUzxHlETPVFXXtm3btm3btm3btm3btm1blmUZCA1ZBQBAAAAQ0mlmqQaIMAMZBkJDVgEACAAAgBGKMMSA0JBVAABAAACAGEoOogmtOd+c46BZDppKsTkdnEi1eZKbirk555xzzsnmnDHOOeecopxZDJoJrTnnnMSgWQqaCa0555wnsXnQmiqtOeeccc7pYJwRxjnnnCateZCajbU555wFrWmOmkuxOeecSLl5UptLtTnnnHPOOeecc84555zqxekcnBPOOeecqL25lpvQxTnnnE/G6d6cEM4555xzzjnnnHPOOeecIDRkFQAABABAEIaNYdwpCNLnaCBGEWIaMulB9+gwCRqDnELq0ehopJQ6CCWVcVJKJwgNWQUAAAIAQAghhRRSSCGFFFJIIYUUYoghhhhyyimnoIJKKqmooowyyyyzzDLLLLPMOuyssw47DDHEEEMrrcRSU2011lhr7jnnmoO0VlprrbVSSimllFIKQkNWAQAgAAAEQgYZZJBRSCGFFGKIKaeccgoqqIDQkFUAACAAgAAAAABP8hzRER3RER3RER3RER3R8RzPESVREiVREi3TMjXTU0VVdWXXlnVZt31b2IVd933d933d+HVhWJZlWZZlWZZlWZZlWZZlWZYgNGQVAAACAAAghBBCSCGFFFJIKcYYc8w56CSUEAgNWQUAAAIACAAAAHAUR3EcyZEcSbIkS9IkzdIsT/M0TxM9URRF0zRV0RVdUTdtUTZl0zVdUzZdVVZtV5ZtW7Z125dl2/d93/d93/d93/d93/d9XQdCQ1YBABIAADqSIymSIimS4ziOJElAaMgqAEAGAEAAAIriKI7jOJIkSZIlaZJneZaomZrpmZ4qqkBoyCoAABAAQAAAAAAAAIqmeIqpeIqoeI7oiJJomZaoqZoryqbsuq7ruq7ruq7ruq7ruq7ruq7ruq7ruq7ruq7ruq7ruq7ruq4LhIasAgAkAAB0JEdyJEdSJEVSJEdygNCQVQCADACAAAAcwzEkRXIsy9I0T/M0TxM90RM901NFV3SB0JBVAAAgAIAAAAAAAAAMybAUy9EcTRIl1VItVVMt1VJF1VNVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVN0zRNEwgNWQkAkAEAkBBTLS3GmgmLJGLSaqugYwxS7KWxSCpntbfKMYUYtV4ah5RREHupJGOKQcwtpNApJq3WVEKFFKSYYyoVUg5SIDRkhQAQmgHgcBxAsixAsiwAAAAAAAAAkDQN0DwPsDQPAAAAAAAAACRNAyxPAzTPAwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABA0jRA8zxA8zwAAAAAAAAA0DwP8DwR8EQRAAAAAAAAACzPAzTRAzxRBAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABA0jRA8zxA8zwAAAAAAAAAsDwP8EQR0DwRAAAAAAAAACzPAzxRBDzRAwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAEOAAABBgIRQasiIAiBMAcEgSJAmSBM0DSJYFTYOmwTQBkmVB06BpME0AAAAAAAAAAAAAJE2DpkHTIIoASdOgadA0iCIAAAAAAAAAAAAAkqZB06BpEEWApGnQNGgaRBEAAAAAAAAAAAAAzzQhihBFmCbAM02IIkQRpgkAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAAAGHAAAAgwoQwUGrIiAIgTAHA4imUBAIDjOJYFAACO41gWAABYliWKAABgWZooAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIAAAYcAAACDChDBQashIAiAIAcCiKZQHHsSzgOJYFJMmyAJYF0DyApgFEEQAIAAAocAAACLBBU2JxgEJDVgIAUQAABsWxLE0TRZKkaZoniiRJ0zxPFGma53meacLzPM80IYqiaJoQRVE0TZimaaoqME1VFQAAUOAAABBgg6bE4gCFhqwEAEICAByKYlma5nmeJ4qmqZokSdM8TxRF0TRNU1VJkqZ5niiKommapqqyLE3zPFEURdNUVVWFpnmeKIqiaaqq6sLzPE8URdE0VdV14XmeJ4qiaJqq6roQRVE0TdNUTVV1XSCKpmmaqqqqrgtETxRNU1Vd13WB54miaaqqq7ouEE3TVFVVdV1ZBpimaaqq68oyQFVV1XVdV5YBqqqqruu6sgxQVdd1XVmWZQCu67qyLMsCAAAOHAAAAoygk4wqi7DRhAsPQKEhKwKAKAAAwBimFFPKMCYhpBAaxiSEFEImJaXSUqogpFJSKRWEVEoqJaOUUmopVRBSKamUCkIqJZVSAADYgQMA2IGFUGjISgAgDwCAMEYpxhhzTiKkFGPOOScRUoox55yTSjHmnHPOSSkZc8w556SUzjnnnHNSSuacc845KaVzzjnnnJRSSuecc05KKSWEzkEnpZTSOeecEwAAVOAAABBgo8jmBCNBhYasBABSAQAMjmNZmuZ5omialiRpmud5niiapiZJmuZ5nieKqsnzPE8URdE0VZXneZ4oiqJpqirXFUXTNE1VVV2yLIqmaZqq6rowTdNUVdd1XZimaaqq67oubFtVVdV1ZRm2raqq6rqyDFzXdWXZloEsu67s2rIAAPAEBwCgAhtWRzgpGgssNGQlAJABAEAYg5BCCCFlEEIKIYSUUggJAAAYcAAACDChDBQashIASAUAAIyx1lprrbXWQGettdZaa62AzFprrbXWWmuttdZaa6211lJrrbXWWmuttdZaa6211lprrbXWWmuttdZaa6211lprrbXWWmuttdZaa6211lprrbXWWmstpZRSSimllFJKKaWUUkoppZRSSgUA+lU4APg/2LA6wknRWGChISsBgHAAAMAYpRhzDEIppVQIMeacdFRai7FCiDHnJKTUWmzFc85BKCGV1mIsnnMOQikpxVZjUSmEUlJKLbZYi0qho5JSSq3VWIwxqaTWWoutxmKMSSm01FqLMRYjbE2ptdhqq7EYY2sqLbQYY4zFCF9kbC2m2moNxggjWywt1VprMMYY3VuLpbaaizE++NpSLDHWXAAAd4MDAESCjTOsJJ0VjgYXGrISAAgJACAQUooxxhhzzjnnpFKMOeaccw5CCKFUijHGnHMOQgghlIwx5pxzEEIIIYRSSsaccxBCCCGEkFLqnHMQQgghhBBKKZ1zDkIIIYQQQimlgxBCCCGEEEoopaQUQgghhBBCCKmklEIIIYRSQighlZRSCCGEEEIpJaSUUgohhFJCCKGElFJKKYUQQgillJJSSimlEkoJJYQSUikppRRKCCGUUkpKKaVUSgmhhBJKKSWllFJKIYQQSikFAAAcOAAABBhBJxlVFmGjCRcegEJDVgIAZAAAkKKUUiktRYIipRikGEtGFXNQWoqocgxSzalSziDmJJaIMYSUk1Qy5hRCDELqHHVMKQYtlRhCxhik2HJLoXMOAAAAQQCAgJAAAAMEBTMAwOAA4XMQdAIERxsAgCBEZohEw0JweFAJEBFTAUBigkIuAFRYXKRdXECXAS7o4q4DIQQhCEEsDqCABByccMMTb3jCDU7QKSp1IAAAAAAADADwAACQXAAREdHMYWRobHB0eHyAhIiMkAgAAAAAABcAfAAAJCVAREQ0cxgZGhscHR4fICEiIyQBAIAAAgAAAAAggAAEBAQAAAAAAAIAAAAEBB9DtnUBAAAAAAAEPueBAKOFggAAgACjzoEAA4BwBwCdASqwAJAAAEcIhYWIhYSIAgIABhwJ7kPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99YAD+/6tQgKOFggADgAqjhYIAD4AOo4WCACSADqOZgQArADECAAEQEAAYABhYL/QACIBDmAYAAKOFggA6gA6jhYIAT4AOo5mBAFMAMQIAARAQABgAGFgv9AAIgEOYBgAAo4WCAGSADqOFggB6gA6jmYEAewAxAgABEBAAGAAYWC/0AAiAQ5gGAACjhYIAj4AOo5mBAKMAMQIAARAQABgAGFgv9AAIgEOYBgAAo4WCAKSADqOFggC6gA6jmYEAywAxAgABEBAAGAAYWC/0AAiAQ5gGAACjhYIAz4AOo4WCAOSADqOZgQDzADECAAEQEAAYABhYL/QACIBDmAYAAKOFggD6gA6jhYIBD4AOo5iBARsAEQIAARAQFGAAYWC/0AAiAQ5gGACjhYIBJIAOo4WCATqADqOZgQFDADECAAEQEAAYABhYL/QACIBDmAYAAKOFggFPgA6jhYIBZIAOo5mBAWsAMQIAARAQABgAGFgv9AAIgEOYBgAAo4WCAXqADqOFggGPgA6jmYEBkwAxAgABEBAAGAAYWC/0AAiAQ5gGAACjhYIBpIAOo4WCAbqADqOZgQG7ADECAAEQEAAYABhYL/QACIBDmAYAAKOFggHPgA6jmYEB4wAxAgABEBAAGAAYWC/0AAiAQ5gGAACjhYIB5IAOo4WCAfqADqOZgQILADECAAEQEAAYABhYL/QACIBDmAYAAKOFggIPgA6jhYICJIAOo5mBAjMAMQIAARAQABgAGFgv9AAIgEOYBgAAo4WCAjqADqOFggJPgA6jmYECWwAxAgABEBAAGAAYWC/0AAiAQ5gGAACjhYICZIAOo4WCAnqADqOZgQKDADECAAEQEAAYABhYL/QACIBDmAYAAKOFggKPgA6jhYICpIAOo5mBAqsAMQIAARAQABgAGFgv9AAIgEOYBgAAo4WCArqADqOFggLPgA6jmIEC0wARAgABEBAUYABhYL/QACIBDmAYAKOFggLkgA6jhYIC+oAOo5mBAvsAMQIAARAQABgAGFgv9AAIgEOYBgAAo4WCAw+ADqOZgQMjADECAAEQEAAYABhYL/QACIBDmAYAAKOFggMkgA6jhYIDOoAOo5mBA0sAMQIAARAQABgAGFgv9AAIgEOYBgAAo4WCA0+ADqOFggNkgA6jmYEDcwAxAgABEBAAGAAYWC/0AAiAQ5gGAACjhYIDeoAOo4WCA4+ADqOZgQObADECAAEQEAAYABhYL/QACIBDmAYAAKOFggOkgA6jhYIDuoAOo5mBA8MAMQIAARAQABgAGFgv9AAIgEOYBgAAo4WCA8+ADqOFggPkgA6jhYID+oAOo4WCBA+ADhxTu2sBAAAAAAAAEbuPs4EDt4r3gQHxghEr8IEK",mp4:"data:video/mp4;base64,AAAAHGZ0eXBNNFYgAAACAGlzb21pc28yYXZjMQAAAAhmcmVlAAAGF21kYXTeBAAAbGliZmFhYyAxLjI4AABCAJMgBDIARwAAArEGBf//rdxF6b3m2Ui3lizYINkj7u94MjY0IC0gY29yZSAxNDIgcjIgOTU2YzhkOCAtIEguMjY0L01QRUctNCBBVkMgY29kZWMgLSBDb3B5bGVmdCAyMDAzLTIwMTQgLSBodHRwOi8vd3d3LnZpZGVvbGFuLm9yZy94MjY0Lmh0bWwgLSBvcHRpb25zOiBjYWJhYz0wIHJlZj0zIGRlYmxvY2s9MTowOjAgYW5hbHlzZT0weDE6MHgxMTEgbWU9aGV4IHN1Ym1lPTcgcHN5PTEgcHN5X3JkPTEuMDA6MC4wMCBtaXhlZF9yZWY9MSBtZV9yYW5nZT0xNiBjaHJvbWFfbWU9MSB0cmVsbGlzPTEgOHg4ZGN0PTAgY3FtPTAgZGVhZHpvbmU9MjEsMTEgZmFzdF9wc2tpcD0xIGNocm9tYV9xcF9vZmZzZXQ9LTIgdGhyZWFkcz02IGxvb2thaGVhZF90aHJlYWRzPTEgc2xpY2VkX3RocmVhZHM9MCBucj0wIGRlY2ltYXRlPTEgaW50ZXJsYWNlZD0wIGJsdXJheV9jb21wYXQ9MCBjb25zdHJhaW5lZF9pbnRyYT0wIGJmcmFtZXM9MCB3ZWlnaHRwPTAga2V5aW50PTI1MCBrZXlpbnRfbWluPTI1IHNjZW5lY3V0PTQwIGludHJhX3JlZnJlc2g9MCByY19sb29rYWhlYWQ9NDAgcmM9Y3JmIG1idHJlZT0xIGNyZj0yMy4wIHFjb21wPTAuNjAgcXBtaW49MCBxcG1heD02OSBxcHN0ZXA9NCB2YnZfbWF4cmF0ZT03NjggdmJ2X2J1ZnNpemU9MzAwMCBjcmZfbWF4PTAuMCBuYWxfaHJkPW5vbmUgZmlsbGVyPTAgaXBfcmF0aW89MS40MCBhcT0xOjEuMDAAgAAAAFZliIQL8mKAAKvMnJycnJycnJycnXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXiEASZACGQAjgCEASZACGQAjgAAAAAdBmjgX4GSAIQBJkAIZACOAAAAAB0GaVAX4GSAhAEmQAhkAI4AhAEmQAhkAI4AAAAAGQZpgL8DJIQBJkAIZACOAIQBJkAIZACOAAAAABkGagC/AySEASZACGQAjgAAAAAZBmqAvwMkhAEmQAhkAI4AhAEmQAhkAI4AAAAAGQZrAL8DJIQBJkAIZACOAAAAABkGa4C/AySEASZACGQAjgCEASZACGQAjgAAAAAZBmwAvwMkhAEmQAhkAI4AAAAAGQZsgL8DJIQBJkAIZACOAIQBJkAIZACOAAAAABkGbQC/AySEASZACGQAjgCEASZACGQAjgAAAAAZBm2AvwMkhAEmQAhkAI4AAAAAGQZuAL8DJIQBJkAIZACOAIQBJkAIZACOAAAAABkGboC/AySEASZACGQAjgAAAAAZBm8AvwMkhAEmQAhkAI4AhAEmQAhkAI4AAAAAGQZvgL8DJIQBJkAIZACOAAAAABkGaAC/AySEASZACGQAjgCEASZACGQAjgAAAAAZBmiAvwMkhAEmQAhkAI4AhAEmQAhkAI4AAAAAGQZpAL8DJIQBJkAIZACOAAAAABkGaYC/AySEASZACGQAjgCEASZACGQAjgAAAAAZBmoAvwMkhAEmQAhkAI4AAAAAGQZqgL8DJIQBJkAIZACOAIQBJkAIZACOAAAAABkGawC/AySEASZACGQAjgAAAAAZBmuAvwMkhAEmQAhkAI4AhAEmQAhkAI4AAAAAGQZsAL8DJIQBJkAIZACOAAAAABkGbIC/AySEASZACGQAjgCEASZACGQAjgAAAAAZBm0AvwMkhAEmQAhkAI4AhAEmQAhkAI4AAAAAGQZtgL8DJIQBJkAIZACOAAAAABkGbgCvAySEASZACGQAjgCEASZACGQAjgAAAAAZBm6AnwMkhAEmQAhkAI4AhAEmQAhkAI4AhAEmQAhkAI4AhAEmQAhkAI4AAAAhubW9vdgAAAGxtdmhkAAAAAAAAAAAAAAAAAAAD6AAABDcAAQAAAQAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAwAAAzB0cmFrAAAAXHRraGQAAAADAAAAAAAAAAAAAAABAAAAAAAAA+kAAAAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAABAAAAAALAAAACQAAAAAAAkZWR0cwAAABxlbHN0AAAAAAAAAAEAAAPpAAAAAAABAAAAAAKobWRpYQAAACBtZGhkAAAAAAAAAAAAAAAAAAB1MAAAdU5VxAAAAAAALWhkbHIAAAAAAAAAAHZpZGUAAAAAAAAAAAAAAABWaWRlb0hhbmRsZXIAAAACU21pbmYAAAAUdm1oZAAAAAEAAAAAAAAAAAAAACRkaW5mAAAAHGRyZWYAAAAAAAAAAQAAAAx1cmwgAAAAAQAAAhNzdGJsAAAAr3N0c2QAAAAAAAAAAQAAAJ9hdmMxAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAALAAkABIAAAASAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGP//AAAALWF2Y0MBQsAN/+EAFWdCwA3ZAsTsBEAAAPpAADqYA8UKkgEABWjLg8sgAAAAHHV1aWRraEDyXyRPxbo5pRvPAyPzAAAAAAAAABhzdHRzAAAAAAAAAAEAAAAeAAAD6QAAABRzdHNzAAAAAAAAAAEAAAABAAAAHHN0c2MAAAAAAAAAAQAAAAEAAAABAAAAAQAAAIxzdHN6AAAAAAAAAAAAAAAeAAADDwAAAAsAAAALAAAACgAAAAoAAAAKAAAACgAAAAoAAAAKAAAACgAAAAoAAAAKAAAACgAAAAoAAAAKAAAACgAAAAoAAAAKAAAACgAAAAoAAAAKAAAACgAAAAoAAAAKAAAACgAAAAoAAAAKAAAACgAAAAoAAAAKAAAAiHN0Y28AAAAAAAAAHgAAAEYAAANnAAADewAAA5gAAAO0AAADxwAAA+MAAAP2AAAEEgAABCUAAARBAAAEXQAABHAAAASMAAAEnwAABLsAAATOAAAE6gAABQYAAAUZAAAFNQAABUgAAAVkAAAFdwAABZMAAAWmAAAFwgAABd4AAAXxAAAGDQAABGh0cmFrAAAAXHRraGQAAAADAAAAAAAAAAAAAAACAAAAAAAABDcAAAAAAAAAAAAAAAEBAAAAAAEAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAkZWR0cwAAABxlbHN0AAAAAAAAAAEAAAQkAAADcAABAAAAAAPgbWRpYQAAACBtZGhkAAAAAAAAAAAAAAAAAAC7gAAAykBVxAAAAAAALWhkbHIAAAAAAAAAAHNvdW4AAAAAAAAAAAAAAABTb3VuZEhhbmRsZXIAAAADi21pbmYAAAAQc21oZAAAAAAAAAAAAAAAJGRpbmYAAAAcZHJlZgAAAAAAAAABAAAADHVybCAAAAABAAADT3N0YmwAAABnc3RzZAAAAAAAAAABAAAAV21wNGEAAAAAAAAAAQAAAAAAAAAAAAIAEAAAAAC7gAAAAAAAM2VzZHMAAAAAA4CAgCIAAgAEgICAFEAVBbjYAAu4AAAADcoFgICAAhGQBoCAgAECAAAAIHN0dHMAAAAAAAAAAgAAADIAAAQAAAAAAQAAAkAAAAFUc3RzYwAAAAAAAAAbAAAAAQAAAAEAAAABAAAAAgAAAAIAAAABAAAAAwAAAAEAAAABAAAABAAAAAIAAAABAAAABgAAAAEAAAABAAAABwAAAAIAAAABAAAACAAAAAEAAAABAAAACQAAAAIAAAABAAAACgAAAAEAAAABAAAACwAAAAIAAAABAAAADQAAAAEAAAABAAAADgAAAAIAAAABAAAADwAAAAEAAAABAAAAEAAAAAIAAAABAAAAEQAAAAEAAAABAAAAEgAAAAIAAAABAAAAFAAAAAEAAAABAAAAFQAAAAIAAAABAAAAFgAAAAEAAAABAAAAFwAAAAIAAAABAAAAGAAAAAEAAAABAAAAGQAAAAIAAAABAAAAGgAAAAEAAAABAAAAGwAAAAIAAAABAAAAHQAAAAEAAAABAAAAHgAAAAIAAAABAAAAHwAAAAQAAAABAAAA4HN0c3oAAAAAAAAAAAAAADMAAAAaAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAACMc3RjbwAAAAAAAAAfAAAALAAAA1UAAANyAAADhgAAA6IAAAO+AAAD0QAAA+0AAAQAAAAEHAAABC8AAARLAAAEZwAABHoAAASWAAAEqQAABMUAAATYAAAE9AAABRAAAAUjAAAFPwAABVIAAAVuAAAFgQAABZ0AAAWwAAAFzAAABegAAAX7AAAGFwAAAGJ1ZHRhAAAAWm1ldGEAAAAAAAAAIWhkbHIAAAAAAAAAAG1kaXJhcHBsAAAAAAAAAAAAAAAALWlsc3QAAAAlqXRvbwAAAB1kYXRhAAAAAQAAAABMYXZmNTUuMzMuMTAw"};const{webm:yf,mp4:bf}=gf,Fn=()=>typeof navigator<"u"&&parseFloat((""+(/CPU.*OS ([0-9_]{3,4})[0-9_]{0,1}|(CPU like).*AppleWebKit.*Mobile/i.exec(navigator.userAgent)||[0,""])[1]).replace("undefined","3_2").replace("_",".").replace("_",""))<10&&!window.MSStream,Ln=()=>"wakeLock"in navigator;class kf{constructor(){if(this.enabled=!1,Ln()){this._wakeLock=null;const l=()=>{this._wakeLock!==null&&document.visibilityState==="visible"&&this.enable()};document.addEventListener("visibilitychange",l),document.addEventListener("fullscreenchange",l)}else Fn()?this.noSleepTimer=null:(this.noSleepVideo=document.createElement("video"),this.noSleepVideo.setAttribute("title","No Sleep"),this.noSleepVideo.setAttribute("playsinline",""),this._addSourceToVideo(this.noSleepVideo,"webm",yf),this._addSourceToVideo(this.noSleepVideo,"mp4",bf),this.noSleepVideo.addEventListener("loadedmetadata",()=>{this.noSleepVideo.duration<=1?this.noSleepVideo.setAttribute("loop",""):this.noSleepVideo.addEventListener("timeupdate",()=>{this.noSleepVideo.currentTime>.5&&(this.noSleepVideo.currentTime=Math.random())})}))}_addSourceToVideo(l,o,a){var r=document.createElement("source");r.src=a,r.type=`video/${o}`,l.appendChild(r)}get isEnabled(){return this.enabled}enable(){return Ln()?navigator.wakeLock.request("screen").then(l=>{this._wakeLock=l,this.enabled=!0,console.log("Wake Lock active."),this._wakeLock.addEventListener("release",()=>{console.log("Wake Lock released.")})}).catch(l=>{throw this.enabled=!1,console.error(`${l.name}, ${l.message}`),l}):Fn()?(this.disable(),console.warn(`
        NoSleep enabled for older iOS devices. This can interrupt
        active or long-running network requests from completing successfully.
        See https://github.com/richtr/NoSleep.js/issues/15 for more details.
      `),this.noSleepTimer=window.setInterval(()=>{document.hidden||(window.location.href=window.location.href.split("#")[0],window.setTimeout(window.stop,0))},15e3),this.enabled=!0,Promise.resolve()):this.noSleepVideo.play().then(o=>(this.enabled=!0,o)).catch(o=>{throw this.enabled=!1,o})}disable(){Ln()?(this._wakeLock&&this._wakeLock.release(),this._wakeLock=null):Fn()?this.noSleepTimer&&(console.warn(`
          NoSleep now disabled for older iOS devices.
        `),window.clearInterval(this.noSleepTimer),this.noSleepTimer=null):this.noSleepVideo.pause(),this.enabled=!1}}var xf=kf;const wf=ua(xf),So=new wf;let sn=!1;async function Jl(){if(sn)return console.log("[WakeLock] Уже активирован"),!0;try{return await So.enable(),sn=!0,console.log("[WakeLock] ✅ Активирован - экран не будет гаснуть"),!0}catch(t){return console.warn("[WakeLock] Ошибка активации:",t.message),!1}}async function Kl(){if(sn)try{So.disable(),sn=!1,console.log("[WakeLock] Освобождён")}catch(t){console.warn("[WakeLock] Ошибка при освобождении:",t.message)}}function eo(){return sn}const Cf=Xn("userPrefs",{state:()=>({keepScreenAwake:!1,compactMode:!1,showTutorialHints:!0,fontSize:"normal",enableAnimations:!0,showBattleGrid:!0,showGridCoordinates:!1,defaultMapZoom:1,touchControlMode:"tap",confirmActions:!0,enableSounds:!0,soundVolume:.7}),persist:{key:"trip-user-prefs",paths:["keepScreenAwake","compactMode","showTutorialHints","fontSize","enableAnimations","showBattleGrid","showGridCoordinates","defaultMapZoom","touchControlMode","confirmActions","enableSounds","soundVolume"]},getters:{isScreenAwake:()=>eo()},actions:{async toggleKeepScreenAwake(){return this.keepScreenAwake?(await Kl(),this.keepScreenAwake=!1):await Jl()&&(this.keepScreenAwake=!0),this.keepScreenAwake},async restoreWakeLockIfNeeded(){this.keepScreenAwake&&!eo()&&(await Jl()||(this.keepScreenAwake=!1))},resetToDefaults(){this.keepScreenAwake=!1,this.compactMode=!1,this.showTutorialHints=!0,this.fontSize="normal",this.enableAnimations=!0,this.showBattleGrid=!0,this.showGridCoordinates=!1,this.defaultMapZoom=1,this.touchControlMode="tap",this.confirmActions=!0,this.enableSounds=!0,this.soundVolume=.7,Kl()}}}),$f=()=>window.innerWidth<768,N_=()=>{let t=document.querySelector('meta[name="viewport"]');t||(t=document.createElement("meta"),t.name="viewport",document.head.appendChild(t)),t.content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"},_f={key:0,class:"collapsed-preview"},Tf={class:"collapsed-avatar"},If=["src","alt"],Sf={key:1,class:"avatar-fallback"},Ef={class:"collapsed-info"},Pf={class:"collapsed-name"},Mf={key:0,class:"collapsed-hint"},Df={key:1,class:"expanded-content"},Bf={class:"card-header"},Rf={class:"character-name"},Ff={key:0,class:"other-token-badge"},Lf={class:"card-body"},Nf={class:"portrait-section"},Of={class:"info-section"},Hf={key:0,class:"wounds-display"},qf={class:"wounds-row"},Uf={class:"wound-slots"},Wf={class:"wounds-row"},zf={class:"wound-slots"},Vf={class:"wounds-row"},Qf={class:"wound-slots"},jf={class:"wounds-row"},Gf={class:"wound-slots"},Yf={key:1,class:"other-info"},Xf={class:"info-row"},Zf={class:"info-row"},Jf={key:2,class:"terrain-info"},Kf={class:"info-row"},eA={key:0,class:"info-row"},tA={key:1,class:"terrain-stats"},sA={key:2,class:"info-row distance-row"},nA={key:3,class:"info-row distance-row text-red-400"},Nn=140,lA={__name:"MobileInfoCard",props:{selectedToken:{type:Object,default:null},selectedHex:{type:Object,default:null},playerCharacter:{type:Object,default:null},playerFacing:{type:Number,default:0},collapsed:{type:Boolean,default:!1},isPlayerTurn:{type:Boolean,default:!1},playerTokenPosition:{type:Object,default:null},alwaysShowPlayer:{type:Boolean,default:!1},isMaster:{type:Boolean,default:!1}},emits:["toggle-collapse","open-character-sheet","switch-equipment","move-to-hex"],setup(t,{emit:l}){const o=xs(),a=an(),r=t,c=l,f=R(null),k=ne(()=>!r.selectedHex||!r.playerTokenPosition?null:ma(r.playerTokenPosition.q,r.playerTokenPosition.r,r.selectedHex.q,r.selectedHex.r)),w=()=>{const C=r.playerCharacter;if(!C)return new Set;const L=new Set,$e=C.movementModifiers||C.abilities||{};return $e.flight&&L.add("flight"),$e.swimming&&L.add("swimming"),$e.phasing&&L.add("phasing"),$e.climbing&&L.add("climbing"),C.movementTags&&C.movementTags.forEach(Ae=>L.add(Ae)),L},x=(C,L)=>{var Ae;const $e=o.activeMap;return $e?o.getHexPathfindingData($e.id,C,L,a,{viewerId:(Ae=r.playerCharacter)==null?void 0:Ae.id,characterTags:w()}):null},T=ne(()=>{if(!r.selectedHex||!r.playerTokenPosition)return null;if(r.selectedHex.q===r.playerTokenPosition.q&&r.selectedHex.r===r.playerTokenPosition.r)return 0;const C=Jn({q:r.playerTokenPosition.q,r:r.playerTokenPosition.r},{q:r.selectedHex.q,r:r.selectedHex.r},x,{});return C.found?C.totalCost:null}),y=ne(()=>{var C;return(C=r.selectedHex)!=null&&C.terrain?r.selectedHex.terrain.movementCost??1:1}),B=ne(()=>{const C=y.value;return C>=5?"stat-blocked":C>=3?"stat-hard":C>=2?"stat-medium":"stat-easy"}),m=ne(()=>{var C;return(C=r.selectedHex)!=null&&C.terrain?r.selectedHex.terrain.meleeAdvantage??0:0}),Y=ne(()=>{const C=m.value;return C>0?`+${C}`:C<0?`${C}`:"0"}),j=ne(()=>{const C=m.value;return C>0?"stat-bonus":C<0?"stat-penalty":"stat-neutral"}),F=ne(()=>{var C;return(C=r.selectedHex)!=null&&C.terrain?r.selectedHex.terrain.visibility??"open":"open"}),ie=ne(()=>({open:"Откр.",partial:"Част.",blocking:"Блок."})[F.value]||F.value),W=ne(()=>({open:"mdi:eye-outline",partial:"mdi:eye-off-outline",blocking:"mdi:eye-off"})[F.value]||"mdi:eye-outline"),S=ne(()=>({open:"stat-neutral",partial:"stat-medium",blocking:"stat-hard"})[F.value]||"stat-neutral");ne(()=>!(!r.selectedHex||r.selectedToken||!r.isPlayerTurn||!r.playerTokenPosition||r.selectedHex.q===r.playerTokenPosition.q&&r.selectedHex.r===r.playerTokenPosition.r||y.value>=5));const Z=ne(()=>r.isMaster||r.alwaysShowPlayer?!0:r.selectedHex&&!r.selectedToken?!1:r.selectedToken?r.playerCharacter?r.selectedToken.characterId===r.playerCharacter.id:!1:!0),K=ne(()=>r.alwaysShowPlayer?!1:r.selectedHex&&!r.selectedToken),X=ne(()=>{var C;return(C=r.selectedToken)!=null&&C.character?r.selectedToken.character:r.playerCharacter}),U=ne(()=>{var C,L;return((L=(C=X.value)==null?void 0:C.combat)==null?void 0:L.wounds)||{scratch:0,light:0,heavy:0,deadly:0}}),D=ne(()=>{var $e;if(!X.value)return null;const C=X.value.stats||{},L=(($e=X.value.combat)==null?void 0:$e.bonusDeadlySlots)||0;return Us(C,L)}),b=ne(()=>{var C;return(C=D.value)!=null&&C.scratch?D.value.scratch.base+D.value.scratch.bonus:0}),d=ne(()=>{var C;return(C=D.value)!=null&&C.light?D.value.light.base+D.value.light.bonus:0}),oe=ne(()=>{var C;return(C=D.value)!=null&&C.heavy?D.value.heavy.base+D.value.heavy.bonus:0}),he=ne(()=>{var C;return(C=D.value)!=null&&C.deadly?D.value.deadly.base+D.value.deadly.bonus:0}),M=C=>{if(C==null)return null;const L=Object.entries(ss).map(([Ae,Ee])=>({value:parseInt(Ae),...Ee})).filter(Ae=>Ae.value>=0).sort((Ae,Ee)=>Ae.value-Ee.value);let $e=L[0];for(const Ae of L)if(Ae.value<=C)$e=Ae;else break;return $e},de=(C,L,$e,Ae)=>{const Ee=(Ae-90)*Math.PI/180;return{x:C+$e*Math.cos(Ee),y:L+$e*Math.sin(Ee)}},H=(C,L,$e,Ae,Ee,Se,Be=0,He="left")=>{if(!Se)return;const Ne=Se.color||"#FFFFFF",ot=Se.linetype||"single";let We;He==="left"?We={top:0,upper:300,lower:240,bottom:180}:We={top:0,upper:60,lower:120,bottom:180};const ce=de(L,$e,Ae,We.top+Be),Je=de(L,$e,Ae,We.upper+Be),Ke=de(L,$e,Ae,We.lower+Be),xe=de(L,$e,Ae,We.bottom+Be);let Me,Pe;if(Ee==="front")Me=ce,Pe=Je;else if(Ee==="flank")Me=Je,Pe=Ke;else if(Ee==="back")Me=Ke,Pe=xe;else return;if(C.lineCap="butt",C.strokeStyle=Ne,ot==="dashed")C.setLineDash([4,5]),C.lineWidth=2,C.beginPath(),C.moveTo(Me.x,Me.y),C.lineTo(Pe.x,Pe.y),C.stroke(),C.setLineDash([]);else if(ot==="double"){C.lineWidth=2,C.beginPath(),C.moveTo(Me.x,Me.y),C.lineTo(Pe.x,Pe.y),C.stroke();const Re=Ae+3,ke=de(L,$e,Re,(Ee==="front"?We.top:Ee==="flank"?We.upper:We.lower)+Be),ge=de(L,$e,Re,(Ee==="front"?We.upper:Ee==="flank"?We.lower:We.bottom)+Be);C.setLineDash([4,5]),C.lineWidth=2,C.beginPath(),C.moveTo(ke.x,ke.y),C.lineTo(ge.x,ge.y),C.stroke(),C.setLineDash([])}else C.lineWidth=2,C.beginPath(),C.moveTo(Me.x,Me.y),C.lineTo(Pe.x,Pe.y),C.stroke()},z=(C,L,$e,Ae,Ee,Se,Be=0,He="left")=>{if(!Se)return;const Ne=Se.color||"#FFFFFF",ot=Se.linetype||"single";let We,ce;if(He==="left")if(Ee==="front")We=300,ce=360;else if(Ee==="flank")We=240,ce=300;else if(Ee==="back")We=180,ce=240;else return;else if(Ee==="front")We=0,ce=60;else if(Ee==="flank")We=60,ce=120;else if(Ee==="back")We=120,ce=180;else return;We+=Be,ce+=Be;const Je=(We-90)*Math.PI/180,Ke=(ce-90)*Math.PI/180;if(C.lineCap="butt",C.strokeStyle=Ne,ot==="dashed")C.setLineDash([4,5]),C.lineWidth=2,C.beginPath(),C.arc(L,$e,Ae,Je,Ke),C.stroke(),C.setLineDash([]);else if(ot==="double"){C.lineWidth=2,C.beginPath(),C.arc(L,$e,Ae,Je,Ke),C.stroke();const xe=Ae+3;C.setLineDash([4,5]),C.lineWidth=2,C.beginPath(),C.arc(L,$e,xe,Je,Ke),C.stroke(),C.setLineDash([])}else C.lineWidth=2,C.beginPath(),C.arc(L,$e,Ae,Je,Ke),C.stroke()},q=async()=>{var ae,Xe;const C=f.value;if(!C)return;const L=C.getContext("2d"),$e=Nn,Ae=$e/2,Ee=$e/2,Se=$e/2-30;L.clearRect(0,0,$e,$e);const Be=X.value;if(!Be){L.fillStyle="#1e293b",L.beginPath(),L.arc(Ae,Ee,Se,0,Math.PI*2),L.fill(),L.strokeStyle="rgba(255, 255, 255, 0.3)",L.lineWidth=2,L.stroke(),L.fillStyle="#64748b",L.font=`bold ${Se}px sans-serif`,L.textAlign="center",L.textBaseline="middle",L.fillText("?",Ae,Ee);return}const He=as(Be.portrait);He&&await fo(He);const Ne=U.value,ot=D.value;if(_n(L,Ae,Ee,Se,Be.portrait,Be.name,Ne,ot),Ne&&ot&&(tl(L,Ae,Ee,Se,Ne,ot),sl(L,Ae,Ee,Se,Ne,ot)),!Z.value)return;let We=(ae=r.selectedToken)==null?void 0:ae.meleeDefence,ce=(Xe=r.selectedToken)==null?void 0:Xe.rangedDefence;if(!We&&Be&&(We=gs(Be,"melee")),!ce&&Be&&(ce=gs(Be,"ranged")),!We&&!ce)return;const Je=o.maps.find(Ze=>Ze.id===o.activeMapId),xe=(Je==null?void 0:Je.orientation)==="pointy"?0:90,Me=(r.playerFacing||0)*30+xe,Pe=Se+14,Re=Pe+6,ke=["front","flank","back"],ge=["left","right"];if(We)for(const Ze of ge)for(const vt of ke){const te=We[vt];if(te!=null){const J=M(te);H(L,Ae,Ee,Pe,vt,J,Me,Ze)}}if(ce)for(const Ze of ge)for(const vt of ke){const te=ce[vt];if(te!=null){const J=M(te);z(L,Ae,Ee,Re,vt,J,Me,Ze)}}},Ie=()=>{r.collapsed&&c("toggle-collapse")};return Gt(()=>[r.selectedToken,r.playerCharacter,r.playerFacing,r.collapsed],async()=>{await fs(),r.collapsed||q()},{immediate:!0,deep:!0}),rs(async()=>{await fs(),r.collapsed||q()}),(C,L)=>{var $e,Ae,Ee,Se,Be,He;return s(),n("div",{class:Q(["mobile-info-card",{collapsed:t.collapsed,"own-token":Z.value}]),onClick:Ie},[t.collapsed?(s(),n("div",_f,[e("div",Tf,[($e=X.value)!=null&&$e.portrait?(s(),n("img",{key:0,src:i(as)(X.value.portrait),alt:X.value.name},null,8,If)):(s(),n("div",Sf,h(((Se=(Ee=(Ae=X.value)==null?void 0:Ae.name)==null?void 0:Ee.charAt(0))==null?void 0:Se.toUpperCase())||"?"),1))]),e("div",Ef,[e("span",Pf,h(((Be=X.value)==null?void 0:Be.name)||"Неизвестно"),1),Z.value?_("",!0):(s(),n("span",Mf,"нажмите для подробностей"))]),A(i(p),{icon:"mdi:chevron-up",class:"collapse-icon"})])):(s(),n("div",Df,[e("div",Bf,[e("button",{class:"collapse-btn",onClick:L[0]||(L[0]=lt(Ne=>C.$emit("toggle-collapse"),["stop"]))},[A(i(p),{icon:"mdi:chevron-down",class:"w-5 h-5"})]),e("span",Rf,h(((He=X.value)==null?void 0:He.name)||"Неизвестно"),1),!Z.value&&t.selectedToken?(s(),n("span",Ff,"Чужой")):_("",!0),Z.value?(s(),n("button",{key:1,class:"header-action-btn",onClick:L[1]||(L[1]=lt(Ne=>{var ot;return C.$emit("open-character-sheet",(ot=X.value)==null?void 0:ot.id)},["stop"]))},[A(i(p),{icon:"mdi:file-document-outline",class:"w-4 h-4"})])):_("",!0)]),e("div",Lf,[e("div",Nf,[e("canvas",{ref_key:"defenceCanvas",ref:f,width:Nn,height:Nn,class:"defence-canvas"},null,512)]),e("div",Of,[Z.value&&X.value?(s(),n("div",Hf,[e("div",qf,[L[2]||(L[2]=e("span",{class:"wound-label"},"Царапины:",-1)),e("div",Uf,[(s(!0),n(ee,null,me(b.value,Ne=>(s(),n("div",{key:"scratch-"+Ne,class:Q(["wound-slot scratch",{filled:Ne<=U.value.scratch}])},null,2))),128))])]),e("div",Wf,[L[3]||(L[3]=e("span",{class:"wound-label"},"Лёгкие:",-1)),e("div",zf,[(s(!0),n(ee,null,me(d.value,Ne=>(s(),n("div",{key:"light-"+Ne,class:Q(["wound-slot light",{filled:Ne<=U.value.light}])},null,2))),128))])]),e("div",Vf,[L[4]||(L[4]=e("span",{class:"wound-label"},"Тяжёлые:",-1)),e("div",Qf,[(s(!0),n(ee,null,me(oe.value,Ne=>(s(),n("div",{key:"heavy-"+Ne,class:Q(["wound-slot heavy",{filled:Ne<=U.value.heavy}])},null,2))),128))])]),e("div",jf,[L[5]||(L[5]=e("span",{class:"wound-label"},"Смерт.:",-1)),e("div",Gf,[(s(!0),n(ee,null,me(he.value,Ne=>(s(),n("div",{key:"deadly-"+Ne,class:Q(["wound-slot deadly",{filled:Ne<=U.value.deadly}])},null,2))),128))])])])):!Z.value&&!K.value&&X.value?(s(),n("div",Yf,[e("div",Xf,[A(i(p),{icon:"mdi:account",class:"w-4 h-4 text-slate-400"}),e("span",null,h(X.value.race||"Неизвестная раса"),1)]),e("div",Zf,[A(i(p),{icon:"mdi:sword",class:"w-4 h-4 text-slate-400"}),e("span",null,h(X.value.class||"Неизвестный класс"),1)])])):K.value?(s(),n("div",Jf,[e("div",Kf,[A(i(p),{icon:"mdi:map-marker",class:"w-4 h-4 text-slate-400"}),e("span",null,"Гекс "+h(t.selectedHex.q)+", "+h(t.selectedHex.r),1)]),t.selectedHex.terrain?(s(),n("div",eA,[A(i(p),{icon:"mdi:terrain",class:"w-4 h-4 text-slate-400"}),e("span",null,h(t.selectedHex.terrain.name||"Неизвестная местность"),1)])):_("",!0),t.selectedHex.terrain?(s(),n("div",tA,[e("div",{class:Q(["stat-item",B.value])},[A(i(p),{icon:"mdi:walk",class:"w-3.5 h-3.5"}),e("span",null,h(y.value),1)],2),e("div",{class:Q(["stat-item",j.value])},[A(i(p),{icon:"mdi:sword-cross",class:"w-3.5 h-3.5"}),e("span",null,h(Y.value),1)],2),e("div",{class:Q(["stat-item",S.value])},[A(i(p),{icon:W.value,class:"w-3.5 h-3.5"},null,8,["icon"]),e("span",null,h(ie.value),1)],2)])):_("",!0),T.value!==null?(s(),n("div",sA,[A(i(p),{icon:"mdi:run-fast",class:"w-4 h-4 text-sky-400"}),e("span",null,h(T.value)+" ОД",1)])):k.value!==null?(s(),n("div",nA,[A(i(p),{icon:"mdi:cancel",class:"w-4 h-4"}),L[6]||(L[6]=e("span",null,"Недоступно",-1))])):_("",!0)])):_("",!0)])])]))],2)}}},to=zt(lA,[["__scopeId","data-v-be8ce244"]]),oA={class:"portrait-image"},aA=["src","alt"],iA={key:1,class:"portrait-fallback"},rA={key:3,class:"death-overlay"},cA=["viewBox","width","height"],dA=["transform"],uA={key:0,class:"melee-defence"},mA=["d"],vA=["d"],fA=["d"],AA=["d"],pA=["d"],hA=["d"],gA={key:1,class:"ranged-defence"},yA=["d"],bA=["d"],kA=["d"],xA=["d"],wA=["d"],CA=["d"],$A=["viewBox","width","height"],_A=["d","stroke"],TA=["cx","cy","r","fill"],Ns=2,IA={__name:"CharacterPortrait",props:{portrait:{type:[String,Number],default:null},name:{type:String,default:""},combat:{type:Object,default:()=>({})},stats:{type:Object,default:()=>({})},meleeDefence:{type:Object,default:null},rangedDefence:{type:Object,default:null},defenceMode:{type:String,default:"all",validator:t=>["all","melee","ranged","none"].includes(t)},defenceLayout:{type:String,default:"left",validator:t=>["left","both"].includes(t)},defenceRotation:{type:Number,default:0},highlightSegment:{type:Object,default:null},showDefence:{type:Boolean,default:!1},size:{type:String,default:"md",validator:t=>["sm","md","lg","xl"].includes(t)},showWounds:{type:Boolean,default:!0}},setup(t){const l=t,o={sm:48,md:80,lg:120,xl:160},a=ne(()=>o[l.size]),r=ne(()=>{const z=l.portrait;return z?typeof z=="string"&&(z.startsWith("http://")||z.startsWith("https://")||z.startsWith("data:"))?z:Qa(z):null}),c=ne(()=>{var z;return((z=l.combat)==null?void 0:z.healthType)||"simple"}),f=ne(()=>{var z;return((z=l.combat)==null?void 0:z.wounds)||{scratch:0,light:0,heavy:0,deadly:0}}),k=ne(()=>{var z;return c.value!=="wounds"?null:Us(l.stats,((z=l.combat)==null?void 0:z.bonusDeadlySlots)||0)}),w=ne(()=>{if(!k.value)return[];const z=k.value.scratch.base+k.value.scratch.bonus,q=k.value.scratch.bonus,Ie=f.value.scratch;if(Ie===0)return[];const C=10,$e=(360-z*C)/z,Ee=180-(Ie*$e+(Ie-1)*C)/2,Se=[];for(let Be=0;Be<Ie;Be++){const He=Ee+Be*($e+C);Se.push({index:Be,startAngle:He,endAngle:He+$e,filled:!0,isBonus:Be<q})}return Se}),x=(z,q,Ie,C)=>{const L=a.value,$e=L/2,Ae=L/2,Ee=Ie,Se=(z-90)*Math.PI/180,Be=(q-90)*Math.PI/180,He=$e+Ee*Math.cos(Se),Ne=Ae+Ee*Math.sin(Se),ot=$e+Ee*Math.cos(Be),We=Ae+Ee*Math.sin(Be),ce=q-z>180?1:0;return`M ${He} ${Ne} A ${Ee} ${Ee} 0 ${ce} 1 ${ot} ${We}`},T=ne(()=>{if(!k.value)return[];const z=k.value.light.bonus,q=f.value.light;if(q===0)return[];const Ie=[],C=a.value,L=C*.08,$e=C/2,Ae=C/2,Ee=C/2,Se=25,He=90+(q-1)*Se/2;for(let Ne=0;Ne<q;Ne++){const We=(He-Ne*Se)*Math.PI/180;Ie.push({index:Ne,cx:Ae+$e*Math.cos(We),cy:Ee+$e*Math.sin(We),r:L,filled:!0,isBonus:Ne<z})}return Ie}),y=ne(()=>{if(!k.value)return 0;const z=k.value.heavy.base+k.value.heavy.bonus,q=f.value.heavy;return z===0||q===0?0:q/z*70}),B=ne(()=>{if(!k.value)return 0;const z=k.value.deadly.base+k.value.deadly.bonus,q=f.value.deadly;return z===0?0:q/z}),m=ne(()=>B.value>0),Y=ne(()=>B.value>=1),j=ne(()=>{var Ie,C;if(c.value!=="simple")return 100;const z=((Ie=l.combat)==null?void 0:Ie.hp)||0,q=((C=l.combat)==null?void 0:C.maxHp)||1;return z/q*100}),F=ne(()=>Math.max(0,100-j.value)*.7),ie=ne(()=>{var z,q;return((q=(z=l.name)==null?void 0:z.charAt(0))==null?void 0:q.toUpperCase())||"?"}),W=z=>{const q=Object.entries(ss.default||ss).map(([C,L])=>({value:parseInt(C),...L})).filter(C=>C.value>=0).sort((C,L)=>C.value-L.value);let Ie=q[0];for(const C of q)if(C.value<=z)Ie=C;else break;return Ie},S=z=>{if(!l.meleeDefence)return null;const q=l.meleeDefence[z];return q==null?null:W(q)},Z=z=>{if(!l.rangedDefence)return null;const q=l.rangedDefence[z];return q==null?null:W(q)},K=ne(()=>!l.showDefence||!l.meleeDefence||l.defenceMode==="none"||l.defenceMode==="ranged"?null:{front:S("front"),flank:S("flank"),back:S("back")}),X=ne(()=>!l.showDefence||!l.rangedDefence||l.defenceMode==="none"||l.defenceMode==="melee"?null:{front:Z("front"),flank:Z("flank"),back:Z("back")}),U=(z,q)=>l.highlightSegment?l.highlightSegment.type===z&&l.highlightSegment.direction===q:!1,D=ne(()=>l.highlightSegment!==null),b=ne(()=>{if(l.defenceRotation===0)return"";const z=a.value,q=de.value,Ie=z/2+q,C=z/2+q;return`rotate(${l.defenceRotation} ${Ie} ${C})`}),d=(z,q=0)=>{const Ie=a.value,C=de.value,L=Ie/2+C,$e=Ie/2+C,Ae=Ie/2+14+q,Ee=ot=>{const We=(ot-90)*Math.PI/180;return{x:L+Ae*Math.cos(We),y:$e+Ae*Math.sin(We)}},Se=Ee(0),Be=Ee(180),He=Ee(240),Ne=Ee(300);return z==="front"?`M ${Se.x} ${Se.y} L ${Ne.x} ${Ne.y}`:z==="flank"?`M ${Ne.x} ${Ne.y} L ${He.x} ${He.y}`:z==="back"?`M ${He.x} ${He.y} L ${Be.x} ${Be.y}`:""},oe=(z,q=0,Ie="left")=>{const C=a.value,L=de.value,$e=C/2+L,Ae=C/2+L,Se=C/2+14+8+q;let Be,He;if(Ie==="left")if(z==="front")Be=300,He=360;else if(z==="flank")Be=240,He=300;else if(z==="back")Be=180,He=240;else return"";else if(z==="front")Be=0,He=60;else if(z==="flank")Be=60,He=120;else if(z==="back")Be=120,He=180;else return"";const Ne=(Be-90)*Math.PI/180,ot=(He-90)*Math.PI/180,We=$e+Se*Math.cos(Ne),ce=Ae+Se*Math.sin(Ne),Je=$e+Se*Math.cos(ot),Ke=Ae+Se*Math.sin(ot);return`M ${We} ${ce} A ${Se} ${Se} 0 0 1 ${Je} ${Ke}`},he=z=>{if(!z)return{};const q=z.linetype||"single",C={stroke:z.color||"#FFFFFF","stroke-width":2,fill:"none","stroke-linecap":"butt"};return q==="dashed"?{...C,"stroke-dasharray":"4 3"}:C},M=z=>!z||z.linetype!=="double"?null:{stroke:z.color||"#FFFFFF","stroke-width":2,fill:"none","stroke-linecap":"butt","stroke-dasharray":"4 3"},de=ne(()=>l.showDefence?28:0),H=ne(()=>a.value+de.value*2);return(z,q)=>(s(),n("div",{class:Q(["character-portrait",[`size-${t.size}`,{dying:m.value,dead:Y.value,"with-defence":t.showDefence}]]),style:Qe({width:`${H.value}px`,height:`${H.value}px`})},[e("div",{class:"portrait-container",style:Qe({width:`${a.value}px`,height:`${a.value}px`,position:"absolute",top:`${de.value}px`,left:`${de.value}px`})},[e("div",oA,[t.portrait?(s(),n("img",{key:0,src:r.value,alt:t.name,class:"portrait-img",onError:q[0]||(q[0]=Ie=>Ie.target.style.display="none")},null,40,aA)):(s(),n("div",iA,h(ie.value),1))]),t.showWounds&&c.value==="wounds"&&y.value>0?(s(),n("div",{key:0,class:"heavy-overlay",style:Qe({height:`${y.value}%`})},null,4)):_("",!0),t.showWounds&&c.value==="simple"&&F.value>0?(s(),n("div",{key:1,class:"hp-damage-overlay",style:Qe({height:`${F.value}%`})},null,4)):_("",!0),t.showWounds&&m.value?(s(),n("div",{key:2,class:"deadly-overlay",style:Qe({opacity:B.value*.8})},null,4)):_("",!0),Y.value?(s(),n("div",rA,[...q[1]||(q[1]=[e("span",{class:"death-icon"},"💀",-1)])])):_("",!0)],4),t.showDefence&&(K.value||X.value)?(s(),n("svg",{key:0,class:"defence-overlay",viewBox:`0 0 ${H.value} ${H.value}`,width:H.value,height:H.value,style:{position:"absolute",top:"0",left:"0"}},[e("g",{transform:b.value},[K.value?(s(),n("g",uA,[!D.value||U("melee","front")?(s(),n(ee,{key:0},[K.value.front?(s(),n("path",Zt({key:0,d:d("front",0)},he(K.value.front)),null,16,mA)):_("",!0),M(K.value.front)?(s(),n("path",Zt({key:1,d:d("front",Ns)},M(K.value.front)),null,16,vA)):_("",!0)],64)):_("",!0),!D.value||U("melee","flank")?(s(),n(ee,{key:1},[K.value.flank?(s(),n("path",Zt({key:0,d:d("flank",0)},he(K.value.flank)),null,16,fA)):_("",!0),M(K.value.flank)?(s(),n("path",Zt({key:1,d:d("flank",Ns)},M(K.value.flank)),null,16,AA)):_("",!0)],64)):_("",!0),!D.value||U("melee","back")?(s(),n(ee,{key:2},[K.value.back?(s(),n("path",Zt({key:0,d:d("back",0)},he(K.value.back)),null,16,pA)):_("",!0),M(K.value.back)?(s(),n("path",Zt({key:1,d:d("back",Ns)},M(K.value.back)),null,16,hA)):_("",!0)],64)):_("",!0)])):_("",!0),X.value?(s(),n("g",gA,[!D.value||U("ranged","front")?(s(),n(ee,{key:0},[X.value.front?(s(),n("path",Zt({key:0,d:oe("front",0,t.defenceLayout)},he(X.value.front)),null,16,yA)):_("",!0),M(X.value.front)?(s(),n("path",Zt({key:1,d:oe("front",Ns,t.defenceLayout)},M(X.value.front)),null,16,bA)):_("",!0)],64)):_("",!0),!D.value||U("ranged","flank")?(s(),n(ee,{key:1},[X.value.flank?(s(),n("path",Zt({key:0,d:oe("flank",0,t.defenceLayout)},he(X.value.flank)),null,16,kA)):_("",!0),M(X.value.flank)?(s(),n("path",Zt({key:1,d:oe("flank",Ns,t.defenceLayout)},M(X.value.flank)),null,16,xA)):_("",!0)],64)):_("",!0),!D.value||U("ranged","back")?(s(),n(ee,{key:2},[X.value.back?(s(),n("path",Zt({key:0,d:oe("back",0,t.defenceLayout)},he(X.value.back)),null,16,wA)):_("",!0),M(X.value.back)?(s(),n("path",Zt({key:1,d:oe("back",Ns,t.defenceLayout)},M(X.value.back)),null,16,CA)):_("",!0)],64)):_("",!0)])):_("",!0)],8,dA)],8,cA)):_("",!0),t.showWounds?(s(),n("svg",{key:1,class:"wounds-overlay",viewBox:`0 0 ${a.value} ${a.value}`,width:a.value,height:a.value,style:Qe({position:"absolute",top:t.showDefence?`${de.value}px`:"0",left:t.showDefence?`${de.value}px`:"0",overflow:"visible"})},[(s(!0),n(ee,null,me(w.value,Ie=>(s(),n("path",{key:`scratch-${Ie.index}`,d:x(Ie.startAngle,Ie.endAngle,a.value/2-3),fill:"none",stroke:Ie.isBonus?"#a855f7":"#fbbf24","stroke-width":"3","stroke-linecap":"round",class:"scratch-arc filled"},null,8,_A))),128)),(s(!0),n(ee,null,me(T.value,Ie=>(s(),n("circle",{key:`light-${Ie.index}`,cx:Ie.cx,cy:Ie.cy,r:Ie.r,fill:Ie.isBonus?"#a855f7":"#ef4444",stroke:"#1f2937","stroke-width":"1.5",class:"light-dot filled"},null,8,TA))),128))],12,$A)):_("",!0)],6))}},Es=zt(IA,[["__scopeId","data-v-844a038f"]]),SA={key:0,class:"perspective-indicator"},EA={key:1,class:"perspective-bar"},PA={class:"perspective-options"},MA=["onClick"],DA={class:"perspective-avatar-wrapper"},BA={key:2,class:"offline-dot",title:"Оффлайн"},RA=["title"],FA={key:0,class:"master-tools-panel"},LA={class:"tools-header"},NA={class:"events-count"},OA={class:"tools-actions"},HA={class:"confirm-dialog"},qA={class:"confirm-icon"},UA={class:"confirm-text"},WA={class:"confirm-actions"},zA={key:2,class:"scene-image-inline"},VA=["src","alt"],QA={class:"scene-image-info"},jA={class:"scene-image-desc"},GA={key:0,class:"load-more-container"},YA={key:1,class:"empty-log"},XA={key:0,class:"battle-desc"},ZA={key:0,class:"delivery-grid"},JA=["onClick"],KA=["src"],ep={key:2,class:"face-placeholder"},tp={class:"face-tooltip"},sp={class:"tooltip-char"},np={class:"tooltip-player"},lp={key:0,class:"tooltip-offline"},op={class:"tooltip-status"},ap=["onClick"],ip={class:"fullwidth-desc"},rp={key:0,class:"delivery-grid"},cp=["onClick"],dp=["src"],up={key:2,class:"face-placeholder"},mp={key:0,class:"invite-used"},vp={key:1,class:"invite-portrait-placeholder"},fp={class:"invite-used-name"},Ap=["onClick"],pp={key:2,class:"invite-not-for-you"},hp={key:1,class:"invite-master-view"},gp={class:"invite-header"},yp={key:0,class:"invite-usages"},bp={key:1,class:"usage-portrait-placeholder"},kp={class:"usage-name"},xp={key:0,class:"delivery-grid"},wp=["title"],Cp=["src"],$p={key:2,class:"face-placeholder"},_p={key:3,class:"event-row"},Tp={class:"event-content"},Ip={key:0,class:"event-system"},Sp={key:1,class:"event-text-message"},Ep={class:"text-content"},Pp={class:"text-time"},Mp=["onClick"],Dp={class:"check-main"},Bp={class:"check-icon-wrapper"},Rp={key:0,class:"check-character"},Fp=["src","alt"],Lp={key:1,class:"character-initial"},Np={class:"check-difficulty"},Op={key:1,class:"check-result"},Hp={key:0,class:"result-label auto-success"},qp={key:1,class:"result-label auto-fail"},Up={key:0,class:"check-details"},Wp={class:"check-roll"},zp={key:0,class:"check-modifier"},Vp={class:"check-total"},Qp={class:"check-target"},jp={key:1,class:"check-desc"},Gp={key:3,class:"event-important-message"},Yp={class:"important-body"},Xp={class:"important-content"},Zp={class:"important-time"},Jp=["onClick"],Kp={class:"quest-header"},eh={class:"quest-title"},th={key:0,class:"quest-details"},sh={key:0,class:"quest-desc"},nh={key:1,class:"quest-objectives"},lh={key:5,class:"event-item-give"},oh={class:"item-content"},ah={class:"item-list"},ih={key:6,class:"event-item-loot"},rh={class:"loot-header"},ch={key:0,class:"loot-desc"},dh={class:"loot-items"},uh={class:"loot-item-name"},mh={key:0,class:"loot-claimed-by"},vh={key:1,class:"loot-claim-btn"},fh={key:7,class:"event-default"},Ah={key:0,class:"delivery-grid"},ph=["onClick"],hh=["src"],gh={key:2,class:"face-placeholder"},yh={class:"face-tooltip"},bh={class:"tooltip-char"},kh={class:"tooltip-player"},xh={key:0,class:"tooltip-offline"},wh={class:"tooltip-status"},Ch={__name:"SceneLog",emits:["go-to-battle","create-character","skill-check-clicked","view-image","hide-image"],setup(t,{emit:l}){const o=l,a=St(Zn,"sceneLog"),r=St(cs,"session"),c=St(on,"user"),f=St(ws,"characters"),{filteredEvents:k=R([]),paginatedEvents:w=R([]),hasMoreEvents:x=R(!1),remainingEventsCount:T=R(0),totalEventsCount:y=R(0),currentImage:B=R(null),hasActiveImage:m=R(!1),activeFilter:Y=R("all"),perspectiveUserId:j=R(null)}=Ut(a,"sceneLog"),{role:F=R("player"),connections:ie=R([])}=Ut(r,"session"),W=te=>!L.value||!j.value?!1:te.hiddenFrom&&te.hiddenFrom.includes(j.value),S=R(null),Z=R(!0),K=R(!0),X=R(!1),U=R(!1),D=R(new Set),b=()=>{a.downloadLog("trip-session-log"),X.value=!1},d=()=>{U.value=!0,X.value=!1},oe=()=>{a.clearAllEvents(),U.value=!1},he=()=>{U.value=!1},M=()=>{a.downloadLog("trip-session-log"),a.clearAllEvents(),U.value=!1},de=te=>{D.value.has(te)?D.value.delete(te):D.value.add(te)},H=te=>{const J=Yt.aspects.find(Te=>Te.id===te);return(J==null?void 0:J.checkIcon)||"mdi:dice-d20"},z=te=>{const J=Yt.aspects.find(Te=>Te.id===te);return(J==null?void 0:J.color)||"#f59e0b"},q=te=>{const J=ss[String(te)];return J?`${J.name} (${te})`:String(te)},Ie=te=>ss[String(te)]||{name:String(te),color:"#f59e0b"};rs(()=>{S.value&&setTimeout(()=>{S.value.scrollTop=S.value.scrollHeight},100)}),Gt(w,(te,J)=>{var $,P;const Te=te.length>0&&J.length>0&&(($=te[te.length-1])==null?void 0:$.id)!==((P=J[J.length-1])==null?void 0:P.id);Z.value&&S.value&&Te&&setTimeout(()=>{S.value.scrollTop=S.value.scrollHeight},50)},{deep:!0});const C=()=>{if(!S.value)return;const{scrollTop:te,scrollHeight:J,clientHeight:Te}=S.value;Z.value=J-te-Te<50},L=ne(()=>F.value==="master"),$e=ne(()=>{if(!L.value)return[];const te=[{id:null,name:"Все",avatar:null,online:!0}];return(r.allPlayers||[]).forEach(Te=>{te.push({id:Te.userId,name:Te.characterName||Te.alias||"Игрок",avatar:Te.characterPortrait||Te.avatar,online:Te.online})}),te}),Ae=te=>{a.setPerspective(te)},Ee=te=>new Date(te).toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"}),Se=te=>{var Te,$;if(!te)return{name:"Система",avatar:null,isMe:!1,isSystem:!0};if(te===c.userId)return{name:c.nickname||"Вы",avatar:c.avatar,isMe:!0};const J=(Te=r.connections)==null?void 0:Te.find(P=>P.userId===te);return J?{name:J.alias||"Игрок",avatar:J.avatar,isMe:!1}:(($=r.masterProfile)==null?void 0:$.userId)===te?{name:r.masterProfile.nickname||"Мастер",avatar:r.masterProfile.avatar,isMe:!1,isMaster:!0}:r.role==="master"?{name:c.nickname||"Мастер",avatar:c.avatar,isMe:!0,isMaster:!0}:{name:"Неизвестный",avatar:null,isMe:!1}},Be=()=>{const te=f.getCharactersByUserId(c.userId);return te.length>0?te[0]:null},He=te=>{if(!te)return null;const J=f.getCharactersByUserId(te);return J.length>0?J[0]:null},Ne=te=>{if(te.characterPortrait)return as(te.characterPortrait);const J=He(te.completedBy);return J!=null&&J.portrait?as(J.portrait):null},ot=te=>{const J=Yt.aspects.find(Te=>Te.id===te);return J?J.id:null},We=te=>{if(te.completed)return;const J=Be();if(!J){console.warn("Нет персонажа для броска");return}const Te=Math.floor(Math.random()*12)+1,$=ot(te.checkType),P=$?Kn(J,$):0,N=Te+P,Ge=N>=te.difficulty,rt={roll:Te,modifier:P,total:N,success:Ge,resultType:"normal",difficulty:te.difficulty};a.updateEvent(te.id,{completed:!0,result:rt,completedBy:c.userId,completedAt:Date.now(),characterName:J.name,characterPortrait:J.portrait||null}),r.sendToMaster({type:"skill-check-result",eventId:te.id,result:rt,characterName:J.name,characterPortrait:J.portrait||null}),o("skill-check-clicked",{...te,result:rt})},ce=()=>{o("go-to-battle")},Je=te=>{o("create-character",{constraints:te.constraints||{},inviteId:te.id})},Ke=te=>({[tt.TEXT]:"mdi:message-text",[tt.SYSTEM]:"mdi:information",[tt.SKILL_CHECK]:"mdi:dice-d20",[tt.SKILL_RESULT]:"mdi:check-circle",[tt.BATTLE_INVITE]:"mdi:sword-cross",[tt.ATTACK_RESULT]:"mdi:sword",[tt.DAMAGE]:"mdi:heart-broken",[tt.IMAGE]:"mdi:image",[tt.IMPORTANT]:"mdi:alert-circle",[tt.QUEST]:"mdi:map-marker-star",[tt.ITEM_GIVE]:"mdi:gift",[tt.ITEM_TAKE]:"mdi:hand-back-left",[tt.ITEM_LOOT]:"mdi:treasure-chest",[tt.CHARACTER_INVITE]:"mdi:account-plus"})[te]||"mdi:circle",xe=te=>({[tt.TEXT]:"#94a3b8",[tt.SYSTEM]:"#64748b",[tt.SKILL_CHECK]:"#f59e0b",[tt.SKILL_RESULT]:"#10b981",[tt.BATTLE_INVITE]:"#ef4444",[tt.ATTACK_RESULT]:"#ef4444",[tt.DAMAGE]:"#dc2626",[tt.IMAGE]:"#8b5cf6",[tt.IMPORTANT]:"#f59e0b",[tt.QUEST]:"#eab308",[tt.ITEM_GIVE]:"#22c55e",[tt.ITEM_TAKE]:"#f97316",[tt.ITEM_LOOT]:"#a855f7",[tt.CHARACTER_INVITE]:"#3b82f6"})[te]||"#94a3b8",Me=te=>{var J;return te.type===tt.SKILL_CHECK&&!te.completed?te.targetUserIds===null?!0:Array.isArray(te.targetUserIds)?te.targetUserIds.includes(c.userId):te.targetUserId==="all"||te.targetUserId===c.userId:te.type===tt.BATTLE_INVITE?te.targetUserIds===null?!0:Array.isArray(te.targetUserIds)?te.targetUserIds.includes(c.userId):!1:te.type===tt.CHARACTER_INVITE?((J=te.usedBy)==null?void 0:J.some($=>$.userId===c.userId))?!1:te.targetUserIds===null?!0:Array.isArray(te.targetUserIds)?te.targetUserIds.includes(c.userId):te.targetUserId==="all"||te.targetUserId===c.userId:te.type===tt.ITEM_GIVE&&!te.accepted?te.targetUserId===c.userId:te.type===tt.ITEM_LOOT?te.items.some(Te=>!Te.claimedBy):!1},Pe=te=>{var J;return(J=te.usedBy)==null?void 0:J.some(Te=>Te.userId===c.userId)},Re=te=>{var Te;return((Te=te.usedBy)==null?void 0:Te.find($=>$.userId===c.userId))||null},ke=te=>L.value?(r.allPlayers||[]).map(Te=>{var N,Ge;if(!(te.targetUserIds===null||Array.isArray(te.targetUserIds)&&te.targetUserIds.includes(Te.userId)))return null;const P=(N=te.usedBy)==null?void 0:N.find(rt=>rt.userId===Te.userId);return{userId:Te.userId,alias:Te.alias,avatar:Te.avatar,online:Te.online,delivered:((Ge=te.deliveredTo)==null?void 0:Ge.includes(Te.userId))||!1,used:!!P,createdCharacter:P?{id:P.characterId,name:P.characterName,portrait:P.characterPortrait}:null}}).filter(Boolean):[],ge=te=>L.value?(f.allPlayerCharacters||[]).map(Te=>{var Et,At,dt,$t;const $=!te.targetCharacterIds||te.targetCharacterIds===null||te.targetCharacterIds.includes(Te.id),P=(Et=r.connections)==null?void 0:Et.find(re=>re.userId===Te.ownerId),N=((At=P==null?void 0:P.conn)==null?void 0:At.open)||!1,Ge=((dt=te.deliveredTo)==null?void 0:dt.includes(Te.ownerId))||!1,rt=(($t=te.hiddenFrom)==null?void 0:$t.includes(Te.ownerId))||!1,ft=Te.portrait?as(Te.portrait):null;return{characterId:Te.id,characterName:Te.name,characterPortrait:ft,ownerId:Te.ownerId,ownerName:Te.ownerNickname||(P==null?void 0:P.alias)||"Игрок",online:N,targeted:$,delivered:Ge,hidden:rt}}).filter(Te=>Te.targeted):[],ae=(te,J,Te)=>{L.value&&(J.hidden?Ze(te,J.ownerId,!0):J.delivered?Ze(te,J.ownerId,!1):Te?vt(te,J.ownerId):Xe(te,J.ownerId))},Xe=(te,J)=>{if(!L.value)return;const Te=te.hiddenFrom||[];Te.includes(J)||a.updateEvent(te.id,{hiddenFrom:[...Te,J]})},Ze=(te,J,Te)=>{var Ge,rt;if(!L.value)return;const $=te.hiddenFrom||[],P=te.deliveredTo||[],N=r.connections.find(ft=>ft.userId===J);if(Te){const ft=$.filter(At=>At!==J),Et=P.includes(J)?P:[...P,J];a.updateEvent(te.id,{hiddenFrom:ft,deliveredTo:Et}),(Ge=N==null?void 0:N.conn)!=null&&Ge.open&&N.conn.send({type:"scene-event",event:{...te,hiddenFrom:ft,deliveredTo:Et}})}else $.includes(J)||a.updateEvent(te.id,{hiddenFrom:[...$,J]}),(rt=N==null?void 0:N.conn)!=null&&rt.open&&N.conn.send({type:"scene-event-hide",eventId:te.id})},vt=(te,J)=>{var $;if(!L.value)return;const Te=r.connections.find(P=>P.userId===J);if(($=Te==null?void 0:Te.conn)!=null&&$.open){Te.conn.send({type:"scene-event",event:te});const P=te.deliveredTo||[];P.includes(J)||a.updateEvent(te.id,{deliveredTo:[...P,J]})}};return(te,J)=>{var Te;return s(),n("div",{class:Q(["scene-log",{"perspective-mode":L.value&&i(j)}])},[L.value&&i(j)?(s(),n("div",SA,[A(i(p),{icon:"mdi:eye"}),e("span",null,[J[5]||(J[5]=Ce("Просмотр от: ",-1)),e("strong",null,h((Te=$e.value.find($=>$.id===i(j)))==null?void 0:Te.name),1)]),e("button",{class:"exit-perspective-btn",onClick:J[0]||(J[0]=$=>Ae(null))},[A(i(p),{icon:"mdi:close"}),J[6]||(J[6]=Ce(" Выйти ",-1))])])):_("",!0),L.value&&$e.value.length>1?(s(),n("div",EA,[J[7]||(J[7]=e("span",{class:"perspective-label"},"Глазами:",-1)),e("div",PA,[(s(!0),n(ee,null,me($e.value,$=>(s(),n("button",{key:$.id||"all",class:Q(["perspective-btn",{active:i(j)===$.id,offline:$.id&&!$.online}]),onClick:P=>Ae($.id)},[e("div",DA,[$.avatar?(s(),st(Os,{key:0,avatar:$.avatar,size:"xs"},null,8,["avatar"])):(s(),st(i(p),{key:1,icon:"mdi:account-group",class:"all-icon"})),$.id&&!$.online?(s(),n("span",BA)):_("",!0)]),e("span",null,h($.name),1)],10,MA))),128))]),e("button",{class:Q(["delivery-toggle-btn",{active:K.value}]),onClick:J[1]||(J[1]=$=>K.value=!K.value),title:K.value?"Скрыть статусы доставки":"Показать статусы доставки"},[A(i(p),{icon:K.value?"mdi:account-check":"mdi:account-off"},null,8,["icon"])],10,RA),e("button",{class:Q(["log-tools-btn",{active:X.value}]),onClick:J[2]||(J[2]=$=>X.value=!X.value),title:"Инструменты лога"},[A(i(p),{icon:"mdi:cog"})],2)])):_("",!0),A(Ps,{name:"slide-down"},{default:ys(()=>[L.value&&X.value?(s(),n("div",FA,[e("div",LA,[J[8]||(J[8]=e("span",{class:"tools-title"},"Управление логом",-1)),e("span",NA,h(i(y))+" событий",1)]),e("div",OA,[e("button",{class:"tool-btn",onClick:b,title:"Экспортировать лог в JSON"},[A(i(p),{icon:"mdi:download"}),J[9]||(J[9]=e("span",null,"Экспорт",-1))]),e("button",{class:"tool-btn tool-btn-danger",onClick:d,title:"Очистить лог"},[A(i(p),{icon:"mdi:delete-outline"}),J[10]||(J[10]=e("span",null,"Очистить",-1))])])])):_("",!0)]),_:1}),(s(),st(Vt,{to:"body"},[A(Ps,{name:"fade"},{default:ys(()=>[U.value?(s(),n("div",{key:0,class:"confirm-overlay",onClick:lt(he,["self"])},[e("div",HA,[e("div",qA,[A(i(p),{icon:"mdi:alert-circle"})]),J[15]||(J[15]=e("h3",{class:"confirm-title"},"Очистить лог?",-1)),e("p",UA,[J[11]||(J[11]=Ce(" Будет удалено ",-1)),e("strong",null,h(i(y)),1),J[12]||(J[12]=Ce(" событий. Это действие нельзя отменить. ",-1))]),e("div",WA,[e("button",{class:"confirm-btn confirm-btn-secondary",onClick:he}," Отмена "),e("button",{class:"confirm-btn confirm-btn-primary",onClick:M},[A(i(p),{icon:"mdi:download"}),J[13]||(J[13]=Ce(" Сохранить и очистить ",-1))]),e("button",{class:"confirm-btn confirm-btn-danger",onClick:oe},[A(i(p),{icon:"mdi:delete"}),J[14]||(J[14]=Ce(" Очистить ",-1))])])])])):_("",!0)]),_:1})])),L.value&&i(m)&&i(B)?(s(),n("div",zA,[e("img",{src:i(B).url,alt:i(B).description,class:"scene-image-preview"},null,8,VA),e("div",QA,[e("span",jA,h(i(B).description||"Изображение сцены"),1),e("button",{class:"hide-image-btn",onClick:J[3]||(J[3]=$=>o("hide-image")),title:"Скрыть изображение"},[A(i(p),{icon:"mdi:eye-off"})])])])):_("",!0),e("div",{ref_key:"logContainerRef",ref:S,class:"events-log",onScroll:C},[i(x)?(s(),n("div",GA,[e("button",{class:"load-more-btn",onClick:J[4]||(J[4]=$=>i(a).loadMoreEvents())},[A(i(p),{icon:"mdi:history"}),e("span",null,"Загрузить ещё ("+h(i(T))+")",1)])])):_("",!0),i(w).length===0?(s(),n("div",YA,[A(i(p),{icon:"mdi:book-open-variant",class:"empty-icon"}),J[16]||(J[16]=e("p",null,"История событий пуста",-1)),J[17]||(J[17]=e("p",{class:"empty-hint"},"Здесь будут отображаться события игры",-1))])):_("",!0),A(aa,{name:"event-list",tag:"div",class:"events-list"},{default:ys(()=>[(s(!0),n(ee,null,me(i(w),$=>{var P,N,Ge,rt,ft,Et,At,dt,$t;return s(),n("div",{key:$.id,class:Q(["event-item",[`event-${$.type}`,{interactive:Me($),"hidden-for-perspective":W($)}]]),style:Qe({"--event-color":xe($.type)})},[$.type===i(tt).BATTLE_INVITE?(s(),n("div",{key:0,class:Q(["event-row",{"event-row-fullwidth":!L.value}])},[e("div",{class:Q(["event-content",{"event-content-fullwidth":!L.value}])},[e("div",{class:"event-battle",onClick:lt(ce,["stop"])},[J[18]||(J[18]=e("div",{class:"battle-lines"},null,-1)),A(i(p),{icon:"mdi:sword-cross",class:"battle-icon"}),J[19]||(J[19]=e("div",{class:"battle-lines"},null,-1))]),$.description?(s(),n("p",XA,h($.description),1)):_("",!0)],2),L.value&&K.value?(s(),n("div",ZA,[(s(!0),n(ee,null,me(ge($),re=>(s(),n("div",{key:re.characterId,class:Q(["delivery-face",{delivered:re.delivered&&!re.hidden,"is-hidden":re.hidden&&re.delivered,"pre-hidden":re.hidden&&!re.delivered,pending:!re.delivered&&!re.hidden,offline:!re.online}]),onClick:lt(ye=>ae($,re,ye.shiftKey),["stop"])},[re.characterPortrait?(s(),n("img",{key:0,src:re.characterPortrait,class:"face-img"},null,8,KA)):re.avatar?(s(),st(Os,{key:1,avatar:re.avatar,size:"sm",class:"face-avatar"},null,8,["avatar"])):(s(),n("div",ep,h((re.characterName||re.name||"?")[0].toUpperCase()),1)),e("div",tp,[e("div",sp,h(re.characterName||"Без персонажа"),1),e("div",np,"Игрок: "+h(re.ownerName),1),re.online?_("",!0):(s(),n("div",lp,"офлайн")),e("div",op,[re.hidden&&re.delivered?(s(),n(ee,{key:0},[Ce("Скрыто • Клик: показать")],64)):re.hidden&&!re.delivered?(s(),n(ee,{key:1},[Ce("Будет скрыто • Клик: отмена")],64)):re.delivered?(s(),n(ee,{key:2},[Ce("Доставлено • Клик: скрыть")],64)):(s(),n(ee,{key:3},[Ce("Ожидает • Клик: скрыть, Shift: отправить")],64))])])],10,JA))),128))])):_("",!0)],2)):$.type===i(tt).IMAGE?(s(),n("div",{key:1,class:Q(["event-row",{"event-row-fullwidth":!L.value}])},[e("div",{class:Q(["event-content",{"event-content-fullwidth":!L.value}])},[e("div",{class:Q(["event-fullwidth-action",{viewing:((P=i(B))==null?void 0:P.url)===$.url}]),onClick:lt(re=>{var ye;return((ye=i(B))==null?void 0:ye.url)===$.url?o("hide-image",$):o("view-image",$)},["stop"])},[J[20]||(J[20]=e("div",{class:"fullwidth-lines"},null,-1)),A(i(p),{icon:((N=i(B))==null?void 0:N.url)===$.url?"mdi:eye-off":"mdi:image",class:"fullwidth-icon"},null,8,["icon"]),J[21]||(J[21]=e("div",{class:"fullwidth-lines"},null,-1))],10,ap),e("p",ip,h($.description||"Изображение"),1)],2),L.value&&K.value?(s(),n("div",rp,[(s(!0),n(ee,null,me(ge($),re=>(s(),n("div",{key:re.characterId,class:Q(["delivery-face",{delivered:re.delivered&&!re.hidden,"is-hidden":re.hidden&&re.delivered,"pre-hidden":re.hidden&&!re.delivered,pending:!re.delivered&&!re.hidden,offline:!re.online}]),onClick:lt(ye=>ae($,re,ye.shiftKey),["stop"])},[re.characterPortrait?(s(),n("img",{key:0,src:re.characterPortrait,class:"face-img"},null,8,dp)):re.avatar?(s(),st(Os,{key:1,avatar:re.avatar,size:"sm",class:"face-avatar"},null,8,["avatar"])):(s(),n("div",up,h((re.characterName||re.name||"?")[0].toUpperCase()),1))],10,cp))),128))])):_("",!0)],2)):$.type===i(tt).CHARACTER_INVITE?(s(),n("div",{key:2,class:Q(["event-row event-row-invite",{"event-row-fullwidth":!L.value}])},[e("div",{class:Q(["event-content",{"event-content-fullwidth":!L.value}])},[L.value?(s(),n("div",hp,[e("div",gp,[A(i(p),{icon:"mdi:account-plus",class:"invite-header-icon"}),J[26]||(J[26]=e("span",null,"Приглашение создать персонажа",-1))]),$.usedBy&&$.usedBy.length>0?(s(),n("div",yp,[(s(!0),n(ee,null,me($.usedBy,re=>(s(),n("div",{key:re.characterId,class:"invite-usage"},[re.characterPortrait?(s(),st(Es,{key:0,portrait:re.characterPortrait,size:32,showBorder:!0,class:"usage-portrait"},null,8,["portrait"])):(s(),n("div",bp,h((re.characterName||"?")[0].toUpperCase()),1)),e("span",kp,h(re.characterName),1)]))),128))])):_("",!0)])):(s(),n(ee,{key:0},[Pe($)?(s(),n("div",mp,[(Ge=Re($))!=null&&Ge.characterPortrait?(s(),st(Es,{key:0,portrait:Re($).characterPortrait,size:48,showBorder:!0,class:"invite-portrait"},null,8,["portrait"])):(s(),n("div",vp,h((((rt=Re($))==null?void 0:rt.characterName)||"?")[0].toUpperCase()),1)),e("span",fp,h(((ft=Re($))==null?void 0:ft.characterName)||"Персонаж создан"),1)])):Me($)?(s(),n(ee,{key:1},[e("div",{class:"event-fullwidth-action",onClick:lt(re=>Je($),["stop"])},[J[22]||(J[22]=e("div",{class:"fullwidth-lines blue"},null,-1)),A(i(p),{icon:"mdi:account-plus",class:"fullwidth-icon blue"}),J[23]||(J[23]=e("div",{class:"fullwidth-lines blue"},null,-1))],8,Ap),J[24]||(J[24]=e("p",{class:"fullwidth-desc"},"Создайте персонажа!",-1))],64)):(s(),n("div",pp,[A(i(p),{icon:"mdi:account-plus-outline",class:"invite-icon-disabled"}),J[25]||(J[25]=e("span",null,"Приглашение не для вас",-1))]))],64))],2),L.value&&K.value?(s(),n("div",xp,[(s(!0),n(ee,null,me(ke($),re=>{var ye,pe;return s(),n("div",{key:re.userId,class:Q(["delivery-face",{delivered:re.delivered&&!re.used,used:re.used,pending:!re.delivered&&!re.used,offline:!re.online}]),title:re.used?`${re.alias}: ${(ye=re.createdCharacter)==null?void 0:ye.name}`:re.alias},[re.used&&((pe=re.createdCharacter)!=null&&pe.portrait)?(s(),n("img",{key:0,src:i(as)(re.createdCharacter.portrait),class:"face-img"},null,8,Cp)):re.avatar?(s(),st(Os,{key:1,avatar:re.avatar,size:"sm",class:"face-avatar"},null,8,["avatar"])):(s(),n("div",$p,h((re.alias||"?")[0].toUpperCase()),1))],10,wp)}),128))])):_("",!0)],2)):(s(),n("div",_p,[e("div",Tp,[$.type===i(tt).SYSTEM?(s(),n("div",Ip,[A(i(p),{icon:Ke($.type),class:"event-icon"},null,8,["icon"]),e("span",null,h($.text),1)])):$.type===i(tt).TEXT?(s(),n("div",Sp,[e("p",Ep,h($.text),1),e("span",Pp,h(Ee($.time)),1)])):$.type===i(tt).SKILL_CHECK?(s(),n("div",{key:2,class:Q(["event-check",{success:$.completed&&((Et=$.result)==null?void 0:Et.success),failure:$.completed&&$.result&&!$.result.success,"auto-success":((At=$.result)==null?void 0:At.resultType)==="guaranteed-success","auto-failure":((dt=$.result)==null?void 0:dt.resultType)==="guaranteed-fail"}]),style:Qe({"--aspect-color":z($.checkType),"--diff-color":Ie($.difficulty).color}),onClick:lt(re=>Me($)&&We($),["stop"])},[e("div",Dp,[e("div",Bp,[A(i(p),{icon:H($.checkType),class:"check-type-icon"},null,8,["icon"])]),$.completed&&(Ne($)||$.characterName)?(s(),n("div",Rp,[Ne($)?(s(),n("img",{key:0,src:Ne($),alt:$.characterName,class:"character-portrait"},null,8,Fp)):(s(),n("div",Lp,h(($.characterName||"?")[0].toUpperCase()),1))])):_("",!0),e("div",Np,h(q($.difficulty)),1),$.completed&&$.result?(s(),n("div",Op,[$.result.resultType==="guaranteed-success"?(s(),n("span",Hp,"Автоуспех")):$.result.resultType==="guaranteed-fail"?(s(),n("span",qp,"Автопровал")):(s(),n("span",{key:2,class:Q(["result-label",$.result.success?"success":"fail"])},h($.result.success?"Успех":"Провал"),3))])):_("",!0)]),$.completed&&$.result&&$.result.resultType==="normal"?(s(),n("div",Up,[e("span",Wp,h($.result.roll),1),$.result.modifier!==0?(s(),n("span",zp,h($.result.modifier>=0?"+":"")+h($.result.modifier),1)):_("",!0),J[27]||(J[27]=e("span",{class:"check-equals"},"=",-1)),e("span",Vp,h($.result.total),1),J[28]||(J[28]=e("span",{class:"check-vs"},"vs",-1)),e("span",Qp,h($.result.difficulty),1)])):_("",!0),$.description?(s(),n("p",jp,h($.description),1)):_("",!0)],14,Mp)):$.type===i(tt).IMPORTANT?(s(),n("div",Gp,[A(i(p),{icon:$.icon||"mdi:alert-circle",class:"important-icon"},null,8,["icon"]),e("div",Yp,[e("p",Xp,h($.text),1),e("span",Zp,h(Ee($.time)),1)])])):$.type===i(tt).QUEST?(s(),n("div",{key:4,class:"quest-container",onClick:lt(re=>de($.id),["stop"])},[e("div",Kp,[A(i(p),{icon:"mdi:map-marker-star",class:"quest-icon"}),e("span",eh,h($.title),1),A(i(p),{icon:D.value.has($.id)?"mdi:chevron-up":"mdi:chevron-down",class:"quest-chevron"},null,8,["icon"])]),D.value.has($.id)?(s(),n("div",th,[$.description?(s(),n("p",sh,h($.description),1)):_("",!0),($t=$.objectives)!=null&&$t.length?(s(),n("ul",nh,[(s(!0),n(ee,null,me($.objectives,(re,ye)=>(s(),n("li",{key:ye,class:Q({completed:re.completed})},[A(i(p),{icon:re.completed?"mdi:checkbox-marked-circle":"mdi:checkbox-blank-circle-outline"},null,8,["icon"]),Ce(" "+h(re.text),1)],2))),128))])):_("",!0)])):_("",!0)],8,Jp)):$.type===i(tt).ITEM_GIVE?(s(),n("div",lh,[A(i(p),{icon:"mdi:gift",class:"item-icon"}),e("div",oh,[J[29]||(J[29]=e("span",{class:"item-label"},"Получен предмет:",-1)),e("div",ah,[(s(!0),n(ee,null,me($.items,re=>(s(),n("span",{key:re.id,class:"item-badge"},[Ce(h(re.name)+" ",1),re.quantity>1?(s(),n(ee,{key:0},[Ce("x"+h(re.quantity),1)],64)):_("",!0)]))),128))])])])):$.type===i(tt).ITEM_LOOT?(s(),n("div",ih,[e("div",rh,[A(i(p),{icon:"mdi:treasure-chest",class:"loot-icon"}),J[30]||(J[30]=e("span",{class:"loot-title"},"Найден лут!",-1))]),$.description?(s(),n("p",ch,h($.description),1)):_("",!0),e("div",dh,[(s(!0),n(ee,null,me($.items,re=>(s(),n("div",{key:re.id,class:Q(["loot-item",{claimed:re.claimedBy}])},[e("span",uh,h(re.name),1),re.claimedBy?(s(),n("span",mh,h(Se(re.claimedBy).name),1)):(s(),n("button",vh,"Взять"))],2))),128))])])):(s(),n("div",fh,[A(i(p),{icon:Ke($.type),class:"event-icon"},null,8,["icon"]),e("span",null,h($.text||$.description||"Событие"),1)]))]),L.value&&K.value?(s(),n("div",Ah,[(s(!0),n(ee,null,me(ge($),re=>(s(),n("div",{key:re.characterId,class:Q(["delivery-face",{delivered:re.delivered&&!re.hidden,"is-hidden":re.hidden&&re.delivered,"pre-hidden":re.hidden&&!re.delivered,pending:!re.delivered&&!re.hidden,offline:!re.online}]),onClick:lt(ye=>ae($,re,ye.shiftKey),["stop"])},[re.characterPortrait?(s(),n("img",{key:0,src:re.characterPortrait,class:"face-img"},null,8,hh)):re.avatar?(s(),st(Os,{key:1,avatar:re.avatar,size:"sm",class:"face-avatar"},null,8,["avatar"])):(s(),n("div",gh,h((re.characterName||re.name||"?")[0].toUpperCase()),1)),e("div",yh,[e("div",bh,h(re.characterName||"Без персонажа"),1),e("div",kh,"Игрок: "+h(re.ownerName),1),re.online?_("",!0):(s(),n("div",xh,"офлайн")),e("div",wh,[re.hidden&&re.delivered?(s(),n(ee,{key:0},[Ce("Скрыто • Клик: показать")],64)):re.hidden&&!re.delivered?(s(),n(ee,{key:1},[Ce("Будет скрыто • Клик: отмена")],64)):re.delivered?(s(),n(ee,{key:2},[Ce("Доставлено • Клик: скрыть")],64)):(s(),n(ee,{key:3},[Ce("Ожидает • Клик: скрыть, Shift: отправить")],64))])])],10,ph))),128))])):_("",!0)]))],6)}),128))]),_:1})],544)],2)}}},so=zt(Ch,[["__scopeId","data-v-4bec0af1"]]),$h=[{id:"scholar",name:{m:"Учёный",f:"Учёная"},nameEn:"Scholar",professions:[],aspects:["knowledge","nature"],traits:[{id:"knowNature",name:"Знание природы",levels:[{text:`:check:nature 1:easier
 Все проверки Поиска для Вас на одну категорию проще.`,effect:{}},{text:`2:check:nature в :turn
Вы можете выполнить две проверки Поиска вместо одной за каждый ход.`,effect:{}},{text:`2:check в :turn, :check:nature 2:easier
Вы можете выполнить любые две проверки одного типа вместо одной за каждый ход. Проверки Поиска проще на две категории`,effect:{}}]},{id:"knowEnemy",name:"Знание врага",levels:[{text:`:attack 1:easier если Вы ранили
Любые атаки по противникам, которых Вам уже удалось ранить - на одну категорию проще.`,effect:{}},{text:`:defence 1:easier если уже отражали
Если Вы успешно отбили удар противника, Ваша защита против него повышается на одну категорию, пока вы дееспособны`,effect:{}},{text:`:attack :defence 1:easier, если видели как ранят или защищаются от атак противника
Вам достаточно видеть как другие ранят противника или успешно отражают его удары, чтобы адаптироваться к ним и получить преимущества.`,effect:{}}]},{id:"constructor",name:"Конструктор",levels:[{text:"Вы получаете преимущество в две категории на создание предметов с помощью немагических ремёсел. В этот список входят самодельное оружие и доспехи, эликсиры и яды, особые боеприпасы, но не ловушки. Для создания Вам всё ещё нужен рецепт достаточного качества.",effect:{}},{text:"Вы можете подбирать рецепты самостоятельно, ориентируясь на найденные слухи и общеизвестную информацию. Для этого Вам нужно провести проверку Поиска или Влияния, если это уместно в данной ситуации",effect:{}},{text:"Вы можете сами создавать рецепты, изучая природные материалы. Проведя успешную проверку Поиска Вы можете узнать о свойствах того или иного материала и придумать ему применение. Проверка на первое создание предмета тем проще, чем более реалистичный у вас план. На усмотрение мастера",effect:{}}]}],edges:[{type:"aspect",id:"knowledge",cost:3},{type:"aspect",id:"nature",cost:3}]},{id:"mastermind",name:{m:"Комбинатор",f:"Комбинаторша"},nameEn:"Mastermind",professions:[],aspects:["shadow","community"],traits:[{id:"ambushMaster",name:"Засадный мастер",levels:[{text:"Вы можете подготовить хорошее место для засады, если потратите на это некоторое время. Противнику будет сложнее Вас обнаружить на две категории, а в случае успеха в первый ход все Ваши герои атакуют и защищаются на две категории эффективнее.",effect:{}},{text:"Если вы отражаете атаку, Вы можете пройти проверку Влияния (против разумных) или  Поиска (против зверей и монстров), чтобы симулировать тяжёлое ранение или даже смерть. Если Ваш обман не раскрыт, Вы можете получить преимущество в две категории на атаку, если наносите неожиданный удар в полную мощь.",effect:{}},{text:"Вы можете провести проверку Влияния (против разумных) или Поиска (против зверей и монстров), чтобы инициировать ложное отступление. Сложность её будет тем больше, чем меньше у Вас понятных врагу причин для отступления, на усмотрение мастера. В случае успеха Вы должны отходить назад один ход, увлекая противника за собой, а затем обрушиться на него снова, получая преимущества как от засады.",effect:{}}]},{id:"criminalSchemes",name:"Преступные схемы",levels:[{text:"Потратив не менее месяца на подготовку, Вы можете организовать серьёзное преступление в поселении. Это может быть кража, похищение или убийство влиятельного лица. Сложность проверки определяет мастер исходя из степени реалистичности Вашего плана. Вы можете отказаться от реализации плана, когда мастер объявил сложность. Выполнить задуманное нелегко, ещё сложнее - не попасться после.  Вероятность того, что кто-то выйдет на Ваш след, зависит от превышения проверки.",effect:{}},{text:"Потратив не менее месяца на подготовку, Вы можете инициировать войну между разными фракциями в пределах одного поселения. Потратив не менее трёх месяцев - глобальную вражду между глобальными фракциями, не менее шести - войну. Формат войны или вражды может быть разным, в зависимости от сути фракций, например, купеческие гильдии будут враждовать совсем не так, как гильдии воров. Ваши преступные планы на две категории эффективнее, если затрагивают интересы воюющих.",effect:{}},{text:"Проведя полгода в поселении, вы можете подчинить себе все его преступные организации, при этом оставаясь в тени. Они не знают Вас в лицо и не будут подчиняться напрямую, но дёргая за правильные ниточки Вы можете заставлять их делать то, что нужно Вам. Все проверки Влияния удаются Вам проще на три категории, а уровень Вашего влияния на эти организации не может опускаться ниже Крепкой Дружбы",effect:{}}]},{id:"noDistinctiveFeatures",name:"Без особых примет",levels:[{text:"Вы умеете затеряться в толпе, знаете толк в маскировке в поселениях разумных. Искать Вас сложнее на две категории, если Вы только не хотите быть найденным. Иначе - на две категории проще.",effect:{}},{text:"Ваше умение скрываться с глаз оказывается полезным и на поле боя. Вы умеете быть неприметным и не угрожающим. Если противник собирается атаковать Вас, когда имеет возможность бить по Вашему союзнику, Вы можете пройти проверку Влияния, чтобы переключить его внимание. На это не требуется никаких действий, Вы можете сделать это сколько угодно раз за ход, но каждая следующая проверка будет сложнее.",effect:{}},{text:"Если Вам удаётся переключить внимание противника на своего союзника - вы можете нанести неожиданную атаку по нему в самый неподходящий момент. Такая атака стоит один порыв, и может быть усилена, но выполняется только один раз за ход.",effect:{}}]}],edges:[{type:"aspect",id:"shadow",cost:2},{type:"aspect",id:"community",cost:4}]},{id:"weaponmaster",name:{m:"Оружейник",f:"Оружейница"},nameEn:"Weaponmaster",professions:[],aspects:["war","knowledge"],traits:[{id:"steelShines",name:"И сталь блестит",levels:[{text:"Вы знаете толк в боевом снаряжении и со всей скурпулёзностью подходите к его выбору. Ваша броня или один из наборов вооружения качественнее на целую категорию.",effect:{}},{text:"Прежде чем стать популярным, более эффективное оружие появляется на рынке в малом количестве. Используя свои связи (не менее 4 уровня) и деньги (не менее 7 уровня), Вы можете найти такие редкие образцы и пополнить свою коллекцию. Теперь более высоким качеством могут отличаться два набора вооружения, или один набор и броня.",effect:{}},{text:"Если вы привыкаете к оружию не менее месяца, необходимое превышение защиты за каждый вид травмы сокращается на единицу (мин 1). Кроме того, Вы можете использовать особые удары экзотического оружия без штрафов. Одновременно вы можете таким образом привыкнуть только к трём наборам снаряжения. ",effect:{}}]},{id:"mySword",name:"Таких мечей много, но этот - мой",levels:[{text:"Если Вы организуете что-то, связанное с оружием или вооружёнными людьми, Ваши проверки Порядка легче на две категории (6). Нанимать и вооружать отряд наёмников для Вас дешевле на одну категорию.",effect:{}},{text:"Вооружённые с Вашей помощью отряды защищаются и атакуют эффективнее на одну категорию.",effect:{}},{text:"Если Ваши товарищи по команде прислушиваются к Вашим советам, каждый может сделать один набор оружия или свою броню более эффективными (на одну категорию). На этом уровне Вы также получаете такое преимущество.",effect:{}}]},{id:"worthMoreThanGold",name:"Дороже золота",levels:[{text:"Оружие даёт силу, а сила - власть. Попадая в новые сообщества Вы сразу получаете как минимум Небольшое Влияние на воинское и дворянское сословие, если готовы демонстрировать своё превосходное снаряжение.",effect:{}},{text:"Внешний вид Вашего снаряжения заставляет нанимателей задуматься о цене за Ваши услуги. Если Вашему заказчику это по карману, он предложит на одну категорию более высокую оплату. Если нет - он и вовсе не станет предлагать Вам работу.",effect:{}},{text:"Раз в три месяца Вы можете купить действительно очень редкое оружие, совершив покупку не менее чем 7 уровня богатства. Такую редкость с удовольствием купят любые коллекционеры, вполне вероятно - даже короли и императоры.",effect:{}}]}],edges:[{type:"aspect",id:"war",cost:2},{type:"aspect",id:"knowledge",cost:4}]},{id:"tactician",name:{m:"Тактик",f:"Тактичка"},nameEn:"Tactician",professions:[],aspects:["war","knowledge"],traits:[{id:"holdOn",name:"Держись!",levels:[{text:"За один ход Вы можете помочь союзнику советом два раза, а не один. Кроме того, Ваши советы могут увеличить не только защиту, но и нападение. Ваши советы должны быть реалистичны, иначе мастер может решить, что они не принесут пользу.",effect:{}},{text:"Стоящие плечом к плечу с Вами товарищи атакуют и защищаются на одну категорию эффективнее, но это преимущество не складывается с эффектом от вербальной помощи.",effect:{}},{text:"Вы можете помочь союзнику трижды за один ход, эффект суммируется с преимуществом от второго уровня этого умения.",effect:{}}]},{id:"officerCourses",name:"Офицерские курсы",levels:[{text:"Вы можете невзначай демонстрировать свои познания в тактике в разговоре, если хотите этого. Все Ваши проверки Влияния на невраждебных разумных-воинов эффективнее на две категории.",effect:{}},{text:"Вам проще находить грамотных командиров, все нанятые Вами воины атакуют и защищаются эффективнее на одну категорию.",effect:{}},{text:"Ваша слава идёт впереди Вас, больше хороших бойцов хотят служить под Вашим началом, меньше дураков готовы на Вас напасть. Проверки Влияния на поиск бойцов легче на две категории, проверки организации диверсий и нападений на Вас на две категории сложнее",effect:{}}]},{id:"artOfWar",name:"Искусство войны",levels:[{text:"Война требует денег, денег и ещё раз денег. А ещё, бизнес здорово похож на войну. Ваши проверки Порядка и Диверсии на одну категории проще, если они касаются организации прибыльной компании или борьбы с конкурентами.",effect:{}},{text:"Какой бы важной не была тактика, она не может обойтись без стратегии. Проверки Поиска и Влияния на одну категорию проще, если касаются исследования рынков или стратегических позиций противника.",effect:{}},{text:"Проверки Порядка, Диверсии, Поиска и Влияния первых двух уровней умения становятся проще не на одну, а на три категории.",effect:{}}]}],edges:[{type:"aspect",id:"war",cost:4},{type:"aspect",id:"knowledge",cost:2}]},{id:"monk",name:{m:"Монах",f:"Монахиня"},nameEn:"Monk",professions:[],aspects:["war","mysticism"],traits:[{id:"martialArts",name:"Боевые искусства",levels:[{text:"Ваша скорость передвижения увеличивается на 2, а рукопашные атаки без оружия становятся эффективнее на одну категорию. Кроме того, Ваша защита в ближнем бою повышается на одну категорию, а в дальнем - на две. Эти бонусы работают только в том случае, если Вы носите броню не тяжелее лёгкой. ",effect:{}},{text:"Вы больше не получаете штрафов к защите сбоку. Ваши сокрушительные удары без оружия - всегда точные. ",effect:{}},{text:"Бой для вас - особая форма транса, вы умудряетесь замечать всё происходящее вокруг. Вы больше не получаете штрафов к защите сзади, а также можете реагировать на происходящее за своей спиной. Ваши безоружные атаки становятся эффективнее ещё на одну категорию, а ваши тяжёлые удары оружием ближнего боя становятся всегда точными.",effect:{}}]},{id:"bastionOfSpirit",name:"Бастион духа",levels:[{text:"Боевые искусства - не просто способ убрать врага со своей дороги. Для Вас - это способ обратиться к себе, познать мир через себя, а себя - через мир вокруг. Вы должны проводить не менее 10 часов в неделю в изнуряющих тренировках, но в результате Вы чувствуете происходящее вокруг невероятно тонко. Любые проверки Диверсии на две категории проще, если Вы участвуете в них лично.",effect:{}},{text:"Вы должны тратить на тренировки не менее 20 часов в неделю, но Ваша потребность в сне значительно сократилась. Теперь Вы высыпаетесь всего за 6 часов в сутки. Проверки Порядка проще на одну категорию, если Вы участвуете в них лично.",effect:{}},{text:"Ваше тело - всего лишь продолжение Вашей несгибаемой воли. Вам больше не нужно спать, но Вы должны проводить не меньше 4х часов в сутки в медитациях, поддерживающих Ваш дух. Пока Вам удаётся выполнять это условие, Вам нужно вдвое меньше припасов для выживания, Ваши раны кровоточат вдвое меньше, а ранить Ваше тело значительно сложнее. Ваш класс брони увеличивается на 1.",effect:{}}]},{id:"innerCalm",name:"Внутреннее спокойствие",levels:[{text:"Вам одинаково просто выживать в дикой природе, в суетливом городе или горном додзё. Однако внешний мир Вам не особенно интересен. Ваш уровень знания немагической местности не может быть ниже 4х, но выше этого значения растёт вдвое медленнее обычного.",effect:{}},{text:"Ваш путь боевых искусств провёл Вас через множество стран и регионов - Ваши проверки Влияния на впервые встреченных незнакомцев на две категории легче.",effect:{}},{text:"Ваше паранормальное предчувствие опасности позволяет точно знать, когда Вас держат на прицеле, а иногда и заранее знать, что кто-то замыслил недоброе. Это предчувствие иногда может давать ложноположительный результат.",effect:{}}]}],edges:[{type:"aspect",id:"war",cost:3},{type:"aspect",id:"mysticism",cost:3}]},{id:"commander",name:{m:"Командир",f:"Командирша"},nameEn:"Commander",professions:[],aspects:["war","community"],traits:[{id:"followMe",name:"За мной!",levels:[{text:"Перед боем командир может повысить мораль союзных бойцов ниже или равных по рангу на 3 единицы, если успешно пройдёт проверку Влияния или на 1, если провалит её.",effect:{}},{text:"Вербальная команда командира во время боя поднимает мораль бойца на единицу, а так же позволяет один ход игнорировать негативные последствия тяжёлой травмы.",effect:{}},{text:"Потратив основное действие во время боя, командир может повысить мораль всех способных его слышать бойцов на 2 единицы, снизить мораль всех разумных бойцов противника на 2 единицы. ",effect:{}}]},{id:"allInOrder",name:"Всё по порядку",levels:[{text:"Составить хороший план - половина успеха. Ваши проверки Порядка на одну категорию легче.",effect:{}},{text:"Мало составить план - нужно ещё и ему следовать. Ваши проверки Порядка на две категории проще, если Вы выполняете работу самостоятельно или с проверенными исполнителями, с которыми Вам уже доводилось работать раньше.",effect:{}},{text:"Вы умеете составлять чёткие исчерпывающие инструкции, такие, чтобы по ним выполнить работу смогла и обезьяна. Ваши проверки Порядка легче на две категории, если исполнителями на месте руководит выбранный Вами смышлёный человек. Этот бонус работает и если вы руководите лично.",effect:{}}]},{id:"togetherStronger",name:"Вместе сильнее",levels:[{text:"Если несколько персонажей думают над решением одной проблемы и готовы доверить Вам руководство, Вы можете сделать так, чтобы проверку проходил персонаж с самой высокой характеристикой, а бонусы учитывались от персонажа с самыми высокими бонусами.",effect:{}},{text:"Если это проверка Войны, Порядка или Влияния, Вы так же можете облегчить её ещё на одну категорию.",effect:{}},{text:"Для любых проверок Вы можете сложить все бонусы всех участников, однако полученное преимущество не должно быть больше чем в два раза большим, чем самый большой бонус.",effect:{}}]}],edges:[{type:"aspect",id:"war",cost:3},{type:"aspect",id:"community",cost:3}]},{id:"ranger",name:{m:"Следопыт",f:"Следопытка"},nameEn:"Ranger",professions:[],aspects:["war","nature"],traits:[{id:"bloodyTrail",name:"По кровавому следу",levels:[{text:"Вы не уличный задира, Вы - профессиональный убийца. Вы выслеживаете свою цель и наносите удар издалека. Проверки Поиска на категорию легче, если вы ищете живое существо. Первый удар по не подозревающей о Вас цели эффективнее дополнительно на две категории, но это не должен быть удар с соседней клетки.",effect:{}},{text:"Ваши атаки по не подозревающему о Вашем присутствии противнику - всегда считаются точными, если Вы успели изучить его по следам или наблюдая в течении хотя бы одной минуты.",effect:{}},{text:"Ваши дальние атаки (даже через одну клетку) эффективнее на одну категорию даже по обнаружившим Вас противникам, если Вы успели изучить их по следам. Ваша защита в ближнем и дальнем бою против них так же выше на категорию.",effect:{}}]},{id:"likeHome",name:"Как у себя дома",levels:[{text:"Если Ваше знание местности хотя бы 5, обнаружить Вас сложнее на одну категорию.",effect:{}},{text:"Если Ваше знание местности хотя бы 5, обнаружить весь Ваш отряд сложнее на одну категорию. Это касается как попыток спрятаться в засаде, так и передвижения по глобальной карте.",effect:{}},{text:"Ваше мастерство скрытности достигло своего апогея. Если Вы знаете местность хотя бы до уровня 3, Вы можете скрыть себя с дополнительной сложностью в три категории, или весь отряд - со сложностью в две. Кроме того, Ваш первый удар по не подозревающему о Вашем присутствии врагу получает дополнительный бонус в одну категорию",effect:{}}]},{id:"secretPaths",name:"Тайные тропы",levels:[{text:"Вы знаете, как выбирать дорогу, чтобы меньше уставать и больше успевать. Ваша скорость передвижения по глобальной карте увеличена на два. Вы значительно эффективнее обнаруживаете другие отряды неподалёку, на две категории. ",effect:{}},{text:"С Вашей помощью весь отряд может двигаться по глобальной карте быстрее на единицу. Если Вы прокладываете маршрут движения какого-нибудь отряда, он оказывается на одну категорию безопаснее.",effect:{}},{text:"Ваши проверки Диверсии против отрядов, движущихся по дикой местности, эффективнее на две категории. Маршруты, проложенные Вами на две категории безопаснее.",effect:{}}]}],edges:[{type:"aspect",id:"war",cost:2},{type:"aspect",id:"nature",cost:4}]},{id:"hunter",name:{m:"Охотник",f:"Охотница"},nameEn:"Hunter",professions:[],aspects:["war","nature"],traits:[{id:"catchTheHunter",name:"На ловца",levels:[{text:"Вопреки расхожему мифу, рыцарь в латах и на коне не сумеет одолеть дракона. А вот хорошо подготовленный охотник - сможет. Вы очень хороши в бою против зверей и монстров из крови и плоти - атака и защита эффективнее на одну категорию.",effect:{}},{text:"Кое-что из Ваших навыков прекрасно работает и на разумных. Ваши ловушки на одну категорию эффективнее, а кровотечение спровоцированное Вашими атаками, вдвое тяжелее.",effect:{}},{text:"В бою против зверей и монстров, с которыми Вы уже сталкивались раньше, Ваша атака и защита эффективнее на две категории.",effect:{}}]},{id:"battleTrophies",name:"Боевые трофеи",levels:[{text:"Если Ваш уровень знания местности хотя бы 4, Вы можете собирать одну меру немагических полезных ингредиентов из тел живущих в ней животных в месяц. Для этого Вам нужно найти подходящее место и остановиться в нём. Вы также можете извлекать обычные ингредиенты из поверженных в бою монстров",effect:{}},{text:"Вы можете собирать редкие ингредиенты, тратя на это всё своё время или обычные - прямо на ходу. Из побеждённых в бою Вы можете извлекать обычные или редкие ингредиенты",effect:{}},{text:"Вы можете собирать даже магические материалы из монстров, которых победили в бою или на которых охотились.",effect:{}}]},{id:"startYearAgo",name:"Начинаем год назад",levels:[{text:"Хорошая подготовка - ключ к успешной охоте. Имея большой опыт в вещах такого рода, Вы можете неплохо организовывать и другие дела. Проверки Порядка проще на одну категорию, если они хоть как-то связаны с пребыванием в дикой местности.",effect:{}},{text:"Что будет, если Ваши конкуретны забудут палатку? Проверки Диверсии так же проще на одну категорию, если связаны с пребыванием Вашей цели в дикой местности.",effect:{}},{text:"Ваше снаряжениие подобрано так хорошо, что Вы можете использовать его исключительно быстро. Полным действием в бою Вы можете подготовить ловушку, это может быть заранее подготовленный капкан на медведя или некая импровизация на месте. В случае импровизации, вы будете проходить проверку Порядка, сложность которой зависит от реалистичности Вашей задумки.",effect:{}}]}],edges:[{type:"aspect",id:"war",cost:4},{type:"aspect",id:"nature",cost:2}]},{id:"druid",name:{m:"Друид",f:"Друидка"},nameEn:"Druid",professions:[],aspects:["nature","mysticism"],traits:[{id:"oneAmongBeasts",name:"Свой среди зверей",levels:[{text:"Вы умеете вести себя так, чтобы не провоцировать диких животных. Они нападут на Вас только по исключительной причине, например, умирая от голода или защищая своё потомство. Проверки Поиска связанные со зверьми для вас на одну категорию проще.",effect:{}},{text:"Звери рассматривают Вас как доброго приятеля. Драться на Вашей стороне они, конечно, не станут, но могут предупредить о приближающейся опасности. Ваш отряд на одну категорию сложнее обнаружить, а Вы обнаруживаете другие на одну проще",effect:{}},{text:"Вы учитесь гораздо лучше понимать, что пытаются Вам сказать наши братья меньшие. Ваши проверки Поиска в местности, где есть звери на две категории эффективнее. Сообщения от зверей мастер теперь передаёт Вам как короткие предложения из двух-трёх простых слов.",effect:{}}]},{id:"forestSpirits",name:"Духи леса",levels:[{text:"Ежедневно жертвуя духам местности, в которой Вы находитесь, нечто ценное (обычно подходят съестные припасы) за одну неделю Вы можете наладить с ними контакт. Если духи благоволят Вам, один раз за боевую сцену (или один раз в месяц вне боя), Вы можете пройти проверку автоматически, если это возможно хотя бы при каком-то значении на кубике.",effect:{}},{text:"Регулярно жертвуя духам местности нечто ценное (отлично подойдут ценные материалы) Вы можете расположить их к себе ещё больше. Проверка, которую Вы видите, может получить максимум или минимум на кубиках по Вашему желанию. Это умение можно применить один раз за бой или раз в месяц в небоевых сценах.",effect:{}},{text:"Регулярно жертвуя духам местности магические ингредиенты или артефакты (не менее месяца), Вы достигаете максимального расположения с их стороны. Они могут самостоятельно помогать Вам как посчитают нужным, будь это подсказки или помощь в бою.",effect:{}}]},{id:"likeAFish",name:"Как рыба в воде",levels:[{text:"Вы чувствуете присутствие крупных зверей на расстоянии в сотню метров. Ваши проверки Поиска в отношении зверей проще на три категории.",effect:{}},{text:"Монстры - совершенно чуждые природе существа. Земля стонет и плачет там, где они ходят по ней. Вы слышите этот плач издалека, за несколько километров определяя направление до ближайшего монстра. Проверки Поиска в отношении монстров на две категории проще.",effect:{}},{text:"Магия вплетена в природу, но всё же выделяется на фоне всего остального ярким пятном. Вы чувствуете магические артефакты и ингредиенты, находящиеся в дикой природе за несколько километров. Поиск таких предметов проще на три категории, но имейте ввиду - духи местности могут разозлиться на Вас, если Вы заберёте что-то ценное.",effect:{}}]}],edges:[{type:"aspect",id:"nature",cost:2},{type:"aspect",id:"mysticism",cost:4}]},{id:"outlaw",name:{m:"Беглец",f:"Беглянка"},nameEn:"Outlaw",professions:[],aspects:["shadow","nature"],traits:[{id:"shepherdOfBlackSheep",name:"Пастух паршивых овец",levels:[{text:"В любом обществе есть те, кто промышляет тёмными делишками. Вы легко определяете таких, сложность проверки ниже на две категории.",effect:{}},{text:"Вы можете не только успешно определять криминальные элементы, но ещё и ловить их на горячем. Чтобы затем шантажировать. Ваши проверки Влияния на них на две категории эффективнее.",effect:{}},{text:"Вы безошибочно определяете тёмных дельцов, воров, взяточников в любом обществе, проведя с ними в разговоре хотя бы несколько минут. Размеры взяток для Вас снижены на две категории. Пройдя дополнительную проверку, Вы можете разгадать схему, в которой кто-то замешан.",effect:{}}]},{id:"constantlyLookingBack",name:"Постоянно оглядываясь",levels:[{text:"Вы так долго скрывались от властей, что теперь чувствуете себя гораздо лучше вне поселений. Скорость изучения местности удвоена вплоть до уровня 4, если это не магическая местность.",effect:{}},{text:"Уходить от погони - сильнейший из Ваших талантов. Если Вас преследуют, (в бою или на стратегической карте) Ваша скорость передвижения увеличивается на два.",effect:{}},{text:"Проведя в поселении хотя бы месяц, Вы узнаёте обо всех тайных ходах, не закрытых от простых людей или криминальных элементов. Если это поселение около границы другого государства, Вы также узнаёте как проникнуть туда незамеченным.",effect:{}}]},{id:"withoutStopping",name:"Не останавливаясь",levels:[{text:"Вы учитесь атаковать на бегу, не разворачиваясь. Для Вас возможны атаки вбок с штрафом эффективности в одну категорию.",effect:{}},{text:"От привычки не так легко избавиться. Если Ваши атаки наносят хотя бы лёгкую травму, они снижают скорость передвижения противника на одну клетку длительностью на два хода. Если только Вы явно не захотите обратного.",effect:{}},{text:"Вы можете атаковать назад не разворачиваясь со штрафом в одну категорию, или вбок - без штрафа. Кроме того, Ваша защита с тыла становится сильнее на одну категорию.",effect:{}}]}],edges:[{type:"aspect",id:"shadow",cost:3},{type:"aspect",id:"nature",cost:3}]},{id:"warlock",name:{m:"Колдун",f:"Колдунья"},nameEn:"Warlock",professions:[],aspects:["mysticism","shadow"],traits:[{id:"bloodMagic",name:"Магия крови",levels:[{text:"Вы получаете связь первого уровня с Концептом Жизнь, если ещё не имели её. Ваше особое умение - направлять магическую энергию по крови, которую Вы сумели получить от цели. Касты, направленные таким образом, слабее на два уровня, но не слабее Быстрого. Кровь, изьятая из организма, имеет связь с телом несколько часов.",effect:{}},{text:"Вы можете жертвовать собственную кровь для усиления магического эффекта - это наносит царапину при результате на кубике 10-12, лёгкую травму в иных случаях. Сила каста вырастает на один уровень.",effect:{}},{text:"Вы учитесь лучше чувствовать связь Крови, теперь магические эффекты, передаваемые через неё, слабее всего на один уровень, а если Вы прикладываете небольшие усилия, образец крови может оставаться связанным с целью сколь угодно долго. Одновременно Вы можете держать у себя не больше трёх таких образцов, но если не сумеете укрепить связь в какой-нибудь день, она будет разрушена.",effect:{}}]},{id:"myOtherHalf",name:"Половинка меня",levels:[{text:"Вам удаётся сделать невероятное - оторвать от своей души небольшой кусок, да ещё так, чтобы он не развалился при этом. Получилось нечто живое, отдельное от Вас и в то же время являющееся Вами. Вы вселили это в животное, получив, таким образом, фамильяра. Небольшой зверёк на Ваш выбор подчиняется Вашей воле, но главное - Вы можете направлять любые касты из той точки, где находится он. Помните, что любые энергии Порядка изгоняют духа, а чтобы вселить его в новое тело, Вам нужно потратить как минимум один день. В случае полного разрушения духовной сущности, Вы получаете травму уровня смертельного ранения и должны потратить не менее недели, чтобы повторить свой опыт.",effect:{}},{text:"Ваш дух-фамильяр становится значительно сильнее. Животное-носитель больше не является живым - скорее немёртвым. Остановить его физическим оружием можно, но убить - нельзя. Теперь Вы можете проводить энергии Порядка через фамильяра, но эффекты будут на один уровень слабее. Кроме того, теперь духа нельзя изгнать энергией порядка ниже уровнем, чем Средний каст. Вы можете общаться телепатически с фамильяром, когда он меньше чем в 1000 метров от Вас.",effect:{}},{text:"Дух становится всё сильнее, как и Ваша с ним связь. Вы можете общаться с ним телепатически на любом расстоянии (в пределах одного мира), а в пределах 1000 метров - ещё и ощущать мир его органами чувств. Вселение духа в животное больше не занимает у Вас много времени - достаточно нескольких минут. Любые энергии каста теперь передаются без потерь. В случае полного разрушения духовной сущности фамильяра, вы больше не получите урона.",effect:{}}]},{id:"deadWater",name:"Мёртвая вода",levels:[{text:"Вы учитесь заключать некоторые магические эффекты в специальных отварах. Потратив час времени и немного как минимум редких ингредиентов, Вы можете выполнить каст и при успехе, заключить его действие в магическом отваре. Энергия сохранится в нём ещё одни сутки, а затем развеется. Ваш отвар - всегда яд, производить что-то кроме яда Вы ещё не научились. Чтобы он подействовал в полной мере, цель должна его проглотить - а внесённый в кровь вместе с ударом оружия яд подействует на уровень слабее. Сила эффектов, которые может вместить Ваш отвар ограничена уровнем Малого каста.",effect:{}},{text:'Вы можете заключать более мощные магические эффекты в отварах, теперь они ограничены уровнем до Среднего каста. Кроме того, теперь Вы можете добавлять дополнительные эффекты, кроме урона, но они должны быть слабее основного, а сделать зелье с "умным" эффектом любого рода не получится - оно не привязано к разуму применяющего, потому всегда имеет нулевой контроль и нулевую самостоятельность.',effect:{}},{text:"Ваши зелья теперь могут вмещать эффект вплоть до уровня Большого каста, гораздо более долговечны - могут прожить до недели, а периодически подновляя магию в них, Вы можете держать их рабочими сколь угодно долго (до 9 зелий, 3 шт каждого из 3х типов).Теперь дополнительные эффекты могут оказываться сильнее вредоносного, но как минимум царапину Ваш яд всегда должен наносить.",effect:{}}]}],edges:[{type:"aspect",id:"mysticism",cost:2},{type:"aspect",id:"shadow",cost:4}]},{id:"specialist",name:{m:"Мастер",f:"Мастерица"},nameEn:"Specialist",professions:[],aspects:["community","knowledge"],traits:[{id:"fasterAndHigher",name:"Быстрее и выше",levels:[{text:"Вы копаете глубоко и не останавливаетесь на достигнутом. И это даёт свои плоды - в любом ремесле, распространённом в обществе, Вы преуспеваете больше других. Работая по любой профессии, не связанной с Мистикой, Вы можете заработать на один уровень богатства больше. Кроме того, все проверки Порядка для Вас на одну категорию проще.",effect:{}},{text:"Хороших профессионалов ценят. Ваши проверки Влияния на категорию проще, а искать специалистов в какой-то области - проще на две.",effect:{}},{text:"Занимаясь своим ремеслом, Вы можете заработать на две категории больше богатства больше, чем другие. Ваши проверки Влияния на две категории эффективнее, если Вы проработали по профессии в этом поселении хотя бы месяц.",effect:{}}]},{id:"allOnShelves",name:"Всё по полочкам",levels:[{text:"Вы бы не смогли достичь таких высот в своих ремёслах, если бы не анализировали и не систематизировали всё. Все проверки Порядка на одну категорию проще, если они связаны с освоенным Вами ремеслом - на две.",effect:{}},{text:"Вы можете осваивать новые профессии и ремёсла гораздо быстрее остальных - всего за месяц обучения Вы достигаете уровня среднего специалиста. Ремесло в таком случае считается усвоенным. Вам всё ещё не доступны профессии, связанные с мистикой.",effect:{}},{text:"Даже мистические профессии теперь доступны Вам, однако Вы должны потратить втрое больше времени, чтобы разобраться в них. Освоив совершенно новую для себя профессию, Вы получите одно очко развития.",effect:{}}]},{id:"almostChess",name:"Почти шахматы",levels:[{text:"Потратив основное действие в бою, Вы можете попробовать разгадать тактический замысел противника, если он есть. Это проверка Порядка или Диверсии, на Ваш выбор. Если проверка пройдена успешно, мастер раскрывает Вам суть задумки, а Вы и Ваши товарищи получают преимущество в атаке и защите в одну категорию на следующий раунд боя.",effect:{}},{text:"Проанализировав как минимум три взаимодействия с враждебными силами, Вы можете попробовать разгадать стратегический замысел противника. Это проверка Порядка или Диверсии на Ваш выбор, сложность тем больше, чем меньше Ваш персонаж узнал предварительно. В случае успеха Вы получаете преимущество в две категории на все проверки (кроме боя) в отношении этой фракции на месяц",effect:{}},{text:"Преимущество, которое Вы получаете от первых двух уровней этого умения, длится вдвое дольше. Кроме того, если Вы прошли изначальную проверку (Порядка или Диверсии), Вы можете предложить план, как помешать врагу и пройти другую (Диверсии для Порядка или наоборот), чтобы удвоить и силу Вашего преимущества. Сложность проверки выставляет мастер ориентируясь на реалистичность Вашего плана.",effect:{}}]}],edges:[{type:"aspect",id:"community",cost:2},{type:"aspect",id:"knowledge",cost:4}]},{id:"skald",name:{m:"Скальд",f:"Скальдесса"},nameEn:"Skald",professions:[],aspects:["community","knowledge"],traits:[{id:"knowATale",name:"Знаю сказ, который начинался...",levels:[{text:"Ничто не ново в этом мире, и Вы, как хранитель легенд ушедших эпох, знаете это лучше других. В любой ситуации Вы можете попробовать пройти проверку Порядка, чтобы вспомнить, не было ли уже на свете подобной ситуации. Проверка тем сложнее, чем более необычный пример Вы пытаетесь вспомнить, но если она пройдена, Вы можете поделиться поучительной историей из прошлого с другими, облегчая следующую проверку (свою или чужую) на две категории. Вы можете упрощать подобным образом только проверки Конфликта, Порядка или Влияния.",effect:{}},{text:"Многие баллады сложены о героизме или о любви, но не стоит забывать и тёмные сказки, которые народ тоже исправно хранит в своей памяти. Теперь Вы можете усиливать этим умением и проверки Диверсии, Защиты и Поиска. Кроме того, раз в месяц Вы можете усилить свою проверку, не затрачивая хода.",effect:{}},{text:"Вам не составляет труда вывернуть любую историю так, чтобы она выставляла Вас в выгодном свете. Ваши собственные проверки Влияния всегда проще на две категории, а Репутация Вашей группы с любыми невраждебными фракциями всегда как минимум 2 (Небольшое Влияние)",effect:{}}]},{id:"ourLastAndDecisive",name:"Наш последний и решительный",levels:[{text:"Жизнь жестока и вопрос не в том, выживешь ли ты. Только в том, каким тебя запомнят. Те, кто дерётся с Вами плечом к плечу понимают, что каждый бой - их шанс занять своё место в героической легенде. Боевой дух всех бойцов ниже рангом чем Вы выше на единицу.",effect:{}},{text:"Когда Вы успешно побеждаете противника в бою, Вы можете сопровождать свои действия вдохновляющими союзников репликами. Все увидевшие и услышавшие это в бою бойцы ниже Вас рангом получат преимущество в одну категорию при атаке на один раунд.",effect:{}},{text:"Преимущества двух предыдущих уровней теперь действуют даже на бойцов Вашего ранга, включая товарищей по команде и даже Вас.",effect:{}}]},{id:"goldenPages",name:"Золотые страницы",levels:[{text:"Не только простые бойцы хотят остаться в легендах, выдающимся людям своей эпохи тоже не чужда жажда славы. Вам на две категории проще находить выход на тех, кто не стремится общаться с простым людом, а Ваши проверки Влияния против них на одну категорию проще.",effect:{}},{text:"Вам на две категории проще убеждать нейтральные стороны оказать Вам какую-то помощь - подкрепления, припасы, деньги или снаряжение. Это работает только в том случае, если по мнению люда Вам противостоит серьёный враг.",effect:{}},{text:"Здорово казаться всем храбрым... но и сойти богатым и щедрым - тоже неплохо. Вы можете рассчитывать на награду на одну категорию выше, если заказчик способен её себе позволить.",effect:{}}]}],edges:[{type:"aspect",id:"community",cost:4},{type:"aspect",id:"knowledge",cost:2}]},{id:"cutthroat",name:{m:"Головорез",f:"Головорезка"},nameEn:"Cutthroat",professions:[],aspects:["war","shadow"],traits:[{id:"terrorToAll",name:"Гроза всему живому",levels:[{text:"Вы славитесь своей безпринципностью и безжалостностью. Проверки Влияния на одну категорию эффективнее, если Вы предпочитаете действовать через угрозы. Однако, вероятность того, что Ваша деятельность привлечёт внимание властей ничуть не меньше.",effect:{}},{text:"Враждебные фракции подумают дважды, прежде чем чинить Вам какие-то неудобства. Но уж если они решатся - бросят в бой всё, что имеют. Враждебные фракции решаются на активные действия только при репутации Ненависть (-4) или Лютая Ненависть (-5)",effect:{}},{text:"Ваши проверки Влияния эффективнее на одну категорию при попытках договориться или на две, если Вы используете угрозы. Любые предприятия и организации связанные с Вашим именем на одну категорию больше защищены от нападок разумных.",effect:{}}]},{id:"mindBlowingCruelty",name:"Умопомрачительная жестокость",levels:[{text:"Пришедшие за Вашей головой морально готовы умереть, но никто не готов умереть ТАК. Если противник уже не может эффективно сопротивляться, Вы можете устроить показательную жестокую казнь, подрывая мораль всех, кто это увидел и услышал. Противники получают -2 морали, союзники и нейтральные бойцы -1. На это нужно затратить основное действие, но в следующий ход противники будут защищаться и нападать на одну категорию хуже. Этот эффект не проймёт бойцов более высокого ранга, чем убитый.",effect:{}},{text:"Захватив в бою пленного, Вы можете жестоко казнить его позже прилюдно. Такое действие снизит вероятность нападок на Вас со стороны враждебных фракций на две категории на следующий месяц.",effect:{}},{text:"Вы можете проводить казнь в бою, затрачивая всего один порыв. Это действие больше не подрывает мораль Ваших союзников, а кроме того может пронять бойцов даже более опытных, чем убитый.",effect:{}}]},{id:"honorForFools",name:"Честь - для идиотов и мертвецов",levels:[{text:"Ваши атаки во фланг и тыл получают преимущество в одну категорию.",effect:{}},{text:"Ваши атаки во фланг и тыл - всегда точные.",effect:{}},{text:"Ваши атаки во фланг и тыл не вызывают срабатывания реакции, а кроме того забирают у цели один порыв даже в случае промаха.",effect:{}}]}],edges:[{type:"aspect",id:"war",cost:3},{type:"aspect",id:"shadow",cost:3}]},{id:"heretic",name:{m:"Еретик",f:"Еретичка"},nameEn:"Heretic",professions:[],aspects:["mysticism","knowledge"],traits:[{id:"comprehendingIncomprehensible",name:"Постигая непостижимое",levels:[{text:"Парадокс - Ваше второе имя. Проходя любую проверку, Вы можете выбрать противоположную ей и преуспеть необъяснимым образом. Такая проверка, правда, будет на одну категорию сложнее заявленной. Вы должны объяснить, каким образом применяете свои навыки для того, чтобы пройти проверку.",effect:{}},{text:"Странно для других, естественно - для Вас. Вы можете выбрать соседнюю проверку вместо противоположной, но она будет на две категории сложнее.",effect:{}},{text:"Гениальность или безумие? Главное, чтобы это работало. Противоположные проверки больше не получают штрафа, а штраф при использовании соседних проверок снижен до одной категории.",effect:{}}]},{id:"verbalMagic",name:"Вербальная магия",levels:[{text:"Посвятив месяц изучению и анализу необъяснимых мистических сущностей, вы всё же находите кое-какие закономерности. Вы способны создавать заклинания - нелепые высказывания, которые нужно громко пропевать странно пританцовывая, чтобы они сработали. Каждое использование заклинания - парная проверка Порядка и Диверсии, требующая основного действия в бою или полного хода в небоевой сцене. Сложность определяется мастером по степени реалистичности задумки. Эти проверки нельзя заменить на другие, к ним не применяются никакие бонусы. Если обе пройдены - заклинание срабатывает как и планировалось, если провалена одна - не происходит ничего, если провалены обе - срабатывает наоборот. Одновременно Вы можете помнить только три заклинания.",effect:{}},{text:"Вы учитесь записывать свои заклинания и лучше запоминать, как именно их следует выполнять. Проверки сложности теперь проще на одну категорию, а если Вам нужно выбросить на кубике 6 или меньше, Вы проходите проверку автоматически. Теперь Вы можете хранить в своей памяти три заклинания и ещё три - в своих записях. Заклинания из памяти используются основным действием, заклинания из записей - основным действием и двумя порывами.",effect:{}},{text:"Вы научились так хорошо записывать свои заклинания, что даже другие могут их повторять. Потратив не менее двух недель и одного очка развития на изучение, Ваш товарищ может научиться использовать заклинание. В вашей собственной памяти теперь может храниться до шести заклинаний, ещё три - в записях.",effect:{}}]},{id:"completePicture",name:"Дорисовать картину",levels:[{text:"Высокие аналитические способности и хорошая интуиция - невероятно редкое сочетание, но благодаря этой связке Вы можете понимать то, что для других - недоступно. Например, разгадывать самые запутанные истории по обрывкам информации. Раз в месяц Вы можете сделать невероятную догадку - точно узнать причину какого-то события, которое Вы подробно изучали.",effect:{}},{text:"Будущее не может быть секретом для того, кто так хорошо понимает прошлое. Раз в месяц Вы можете сделать невероятную догадку - точно узнать последствия какого-то события, которое Вы подробно изучали или действия, которое собираетесь совершить.",effect:{}},{text:"Остальные видят только разрозренные кусочки, а Вы - полную картину. Жаль, что такие озарения посещают Вас лишь иногда. Раз в месяц Вы можете точно узнать самый лучший, простой и надёжный способ добиться каких-то результатов.",effect:{}}]}],edges:[{type:"aspect",id:"mysticism",cost:3},{type:"aspect",id:"knowledge",cost:3}]},{id:"seeker",name:{m:"Искатель",f:"Искательница"},nameEn:"Seeker",professions:[],aspects:["nature","community"],traits:[{id:"wolfToWolf",name:"Волк волку человек",levels:[{text:"Дух первооткрывателя толкает Вас почти всё время проводить в экспедициях по неизведанным землям. Вы здорово научились находить общий язык с местными дикими сообществами, Ваша Репутация с ними начинается с Небольшого Влияния (2), а все проверки Поиска и Влияния с их помощью на две категории проще.",effect:{}},{text:"Вы легко можете затеряться в дикой местности, поселившись в диком сообществе. За месяц проживания с ними, Вы можете хорошо выучить их язык, подняв попутно уровень Репутации до Дружбы (5). Ваши проверки Поиска в этой местности с помощью дружественных аборигенов проще на три категории.",effect:{}},{text:"Затратив достаточно времени, Вы способны, кажется, подружиться с кем угодно. Теперь Вы можете вжиться в сообщество любых животных или монстров, если им свойственна хотя бы какая-то стайность или социальность. На это придётся потратить не менее трёх месяцев, но в результате вы получите полное знание местности Как Свои Пять Пальцев (10), и одно очко развития.",effect:{}}]},{id:"artifactorFlair",name:"Чутьё артефактора",levels:[{text:"Пока другие покупают безделушки по цене магических артефактов, Вы делаете обратное. Паранормальное чутьё позволяет Вам находить действительно магические предметы даже в куче хлама, если они там есть. Проверки Поиска и Влияния проще на две категории при попытке найти артефакты.",effect:{}},{text:"Продажа магических материалов, ингредиентов и артефактов позволяет Вам выручить на одну категорию больше богатства.",effect:{}},{text:"Собирая вместе все знания о местной природе, слухи и легенды местного населения и своё таинственное чутьё, Вы гораздо легче находите древние руины, гробницы, затерянные города, магические места силы и прочее подобное. Проверки такого рода легче на три категории.",effect:{}}]},{id:"untilVictorious",name:"До победного",levels:[{text:"Простая неудача не может остановить Вашу несгибаемую волю Искателя. Раз в месяц Вы можете попробовать пройти проверку ещё два раза, если провалили первую попытку. Если вы пройдёте хотя бы одну из трёх - это зачитывается как успех. Мастер может наложить на Вас какой-нибудь штраф за приложение чрезмерных усилий.",effect:{}},{text:"Если Вы преуспели со второй попытки, третью можете использовать на другой проверке в этом же месяце.",effect:{}},{text:"Если Вы проваливаете проверку все три раза, при следующей попытке Ваша проверка будет на одну категорию проще.",effect:{}}]}],edges:[{type:"aspect",id:"nature",cost:3},{type:"aspect",id:"community",cost:3}]},{id:"dervish",name:{m:"Дервиш",f:"Дервишка"},nameEn:"Dervish",professions:[],aspects:["community","mysticism"],traits:[{id:"danceOfBliss",name:"Танец блаженства",levels:[{text:"Потратив действие в свой ход, Вы можете войти в особый боевой танец, в процессе которого не можете использовать атаки дальнего боя, но получаете преимущество в атаке в одну категорию.",effect:{}},{text:"Ваши движения иррациональны и непредсказуемы. Если Ваше передвижение или атака вызывает реакцию, пройдите проверку Влияния против Поиска противника. В случае успеха ему не удаётся отреагировать на Ваше действие, но затраченный порыв всё равно тратится.",effect:{}},{text:"Во время танца вы не получаете штрафов из-за ранений и морали (кроме смертельных), в к Вашей проверке Влияния на реакцию противника прибавляется две категории сложности.",effect:{}}]},{id:"ignitingHearts",name:"Зажигающий сердца",levels:[{text:"Свет вашей безграничной веры зажигает сердца и увлекает за собой. Ваши проверки Влияния вне боя легче на две категории, если цель не настроена враждебно по отношению к Вам.",effect:{}},{text:"Вы учитесь входить в особый транс в танце, который позволяет Вам лучше настроиться на следующую проверку. Проведя особый ритуал, Вы можете снизить сложность следующей проверки на категорию.",effect:{}},{text:"Ваш фанатизм сияет настолько ярко, что способен заворожить даже врага в бою. Теперь Ваши проверки Влияния легче на две категории даже в бою, даже в отношении врагов.",effect:{}}]},{id:"asIfNoOneSees",name:"Как будто никто не видит",levels:[{text:"Дервиш - это юродивый, которого никто не замечает, если он только сам того не хочет. Найти Вас в поселении с помощью Влияния на категорию сложнее.",effect:{}},{text:"Паранормальное чувство опасности ведёт Вас, позволяя избегать недоброжелателей. Найти Вас с помощью Влияния или Поиска становится сложнее на две категории. Этот бонус работает как в поселениях, так и в дикой природе.",effect:{}},{text:"Если Вас никто не видит, Вы можете делать что захотите. Проверки Диверсии становятся проще на две категории, если Вы лично участвуете в деле.",effect:{}}]}],edges:[{type:"aspect",id:"community",cost:3},{type:"aspect",id:"mysticism",cost:3}]},{id:"bard",name:{m:"Бард",f:"Бардесса"},nameEn:"Bard",professions:[],aspects:["community","shadow"],traits:[{id:"withoutMusic",name:"А без музыки…",levels:[{text:"Хотя бардам и не часто приходится участвовать в сражениях, в кабацких драках они бывают чаще прочих. Те, кто не научился защищать себя - попросту не выжили. Потратив два порыва Вы можете провести проверку Влияния против Влияния противника, чтобы отвлечь его и заставить потерять оставшиеся действия и порывы.",effect:{}},{text:"Пока Ваша собственная мораль высока и у Вас нет тяжёлых ранений, Вы можете петь в бою, не затрачивая никаких ресурсов. Это укрепляет мораль окружающих, добавляя единицу.",effect:{}},{text:"Ваше пение теперь повышает мораль на две единицы, а затратив в свой ход полное действие Вы можете подключить к нему игру на инструменте, попробовав, таким образом, отвлечь внимание сразу всей противников, которые способны Вас видеть и слышать. С высокой долей вероятности они вскоре захотят атаковать Вас.",effect:{}}]},{id:"welcomeGuest",name:"Желанный гость",levels:[{text:"Любое застолье проходит приятнее под хорошую музыку. Мало кто откажется от присутствия барда на светском рауте. Вы в курсе всех слухов поселения, в котором провели хотя бы один месяц, это упрощает Ваши проверки Влияния в поселении на три категории. ",effect:{}},{text:"Если Вы проводите в поселении хотя бы месяц, все фракции кроме враждебных, начинают относиться к Вам как минимум с Симпатией (1).",effect:{}},{text:"Если Вы проводите в поселении хотя бы месяц, все фракции кроме враждебных начинают относиться к Вам как к доброму приятелю (Сопереживание, 4), а жители окрестных селений - с Симпатией (1)",effect:{}}]},{id:"lightWedge",name:"Свет клином",levels:[{text:"Любое тёмное дело гораздо проще провернуть, если в нём участвует яркий фанфарон, привлекающий всё внимание. Вы не можете действовать в одиночку, но облегчаете проверки Диверсии для своих друзей на одну категорию. Этот бонус складывается с другими, которыми они обладают.",effect:{}},{text:"Как же не помочь хорошим ребятам! Вы облегчаете проверки Влияния на одну категорию для своих друзей, этот бонус складывается с другими. Размер бонуса к Диверсии увеличивается до двух категорий.",effect:{}},{text:" Как складно говорит! Проверки Порядка для Ваших друзей становятся легче на одну, Влияния - на две, Порядка - на три категории. Все эти бонусы складываются с другими, которые есть у этих персонажей.",effect:{}}]}],edges:[{type:"aspect",id:"community",cost:2},{type:"aspect",id:"shadow",cost:4}]},{id:"assassin",name:{m:"Убийца",f:"Убийца"},nameEn:"Assassin",professions:[],aspects:["mysticism","shadow"],traits:[{id:"slidingInShadows",name:"Скользящий в тени",levels:[{text:"Договариваться и подкупать стражу - не для Вас. Вам больше по душе верёвка с крюком и немного акробатики. А ещё Вы тонко чувствуете опасности, потому знаете, куда и когда лучше не соваться. Проверки Диверсии на проникновение на защищаемые объекты легче на две категории. Вы гарантированно успешно проникаете на объект, если его охраняют только Бойцы или ниже.",effect:{}},{text:"Затратив полный ход (включая порывы и передвижения) Вы можете попробовать настроиться на своё сверхъестественное чувство и узнать, какие опасности есть поблизости. Этот талант работает нестабильно, но всё же много раз спасал Вам жизнь.",effect:{}},{text:"Тени вокруг Вас неестественно темны, а под Вашими шагами не хрустят ветки и не скрипят половицы. Вне боя противник может заметить Вас, только если вы попадёте в его фронтальное поле зрения без укрытия. Противник не может протрубить тревогу в тот же ход, когда обнаружил Вас, если Вы нанесли ему хотя бы лёгкую травму. Проверки Диверсии теперь легче на три категории, если Вы можете обосновать, как будете использовать своё мастерство проникновения. ",effect:{}}]},{id:"flyingDeath",name:"Летящая смерть",levels:[{text:'Вопреки расхожим мифам, убийца - вовсе не лучший воин на свете. Ваше лучшее оружие - неожиданность и удары в спину. Затрачивая порыв на передвижение, Вы можете сделать один шаг и метнуть небольшой металлический шип через одну клетку. При попадании, он нанесёт травму категории "царапина".',effect:{}},{text:'Вы можете метать своё оружие через две клетки, а при попадании вы можете выбрать "точный удар" категории царапина или "лёгкая травма".',effect:{}},{text:'Ваши метательные ножи отравлены. Если Вы наносите хотя бы "лёгкую травму" своим метательным шипом, противник подвергается воздействию сильного яда, который удвоит этот урон на следующий ход. Теперь Вы можете метать ножи порывом, не затормаживая своего движения, в Вашем распоряжении остаются все два очка передвижения.',effect:{}}]},{id:"rememberDeath",name:"Помни о смерти",levels:[{text:"Хотя вы не афишируете свои умения, многие знают, что Ваши недоброжелатели долго не живут. Кто-то захлебнулся чаем, кто-то накормил в лесу стаю волков, а кто-то упал на собственный кухонный нож 18 раз. Проверки Влияния на две категории (6) проще, если Вы пытаетесь запугать кого-то.",effect:{}},{text:"Доказательств нет, но слухи… Преступные сообщества поселения, в котором Вы живёте не менее месяца, относятся к Вам с опаской. Быть безразличными им не удаётся - либо ненависть, либо уважение. Уровни влияния с -2 до +2 недоступны, все сообщества должны выбрать свою сторону. Те, кому Вы не чинили явного зла, будут склонны выбрать дружбу. Переходить из -3 до +3 для Вас вдвое проще, чем в обратную сторону..",effect:{}},{text:"Кроме тех, кто Вас боится, есть ещё и те, кто Вам должен. Все проверки Влияния на категорию проще, если Вы провели в этом поселении не менее месяца. Этот бонус складывается с бонусом при угрозах.",effect:{}}]}],edges:[{type:"aspect",id:"mysticism",cost:4},{type:"aspect",id:"shadow",cost:2}]},{id:"shaman",name:{m:"Шаман",f:"Шаманка"},nameEn:"Shaman",professions:[],aspects:["mysticism","nature"],traits:[{id:"bearSkin",name:"Медвежья шкура",levels:[{text:"В бою Вы способны впадать в кровавую ярость - за каждую степень этого эффекта Ваши защита и атака повышаются на одну категорию, но Вы не можете сопротивляться соблазну рвать на части зубами и когтями тело поверженного врага, если оказываетесь вплотную к нему. Активация ярости происходит мгновенно, сразу на второй степени. Вы можете потратить действие, чтобы снизить уровень эффекта на единицу, проведя проверку категории Простая + степень эффекта. В случае провала, Вы не можете контролировать своего персонажа следующий ход. Расправа над поверженным занимает целое действие.",effect:{}},{text:"За каждого разодранного противника Вы получаете дополнительную степень эффекта, вплоть до пяти. Начиная с третьей, расправа над противником требует только один порыв.",effect:{}},{text:"Максимальная степень эффекта теперь шестая. Начиная с третьей Вы мгновенно раздираете противника на части, если добиваете своей атакой. Если же он уже был повержен к тому моменту, Вам требуется один порыв.",effect:{}}]},{id:"iSee",name:"Я вижу",levels:[{text:"Духи говорят с Вами, позволяют видеть своими глазами. Вы получаете дополнительную информацию о том, что происходит в пределах километра от Вас. Проверки Поиска легче на одну категорию.",effect:{}},{text:"Духи видят прошлое и будущее. Вы можете узнать прошлое и будущее места, которое посетили, если свяжетесь с духами, которые здесь живут. Доступна особая проверка Интуиции, сложность на усмотрение мастера.",effect:{}},{text:"Духи помнят, помнят всё. Вы можете ограниченно получать информацию от мёртвых. Доступна особая проверка интуиции, сложность на усмотрение мастера.",effect:{}}]},{id:"visions",name:"Видения",levels:[{text:"Знать - недостаточно, нужно ещё суметь применить эти знания на пользу делу. Вы учитесь использовать полученную информацию для шпионажа и диверсий, таким образом можете облегчить любую проверку Диверсии на одну категорию.",effect:{}},{text:"Предупреждён - значит вооружён. Позволяет усложнить вражеские проверки Диверсии против какого-то предприятия на одну категорию.",effect:{}},{text:"Удваивает бонусы двух предыдущих уровней этого умения.",effect:{}}]}],edges:[{type:"aspect",id:"mysticism",cost:2},{type:"aspect",id:"nature",cost:4}]},{id:"fixer",name:{m:"Решала",f:"Решала"},nameEn:"Fixer",professions:[],aspects:["knowledge","shadow"],traits:[{id:"sneakyStrike",name:"Подлый удар",levels:[{text:"Вы не рыцарь в сверкающих доспехах, а всего лишь деловой человек, который не хочет проблем. Но иногда проблемы приходят сами… Потратив один порыв Вы можете нанести точный лёгкий удар рукой по противнику. Если Вы держите в руках оружие, считается что Вы ударили рукоятью, гардой, древком. Этот удар гарантировано сработает против противника, который ещё не знает что Вы так умеете. Но только один раз, и всех увидевших Вы уже не сможете удивить повторно.",effect:{}},{text:"Ваша точная неожиданная атага теперь наносит лёгкую травму, а не царапину. После такой атаки защита противника снижена на две категории.",effect:{}},{text:"Разнообразие. Вы знаете столько приёмов, что можете удивить каждого. Если Вы используете подлый удар, в течении этого хода Вы можете применить его несколько раз до полного исчерпания порывов.",effect:{}}]},{id:"whileNoOneSees",name:"Пока никто не видит",levels:[{text:"Ваша специализация - тёмные дела, чаще всего торговые. Вы проводите теневые сделки проще, зарабатываете с них больше. Проверки проще на одну категорию, прибыль также больше на одну.",effect:{}},{text:"Ваши шансы найти что-то действительно ценное значительно повышаются, если Вы занимаетесь торговлей. Поиск через Влияние работает на две категории проще, если Вы знаете, что именно ищете.",effect:{}},{text:"Торговля удаётся Вам всё лучше - теперь проверки и прибыль лучше сразу на две категории. Раз в месяц Вы можете провести особенно крупную сделку, с повышенными шансами на провал и на то, что Вас поймают.",effect:{}}]},{id:"boundByBlood",name:"Повязанные кровью",levels:[{text:"У Вас обширная сеть контактов в криминальном мире, преимущественно - среди гильдий воров. Ваши отношения с ними изначально на уровне 4, Сопереживание, но могут и меняться со временем.",effect:{}},{text:"В любом поселении цивилизованного мира Вы легко можете найти своих. За звонкую монету они готовы выполнить любой заказ. Доступен особый тип наёмников - разъярённые бедняки. Они способны устроить беспорядки в своём селении, но не покинут его пределов.",effect:{}},{text:"Вам доступен особый тип наёмников - городские бандиты. Могут наниматься только в крупных городах, их дисциплина хромает, как и мораль. Зато они обходятся крайне дёшево и с такими потерями можно не считаться.",effect:{}}]}],edges:[{type:"aspect",id:"knowledge",cost:3},{type:"aspect",id:"shadow",cost:3}]},{id:"champion",name:{m:"Чемпион",f:"Чемпион"},nameEn:"Champion",professions:[],aspects:["war"],traits:[{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]}],edges:[{type:"aspect",id:"war",cost:2}]},{id:"strategist",name:{m:"Стратег",f:"Стратег"},nameEn:"Strategist",professions:[],aspects:["war"],traits:[{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]}],edges:[{type:"aspect",id:"war",cost:2},{type:"class",id:"surgeon",cost:4}]},{id:"sniper",name:{m:"Снайпер",f:"Снайпер"},nameEn:"Sniper",professions:[],aspects:["war"],traits:[{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]}],edges:[{type:"aspect",id:"war",cost:2},{type:"class",id:"warden",cost:4}]},{id:"surgeon",name:{m:"Хирург",f:"Хирург"},nameEn:"Surgeon",professions:[],aspects:["knowledge"],traits:[{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]}],edges:[{type:"aspect",id:"knowledge",cost:2},{type:"class",id:"strategist",cost:4}]},{id:"magister",name:{m:"Магистр",f:"Магистр"},nameEn:"Magister",professions:[],aspects:["knowledge"],traits:[{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]}],edges:[{type:"aspect",id:"knowledge",cost:2}]},{id:"advisor",name:{m:"Советник",f:"Советница"},nameEn:"Advisor",professions:[],aspects:["knowledge"],traits:[{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]}],edges:[{type:"aspect",id:"knowledge",cost:2},{type:"class",id:"politician",cost:4}]},{id:"politician",name:{m:"Политик",f:"Политик"},nameEn:"Politician",professions:[],aspects:["community"],traits:[{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]}],edges:[{type:"aspect",id:"community",cost:2},{type:"class",id:"advisor",cost:4}]},{id:"leader",name:{m:"Лидер",f:"Лидер"},nameEn:"Leader",professions:[],aspects:["community"],traits:[{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]}],edges:[{type:"aspect",id:"community",cost:2}]},{id:"instigator",name:{m:"Провокатор",f:"Провокатор"},nameEn:"Instigator",professions:[],aspects:["community"],traits:[{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]}],edges:[{type:"aspect",id:"community",cost:2},{type:"class",id:"spy",cost:4}]},{id:"spy",name:{m:"Шпион",f:"Шпион"},nameEn:"Spy",professions:[],aspects:["shadow"],traits:[{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]}],edges:[{type:"aspect",id:"shadow",cost:2},{type:"class",id:"instigator",cost:4}]},{id:"thief",name:{m:"Вор",f:"Вор"},nameEn:"Thief",professions:[],aspects:["shadow"],traits:[{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]}],edges:[{type:"aspect",id:"shadow",cost:2}]},{id:"trickster",name:{m:"Шулер",f:"Шулер"},nameEn:"Trickster",professions:[],aspects:["shadow"],traits:[{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]}],edges:[{type:"aspect",id:"shadow",cost:2},{type:"class",id:"mentalist",cost:4}]},{id:"mentalist",name:{m:"Менталист",f:"Менталист"},nameEn:"Mentalist",professions:[],aspects:["mysticism"],traits:[{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]}],edges:[{type:"aspect",id:"mysticism",cost:2},{type:"class",id:"trickster",cost:4}]},{id:"occultist",name:{m:"Оккультист",f:"Оккультист"},nameEn:"Occultist",professions:[],aspects:["mysticism"],traits:[{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]}],edges:[{type:"aspect",id:"mysticism",cost:2}]},{id:"seer",name:{m:"Провидец",f:"Провидица"},nameEn:"Seer",professions:[],aspects:["mysticism"],traits:[{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]}],edges:[{type:"aspect",id:"mysticism",cost:2},{type:"class",id:"stalker",cost:4}]},{id:"stalker",name:{m:"Сталкер",f:"Сталкер"},nameEn:"Stalker",professions:[],aspects:["nature"],traits:[{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]}],edges:[{type:"aspect",id:"nature",cost:2},{type:"class",id:"seer",cost:4}]},{id:"archon",name:{m:"Архонт",f:"Архонт"},nameEn:"Archon",professions:[],aspects:["nature"],traits:[{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]}],edges:[{type:"aspect",id:"nature",cost:2}]},{id:"warden",name:{m:"Страж",f:"Страж"},nameEn:"Warden",professions:[],aspects:["nature"],traits:[{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]},{id:"placeholder",name:"Временный",levels:[{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}},{text:"Этот класс ещё не прописан, как и его способности",effect:{}}]}],edges:[{type:"aspect",id:"nature",cost:2},{type:"class",id:"sniper",cost:4}]}],_h={systemName:"triP Classes",version:"1.0"},nn={classes:$h,metadata:_h},Th=[{level:1,key:"t",letter:"F",short:"П",color:"#00DDFF",lightText:!1,aliases:["trivial","простая","пустяковый","пустяк"],names:{difficulty:{ru:"Простая",en:"Trivial"},damage:{ru:"Пустяковый",en:"Trivial"},defence:{ru:"Простая",en:"Trivial"}}},{level:2,key:"l",letter:"E",short:"Л",color:"#00CC44",lightText:!1,aliases:["light","лёгкая","лёгкий"],names:{difficulty:{ru:"Лёгкая",en:"Light"},damage:{ru:"Лёгкий",en:"Light"},defence:{ru:"Лёгкая",en:"Light"}}},{level:3,key:"m",letter:"D",short:"С",color:"#FFEE00",lightText:!1,aliases:["moderate","средняя","серьёзный"],names:{difficulty:{ru:"Средняя",en:"Moderate"},damage:{ru:"Серьёзный",en:"Moderate"},defence:{ru:"Средняя",en:"Moderate"}}},{level:4,key:"h",letter:"C",short:"Т",color:"#FF8800",lightText:!1,aliases:["heavy","тяжёлая","тяжёлый"],names:{difficulty:{ru:"Тяжёлая",en:"Heavy"},damage:{ru:"Тяжёлый",en:"Heavy"},defence:{ru:"Тяжёлая",en:"Heavy"}}},{level:5,key:"g",letter:"B",short:"Ж",color:"#CC0000",lightText:!0,aliases:["grievous","granite","жестокая","жёсткая","жестокий"],names:{difficulty:{ru:"Жестокая",en:"Grievous"},damage:{ru:"Жестокий",en:"Grievous"},defence:{ru:"Жёсткая",en:"Granite"}}},{level:6,key:"n",letter:"A",short:"К",color:"#440066",lightText:!0,aliases:["nightmare","кошмарная","кошмарный"],names:{difficulty:{ru:"Кошмарная",en:"Nightmare"},damage:{ru:"Кошмарный",en:"Nightmare"},defence:{ru:"Кошмарная",en:"Nightmare"}}},{level:7,key:"i",letter:"S",short:"Н",color:"#000000",lightText:!0,aliases:["impossible","невозможная","невыносимый"],names:{difficulty:{ru:"Невозможная",en:"Impossible"},damage:{ru:"Невыносимый",en:"Impossible"},defence:{ru:"Невозможная",en:"Impossible"}}}],Ih={description:"Единая шкала уровней для сложностей проверок, категорий урона и защит",version:"2.0"},Eo={levels:Th,metadata:Ih},bs={ASSET:"asset",URL:"url",BASE64:"base64",BLOB:"blob"},Sh=(t,l)=>({type:bs.ASSET,value:es(`/images/${t}/${l}.png`),assetPath:`/images/${t}/${l}.png`}),Eh=t=>({type:bs.URL,value:t}),Ph=t=>({type:bs.BASE64,value:t.startsWith("data:")?t:`data:image/png;base64,${t}`}),jn=(t,l="items")=>{if(!t)return null;if(typeof t=="object"&&t.type)return t;const o=String(t);return o.startsWith("data:image")?Ph(o):o.startsWith("http://")||o.startsWith("https://")?Eh(o):o.startsWith("blob:")?{type:bs.BLOB,value:o}:o.startsWith("/images/")?{type:bs.ASSET,value:es(o),assetPath:o}:Sh(l,o)},Gn=(t,l="items",o=null)=>{const a=jn(t,l);return a?a.value:o?es(`/images/${l}/${o}.png`):""},Mh=t=>new Promise((l,o)=>{const a=new FileReader;a.onload=()=>l(a.result),a.onerror=o,a.readAsDataURL(t)}),Dh=(t,l=256,o=256,a="image/png",r=.85)=>new Promise((c,f)=>{const k=new Image;k.crossOrigin="anonymous",k.onload=()=>{let{width:w,height:x}=k;if(w>l||x>o){const B=Math.min(l/w,o/x);w=Math.round(w*B),x=Math.round(x*B)}const T=document.createElement("canvas");T.width=w,T.height=x,T.getContext("2d").drawImage(k,0,0,w,x),c(T.toDataURL(a,r))},k.onerror=f,k.src=t}),Bh=t=>{if(!t)return!1;try{const l=new URL(t);return["http:","https:"].includes(l.protocol)}catch{return!1}},Rh={class:"image-picker"},Fh=["src"],Lh={class:"edit-overlay"},Nh={key:2,class:"source-badge uploaded"},Oh={key:3,class:"source-badge external"},Hh={class:"picker-modal"},qh={class:"picker-header"},Uh={class:"picker-tabs"},Wh={class:"picker-body"},zh={key:0,class:"tab-content"},Vh={class:"input-group"},Qh=["disabled"],jh={key:1,class:"tab-content"},Gh=["disabled"],Yh={class:"hint"},Xh={key:2,class:"tab-content"},Zh={class:"input-group"},Jh=["placeholder"],Kh={class:"hint"},eg={key:3,class:"error-msg"},tg={class:"picker-footer"},sg={__name:"ImagePicker",props:{modelValue:{type:[String,Object],default:null},category:{type:String,default:"items"},fallbackId:{type:String,default:null},size:{type:Number,default:80},maxFileSize:{type:Number,default:256},disabled:{type:Boolean,default:!1}},emits:["update:modelValue"],setup(t,{emit:l}){const o=t,a=l,r=R(!1),c=R("url"),f=R(""),k=R(""),w=R(!1),x=R(""),T=ne(()=>Gn(o.modelValue,o.category,o.fallbackId)),y=ne(()=>{const Z=jn(o.modelValue,o.category);return(Z==null?void 0:Z.type)||bs.ASSET}),B=()=>{if(o.disabled)return;const Z=jn(o.modelValue,o.category);(Z==null?void 0:Z.type)===bs.URL?(c.value="url",f.value=Z.value):(Z==null?void 0:Z.type)===bs.BASE64?c.value="upload":(c.value="asset",k.value=o.fallbackId||""),x.value="",r.value=!0},m=()=>{r.value=!1,x.value=""},Y=async()=>{const Z=f.value.trim();if(!Z){x.value="Введите URL";return}if(!Bh(Z)){x.value="Некорректный URL";return}w.value=!0,x.value="";try{const K=new Image;K.crossOrigin="anonymous",await new Promise((X,U)=>{K.onload=X,K.onerror=()=>U(new Error("Не удалось загрузить изображение")),K.src=Z}),a("update:modelValue",Z),m()}catch(K){x.value=K.message||"Ошибка загрузки"}finally{w.value=!1}},j=()=>{const Z=k.value.trim();if(!Z){x.value="Введите ID";return}a("update:modelValue",Z),m()},F=async Z=>{var X;const K=(X=Z.target.files)==null?void 0:X[0];if(K){if(!K.type.startsWith("image/")){x.value="Выберите изображение";return}w.value=!0,x.value="";try{const U=await Mh(K),D=await Dh(U,o.maxFileSize,o.maxFileSize,"image/png",.9);a("update:modelValue",D),m()}catch{x.value="Ошибка обработки изображения"}finally{w.value=!1}}},ie=()=>{a("update:modelValue",null),m()},W=R(null),S=()=>{var Z;(Z=W.value)==null||Z.click()};return(Z,K)=>(s(),n("div",Rh,[e("div",{class:Q(["picker-preview",{disabled:t.disabled}]),style:Qe({width:t.size+"px",height:t.size+"px"}),onClick:B},[T.value?(s(),n("img",{key:0,src:T.value,alt:"Preview"},null,8,Fh)):(s(),st(i(p),{key:1,icon:"mdi:image-plus",class:"placeholder-icon"})),e("div",Lh,[A(i(p),{icon:"mdi:pencil"})]),y.value==="base64"?(s(),n("div",Nh,[A(i(p),{icon:"mdi:upload"})])):y.value==="url"?(s(),n("div",Oh,[A(i(p),{icon:"mdi:link"})])):_("",!0)],6),(s(),st(Vt,{to:"body"},[r.value?(s(),n("div",{key:0,class:"picker-overlay",onClick:lt(m,["self"])},[e("div",Hh,[e("div",qh,[K[5]||(K[5]=e("h4",null,"Выбор изображения",-1)),e("button",{onClick:m,class:"close-btn"},[A(i(p),{icon:"mdi:close"})])]),e("div",Uh,[e("button",{class:Q({active:c.value==="url"}),onClick:K[0]||(K[0]=X=>c.value="url")},[A(i(p),{icon:"mdi:link"}),K[6]||(K[6]=Ce("URL ",-1))],2),e("button",{class:Q({active:c.value==="upload"}),onClick:K[1]||(K[1]=X=>c.value="upload")},[A(i(p),{icon:"mdi:upload"}),K[7]||(K[7]=Ce("Загрузить ",-1))],2),e("button",{class:Q({active:c.value==="asset"}),onClick:K[2]||(K[2]=X=>c.value="asset")},[A(i(p),{icon:"mdi:folder-image"}),K[8]||(K[8]=Ce("Файл игры ",-1))],2)]),e("div",Wh,[c.value==="url"?(s(),n("div",zh,[e("div",Vh,[De(e("input",{"onUpdate:modelValue":K[3]||(K[3]=X=>f.value=X),type:"url",placeholder:"https://example.com/image.png",onKeyup:ks(Y,["enter"])},null,544),[[je,f.value]]),e("button",{onClick:Y,disabled:w.value,class:"apply-btn"},[w.value?(s(),st(i(p),{key:0,icon:"mdi:loading",class:"spin"})):(s(),st(i(p),{key:1,icon:"mdi:check"}))],8,Qh)]),K[9]||(K[9]=e("p",{class:"hint"},"Вставьте прямую ссылку на изображение",-1))])):_("",!0),c.value==="upload"?(s(),n("div",jh,[e("input",{ref_key:"fileInputRef",ref:W,type:"file",accept:"image/*",onChange:F,style:{display:"none"}},null,544),e("button",{onClick:S,class:"upload-btn",disabled:w.value},[w.value?(s(),st(i(p),{key:0,icon:"mdi:loading",class:"spin"})):(s(),st(i(p),{key:1,icon:"mdi:cloud-upload"})),K[10]||(K[10]=e("span",null,"Выбрать файл",-1))],8,Gh),e("p",Yh,"PNG, JPG, WebP. Будет сжато до "+h(t.maxFileSize)+"×"+h(t.maxFileSize)+"px",1)])):_("",!0),c.value==="asset"?(s(),n("div",Xh,[e("div",Zh,[De(e("input",{"onUpdate:modelValue":K[4]||(K[4]=X=>k.value=X),type:"text",placeholder:`ID (например: ${t.fallbackId||"iron_sword"})`,onKeyup:ks(j,["enter"])},null,40,Jh),[[je,k.value]]),e("button",{onClick:j,class:"apply-btn"},[A(i(p),{icon:"mdi:check"})])]),e("p",Kh,"Файл: /images/"+h(t.category)+"/{ID}.png",1)])):_("",!0),x.value?(s(),n("div",eg,[A(i(p),{icon:"mdi:alert-circle"}),Ce(h(x.value),1)])):_("",!0)]),e("div",tg,[e("button",{onClick:ie,class:"reset-btn"},[A(i(p),{icon:"mdi:restore"}),K[11]||(K[11]=Ce("По умолчанию ",-1))])])])])):_("",!0)]))]))}},Po=zt(sg,[["__scopeId","data-v-d6a3b6e4"]]),ng={class:"picker-header"},lg={key:0,class:"custom-form"},og={class:"form-scroll"},ag={class:"form-section"},ig={class:"form-row"},rg={class:"form-section flex-1"},cg={class:"form-section flex-1"},dg={class:"form-section"},ug={class:"form-row"},mg={class:"form-section flex-1"},vg={class:"form-section flex-1"},fg={class:"form-row"},Ag={class:"form-section flex-1"},pg={class:"form-section flex-1"},hg={class:"form-section"},gg={class:"attack-row"},yg={class:"attack-field"},bg={class:"attack-label"},kg={class:"stepper"},xg={class:"attack-field"},wg={class:"attack-label"},Cg={class:"stepper"},$g={class:"attack-field"},_g={class:"attack-label"},Tg={class:"stepper"},Ig={class:"form-section"},Sg={class:"damage-grid"},Eg={class:"level-stepper"},Pg=["onClick"],Mg={class:"value"},Dg=["onClick"],Bg={class:"form-row"},Rg={class:"form-section flex-1"},Fg={class:"form-section flex-1"},Lg={class:"form-row"},Ng={class:"form-section flex-1"},Og={class:"form-section flex-1"},Hg={key:2,class:"form-section"},qg={class:"form-section"},Ug={class:"form-actions"},Wg={class:"picker-filters"},zg={class:"search-box"},Vg={class:"category-tabs"},Qg=["onClick"],jg={class:"picker-content"},Gg={key:0,class:"empty-state"},Yg={class:"group-header"},Xg={class:"items-grid"},Zg=["onClick"],Jg={class:"item-img"},Kg=["src","alt"],e1={class:"item-info"},t1={class:"item-name"},s1={class:"item-stats"},n1={key:0,class:"stat atk"},l1={key:1,class:"stat atk"},o1={key:2,class:"stat def"},a1={key:3,class:"stat res"},i1={key:0,class:"picker-footer"},r1={__name:"ItemPicker",props:{mode:{type:String,default:"single"},title:{type:String,default:"Выбрать предмет"},allowCustom:{type:Boolean,default:!0},categoryFilter:{type:Array,default:null},selected:{type:Array,default:()=>[]},useExternalEditor:{type:Boolean,default:!0}},emits:["select","close","create-custom"],setup(t,{emit:l}){const o=t,a=l,r=R(""),c=R("all"),f=R(!1),k=R(w());function w(){return{id:`custom_${Date.now()}`,name:"",category:"weapon",subcat:"",desc:"",length:1,hands:1,price:1,epoch:1,attack:{short:0,long:0},defence:0,damageType:"Режущий",armorPen:0,damage:{},customImage:null,isCustom:!0}}const x=ne(()=>en.items||[]),T=ne(()=>{const D=[{id:"all",label:"Все",icon:"mdi:view-grid"},{id:"weapon",label:"Оружие",icon:"mdi:sword"},{id:"armor",label:"Броня",icon:"mdi:shield-account"},{id:"shield",label:"Щиты",icon:"mdi:shield"}];return o.categoryFilter?D.filter(b=>b.id==="all"||o.categoryFilter.includes(b.id)):D}),y=ne(()=>{let D=x.value;if(o.categoryFilter&&(D=D.filter(b=>o.categoryFilter.includes(b.category))),c.value!=="all"&&(D=D.filter(b=>b.category===c.value)),r.value.trim()){const b=r.value.toLowerCase().trim();D=D.filter(d=>d.name.toLowerCase().includes(b)||d.id.toLowerCase().includes(b)||d.desc&&d.desc.toLowerCase().includes(b))}return D}),B=ne(()=>{const D={};return y.value.forEach(b=>{const d=b.subcat||"other";D[d]||(D[d]=[]),D[d].push(b)}),D}),m={spears:"Копья и древковое",bows:"Луки",crossbows:"Арбалеты",slings:"Пращи",daggers:"Кинжалы",swords:"Мечи",axes:"Топоры",maces:"Дробящее",flails:"Цепы",shields:"Щиты",light:"Лёгкая броня",middle:"Средняя броня",heavy:"Тяжёлая броня",other:"Прочее"},Y=ne(()=>Eo.levels||[]),j=D=>{const b={...JSON.parse(JSON.stringify(D)),instanceId:`${D.id}_${Date.now()}_${Math.random().toString(36).substr(2,5)}`};a("select",b),o.mode==="single"&&a("close")},F=()=>{o.useExternalEditor?a("create-custom"):f.value=!0},ie=()=>{if(!k.value.name.trim()){alert("Введите название предмета");return}const D={...k.value,id:`custom_${Date.now()}`,instanceId:`custom_${Date.now()}_${Math.random().toString(36).substr(2,5)}`};a("select",D),k.value=w(),f.value=!1,o.mode==="single"&&a("close")},W=()=>{k.value=w(),f.value=!1},S=D=>D==null?"—":D>=0?`+${D}`:String(D),Z=(D,b)=>{const d=k.value.damage[D];if(d===void 0)b>0&&(k.value.damage[D]=0);else{const oe=d+b;oe<0?delete k.value.damage[D]:k.value.damage[D]=oe}},K=(D,b)=>{k.value.attack||(k.value.attack={});const d=k.value.attack[D];d===void 0?b!==0&&(k.value.attack[D]=b>0?0:-1):k.value.attack[D]=d+b},X=D=>{k.value.attack&&delete k.value.attack[D]},U=D=>{k.value.customImage=D};return(D,b)=>{var d,oe,he;return s(),n("div",{class:"item-picker-overlay",onClick:b[26]||(b[26]=M=>D.$emit("close"))},[e("div",{class:"item-picker",onClick:b[25]||(b[25]=lt(()=>{},["stop"]))},[e("div",ng,[e("h3",null,h(f.value?"Создать предмет":t.title),1),e("button",{class:"close-btn",onClick:b[0]||(b[0]=M=>D.$emit("close"))},[A(i(p),{icon:"mdi:close"})])]),f.value?(s(),n("div",lg,[e("div",og,[e("div",ag,[b[27]||(b[27]=e("label",{class:"form-label"},"Название",-1)),De(e("input",{"onUpdate:modelValue":b[1]||(b[1]=M=>k.value.name=M),class:"form-input",placeholder:"Название предмета"},null,512),[[je,k.value.name]])]),e("div",ig,[e("div",rg,[b[29]||(b[29]=e("label",{class:"form-label"},"Категория",-1)),De(e("select",{"onUpdate:modelValue":b[2]||(b[2]=M=>k.value.category=M),class:"form-select"},[...b[28]||(b[28]=[e("option",{value:"weapon"},"Оружие",-1),e("option",{value:"armor"},"Броня",-1),e("option",{value:"shield"},"Щит",-1)])],512),[[Kt,k.value.category]])]),e("div",cg,[b[31]||(b[31]=e("label",{class:"form-label"},"Тип урона",-1)),De(e("select",{"onUpdate:modelValue":b[3]||(b[3]=M=>k.value.damageType=M),class:"form-select"},[...b[30]||(b[30]=[e("option",null,"Режущий",-1),e("option",null,"Колющий",-1),e("option",null,"Дробящий",-1),e("option",null,"Рубящий",-1)])],512),[[Kt,k.value.damageType]])])]),e("div",dg,[b[32]||(b[32]=e("label",{class:"form-label"},"Описание",-1)),De(e("textarea",{"onUpdate:modelValue":b[4]||(b[4]=M=>k.value.desc=M),class:"form-textarea",placeholder:"Описание предмета...",rows:"2"},null,512),[[je,k.value.desc]])]),k.value.category==="weapon"?(s(),n(ee,{key:0},[e("div",ug,[e("div",mg,[b[34]||(b[34]=e("label",{class:"form-label"},"Длина",-1)),De(e("select",{"onUpdate:modelValue":b[5]||(b[5]=M=>k.value.length=M),class:"form-select"},[...b[33]||(b[33]=[e("option",{value:1},"Короткое (1)",-1),e("option",{value:2},"Длинное (2)",-1)])],512),[[Kt,k.value.length,void 0,{number:!0}]])]),e("div",vg,[b[36]||(b[36]=e("label",{class:"form-label"},"Руки",-1)),De(e("select",{"onUpdate:modelValue":b[6]||(b[6]=M=>k.value.hands=M),class:"form-select"},[...b[35]||(b[35]=[e("option",{value:.5},"Половина (0.5)",-1),e("option",{value:1},"Одна (1)",-1),e("option",{value:1.5},"Полторы (1.5)",-1),e("option",{value:2},"Две (2)",-1)])],512),[[Kt,k.value.hands,void 0,{number:!0}]])])]),e("div",fg,[e("div",Ag,[b[37]||(b[37]=e("label",{class:"form-label"},"Защита",-1)),De(e("input",{"onUpdate:modelValue":b[7]||(b[7]=M=>k.value.defence=M),type:"number",class:"form-input"},null,512),[[je,k.value.defence,void 0,{number:!0}]])]),e("div",pg,[b[38]||(b[38]=e("label",{class:"form-label"},"Пробитие",-1)),De(e("input",{"onUpdate:modelValue":b[8]||(b[8]=M=>k.value.armorPen=M),type:"number",class:"form-input"},null,512),[[je,k.value.armorPen,void 0,{number:!0}]])])]),e("div",hg,[b[42]||(b[42]=e("label",{class:"form-label"},"Модификаторы атаки",-1)),e("div",gg,[e("div",yg,[e("span",bg,[A(i(p),{icon:"mdi:knife"}),b[39]||(b[39]=Ce("Ближ.",-1))]),e("div",kg,[e("button",{onClick:b[9]||(b[9]=M=>K("short",-1))},"−"),e("span",{class:"value",onDblclick:b[10]||(b[10]=M=>X("short"))},h(((d=k.value.attack)==null?void 0:d.short)!==void 0?S(k.value.attack.short):"—"),33),e("button",{onClick:b[11]||(b[11]=M=>K("short",1))},"+")])]),e("div",xg,[e("span",wg,[A(i(p),{icon:"mdi:spear"}),b[40]||(b[40]=Ce("Дальн.",-1))]),e("div",Cg,[e("button",{onClick:b[12]||(b[12]=M=>K("long",-1))},"−"),e("span",{class:"value",onDblclick:b[13]||(b[13]=M=>X("long"))},h(((oe=k.value.attack)==null?void 0:oe.long)!==void 0?S(k.value.attack.long):"—"),33),e("button",{onClick:b[14]||(b[14]=M=>K("long",1))},"+")])]),e("div",$g,[e("span",_g,[A(i(p),{icon:"mdi:bow-arrow"}),b[41]||(b[41]=Ce("Стрел.",-1))]),e("div",Tg,[e("button",{onClick:b[15]||(b[15]=M=>K("ranged",-1))},"−"),e("span",{class:"value",onDblclick:b[16]||(b[16]=M=>X("ranged"))},h(((he=k.value.attack)==null?void 0:he.ranged)!==void 0?S(k.value.attack.ranged):"—"),33),e("button",{onClick:b[17]||(b[17]=M=>K("ranged",1))},"+")])])])]),e("div",Ig,[b[43]||(b[43]=e("label",{class:"form-label"},"Пороги урона",-1)),e("div",Sg,[(s(!0),n(ee,null,me(Y.value,M=>(s(),n("div",{key:M.key,class:Q(["damage-level",{active:k.value.damage[M.key]!==void 0}]),style:Qe({"--level-color":M.color})},[e("div",{class:"level-header",style:Qe({background:M.color+"30"})},h(M.short),5),e("div",Eg,[e("button",{onClick:de=>Z(M.key,-1)},"−",8,Pg),e("span",Mg,h(k.value.damage[M.key]!==void 0?k.value.damage[M.key]:"—"),1),e("button",{onClick:de=>Z(M.key,1)},"+",8,Dg)])],6))),128))])])],64)):_("",!0),k.value.category==="armor"?(s(),n(ee,{key:1},[e("div",Bg,[e("div",Rg,[b[44]||(b[44]=e("label",{class:"form-label"},"Защита",-1)),De(e("input",{"onUpdate:modelValue":b[18]||(b[18]=M=>k.value.defence=M),type:"number",class:"form-input"},null,512),[[je,k.value.defence,void 0,{number:!0}]])]),e("div",Fg,[b[45]||(b[45]=e("label",{class:"form-label"},"Резист",-1)),De(e("input",{"onUpdate:modelValue":b[19]||(b[19]=M=>k.value.resist=M),type:"number",class:"form-input"},null,512),[[je,k.value.resist,void 0,{number:!0}]])])]),e("div",Lg,[e("div",Ng,[b[46]||(b[46]=e("label",{class:"form-label"},"Движение",-1)),De(e("input",{"onUpdate:modelValue":b[20]||(b[20]=M=>k.value.movement=M),type:"number",class:"form-input"},null,512),[[je,k.value.movement,void 0,{number:!0}]])]),e("div",Og,[b[47]||(b[47]=e("label",{class:"form-label"},"Порывы",-1)),De(e("input",{"onUpdate:modelValue":b[21]||(b[21]=M=>k.value.bursts=M),type:"number",class:"form-input"},null,512),[[je,k.value.bursts,void 0,{number:!0}]])])])],64)):_("",!0),k.value.category==="shield"?(s(),n("div",Hg,[b[48]||(b[48]=e("label",{class:"form-label"},"Защита (простая)",-1)),De(e("input",{"onUpdate:modelValue":b[22]||(b[22]=M=>k.value.defence=M),type:"number",class:"form-input"},null,512),[[je,k.value.defence,void 0,{number:!0}]]),b[49]||(b[49]=e("span",{class:"form-hint"},"Или используйте редактор предмета после добавления для сложной защиты",-1))])):_("",!0),e("div",qg,[b[50]||(b[50]=e("label",{class:"form-label"},"Изображение",-1)),A(Po,{value:k.value.customImage,"onUpdate:value":U,placeholder:"Выбрать изображение"},null,8,["value"])])]),e("div",Ug,[e("button",{class:"btn cancel",onClick:W},"Отмена"),e("button",{class:"btn primary",onClick:ie},[A(i(p),{icon:"mdi:plus"}),b[51]||(b[51]=Ce("Создать ",-1))])])])):(s(),n(ee,{key:1},[e("div",Wg,[e("div",zg,[A(i(p),{icon:"mdi:magnify",class:"search-icon"}),De(e("input",{"onUpdate:modelValue":b[23]||(b[23]=M=>r.value=M),placeholder:"Поиск...",class:"search-input"},null,512),[[je,r.value]]),r.value?(s(),n("button",{key:0,class:"clear-search",onClick:b[24]||(b[24]=M=>r.value="")},[A(i(p),{icon:"mdi:close"})])):_("",!0)]),e("div",Vg,[(s(!0),n(ee,null,me(T.value,M=>(s(),n("button",{key:M.id,class:Q(["cat-tab",{active:c.value===M.id}]),onClick:de=>c.value=M.id},[A(i(p),{icon:M.icon},null,8,["icon"]),e("span",null,h(M.label),1)],10,Qg))),128))])]),e("div",jg,[y.value.length===0?(s(),n("div",Gg,[A(i(p),{icon:"mdi:package-variant-remove"}),b[52]||(b[52]=e("span",null,"Ничего не найдено",-1))])):(s(!0),n(ee,{key:1},me(B.value,(M,de)=>(s(),n("div",{key:de,class:"item-group"},[e("div",Yg,h(m[de]||de),1),e("div",Xg,[(s(!0),n(ee,null,me(M,H=>{var z,q;return s(),n("div",{key:H.id,class:"item-card",onClick:Ie=>j(H)},[e("div",Jg,[e("img",{src:i(Jt)(H.id),alt:H.name},null,8,Kg)]),e("div",e1,[e("span",t1,h(H.name),1),e("div",s1,[((z=H.attack)==null?void 0:z.short)!==void 0?(s(),n("span",n1,[A(i(p),{icon:"mdi:knife"}),Ce(h(S(H.attack.short)),1)])):_("",!0),((q=H.attack)==null?void 0:q.long)!==void 0?(s(),n("span",l1,[A(i(p),{icon:"mdi:spear"}),Ce(h(S(H.attack.long)),1)])):_("",!0),H.defence&&typeof H.defence=="number"?(s(),n("span",o1,[A(i(p),{icon:"mdi:shield"}),Ce(h(H.defence),1)])):_("",!0),H.resist?(s(),n("span",a1,[A(i(p),{icon:"mdi:water"}),Ce(h(H.resist),1)])):_("",!0)])]),A(i(p),{icon:"mdi:plus-circle",class:"add-icon"})],8,Zg)}),128))])]))),128))]),t.allowCustom?(s(),n("div",i1,[e("button",{class:"create-custom-btn",onClick:F},[A(i(p),{icon:"mdi:plus"}),b[53]||(b[53]=Ce(" Создать свой предмет ",-1))])])):_("",!0)],64))])])}}},c1=zt(r1,[["__scopeId","data-v-79f98b5a"]]),d1={class:"equipment-view"},u1={class:"stats-bar top"},m1={class:"stat-item"},v1={class:"stat-value"},f1={class:"stat-item"},A1={class:"stat-value"},p1={key:0,class:"stat-item"},h1={class:"stat-value"},g1={key:1,class:"stat-item"},y1={class:"stat-value"},b1={key:2,class:"stat-item"},k1={class:"stat-value"},x1={key:3,class:"stat-item"},w1={class:"hand-carousel left"},C1=["src"],$1={key:2,class:"link-badge left"},_1={class:"slot-item current"},T1=["src","alt"],I1={key:2,class:"link-badge left"},S1={class:"slot-label"},E1=["src"],P1={key:2,class:"link-badge left"},M1={class:"armor-center"},D1=["src","alt"],B1={class:"armor-stats"},R1={class:"stat def"},F1={class:"stat res"},L1={class:"armor-name"},N1={class:"hand-carousel right"},O1=["src"],H1={key:2,class:"link-badge right"},q1={class:"slot-item current"},U1=["src","alt"],W1={key:2,class:"link-badge right"},z1={class:"slot-label"},V1=["src"],Q1={key:2,class:"link-badge right"},j1={class:"inventory-carousel"},G1={class:"carousel-track"},Y1=["onClick"],X1=["src","alt"],Z1={key:0,class:"equipped-badge"},J1={key:0,class:"carousel-empty"},K1={class:"carousel-actions"},e0={key:0,class:"badge"},t0={class:"modal-header"},s0={class:"modal-img"},n0=["src","alt"],l0={class:"modal-title-area"},o0={key:0,class:"attack-chips"},a0={class:"modal-body"},i0={class:"stats-row"},r0={key:0,class:"shield-section"},c0={class:"shield-table"},d0={key:0,class:"shield-row"},u0={class:"shield-cell value"},m0={class:"shield-cell value"},v0={key:1,class:"shield-row"},f0={class:"shield-cell value"},A0={class:"shield-cell value"},p0={key:1,class:"damage-section"},h0={class:"damage-scale"},g0=["onClick"],y0={class:"damage-letter"},b0={key:0,class:"damage-threshold"},k0={key:2,class:"spec-box"},x0={key:3,class:"desc-box"},w0={class:"info-row"},C0={key:4,class:"hint-area"},$0={class:"hint-title"},_0={class:"hint-text"},T0={key:5,class:"hint-area placeholder"},I0={class:"modal-footer"},S0={key:2,class:"btn disabled",disabled:""},E0={class:"modal-header simple"},P0={class:"armor-list"},M0=["onClick"],D0=["src","alt"],B0={class:"armor-info"},R0={class:"name"},F0={class:"stats"},L0={key:0},N0={class:"modal-header"},O0={key:0,class:"custom-badge"},H0={class:"edit-modal-body"},q0={class:"edit-header-row"},U0={class:"edit-header-info"},W0={class:"icon-btn-group category-selector"},z0=["title","onClick"],V0={class:"edit-meta-row"},Q0={key:0,class:"icon-btn-group wrap"},j0=["title","onClick"],G0={key:1,class:"icon-btn-group"},Y0=["title","onClick"],X0={key:2,class:"icon-btn-group"},Z0=["title","onClick"],J0={key:3,class:"spacer"},K0={class:"meta-values"},ey={class:"meta-item",title:"Цена"},ty={class:"meta-item",title:"Эпоха"},sy={class:"edit-compact-row"},ny={class:"compact-group"},ly={class:"group-label"},oy={class:"icon-btn-group compact"},ay={class:"compact-group"},iy={class:"group-label"},ry={class:"icon-btn-group compact"},cy={class:"combat-stats-grid attacks-grid"},dy={class:"stat-header"},uy={class:"stat-value"},my={class:"stat-header"},vy={class:"stat-value"},fy={class:"stat-header"},Ay={class:"stat-value"},py={class:"stat-cell armor-pen"},hy={class:"stat-header"},gy={class:"stat-value"},yy={class:"defence-section"},by={class:"defence-header"},ky={class:"defence-title"},xy=["title"],wy={key:0,class:"simple-defence"},Cy={class:"stat-cell defence inline"},$y={class:"stat-value"},_y={key:1,class:"complex-defence"},Ty={key:0,class:"defence-direction"},Iy={class:"direction-label"},Sy={class:"direction-stats"},Ey={class:"mini-stat melee"},Py={class:"mini-label"},My={class:"mini-value"},Dy={class:"mini-stat ranged"},By={class:"mini-label"},Ry={class:"mini-value"},Fy={key:1,class:"defence-direction"},Ly={class:"direction-label"},Ny={class:"direction-stats"},Oy={class:"mini-stat melee"},Hy={class:"mini-label"},qy={class:"mini-value"},Uy={class:"mini-stat ranged"},Wy={class:"mini-label"},zy={class:"mini-value"},Vy={class:"add-direction-row"},Qy={class:"damage-type-section"},jy={class:"damage-levels-row"},Gy=["title"],Yy=["onClick"],Xy=["onDblclick"],Zy=["onClick"],Jy={key:1,class:"combat-stats-grid armor-grid"},Ky={class:"stat-cell defence"},eb={class:"stat-header"},tb={class:"stat-value"},sb={class:"stat-cell resist"},nb={class:"stat-header"},lb={class:"stat-value"},ob={class:"stat-cell movement"},ab={class:"stat-header"},ib={class:"stat-value"},rb={class:"stat-cell bursts"},cb={class:"stat-header"},db={class:"stat-value"},ub={class:"accessory-info"},mb={class:"combat-stats-grid accessory-grid"},vb={class:"stat-cell defence"},fb={class:"stat-header"},Ab={class:"stat-value"},pb={class:"stat-cell resist"},hb={class:"stat-header"},gb={class:"stat-value"},yb={class:"stat-cell movement"},bb={class:"stat-header"},kb={class:"stat-value"},xb={class:"stat-cell bursts"},wb={class:"stat-header"},Cb={class:"stat-value"},$b={class:"text-section special"},_b={class:"text-label"},Tb={class:"text-section"},Ib={class:"text-label"},Sb={class:"modal-footer edit-footer"},Eb={class:"backpack-modal-header"},Pb={class:"header-title"},Mb={class:"count"},Db={class:"backpack-filters"},Bb=["onClick"],Rb={key:0,class:"filter-count"},Fb={class:"backpack-content"},Lb={key:0,class:"backpack-grid"},Nb=["onClick"],Ob={class:"item-img-wrapper"},Hb=["src","alt"],qb={class:"item-info"},Ub={class:"item-name"},Wb={class:"item-category"},zb=["onClick"],Vb={key:1,class:"backpack-empty"},Qb={key:0,class:"backpack-footer"},jb={__name:"CharacterEquipment",props:{character:{type:Object,required:!0},isMaster:{type:Boolean,default:!1}},emits:["update:character"],setup(t,{emit:l}){var et;const o=t,a=l,r=ne(()=>en.items);ne(()=>r.value.filter(O=>O.category==="weapon"||O.category==="shield"));const c=ne(()=>r.value.filter(O=>O.category==="armor")),f=Eo.levels,k=ne(()=>o.character.customItems||[]),w=O=>{if(!O)return null;const u=k.value.find(ze=>ze.id===O||ze.instanceId===O);if(u)return u;const be=(o.character.inventory||[]).find(ze=>typeof ze=="object"?ze.id===O||ze.instanceId===O:ze===O);if(be&&typeof be=="object"){if(be.name||be.isCustom)return be;const ze=r.value.find(ut=>ut.id===be.id);if(ze)return{...ze,instanceId:be.instanceId}}return r.value.find(ze=>ze.id===O)},x=O=>{const u=w(O);return u&&(u.category==="weapon"||u.category==="shield")?u:null},T=O=>{const u=w(O);return u&&u.category==="armor"?u:null},y=R(((et=o.character.equipment)==null?void 0:et.activeSetIndex)||0),B=R(!1),m=R(null),Y=R(!1),j=R(!1),F=R(null),ie=R(""),W=R(!1),S=R(null),Z=R(!1),K=R("all"),X=R(!1),U=R(null),D=R(null),b={attack_short:{title:"Атака вплотную",text:"Модификатор броска атаки при ударе по соседнему противнику (на той же или соседней клетке). Положительное значение — бонус, отрицательное — штраф."},attack_long:{title:"Атака через клетку",text:"Модификатор броска атаки при ударе по противнику через одну клетку (длинное оружие). Положительное значение — бонус, отрицательное — штраф."},attack_ranged:{title:"Дальняя атака",text:"Модификатор броска атаки для стрельбы. Применяется при атаке на расстоянии более двух клеток."},defence:{title:"Защита оружием",text:"Бонус к защите при использовании этого оружия для парирования или отклонения ударов противника."},armorPen:{title:"Пробивание брони",text:"Количество очков брони, которое это оружие игнорирует при нанесении урона. Эффективно против бронированных противников."},damageType:{title:"Тип урона",text:"Вид повреждений, наносимых оружием. Разные типы урона могут быть более или менее эффективны против определённой брони или существ."},price:{title:"Стоимость",text:"Ценовая категория предмета. Определяет минимальный уровень достатка персонажа для приобретения."},epoch:{title:"Эпоха",text:"Технологическая эпоха, начиная с которой доступен этот предмет. Более поздние эпохи предлагают лучшее снаряжение."},length:{title:"Длина оружия",text:"Длинное оружие позволяет атаковать через клетку, но может быть менее эффективно вплотную. Короткое оружие удобнее в тесном бою."},hands:{title:"Хват",text:"Сколько рук требуется для использования. Одноручное оружие оставляет руку свободной для щита или второго оружия. Двуручное обычно мощнее."},armor_defence:{title:"Защита брони",text:"Базовая защита, которую даёт броня. Вычитается из урона противника при попадании."},armor_resist:{title:"Сопротивление",text:"Устойчивость к стихийному и магическому урону. Снижает урон от огня, холода, молний и т.д."},armor_movement:{title:"Влияние на движение",text:"Модификатор скорости передвижения. Тяжёлая броня замедляет, лёгкая может не влиять или даже ускорять."}},d={t:"Пустяковый урон — наносит царапину. Неприятно, но не опасно.",l:"Лёгкий урон — наносит лёгкое ранение. Персонаж способен пережить несколько таких ран без серьёзных последствий.",m:"Серьёзный урон — наносит тяжёлое ранение. Персонаж выведен из строя и нуждается в срочной помощи.",h:"Тяжёлый урон — смертельное ранение. Без снижения урона персонаж погибает.",g:"Жестокий урон — мгновенная смерть без защиты. Требуется минимум 1 единица снижения урона, чтобы выжить.",n:"Кошмарный урон — мгновенная смерть. Требуется минимум 2 единицы снижения урона, чтобы выжить.",i:"Невыносимый урон — мгновенная смерть. Требуется минимум 3 единицы снижения урона, чтобы выжить."},oe=ne(()=>{var u;const O=[...((u=o.character.equipment)==null?void 0:u.weaponSets)||[]];for(;O.length<2;)O.push({name:`Набор ${O.length+1}`,weapons:[]});return O}),he=ne(()=>oe.value[y.value]||{name:"Набор 1",weapons:[]}),M=ne(()=>{var u;const O=((u=o.character.equipment)==null?void 0:u.armor)||"clothes";return T(O)}),de=O=>{var ut;const u=oe.value[O];if(!u)return{left:null,right:null,isTwoHanded:!1};const be=(u.weapons||[]).map(xt=>x(xt)).filter(Boolean),ze=((ut=be[0])==null?void 0:ut.hands)===2;return{left:be[0]||null,right:ze?be[0]:be[1]||null,isTwoHanded:ze}},H=ne(()=>de(y.value)),z=ne(()=>(y.value-1+oe.value.length)%oe.value.length),q=ne(()=>(y.value+1)%oe.value.length),Ie=ne(()=>{var u;const O=new Set;return(u=o.character.equipment)!=null&&u.armor&&O.add(o.character.equipment.armor),oe.value.forEach(be=>(be.weapons||[]).forEach(ze=>O.add(ze))),(o.character.inventory||[]).forEach(be=>{O.add(typeof be=="string"?be:be.instanceId||be.id)}),Array.from(O)}),C=ne(()=>Ie.value.map(O=>w(O)).filter(Boolean)),L=ne(()=>{const O=new Set;return C.value.filter(u=>u.category==="weapon"||u.category==="shield").filter(u=>O.has(u.id)?!1:(O.add(u.id),!0))}),$e=ne(()=>{var ze;const O=(o.character.inventory||[]).map(ut=>typeof ut=="string"?ut:ut.instanceId||ut.id),u=[];O.forEach(ut=>{const xt=T(ut);xt&&u.push(xt)});const be=T((ze=o.character.equipment)==null?void 0:ze.armor);return be&&!u.find(ut=>ut.id===be.id)&&u.push(be),u}),Ae=ne(()=>{var u;const O=new Set;return O.add((u=o.character.equipment)==null?void 0:u.armor),oe.value.forEach(be=>(be.weapons||[]).forEach(ze=>O.add(ze))),(o.character.inventory||[]).map(be=>{const ze=typeof be=="string"?be:be.instanceId||be.id,ut=typeof be=="object"?be.id:be;if(typeof be=="object"&&(be.name||be.isCustom))return{...be,_instanceId:be.instanceId||be.id};const xt=w(ut);return xt?{...xt,_instanceId:ze}:null}).filter(Boolean).filter(be=>!O.has(be._instanceId)&&!O.has(be.id))}),Ee=ne(()=>K.value==="all"?Ae.value:Ae.value.filter(O=>K.value==="weapon"?O.category==="weapon":K.value==="armor"?O.category==="armor":K.value==="shield"?O.category==="shield":K.value==="other"?!["weapon","armor","shield"].includes(O.category):!0)),Se=ne(()=>({all:Ae.value.length,weapon:Ae.value.filter(O=>O.category==="weapon").length,armor:Ae.value.filter(O=>O.category==="armor").length,shield:Ae.value.filter(O=>O.category==="shield").length,other:Ae.value.filter(O=>!["weapon","armor","shield"].includes(O.category)).length})),Be=ne(()=>{const O=H.value,u=M.value;let be=(u==null?void 0:u.defence)||0,ze=(u==null?void 0:u.resist)||0,ut=(u==null?void 0:u.movement)||0,xt=null,Dt=null,Ht=null;const ns=Ft=>{var V;Ft&&(typeof Ft.defence=="object"?be+=((V=Ft.defence.front)==null?void 0:V.melee)||0:Ft.defence&&(be+=Ft.defence),Ft.attack&&typeof Ft.attack=="object"&&(Ft.attack.short!==void 0&&(xt=Math.max(xt??-999,Ft.attack.short)),Ft.attack.long!==void 0&&(Dt=Math.max(Dt??-999,Ft.attack.long)),Ft.attack.ranged!==void 0&&(Ht=Math.max(Ht??-999,Ft.attack.ranged))))};return ns(O.left),O.isTwoHanded||ns(O.right),{defence:be,resist:ze,movement:ut,attackShort:xt,attackLong:Dt,attackRanged:Ht}}),He=O=>{a("update:character",{...o.character,equipment:{...o.character.equipment,...O}})},Ne=O=>{a("update:character",{...o.character,inventory:O})},ot=O=>{X.value||(X.value=!0,U.value=O,setTimeout(()=>{const u=O==="up"?z.value:q.value;y.value=u,He({activeSetIndex:u}),X.value=!1,U.value=null},250))},We=()=>{if(!o.isMaster)return;const O=[...oe.value];O.push({name:`Набор ${O.length+1}`,weapons:[]}),He({weaponSets:O})},ce=O=>{var ze;if(!o.isMaster)return;if(oe.value.length<=1){alert("Нельзя удалить последний набор");return}if(!confirm(`Удалить набор "${((ze=oe.value[O])==null?void 0:ze.name)||"Без имени"}"?`))return;const u=[...oe.value];u.splice(O,1);let be=y.value;O===y.value?be=Math.min(O,u.length-1):O<y.value&&(be=y.value-1),y.value=be,He({weaponSets:u,activeSetIndex:be})},Je=O=>{const u=x(O);if(!u)return!1;const ze=[...(he.value.weapons||[]).map(Dt=>x(Dt)).filter(Boolean),u],ut=ze.reduce((Dt,Ht)=>Dt+(Ht.hands||1),0),xt=ze.filter(Dt=>Dt.length===2).length;return ut<=2&&xt<=1},Ke=O=>{if((he.value.weapons||[]).includes(O)||!Je(O))return;const u=[...oe.value],be={...u[y.value]};be.weapons=[...be.weapons||[],O],u[y.value]=be,He({weaponSets:u})},xe=O=>{const u=[...oe.value],be={...u[y.value]};be.weapons=(be.weapons||[]).filter(ze=>ze!==O),u[y.value]=be,He({weaponSets:u})},Me=O=>{He({armor:O}),Y.value=!1},Pe=O=>{const u=[...o.character.inventory||[]];if(O.isCustom){const be={...O,instanceId:O.instanceId||`${O.id}_${Date.now()}`};u.push(be);const ze=[...o.character.customItems||[],be];a("update:character",{...o.character,inventory:u,customItems:ze});return}u.push({id:O.id,instanceId:O.instanceId||`${O.id}_${Date.now()}`}),Ne(u)},Re=O=>{var ut;if(((ut=o.character.equipment)==null?void 0:ut.armor)===O||oe.value.some(xt=>(xt.weapons||[]).includes(O))){alert("Сначала снимите предмет");return}const be=(o.character.inventory||[]).filter(xt=>(typeof xt=="string"?xt:xt.instanceId||xt.id)!==O);Ne(be);const ze=(o.character.customItems||[]).filter(xt=>xt.id!==O);ze.length!==(o.character.customItems||[]).length&&a("update:character",{...o.character,inventory:be,customItems:ze})},ke=O=>{m.value=O,B.value=!0,D.value=null},ge=()=>{m.value=null,B.value=!1,D.value=null},ae=O=>{b[O]&&(D.value={type:"property",key:O,...b[O]})},Xe=(O,u)=>{var ze,ut;const be=((ut=(ze=O.names)==null?void 0:ze.damage)==null?void 0:ut.ru)||O.short;u==null?D.value={type:"damage",key:O.key,title:`${O.short} — ${be} урон`,text:"Это оружие не способно нанести урон данной категории."}:D.value={type:"damage",key:O.key,title:`${O.short} — ${be} урон`,text:`${d[O.key]||be}

Требуется очков превышения защиты: ${u}+`}},Ze=(O,u)=>!O.damage||O.damage[u]===void 0?null:O.damage[u],vt=(O,u)=>u?{backgroundColor:O.color,color:O.lightText?"#fff":"#000"}:{backgroundColor:"#333",color:"#666"},te=O=>O===2?"2 руки":O===1?"1 рука":O===1.5?"1.5 руки":`${O}`,J=O=>O===2?"Длинное":"Короткое",Te=O=>{F.value=O,ie.value=oe.value[O].name},$=()=>{if(F.value===null)return;const O=[...oe.value];O[F.value]={...O[F.value],name:ie.value||`Набор ${F.value+1}`},He({weaponSets:O}),F.value=null},P=O=>O>=0?`+${O}`:String(O),N=O=>{if(!o.isMaster||!O)return;const u=JSON.parse(JSON.stringify(O));(u.category==="weapon"||u.category==="shield")&&(u.attack||(u.attack={short:0,long:0,ranged:void 0}),u.damage||(u.damage={}),u.hands||(u.hands=1),u.length||(u.length=1)),u.spec&&!u.special&&(u.special=u.spec),S.value=u,W.value=!0},Ge=()=>{var ze;if(!S.value)return;const O=S.value,u=[...o.character.customItems||[]],be=u.findIndex(ut=>ut.id===O.id||ut.instanceId===O.instanceId);if(be!==-1?u[be]=O:u.push(O),At.value){const ut=[...o.character.inventory||[],O];a("update:character",{...o.character,inventory:ut,customItems:u}),At.value=!1}else a("update:character",{...o.character,customItems:u});W.value=!1,S.value=null,((ze=m.value)==null?void 0:ze.id)===O.id&&(m.value=O)},rt=()=>{W.value=!1,S.value=null,At.value=!1},ft=()=>{var u;if(!S.value)return;const O=r.value.find(be=>be.id===S.value.id);if(O){const be=(o.character.customItems||[]).filter(ze=>ze.id!==S.value.id);a("update:character",{...o.character,customItems:be}),((u=m.value)==null?void 0:u.id)===S.value.id&&(m.value=O)}W.value=!1,S.value=null},Et=O=>(o.character.customItems||[]).some(u=>u.id===O),At=R(!1),dt=()=>{const O={id:`custom_${Date.now()}`,instanceId:`custom_${Date.now()}_${Math.random().toString(36).substr(2,5)}`,name:"Новый предмет",category:"weapon",subcat:"swords",desc:"",length:1,hands:1,price:1,epoch:1,attack:{short:0,long:0},defence:0,damageType:"Режущий",armorPen:0,damage:{},isCustom:!0};S.value=O,At.value=!0,W.value=!0,j.value=!1},$t=[{value:"weapon",label:"Оружие",icon:"mdi:sword"},{value:"shield",label:"Щит",icon:"mdi:shield"},{value:"armor",label:"Броня",icon:"mdi:tshirt-crew"},{value:"item",label:"Предмет",icon:"mdi:package-variant"},{value:"quest",label:"Квестовый",icon:"mdi:exclamation-thick"},{value:"accessory",label:"Аксессуар",icon:"mdi:ring"},{value:"consumable",label:"Расходник",icon:"mdi:flask"}],re=[{value:"spears",icon:"mdi:spear"},{value:"swords",icon:"mdi:sword"},{value:"axes",icon:"mdi:axe"},{value:"maces",icon:"mdi:mace"},{value:"flails",icon:"ph:lasso-bold"},{value:"daggers",icon:"mdi:knife"},{value:"bows",icon:"mdi:bow-arrow"},{value:"crossbows",icon:"mdi:crosshairs"},{value:"slings",icon:"game-icons:sling"},{value:"firearms",icon:"mdi:pistol"},{value:"shields",icon:"mdi:shield"},{value:"exotic",icon:"mdi:star-four-points"}],ye=[{value:"light",icon:"mdi:tshirt-v"},{value:"middle",icon:"mdi:tshirt-crew"},{value:"heavy",icon:"mdi:shield-account"}],pe=[{value:"ring",icon:"mdi:ring"},{value:"amulet",icon:"game-icons:gem-pendant"},{value:"talisman",icon:"mdi:star-circle"},{value:"cloak",icon:"game-icons:cape"},{value:"belt",icon:"game-icons:belt"},{value:"other",icon:"mdi:dots-horizontal"}],Ue=(O,u)=>{var ut;if(!S.value)return;const ze=(((ut=S.value.damage)==null?void 0:ut[O])??-1)+u;if(ze<0){const xt={...S.value.damage};delete xt[O],S.value.damage=xt}else S.value.damage={...S.value.damage,[O]:ze}},Wt=O=>{if(!S.value)return;const u={...S.value.damage};delete u[O],S.value.damage=u},Rt=(O,u)=>{if(!S.value)return;S.value.attack||(S.value.attack={});const be=S.value.attack[O];be===void 0?u>0&&(S.value.attack={...S.value.attack,[O]:0}):S.value.attack={...S.value.attack,[O]:be+u}},gt=O=>{if(!S.value||!S.value.attack)return;const u={...S.value.attack};delete u[O],S.value.attack=u},bt=(O,u)=>{if(!S.value)return;const be=O.split(".");be.length===1?S.value[O]=(S.value[O]||0)+u:be.length===2&&(S.value[be[0]]||(S.value[be[0]]={}),S.value[be[0]][be[1]]=(S.value[be[0]][be[1]]||0)+u)},Ye=ne(()=>S.value?typeof S.value.defence=="object"&&S.value.defence!==null:!1),Ms=()=>{var O;if(S.value)if(Ye.value){const u=(O=S.value.defence)==null?void 0:O.front;S.value.defence=(u==null?void 0:u.melee)||0}else{const u=S.value.defence||0;S.value.defence={front:{melee:u,ranged:u}}}},fe=(O,u,be)=>{!S.value||!Ye.value||(S.value.defence[O]||(S.value.defence[O]={melee:0,ranged:0}),S.value.defence[O][u]=(S.value.defence[O][u]||0)+be)},I=O=>{if(!S.value||!Ye.value)return;const u={...S.value.defence};delete u[O],S.value.defence=u},Fe=O=>{!S.value||!Ye.value||(S.value.defence={...S.value.defence,[O]:{melee:0,ranged:0}})};return Gt(()=>{var O;return(O=o.character.equipment)==null?void 0:O.activeSetIndex},O=>{O!==void 0&&O!==y.value&&(y.value=O)}),(O,u)=>{var be,ze,ut,xt,Dt,Ht,ns,Ft,V,ht,Tt,Qt,rn,Ws,As,Nt,ls,ps,kt,zs,Ds,Cs,Vs,cn,Bs,dn,un,mn;return s(),n("div",d1,[e("div",u1,[e("div",m1,[A(i(p),{icon:"mdi:shield",class:"stat-icon def"}),e("span",v1,h(Be.value.defence),1),u[91]||(u[91]=e("span",{class:"stat-label"},"Защита",-1))]),e("div",f1,[A(i(p),{icon:"mdi:water",class:"stat-icon res"}),e("span",A1,h(Be.value.resist),1),u[92]||(u[92]=e("span",{class:"stat-label"},"Резист",-1))]),Be.value.attackShort!==null?(s(),n("div",p1,[A(i(p),{icon:"mdi:knife",class:"stat-icon atk"}),e("span",h1,h(P(Be.value.attackShort)),1),u[93]||(u[93]=e("span",{class:"stat-label"},"Ближ.",-1))])):_("",!0),Be.value.attackLong!==null?(s(),n("div",g1,[A(i(p),{icon:"mdi:spear",class:"stat-icon atk"}),e("span",y1,h(P(Be.value.attackLong)),1),u[94]||(u[94]=e("span",{class:"stat-label"},"Даль.",-1))])):_("",!0),Be.value.attackRanged!==null?(s(),n("div",b1,[A(i(p),{icon:"mdi:bow-arrow",class:"stat-icon rng"}),e("span",k1,h(P(Be.value.attackRanged)),1),u[95]||(u[95]=e("span",{class:"stat-label"},"Стрел.",-1))])):_("",!0),Be.value.movement?(s(),n("div",x1,[A(i(p),{icon:"mdi:run",class:"stat-icon mov"}),e("span",{class:Q(["stat-value",Be.value.movement>0?"positive":"negative"])},h(Be.value.movement>0?"+":"")+h(Be.value.movement),3),u[96]||(u[96]=e("span",{class:"stat-label"},"Движ.",-1))])):_("",!0)]),e("div",{class:Q(["doll-container",{animating:X.value,"anim-up":U.value==="up","anim-down":U.value==="down"}])},[e("div",w1,[e("div",{class:"slot-item prev",onClick:u[0]||(u[0]=G=>ot("up"))},[e("div",{class:Q(["weapon-slot ghost",{"two-handed":de(z.value).isTwoHanded}])},[de(z.value).left?(s(),n("img",{key:0,src:i(Jt)(de(z.value).left.id),class:"weapon-img"},null,8,C1)):(s(),st(i(p),{key:1,icon:"mdi:hand-back-left",class:"empty-icon"})),de(z.value).isTwoHanded?(s(),n("div",$1,[A(i(p),{icon:"mdi:link-variant"})])):_("",!0)],2)]),e("div",_1,[e("div",{class:Q(["weapon-slot",{occupied:H.value.left,"two-handed":H.value.isTwoHanded}]),onClick:u[2]||(u[2]=G=>H.value.left&&ke(H.value.left))},[H.value.left?(s(),n("img",{key:0,src:i(Jt)(H.value.left.id),alt:H.value.left.name,class:"weapon-img"},null,8,T1)):(s(),st(i(p),{key:1,icon:"mdi:hand-back-left",class:"empty-icon"})),H.value.isTwoHanded?(s(),n("div",I1,[A(i(p),{icon:"mdi:link-variant"})])):_("",!0),H.value.left?(s(),n("button",{key:3,onClick:u[1]||(u[1]=lt(G=>xe(H.value.left.id),["stop"])),class:"remove-btn"},[A(i(p),{icon:"mdi:close"})])):_("",!0)],2),e("span",S1,h(H.value.isTwoHanded?"2H":"Левая"),1)]),e("div",{class:"slot-item next",onClick:u[3]||(u[3]=G=>ot("down"))},[e("div",{class:Q(["weapon-slot ghost",{"two-handed":de(q.value).isTwoHanded}])},[de(q.value).left?(s(),n("img",{key:0,src:i(Jt)(de(q.value).left.id),class:"weapon-img"},null,8,E1)):(s(),st(i(p),{key:1,icon:"mdi:hand-back-left",class:"empty-icon"})),de(q.value).isTwoHanded?(s(),n("div",P1,[A(i(p),{icon:"mdi:link-variant"})])):_("",!0)],2)])]),e("div",M1,[e("div",{class:"armor-slot",onClick:u[4]||(u[4]=G=>t.isMaster||$e.value.length>1?Y.value=!0:ke(M.value))},[M.value?(s(),n("img",{key:0,src:i(Jt)(M.value.id),alt:M.value.name,class:"armor-img"},null,8,D1)):_("",!0),e("div",B1,[e("span",R1,[A(i(p),{icon:"mdi:shield"}),Ce(h(((be=M.value)==null?void 0:be.defence)||0),1)]),e("span",F1,[A(i(p),{icon:"mdi:water"}),Ce(h(((ze=M.value)==null?void 0:ze.resist)||0),1)])])]),e("span",L1,h(((ut=M.value)==null?void 0:ut.name)||"Нет брони"),1),e("div",{class:"set-name-display",onClick:u[6]||(u[6]=G=>Te(y.value))},[F.value===y.value?De((s(),n("input",{key:0,"onUpdate:modelValue":u[5]||(u[5]=G=>ie.value=G),class:"set-name-input",onBlur:$,onKeyup:ks($,["enter"]),autofocus:""},null,544)),[[je,ie.value]]):(s(),n(ee,{key:1},[A(i(p),{icon:"mdi:pencil",class:"edit-icon"}),e("span",null,h(he.value.name),1)],64))])]),e("div",N1,[e("div",{class:"slot-item prev",onClick:u[7]||(u[7]=G=>ot("up"))},[e("div",{class:Q(["weapon-slot ghost",{"two-handed":de(z.value).isTwoHanded}])},[de(z.value).right?(s(),n("img",{key:0,src:i(Jt)(de(z.value).right.id),class:"weapon-img"},null,8,O1)):(s(),st(i(p),{key:1,icon:"mdi:hand-back-right",class:"empty-icon"})),de(z.value).isTwoHanded?(s(),n("div",H1,[A(i(p),{icon:"mdi:link-variant"})])):_("",!0)],2)]),e("div",q1,[e("div",{class:Q(["weapon-slot",{occupied:H.value.right,"two-handed":H.value.isTwoHanded}]),onClick:u[9]||(u[9]=G=>H.value.right&&ke(H.value.right))},[H.value.right?(s(),n("img",{key:0,src:i(Jt)(H.value.right.id),alt:(xt=H.value.right)==null?void 0:xt.name,class:"weapon-img"},null,8,U1)):(s(),st(i(p),{key:1,icon:"mdi:hand-back-right",class:"empty-icon"})),H.value.isTwoHanded?(s(),n("div",W1,[A(i(p),{icon:"mdi:link-variant"})])):_("",!0),H.value.right&&!H.value.isTwoHanded?(s(),n("button",{key:3,onClick:u[8]||(u[8]=lt(G=>xe(H.value.right.id),["stop"])),class:"remove-btn"},[A(i(p),{icon:"mdi:close"})])):_("",!0)],2),e("span",z1,h(H.value.isTwoHanded?"2H":"Правая"),1)]),e("div",{class:"slot-item next",onClick:u[10]||(u[10]=G=>ot("down"))},[e("div",{class:Q(["weapon-slot ghost",{"two-handed":de(q.value).isTwoHanded}])},[de(q.value).right?(s(),n("img",{key:0,src:i(Jt)(de(q.value).right.id),class:"weapon-img"},null,8,V1)):(s(),st(i(p),{key:1,icon:"mdi:hand-back-right",class:"empty-icon"})),de(q.value).isTwoHanded?(s(),n("div",Q1,[A(i(p),{icon:"mdi:link-variant"})])):_("",!0)],2)])])],2),e("div",j1,[e("div",G1,[(s(!0),n(ee,null,me(L.value,G=>(s(),n("div",{key:G.id,class:Q(["carousel-item",{equipped:(he.value.weapons||[]).includes(G.id),disabled:!(he.value.weapons||[]).includes(G.id)&&!Je(G.id)}]),onClick:Mt=>ke(G)},[e("img",{src:i(Jt)(G.id),alt:G.name},null,8,X1),(he.value.weapons||[]).includes(G.id)?(s(),n("div",Z1,[A(i(p),{icon:"mdi:check"})])):_("",!0)],10,Y1))),128)),L.value.length===0?(s(),n("div",J1,"Нет оружия")):_("",!0)]),e("div",K1,[e("button",{class:Q(["action-btn backpack",{"has-items":Ae.value.length>0}]),onClick:u[11]||(u[11]=G=>Z.value=!0)},[A(i(p),{icon:"mdi:bag-personal"}),Ae.value.length?(s(),n("span",e0,h(Ae.value.length),1)):_("",!0)],2),t.isMaster?(s(),n("button",{key:0,class:"action-btn add-set",onClick:We},[A(i(p),{icon:"mdi:plus"})])):_("",!0),t.isMaster&&oe.value.length>2?(s(),n("button",{key:1,class:"action-btn delete-set",onClick:u[12]||(u[12]=G=>ce(y.value))},[A(i(p),{icon:"mdi:delete"})])):_("",!0)])]),(s(),st(Vt,{to:"body"},[B.value&&m.value?(s(),n("div",{key:0,class:"modal-overlay",onClick:ge},[e("div",{class:Q(["item-modal",[`category-${m.value.category||"item"}`]]),onClick:u[27]||(u[27]=lt(()=>{},["stop"]))},[e("div",t0,[e("div",s0,[e("img",{src:m.value.customImage?i(Gn)(m.value.customImage):i(Jt)(m.value.id),alt:m.value.name},null,8,n0),m.value.category==="quest"?(s(),st(i(p),{key:0,icon:"mdi:exclamation-thick",class:"category-badge quest"})):m.value.category==="accessory"?(s(),st(i(p),{key:1,icon:"mdi:ring",class:"category-badge accessory"})):_("",!0)]),e("div",l0,[e("h3",{class:Q([`category-text-${m.value.category||"item"}`])},h(m.value.name),3),m.value.attack&&typeof m.value.attack=="object"?(s(),n("div",o0,[e("div",{class:Q(["attack-chip clickable",{negative:m.value.attack.short<0,disabled:m.value.attack.short===void 0,selected:((Dt=D.value)==null?void 0:Dt.key)==="attack_short"}]),onClick:u[13]||(u[13]=G=>ae("attack_short"))},[A(i(p),{icon:"mdi:knife"}),e("span",null,h(m.value.attack.short!==void 0?P(m.value.attack.short):"—"),1)],2),e("div",{class:Q(["attack-chip clickable",{negative:m.value.attack.long<0,disabled:m.value.attack.long===void 0,selected:((Ht=D.value)==null?void 0:Ht.key)==="attack_long"}]),onClick:u[14]||(u[14]=G=>ae("attack_long"))},[A(i(p),{icon:"mdi:spear"}),e("span",null,h(m.value.attack.long!==void 0?P(m.value.attack.long):"—"),1)],2),m.value.attack.ranged!==void 0?(s(),n("div",{key:0,class:Q(["attack-chip ranged clickable",{negative:m.value.attack.ranged<0,selected:((ns=D.value)==null?void 0:ns.key)==="attack_ranged"}]),onClick:u[15]||(u[15]=G=>ae("attack_ranged"))},[A(i(p),{icon:"mdi:bow-arrow"}),e("span",null,h(P(m.value.attack.ranged)),1)],2)):_("",!0)])):_("",!0)]),e("button",{onClick:ge,class:"close-btn"},[A(i(p),{icon:"mdi:close"})])]),e("div",a0,[e("div",i0,[typeof m.value.defence=="number"&&m.value.defence>0?(s(),n("div",{key:0,class:Q(["stat-chip clickable",{selected:((Ft=D.value)==null?void 0:Ft.key)==="defence"}]),onClick:u[16]||(u[16]=G=>ae("defence"))},[A(i(p),{icon:"mdi:shield"}),e("span",null,h(m.value.defence),1),u[97]||(u[97]=e("span",{class:"label"},"защита",-1))],2)):_("",!0),m.value.armorPen>0?(s(),n("div",{key:1,class:Q(["stat-chip clickable",{selected:((V=D.value)==null?void 0:V.key)==="armorPen"}]),onClick:u[17]||(u[17]=G=>ae("armorPen"))},[A(i(p),{icon:"mdi:shield-off"}),e("span",null,h(m.value.armorPen),1),u[98]||(u[98]=e("span",{class:"label"},"пробив.",-1))],2)):_("",!0),m.value.damageType?(s(),n("div",{key:2,class:Q(["stat-chip type clickable",{selected:((ht=D.value)==null?void 0:ht.key)==="damageType"}]),onClick:u[18]||(u[18]=G=>ae("damageType"))},[A(i(p),{icon:"mdi:fire"}),e("span",null,h(m.value.damageType),1)],2)):_("",!0)]),typeof m.value.defence=="object"?(s(),n("div",r0,[e("div",c0,[u[101]||(u[101]=e("div",{class:"shield-row header"},[e("div",{class:"shield-cell"}),e("div",{class:"shield-cell"},"Ближ."),e("div",{class:"shield-cell"},"Дальн.")],-1)),m.value.defence.front?(s(),n("div",d0,[u[99]||(u[99]=e("div",{class:"shield-cell label"},"Спереди",-1)),e("div",u0,h(m.value.defence.front.melee||0),1),e("div",m0,h(m.value.defence.front.ranged||0),1)])):_("",!0),m.value.defence.side?(s(),n("div",v0,[u[100]||(u[100]=e("div",{class:"shield-cell label"},"С фланга",-1)),e("div",f0,h(m.value.defence.side.melee||0),1),e("div",A0,h(m.value.defence.side.ranged||0),1)])):_("",!0)])])):_("",!0),m.value.damage?(s(),n("div",p0,[e("div",h0,[(s(!0),n(ee,null,me(i(f),G=>{var Mt,ds;return s(),n("div",{key:G.key,class:Q(["damage-level clickable",{active:Ze(m.value,G.key)!==null,selected:((Mt=D.value)==null?void 0:Mt.type)==="damage"&&((ds=D.value)==null?void 0:ds.key)===G.key}]),style:Qe(vt(G,Ze(m.value,G.key)!==null)),onClick:Qs=>Xe(G,Ze(m.value,G.key))},[e("div",y0,h(G.short),1),Ze(m.value,G.key)!==null?(s(),n("div",b0," +"+h(Ze(m.value,G.key)),1)):_("",!0)],14,g0)}),128))])])):_("",!0),m.value.spec||m.value.special?(s(),n("div",k0,[A(i(p),{icon:"mdi:star-four-points"}),e("span",null,h(m.value.special||m.value.spec),1)])):_("",!0),m.value.desc?(s(),n("div",x0,h(m.value.desc),1)):_("",!0),e("div",w0,[m.value.price!==void 0?(s(),n("div",{key:0,class:Q(["info-chip clickable",{selected:((Tt=D.value)==null?void 0:Tt.key)==="price"}]),onClick:u[19]||(u[19]=G=>ae("price"))},[A(i(p),{icon:"mdi:gold"}),e("span",null,h(m.value.price),1)],2)):_("",!0),m.value.epoch!==void 0?(s(),n("div",{key:1,class:Q(["info-chip clickable",{selected:((Qt=D.value)==null?void 0:Qt.key)==="epoch"}]),onClick:u[20]||(u[20]=G=>ae("epoch"))},[A(i(p),{icon:"mdi:clock-outline"}),e("span",null,h(m.value.epoch),1)],2)):_("",!0),m.value.length?(s(),n("div",{key:2,class:Q(["info-chip clickable",{selected:((rn=D.value)==null?void 0:rn.key)==="length"}]),onClick:u[21]||(u[21]=G=>ae("length"))},[A(i(p),{icon:m.value.length===2?"mdi:arrow-expand-horizontal":"mdi:minus"},null,8,["icon"]),e("span",null,h(J(m.value.length)),1)],2)):_("",!0),m.value.hands?(s(),n("div",{key:3,class:Q(["info-chip clickable",{selected:((Ws=D.value)==null?void 0:Ws.key)==="hands"}]),onClick:u[22]||(u[22]=G=>ae("hands"))},[A(i(p),{icon:"mdi:hand-back-left"}),e("span",null,h(te(m.value.hands)),1)],2)):_("",!0)]),D.value?(s(),n("div",C0,[e("div",$0,h(D.value.title),1),e("div",_0,h(D.value.text),1)])):(s(),n("div",T0,[A(i(p),{icon:"mdi:gesture-tap"}),u[102]||(u[102]=e("span",null,"Нажмите на любой элемент для подробностей",-1))]))]),e("div",I0,[m.value.category==="weapon"||m.value.category==="shield"?(s(),n(ee,{key:0},[(he.value.weapons||[]).includes(m.value.id)?(s(),n("button",{key:0,onClick:u[23]||(u[23]=G=>{xe(m.value.id),ge()}),class:"btn warning"},[A(i(p),{icon:"mdi:minus-circle"}),u[103]||(u[103]=Ce("Убрать ",-1))])):Je(m.value.id)?(s(),n("button",{key:1,onClick:u[24]||(u[24]=G=>{Ke(m.value.id),ge()}),class:"btn primary"},[A(i(p),{icon:"mdi:plus-circle"}),u[104]||(u[104]=Ce("Взять ",-1))])):(s(),n("button",S0,[A(i(p),{icon:"mdi:block-helper"}),u[105]||(u[105]=Ce("Нельзя добавить ",-1))]))],64)):_("",!0),t.isMaster?(s(),n("button",{key:1,onClick:u[25]||(u[25]=G=>N(m.value)),class:"btn edit"},[A(i(p),{icon:"mdi:pencil"}),u[106]||(u[106]=Ce("Редактировать ",-1))])):_("",!0),t.isMaster&&m.value.id!==((As=M.value)==null?void 0:As.id)&&!oe.value.some(G=>(G.weapons||[]).includes(m.value.id))?(s(),n("button",{key:2,onClick:u[26]||(u[26]=G=>{Re(m.value.id),ge()}),class:"btn danger"},[A(i(p),{icon:"mdi:delete"}),u[107]||(u[107]=Ce("Удалить ",-1))])):_("",!0),e("button",{onClick:ge,class:"btn close"},"Закрыть")])],2)])):_("",!0)])),(s(),st(Vt,{to:"body"},[Y.value?(s(),n("div",{key:0,class:"modal-overlay",onClick:u[30]||(u[30]=G=>Y.value=!1)},[e("div",{class:"armor-modal",onClick:u[29]||(u[29]=lt(()=>{},["stop"]))},[e("div",E0,[u[108]||(u[108]=e("h3",null,"Выбрать броню",-1)),e("button",{onClick:u[28]||(u[28]=G=>Y.value=!1),class:"close-btn"},[A(i(p),{icon:"mdi:close"})])]),e("div",P0,[(s(!0),n(ee,null,me(t.isMaster?c.value:$e.value,G=>{var Mt;return s(),n("div",{key:G.id,class:Q(["armor-option",{selected:((Mt=M.value)==null?void 0:Mt.id)===G.id}]),onClick:ds=>Me(G.id)},[e("img",{src:i(Jt)(G.id),alt:G.name},null,8,D0),e("div",B0,[e("span",R0,h(G.name),1),e("div",F0,[e("span",null,"🛡️"+h(G.defence),1),e("span",null,"💧"+h(G.resist),1),G.movement?(s(),n("span",L0,"👟"+h(G.movement),1)):_("",!0)])])],10,M0)}),128))])])])):_("",!0)])),(s(),st(Vt,{to:"body"},[j.value?(s(),st(c1,{key:0,title:"Добавить предмет в инвентарь","allow-custom":!0,onSelect:Pe,onCreateCustom:dt,onClose:u[31]||(u[31]=G=>j.value=!1)})):_("",!0)])),(s(),st(Vt,{to:"body"},[W.value&&S.value&&t.isMaster?(s(),n("div",{key:0,class:"modal-overlay",onClick:rt},[e("div",{class:Q(["edit-item-modal",{creating:At.value,[`category-${S.value.category||"item"}`]:!0}]),onClick:u[86]||(u[86]=lt(()=>{},["stop"]))},[e("div",N0,[e("h3",null,h(At.value?"Создание предмета":"Редактирование предмета"),1),!At.value&&Et(S.value.id)?(s(),n("div",O0,[A(i(p),{icon:"mdi:pencil-circle"}),u[109]||(u[109]=Ce("изменён ",-1))])):_("",!0),e("button",{onClick:rt,class:"close-btn"},[A(i(p),{icon:"mdi:close"})])]),e("div",H0,[e("div",q0,[A(Po,{modelValue:S.value.customImage,"onUpdate:modelValue":u[32]||(u[32]=G=>S.value.customImage=G),category:"items","fallback-id":S.value.id,size:72},null,8,["modelValue","fallback-id"]),e("div",U0,[De(e("input",{"onUpdate:modelValue":u[33]||(u[33]=G=>S.value.name=G),type:"text",class:"edit-name-input",placeholder:"Название предмета"},null,512),[[je,S.value.name]]),e("div",W0,[(s(),n(ee,null,me($t,G=>e("button",{key:G.value,class:Q({active:S.value.category===G.value,[G.value]:!0}),title:G.label,onClick:Mt=>S.value.category=G.value},[A(i(p),{icon:G.icon},null,8,["icon"])],10,z0)),64))])])]),e("div",V0,[S.value.category==="weapon"||S.value.category==="shield"?(s(),n("div",Q0,[(s(),n(ee,null,me(re,G=>e("button",{key:G.value,class:Q({active:S.value.subcat===G.value}),title:G.value,onClick:Mt=>S.value.subcat=G.value},[A(i(p),{icon:G.icon},null,8,["icon"])],10,j0)),64))])):S.value.category==="armor"?(s(),n("div",G0,[(s(),n(ee,null,me(ye,G=>e("button",{key:G.value,class:Q({active:S.value.subcat===G.value}),title:G.value,onClick:Mt=>S.value.subcat=G.value},[A(i(p),{icon:G.icon},null,8,["icon"])],10,Y0)),64))])):S.value.category==="accessory"?(s(),n("div",X0,[(s(),n(ee,null,me(pe,G=>e("button",{key:G.value,class:Q({active:S.value.subcat===G.value}),title:G.value,onClick:Mt=>S.value.subcat=G.value},[A(i(p),{icon:G.icon},null,8,["icon"])],10,Z0)),64))])):(s(),n("div",J0)),e("div",K0,[e("div",ey,[A(i(p),{icon:"mdi:gold",class:"gold"}),De(e("input",{"onUpdate:modelValue":u[34]||(u[34]=G=>S.value.price=G),type:"number",min:"0",max:"15"},null,512),[[je,S.value.price,void 0,{number:!0}]])]),e("div",ty,[A(i(p),{icon:"mdi:clock-outline",class:"epoch"}),De(e("input",{"onUpdate:modelValue":u[35]||(u[35]=G=>S.value.epoch=G),type:"number",min:"1",max:"10"},null,512),[[je,S.value.epoch,void 0,{number:!0}]])])])]),S.value.category==="weapon"||S.value.category==="shield"?(s(),n(ee,{key:0},[e("div",sy,[e("div",ny,[e("span",ly,[A(i(p),{icon:"mdi:hand-back-left"}),u[110]||(u[110]=Ce("Руки",-1))]),e("div",oy,[e("button",{class:Q({active:S.value.hands===.5}),onClick:u[36]||(u[36]=G=>S.value.hands=.5)},"½",2),e("button",{class:Q({active:S.value.hands===1}),onClick:u[37]||(u[37]=G=>S.value.hands=1)},"1",2),e("button",{class:Q({active:S.value.hands===1.5}),onClick:u[38]||(u[38]=G=>S.value.hands=1.5)},"1½",2),e("button",{class:Q({active:S.value.hands===2}),onClick:u[39]||(u[39]=G=>S.value.hands=2)},"2",2)])]),e("div",ay,[e("span",iy,[A(i(p),{icon:"mdi:arrow-expand-horizontal"}),u[111]||(u[111]=Ce("Длина",-1))]),e("div",ry,[e("button",{class:Q({active:S.value.length===1}),onClick:u[40]||(u[40]=G=>S.value.length=1)},[A(i(p),{icon:"mdi:minus"})],2),e("button",{class:Q({active:S.value.length===2}),onClick:u[41]||(u[41]=G=>S.value.length=2)},[A(i(p),{icon:"mdi:arrow-left-right"})],2)])])]),e("div",cy,[e("div",{class:Q(["stat-cell attack",{empty:((Nt=S.value.attack)==null?void 0:Nt.short)===void 0}])},[e("div",dy,[A(i(p),{icon:"mdi:knife"}),u[112]||(u[112]=Ce("Ближ.",-1))]),e("div",uy,[e("button",{class:"adj-btn",onClick:u[42]||(u[42]=G=>Rt("short",-1))},[A(i(p),{icon:"mdi:minus"})]),e("span",{class:Q({negative:(((ls=S.value.attack)==null?void 0:ls.short)??0)<0}),onDblclick:u[43]||(u[43]=G=>gt("short"))},h(((ps=S.value.attack)==null?void 0:ps.short)??"—"),35),e("button",{class:"adj-btn",onClick:u[44]||(u[44]=G=>Rt("short",1))},[A(i(p),{icon:"mdi:plus"})])])],2),e("div",{class:Q(["stat-cell attack",{empty:((kt=S.value.attack)==null?void 0:kt.long)===void 0}])},[e("div",my,[A(i(p),{icon:"mdi:spear"}),u[113]||(u[113]=Ce("Длин.",-1))]),e("div",vy,[e("button",{class:"adj-btn",onClick:u[45]||(u[45]=G=>Rt("long",-1))},[A(i(p),{icon:"mdi:minus"})]),e("span",{class:Q({negative:(((zs=S.value.attack)==null?void 0:zs.long)??0)<0}),onDblclick:u[46]||(u[46]=G=>gt("long"))},h(((Ds=S.value.attack)==null?void 0:Ds.long)??"—"),35),e("button",{class:"adj-btn",onClick:u[47]||(u[47]=G=>Rt("long",1))},[A(i(p),{icon:"mdi:plus"})])])],2),e("div",{class:Q(["stat-cell attack ranged",{empty:((Cs=S.value.attack)==null?void 0:Cs.ranged)===void 0}])},[e("div",fy,[A(i(p),{icon:"mdi:bow-arrow"}),u[114]||(u[114]=Ce("Дальн.",-1))]),e("div",Ay,[e("button",{class:"adj-btn",onClick:u[48]||(u[48]=G=>Rt("ranged",-1))},[A(i(p),{icon:"mdi:minus"})]),e("span",{class:Q({negative:(((Vs=S.value.attack)==null?void 0:Vs.ranged)??0)<0}),onDblclick:u[49]||(u[49]=G=>gt("ranged"))},h(((cn=S.value.attack)==null?void 0:cn.ranged)??"—"),35),e("button",{class:"adj-btn",onClick:u[50]||(u[50]=G=>Rt("ranged",1))},[A(i(p),{icon:"mdi:plus"})])])],2),e("div",py,[e("div",hy,[A(i(p),{icon:"mdi:shield-off"}),u[115]||(u[115]=Ce("Пробив.",-1))]),e("div",gy,[e("button",{class:"adj-btn",onClick:u[51]||(u[51]=G=>bt("armorPen",-1))},[A(i(p),{icon:"mdi:minus"})]),e("span",null,h(S.value.armorPen??0),1),e("button",{class:"adj-btn",onClick:u[52]||(u[52]=G=>bt("armorPen",1))},[A(i(p),{icon:"mdi:plus"})])])])]),e("div",yy,[e("div",by,[e("span",ky,[A(i(p),{icon:"mdi:shield"}),u[116]||(u[116]=Ce("Защита",-1))]),e("button",{class:"mode-toggle",onClick:Ms,title:Ye.value?"Простая защита":"Сложная защита (для щитов)"},[A(i(p),{icon:Ye.value?"mdi:view-grid":"mdi:numeric"},null,8,["icon"]),Ce(" "+h(Ye.value?"Сложная":"Простая"),1)],8,xy)]),Ye.value?(s(),n("div",_y,[(Bs=S.value.defence)!=null&&Bs.front?(s(),n("div",Ty,[e("div",Iy,[A(i(p),{icon:"mdi:arrow-up-bold"}),u[117]||(u[117]=Ce("Спереди ",-1)),e("button",{class:"remove-btn",onClick:u[55]||(u[55]=G=>I("front")),title:"Удалить"},[A(i(p),{icon:"mdi:close"})])]),e("div",Sy,[e("div",Ey,[e("span",Py,[A(i(p),{icon:"mdi:sword-cross"})]),e("button",{class:"adj-btn",onClick:u[56]||(u[56]=G=>fe("front","melee",-1))},[A(i(p),{icon:"mdi:minus"})]),e("span",My,h(S.value.defence.front.melee??0),1),e("button",{class:"adj-btn",onClick:u[57]||(u[57]=G=>fe("front","melee",1))},[A(i(p),{icon:"mdi:plus"})])]),e("div",Dy,[e("span",By,[A(i(p),{icon:"mdi:bow-arrow"})]),e("button",{class:"adj-btn",onClick:u[58]||(u[58]=G=>fe("front","ranged",-1))},[A(i(p),{icon:"mdi:minus"})]),e("span",Ry,h(S.value.defence.front.ranged??0),1),e("button",{class:"adj-btn",onClick:u[59]||(u[59]=G=>fe("front","ranged",1))},[A(i(p),{icon:"mdi:plus"})])])])])):_("",!0),(dn=S.value.defence)!=null&&dn.side?(s(),n("div",Fy,[e("div",Ly,[A(i(p),{icon:"mdi:arrow-left-right-bold"}),u[118]||(u[118]=Ce("С боков ",-1)),e("button",{class:"remove-btn",onClick:u[60]||(u[60]=G=>I("side")),title:"Удалить"},[A(i(p),{icon:"mdi:close"})])]),e("div",Ny,[e("div",Oy,[e("span",Hy,[A(i(p),{icon:"mdi:sword-cross"})]),e("button",{class:"adj-btn",onClick:u[61]||(u[61]=G=>fe("side","melee",-1))},[A(i(p),{icon:"mdi:minus"})]),e("span",qy,h(S.value.defence.side.melee??0),1),e("button",{class:"adj-btn",onClick:u[62]||(u[62]=G=>fe("side","melee",1))},[A(i(p),{icon:"mdi:plus"})])]),e("div",Uy,[e("span",Wy,[A(i(p),{icon:"mdi:bow-arrow"})]),e("button",{class:"adj-btn",onClick:u[63]||(u[63]=G=>fe("side","ranged",-1))},[A(i(p),{icon:"mdi:minus"})]),e("span",zy,h(S.value.defence.side.ranged??0),1),e("button",{class:"adj-btn",onClick:u[64]||(u[64]=G=>fe("side","ranged",1))},[A(i(p),{icon:"mdi:plus"})])])])])):_("",!0),e("div",Vy,[(un=S.value.defence)!=null&&un.front?_("",!0):(s(),n("button",{key:0,class:"add-direction-btn",onClick:u[65]||(u[65]=G=>Fe("front"))},[A(i(p),{icon:"mdi:plus"}),u[119]||(u[119]=Ce("Спереди ",-1))])),(mn=S.value.defence)!=null&&mn.side?_("",!0):(s(),n("button",{key:1,class:"add-direction-btn",onClick:u[66]||(u[66]=G=>Fe("side"))},[A(i(p),{icon:"mdi:plus"}),u[120]||(u[120]=Ce("С боков ",-1))]))])])):(s(),n("div",wy,[e("div",Cy,[e("div",$y,[e("button",{class:"adj-btn",onClick:u[53]||(u[53]=G=>bt("defence",-1))},[A(i(p),{icon:"mdi:minus"})]),e("span",null,h(S.value.defence??0),1),e("button",{class:"adj-btn",onClick:u[54]||(u[54]=G=>bt("defence",1))},[A(i(p),{icon:"mdi:plus"})])])])]))]),e("div",Qy,[De(e("input",{"onUpdate:modelValue":u[67]||(u[67]=G=>S.value.damageType=G),type:"text",class:"damage-type-input",placeholder:"Тип урона"},null,512),[[je,S.value.damageType]])]),e("div",jy,[(s(!0),n(ee,null,me(i(f),G=>{var Mt,ds,Qs,Rs,js;return s(),n("div",{key:G.key,class:Q(["damage-level-cell",{"light-text":G.lightText,"has-value":((Mt=S.value.damage)==null?void 0:Mt[G.key])!==void 0}]),style:Qe({"--level-color":G.color}),title:((Qs=(ds=G.names)==null?void 0:ds.damage)==null?void 0:Qs.ru)||G.short},[e("button",{class:"adj-btn top",onClick:Gs=>Ue(G.key,1)},[A(i(p),{icon:"mdi:chevron-up"})],8,Yy),e("div",{class:Q(["damage-value",{empty:((Rs=S.value.damage)==null?void 0:Rs[G.key])===void 0}]),onDblclick:Gs=>Wt(G.key)},h(((js=S.value.damage)==null?void 0:js[G.key])??"—"),43,Xy),e("button",{class:"adj-btn bottom",onClick:Gs=>Ue(G.key,-1)},[A(i(p),{icon:"mdi:chevron-down"})],8,Zy)],14,Gy)}),128))])],64)):_("",!0),S.value.category==="armor"?(s(),n("div",Jy,[e("div",Ky,[e("div",eb,[A(i(p),{icon:"mdi:shield"}),u[121]||(u[121]=Ce("Защита",-1))]),e("div",tb,[e("button",{class:"adj-btn",onClick:u[68]||(u[68]=G=>bt("defence",-1))},[A(i(p),{icon:"mdi:minus"})]),e("span",null,h(S.value.defence??0),1),e("button",{class:"adj-btn",onClick:u[69]||(u[69]=G=>bt("defence",1))},[A(i(p),{icon:"mdi:plus"})])])]),e("div",sb,[e("div",nb,[A(i(p),{icon:"mdi:shield-half-full"}),u[122]||(u[122]=Ce("Сопрот.",-1))]),e("div",lb,[e("button",{class:"adj-btn",onClick:u[70]||(u[70]=G=>bt("resist",-1))},[A(i(p),{icon:"mdi:minus"})]),e("span",null,h(S.value.resist??0),1),e("button",{class:"adj-btn",onClick:u[71]||(u[71]=G=>bt("resist",1))},[A(i(p),{icon:"mdi:plus"})])])]),e("div",ob,[e("div",ab,[A(i(p),{icon:"mdi:run"}),u[123]||(u[123]=Ce("Движ.",-1))]),e("div",ib,[e("button",{class:"adj-btn",onClick:u[72]||(u[72]=G=>bt("movement",-1))},[A(i(p),{icon:"mdi:minus"})]),e("span",{class:Q({negative:(S.value.movement||0)<0})},h(S.value.movement??0),3),e("button",{class:"adj-btn",onClick:u[73]||(u[73]=G=>bt("movement",1))},[A(i(p),{icon:"mdi:plus"})])])]),e("div",rb,[e("div",cb,[A(i(p),{icon:"mdi:flash"}),u[124]||(u[124]=Ce("Порывы",-1))]),e("div",db,[e("button",{class:"adj-btn",onClick:u[74]||(u[74]=G=>bt("bursts",-1))},[A(i(p),{icon:"mdi:minus"})]),e("span",{class:Q({negative:(S.value.bursts||0)<0})},h(S.value.bursts??0),3),e("button",{class:"adj-btn",onClick:u[75]||(u[75]=G=>bt("bursts",1))},[A(i(p),{icon:"mdi:plus"})])])])])):_("",!0),S.value.category==="accessory"?(s(),n(ee,{key:2},[e("div",ub,[A(i(p),{icon:"mdi:information-outline",class:"info-icon"}),u[125]||(u[125]=e("span",null,"Аксессуары работают, пока находятся в инвентаре. Эффект описывается в особых свойствах.",-1))]),e("div",mb,[e("div",vb,[e("div",fb,[A(i(p),{icon:"mdi:shield"}),u[126]||(u[126]=Ce("Защита",-1))]),e("div",Ab,[e("button",{class:"adj-btn",onClick:u[76]||(u[76]=G=>bt("defence",-1))},[A(i(p),{icon:"mdi:minus"})]),e("span",null,h(S.value.defence??0),1),e("button",{class:"adj-btn",onClick:u[77]||(u[77]=G=>bt("defence",1))},[A(i(p),{icon:"mdi:plus"})])])]),e("div",pb,[e("div",hb,[A(i(p),{icon:"mdi:shield-half-full"}),u[127]||(u[127]=Ce("Сопрот.",-1))]),e("div",gb,[e("button",{class:"adj-btn",onClick:u[78]||(u[78]=G=>bt("resist",-1))},[A(i(p),{icon:"mdi:minus"})]),e("span",null,h(S.value.resist??0),1),e("button",{class:"adj-btn",onClick:u[79]||(u[79]=G=>bt("resist",1))},[A(i(p),{icon:"mdi:plus"})])])]),e("div",yb,[e("div",bb,[A(i(p),{icon:"mdi:run"}),u[128]||(u[128]=Ce("Движ.",-1))]),e("div",kb,[e("button",{class:"adj-btn",onClick:u[80]||(u[80]=G=>bt("movement",-1))},[A(i(p),{icon:"mdi:minus"})]),e("span",{class:Q({negative:(S.value.movement||0)<0})},h(S.value.movement??0),3),e("button",{class:"adj-btn",onClick:u[81]||(u[81]=G=>bt("movement",1))},[A(i(p),{icon:"mdi:plus"})])])]),e("div",xb,[e("div",wb,[A(i(p),{icon:"mdi:flash"}),u[129]||(u[129]=Ce("Порывы",-1))]),e("div",Cb,[e("button",{class:"adj-btn",onClick:u[82]||(u[82]=G=>bt("bursts",-1))},[A(i(p),{icon:"mdi:minus"})]),e("span",{class:Q({negative:(S.value.bursts||0)<0})},h(S.value.bursts??0),3),e("button",{class:"adj-btn",onClick:u[83]||(u[83]=G=>bt("bursts",1))},[A(i(p),{icon:"mdi:plus"})])])])])],64)):_("",!0),e("div",$b,[e("div",_b,[A(i(p),{icon:"mdi:star"}),u[130]||(u[130]=Ce("Особые свойства",-1))]),De(e("textarea",{"onUpdate:modelValue":u[84]||(u[84]=G=>S.value.special=G),rows:"2",placeholder:"Игнорирует 2 очка защиты при критическом ударе..."},null,512),[[je,S.value.special]])]),e("div",Tb,[e("div",Ib,[A(i(p),{icon:"mdi:text"}),u[131]||(u[131]=Ce("Описание",-1))]),De(e("textarea",{"onUpdate:modelValue":u[85]||(u[85]=G=>S.value.desc=G),rows:"2",placeholder:"Описание предмета..."},null,512),[[je,S.value.desc]])])]),e("div",Sb,[!At.value&&!S.value.isCustom&&Et(S.value.id)?(s(),n("button",{key:0,onClick:ft,class:"btn warning"},[A(i(p),{icon:"mdi:restore"}),u[132]||(u[132]=Ce("Сбросить ",-1))])):_("",!0),e("button",{onClick:rt,class:"btn close"},"Отмена"),e("button",{onClick:Ge,class:"btn primary"},[A(i(p),{icon:"mdi:check"}),Ce(h(At.value?"Создать":"Сохранить"),1)])])],2)])):_("",!0)])),(s(),st(Vt,{to:"body"},[Z.value?(s(),n("div",{key:0,class:"modal-overlay",onClick:u[90]||(u[90]=G=>Z.value=!1)},[e("div",{class:"backpack-modal",onClick:u[89]||(u[89]=lt(()=>{},["stop"]))},[e("div",Eb,[e("div",Pb,[A(i(p),{icon:"mdi:bag-personal"}),u[133]||(u[133]=e("h3",null,"Рюкзак",-1)),e("span",Mb,"("+h(Ae.value.length)+")",1)]),e("button",{class:"close-btn",onClick:u[87]||(u[87]=G=>Z.value=!1)},[A(i(p),{icon:"mdi:close"})])]),e("div",Db,[(s(),n(ee,null,me({all:"Все",weapon:"Оружие",shield:"Щиты",armor:"Броня",other:"Прочее"},(G,Mt)=>e("button",{key:Mt,class:Q(["filter-btn",{active:K.value===Mt}]),onClick:ds=>K.value=Mt},[Ce(h(G)+" ",1),Se.value[Mt]?(s(),n("span",Rb,h(Se.value[Mt]),1)):_("",!0)],10,Bb)),64))]),e("div",Fb,[Ee.value.length?(s(),n("div",Lb,[(s(!0),n(ee,null,me(Ee.value,G=>(s(),n("div",{key:G._instanceId||G.id,class:Q(["backpack-item",[`category-${G.category||"item"}`]]),onClick:Mt=>{ke(G),Z.value=!1}},[e("div",Ob,[e("img",{src:G.customImage?i(Gn)(G.customImage):i(Jt)(G.id),alt:G.name,class:"item-img"},null,8,Hb),G.category==="quest"?(s(),st(i(p),{key:0,icon:"mdi:exclamation-thick",class:"category-icon quest"})):G.category==="accessory"?(s(),st(i(p),{key:1,icon:"mdi:ring",class:"category-icon accessory"})):_("",!0)]),e("div",qb,[e("span",Ub,h(G.name),1),e("span",Wb,h(G.category),1)]),t.isMaster?(s(),n("button",{key:0,onClick:lt(Mt=>Re(G._instanceId||G.id),["stop"]),class:"item-remove"},[A(i(p),{icon:"mdi:delete"})],8,zb)):_("",!0)],10,Nb))),128))])):(s(),n("div",Vb,[A(i(p),{icon:"mdi:bag-personal-off"}),e("span",null,h(K.value==="all"?"Рюкзак пуст":"Нет предметов в этой категории"),1)]))]),t.isMaster?(s(),n("div",Qb,[e("button",{class:"add-item-btn",onClick:u[88]||(u[88]=G=>{j.value=!0,Z.value=!1})},[A(i(p),{icon:"mdi:plus"}),u[134]||(u[134]=Ce("Добавить предмет ",-1))])])):_("",!0)])])):_("",!0)]))])}}},Gb=zt(jb,[["__scopeId","data-v-bec1e5b6"]]),Yb=[{id:"dwarf",name:"Дворфы",nameEn:"Dwarf",description:"Крепкие и стойкие мастера камня и металла, живущие в горных твердынях",icon:"🧔",position:{aspects:["war","knowledge"],description:"Между Войной и Знанием"},color:"amber",subraceAliases:{}},{id:"human",name:"Люди",nameEn:"Human",description:"Универсальные и адаптивные существа, способные проявить себя в любой сфере",icon:"👤",position:{aspects:["knowledge","community"],description:"Между Знанием и Обществом"},color:"slate",subraceAliases:{}},{id:"tiefling",name:"Тифлинги",nameEn:"Tiefling",description:"Существа с демоническим наследием, обладающие врождённой магией и харизмой",icon:"😈",position:{aspects:["community","shadow"],description:"Между Обществом и Тенью"},color:"purple",subraceAliases:{}},{id:"drow",name:"Дроу",nameEn:"Drow",description:"Тёмные эльфы подземий, мастера скрытности и магии теней",icon:"🕷️",position:{aspects:["shadow","mysticism"],description:"Между Тенью и Мистикой"},color:"gray",subraceAliases:{}},{id:"goblin",name:"Гоблины",nameEn:"Goblin",description:"Хитрые и изобретательные существа, выжившие благодаря смекалке",icon:"👺",position:{aspects:["mysticism","nature"],description:"Между Мистикой и Природой"},color:"green",subraceAliases:{}},{id:"orc",name:"Орки",nameEn:"Orc",description:"Могучие воины с первобытной силой и связью с природой",icon:"💪",position:{aspects:["nature","war"],description:"Между Природой и Войной"},color:"green",subraceAliases:{}},{id:"hobgoblin",name:"Хобгоблины",nameEn:"Hobgoblin",description:"Дисциплинированные и организованные военные стратеги",icon:"🎖️",position:{aspects:["war","community"],description:"Между Войной и Обществом"},color:"red",subraceAliases:{}},{id:"kobold",name:"Кобольды",nameEn:"Kobold",description:"Маленькие драконоподобные существа, изобретательные и хитрые",icon:"🦎",position:{aspects:["knowledge","shadow"],description:"Между Знанием и Тенью"},color:"orange",subraceAliases:{}},{id:"liminar",name:"Лиминары",nameEn:"Liminar",description:"Загадочные существа пограничных миров, обладающие глубокой связью с мистикой и обществом",icon:"✨",position:{aspects:["community","mysticism"],description:"Между Обществом и Мистикой"},color:"pink",subraceAliases:{}},{id:"shifter",name:"Шифтеры",nameEn:"Shifter",description:"Существа с ликантропическим наследием, способные менять облик",icon:"🐺",position:{aspects:["shadow","nature"],description:"Между Тенью и Природой"},color:"brown",subraceAliases:{}},{id:"ferrat",name:"Фераты",nameEn:"Ferrat",description:"Дикие гуманоиды с первобытной магией и боевыми инстинктами",icon:"🐉",position:{aspects:["mysticism","war"],description:"Между Мистикой и Войной"},color:"purple",subraceAliases:{}},{id:"elf",name:"Эльфы",nameEn:"Elf",description:"Грациозные и долгоживущие существа с глубокой связью с природой и знаниями",icon:"🧝",position:{aspects:["nature","knowledge"],description:"Между Природой и Знанием"},color:"emerald",subraceAliases:{}}],il={races:Yb};function Xb(t){var l;for(const o of nn.classes){const a=(l=o.traits)==null?void 0:l.find(r=>r.id===t);if(a)return{sourceType:"class",sourceId:o.id,trait:a}}return null}function Zb(t){var l;for(const o of Yt.aspects){const a=(l=o.traits)==null?void 0:l.find(r=>r.id===t);if(a)return{sourceType:"aspect",sourceId:o.id,trait:a}}return null}function Jb(t){var l;for(const o of il.races){const a=(l=o.traits)==null?void 0:l.find(r=>r.id===t);if(a)return{sourceType:"race",sourceId:o.id,trait:a}}return null}function Yn(t){return Xb(t)||Zb(t)||Jb(t)||null}function Kb(t){if(typeof t=="object"&&t!==null){if(t.id&&t.sourceType&&t.sourceId){const l={id:t.id,sourceType:t.sourceType,sourceId:t.sourceId,level:t.level||1,customDescriptions:t.customDescriptions||{},customTags:t.customTags||{}};return t.customColor&&(l.customColor=t.customColor),l}if(t.id){const l=Yn(t.id);if(l)return{id:t.id,sourceType:l.sourceType,sourceId:l.sourceId,level:t.level||1,customDescriptions:t.customDescriptions||t.customDescription?{[t.level||1]:t.customDescription}:{},customTags:t.customTags||{}}}return null}if(typeof t=="string"){const l=Yn(t);return l?{id:t,sourceType:l.sourceType,sourceId:l.sourceId,level:1,customDescriptions:{},customTags:{}}:(console.warn(`[SkillsMigration] Навык "${t}" не найден ни в одном источнике`),null)}return null}function ek(t){if(!Array.isArray(t))return{migrated:[],needsSave:!1};let l=!1;const o=[];for(const a of t){(typeof a=="string"||typeof a=="object"&&a&&!a.sourceType)&&(l=!0);const c=Kb(a);c&&o.push(c)}return{migrated:o,needsSave:l}}function tk(t){var ie,W,S,Z,K,X,U,D,b,d;const l=Yn(t.id);if(!l)return{...t,name:t.id,maxLevel:1,levels:[],sourceName:"Неизвестно",sourceIcon:"mdi:help-circle",sourceColor:"#94a3b8",aspectColor:"#94a3b8",currentDescription:""};const o=l.trait,a=((ie=o.levels)==null?void 0:ie.length)||1;let r="",c="mdi:help-circle",f="#94a3b8",k=null,w="#94a3b8",x=null,T=null;if(l.sourceType==="class"){const oe=nn.classes.find(M=>M.id===l.sourceId);if(c="mdi:school",r=oe?oe.name.m||oe.name:l.sourceId,k=`/TriP/images/classes/${l.sourceId}.png`,(W=oe==null?void 0:oe.aspects)!=null&&W[0]){x=oe.aspects[0];const M=Yt.aspects.find(de=>de.id===x);M&&(w=M.color||"#94a3b8",T=M.icon)}}else if(l.sourceType==="aspect"){const oe=Yt.aspects.find(he=>he.id===l.sourceId);c=(oe==null?void 0:oe.icon)||"mdi:hexagon",f=(oe==null?void 0:oe.color)||"#94a3b8",w=f,T=oe==null?void 0:oe.icon,r=(oe==null?void 0:oe.name)||l.sourceId,x=l.sourceId}else if(l.sourceType==="race"){const oe=il.races.find(he=>he.id===l.sourceId);c="mdi:account",r=(oe==null?void 0:oe.name)||l.sourceId}const y=[];for(let oe=0;oe<t.level;oe++){const he=(S=o.levels)==null?void 0:S[oe];he&&y.push({level:oe+1,description:he.text||he.description||"",customDescription:((Z=t.customDescriptions)==null?void 0:Z[oe+1])||"",customTags:((K=t.customTags)==null?void 0:K[oe+1])||[]})}const B=(X=o.levels)==null?void 0:X[t.level-1],m=(B==null?void 0:B.text)||(B==null?void 0:B.description)||"",Y=((U=t.customDescriptions)==null?void 0:U[0])||((D=t.customDescriptions)==null?void 0:D[t.level])||"",j=((b=t.customTags)==null?void 0:b[0])||((d=t.customTags)==null?void 0:d[t.level])||[],F=t.customColor||null;return{id:t.id,name:o.name,sourceType:t.sourceType,sourceId:t.sourceId,level:t.level,maxLevel:a,levels:o.levels||[],unlockedLevels:y,sourceName:r,sourceIcon:c,sourceColor:f,sourceImage:k,aspectId:x,aspectColor:w,aspectIcon:T,currentDescription:m,customDescription:Y,customTags:j,customColor:F,customDescriptions:t.customDescriptions||{},allCustomTags:t.customTags||{}}}const sk={key:0,class:"character-tabs"},nk=["onClick"],lk=["src","alt"],ok={key:1,class:"char-tab-avatar-fallback"},ak={class:"char-tab-name"},ik={key:1,class:"sheet-tabs-row"},rk=["onClick"],ck={class:"tab-label"},dk={key:0,class:"master-edit-section"},uk={class:"master-basic-section"},mk={class:"master-section-header"},vk={class:"master-basic-info"},fk={class:"basic-info-row"},Ak={class:"info-value"},pk={key:0,class:"basic-info-row"},hk={key:1,class:"basic-info-row"},gk={class:"info-value"},yk={class:"master-health-section"},bk={class:"master-section-header"},kk={class:"master-health-info"},xk={key:0,class:"health-max"},wk={key:1,class:"health-max"},Ck={class:"master-stats-section"},$k={class:"master-section-header"},_k={class:"master-stats-grid"},Tk={class:"stat-name"},Ik={class:"stat-value"},Sk={class:"master-skills-section"},Ek={class:"master-section-header"},Pk={class:"master-skills-info"},Mk={class:"master-danger-section"},Dk={class:"tab-content tab-content-bottom"},Bk={class:"skills-section"},Rk={class:"skills-header"},Fk={class:"skills-controls"},Lk=["title"],Nk={key:0,class:"skills-list"},Ok=["onClick"],Hk={class:"skill-info"},qk={class:"skill-name"},Uk={class:"skill-level"},Wk={class:"skill-source"},zk={class:"skill-source-name"},Vk={key:0,class:"skill-description"},Qk={class:"skill-levels-list"},jk={class:"skill-level-badge"},Gk={key:1,class:"skill-custom-note"},Yk={key:2,class:"skill-hidden-hint"},Xk=["onClick"],Zk={key:1,class:"skills-empty"},Jk={key:2,class:"skills-filter"},Kk={class:"skill-details-title"},ex={class:"skill-details-name"},tx={class:"skill-details-level"},sx={class:"skill-details-body"},nx={class:"skill-details-levels"},lx={class:"skill-details-level-badge"},ox={class:"skill-details-desc-text"},ax={class:"skill-details-section"},ix=["value"],rx={class:"skill-details-section"},cx=["value"],dx={class:"skill-details-section"},ux={class:"skill-color-picker"},mx=["title","onClick"],vx={class:"action-mode-section"},fx={class:"mode-header"},Ax={class:"mode-header-center"},px={class:"mode-active-name"},hx={class:"mode-buttons"},gx=["onClick","title"],yx=["onClick"],bx={key:0,class:"mode-info-panel"},kx={class:"mode-details-name"},xx={class:"mode-details-desc"},wx={class:"checks-section"},Cx={class:"checks-table-container"},$x={class:"aspects-column"},_x={class:"aspect-name"},Tx={class:"checks-scroll-area"},Ix={class:"checks-grid"},Sx={class:"diff-headers-row"},Ex=["title"],Px={class:"tab-content"},Mx={class:"section-card"},Dx={class:"tab-content"},Bx={class:"section-card placeholder"},Rx={class:"tab-content"},Fx={class:"section-card placeholder"},Lx={key:3,class:"empty-state"},Nx={class:"master-modal-header"},Ox={class:"master-modal-body"},Hx={class:"form-group"},qx={class:"form-group"},Ux={key:0,class:"portrait-preview"},Wx=["src"],zx={class:"form-group"},Vx={class:"npc-type-selector"},Qx=["onClick"],jx={class:"form-group"},Gx={class:"checkbox-label"},Yx={class:"form-group"},Xx={class:"factions-list"},Zx=["onClick"],Jx={class:"faction-add"},Kx={class:"master-modal-footer"},e2={class:"master-modal-header"},t2={class:"master-modal-body"},s2={class:"form-group"},n2={class:"health-type-selector"},l2={key:0,class:"form-group"},o2={class:"wounds-grid"},a2={class:"form-group"},i2={class:"form-group"},r2={class:"form-group"},c2={class:"form-group"},d2={class:"form-group"},u2={class:"master-modal-footer"},m2={class:"master-modal-header"},v2={class:"master-modal-body"},f2={class:"stats-editor-grid"},A2={class:"stat-editor-label"},p2=["onUpdate:modelValue"],h2={class:"master-modal-footer"},g2={class:"master-modal-header"},y2={class:"master-modal-body"},b2={class:"skill-add-row"},k2=["value","disabled"],x2=["disabled"],w2={class:"custom-skill-section"},C2={key:1,class:"custom-skill-form"},$2={class:"custom-skill-actions"},_2={key:0,class:"skills-editor-list"},T2={class:"skill-editor-info"},I2={class:"skill-editor-name"},S2={key:0,class:"skill-editor-source"},E2={key:1,class:"skill-editor-source custom"},P2=["value","onChange"],M2=["onClick"],D2={key:1,class:"skills-editor-empty"},B2={class:"master-modal-footer"},R2={__name:"MobileCharacterSheet",props:{character:{type:Object,default:null},embedded:{type:Boolean,default:!1},activeTab:{type:String,default:"main"}},emits:["close","switch-tab","update:activeTab","create-character","go-to-characters"],setup(t,{emit:l}){const o=t,a=l,r=ws(),c=cs(),f=on(),k=xs(),{myCharacters:w,activeCharacter:x,activeCharacterId:T}=jt(r),{isMaster:y}=jt(c),{userId:B}=jt(f),m=ne(()=>{if(o.character)return o.character;if(y.value)return x.value;const fe=w.value;return fe.length?x.value&&x.value.ownerId===B.value?x.value:fe[0]:null}),Y=ne(()=>{var fe;return((fe=m.value)==null?void 0:fe.ownerId)===B.value});ne(()=>Y.value||y.value);const j=[{id:"main",label:"Личность",icon:"mdi:account-heart"},{id:"items",label:"Инвентарь",icon:"mdi:backpack"},{id:"social",label:"Социум",icon:"mdi:account-group"},{id:"magic",label:"Магия",icon:"mdi:auto-fix"}],F=R("main"),ie=ne({get:()=>o.embedded?o.activeTab:F.value,set:fe=>{o.embedded?a("update:activeTab",fe):F.value=fe}}),W=R(null);Gt(ie,()=>{W.value&&(W.value.scrollTop=0)});const S=fe=>{r.setActiveCharacter(fe)},Z=ne(()=>{var I;return(((I=Yt.metadata)==null?void 0:I.circularOrder)||Yt.aspects.map(Fe=>Fe.id)).map(Fe=>Yt.aspects.find(et=>et.id===Fe)).filter(Boolean)}),K=ne(()=>Z.value.filter(fe=>fe.mode)),X=ne({get:()=>{var fe;return(fe=m.value)!=null&&fe.id?f.getCharacterMode(m.value.id):null},set:fe=>{var I;(I=m.value)!=null&&I.id&&f.setCharacterMode(m.value.id,fe)}}),U=R(!1),D=R(null),b=ne(()=>{if(!X.value)return"не выбран";const fe=K.value.find(I=>I.id===X.value);return fe?fe.mode.name:"не выбран"}),d=fe=>{X.value=X.value===fe?null:fe},oe=fe=>{D.value=fe},he=R(!1),M=R(!0),de=R(""),H=R(null),z=ne(()=>{var fe;return(fe=m.value)!=null&&fe.id?f.getSkillPreferences(m.value.id):{expandedSkills:[],allExpanded:!0}}),q=fe=>z.value.allExpanded?!z.value.expandedSkills.includes(fe):z.value.expandedSkills.includes(fe),Ie=fe=>{var et;if(!((et=m.value)!=null&&et.id))return;const I=m.value.id,Fe=q(fe);z.value.allExpanded?f.setSkillExpanded(I,fe,Fe):f.setSkillExpanded(I,fe,!Fe)},C=()=>{var fe;(fe=m.value)!=null&&fe.id&&f.setAllSkillsExpanded(m.value.id,!z.value.allExpanded)},L=ne(()=>{var Fe;if(!((Fe=m.value)!=null&&Fe.skills))return[];const{migrated:fe,needsSave:I}=ek(m.value.skills);return I&&m.value.id&&(console.log("[Skills] Миграция навыков персонажа",m.value.name),r.updateCharacter(m.value.id,{skills:fe})),fe.map(et=>tk(et)).filter(Boolean)}),$e=ne(()=>{const fe=de.value.toLowerCase().trim();if(!fe)return L.value;const I=Fe=>{var xt,Dt;let et=0;const O=Fe.name.toLowerCase(),u=Fe.sourceName.toLowerCase(),be=((xt=Fe.currentDescription)==null?void 0:xt.toLowerCase())||"",ze=((Dt=Fe.customDescription)==null?void 0:Dt.toLowerCase())||"",ut=(Fe.customTags||[]).join(" ").toLowerCase();return O===fe?et+=100:O.startsWith(fe)?et+=50:O.includes(fe)&&(et+=30),u.includes(fe)&&(et+=15),ut.includes(fe)&&(et+=20),ze.includes(fe)&&(et+=10),be.includes(fe)&&(et+=5),et};return L.value.map(Fe=>({skill:Fe,relevance:I(Fe)})).filter(Fe=>Fe.relevance>0).sort((Fe,et)=>et.relevance-Fe.relevance).map(Fe=>Fe.skill)}),Ae=fe=>{H.value=fe.id},Ee=()=>{H.value=null},Se=ne(()=>H.value&&L.value.find(fe=>fe.id===H.value)||null),Be=(fe,I,Fe)=>{if(!m.value)return;const et=[...m.value.skills||[]],O=et.findIndex(u=>u.id===fe);if(O>=0){const u={...et[O]};u.customDescriptions={...u.customDescriptions,[I]:Fe},et[O]=u,r.updateCharacter(m.value.id,{skills:et})}},He=(fe,I,Fe)=>{if(!m.value)return;const et=[...m.value.skills||[]],O=et.findIndex(u=>u.id===fe);if(O>=0){const u={...et[O]};u.customTags={...u.customTags,[I]:Fe},et[O]=u,r.updateCharacter(m.value.id,{skills:et})}},Ne=[{name:"Красный",value:"#ef4444"},{name:"Оранжевый",value:"#f97316"},{name:"Жёлтый",value:"#eab308"},{name:"Зелёный",value:"#22c55e"},{name:"Бирюзовый",value:"#14b8a6"},{name:"Голубой",value:"#06b6d4"},{name:"Синий",value:"#3b82f6"},{name:"Фиолетовый",value:"#8b5cf6"},{name:"Розовый",value:"#ec4899"},{name:"Серый",value:"#64748b"}],ot=(fe,I)=>{if(!m.value)return;const Fe=[...m.value.skills||[]],et=Fe.findIndex(O=>O.id===fe);if(et>=0){const O={...Fe[et]};I?O.customColor=I:delete O.customColor,Fe[et]=O,r.updateCharacter(m.value.id,{skills:Fe})}},We=ne(()=>{const fe=ss.default||ss;return Object.entries(fe).map(([I,Fe])=>({value:parseInt(I),...Fe})).sort((I,Fe)=>I.value-Fe.value)}),ce=fe=>Kn(m.value,fe),Je=(fe,I)=>{const Fe=ce(fe),et=I-Fe;return et<=2?{type:"auto",value:"✓"}:et<=12?{type:"roll",value:et}:{type:"fail",value:"✗"}},Ke=fe=>{r.updateCharacter(fe.id,fe),y.value?(fe.ownerId&&fe.ownerId!=="master"&&c.sendCharacterToPlayer(fe.id,fe.ownerId),c.broadcastAllCharacters()):c.sendCharacterUpdate(fe.id)},xe=R(!1),Me=R({}),Pe=ne(()=>Yt.aspects.filter(fe=>["war","knowledge","community","shadow","mysticism","nature"].includes(fe.id))),Re=()=>{m.value&&(Me.value={...m.value.stats||{war:0,knowledge:0,community:0,shadow:0,mysticism:0,nature:0}},xe.value=!0)},ke=()=>{m.value&&(r.updateCharacter(m.value.id,{stats:{...Me.value}}),y.value&&c.broadcastAllCharacters(),xe.value=!1)},ge=R(!1),ae=R([]),Xe=R(""),Ze=R(1),vt=R(""),te=R(""),J=R(!1),Te=ne(()=>{const fe=[];return nn.classes.forEach(I=>{I.traits&&I.traits.forEach(Fe=>{var et;fe.push({id:`class_${I.id}_${Fe.id}`,name:Fe.name,sourceType:"class",sourceId:I.id,sourceName:typeof I.name=="object"?I.name.m:I.name,maxLevel:((et=Fe.levels)==null?void 0:et.length)||1,levels:Fe.levels||[]})})}),Yt.aspects.forEach(I=>{I.traits&&I.traits.forEach(Fe=>{var et,O;(et=Fe.id)!=null&&et.toLowerCase().includes("temp")||fe.push({id:`aspect_${I.id}_${Fe.id}`,name:Fe.name,sourceType:"aspect",sourceId:I.id,sourceName:I.name,aspectColor:I.color,maxLevel:((O=Fe.levels)==null?void 0:O.length)||1,levels:Fe.levels||[]})})}),fe}),$=()=>{m.value&&(ae.value=[...m.value.skills||[]],ge.value=!0)},P=()=>{if(Xe.value){if(ae.value.some(fe=>fe.id===Xe.value)){alert("Этот навык уже добавлен");return}ae.value.push({id:Xe.value,level:Ze.value}),Xe.value="",Ze.value=1}},N=fe=>{ae.value=ae.value.filter(I=>I.id!==fe)},Ge=(fe,I)=>{const Fe=ae.value.find(et=>et.id===fe);Fe&&(Fe.level=parseInt(I)||1)},rt=fe=>{const I=Te.value.find(Fe=>Fe.id===fe);if(I)return I;if(fe.startsWith("custom_")){const Fe=ae.value.find(et=>et.id===fe);if(Fe)return{id:fe,name:Fe.customName||"Кастомный навык",sourceType:"custom",sourceName:"Особый",maxLevel:3,levels:[],description:Fe.customDescription||""}}return null},ft=()=>{if(!vt.value.trim()){alert("Введите название навыка");return}const fe=`custom_${Date.now()}`;ae.value.push({id:fe,level:1,customName:vt.value.trim(),customDescription:te.value.trim()}),vt.value="",te.value="",J.value=!1},Et=()=>{m.value&&(r.updateCharacter(m.value.id,{skills:[...ae.value]}),y.value&&c.broadcastAllCharacters(),ge.value=!1)},At=R(!1),dt=R({name:"",portrait:"",npcType:"neutral",factions:[],visibleToPlayers:!0}),$t=[{id:"ally",label:"Союзник",color:"#22c55e"},{id:"neutral",label:"Нейтрал",color:"#94a3b8"},{id:"enemy",label:"Враг",color:"#ef4444"}],re=()=>{m.value&&(dt.value={name:m.value.name||"",portrait:m.value.portrait||"",npcType:m.value.npcType||"neutral",factions:m.value.factions||[],visibleToPlayers:m.value.visibleToPlayers!==!1},At.value=!0)},ye=()=>{m.value&&(r.updateCharacter(m.value.id,{name:dt.value.name,portrait:dt.value.portrait,npcType:dt.value.npcType,factions:dt.value.factions,visibleToPlayers:dt.value.visibleToPlayers}),y.value&&c.broadcastAllCharacters(),At.value=!1)},pe=R(""),Ue=()=>{pe.value.trim()&&(dt.value.factions.includes(pe.value.trim())||dt.value.factions.push(pe.value.trim()),pe.value="")},Wt=fe=>{dt.value.factions=dt.value.factions.filter(I=>I!==fe)},Rt=R(!1),gt=R({healthType:"simple",maxHp:8,maxScratch:3,maxLight:2,maxHeavy:1,maxDeadly:1,bonusDeadlySlots:0}),bt=()=>{if(!m.value)return;const fe=m.value.combat||{},I=fe.wounds||{};gt.value={healthType:fe.healthType||"simple",maxHp:fe.maxHp||8,maxScratch:I.maxScratch??3,maxLight:I.maxLight??2,maxHeavy:I.maxHeavy??1,maxDeadly:I.maxDeadly??1,bonusDeadlySlots:fe.bonusDeadlySlots||0},Rt.value=!0},Ye=()=>{if(!m.value)return;const fe=m.value.combat||{},I=fe.wounds||{},Fe={combat:{...fe,healthType:gt.value.healthType,maxHp:gt.value.maxHp,bonusDeadlySlots:gt.value.bonusDeadlySlots}};gt.value.healthType==="wounds"&&(Fe.combat.wounds={...I,maxScratch:gt.value.maxScratch,maxLight:gt.value.maxLight,maxHeavy:gt.value.maxHeavy,maxDeadly:gt.value.maxDeadly}),r.updateCharacter(m.value.id,Fe),y.value&&c.broadcastAllCharacters(),Rt.value=!1},Ms=()=>{if(!m.value)return;const fe=m.value.isNpc,I=fe?`Удалить NPC "${m.value.name}"?`:Y.value?`Удалить персонажа "${m.value.name}"?`:`Удалить персонажа "${m.value.name}" игрока ${m.value.ownerNickname}?`;if(confirm(I)){const Fe=m.value.id,et=k.activeMap;et&&k.removeTokenByCharacterId(et.id,Fe),fe?(r.deleteNpc(Fe),c.sendCharacterDelete(Fe)):(r.deleteCharacter(Fe),c.sendCharacterDelete(Fe)),y.value?a("go-to-characters"):a("close")}};return(fe,I)=>{var Fe,et,O,u,be,ze,ut,xt,Dt,Ht,ns,Ft;return s(),n("div",{class:Q(["mobile-character-sheet",{embedded:t.embedded}])},[!t.embedded&&i(w).length>1?(s(),n("div",sk,[(s(!0),n(ee,null,me(i(w),V=>{var ht,Tt;return s(),n("button",{key:V.id,class:Q(["char-tab",{active:i(T)===V.id}]),onClick:Qt=>S(V.id)},[V.portrait?(s(),n("img",{key:0,src:V.portrait,alt:V.name,class:"char-tab-avatar"},null,8,lk)):(s(),n("span",ok,h(((Tt=(ht=V.name)==null?void 0:ht.charAt(0))==null?void 0:Tt.toUpperCase())||"?"),1)),e("span",ak,h(V.name),1)],10,nk)}),128))])):_("",!0),t.embedded?_("",!0):(s(),n("div",ik,[(s(),n(ee,null,me(j,V=>e("button",{key:V.id,class:Q(["sheet-tab-btn",{active:ie.value===V.id}]),onClick:ht=>ie.value=V.id},[A(i(p),{icon:V.icon,class:"tab-icon"},null,8,["icon"]),e("span",ck,h(V.label),1)],10,rk)),64))])),m.value?(s(),n("div",{key:2,ref_key:"sheetContentRef",ref:W,class:"sheet-content"},[i(y)?(s(),n("div",dk,[I[57]||(I[57]=e("div",{class:"master-section-title"},"⚙️ Мастерские инструменты",-1)),e("div",uk,[e("div",mk,[I[47]||(I[47]=e("span",null,"Основные данные",-1)),e("button",{class:"master-edit-btn",onClick:re},[A(i(p),{icon:"mdi:pencil"}),I[46]||(I[46]=Ce(" Редактировать ",-1))])]),e("div",vk,[e("div",fk,[I[48]||(I[48]=e("span",{class:"info-label"},"Имя:",-1)),e("span",Ak,h(m.value.name),1)]),m.value.isNpc?(s(),n("div",pk,[I[49]||(I[49]=e("span",{class:"info-label"},"Тип:",-1)),e("span",{class:"info-value npc-type-badge",style:Qe({color:((Fe=$t.find(V=>V.id===m.value.npcType))==null?void 0:Fe.color)||"#94a3b8"})},h(((et=$t.find(V=>V.id===m.value.npcType))==null?void 0:et.label)||"Нейтрал"),5)])):_("",!0),m.value.isNpc&&((O=m.value.factions)!=null&&O.length)?(s(),n("div",hk,[I[50]||(I[50]=e("span",{class:"info-label"},"Фракции:",-1)),e("span",gk,h(m.value.factions.join(", ")),1)])):_("",!0)])]),e("div",yk,[e("div",bk,[I[52]||(I[52]=e("span",null,"Здоровье",-1)),e("button",{class:"master-edit-btn",onClick:bt},[A(i(p),{icon:"mdi:pencil"}),I[51]||(I[51]=Ce(" Редактировать ",-1))])]),e("div",kk,[e("span",{class:Q(["health-type-badge",((u=m.value.combat)==null?void 0:u.healthType)||"simple"])},h(((be=m.value.combat)==null?void 0:be.healthType)==="wounds"?"Ранения":"Простое HP"),3),((ze=m.value.combat)==null?void 0:ze.healthType)!=="wounds"?(s(),n("span",xk," Макс: "+h(((ut=m.value.combat)==null?void 0:ut.maxHp)||8),1)):(s(),n("span",wk," Смерт. слоты: "+h(1+(((xt=m.value.combat)==null?void 0:xt.bonusDeadlySlots)||0)),1))])]),e("div",Ck,[e("div",$k,[I[54]||(I[54]=e("span",null,"Характеристики",-1)),e("button",{class:"master-edit-btn",onClick:Re},[A(i(p),{icon:"mdi:pencil"}),I[53]||(I[53]=Ce(" Редактировать ",-1))])]),e("div",_k,[(s(!0),n(ee,null,me(Pe.value,V=>{var ht,Tt,Qt;return s(),n("div",{key:V.id,class:"master-stat-item",style:Qe({"--stat-color":V.color})},[A(i(p),{icon:V.characteristicIcon||V.icon,class:"stat-icon"},null,8,["icon"]),e("span",Tk,h(((ht=V.characteristic)==null?void 0:ht.name)||V.name),1),e("span",Ik,h(((Qt=(Tt=m.value)==null?void 0:Tt.stats)==null?void 0:Qt[V.id])||0),1)],4)}),128))])]),e("div",Sk,[e("div",Ek,[I[56]||(I[56]=e("span",null,"Управление навыками",-1)),e("button",{class:"master-edit-btn",onClick:$},[A(i(p),{icon:"mdi:pencil"}),I[55]||(I[55]=Ce(" Редактировать ",-1))])]),e("div",Pk,h(((Ht=(Dt=m.value)==null?void 0:Dt.skills)==null?void 0:Ht.length)||0)+" навыков назначено ",1)]),e("div",Mk,[e("button",{class:"master-delete-btn",onClick:Ms},[A(i(p),{icon:"mdi:delete"}),Ce(" "+h(m.value.isNpc?"Удалить NPC":"Удалить персонажа"),1)])])])):_("",!0),De(e("div",Dk,[e("div",Bk,[e("div",Rk,[I[58]||(I[58]=e("span",{class:"skills-title"},"НАВЫКИ И ОСОБЕННОСТИ",-1)),e("div",Fk,[e("button",{class:Q(["skills-toggle-desc",{active:!M.value}]),onClick:I[0]||(I[0]=V=>M.value=!M.value),title:"Скрыть/показать оригинальные описания"},[A(i(p),{icon:"mdi:text-box-remove"})],2),e("button",{class:Q(["skills-toggle-desc",{active:he.value}]),onClick:I[1]||(I[1]=V=>he.value=!he.value),title:"Показать свои заметки"},[A(i(p),{icon:"mdi:note-edit"})],2),e("button",{class:"skills-toggle-expand",onClick:C,title:z.value.allExpanded?"Свернуть все":"Развернуть все"},[A(i(p),{icon:z.value.allExpanded?"mdi:unfold-less-horizontal":"mdi:unfold-more-horizontal"},null,8,["icon"])],8,Lk)])]),L.value.length>0?(s(),n("div",Nk,[(s(!0),n(ee,null,me($e.value,V=>(s(),n("div",{key:V.id,class:Q(["skill-item",{expanded:q(V.id)}]),style:Qe({"--skill-color":V.customColor||V.aspectColor})},[e("div",{class:"skill-main",onClick:ht=>Ie(V.id)},[e("div",Hk,[e("span",qk,h(V.name),1),e("span",Uk,h(V.level)+"/"+h(V.maxLevel),1)]),e("div",Wk,[e("span",zk,h(V.sourceName),1),A(i(p),{icon:q(V.id)?"mdi:chevron-up":"mdi:chevron-down",class:"skill-expand-icon"},null,8,["icon"])])],8,Ok),q(V.id)?(s(),n("div",Vk,[V.sourceType==="class"&&V.sourceImage?(s(),n("div",{key:0,class:"skill-bg-image",style:Qe({backgroundImage:`url(${V.sourceImage})`})},null,4)):_("",!0),e("div",Qk,[M.value?(s(!0),n(ee,{key:0},me(V.unlockedLevels,ht=>(s(),n("div",{key:ht.level,class:"skill-level-item"},[e("span",jk,h(ht.level),1),e("p",null,h(ht.description),1)]))),128)):_("",!0),he.value&&V.customDescription?(s(),n("div",Gk,[I[59]||(I[59]=e("span",{class:"skill-note-badge"},"📝",-1)),e("p",null,h(V.customDescription),1)])):_("",!0),!M.value&&!(he.value&&V.customDescription)?(s(),n("div",Yk,[A(i(p),{icon:"mdi:eye-off"}),I[60]||(I[60]=e("span",null,"Описания скрыты",-1))])):_("",!0)]),e("button",{class:"skill-details-btn",onClick:lt(ht=>Ae(V),["stop"])},[A(i(p),{icon:"mdi:dots-horizontal"})],8,Xk)])):_("",!0)],6))),128))])):(s(),n("div",Zk,[A(i(p),{icon:"mdi:book-open-variant",class:"skills-empty-icon"}),I[61]||(I[61]=e("span",null,"Навыки появятся по мере развития персонажа",-1))])),L.value.length>0?(s(),n("div",Jk,[A(i(p),{icon:"mdi:magnify",class:"skills-filter-icon"}),De(e("input",{type:"text","onUpdate:modelValue":I[2]||(I[2]=V=>de.value=V),placeholder:"Поиск навыков...",class:"skills-filter-input"},null,512),[[je,de.value]]),de.value?(s(),n("button",{key:0,class:"skills-filter-clear",onClick:I[3]||(I[3]=V=>de.value="")},[A(i(p),{icon:"mdi:close"})])):_("",!0)])):_("",!0)]),(s(),st(Vt,{to:"body"},[Se.value?(s(),n("div",{key:0,class:"skill-details-overlay",onClick:Ee},[e("div",{class:"skill-details-card",onClick:I[7]||(I[7]=lt(()=>{},["stop"]))},[e("div",{class:"skill-details-header",style:Qe({borderColor:Se.value.customColor||Se.value.aspectColor})},[A(i(p),{icon:Se.value.sourceIcon,class:"skill-details-source-icon"},null,8,["icon"]),e("div",Kk,[e("span",ex,h(Se.value.name),1),e("span",tx,"Уровень "+h(Se.value.level)+" / "+h(Se.value.maxLevel),1)]),e("button",{class:"skill-details-close-btn",onClick:Ee},[A(i(p),{icon:"mdi:close"})])],4),e("div",sx,[e("div",nx,[(s(!0),n(ee,null,me(Se.value.unlockedLevels,V=>(s(),n("div",{key:V.level,class:"skill-details-level"},[e("span",lx,h(V.level),1),e("p",ox,h(V.description),1)]))),128))]),e("div",ax,[I[62]||(I[62]=e("h4",null,"Заметка",-1)),e("textarea",{class:"skill-custom-desc-input",value:Se.value.customDescription,onInput:I[4]||(I[4]=V=>Be(Se.value.id,0,V.target.value)),placeholder:"Добавьте заметку к навыку..."},null,40,ix)]),e("div",rx,[I[63]||(I[63]=e("h4",null,"Теги для поиска",-1)),e("input",{type:"text",class:"skill-tags-input",value:(ns=Se.value.customTags)==null?void 0:ns.join(", "),onInput:I[5]||(I[5]=V=>He(Se.value.id,0,V.target.value.split(",").map(ht=>ht.trim()).filter(Boolean))),placeholder:"тег1, тег2, тег3..."},null,40,cx)]),e("div",dx,[I[64]||(I[64]=e("h4",null,"Цвет метки",-1)),e("div",ux,[(s(),n(ee,null,me(Ne,V=>e("button",{key:V.value,class:Q(["skill-color-option",{active:(Se.value.customColor||Se.value.aspectColor)===V.value}]),style:Qe({backgroundColor:V.value}),title:V.name,onClick:ht=>ot(Se.value.id,V.value)},null,14,mx)),64)),e("button",{class:Q(["skill-color-option reset",{active:!Se.value.customColor}]),title:"Сбросить (цвет аспекта)",onClick:I[6]||(I[6]=V=>ot(Se.value.id,null))},[A(i(p),{icon:"mdi:refresh"})],2)])])])])])):_("",!0)])),e("div",vx,[e("div",fx,[e("div",Ax,[I[65]||(I[65]=e("span",{class:"mode-title"},"РЕЖИМ ДЕЙСТВИЙ:",-1)),e("span",px,h(b.value),1)]),e("button",{class:"mode-info-btn",onClick:I[8]||(I[8]=V=>U.value=!U.value)},[A(i(p),{icon:"mdi:information-outline"})])]),e("div",hx,[(s(!0),n(ee,null,me(K.value,V=>(s(),n("button",{key:V.id,class:Q(["mode-btn",{active:X.value===V.id}]),style:Qe({"--mode-color":V.color}),onClick:ht=>d(V.id),title:V.mode.name},[A(i(p),{icon:V.mode.icon,class:"mode-icon"},null,8,["icon"]),e("span",{class:"mode-detail-btn",onClick:lt(ht=>oe(V),["stop"])},[A(i(p),{icon:"mdi:help-circle-outline"})],8,yx)],14,gx))),128))])]),U.value?(s(),n("div",bx,[...I[66]||(I[66]=[e("p",null,"Выбранный режим виден мастеру и влияет на контекст сцены.",-1),e("p",null,"При высоких показателях соответствующего Атрибута режимы становятся эффективнее и дают особые бонусы.",-1),e("p",null,"По умолчанию можно выбрать только один режим. Особые умения увеличивают лимит.",-1),e("p",{class:"mode-info-warning"},"В бою режимы менять нельзя.",-1)])])):_("",!0),D.value?(s(),n("div",{key:1,class:"mode-details-overlay",onClick:I[11]||(I[11]=V=>D.value=null)},[e("div",{class:"mode-details-card",onClick:I[10]||(I[10]=lt(()=>{},["stop"]))},[e("div",{class:"mode-details-header",style:Qe({color:D.value.color})},[A(i(p),{icon:D.value.mode.icon,class:"mode-details-icon"},null,8,["icon"]),e("span",kx,h(D.value.mode.name),1)],4),e("p",xx,h(D.value.mode.description),1),I[67]||(I[67]=e("div",{class:"mode-details-info"},[e("p",null,"Мастер видит ваш выбранный режим. Контекст сцены может меняться в зависимости от вашего подхода.")],-1)),e("button",{class:"mode-details-close",onClick:I[9]||(I[9]=V=>D.value=null)},"Закрыть")])])):_("",!0),e("div",wx,[e("div",Cx,[e("div",$x,[I[68]||(I[68]=e("div",{class:"aspect-header-cell"},[e("span",{class:"checks-title"},"ПРОВЕРКИ")],-1)),(s(!0),n(ee,null,me(Z.value,V=>{var ht;return s(),n("div",{key:V.id,class:"aspect-row-cell",style:Qe({color:V.color})},[A(i(p),{icon:V.checkIcon||V.icon||"mdi:circle",class:"aspect-icon"},null,8,["icon"]),e("span",_x,h(((ht=V.check)==null?void 0:ht.name)||V.name),1)],4)}),128))]),e("div",Tx,[e("div",Ix,[e("div",Sx,[(s(!0),n(ee,null,me(We.value,V=>(s(),n("div",{key:V.value,class:Q(["diff-header-cell","linetype-"+V.linetype]),style:Qe({"--diff-color":V.color}),title:V.name},h(V.short),15,Ex))),128))]),(s(!0),n(ee,null,me(Z.value,V=>(s(),n("div",{key:V.id,class:"checks-row"},[(s(!0),n(ee,null,me(We.value,ht=>(s(),n("div",{key:ht.value,class:Q(["check-cell",["linetype-"+ht.linetype,Je(V.id,ht.value).type]]),style:Qe({"--diff-color":ht.color})},h(Je(V.id,ht.value).value),7))),128))]))),128))])])])])],512),[[hn,ie.value==="main"]]),De(e("div",Px,[e("div",Mx,[A(Gb,{character:m.value,"is-master":i(y),"onUpdate:character":Ke},null,8,["character","is-master"])])],512),[[hn,ie.value==="items"]]),De(e("div",Dx,[e("div",Bx,[A(i(p),{icon:"mdi:account-group",class:"placeholder-icon"}),I[69]||(I[69]=e("p",null,"Социальные связи",-1)),I[70]||(I[70]=e("span",{class:"placeholder-hint"},"В разработке",-1))])],512),[[hn,ie.value==="social"]]),De(e("div",Rx,[e("div",Fx,[A(i(p),{icon:"mdi:auto-fix",class:"placeholder-icon"}),I[71]||(I[71]=e("p",null,"Магические способности",-1)),I[72]||(I[72]=e("span",{class:"placeholder-hint"},"В разработке",-1))])],512),[[hn,ie.value==="magic"]])],512)):(s(),n("div",Lx,[A(i(p),{icon:"mdi:account-off",class:"empty-icon"}),I[73]||(I[73]=e("p",{class:"empty-title"},"У вас пока нет персонажей",-1)),I[74]||(I[74]=e("p",{class:"empty-hint"}," Чтобы создать нового персонажа, вам нужно получить приглашение от мастера. Оно отобразится на вкладке «Сцена». ",-1))])),(s(),st(Vt,{to:"body"},[At.value?(s(),n("div",{key:0,class:"master-modal-overlay",onClick:I[19]||(I[19]=V=>At.value=!1)},[e("div",{class:"master-modal master-modal-wide",onClick:I[18]||(I[18]=lt(()=>{},["stop"]))},[e("div",Nx,[I[75]||(I[75]=e("h3",null,"Основные данные",-1)),e("button",{class:"modal-close-btn",onClick:I[12]||(I[12]=V=>At.value=!1)},[A(i(p),{icon:"mdi:close"})])]),e("div",Ox,[e("div",Hx,[I[76]||(I[76]=e("label",null,"Имя персонажа",-1)),De(e("input",{type:"text","onUpdate:modelValue":I[13]||(I[13]=V=>dt.value.name=V),class:"form-input",placeholder:"Введите имя..."},null,512),[[je,dt.value.name]])]),e("div",qx,[I[77]||(I[77]=e("label",null,"URL портрета",-1)),De(e("input",{type:"text","onUpdate:modelValue":I[14]||(I[14]=V=>dt.value.portrait=V),class:"form-input",placeholder:"https://..."},null,512),[[je,dt.value.portrait]]),dt.value.portrait?(s(),n("div",Ux,[e("img",{src:dt.value.portrait,alt:"Превью"},null,8,Wx)])):_("",!0)]),(Ft=m.value)!=null&&Ft.isNpc?(s(),n(ee,{key:0},[e("div",zx,[I[78]||(I[78]=e("label",null,"Тип NPC",-1)),e("div",Vx,[(s(),n(ee,null,me($t,V=>e("button",{key:V.id,class:Q(["npc-type-btn",{active:dt.value.npcType===V.id}]),style:Qe({"--type-color":V.color}),onClick:ht=>dt.value.npcType=V.id},h(V.label),15,Qx)),64))])]),e("div",jx,[e("label",Gx,[De(e("input",{type:"checkbox","onUpdate:modelValue":I[15]||(I[15]=V=>dt.value.visibleToPlayers=V)},null,512),[[On,dt.value.visibleToPlayers]]),I[79]||(I[79]=e("span",null,"Видим игрокам на карте",-1))])]),e("div",Yx,[I[80]||(I[80]=e("label",null,"Фракции",-1)),e("div",Xx,[(s(!0),n(ee,null,me(dt.value.factions,V=>(s(),n("span",{key:V,class:"faction-tag"},[Ce(h(V)+" ",1),e("button",{class:"faction-remove",onClick:ht=>Wt(V)},"×",8,Zx)]))),128))]),e("div",Jx,[De(e("input",{type:"text","onUpdate:modelValue":I[16]||(I[16]=V=>pe.value=V),class:"form-input",placeholder:"Новая фракция...",onKeyup:ks(Ue,["enter"])},null,544),[[je,pe.value]]),e("button",{class:"add-faction-btn",onClick:Ue},[A(i(p),{icon:"mdi:plus"})])])])],64)):_("",!0)]),e("div",Kx,[e("button",{class:"modal-btn cancel",onClick:I[17]||(I[17]=V=>At.value=!1)},"Отмена"),e("button",{class:"modal-btn save",onClick:ye},"Сохранить")])])])):_("",!0)])),(s(),st(Vt,{to:"body"},[Rt.value?(s(),n("div",{key:0,class:"master-modal-overlay",onClick:I[31]||(I[31]=V=>Rt.value=!1)},[e("div",{class:"master-modal",onClick:I[30]||(I[30]=lt(()=>{},["stop"]))},[e("div",e2,[I[81]||(I[81]=e("h3",null,"Настройки здоровья",-1)),e("button",{class:"modal-close-btn",onClick:I[20]||(I[20]=V=>Rt.value=!1)},[A(i(p),{icon:"mdi:close"})])]),e("div",t2,[e("div",s2,[I[84]||(I[84]=e("label",null,"Система здоровья",-1)),e("div",n2,[e("button",{class:Q(["health-type-btn",{active:gt.value.healthType==="simple"}]),onClick:I[21]||(I[21]=V=>gt.value.healthType="simple")},[A(i(p),{icon:"mdi:heart"}),I[82]||(I[82]=e("span",null,"Простое HP",-1))],2),e("button",{class:Q(["health-type-btn",{active:gt.value.healthType==="wounds"}]),onClick:I[22]||(I[22]=V=>gt.value.healthType="wounds")},[A(i(p),{icon:"mdi:bandage"}),I[83]||(I[83]=e("span",null,"Ранения",-1))],2)])]),gt.value.healthType==="simple"?(s(),n("div",l2,[I[85]||(I[85]=e("label",null,"Максимальное HP",-1)),De(e("input",{type:"number","onUpdate:modelValue":I[23]||(I[23]=V=>gt.value.maxHp=V),class:"form-input",min:"1",max:"100"},null,512),[[je,gt.value.maxHp,void 0,{number:!0}]])])):_("",!0),gt.value.healthType==="wounds"?(s(),n(ee,{key:1},[e("div",o2,[e("div",a2,[I[86]||(I[86]=e("label",null,"Царапины (макс.)",-1)),De(e("input",{type:"number","onUpdate:modelValue":I[24]||(I[24]=V=>gt.value.maxScratch=V),class:"form-input",min:"0",max:"10"},null,512),[[je,gt.value.maxScratch,void 0,{number:!0}]])]),e("div",i2,[I[87]||(I[87]=e("label",null,"Лёгкие (макс.)",-1)),De(e("input",{type:"number","onUpdate:modelValue":I[25]||(I[25]=V=>gt.value.maxLight=V),class:"form-input",min:"0",max:"10"},null,512),[[je,gt.value.maxLight,void 0,{number:!0}]])]),e("div",r2,[I[88]||(I[88]=e("label",null,"Тяжёлые (макс.)",-1)),De(e("input",{type:"number","onUpdate:modelValue":I[26]||(I[26]=V=>gt.value.maxHeavy=V),class:"form-input",min:"0",max:"10"},null,512),[[je,gt.value.maxHeavy,void 0,{number:!0}]])]),e("div",c2,[I[89]||(I[89]=e("label",null,"Смертельные (макс.)",-1)),De(e("input",{type:"number","onUpdate:modelValue":I[27]||(I[27]=V=>gt.value.maxDeadly=V),class:"form-input",min:"1",max:"10"},null,512),[[je,gt.value.maxDeadly,void 0,{number:!0}]])])]),e("div",d2,[I[90]||(I[90]=e("label",null,"Бонусные смертельные слоты",-1)),De(e("input",{type:"number","onUpdate:modelValue":I[28]||(I[28]=V=>gt.value.bonusDeadlySlots=V),class:"form-input",min:"0",max:"5"},null,512),[[je,gt.value.bonusDeadlySlots,void 0,{number:!0}]]),I[91]||(I[91]=e("p",{class:"form-hint"},"Добавляются к максимуму смертельных",-1))])],64)):_("",!0)]),e("div",u2,[e("button",{class:"modal-btn cancel",onClick:I[29]||(I[29]=V=>Rt.value=!1)},"Отмена"),e("button",{class:"modal-btn save",onClick:Ye},"Сохранить")])])])):_("",!0)])),(s(),st(Vt,{to:"body"},[xe.value?(s(),n("div",{key:0,class:"master-modal-overlay",onClick:I[35]||(I[35]=V=>xe.value=!1)},[e("div",{class:"master-modal",onClick:I[34]||(I[34]=lt(()=>{},["stop"]))},[e("div",m2,[I[92]||(I[92]=e("h3",null,"Редактирование характеристик",-1)),e("button",{class:"modal-close-btn",onClick:I[32]||(I[32]=V=>xe.value=!1)},[A(i(p),{icon:"mdi:close"})])]),e("div",v2,[e("div",f2,[(s(!0),n(ee,null,me(Pe.value,V=>{var ht;return s(),n("div",{key:V.id,class:"stat-editor-item",style:Qe({"--stat-color":V.color})},[e("div",A2,[A(i(p),{icon:V.characteristicIcon||V.icon},null,8,["icon"]),e("span",null,h(((ht=V.characteristic)==null?void 0:ht.name)||V.name),1)]),De(e("input",{type:"number","onUpdate:modelValue":Tt=>Me.value[V.id]=Tt,class:"stat-editor-input",min:"-5",max:"10"},null,8,p2),[[je,Me.value[V.id],void 0,{number:!0}]])],4)}),128))])]),e("div",h2,[e("button",{class:"modal-btn cancel",onClick:I[33]||(I[33]=V=>xe.value=!1)},"Отмена"),e("button",{class:"modal-btn save",onClick:ke},"Сохранить")])])])):_("",!0)])),(s(),st(Vt,{to:"body"},[ge.value?(s(),n("div",{key:0,class:"master-modal-overlay",onClick:I[45]||(I[45]=V=>ge.value=!1)},[e("div",{class:"master-modal master-modal-wide",onClick:I[44]||(I[44]=lt(()=>{},["stop"]))},[e("div",g2,[I[93]||(I[93]=e("h3",null,"Редактирование навыков",-1)),e("button",{class:"modal-close-btn",onClick:I[36]||(I[36]=V=>ge.value=!1)},[A(i(p),{icon:"mdi:close"})])]),e("div",y2,[e("div",b2,[De(e("select",{"onUpdate:modelValue":I[37]||(I[37]=V=>Xe.value=V),class:"skill-select"},[I[94]||(I[94]=e("option",{value:""},"Выберите навык...",-1)),(s(!0),n(ee,null,me(Te.value,V=>(s(),n("option",{key:V.id,value:V.id,disabled:ae.value.some(ht=>ht.id===V.id)}," ["+h(V.sourceType==="class"?"Класс":"Аспект")+"] "+h(V.name)+" ("+h(V.sourceName)+") ",9,k2))),128))],512),[[Kt,Xe.value]]),De(e("select",{"onUpdate:modelValue":I[38]||(I[38]=V=>Ze.value=V),class:"level-select"},[...I[95]||(I[95]=[e("option",{value:1},"Ур. 1",-1),e("option",{value:2},"Ур. 2",-1),e("option",{value:3},"Ур. 3",-1)])],512),[[Kt,Ze.value,void 0,{number:!0}]]),e("button",{class:"add-skill-btn",onClick:P,disabled:!Xe.value},[A(i(p),{icon:"mdi:plus"})],8,x2)]),e("div",w2,[J.value?(s(),n("div",C2,[De(e("input",{"onUpdate:modelValue":I[40]||(I[40]=V=>vt.value=V),placeholder:"Название навыка",class:"custom-skill-input"},null,512),[[je,vt.value]]),De(e("textarea",{"onUpdate:modelValue":I[41]||(I[41]=V=>te.value=V),placeholder:"Описание (опционально)",class:"custom-skill-textarea",rows:"2"},null,512),[[je,te.value]]),e("div",$2,[e("button",{class:"modal-btn cancel",onClick:I[42]||(I[42]=V=>J.value=!1)},"Отмена"),e("button",{class:"modal-btn save",onClick:ft},"Добавить")])])):(s(),n("button",{key:0,class:"add-custom-skill-btn",onClick:I[39]||(I[39]=V=>J.value=!0)},[A(i(p),{icon:"mdi:plus-circle-outline"}),I[96]||(I[96]=Ce(" Добавить особый навык ",-1))]))]),ae.value.length?(s(),n("div",_2,[(s(!0),n(ee,null,me(ae.value,V=>{var ht,Tt;return s(),n("div",{key:V.id,class:Q(["skill-editor-item",{"custom-skill":V.id.startsWith("custom_")}])},[e("div",T2,[e("span",I2,h(V.customName||((ht=rt(V.id))==null?void 0:ht.name)||V.id),1),(Tt=rt(V.id))!=null&&Tt.sourceName?(s(),n("span",S2,h(rt(V.id).sourceName),1)):V.id.startsWith("custom_")?(s(),n("span",E2," Особый ")):_("",!0)]),e("select",{value:V.level,onChange:Qt=>Ge(V.id,Qt.target.value),class:"level-select"},[...I[97]||(I[97]=[e("option",{value:1},"Ур. 1",-1),e("option",{value:2},"Ур. 2",-1),e("option",{value:3},"Ур. 3",-1)])],40,P2),e("button",{class:"remove-skill-btn",onClick:Qt=>N(V.id)},[A(i(p),{icon:"mdi:close"})],8,M2)],2)}),128))])):(s(),n("div",D2," Навыки не добавлены "))]),e("div",B2,[e("button",{class:"modal-btn cancel",onClick:I[43]||(I[43]=V=>ge.value=!1)},"Отмена"),e("button",{class:"modal-btn save",onClick:Et},"Сохранить")])])])):_("",!0)]))],2)}}},no=zt(R2,[["__scopeId","data-v-7107e32d"]]),F2={class:"tools-header"},L2={class:"tools-title"},N2={class:"tools-grid"},O2=["onClick"],H2={class:"tool-label"},q2={key:0,class:"tool-form"},U2={class:"form-group"},W2={class:"checkbox-label"},z2={class:"form-group"},V2={class:"check-type-grid"},Q2=["onClick"],j2={class:"form-group"},G2={class:"difficulty-slider-container"},Y2=["max"],X2={class:"difficulty-marks"},Z2=["title"],J2={class:"form-group"},K2={class:"checkbox-label"},ew={class:"form-group"},tw={class:"form-group"},sw=["value"],nw={class:"form-group"},lw={key:0,class:"image-preview"},ow=["src"],aw={class:"form-group"},iw={class:"form-group"},rw={class:"form-group"},cw={class:"form-group"},dw={class:"icon-picker"},uw=["title","onClick"],mw={class:"form-group"},vw={class:"form-group"},fw={class:"form-group"},Aw={key:6,class:"form-row"},pw={class:"form-group flex-1"},hw={class:"form-group quantity"},gw={class:"constraints-section"},yw={key:0,class:"constraints-badge"},bw={key:0,class:"constraints-body"},kw={class:"constraint-group"},xw={class:"chips-grid"},ww=["onClick"],Cw={class:"constraint-group"},$w={class:"chips-grid"},_w=["onClick"],Tw={class:"constraint-row"},Iw={class:"constraint-slider"},Sw={class:"constraint-slider"},Ew={key:8,class:"send-section"},Pw={class:"recipients-grid"},Mw=["disabled","onClick","title"],Dw={key:1,class:"char-initial"},Bw={class:"recipient-info"},Rw={class:"recipient-name"},Fw=["disabled"],Lw={key:9,class:"send-section"},Nw={class:"recipients-grid"},Ow=["disabled","onClick","title"],Hw={key:1,class:"char-initial"},qw={class:"recipient-info"},Uw={class:"recipient-name"},Ww={class:"recipient-char"},zw=["disabled"],Vw={key:0,class:"save-template-form"},Qw={class:"template-form-header"},jw={class:"form-group"},Gw={class:"form-group"},Yw={class:"form-group"},Xw={class:"icon-picker"},Zw=["onClick","title"],Jw={class:"form-group"},Kw={class:"color-picker"},eC=["onClick"],tC=["disabled"],sC={__name:"MasterSceneTools",props:{compact:{type:Boolean,default:!1}},emits:["close","event-sent","templates-updated"],setup(t,{expose:l,emit:o}){const a=o,r=Zn(),c=cs(),f=ws();on();const k=xs(),{connections:w}=jt(c),x=R(null),T=[{id:"text",label:"Текст",icon:"mdi:message-text",color:"#94a3b8"},{id:"skill-check",label:"Проверка",icon:"mdi:dice-d20",color:"#f59e0b"},{id:"battle-invite",label:"В бой",icon:"mdi:sword-cross",color:"#ef4444"},{id:"image",label:"Картинка",icon:"mdi:image",color:"#8b5cf6"},{id:"important",label:"Важное",icon:"mdi:alert-circle",color:"#f59e0b"},{id:"quest",label:"Квест",icon:"mdi:map-marker-star",color:"#eab308"},{id:"item-give",label:"Предмет",icon:"mdi:gift",color:"#22c55e"},{id:"character-invite",label:"Персонаж",icon:"mdi:account-plus",color:"#3b82f6"}],y=$=>{x.value=x.value===$?null:$,X()},B=R({text:"",isSecret:!1}),m=R({checkType:"war",difficultyIndex:3,description:"",isSecret:!1}),Y=R({description:"",mapId:""}),j=R({url:"",description:""}),F=R({title:"",text:"",icon:"mdi:alert-circle"}),ie=R({title:"",description:"",objectives:""}),W=R({itemName:"",quantity:1,description:""}),S=R({allowedRaces:[],allowedSubraces:[],allowedClasses:[],maxWealth:5,maxEpoch:5}),Z=R(new Set),K=R(new Set),X=()=>{B.value={text:"",isSecret:!1},m.value={checkType:"war",difficultyIndex:3,description:"",isSecret:!1},Y.value={description:"",mapId:""},j.value={url:"",description:""},F.value={title:"",text:"",icon:"mdi:alert-circle"},ie.value={title:"",description:"",objectives:""},W.value={itemName:"",quantity:1,description:""},S.value={allowedRaces:[],allowedSubraces:[],allowedClasses:[],maxWealth:5,maxEpoch:5},Z.value=new Set,K.value=new Set},U=R([]),D=R(!1),b=R(""),d=R("mdi:file-document"),oe=R("#3b82f6"),he=R(""),M=[{icon:"mdi:skull",label:"Монстр"},{icon:"mdi:spider",label:"Паук"},{icon:"mdi:snake",label:"Змея"},{icon:"mdi:bat",label:"Летучая мышь"},{icon:"mdi:ghost",label:"Призрак"},{icon:"mdi:alien",label:"Пришелец"},{icon:"mdi:paw",label:"Зверь"},{icon:"mdi:bird",label:"Птица"},{icon:"mdi:fish",label:"Рыба"},{icon:"mdi:bug",label:"Насекомое"},{icon:"mdi:castle",label:"Замок"},{icon:"mdi:home",label:"Дом"},{icon:"mdi:pine-tree",label:"Лес"},{icon:"mdi:terrain",label:"Горы"},{icon:"mdi:waves",label:"Вода"},{icon:"mdi:fire",label:"Огонь"},{icon:"mdi:weather-sunny",label:"Солнце"},{icon:"mdi:weather-night",label:"Ночь"},{icon:"mdi:city",label:"Город"},{icon:"mdi:bridge",label:"Мост"},{icon:"mdi:sword-cross",label:"Бой"},{icon:"mdi:treasure-chest",label:"Сокровище"},{icon:"mdi:map-marker",label:"Локация"},{icon:"mdi:alert-circle",label:"Важное"},{icon:"mdi:help-circle",label:"Загадка"},{icon:"mdi:account-group",label:"НПС"},{icon:"mdi:script-text",label:"Текст"},{icon:"mdi:image",label:"Картинка"},{icon:"mdi:star",label:"Особое"},{icon:"mdi:flag",label:"Квест"}],de=["#ef4444","#f97316","#eab308","#22c55e","#14b8a6","#3b82f6","#8b5cf6","#ec4899","#64748b","#78716c"],H=R(!1),z=ne(()=>{var P,N,Ge;const $=S.value;return((P=$.allowedRaces)==null?void 0:P.length)>0||((N=$.allowedClasses)==null?void 0:N.length)>0||((Ge=$.allowedSubraces)==null?void 0:Ge.length)>0||$.maxWealth<5||$.maxEpoch<5}),q=ne(()=>{var N,Ge,rt;const $=S.value;let P=0;return((N=$.allowedRaces)==null?void 0:N.length)>0&&(P+=$.allowedRaces.length),((Ge=$.allowedClasses)==null?void 0:Ge.length)>0&&(P+=$.allowedClasses.length),((rt=$.allowedSubraces)==null?void 0:rt.length)>0&&(P+=$.allowedSubraces.length),$.maxWealth<5&&P++,$.maxEpoch<5&&P++,P}),Ie=($,P)=>{const N=S.value[$],Ge=N.indexOf(P);Ge===-1?N.push(P):N.splice(Ge,1)},C=ne(()=>nn.classes.filter($=>{var N;return((N=$.aspects)==null?void 0:N.length)!==2||!$.edges||$.edges.length===0?!1:$.edges.every(Ge=>Ge.type==="aspect")})),L=()=>{S.value.allowedClasses=C.value.map($=>$.id)};rs(()=>{const $=localStorage.getItem("scene-templates-v2");if($)try{U.value=JSON.parse($)}catch(P){console.error("Failed to load templates:",P),U.value=[]}});const $e=()=>{localStorage.setItem("scene-templates-v2",JSON.stringify(U.value))},Ae=()=>{if(!b.value.trim()||!Pe.value)return;const $=Re();if(!$)return;const P={id:Date.now().toString(),name:b.value.trim(),icon:d.value,color:oe.value,tags:he.value.split(",").map(N=>N.trim()).filter(Boolean),tool:x.value,data:$,sent:!1};U.value.push(P),$e(),a("templates-updated",U.value),D.value=!1,b.value="",he.value=""},Ee=$=>{U.value=U.value.filter(P=>P.id!==$),$e(),a("templates-updated",U.value)},Se=$=>{const P=U.value.find(N=>N.id===$);P&&(P.sent=!P.sent,$e(),a("templates-updated",U.value))},Be=$=>{const P=U.value.find(N=>N.id===$);P&&(P.sent=!0,$e(),a("templates-updated",U.value))},He=R(null),Ne=$=>{switch(x.value=$.tool,He.value=$.id,$.tool){case"text":B.value={text:$.data.text||"",isSecret:$.data.isSecret||!1};break;case"skill-check":const P=We.value.findIndex(N=>N.value===$.data.difficulty);m.value={checkType:$.data.checkType||"war",difficultyIndex:P>=0?P:3,description:$.data.description||"",isSecret:$.data.isSecret||!1};break;case"image":j.value={url:$.data.url||"",description:$.data.description||""};break;case"important":F.value={title:$.data.title||"",text:$.data.text||"",icon:$.data.icon||"mdi:alert-circle"};break;case"quest":ie.value={title:$.data.title||"",description:$.data.description||"",objectives:$.data.objectives||""};break;case"item-give":W.value={itemName:$.data.itemName||"",quantity:$.data.quantity||1,description:$.data.description||""};break;case"battle-invite":Y.value={description:$.data.description||"",mapId:$.data.mapId||""};break;case"character-invite":$.data.constraints&&(S.value={allowedRaces:$.data.constraints.allowedRaces||[],allowedSubraces:$.data.constraints.allowedSubraces||[],allowedClasses:$.data.constraints.allowedClasses||[],maxWealth:$.data.constraints.maxWealth??5,maxEpoch:$.data.constraints.maxEpoch??5});break}},ot=ne(()=>Yt.aspects.map($=>({id:$.id,name:$.check.name,color:$.color,icon:$.checkIcon}))),We=ne(()=>{const $=[];return Object.keys(ss).map(Number).sort((N,Ge)=>N-Ge).forEach(N=>{$.push({value:N,...ss[N]})}),$}),ce=ne(()=>{const $=m.value.difficultyIndex;return We.value[$]||We.value[0]}),Je=ne(()=>f.allPlayerCharacters.map(P=>{var rt;const N=w.value.find(ft=>ft.userId===P.ownerId),Ge=((rt=N==null?void 0:N.conn)==null?void 0:rt.open)||!1;return{characterId:P.id,characterName:P.name,characterPortrait:P.portrait,ownerId:P.ownerId,ownerName:P.ownerNickname||(N==null?void 0:N.alias)||"Игрок",online:Ge,sent:Z.value.has(P.id)}})),Ke=ne(()=>c.allPlayers.map($=>({userId:$.userId,alias:$.alias,avatar:$.avatar,online:$.online,sent:K.value.has($.userId)}))),xe=ne(()=>Ke.value.length===0?!1:Ke.value.every($=>$.sent));R(!1);const Me=ne(()=>Je.value.length===0?!1:Je.value.every($=>$.sent)),Pe=ne(()=>{switch(x.value){case"text":return B.value.text.trim().length>0;case"skill-check":return!0;case"battle-invite":return!0;case"image":return j.value.url.trim().length>0;case"important":return F.value.title.trim().length>0;case"quest":return ie.value.title.trim().length>0;case"item-give":return W.value.itemName.trim().length>0;case"character-invite":return!0;default:return!1}}),Re=()=>{switch(x.value){case"text":return B.value.text.trim()?{type:tt.TEXT,text:B.value.text.trim(),isSecret:B.value.isSecret}:null;case"skill-check":const $=ce.value;return{type:tt.SKILL_CHECK,checkType:m.value.checkType,difficulty:$.value,difficultyName:$.name,difficultyColor:$.color,isSecret:m.value.isSecret,description:m.value.description,completed:!1,result:null};case"battle-invite":return{type:tt.BATTLE_INVITE,description:Y.value.description,mapId:Y.value.mapId||null};case"image":return j.value.url.trim()?{type:tt.IMAGE,url:j.value.url.trim(),description:j.value.description}:null;case"important":return F.value.title.trim()?{type:tt.IMPORTANT,title:F.value.title.trim(),text:F.value.text,icon:F.value.icon}:null;case"quest":if(!ie.value.title.trim())return null;const P=ie.value.objectives.split(`
`).filter(N=>N.trim()).map(N=>({text:N.trim(),completed:!1}));return{type:tt.QUEST,title:ie.value.title.trim(),description:ie.value.description,objectives:P};case"item-give":return W.value.itemName.trim()?{type:tt.ITEM_GIVE,items:[{id:crypto.randomUUID(),name:W.value.itemName.trim(),quantity:W.value.quantity}],description:W.value.description,accepted:!1}:null;case"character-invite":return{type:tt.CHARACTER_INVITE,constraints:{allowedRaces:S.value.allowedRaces||[],allowedSubraces:S.value.allowedSubraces||[],allowedClasses:S.value.allowedClasses||[],maxWealth:S.value.maxWealth??10,maxEpoch:S.value.maxEpoch??10},accepted:!1};default:return null}},ke=$=>{var dt;const P=Re();if(!P)return;const N=f.characters.find($t=>$t.id===$);if(!N)return;const Ge=N.ownerId,rt={...P,targetCharacterIds:[$],targetUserIds:[Ge],targetCharacterName:N.name,targetCharacterPortrait:N.portrait},ft=w.value.find($t=>$t.userId===Ge),Et=(dt=ft==null?void 0:ft.conn)==null?void 0:dt.open,At=r.addEvent({...rt,deliveredTo:Et?[Ge]:[]});Et&&ft.conn.send({type:"scene-event",event:At}),Z.value.add($),Z.value=new Set(Z.value),a("event-sent",At)},ge=()=>{const $=Re();if(!$)return;const P=Je.value;P.map(ft=>ft.characterId);const N=P.filter(ft=>ft.online).map(ft=>ft.ownerId),Ge={...$,targetCharacterIds:null,targetUserIds:null,deliveredTo:N},rt=r.addEvent(Ge);c.broadcastPayload({type:"scene-event",event:rt}),He.value&&(Be(He.value),He.value=null),a("event-sent",rt),x.value=null,X()},ae=$=>{var At;const P=Re();if(!P||P.type!==tt.CHARACTER_INVITE||!Ke.value.find(dt=>dt.userId===$))return;const Ge={...P,targetUserIds:[$],targetCharacterIds:null,usedBy:[]},rt=w.value.find(dt=>dt.userId===$),ft=(At=rt==null?void 0:rt.conn)==null?void 0:At.open,Et=r.addEvent({...Ge,deliveredTo:ft?[$]:[]});ft&&rt.conn.send({type:"scene-event",event:Et}),K.value.add($),K.value=new Set(K.value),a("event-sent",Et)},Xe=()=>{const $=Re();if(!$||$.type!==tt.CHARACTER_INVITE)return;const N=Ke.value.filter(ft=>ft.online).map(ft=>ft.userId),Ge={...$,targetUserIds:null,targetCharacterIds:null,usedBy:[],deliveredTo:N},rt=r.addEvent(Ge);c.broadcastPayload({type:"scene-event",event:rt}),He.value&&(Be(He.value),He.value=null),a("event-sent",rt),x.value=null,X()},Ze=$=>{x.value==="image"&&(r.setSceneImage(j.value.url.trim(),j.value.description,c.userId),ke($))},vt=()=>{x.value==="image"&&(r.setSceneImage(j.value.url.trim(),j.value.description,c.userId),ge())},te=()=>{r.clearSceneImage(),c.broadcastPayload({type:"scene-event",event:{id:crypto.randomUUID(),type:tt.CLEAR_IMAGE,time:Date.now()}})},J=()=>{x.value=null,He.value=null,X()},Te=[{value:"mdi:alert-circle",label:"Внимание"},{value:"mdi:information",label:"Информация"},{value:"mdi:star",label:"Важно"},{value:"mdi:shield",label:"Защита"},{value:"mdi:skull",label:"Опасность"},{value:"mdi:treasure-chest",label:"Награда"}];return l({templates:U,loadTemplate:Ne,deleteTemplate:Ee,toggleTemplateSent:Se}),($,P)=>(s(),n("div",{class:Q(["master-scene-tools",{compact:t.compact}])},[e("div",F2,[e("h3",L2,[A(i(p),{icon:"mdi:broadcast"}),P[29]||(P[29]=Ce(" Инструменты сцены ",-1))]),t.compact?(s(),n("button",{key:0,class:"close-btn",onClick:P[0]||(P[0]=N=>a("close"))},[A(i(p),{icon:"mdi:close"})])):_("",!0)]),e("div",N2,[(s(),n(ee,null,me(T,N=>e("button",{key:N.id,class:Q(["tool-btn",{active:x.value===N.id}]),style:Qe({"--tool-color":N.color}),onClick:Ge=>y(N.id)},[A(i(p),{icon:N.icon,class:"tool-icon"},null,8,["icon"]),e("span",H2,h(N.label),1)],14,O2)),64))]),A(Ps,{name:"slide-down"},{default:ys(()=>[x.value?(s(),n("div",q2,[x.value==="text"?(s(),n(ee,{key:0},[e("div",U2,[P[30]||(P[30]=e("label",null,"Сообщение",-1)),De(e("textarea",{"onUpdate:modelValue":P[1]||(P[1]=N=>B.value.text=N),placeholder:"Введите текст...",rows:"3"},null,512),[[je,B.value.text]])]),e("label",W2,[De(e("input",{type:"checkbox","onUpdate:modelValue":P[2]||(P[2]=N=>B.value.isSecret=N)},null,512),[[On,B.value.isSecret]]),P[31]||(P[31]=Ce(" Секретно (только видевшие увидят) ",-1))])],64)):x.value==="skill-check"?(s(),n(ee,{key:1},[e("div",z2,[P[32]||(P[32]=e("label",null,"Тип проверки",-1)),e("div",V2,[(s(!0),n(ee,null,me(ot.value,N=>(s(),n("button",{key:N.id,type:"button",class:Q(["check-type-btn",{active:m.value.checkType===N.id}]),style:Qe({"--check-color":N.color}),onClick:Ge=>m.value.checkType=N.id},[A(i(p),{icon:N.icon,class:"check-type-icon"},null,8,["icon"]),e("span",null,h(N.name),1)],14,Q2))),128))])]),e("div",j2,[e("label",null,[P[33]||(P[33]=Ce(" Сложность: ",-1)),e("span",{class:"difficulty-badge",style:Qe({backgroundColor:ce.value.color,color:ce.value.lightText?"#fff":"#000"})},h(ce.value.name)+" ("+h(ce.value.value)+") ",5)]),e("div",G2,[De(e("input",{type:"range","onUpdate:modelValue":P[3]||(P[3]=N=>m.value.difficultyIndex=N),min:0,max:We.value.length-1,class:"difficulty-slider",style:Qe({"--slider-color":ce.value.color})},null,12,Y2),[[je,m.value.difficultyIndex,void 0,{number:!0}]]),e("div",X2,[(s(!0),n(ee,null,me(We.value,(N,Ge)=>(s(),n("span",{key:N.value,class:Q(["difficulty-mark",{active:Ge===m.value.difficultyIndex}]),style:Qe({left:`${Ge/(We.value.length-1)*100}%`}),title:N.name},[e("span",{class:"mark-dot",style:Qe({backgroundColor:N.color})},null,4)],14,Z2))),128))])])]),e("div",J2,[P[34]||(P[34]=e("label",null,"Описание (опц.)",-1)),De(e("input",{type:"text","onUpdate:modelValue":P[4]||(P[4]=N=>m.value.description=N),placeholder:"Что проверяем?"},null,512),[[je,m.value.description]])]),e("label",K2,[De(e("input",{type:"checkbox","onUpdate:modelValue":P[5]||(P[5]=N=>m.value.isSecret=N)},null,512),[[On,m.value.isSecret]]),P[35]||(P[35]=Ce(" Секретная проверка ",-1))])],64)):x.value==="battle-invite"?(s(),n(ee,{key:2},[e("div",ew,[P[36]||(P[36]=e("label",null,"Описание (опц.)",-1)),De(e("input",{type:"text","onUpdate:modelValue":P[6]||(P[6]=N=>Y.value.description=N),placeholder:"Начало битвы..."},null,512),[[je,Y.value.description]])]),e("div",tw,[P[38]||(P[38]=e("label",null,"Карта сражения (опц.)",-1)),De(e("select",{"onUpdate:modelValue":P[7]||(P[7]=N=>Y.value.mapId=N)},[P[37]||(P[37]=e("option",{value:""},"Текущая карта",-1)),(s(!0),n(ee,null,me(i(k).maps,N=>(s(),n("option",{key:N.id,value:N.id},h(N.name||"Карта "+N.id.slice(0,6)),9,sw))),128))],512),[[Kt,Y.value.mapId]])])],64)):x.value==="image"?(s(),n(ee,{key:3},[e("div",nw,[P[39]||(P[39]=e("label",null,"URL изображения",-1)),De(e("input",{type:"url","onUpdate:modelValue":P[8]||(P[8]=N=>j.value.url=N),placeholder:"https://..."},null,512),[[je,j.value.url]])]),j.value.url.trim()?(s(),n("div",lw,[e("img",{src:j.value.url,alt:"Предпросмотр",onError:P[9]||(P[9]=N=>N.target.style.display="none"),onLoad:P[10]||(P[10]=N=>N.target.style.display="block")},null,40,ow)])):_("",!0),e("div",aw,[P[40]||(P[40]=e("label",null,"Описание",-1)),De(e("textarea",{"onUpdate:modelValue":P[11]||(P[11]=N=>j.value.description=N),placeholder:"Что на картинке?",rows:"2"},null,512),[[je,j.value.description]])]),e("button",{class:"clear-btn",onClick:te},[A(i(p),{icon:"mdi:image-off"}),P[41]||(P[41]=Ce(" Очистить изображение сцены ",-1))])],64)):x.value==="important"?(s(),n(ee,{key:4},[e("div",iw,[P[42]||(P[42]=e("label",null,"Заголовок",-1)),De(e("input",{type:"text","onUpdate:modelValue":P[12]||(P[12]=N=>F.value.title=N),placeholder:"Важное событие!"},null,512),[[je,F.value.title]])]),e("div",rw,[P[43]||(P[43]=e("label",null,"Текст",-1)),De(e("textarea",{"onUpdate:modelValue":P[13]||(P[13]=N=>F.value.text=N),placeholder:"Подробности...",rows:"2"},null,512),[[je,F.value.text]])]),e("div",cw,[P[44]||(P[44]=e("label",null,"Иконка",-1)),e("div",dw,[(s(),n(ee,null,me(Te,N=>e("button",{key:N.value,type:"button",class:Q(["icon-option",{active:F.value.icon===N.value}]),title:N.label,onClick:Ge=>F.value.icon=N.value},[A(i(p),{icon:N.value},null,8,["icon"])],10,uw)),64))])])],64)):x.value==="quest"?(s(),n(ee,{key:5},[e("div",mw,[P[45]||(P[45]=e("label",null,"Название квеста",-1)),De(e("input",{type:"text","onUpdate:modelValue":P[14]||(P[14]=N=>ie.value.title=N),placeholder:"Найти сокровище..."},null,512),[[je,ie.value.title]])]),e("div",vw,[P[46]||(P[46]=e("label",null,"Описание",-1)),De(e("textarea",{"onUpdate:modelValue":P[15]||(P[15]=N=>ie.value.description=N),placeholder:"Подробности задания...",rows:"2"},null,512),[[je,ie.value.description]])]),e("div",fw,[P[47]||(P[47]=e("label",null,"Цели (по одной на строку)",-1)),De(e("textarea",{"onUpdate:modelValue":P[16]||(P[16]=N=>ie.value.objectives=N),placeholder:`Поговорить с NPC
Найти ключ
Открыть дверь`,rows:"3"},null,512),[[je,ie.value.objectives]])])],64)):x.value==="item-give"?(s(),n("div",Aw,[e("div",pw,[P[48]||(P[48]=e("label",null,"Предмет",-1)),De(e("input",{type:"text","onUpdate:modelValue":P[17]||(P[17]=N=>W.value.itemName=N),placeholder:"Зелье здоровья"},null,512),[[je,W.value.itemName]])]),e("div",hw,[P[49]||(P[49]=e("label",null,"Кол-во",-1)),De(e("input",{type:"number","onUpdate:modelValue":P[18]||(P[18]=N=>W.value.quantity=N),min:"1"},null,512),[[je,W.value.quantity,void 0,{number:!0}]])])])):x.value==="character-invite"?(s(),n(ee,{key:7},[P[53]||(P[53]=e("p",{class:"form-hint"},"Игрок получит приглашение создать нового персонажа",-1)),e("div",gw,[e("div",{class:"constraints-header",onClick:P[19]||(P[19]=N=>H.value=!H.value)},[A(i(p),{icon:H.value?"mdi:chevron-down":"mdi:chevron-right"},null,8,["icon"]),P[50]||(P[50]=e("span",null,"Ограничения",-1)),z.value?(s(),n("span",yw,h(q.value),1)):_("",!0)]),H.value?(s(),n("div",bw,[e("div",kw,[P[51]||(P[51]=e("label",null,[Ce("Разрешённые расы "),e("span",{class:"hint"},"(пусто = все)")],-1)),e("div",xw,[(s(!0),n(ee,null,me(i(il).races,N=>(s(),n("button",{key:N.id,class:Q(["chip",{active:S.value.allowedRaces.includes(N.id)}]),onClick:Ge=>Ie("allowedRaces",N.id)},h(N.name),11,ww))),128))])]),e("div",Cw,[e("div",{class:"constraint-header"},[P[52]||(P[52]=e("label",null,[Ce("Разрешённые классы "),e("span",{class:"hint"},"(пусто = все)")],-1)),e("button",{class:"preset-btn",onClick:L,title:"Только внутренние классы (между двумя аспектами)"}," ⚙️ Внутренние ")]),e("div",$w,[(s(!0),n(ee,null,me(i(nn).classes,N=>(s(),n("button",{key:N.id,class:Q(["chip",{active:S.value.allowedClasses.includes(N.id)}]),onClick:Ge=>Ie("allowedClasses",N.id)},h(typeof N.name=="object"?N.name.m:N.name),11,_w))),128))])]),e("div",Tw,[e("div",Iw,[e("label",null,"Благосостояние: "+h(S.value.maxWealth),1),De(e("input",{type:"range",min:"1",max:"10","onUpdate:modelValue":P[20]||(P[20]=N=>S.value.maxWealth=N)},null,512),[[je,S.value.maxWealth,void 0,{number:!0}]])]),e("div",Sw,[e("label",null,"Эпоха: "+h(S.value.maxEpoch),1),De(e("input",{type:"range",min:"1",max:"10","onUpdate:modelValue":P[21]||(P[21]=N=>S.value.maxEpoch=N)},null,512),[[je,S.value.maxEpoch,void 0,{number:!0}]])])])])):_("",!0)])],64)):_("",!0),x.value==="character-invite"?(s(),n("div",Ew,[P[56]||(P[56]=e("div",{class:"send-label"},"Отправить игроку:",-1)),e("div",Pw,[(s(!0),n(ee,null,me(Ke.value,N=>(s(),n("button",{key:N.userId,class:Q(["recipient-btn",{sent:N.sent,offline:!N.online}]),disabled:!Pe.value||N.sent,onClick:Ge=>ae(N.userId),title:N.sent?`Отправлено: ${N.alias}`:`Отправить: ${N.alias}`+(N.online?"":" (офлайн)")},[N.avatar?(s(),st(Os,{key:0,avatar:N.avatar,size:"md",class:"player-avatar"},null,8,["avatar"])):(s(),n("div",Dw,h((N.alias||"?")[0].toUpperCase()),1)),e("div",Bw,[e("span",Rw,h(N.alias),1)]),N.sent?(s(),st(i(p),{key:2,icon:"mdi:check-circle",class:"sent-icon"})):N.online?_("",!0):(s(),st(i(p),{key:3,icon:"mdi:wifi-off",class:"offline-icon"}))],10,Mw))),128))]),e("button",{class:Q(["send-all-btn",{sent:xe.value}]),disabled:!Pe.value,onClick:P[22]||(P[22]=N=>Xe())},[A(i(p),{icon:"mdi:account-group"}),P[54]||(P[54]=e("span",null,"Отправить всем",-1))],10,Fw),Pe.value&&!D.value?(s(),n("button",{key:0,class:"template-btn",onClick:P[23]||(P[23]=N=>D.value=!0),title:"Сохранить как шаблон"},[A(i(p),{icon:"mdi:content-save-plus"})])):_("",!0),K.value.size>0?(s(),n("button",{key:1,class:"finish-btn",onClick:J},[A(i(p),{icon:"mdi:check"}),P[55]||(P[55]=Ce(" Готово ",-1))])):_("",!0)])):(s(),n("div",Lw,[P[59]||(P[59]=e("div",{class:"send-label"},"Отправить:",-1)),e("div",Nw,[(s(!0),n(ee,null,me(Je.value,N=>(s(),n("button",{key:N.characterId,class:Q(["recipient-btn",{sent:N.sent,offline:!N.online}]),disabled:!Pe.value||N.sent,onClick:Ge=>x.value==="image"?Ze(N.characterId):ke(N.characterId),title:N.sent?`Отправлено: ${N.characterName}`:`Отправить: ${N.characterName}`+(N.online?"":" (игрок офлайн)")},[N.characterPortrait?(s(),st(Es,{key:0,portrait:N.characterPortrait,size:44,showBorder:!0},null,8,["portrait"])):(s(),n("div",Hw,h((N.characterName||"?")[0].toUpperCase()),1)),e("div",qw,[e("span",Uw,h(N.characterName),1),e("span",Ww,h(N.ownerName),1)]),N.sent?(s(),st(i(p),{key:2,icon:"mdi:check-circle",class:"sent-icon"})):N.online?_("",!0):(s(),st(i(p),{key:3,icon:"mdi:wifi-off",class:"offline-icon"}))],10,Ow))),128))]),e("button",{class:Q(["send-all-btn",{sent:Me.value}]),disabled:!Pe.value,onClick:P[24]||(P[24]=N=>x.value==="image"?vt():ge())},[A(i(p),{icon:"mdi:account-group"}),P[57]||(P[57]=e("span",null,"Отправить всем",-1))],10,zw),Pe.value&&!D.value?(s(),n("button",{key:0,class:"template-btn",onClick:P[25]||(P[25]=N=>D.value=!0),title:"Сохранить как шаблон"},[A(i(p),{icon:"mdi:content-save-plus"})])):_("",!0),Z.value.size>0?(s(),n("button",{key:1,class:"finish-btn",onClick:J},[A(i(p),{icon:"mdi:check"}),P[58]||(P[58]=Ce(" Готово ",-1))])):_("",!0)])),A(Ps,{name:"slide-down"},{default:ys(()=>[D.value?(s(),n("div",Vw,[e("div",Qw,[P[60]||(P[60]=e("span",null,"Сохранить как шаблон",-1)),e("button",{class:"close-btn",onClick:P[26]||(P[26]=N=>D.value=!1)},[A(i(p),{icon:"mdi:close"})])]),e("div",jw,[P[61]||(P[61]=e("label",null,"Название",-1)),De(e("input",{"onUpdate:modelValue":P[27]||(P[27]=N=>b.value=N),type:"text",placeholder:"Название шаблона...",class:"form-input"},null,512),[[je,b.value]])]),e("div",Gw,[P[62]||(P[62]=e("label",null,"Теги (через запятую)",-1)),De(e("input",{"onUpdate:modelValue":P[28]||(P[28]=N=>he.value=N),type:"text",placeholder:"монстр, босс, подземелье...",class:"form-input"},null,512),[[je,he.value]])]),e("div",Yw,[P[63]||(P[63]=e("label",null,"Иконка",-1)),e("div",Xw,[(s(),n(ee,null,me(M,N=>e("button",{key:N.icon,class:Q(["icon-option",{active:d.value===N.icon}]),style:Qe({color:d.value===N.icon?oe.value:void 0}),onClick:Ge=>d.value=N.icon,title:N.label},[A(i(p),{icon:N.icon},null,8,["icon"])],14,Zw)),64))])]),e("div",Jw,[P[64]||(P[64]=e("label",null,"Цвет",-1)),e("div",Kw,[(s(),n(ee,null,me(de,N=>e("button",{key:N,class:Q(["color-option",{active:oe.value===N}]),style:Qe({background:N}),onClick:Ge=>oe.value=N},null,14,eC)),64))])]),e("button",{class:"save-template-btn",disabled:!b.value.trim(),onClick:Ae},[A(i(p),{icon:"mdi:content-save"}),P[65]||(P[65]=Ce(" Сохранить шаблон ",-1))],8,tC)])):_("",!0)]),_:1})])):_("",!0)]),_:1})],2))}},nC=zt(sC,[["__scopeId","data-v-5436ff13"]]),lC={class:"bg-slate-900/60 border border-white/10 rounded-2xl p-6 space-y-4"},oC={class:"flex items-center justify-between gap-3"},aC={class:"text-xs px-3 py-1 rounded-full border border-white/10 uppercase tracking-wide text-slate-400"},iC=["disabled"],rC={key:0,class:"flex flex-col gap-3"},cC={class:"flex items-center gap-2"},dC={class:"flex-1 rounded-xl border border-white/10 px-4 py-3 font-mono text-xl tracking-[0.3em] text-center"},uC=["disabled"],mC={key:1,class:"space-y-2"},vC={class:"space-y-2"},fC={class:"font-medium"},AC={class:"text-xs text-slate-400"},pC={key:2,class:"text-sm text-rose-300"},hC={__name:"MasterTools",setup(t){const l=cs(),{roomId:o,status:a,error:r,connections:c}=jt(l),f=ne(()=>a.value==="connecting"),k=ne(()=>!!o.value),w=ne(()=>k.value&&!f.value),x=()=>{f.value||(k.value?l.createNewRoom():l.createRoom())},T=async()=>{if(w.value)try{await navigator.clipboard.writeText(o.value)}catch(y){console.error("Clipboard copy failed",y)}};return(y,B)=>(s(),n("div",lC,[e("div",oC,[B[0]||(B[0]=e("div",null,[e("p",{class:"text-sm uppercase tracking-[0.2em] text-slate-500"},"Шаг 2"),e("h2",{class:"text-xl font-semibold"},"Создайте комнату")],-1)),e("span",aC,h(i(a)),1)]),e("button",{type:"button",class:"w-full rounded-xl bg-sky-500/20 border border-sky-400/60 py-3 text-lg font-semibold text-sky-100 hover:bg-sky-500/30 transition",disabled:f.value,onClick:x},h(k.value?"Создать новую комнату":"Создать комнату"),9,iC),k.value?(s(),n("div",rC,[B[1]||(B[1]=e("p",{class:"text-sm text-slate-400"},"Этим кодом делитесь с игроками:",-1)),e("div",cC,[e("div",dC,h(i(o)),1),e("button",{type:"button",class:"px-4 py-3 rounded-xl border border-white/20 hover:border-sky-400/70 text-sm",disabled:!w.value,onClick:T}," Копировать ",8,uC)])])):_("",!0),i(c).length?(s(),n("div",mC,[B[2]||(B[2]=e("p",{class:"text-sm uppercase tracking-[0.2em] text-slate-500"},"Игроки",-1)),e("ul",vC,[(s(!0),n(ee,null,me(i(c),m=>(s(),n("li",{key:m.peerId,class:"flex items-center justify-between rounded-xl border border-white/5 px-4 py-2 bg-slate-950/60"},[e("span",fC,h(m.alias),1),e("span",AC,h(m.ready?"онлайн":"подключается"),1)]))),128))])])):_("",!0),i(r)?(s(),n("p",pC,h(i(r)),1)):_("",!0)]))}},gC={key:0,class:"hp-display"},yC={key:0,class:"hp-compact"},bC={class:"hp-text"},kC={key:0,class:"hp-penalty"},xC={key:1,class:"hp-full"},wC={class:"hp-header"},CC={class:"hp-value"},$C={key:0,class:"hp-penalty-badge"},_C={class:"hp-groups"},TC=["onClick"],IC={key:1,class:"wounds-display"},SC={key:0,class:"wounds-compact"},EC={key:0,class:"wound-healthy"},PC={key:1,class:"wounds-full"},MC=["onClick","onContextmenu","onTouchstart","onTouchend"],DC={class:"wound-header"},BC={class:"wound-icon"},RC={class:"wound-label"},FC={class:"wound-slots"},LC={class:"wound-count"},NC=500,OC={__name:"HealthDisplay",props:{combat:{type:Object,required:!0},stats:{type:Object,default:()=>({})},compact:{type:Boolean,default:!1},readonly:{type:Boolean,default:!1}},emits:["update:hp","add-wound","remove-wound","toggle-health-type"],setup(t,{emit:l}){const o=t,a=l,r=ne(()=>{var Z;return((Z=o.combat)==null?void 0:Z.healthType)||"simple"}),c=ne(()=>{var Z;return((Z=o.combat)==null?void 0:Z.hp)||0}),f=ne(()=>{var Z;return((Z=o.combat)==null?void 0:Z.maxHp)||8}),k=ne(()=>{const Z=[],X=f.value,U=X%3;let D=0;if(U>0){const b=[];for(let d=0;d<U;d++)b.push({index:D,filled:D<c.value}),D++;Z.push(b)}for(;D<X;){const b=[];for(let d=0;d<3&&D<X;d++)b.push({index:D,filled:D<c.value}),D++;Z.push(b)}return Z}),w=ne(()=>{const Z=f.value-c.value;return Math.floor(Z/3)}),x=ne(()=>{var Z;return((Z=o.combat)==null?void 0:Z.wounds)||{scratch:0,light:0,heavy:0,deadly:0}}),T=ne(()=>{var Z;return((Z=o.combat)==null?void 0:Z.bonusDeadlySlots)||0}),y=ne(()=>{const Z=Us(o.stats,T.value);return{scratch:{...Z.scratch,total:Z.scratch.base+Z.scratch.bonus,filled:x.value.scratch,label:"Царапины",icon:"🩹",color:"amber"},light:{...Z.light,total:Z.light.base+Z.light.bonus,filled:x.value.light,label:"Лёгкие",icon:"🩸",color:"orange"},heavy:{...Z.heavy,total:Z.heavy.base+Z.heavy.bonus,filled:x.value.heavy,label:"Тяжёлые",icon:"💔",color:"rose"},deadly:{...Z.deadly,total:Z.deadly.base+Z.deadly.bonus,filled:x.value.deadly,label:"Смертельные",icon:"💀",color:"red"}}}),B=["scratch","light","heavy","deadly"],m=Z=>{const K=y.value[Z],X=[];K.bonus+K.base;const U=K.filled;for(let D=0;D<K.bonus;D++)X.push({index:D,isBonus:!0,filled:D<U});for(let D=0;D<K.base;D++)X.push({index:K.bonus+D,isBonus:!1,filled:K.bonus+D<U});return X};let Y=null;const j=Z=>{o.readonly||(Z<c.value?a("update:hp",c.value-1):a("update:hp",Math.min(f.value,c.value+1)))},F=(Z,K)=>{o.readonly||(K.preventDefault(),a("add-wound",Z))},ie=(Z,K)=>{o.readonly||(K.preventDefault(),a("remove-wound",Z))},W=(Z,K)=>{o.readonly||(Y=setTimeout(()=>{a("remove-wound",Z),Y=null},NC))},S=(Z,K)=>{o.readonly||Y&&(clearTimeout(Y),Y=null,a("add-wound",Z))};return(Z,K)=>(s(),n("div",{class:Q(["health-display",{compact:t.compact}])},[r.value==="simple"?(s(),n("div",gC,[t.compact?(s(),n("div",yC,[K[0]||(K[0]=e("span",{class:"hp-icon"},"❤️",-1)),e("span",bC,h(c.value)+"/"+h(f.value),1),w.value>0?(s(),n("span",kC,"-"+h(w.value),1)):_("",!0)])):(s(),n("div",xC,[e("div",wC,[K[1]||(K[1]=e("span",{class:"hp-label"},"HP",-1)),e("span",CC,h(c.value)+"/"+h(f.value),1),w.value>0?(s(),n("span",$C,"штраф: -"+h(w.value),1)):_("",!0)]),e("div",_C,[(s(!0),n(ee,null,me(k.value,(X,U)=>(s(),n("div",{key:U,class:"hp-group"},[(s(!0),n(ee,null,me(X,D=>(s(),n("div",{key:D.index,class:Q(["hp-cell",{filled:D.filled,clickable:!t.readonly}]),onClick:b=>j(D.index)},null,10,TC))),128))]))),128))])]))])):(s(),n("div",IC,[t.compact?(s(),n("div",SC,[(s(),n(ee,null,me(B,X=>(s(),n(ee,{key:X},[y.value[X].filled>0?(s(),n("span",{key:0,class:Q(["wound-badge",`wound-${y.value[X].color}`])},h(y.value[X].icon)+" "+h(y.value[X].filled),3)):_("",!0)],64))),64)),Object.values(x.value).every(X=>X===0)?(s(),n("span",EC," ✓ Здоров ")):_("",!0)])):(s(),n("div",PC,[(s(),n(ee,null,me(B,X=>e("div",{key:X,class:Q(["wound-column",[`wound-column-${y.value[X].color}`,`wound-column-${X}`,{clickable:!t.readonly}]]),onClick:U=>F(X,U),onContextmenu:U=>ie(X,U),onTouchstart:U=>W(X),onTouchend:U=>S(X)},[e("div",DC,[e("span",BC,h(y.value[X].icon),1),e("span",RC,h(y.value[X].label),1)]),e("div",FC,[(s(!0),n(ee,null,me(m(X),U=>(s(),n("div",{key:U.index,class:Q(["wound-slot",{filled:U.filled,bonus:U.isBonus}])},null,2))),128))]),e("div",LC,h(y.value[X].filled)+"/"+h(y.value[X].total),1)],42,MC)),64))]))]))],2))}},lo=zt(OC,[["__scopeId","data-v-7206f32a"]]),HC=[{id:"hat",name:"Шляпа",emoji:"🎩",svg:"M12 2C8 2 5 4 5 7v1H4c-1 0-2 1-2 2v2h20v-2c0-1-1-2-2-2h-1V7c0-3-3-5-7-5zm-8 14v4h16v-4H4z"},{id:"boot",name:"Ботинок",emoji:"🥾",svg:"M4 18h16l-2-6H10l-2-4H4v10z"},{id:"car",name:"Машина",emoji:"🚗",svg:"M19 7h-3L13.5 3H10.5L8 7H5c-1.1 0-2 .9-2 2v5c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V9c0-1.1-.9-2-2-2zM6 12c-.83 0-1.5-.67-1.5-1.5S5.17 9 6 9s1.5.67 1.5 1.5S6.83 12 6 12zm12 0c-.83 0-1.5-.67-1.5-1.5S17.17 9 18 9s1.5.67 1.5 1.5S18.83 12 18 12z"},{id:"ship",name:"Корабль",emoji:"⛵",svg:"M12 2L4 12h4v3c0 1 1 2 2 2h4c1 0 2-1 2-2v-3h4L12 2z"},{id:"dog",name:"Собака",emoji:"🐕",svg:"M18 4c-1 0-2 1-2 2v2H8V6c0-1-1-2-2-2s-2 1-2 2v8c0 2 2 4 4 4h8c2 0 4-2 4-4V6c0-1-1-2-2-2zm-8 10c-.6 0-1-.4-1-1s.4-1 1-1 1 .4 1 1-.4 1-1 1z"},{id:"cat",name:"Кот",emoji:"🐱",svg:"M12 2C9 2 6 4 6 7v1c-2 0-3 1-3 3s1 3 3 3v4c0 2 2 4 6 4s6-2 6-4v-4c2 0 3-1 3-3s-1-3-3-3V7c0-3-3-5-6-5z"},{id:"thimble",name:"Напёрсток",emoji:"🧵",svg:"M12 2c-3 0-6 2-6 5v10c0 2 2 4 6 4s6-2 6-4V7c0-3-3-5-6-5zm0 2c2 0 4 1 4 3v1H8V7c0-2 2-3 4-3z"},{id:"iron",name:"Утюг",emoji:"🔥",svg:"M4 12h12l2-4H6l-2 4zm0 2v4h16l-2-4H4z"},{id:"dragon",name:"Дракон",emoji:"🐉",svg:"M12 2c-2 0-4 1-5 3L5 8c-2 1-3 3-3 5v4c0 2 2 4 4 4h12c2 0 4-2 4-4v-4c0-2-1-4-3-5l-2-3c-1-2-3-3-5-3z"},{id:"sword",name:"Меч",emoji:"⚔️",svg:"M14.5 2L11 5.5 5.5 11l-3 6 3 3 6-3L17 11.5 20.5 8 14.5 2z"},{id:"shield",name:"Щит",emoji:"🛡️",svg:"M12 2L4 6v6c0 5 3 9 8 10 5-1 8-5 8-10V6l-8-4z"},{id:"crown",name:"Корона",emoji:"👑",svg:"M2 16l3-8 4 4 3-6 3 6 4-4 3 8H2z"},{id:"wizard",name:"Волшебник",emoji:"🧙",svg:"M12 2l3 7h-6l3-7zm-6 9h12l-1 9H7l-1-9z"},{id:"skull",name:"Череп",emoji:"💀",svg:"M12 2C8 2 5 5 5 9c0 2 1 4 2 5v5h10v-5c1-1 2-3 2-5 0-4-3-7-7-7zm-2 8c-.6 0-1-.4-1-1s.4-1 1-1 1 .4 1 1-.4 1-1 1zm4 0c-.6 0-1-.4-1-1s.4-1 1-1 1 .4 1 1-.4 1-1 1z"},{id:"dice",name:"Кубик",emoji:"🎲",svg:"M4 4h16v16H4V4zm4 4c-.6 0-1 .4-1 1s.4 1 1 1 1-.4 1-1-.4-1-1-1zm4 4c-.6 0-1 .4-1 1s.4 1 1 1 1-.4 1-1-.4-1-1-1zm4 4c-.6 0-1 .4-1 1s.4 1 1 1 1-.4 1-1-.4-1-1-1z"},{id:"gem",name:"Самоцвет",emoji:"💎",svg:"M12 2L4 8l8 12 8-12-8-6z"}],qC=[{id:"red",name:"Красный",value:"#ef4444"},{id:"orange",name:"Оранжевый",value:"#f97316"},{id:"amber",name:"Янтарный",value:"#f59e0b"},{id:"yellow",name:"Жёлтый",value:"#eab308"},{id:"lime",name:"Лайм",value:"#84cc16"},{id:"green",name:"Зелёный",value:"#22c55e"},{id:"emerald",name:"Изумрудный",value:"#10b981"},{id:"teal",name:"Бирюзовый",value:"#14b8a6"},{id:"cyan",name:"Голубой",value:"#06b6d4"},{id:"sky",name:"Небесный",value:"#0ea5e9"},{id:"blue",name:"Синий",value:"#3b82f6"},{id:"indigo",name:"Индиго",value:"#6366f1"},{id:"violet",name:"Фиолетовый",value:"#8b5cf6"},{id:"purple",name:"Пурпурный",value:"#a855f7"},{id:"fuchsia",name:"Фуксия",value:"#d946ef"},{id:"pink",name:"Розовый",value:"#ec4899"},{id:"rose",name:"Алый",value:"#f43f5e"}],oo={icons:HC,colors:qC},UC=["title"],WC={__name:"PlayerIcon",props:{iconId:{type:String,default:null},color:{type:String,default:null},size:{type:[Number,String],default:24},showBackground:{type:Boolean,default:!1}},setup(t){const l=t,o=ne(()=>l.iconId?oo.icons.find(f=>f.id===l.iconId):null),a=ne(()=>{if(!l.color)return"#94a3b8";const f=oo.colors.find(k=>k.id===l.color);return f?f.value:l.color}),r=ne(()=>typeof l.size=="string"?parseInt(l.size,10):l.size),c=ne(()=>`${r.value}px`);return(f,k)=>o.value?(s(),n("span",{key:0,class:Q(["player-icon",{"with-bg":t.showBackground}]),style:Qe({color:a.value,fontSize:c.value,"--icon-color":a.value}),title:o.value.name},h(o.value.emoji),15,UC)):(s(),n("span",{key:1,class:"player-icon placeholder",style:Qe({fontSize:c.value})}," 👤 ",4))}},ao=zt(WC,[["__scopeId","data-v-21296808"]]),zC=[{id:"humanoid",name:"Гуманоиды",icon:"mdi:account"},{id:"beast",name:"Звери",icon:"mdi:paw"},{id:"monster",name:"Монстры",icon:"mdi:skull"},{id:"undead",name:"Нежить",icon:"mdi:ghost"},{id:"construct",name:"Конструкты",icon:"mdi:robot"},{id:"elemental",name:"Элементали",icon:"mdi:fire"},{id:"demon",name:"Демоны",icon:"mdi:emoticon-devil"},{id:"dragon",name:"Драконы",icon:"mdi:dragon"},{id:"other",name:"Прочее",icon:"mdi:help-circle"}],VC=[{id:"minion",name:"Миньон",color:"#64748b",description:"Слабый противник, группы по 3-5"},{id:"regular",name:"Рядовой",color:"#22c55e",description:"Обычный противник"},{id:"elite",name:"Элита",color:"#3b82f6",description:"Сильный противник"},{id:"boss",name:"Босс",color:"#a855f7",description:"Очень сильный противник"},{id:"legendary",name:"Легендарный",color:"#f59e0b",description:"Исключительно сильный противник"}],QC=[{id:"goblin",name:"Гоблин",category:"humanoid",difficulty:"minion",portrait:null,images:[],stats:{war:{min:1,max:2},knowledge:{min:0,max:1},community:{min:0,max:1},shadow:{min:2,max:3},mysticism:{min:0,max:0},nature:{min:1,max:2}},health:{type:"simple",hp:{min:3,max:5}},skills:[],equipment:{armor:["clothes","leather"],weapons:[{type:"melee",options:["dagger","club"]}]},description:"Маленький хитрый гуманоид. Слабый в одиночку, опасен в группе."},{id:"skeleton",name:"Скелет",category:"undead",difficulty:"minion",portrait:null,images:[],stats:{war:{min:2,max:3},knowledge:{min:0,max:0},community:{min:0,max:0},shadow:{min:1,max:2},mysticism:{min:0,max:0},nature:{min:0,max:0}},health:{type:"simple",hp:{min:4,max:6}},skills:[],equipment:{armor:["none"],weapons:[{type:"melee",options:["sword","axe"]}]},description:"Оживлённые кости павшего воина."},{id:"wolf",name:"Волк",category:"beast",difficulty:"regular",portrait:null,images:[],stats:{war:{min:2,max:3},knowledge:{min:0,max:0},community:{min:1,max:2},shadow:{min:2,max:3},mysticism:{min:0,max:0},nature:{min:3,max:4}},health:{type:"simple",hp:{min:6,max:8}},skills:[{id:"packTactics",level:1}],equipment:{armor:["none"],weapons:[]},naturalWeapons:[{name:"Укус",damage:"1d6",type:"piercing"}],description:"Свирепый хищник, охотящийся стаями."}],jC={id:"",name:"",description:"",aspectId:null,maxLevel:1,levels:[{level:1,description:""}],isCustom:!0},io={categories:zC,difficulties:VC,templates:QC,customSkillTemplate:jC},GC={class:"npc-panel"},YC={class:"panel-header"},XC={class:"header-info"},ZC={class:"header-title"},JC={class:"header-count"},KC={class:"filters"},e$=["value"],t$=["value"],s$={class:"npc-list"},n$={class:"category-header"},l$={class:"category-count"},o$={class:"npcs-grid"},a$=["onClick"],i$={class:"npc-portrait"},r$={key:1,class:"portrait-placeholder"},c$={class:"npc-info"},d$={class:"npc-name"},u$={class:"npc-meta"},m$={key:0,class:"npc-hp"},v$={key:0,class:"npc-factions"},f$={key:0,class:"faction-more"},A$=["onClick"],p$=["onClick"],h$=["onClick"],g$={key:1,class:"empty-state"},y$={key:0},b$={key:1},k$={__name:"NpcPanel",emits:["open-character-sheet"],setup(t,{emit:l}){const o=ws(),a=cs(),r=xs(),c=l,f=io.categories,k=io.difficulties,w=R("all"),x=R("all"),T=R("");R(!1),R(null),R(null);const y=ne(()=>o.allNpcs),B=ne(()=>{let b=y.value;if(w.value!=="all"&&(b=b.filter(d=>d.category===w.value)),x.value!=="all"&&(b=b.filter(d=>d.difficulty===x.value)),T.value.trim()){const d=T.value.toLowerCase();b=b.filter(oe=>oe.name.toLowerCase().includes(d))}return b}),m=ne(()=>{const b={};return B.value.forEach(d=>{const oe=d.category||"other";b[oe]||(b[oe]=[]),b[oe].push(d)}),b}),Y=()=>{const b=o.createNpc({name:"Новый NPC",category:"humanoid",difficulty:"regular"});a.broadcastAllCharacters(),c("open-character-sheet",b.id)},j=b=>{c("open-character-sheet",b.id)},F=b=>{const d={...b,name:b.name+" (копия)"};delete d.id,o.createNpc(d),a.broadcastAllCharacters()},ie=b=>{if(confirm("Удалить этого NPC?")){const d=r.activeMap;d&&r.removeTokenByCharacterId(d.id,b),o.deleteNpc(b),a.sendCharacterDelete(b)}},W=(b,d)=>{d&&a.sendSplashImage(d,{title:b.name,duration:5e3})},S=b=>f.find(d=>d.id===b)||{name:"Прочее",icon:"mdi:help-circle"},Z=b=>k.find(d=>d.id===b)||{name:"Рядовой",color:"#22c55e"},K={player:"#22c55e",enemy:"#ef4444",neutral:"#94a3b8",wildlife:"#f59e0b",undead:"#8b5cf6",guards:"#3b82f6",bandits:"#dc2626",merchants:"#eab308"},X={player:"Игроки",enemy:"Враги",neutral:"Нейтральные",wildlife:"Дикие звери",undead:"Нежить",guards:"Стража",bandits:"Бандиты",merchants:"Торговцы"},U=b=>K[b]||"#94a3b8",D=b=>b.startsWith("custom_")?b.replace("custom_","").replace(/_/g," "):X[b]||b;return(b,d)=>(s(),n("div",GC,[e("header",YC,[e("div",XC,[e("h2",ZC,[A(i(p),{icon:"mdi:skull"}),d[4]||(d[4]=Ce(" NPC и монстры ",-1))]),e("span",JC,h(y.value.length),1)]),e("button",{class:"btn-create",onClick:Y},[A(i(p),{icon:"mdi:plus"}),d[5]||(d[5]=e("span",null,"Создать",-1))])]),e("div",KC,[De(e("input",{"onUpdate:modelValue":d[0]||(d[0]=oe=>T.value=oe),type:"text",class:"search-input",placeholder:"Поиск по имени..."},null,512),[[je,T.value]]),De(e("select",{"onUpdate:modelValue":d[1]||(d[1]=oe=>w.value=oe),class:"filter-select"},[d[6]||(d[6]=e("option",{value:"all"},"Все категории",-1)),(s(!0),n(ee,null,me(i(f),oe=>(s(),n("option",{key:oe.id,value:oe.id},h(oe.name),9,e$))),128))],512),[[Kt,w.value]]),De(e("select",{"onUpdate:modelValue":d[2]||(d[2]=oe=>x.value=oe),class:"filter-select"},[d[7]||(d[7]=e("option",{value:"all"},"Любая сложность",-1)),(s(!0),n(ee,null,me(i(k),oe=>(s(),n("option",{key:oe.id,value:oe.id},h(oe.name),9,t$))),128))],512),[[Kt,x.value]])]),e("div",s$,[B.value.length>0?(s(!0),n(ee,{key:0},me(m.value,(oe,he)=>(s(),n("div",{key:he,class:"category-group"},[e("div",n$,[A(i(p),{icon:S(he).icon},null,8,["icon"]),e("span",null,h(S(he).name),1),e("span",l$,h(oe.length),1)]),e("div",o$,[(s(!0),n(ee,null,me(oe,M=>{var de,H,z,q,Ie;return s(),n("div",{key:M.id,class:"npc-card",onClick:C=>j(M)},[e("div",i$,[M.portrait?(s(),st(Es,{key:0,portrait:M.portrait,size:48},null,8,["portrait"])):(s(),n("div",r$,[A(i(p),{icon:S(M.category).icon},null,8,["icon"])]))]),e("div",c$,[e("div",d$,h(M.name),1),e("div",u$,[e("span",{class:"npc-difficulty",style:Qe({color:Z(M.difficulty).color})},h(Z(M.difficulty).name),5),((de=M.combat)==null?void 0:de.healthType)==="simple"?(s(),n("span",m$," ❤️ "+h((H=M.combat)==null?void 0:H.hp)+"/"+h((z=M.combat)==null?void 0:z.maxHp),1)):_("",!0)]),(q=M.factions)!=null&&q.length?(s(),n("div",v$,[(s(!0),n(ee,null,me(M.factions.slice(0,3),C=>(s(),n("span",{key:C,class:"faction-badge",style:Qe({background:U(C)+"30",color:U(C)})},h(D(C)),5))),128)),M.factions.length>3?(s(),n("span",f$," +"+h(M.factions.length-3),1)):_("",!0)])):_("",!0)]),e("div",{class:"npc-actions",onClick:d[3]||(d[3]=lt(()=>{},["stop"]))},[e("button",{class:"action-btn",title:"Дублировать",onClick:C=>F(M)},[A(i(p),{icon:"mdi:content-copy"})],8,A$),((Ie=M.images)==null?void 0:Ie.length)>0?(s(),n("button",{key:0,class:"action-btn",title:"Показать игрокам",onClick:C=>W(M,M.images[0])},[A(i(p),{icon:"mdi:eye"})],8,p$)):_("",!0),e("button",{class:"action-btn delete",title:"Удалить",onClick:C=>ie(M.id)},[A(i(p),{icon:"mdi:delete"})],8,h$)])],8,a$)}),128))])]))),128)):(s(),n("div",g$,[A(i(p),{icon:"mdi:ghost",class:"empty-icon"}),T.value||w.value!=="all"||x.value!=="all"?(s(),n("p",y$," Нет NPC по заданным фильтрам ")):(s(),n("p",b$,[...d[8]||(d[8]=[Ce(" Пока нет созданных NPC.",-1),e("br",null,null,-1),Ce(" Создайте первого противника! ",-1)])])),e("button",{class:"btn-create-empty",onClick:Y},[A(i(p),{icon:"mdi:plus"}),d[9]||(d[9]=Ce(" Создать NPC ",-1))])]))])]))}},x$=zt(k$,[["__scopeId","data-v-d654f3a1"]]),w$={class:"h-full flex flex-col bg-slate-950 text-slate-50"},C$={class:"px-6 py-4 border-b border-slate-800 bg-slate-900/50 flex-shrink-0"},$$={class:"flex gap-2"},_$={class:"ml-1 text-xs opacity-75"},T$={class:"ml-1 text-xs opacity-75"},I$={class:"ml-1 text-xs opacity-75"},S$={key:0,class:"flex-1 overflow-y-auto p-6"},E$={key:0,class:"mb-8"},P$={class:"text-lg font-semibold text-slate-300 mb-4 flex items-center gap-2"},M$={class:"text-sm text-slate-500"},D$={class:"space-y-3"},B$={class:"px-4 py-2 bg-slate-800/50 border-b border-slate-700 flex items-center gap-3"},R$={class:"font-medium text-sm"},F$={class:"divide-y divide-slate-800/50"},L$=["onClick"],N$={class:"flex-1 min-w-0"},O$={class:"font-medium truncate"},H$={class:"text-xs text-slate-500"},q$={key:1},U$={class:"text-lg font-semibold text-slate-300 mb-4 flex items-center gap-2"},W$={class:"text-sm text-slate-500"},z$={class:"grid grid-cols-1 md:grid-cols-2 gap-3"},V$=["onClick"],Q$={key:1,class:"w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center text-lg"},j$={class:"flex-1 min-w-0"},G$={class:"font-medium truncate"},Y$={class:"text-xs text-slate-500"},X$={key:2,class:"text-sm text-slate-400"},Z$={key:2,class:"flex flex-col items-center justify-center h-full text-center"},J$={key:1,class:"flex-1 overflow-y-auto p-6"},K$={key:0,class:"flex flex-col items-center justify-center h-full text-center"},e4={key:1,class:"space-y-6"},t4={class:"px-4 py-3 bg-slate-800/50 border-b border-slate-700 flex items-center justify-between"},s4={class:"flex items-center gap-3"},n4=["title"],l4={class:"font-medium"},o4={class:"text-sm text-slate-500"},a4={class:"divide-y divide-slate-800/50"},i4=["onClick"],r4={class:"flex items-start gap-4"},c4={class:"flex-1 min-w-0"},d4={class:"flex items-center gap-2 mb-1"},u4={class:"font-bold text-lg truncate"},m4={class:"text-xs px-2 py-0.5 rounded bg-slate-700 text-slate-300"},v4={class:"flex flex-wrap gap-3 text-sm"},f4={key:0,class:"text-slate-400"},A4={key:1,class:"text-slate-400"},p4={class:"mt-3"},h4={class:"flex gap-2 mt-2"},g4=["onClick"],y4=["onClick"],b4={key:0,class:"flex flex-wrap gap-2 mt-2"},k4={class:"flex flex-col gap-1"},x4=["onClick"],w4=["title","onClick"],C4={__name:"MasterCharactersPanel",emits:["open-character-sheet"],setup(t,{emit:l}){const o=R("all"),a=ws(),r=cs(),c=l,{connections:f}=jt(r),k=R(new Set),w=R(new Map),x=ne(()=>a.allPlayerCharacters),T=ne(()=>{const b={};return x.value.forEach(d=>{const oe=d.ownerId||"unknown";b[oe]||(b[oe]={ownerId:oe,ownerNickname:d.ownerNickname||"Неизвестный игрок",characters:[]}),b[oe].characters.push(d)}),Object.values(b)}),y=ne(()=>x.value.length),B=b=>({commander:"⚔️",warrior:"🗡️",ranger:"🏹",mage:"🔮",healer:"💚",rogue:"🗝️",bard:"🎭",paladin:"🛡️"})[b]||"👤",m=b=>({commander:"Командир",warrior:"Воин",ranger:"Следопыт",mage:"Маг",healer:"Целитель",rogue:"Плут",bard:"Бард",paladin:"Паладин"})[b]||b||"Без класса",Y=b=>f.value.some(d=>d.userId===b||d.peerId===b),j=b=>{const d=r.allPlayers.find(oe=>oe.userId===b);return{iconId:(d==null?void 0:d.playerIcon)||null,colorId:(d==null?void 0:d.playerColor)||null}},F=b=>{var oe;const d=a.characters.find(he=>he.id===b);if(d!=null&&d.ownerId&&!d.isNpc){const he=w.value.get(b);if(he){if(((oe=d.combat)==null?void 0:oe.healthType)==="simple")he.hpDelta<0?r.sendDamageEffect(d.ownerId,Math.abs(he.hpDelta)):he.hpDelta>0&&r.sendHealEffect(d.ownerId,he.hpDelta);else{const M=he.woundChanges||{},de=(M.scratch||0)+(M.light||0)*2+(M.heavy||0)*3+(M.deadly||0)*4,H=Math.abs(Math.min(0,M.scratch||0))+Math.abs(Math.min(0,M.light||0))*2+Math.abs(Math.min(0,M.heavy||0))*3+Math.abs(Math.min(0,M.deadly||0))*4;de>0&&r.sendDamageEffect(d.ownerId,de,"ран"),H>0&&r.sendHealEffect(d.ownerId,H)}w.value.delete(b)}r.sendCharacterToPlayer(b,d.ownerId),k.value.delete(b)}},ie=b=>{k.value.add(b)},W=b=>k.value.has(b),S=(b,d)=>{var H;const oe=a.characters.find(z=>z.id===b);if(!oe)return;const he=((H=oe.combat)==null?void 0:H.hp)||0,M=d-he;a.updateCharacter(b,{combat:{...oe.combat,hp:d}});const de=w.value.get(b)||{hpDelta:0,woundChanges:{}};de.hpDelta+=M,w.value.set(b,de),ie(b)},Z=(b,d)=>{a.addWound(b,d);const oe=w.value.get(b)||{hpDelta:0,woundChanges:{}};oe.woundChanges[d]=(oe.woundChanges[d]||0)+1,w.value.set(b,oe),ie(b)},K=(b,d)=>{a.removeWound(b,d);const oe=w.value.get(b)||{hpDelta:0,woundChanges:{}};oe.woundChanges[d]=(oe.woundChanges[d]||0)-1,w.value.set(b,oe),ie(b)},X=b=>{a.postCombatRecovery(b),ie(b)},U=b=>{var he;const d=a.characters.find(M=>M.id===b);if(!d)return;const oe=((he=d.combat)==null?void 0:he.healthType)==="simple"?"wounds":"simple";a.setHealthType(b,oe),F(b)},D=b=>{c("open-character-sheet",b)};return(b,d)=>{var oe,he,M;return s(),n("div",w$,[e("header",C$,[d[6]||(d[6]=e("div",{class:"flex items-center justify-between mb-3"},[e("h1",{class:"text-xl font-bold flex items-center gap-2"},[e("span",null,"👥"),e("span",null,"Персонажи")])],-1)),e("div",$$,[e("button",{onClick:d[0]||(d[0]=de=>o.value="all"),class:Q(["flex-1 px-4 py-2 rounded-lg text-sm font-medium transition-all",o.value==="all"?"bg-purple-600 text-white":"bg-slate-800 text-slate-400 hover:bg-slate-700 hover:text-slate-200"])},[d[3]||(d[3]=Ce(" 📋 Все ",-1)),e("span",_$,"("+h(y.value+(((oe=i(a).allNpcs)==null?void 0:oe.length)||0))+")",1)],2),e("button",{onClick:d[1]||(d[1]=de=>o.value="players"),class:Q(["flex-1 px-4 py-2 rounded-lg text-sm font-medium transition-all",o.value==="players"?"bg-sky-600 text-white":"bg-slate-800 text-slate-400 hover:bg-slate-700 hover:text-slate-200"])},[d[4]||(d[4]=Ce(" 👤 Игроки ",-1)),e("span",T$,"("+h(y.value)+")",1)],2),e("button",{onClick:d[2]||(d[2]=de=>o.value="npcs"),class:Q(["flex-1 px-4 py-2 rounded-lg text-sm font-medium transition-all",o.value==="npcs"?"bg-amber-600 text-white":"bg-slate-800 text-slate-400 hover:bg-slate-700 hover:text-slate-200"])},[d[5]||(d[5]=Ce(" 👹 NPC ",-1)),e("span",I$,"("+h(((he=i(a).allNpcs)==null?void 0:he.length)||0)+")",1)],2)])]),o.value==="all"?(s(),n("div",S$,[y.value>0?(s(),n("div",E$,[e("h3",P$,[d[7]||(d[7]=e("span",null,"👤",-1)),d[8]||(d[8]=Ce(" Персонажи игроков ",-1)),e("span",M$,"("+h(y.value)+")",1)]),e("div",D$,[(s(!0),n(ee,null,me(T.value,de=>(s(),n("div",{key:de.ownerId,class:"bg-slate-900/50 rounded-xl border border-slate-800 overflow-hidden"},[e("div",B$,[e("div",{class:Q(["w-2 h-2 rounded-full",Y(de.ownerId)?"bg-emerald-500":"bg-slate-500"])},null,2),A(ao,{"icon-id":j(de.ownerId).iconId,color:j(de.ownerId).colorId,size:16},null,8,["icon-id","color"]),e("span",R$,h(de.ownerNickname),1)]),e("div",F$,[(s(!0),n(ee,null,me(de.characters,H=>(s(),n("div",{key:H.id,class:"p-3 hover:bg-slate-800/30 transition cursor-pointer flex items-center gap-3",onClick:z=>D(H.id)},[A(Es,{portrait:H.portrait,name:H.name,combat:H.combat,stats:H.stats,size:"sm"},null,8,["portrait","name","combat","stats"]),e("div",N$,[e("div",O$,h(H.name),1),e("div",H$,h(m(H.class)),1)]),A(lo,{combat:H.combat,stats:H.stats,compact:"","onUpdate:hp":z=>S(H.id,z),onAddWound:z=>Z(H.id,z),onRemoveWound:z=>K(H.id,z)},null,8,["combat","stats","onUpdate:hp","onAddWound","onRemoveWound"])],8,L$))),128))])]))),128))])])):_("",!0),((M=i(a).allNpcs)==null?void 0:M.length)>0?(s(),n("div",q$,[e("h3",U$,[d[9]||(d[9]=e("span",null,"👹",-1)),d[10]||(d[10]=Ce(" NPC и монстры ",-1)),e("span",W$,"("+h(i(a).allNpcs.length)+")",1)]),e("div",z$,[(s(!0),n(ee,null,me(i(a).allNpcs,de=>{var H;return s(),n("div",{key:de.id,class:"bg-slate-900/50 rounded-xl border border-slate-800 p-3 hover:bg-slate-800/30 transition cursor-pointer flex items-center gap-3",onClick:z=>D(de.id)},[de.portrait?(s(),st(Es,{key:0,portrait:de.portrait,name:de.name,combat:de.combat,size:"sm"},null,8,["portrait","name","combat"])):(s(),n("div",Q$," 👹 ")),e("div",j$,[e("div",G$,h(de.name),1),e("div",Y$,h(de.category),1)]),((H=de.combat)==null?void 0:H.healthType)==="simple"?(s(),n("div",X$," ❤️ "+h(de.combat.hp)+"/"+h(de.combat.maxHp),1)):_("",!0)],8,V$)}),128))])])):_("",!0),y.value===0&&(!i(a).allNpcs||i(a).allNpcs.length===0)?(s(),n("div",Z$,[...d[11]||(d[11]=[e("div",{class:"text-6xl mb-4"},"🎭",-1),e("h2",{class:"text-xl font-medium text-slate-300 mb-2"},"Нет персонажей",-1),e("p",{class:"text-slate-500 max-w-md"},' Персонажи игроков появятся здесь когда они подключатся. NPC можно создать во вкладке "NPC". ',-1)])])):_("",!0)])):_("",!0),o.value==="players"?(s(),n("div",J$,[y.value===0?(s(),n("div",K$,[...d[12]||(d[12]=[e("div",{class:"text-6xl mb-4"},"🎭",-1),e("h2",{class:"text-xl font-medium text-slate-300 mb-2"},"Нет персонажей",-1),e("p",{class:"text-slate-500 max-w-md"}," Персонажи игроков появятся здесь, когда они подключатся к комнате. Убедитесь, что игроки создали персонажей перед подключением. ",-1)])])):(s(),n("div",e4,[(s(!0),n(ee,null,me(T.value,de=>(s(),n("div",{key:de.ownerId,class:"bg-slate-900/50 rounded-xl border border-slate-800 overflow-hidden"},[e("div",t4,[e("div",s4,[e("div",{class:Q(["w-3 h-3 rounded-full",Y(de.ownerId)?"bg-emerald-500":"bg-slate-500"]),title:Y(de.ownerId)?"Онлайн":"Офлайн"},null,10,n4),A(ao,{"icon-id":j(de.ownerId).iconId,color:j(de.ownerId).colorId,size:20},null,8,["icon-id","color"]),e("span",l4,h(de.ownerNickname),1),e("span",o4,"("+h(de.characters.length)+" перс.)",1)])]),e("div",a4,[(s(!0),n(ee,null,me(de.characters,H=>{var z,q,Ie;return s(),n("div",{key:H.id,class:"p-4 hover:bg-slate-800/30 transition cursor-pointer",onClick:C=>D(H.id)},[e("div",r4,[A(Es,{portrait:H.portrait,name:H.name,combat:H.combat,stats:H.stats,meleeDefence:i(gs)(H,"melee"),rangedDefence:i(gs)(H,"ranged"),showDefence:!0,defenceLayout:"left",size:"lg"},null,8,["portrait","name","combat","stats","meleeDefence","rangedDefence"]),e("div",c4,[e("div",d4,[e("h3",u4,h(H.name),1),e("span",m4,h(B(H.class))+" "+h(m(H.class)),1)]),e("div",v4,[H.race?(s(),n("div",f4," 🧬 "+h(H.race)+h(H.subrace?` (${H.subrace})`:""),1)):_("",!0),H.gender?(s(),n("div",A4,h(H.gender==="m"?"♂️":"♀️"),1)):_("",!0)]),e("div",p4,[A(lo,{combat:H.combat,stats:H.stats,"onUpdate:hp":C=>S(H.id,C),onAddWound:C=>Z(H.id,C),onRemoveWound:C=>K(H.id,C)},null,8,["combat","stats","onUpdate:hp","onAddWound","onRemoveWound"]),e("div",h4,[W(H.id)?(s(),n("button",{key:0,onClick:C=>F(H.id),class:"flex-1 px-3 py-1.5 rounded-lg text-sm font-medium bg-emerald-600 hover:bg-emerald-500 text-white transition flex items-center justify-center gap-1"},[...d[13]||(d[13]=[e("span",null,"📤",-1),e("span",null,"Отправить",-1)])],8,g4)):_("",!0),((z=H.combat)==null?void 0:z.healthType)==="wounds"?(s(),n("button",{key:1,onClick:C=>X(H.id),class:"px-3 py-1.5 rounded-lg text-sm bg-slate-700 hover:bg-slate-600 text-slate-300 transition",title:"Послебоевое восстановление: раны смещаются на категорию ниже"}," 🩹 Отдых ",8,y4)):_("",!0)])]),H.stats?(s(),n("div",b4,[(s(!0),n(ee,null,me(H.stats,(C,L)=>(s(),n("span",{key:L,class:Q(["text-xs px-1.5 py-0.5 rounded bg-slate-800",{"text-rose-400":L==="war","text-blue-400":L==="knowledge","text-amber-400":L==="community","text-slate-400":L==="shadow","text-purple-400":L==="mysticism","text-emerald-400":L==="nature"}])},h(L.slice(0,3).toUpperCase())+": "+h(C),3))),128))])):_("",!0)]),e("div",k4,[e("button",{class:"p-2 rounded-lg hover:bg-sky-700 text-sky-400 hover:text-white transition",title:"Открыть лист персонажа",onClick:C=>D(H.id)}," 📋 ",8,x4),e("button",{class:"p-2 rounded-lg hover:bg-slate-700 text-slate-400 hover:text-white transition",title:((q=H.combat)==null?void 0:q.healthType)==="simple"?"Переключить на ранения":"Переключить на HP",onClick:C=>U(H.id)},h(((Ie=H.combat)==null?void 0:Ie.healthType)==="simple"?"📊":"❤️"),9,w4),d[14]||(d[14]=e("button",{class:"p-2 rounded-lg hover:bg-slate-700 text-slate-400 hover:text-white transition",title:"Нанести урон"}," 💥 ",-1)),d[15]||(d[15]=e("button",{class:"p-2 rounded-lg hover:bg-slate-700 text-slate-400 hover:text-white transition",title:"Исцелить"}," 💚 ",-1)),d[16]||(d[16]=e("button",{class:"p-2 rounded-lg hover:bg-slate-700 text-slate-400 hover:text-white transition",title:"Разместить на карте"}," 📍 ",-1))])])],8,i4)}),128))])]))),128))]))])):o.value==="npcs"?(s(),st(x$,{key:2,class:"flex-1",onOpenCharacterSheet:D})):_("",!0)])}}},$4={class:"templates-list-panel"},_4={class:"templates-header"},T4={class:"templates-title"},I4={class:"templates-count"},S4={key:0,class:"tag-filters"},E4=["onClick"],P4=["onClick"],M4=["onClick","title"],D4={class:"template-info"},B4={class:"template-name"},R4={class:"template-meta"},F4={key:0,class:"template-tags"},L4={key:0,class:"mini-tag more"},N4=["onClick"],O4={key:0,class:"empty-templates"},H4={key:0},q4={key:1},ro="scene-templates-scroll",U4={__name:"SceneTemplatesList",props:{templates:{type:Array,default:()=>[]}},emits:["select-template","delete-template","toggle-sent"],setup(t,{emit:l}){const o=t,a=l,r=R([]),c=R(null),f=ne(()=>{const Y=new Set;return o.templates.forEach(j=>{var F;(F=j.tags)==null||F.forEach(ie=>Y.add(ie))}),Array.from(Y).sort()}),k=ne(()=>r.value.length===0?o.templates:o.templates.filter(Y=>r.value.some(j=>{var F;return(F=Y.tags)==null?void 0:F.includes(j)}))),w=Y=>{const j=r.value.indexOf(Y);j===-1?r.value.push(Y):r.value.splice(j,1)},x=Y=>({text:"mdi:message-text","skill-check":"mdi:dice-d20","battle-invite":"mdi:sword-cross",image:"mdi:image",important:"mdi:alert-circle",quest:"mdi:map-marker-star","item-give":"mdi:gift","character-invite":"mdi:account-plus"})[Y]||"mdi:file-document",T=()=>{c.value&&localStorage.setItem(ro,c.value.scrollTop.toString())},y=()=>{const Y=localStorage.getItem(ro);Y&&c.value&&(c.value.scrollTop=parseInt(Y,10))},B=(Y,j)=>{Y.stopPropagation(),a("toggle-sent",j.id)};rs(()=>{fs(()=>{y()})});const m=()=>{T()};return(Y,j)=>(s(),n("div",$4,[e("div",_4,[e("h4",T4,[A(i(p),{icon:"mdi:bookmark-multiple"}),j[0]||(j[0]=Ce(" Шаблоны ",-1))]),e("span",I4,h(t.templates.length),1)]),f.value.length>0?(s(),n("div",S4,[(s(!0),n(ee,null,me(f.value,F=>(s(),n("button",{key:F,class:Q(["tag-filter",{active:r.value.includes(F)}]),onClick:ie=>w(F)},h(F),11,E4))),128))])):_("",!0),e("div",{ref_key:"listContainer",ref:c,class:"templates-scroll",onScroll:m},[(s(!0),n(ee,null,me(k.value,F=>{var ie;return s(),n("div",{key:F.id,class:Q(["template-item",{sent:F.sent}]),style:Qe({"--template-color":F.color}),onClick:W=>a("select-template",F)},[e("div",{class:"template-icon-wrapper",onClick:W=>B(W,F),title:F.sent?"Отмечен как отправленный (клик - сбросить)":"Клик - отметить как отправленный"},[A(i(p),{icon:F.icon,class:"template-icon",style:Qe({color:F.color})},null,8,["icon","style"]),F.sent?(s(),st(i(p),{key:0,icon:"mdi:check-circle",class:"sent-badge"})):_("",!0)],8,M4),e("div",D4,[e("div",B4,h(F.name),1),e("div",R4,[A(i(p),{icon:x(F.tool),class:"tool-type-icon"},null,8,["icon"]),(ie=F.tags)!=null&&ie.length?(s(),n("span",F4,[(s(!0),n(ee,null,me(F.tags.slice(0,2),W=>(s(),n("span",{key:W,class:"mini-tag"},h(W),1))),128)),F.tags.length>2?(s(),n("span",L4,"+"+h(F.tags.length-2),1)):_("",!0)])):_("",!0)])]),e("button",{class:"template-delete-btn",onClick:lt(W=>a("delete-template",F.id),["stop"]),title:"Удалить шаблон"},[A(i(p),{icon:"mdi:delete-outline"})],8,N4)],14,P4)}),128)),k.value.length===0?(s(),n("div",O4,[A(i(p),{icon:"mdi:bookmark-off-outline"}),t.templates.length===0?(s(),n("span",H4,"Нет шаблонов")):(s(),n("span",q4,"Нет шаблонов с выбранными тегами"))])):_("",!0)],544)]))}},W4=zt(U4,[["__scopeId","data-v-d05c5cb8"]]),z4={key:0,class:"collapsed-header scene-image-preview"},V4=["src","alt"],Q4={class:"collapsed-name"},j4={class:"panel-header"},G4={class:"panel-title"},Y4=["src","alt"],X4={key:0,class:"collapsed-header"},Z4={class:"panel-header"},J4={class:"workspace"},K4={class:"master-scene-layout"},e_={class:"master-scene-tools-column"},t_={class:"master-scene-templates-column"},s_={class:"master-scene-log"},n_={key:0,class:"pending-action"},l_={class:"action-info"},o_={class:"action-controls"},a_=["disabled"],i_={key:1,class:"action-buttons"},r_=["onClick"],c_={class:"btn-label"},d_=["disabled"],u_={class:"btn-label"},m_={key:1,class:"sheet-tabs"},v_=["onClick"],f_={class:"tab-label"},A_={key:2,class:"scene-filters"},p_=["onClick"],h_={class:"filter-label"},g_={class:"nav-bar"},y_={class:"nav-tabs"},b_=["onClick"],k_={class:"status-text"},x_={class:"menu-section"},w_={class:"room-code"},C_={key:0,class:"copy-hint"},$_={class:"menu-section"},__={class:"layout-switcher"},T_={class:"menu-section"},I_={class:"wake-lock-status"},S_={__name:"GameLayout",props:{isMaster:{type:Boolean,default:!1},character:{type:Object,default:null},characters:{type:Array,default:()=>[]},selectedToken:{type:Object,default:null},selectedHex:{type:Object,default:null},playerFacing:{type:Number,default:0},playerTokenPosition:{type:Object,default:null},connectionStatus:{type:String,default:"disconnected"},currentTurn:{type:Object,default:null},isPlayerTurn:{type:Boolean,default:!1},pendingAction:{type:Object,default:null},reactionPrompt:{type:Object,default:null}},emits:["leave-room","set-view","select-action","confirm-action","cancel-action","switch-equipment","reaction-accept","reaction-decline","open-character-sheet","move-to-hex","token-selected","hex-selected","hex-double-tap","hex-long-press-move","hex-long-press-confirm","token-rotate","action-target-selected","create-character"],setup(t,{emit:l}){const o=t,a=l,r=ws();xs();const c=on(),f=Cf(),k=Zn(),w=cs(),{roomId:x}=jt(w),T=$n();jt(T);const y=R(!1),B=async()=>{if(x.value)try{await navigator.clipboard.writeText(x.value),y.value=!0,setTimeout(()=>{y.value=!1},2e3)}catch(ye){console.error("Не удалось скопировать:",ye)}},{keepScreenAwake:m}=jt(f),Y=async()=>{await f.toggleKeepScreenAwake()},{myCharacters:j,activeCharacter:F,activeCharacterId:ie}=jt(r),{activeFilter:W,hasActiveImage:S,currentImage:Z}=jt(k),{layoutPreference:K}=jt(c),X=R(window.innerWidth),U=ne(()=>$f()),D=ne(()=>K.value==="mobile"?"mobile":K.value==="desktop"?"desktop":U.value?"mobile":"desktop"),b=ne(()=>D.value==="mobile"),d=ne(()=>D.value==="desktop"),oe=()=>{X.value=window.innerWidth};rs(()=>{if(window.addEventListener("resize",oe),o.isMaster){const ye=localStorage.getItem("scene-templates-v2");if(ye)try{q.value=JSON.parse(ye)}catch(pe){console.error("Failed to load templates:",pe)}}}),ln(()=>{window.removeEventListener("resize",oe)});const he=ne(()=>o.isMaster?["battle-map","chat","master-tools","characters","character-sheet"]:["battle-map","character-sheet","chat"]),M=R(c.mobileActiveScreen||"battle-map"),de=ne(()=>he.value.indexOf(M.value)),H=ne(()=>he.value.length),z=R(null),q=R([]),Ie=ye=>{q.value=ye},C=ye=>{z.value&&z.value.loadTemplate(ye)},L=ye=>{z.value&&z.value.deleteTemplate(ye)},$e=ye=>{z.value&&z.value.toggleTemplateSent(ye)},Ae=[{id:"main",label:"Личность",icon:"mdi:account-heart"},{id:"items",label:"Инвентарь",icon:"mdi:backpack"},{id:"social",label:"Социум",icon:"mdi:account-group"},{id:"magic",label:"Магия",icon:"mdi:auto-fix"}],Ee=R("main"),Se=ne(()=>o.isMaster?[{id:"battle-map",label:"Карта",icon:"mdi:map"},{id:"chat",label:"Сцена",icon:"mdi:drama-masks"},{id:"master-tools",label:"Инструменты",icon:"mdi:cog"},{id:"characters",label:"Все персонажи",icon:"mdi:account-group"}]:[{id:"battle-map",label:"Карта",icon:"mdi:map"},{id:"character-sheet",label:"Персонаж",icon:"mdi:account"},{id:"chat",label:"Сцена",icon:"mdi:drama-masks"}]),Be=[{id:Zs.ALL,label:"Всё",icon:"mdi:format-list-bulleted"},{id:Zs.CHECKS,label:"Проверки",icon:"mdi:dice-d20"},{id:Zs.COMBAT,label:"Бой",icon:"mdi:sword-cross"},{id:Zs.QUESTS,label:"Квесты",icon:"mdi:map-marker-star"},{id:Zs.ITEMS,label:"Вещи",icon:"mdi:treasure-chest"}],He=ne({get:()=>!c.getInfoPanelOpen(M.value),set:ye=>{c.setInfoPanelOpen(M.value,!ye)}}),Ne=R(!1),ot=async()=>{await f.restoreWakeLockIfNeeded(),document.removeEventListener("click",ot),document.removeEventListener("touchstart",ot)};rs(()=>{document.addEventListener("click",ot,{once:!0}),document.addEventListener("touchstart",ot,{once:!0,passive:!0})});const We=ye=>{ye&&ye.url&&k.setSceneImage(ye.url,ye.description,ye.senderUserId),c.setInfoPanelOpen("chat",!0),k.touchInfoPanel()},ce=()=>{k.clearSceneImage(),c.setInfoPanelOpen("chat",!1)},Je=()=>{k.touchInfoPanel(),c.setInfoPanelOpen("chat",!0)},Ke=R({startX:0,startY:0,currentX:0,isDragging:!1,threshold:80}),xe=ne(()=>{if(Ke.value.isDragging){const ye=Ke.value.currentX-Ke.value.startX,pe=100;return Math.max(-pe,Math.min(pe,ye))}return 0}),Me=ye=>{Ke.value.startX=ye.touches[0].clientX,Ke.value.startY=ye.touches[0].clientY,Ke.value.currentX=ye.touches[0].clientX,Ke.value.isDragging=!1},Pe=ye=>{const pe=ye.touches[0].clientX-Ke.value.startX,Ue=ye.touches[0].clientY-Ke.value.startY;Math.abs(pe)>Math.abs(Ue)&&Math.abs(pe)>15&&(ye.preventDefault(),Ke.value.isDragging=!0,Ke.value.currentX=ye.touches[0].clientX)},Re=()=>{if(!Ke.value.isDragging)return;const ye=Ke.value.currentX-Ke.value.startX;if(Math.abs(ye)>50){const pe=de.value;ye>0&&pe>0?(M.value=he[pe-1],c.setMobileActiveScreen(M.value),a("set-view",he[pe-1])):ye<0&&pe<he.length-1&&(M.value=he[pe+1],c.setMobileActiveScreen(M.value),a("set-view",he[pe+1]))}Ke.value.isDragging=!1},ke=ye=>{M.value=ye,c.setMobileActiveScreen(ye),a("set-view",ye)},ge=ye=>{r.setActiveCharacter(ye),ke("character-sheet")},ae=()=>{Ne.value=!Ne.value},Xe=()=>{He.value=!He.value},Ze=ne(()=>o.connectionStatus==="in-room"?"connected":o.connectionStatus==="connecting"?"connecting":"disconnected"),vt=ne(()=>o.connectionStatus==="in-room"?"онлайн":o.connectionStatus==="connecting"?"подкл...":"офлайн"),te=ne(()=>M.value==="battle-map"?"map":M.value==="character-sheet"?"character":"chat"),J=ne(()=>!(o.isMaster&&M.value==="chat")),Te=[{id:"move",label:"Движение",icon:"mdi:walk"},{id:"attack",label:"Атака",icon:"mdi:sword"},{id:"defend",label:"Защита",icon:"mdi:shield"},{id:"skill",label:"Навык",icon:"mdi:auto-fix"}],$=ye=>{a("select-action",ye)},P=()=>{r.startNewTurn(),console.log("🔄 Новый ход! Движение и порывы восстановлены.")},N=ne(()=>{var pe;const ye=(pe=o.selectedToken)==null?void 0:pe.characterId;return ye?r.getAvailableSurges(ye):null}),Ge=()=>{var Ue;const ye=(Ue=o.selectedToken)==null?void 0:Ue.characterId;if(!ye)return;const pe=r.spendSurge(ye);pe.success?console.log(`⚡ Порыв! +${pe.movementGained} ОД`):console.log("❌ Нет доступных порывов")},rt=ye=>{a("token-selected",ye)},ft=ye=>{a("hex-selected",ye)},Et=ye=>{a("hex-double-tap",ye)},At=ye=>{a("hex-long-press-move",ye)},dt=ye=>{a("hex-long-press-confirm",ye)},$t=ye=>{a("token-rotate",ye)},re=ye=>{a("action-target-selected",ye)};return(ye,pe)=>(s(),n("div",{class:Q(["game-layout",{"player-turn":t.isPlayerTurn,"mobile-layout":b.value,"desktop-layout":d.value,"master-mode":t.isMaster,"no-info-panel":!J.value}])},[J.value?(s(),n("div",{key:0,class:Q(["info-panel-overlay",{collapsed:He.value,"scene-mode":te.value==="chat","has-image":te.value==="chat"&&i(S)}])},[te.value==="map"?(s(),st(to,{key:0,"selected-token":t.selectedToken,"selected-hex":t.selectedHex,"player-character":t.character,"player-facing":t.playerFacing,collapsed:He.value,"is-player-turn":t.isPlayerTurn,"player-token-position":t.playerTokenPosition,"is-master":t.isMaster,onToggleCollapse:pe[0]||(pe[0]=Ue=>He.value=!He.value),onOpenCharacterSheet:pe[1]||(pe[1]=Ue=>{a("open-character-sheet",Ue),M.value="character-sheet"}),onSwitchEquipment:pe[2]||(pe[2]=Ue=>ye.$emit("switch-equipment")),onMoveToHex:pe[3]||(pe[3]=Ue=>ye.$emit("move-to-hex",Ue))},null,8,["selected-token","selected-hex","player-character","player-facing","collapsed","is-player-turn","player-token-position","is-master"])):te.value==="character"?(s(),st(to,{key:1,"selected-token":t.selectedToken,"selected-hex":null,"player-character":i(F),"player-facing":t.playerFacing,collapsed:He.value,"is-player-turn":t.isPlayerTurn,"player-token-position":null,"always-show-player":!0,"is-master":t.isMaster,onToggleCollapse:pe[4]||(pe[4]=Ue=>He.value=!He.value),onOpenCharacterSheet:pe[5]||(pe[5]=Ue=>a("open-character-sheet",Ue)),onSwitchEquipment:pe[6]||(pe[6]=Ue=>ye.$emit("switch-equipment"))},null,8,["selected-token","player-character","player-facing","collapsed","is-player-turn","is-master"])):(s(),n("div",{key:2,class:"info-panel-content scene-info",onClick:Je},[i(S)&&i(Z)?(s(),n(ee,{key:0},[He.value?(s(),n("div",z4,[e("img",{src:i(Z).url,alt:i(Z).description,class:"preview-thumbnail"},null,8,V4),e("span",Q4,h(i(Z).description||"Изображение сцены"),1),A(i(p),{icon:"mdi:chevron-down",class:"collapse-icon"})])):(s(),n(ee,{key:1},[e("div",j4,[e("button",{class:"collapse-btn",onClick:lt(Xe,["stop"])},[A(i(p),{icon:"mdi:chevron-up"})]),e("span",G4,h(i(Z).description||"Сцена"),1)]),e("div",{class:"scene-image-container",onClick:pe[7]||(pe[7]=lt(()=>{},["stop"])),onTouchstart:Je},[e("img",{src:i(Z).url,alt:i(Z).description,class:"scene-full-image"},null,8,Y4)],32)],64))],64)):(s(),n(ee,{key:1},[He.value?(s(),n("div",X4,[A(i(p),{icon:"mdi:drama-masks",class:"collapsed-chat-icon"}),pe[25]||(pe[25]=e("span",{class:"collapsed-name"},"Сцена",-1)),A(i(p),{icon:"mdi:chevron-down",class:"collapse-icon"})])):(s(),n(ee,{key:1},[e("div",Z4,[e("button",{class:"collapse-btn",onClick:lt(Xe,["stop"])},[A(i(p),{icon:"mdi:chevron-up"})]),pe[26]||(pe[26]=e("span",{class:"panel-title"},"Сцена",-1))]),e("div",{class:"chat-info-expanded",onClick:pe[8]||(pe[8]=lt(()=>{},["stop"])),onTouchstart:Je},[...pe[27]||(pe[27]=[e("p",{class:"chat-hint"},"Лог событий, проверки и квесты",-1)])],32)],64))],64))]))],2)):_("",!0),e("div",J4,[e("div",{class:Q(["screens-container",{"master-screens":t.isMaster}]),style:Qe({width:`${H.value*100}%`,transform:`translateX(calc(-${de.value*(100/H.value)}% + ${xe.value}px))`,transition:Ke.value.isDragging?"none":"transform 300ms ease-out"})},[e("div",{class:"screen screen-map",style:Qe({width:`${100/H.value}%`})},[A(hf,{readonly:!t.isMaster&&!t.isPlayerTurn,"is-master":t.isMaster,"mobile-mode":b.value,"pending-action":t.pendingAction,onActionTargetSelected:re,onTokenSelected:rt,onHexSelected:ft,onHexDoubleTap:Et,onHexLongPressMove:At,onHexLongPressConfirm:dt,onTokenRotate:$t},null,8,["readonly","is-master","mobile-mode","pending-action"])],4),t.isMaster?(s(),n(ee,{key:1},[e("div",{class:"screen screen-scene-master",style:Qe({width:`${100/H.value}%`})},[e("div",K4,[e("div",e_,[A(nC,{ref_key:"masterSceneToolsRef",ref:z,onTemplatesUpdated:Ie},null,512)]),e("div",t_,[A(W4,{templates:q.value,onSelectTemplate:C,onDeleteTemplate:L,onToggleSent:$e},null,8,["templates"])]),e("div",s_,[A(so,{onGoToBattle:pe[13]||(pe[13]=Ue=>ke("battle-map")),onViewImage:We,onHideImage:ce})])])],4),e("div",{class:"screen screen-master-tools",style:Qe({width:`${100/H.value}%`})},[A(hC)],4),e("div",{class:"screen screen-characters",style:Qe({width:`${100/H.value}%`})},[A(C4,{onOpenCharacterSheet:ge})],4),e("div",{class:"screen screen-character",style:Qe({width:`${100/H.value}%`})},[A(no,{embedded:!0,"active-tab":Ee.value,"onUpdate:activeTab":pe[14]||(pe[14]=Ue=>Ee.value=Ue),onGoToCharacters:pe[15]||(pe[15]=Ue=>ke("characters"))},null,8,["active-tab"])],4)],64)):(s(),n(ee,{key:0},[e("div",{class:"screen screen-character",style:Qe({width:`${100/H.value}%`})},[A(no,{embedded:!0,"active-tab":Ee.value,"onUpdate:activeTab":pe[9]||(pe[9]=Ue=>Ee.value=Ue),onCreateCharacter:pe[10]||(pe[10]=Ue=>a("create-character",Ue))},null,8,["active-tab"])],4),e("div",{class:"screen screen-chat",style:Qe({width:`${100/H.value}%`})},[A(so,{onGoToBattle:pe[11]||(pe[11]=Ue=>ke("battle-map")),onCreateCharacter:pe[12]||(pe[12]=Ue=>a("create-character",Ue)),onViewImage:We,onHideImage:ce})],4)],64))],6)]),e("div",{class:"action-panel",onTouchstart:Me,onTouchmove:Pe,onTouchend:Re},[M.value==="battle-map"?(s(),n(ee,{key:0},[t.pendingAction?(s(),n("div",n_,[e("div",l_,[A(i(p),{icon:t.pendingAction.icon,class:"action-icon"},null,8,["icon"]),e("span",null,h(t.pendingAction.title),1)]),e("div",o_,[e("button",{class:"btn-cancel",onClick:pe[16]||(pe[16]=Ue=>a("cancel-action"))},"Отмена"),e("button",{class:"btn-confirm",disabled:!t.pendingAction.canConfirm,onClick:pe[17]||(pe[17]=Ue=>a("confirm-action"))},"OK",8,a_)])])):(s(),n("div",i_,[(s(),n(ee,null,me(Te,Ue=>e("button",{key:Ue.id,class:"action-btn",onClick:Wt=>$(Ue)},[A(i(p),{icon:Ue.icon,class:"btn-icon"},null,8,["icon"]),e("span",c_,h(Ue.label),1)],8,r_)),64)),e("button",{class:"action-btn new-turn-btn",onClick:P},[A(i(p),{icon:"mdi:refresh",class:"btn-icon"}),pe[28]||(pe[28]=e("span",{class:"btn-label"},"Новый ход",-1))]),t.selectedToken&&N.value!==null?(s(),n("button",{key:0,class:Q(["action-btn surge-btn",{disabled:N.value<=0}]),disabled:N.value<=0,onClick:Ge},[A(i(p),{icon:"mdi:lightning-bolt",class:"btn-icon"}),e("span",u_,"Порыв ("+h(N.value)+")",1)],10,d_)):_("",!0)]))],64)):M.value==="character-sheet"?(s(),n("div",m_,[t.isMaster?(s(),n("button",{key:0,class:"sheet-tab back-btn",onClick:pe[18]||(pe[18]=Ue=>ke("characters"))},[A(i(p),{icon:"mdi:arrow-left",class:"tab-icon"}),pe[29]||(pe[29]=e("span",{class:"tab-label"},"Назад",-1))])):_("",!0),(s(),n(ee,null,me(Ae,Ue=>e("button",{key:Ue.id,class:Q(["sheet-tab",{active:Ee.value===Ue.id}]),onClick:Wt=>Ee.value=Ue.id},[A(i(p),{icon:Ue.icon,class:"tab-icon"},null,8,["icon"]),e("span",f_,h(Ue.label),1)],10,v_)),64))])):(s(),n("div",A_,[(s(),n(ee,null,me(Be,Ue=>e("button",{key:Ue.id,class:Q(["scene-filter-btn",{active:i(W)===Ue.id}]),onClick:Wt=>i(k).setFilter(Ue.id)},[A(i(p),{icon:Ue.icon,class:"filter-icon"},null,8,["icon"]),e("span",h_,h(Ue.label),1)],10,p_)),64))]))],32),e("div",g_,[e("button",{class:"menu-btn",onClick:ae},[A(i(p),{icon:"mdi:menu"})]),e("div",y_,[(s(!0),n(ee,null,me(Se.value,Ue=>(s(),n("button",{key:Ue.id,class:Q(["nav-tab",{active:M.value===Ue.id}]),onClick:Wt=>ke(Ue.id)},[A(i(p),{icon:Ue.icon,class:"nav-icon"},null,8,["icon"])],10,b_))),128))]),e("div",{class:Q(["connection-status",Ze.value])},[e("span",k_,h(vt.value),1),pe[30]||(pe[30]=e("div",{class:"status-dot"},null,-1))],2)]),A(Ps,{name:"menu-fade"},{default:ys(()=>[Ne.value?(s(),n("div",{key:0,class:"menu-overlay",onClick:pe[24]||(pe[24]=Ue=>Ne.value=!1)},[e("div",{class:"menu-content",onClick:pe[23]||(pe[23]=lt(()=>{},["stop"]))},[t.isMaster&&i(x)?(s(),n(ee,{key:0},[e("div",x_,[pe[31]||(pe[31]=e("div",{class:"menu-section-title"},"Код комнаты",-1)),e("button",{class:"room-code-btn",onClick:B},[e("span",w_,h(i(x)),1),A(i(p),{icon:y.value?"mdi:check":"mdi:content-copy",class:"copy-icon"},null,8,["icon"])]),y.value?(s(),n("p",C_,"Скопировано!")):_("",!0)]),pe[32]||(pe[32]=e("div",{class:"menu-divider"},null,-1))],64)):_("",!0),e("div",$_,[pe[36]||(pe[36]=e("div",{class:"menu-section-title"},"Режим отображения",-1)),e("div",__,[e("button",{class:Q(["layout-option",{active:i(K)==="auto"}]),onClick:pe[19]||(pe[19]=Ue=>i(c).setLayoutPreference("auto"))},[A(i(p),{icon:"mdi:cellphone-link"}),pe[33]||(pe[33]=e("span",null,"Авто",-1))],2),e("button",{class:Q(["layout-option",{active:i(K)==="mobile"}]),onClick:pe[20]||(pe[20]=Ue=>i(c).setLayoutPreference("mobile"))},[A(i(p),{icon:"mdi:cellphone"}),pe[34]||(pe[34]=e("span",null,"Мобильный",-1))],2),e("button",{class:Q(["layout-option",{active:i(K)==="desktop"}]),onClick:pe[21]||(pe[21]=Ue=>i(c).setLayoutPreference("desktop"))},[A(i(p),{icon:"mdi:monitor"}),pe[35]||(pe[35]=e("span",null,"Десктоп",-1))],2)])]),e("div",T_,[e("button",{class:Q(["menu-item wake-lock",{active:i(m)}]),onClick:Y},[A(i(p),{icon:i(m)?"mdi:lightbulb-on":"mdi:lightbulb-outline"},null,8,["icon"]),pe[37]||(pe[37]=e("span",null,"Не гасить экран",-1)),e("span",I_,h(i(m)?"ВКЛ":"ВЫКЛ"),1)],2)]),pe[39]||(pe[39]=e("div",{class:"menu-divider"},null,-1)),e("button",{class:"menu-item exit",onClick:pe[22]||(pe[22]=Ue=>{a("leave-room"),Ne.value=!1})},[A(i(p),{icon:"mdi:exit-to-app"}),pe[38]||(pe[38]=e("span",null,"Выйти из комнаты",-1))])])])):_("",!0)]),_:1})],2))}},O_=zt(S_,[["__scopeId","data-v-81bcb6d5"]]);export{O_ as G,p as I,zt as _,Yt as a,Jt as b,nn as c,R_ as d,F_ as e,oo as f,L_ as g,$f as h,en as i,Jn as j,B_ as k,Eo as l,Sl as m,El as n,$n as o,Qa as p,il as r,N_ as s,an as u};
