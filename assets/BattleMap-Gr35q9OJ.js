import{a as hn,s as Ke,r as j,n as H,m as Je,c as f,d as p,e as r,t as O,i as M,F as Y,p as ae,x as oe,f as rs,h as Me,v as qe,H as je,I as cs,J as us,o as mn,E as gn,K as Gt,g as E,q as Se,L as Ce,l as ds,M as fs,w as $e,N as ht,y as ps,k as Xt}from"./index-Cz7qojYD.js";import{_ as hs}from"./UserAvatar-BKXOAnrW.js";import{a as vn,e as rt,f as ms,F as ge,C as ke,d as bn,b as gs,u as vs,H as Qt,M as ze,g as bs,S as ys,T as Ge,L as He,h as me,i as _e,j as Be,k as mt}from"./fillProfile-mUJhn4D_.js";const xs={class:"flex flex-col h-full bg-slate-950"},ks={key:0,class:"h-full flex items-center justify-center"},ws={class:"text-center max-w-md"},_s={class:"text-slate-600 text-sm"},Ts={class:"flex items-center justify-between text-xs text-slate-400 mb-1"},Cs={class:"font-semibold text-slate-200"},Ss={class:"text-base text-slate-100 whitespace-pre-line"},Ps={class:"border-t border-white/10 bg-slate-900/80 backdrop-blur px-6 py-4"},$s={class:"flex gap-3 items-end max-w-4xl mx-auto"},Es=["disabled"],As=["disabled"],Lr={__name:"ChatPanel",setup(e){const t=vn(),n=hn(),{messages:s,status:o,role:l,userProfiles:i}=Ke(t),m=j(""),d=j(null),c=H(()=>s.value.filter(P=>P.type!=="system")),u=P=>{if(P===n.userId)return{nickname:n.nickname||"Гость",avatar:n.avatar};const C=i.value.get(P);return C?{nickname:C.nickname||"Гость",avatar:C.avatar}:{nickname:"Неизвестный",avatar:null}},h=H(()=>l.value==="master"?["ready","in-room"].includes(o.value):o.value==="in-room");Je(()=>c.value.length,()=>{je(()=>{d.value&&(d.value.scrollTop=d.value.scrollHeight)})});const y=()=>{h.value&&(t.sendMessage(m.value),m.value="")},I=P=>{P.key==="Enter"&&!P.shiftKey&&(P.preventDefault(),y())},k=P=>new Date(P).toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"});return(P,C)=>(f(),p("div",xs,[r("div",{ref_key:"listRef",ref:d,class:"flex-1 overflow-y-auto px-6 py-6 space-y-4"},[c.value.length===0?(f(),p("div",ks,[r("div",ws,[C[1]||(C[1]=r("p",{class:"text-slate-500 text-lg mb-2"},"Чат пуст",-1)),r("p",_s,O(h.value?"Отправьте первое сообщение, чтобы начать переписку.":"Подключитесь к комнате, чтобы начать общение."),1)])])):M("",!0),(f(!0),p(Y,null,ae(c.value,N=>(f(),p("article",{key:N.id,class:oe(["flex gap-3 items-start max-w-2xl",[N.senderRole==="master"?"ml-0 mr-auto":"",N.senderRole==="player"?"mr-0 ml-auto flex-row-reverse":""]])},[rs(hs,{avatar:u(N.userId).avatar,name:u(N.userId).nickname,size:"md"},null,8,["avatar","name"]),r("div",{class:oe(["rounded-xl px-5 py-3 border flex-1",[N.senderRole==="master"?"bg-sky-500/10 border-sky-400/30":"",N.senderRole==="player"?"bg-emerald-500/10 border-emerald-400/20":""]])},[r("header",Ts,[r("span",Cs,O(u(N.userId).nickname),1),r("time",null,O(k(N.time)),1)]),r("p",Ss,O(N.text),1)],2)],2))),128))],512),r("footer",Ps,[r("div",$s,[Me(r("textarea",{"onUpdate:modelValue":C[0]||(C[0]=N=>m.value=N),class:"flex-1 min-h-[56px] max-h-[200px] rounded-xl border border-white/10 bg-slate-950/60 px-4 py-3 text-base text-slate-50 resize-none",placeholder:"Напишите сообщение...",disabled:!h.value,onKeydown:I,rows:"1"},null,40,Es),[[qe,m.value]]),r("button",{type:"button",class:"h-[56px] px-6 rounded-xl bg-sky-500/20 border border-sky-400/60 font-semibold text-sky-100 hover:bg-sky-500/30 disabled:opacity-40 transition flex-shrink-0",disabled:!h.value||!m.value.trim(),onClick:y}," Отправить ",8,As)])])]))}},Le=e=>{const t="/TriP/";return e.startsWith("/")?t.endsWith("/")?t+e.slice(1):t+e:t.endsWith("/")?t+e:t+"/"+e},Is=e=>Le(`/images/presets/${e}.png`),Rr=e=>Le(`/images/classes/${e}.png`),Fr=e=>Le(`/images/items/${e}.png`),Nr=(e,t,n="base")=>Le(`/images/races/${e}/${t}/${n}.png`),Or=e=>Le(`/images/gender/${e}.png`),yn=/^[a-z0-9]+(-[a-z0-9]+)*$/,ct=(e,t,n,s="")=>{const o=e.split(":");if(e.slice(0,1)==="@"){if(o.length<2||o.length>3)return null;s=o.shift().slice(1)}if(o.length>3||!o.length)return null;if(o.length>1){const m=o.pop(),d=o.pop(),c={provider:o.length>0?o[0]:s,prefix:d,name:m};return t&&!st(c)?null:c}const l=o[0],i=l.split("-");if(i.length>1){const m={provider:s,prefix:i.shift(),name:i.join("-")};return t&&!st(m)?null:m}if(n&&s===""){const m={provider:s,prefix:"",name:l};return t&&!st(m,n)?null:m}return null},st=(e,t)=>e?!!((t&&e.prefix===""||e.prefix)&&e.name):!1,xn=Object.freeze({left:0,top:0,width:16,height:16}),lt=Object.freeze({rotate:0,vFlip:!1,hFlip:!1}),ut=Object.freeze({...xn,...lt}),wt=Object.freeze({...ut,body:"",hidden:!1});function Ms(e,t){const n={};!e.hFlip!=!t.hFlip&&(n.hFlip=!0),!e.vFlip!=!t.vFlip&&(n.vFlip=!0);const s=((e.rotate||0)+(t.rotate||0))%4;return s&&(n.rotate=s),n}function Kt(e,t){const n=Ms(e,t);for(const s in wt)s in lt?s in e&&!(s in n)&&(n[s]=lt[s]):s in t?n[s]=t[s]:s in e&&(n[s]=e[s]);return n}function Ds(e,t){const n=e.icons,s=e.aliases||Object.create(null),o=Object.create(null);function l(i){if(n[i])return o[i]=[];if(!(i in o)){o[i]=null;const m=s[i]&&s[i].parent,d=m&&l(m);d&&(o[i]=[m].concat(d))}return o[i]}return Object.keys(n).concat(Object.keys(s)).forEach(l),o}function Ls(e,t,n){const s=e.icons,o=e.aliases||Object.create(null);let l={};function i(m){l=Kt(s[m]||o[m],l)}return i(t),n.forEach(i),Kt(e,l)}function kn(e,t){const n=[];if(typeof e!="object"||typeof e.icons!="object")return n;e.not_found instanceof Array&&e.not_found.forEach(o=>{t(o,null),n.push(o)});const s=Ds(e);for(const o in s){const l=s[o];l&&(t(o,Ls(e,o,l)),n.push(o))}return n}const Rs={provider:"",aliases:{},not_found:{},...xn};function gt(e,t){for(const n in t)if(n in e&&typeof e[n]!=typeof t[n])return!1;return!0}function wn(e){if(typeof e!="object"||e===null)return null;const t=e;if(typeof t.prefix!="string"||!e.icons||typeof e.icons!="object"||!gt(e,Rs))return null;const n=t.icons;for(const o in n){const l=n[o];if(!o||typeof l.body!="string"||!gt(l,wt))return null}const s=t.aliases||Object.create(null);for(const o in s){const l=s[o],i=l.parent;if(!o||typeof i!="string"||!n[i]&&!s[i]||!gt(l,wt))return null}return t}const Jt=Object.create(null);function Fs(e,t){return{provider:e,prefix:t,icons:Object.create(null),missing:new Set}}function Ve(e,t){const n=Jt[e]||(Jt[e]=Object.create(null));return n[t]||(n[t]=Fs(e,t))}function _n(e,t){return wn(t)?kn(t,(n,s)=>{s?e.icons[n]=s:e.missing.add(n)}):[]}function Ns(e,t,n){try{if(typeof n.body=="string")return e.icons[t]={...n},!0}catch{}return!1}let et=!1;function Tn(e){return typeof e=="boolean"&&(et=e),et}function Os(e){const t=typeof e=="string"?ct(e,!0,et):e;if(t){const n=Ve(t.provider,t.prefix),s=t.name;return n.icons[s]||(n.missing.has(s)?null:void 0)}}function zs(e,t){const n=ct(e,!0,et);if(!n)return!1;const s=Ve(n.provider,n.prefix);return t?Ns(s,n.name,t):(s.missing.add(n.name),!0)}function Bs(e,t){if(typeof e!="object")return!1;if(typeof t!="string"&&(t=e.provider||""),et&&!t&&!e.prefix){let o=!1;return wn(e)&&(e.prefix="",kn(e,(l,i)=>{zs(l,i)&&(o=!0)})),o}const n=e.prefix;if(!st({prefix:n,name:"a"}))return!1;const s=Ve(t,n);return!!_n(s,e)}const Cn=Object.freeze({width:null,height:null}),Sn=Object.freeze({...Cn,...lt}),js=/(-?[0-9.]*[0-9]+[0-9.]*)/g,Ws=/^-?[0-9.]*[0-9]+[0-9.]*$/g;function Zt(e,t,n){if(t===1)return e;if(n=n||100,typeof e=="number")return Math.ceil(e*t*n)/n;if(typeof e!="string")return e;const s=e.split(js);if(s===null||!s.length)return e;const o=[];let l=s.shift(),i=Ws.test(l);for(;;){if(i){const m=parseFloat(l);isNaN(m)?o.push(l):o.push(Math.ceil(m*t*n)/n)}else o.push(l);if(l=s.shift(),l===void 0)return o.join("");i=!i}}function Hs(e,t="defs"){let n="";const s=e.indexOf("<"+t);for(;s>=0;){const o=e.indexOf(">",s),l=e.indexOf("</"+t);if(o===-1||l===-1)break;const i=e.indexOf(">",l);if(i===-1)break;n+=e.slice(o+1,l).trim(),e=e.slice(0,s).trim()+e.slice(i+1)}return{defs:n,content:e}}function Us(e,t){return e?"<defs>"+e+"</defs>"+t:t}function qs(e,t,n){const s=Hs(e);return Us(s.defs,t+s.content+n)}const Vs=e=>e==="unset"||e==="undefined"||e==="none";function Ys(e,t){const n={...ut,...e},s={...Sn,...t},o={left:n.left,top:n.top,width:n.width,height:n.height};let l=n.body;[n,s].forEach(P=>{const C=[],N=P.hFlip,J=P.vFlip;let X=P.rotate;N?J?X+=2:(C.push("translate("+(o.width+o.left).toString()+" "+(0-o.top).toString()+")"),C.push("scale(-1 1)"),o.top=o.left=0):J&&(C.push("translate("+(0-o.left).toString()+" "+(o.height+o.top).toString()+")"),C.push("scale(1 -1)"),o.top=o.left=0);let w;switch(X<0&&(X-=Math.floor(X/4)*4),X=X%4,X){case 1:w=o.height/2+o.top,C.unshift("rotate(90 "+w.toString()+" "+w.toString()+")");break;case 2:C.unshift("rotate(180 "+(o.width/2+o.left).toString()+" "+(o.height/2+o.top).toString()+")");break;case 3:w=o.width/2+o.left,C.unshift("rotate(-90 "+w.toString()+" "+w.toString()+")");break}X%2===1&&(o.left!==o.top&&(w=o.left,o.left=o.top,o.top=w),o.width!==o.height&&(w=o.width,o.width=o.height,o.height=w)),C.length&&(l=qs(l,'<g transform="'+C.join(" ")+'">',"</g>"))});const i=s.width,m=s.height,d=o.width,c=o.height;let u,h;i===null?(h=m===null?"1em":m==="auto"?c:m,u=Zt(h,d/c)):(u=i==="auto"?d:i,h=m===null?Zt(u,c/d):m==="auto"?c:m);const y={},I=(P,C)=>{Vs(C)||(y[P]=C.toString())};I("width",u),I("height",h);const k=[o.left,o.top,d,c];return y.viewBox=k.join(" "),{attributes:y,viewBox:k,body:l}}const Gs=/\sid="(\S+)"/g,Xs="IconifyId"+Date.now().toString(16)+(Math.random()*16777216|0).toString(16);let Qs=0;function Ks(e,t=Xs){const n=[];let s;for(;s=Gs.exec(e);)n.push(s[1]);if(!n.length)return e;const o="suffix"+(Math.random()*16777216|Date.now()).toString(16);return n.forEach(l=>{const i=typeof t=="function"?t(l):t+(Qs++).toString(),m=l.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");e=e.replace(new RegExp('([#;"])('+m+')([")]|\\.[a-z])',"g"),"$1"+i+o+"$3")}),e=e.replace(new RegExp(o,"g"),""),e}const _t=Object.create(null);function Js(e,t){_t[e]=t}function Tt(e){return _t[e]||_t[""]}function St(e){let t;if(typeof e.resources=="string")t=[e.resources];else if(t=e.resources,!(t instanceof Array)||!t.length)return null;return{resources:t,path:e.path||"/",maxURL:e.maxURL||500,rotate:e.rotate||750,timeout:e.timeout||5e3,random:e.random===!0,index:e.index||0,dataAfterTimeout:e.dataAfterTimeout!==!1}}const Pt=Object.create(null),Xe=["https://api.simplesvg.com","https://api.unisvg.com"],ot=[];for(;Xe.length>0;)Xe.length===1||Math.random()>.5?ot.push(Xe.shift()):ot.push(Xe.pop());Pt[""]=St({resources:["https://api.iconify.design"].concat(ot)});function Zs(e,t){const n=St(t);return n===null?!1:(Pt[e]=n,!0)}function $t(e){return Pt[e]}const eo=()=>{let e;try{if(e=fetch,typeof e=="function")return e}catch{}};let en=eo();function to(e,t){const n=$t(e);if(!n)return 0;let s;if(!n.maxURL)s=0;else{let o=0;n.resources.forEach(i=>{o=Math.max(o,i.length)});const l=t+".json?icons=";s=n.maxURL-o-n.path.length-l.length}return s}function no(e){return e===404}const so=(e,t,n)=>{const s=[],o=to(e,t),l="icons";let i={type:l,provider:e,prefix:t,icons:[]},m=0;return n.forEach((d,c)=>{m+=d.length+1,m>=o&&c>0&&(s.push(i),i={type:l,provider:e,prefix:t,icons:[]},m=d.length),i.icons.push(d)}),s.push(i),s};function oo(e){if(typeof e=="string"){const t=$t(e);if(t)return t.path}return"/"}const ao=(e,t,n)=>{if(!en){n("abort",424);return}let s=oo(t.provider);switch(t.type){case"icons":{const l=t.prefix,m=t.icons.join(","),d=new URLSearchParams({icons:m});s+=l+".json?"+d.toString();break}case"custom":{const l=t.uri;s+=l.slice(0,1)==="/"?l.slice(1):l;break}default:n("abort",400);return}let o=503;en(e+s).then(l=>{const i=l.status;if(i!==200){setTimeout(()=>{n(no(i)?"abort":"next",i)});return}return o=501,l.json()}).then(l=>{if(typeof l!="object"||l===null){setTimeout(()=>{l===404?n("abort",l):n("next",o)});return}setTimeout(()=>{n("success",l)})}).catch(()=>{n("next",o)})},lo={prepare:so,send:ao};function io(e){const t={loaded:[],missing:[],pending:[]},n=Object.create(null);e.sort((o,l)=>o.provider!==l.provider?o.provider.localeCompare(l.provider):o.prefix!==l.prefix?o.prefix.localeCompare(l.prefix):o.name.localeCompare(l.name));let s={provider:"",prefix:"",name:""};return e.forEach(o=>{if(s.name===o.name&&s.prefix===o.prefix&&s.provider===o.provider)return;s=o;const l=o.provider,i=o.prefix,m=o.name,d=n[l]||(n[l]=Object.create(null)),c=d[i]||(d[i]=Ve(l,i));let u;m in c.icons?u=t.loaded:i===""||c.missing.has(m)?u=t.missing:u=t.pending;const h={provider:l,prefix:i,name:m};u.push(h)}),t}function Pn(e,t){e.forEach(n=>{const s=n.loaderCallbacks;s&&(n.loaderCallbacks=s.filter(o=>o.id!==t))})}function ro(e){e.pendingCallbacksFlag||(e.pendingCallbacksFlag=!0,setTimeout(()=>{e.pendingCallbacksFlag=!1;const t=e.loaderCallbacks?e.loaderCallbacks.slice(0):[];if(!t.length)return;let n=!1;const s=e.provider,o=e.prefix;t.forEach(l=>{const i=l.icons,m=i.pending.length;i.pending=i.pending.filter(d=>{if(d.prefix!==o)return!0;const c=d.name;if(e.icons[c])i.loaded.push({provider:s,prefix:o,name:c});else if(e.missing.has(c))i.missing.push({provider:s,prefix:o,name:c});else return n=!0,!0;return!1}),i.pending.length!==m&&(n||Pn([e],l.id),l.callback(i.loaded.slice(0),i.missing.slice(0),i.pending.slice(0),l.abort))})}))}let co=0;function uo(e,t,n){const s=co++,o=Pn.bind(null,n,s);if(!t.pending.length)return o;const l={id:s,icons:t,callback:e,abort:o};return n.forEach(i=>{(i.loaderCallbacks||(i.loaderCallbacks=[])).push(l)}),o}function fo(e,t=!0,n=!1){const s=[];return e.forEach(o=>{const l=typeof o=="string"?ct(o,t,n):o;l&&s.push(l)}),s}var po={resources:[],index:0,timeout:2e3,rotate:750,random:!1,dataAfterTimeout:!1};function ho(e,t,n,s){const o=e.resources.length,l=e.random?Math.floor(Math.random()*o):e.index;let i;if(e.random){let A=e.resources.slice(0);for(i=[];A.length>1;){const x=Math.floor(Math.random()*A.length);i.push(A[x]),A=A.slice(0,x).concat(A.slice(x+1))}i=i.concat(A)}else i=e.resources.slice(l).concat(e.resources.slice(0,l));const m=Date.now();let d="pending",c=0,u,h=null,y=[],I=[];typeof s=="function"&&I.push(s);function k(){h&&(clearTimeout(h),h=null)}function P(){d==="pending"&&(d="aborted"),k(),y.forEach(A=>{A.status==="pending"&&(A.status="aborted")}),y=[]}function C(A,x){x&&(I=[]),typeof A=="function"&&I.push(A)}function N(){return{startTime:m,payload:t,status:d,queriesSent:c,queriesPending:y.length,subscribe:C,abort:P}}function J(){d="failed",I.forEach(A=>{A(void 0,u)})}function X(){y.forEach(A=>{A.status==="pending"&&(A.status="aborted")}),y=[]}function w(A,x,$){const R=x!=="success";switch(y=y.filter(W=>W!==A),d){case"pending":break;case"failed":if(R||!e.dataAfterTimeout)return;break;default:return}if(x==="abort"){u=$,J();return}if(R){u=$,y.length||(i.length?z():J());return}if(k(),X(),!e.random){const W=e.resources.indexOf(A.resource);W!==-1&&W!==e.index&&(e.index=W)}d="completed",I.forEach(W=>{W($)})}function z(){if(d!=="pending")return;k();const A=i.shift();if(A===void 0){if(y.length){h=setTimeout(()=>{k(),d==="pending"&&(X(),J())},e.timeout);return}J();return}const x={status:"pending",resource:A,callback:($,R)=>{w(x,$,R)}};y.push(x),c++,h=setTimeout(z,e.rotate),n(A,t,x.callback)}return setTimeout(z),N}function $n(e){const t={...po,...e};let n=[];function s(){n=n.filter(m=>m().status==="pending")}function o(m,d,c){const u=ho(t,m,d,(h,y)=>{s(),c&&c(h,y)});return n.push(u),u}function l(m){return n.find(d=>m(d))||null}return{query:o,find:l,setIndex:m=>{t.index=m},getIndex:()=>t.index,cleanup:s}}function tn(){}const vt=Object.create(null);function mo(e){if(!vt[e]){const t=$t(e);if(!t)return;const n=$n(t),s={config:t,redundancy:n};vt[e]=s}return vt[e]}function go(e,t,n){let s,o;if(typeof e=="string"){const l=Tt(e);if(!l)return n(void 0,424),tn;o=l.send;const i=mo(e);i&&(s=i.redundancy)}else{const l=St(e);if(l){s=$n(l);const i=e.resources?e.resources[0]:"",m=Tt(i);m&&(o=m.send)}}return!s||!o?(n(void 0,424),tn):s.query(t,o,n)().abort}function nn(){}function vo(e){e.iconsLoaderFlag||(e.iconsLoaderFlag=!0,setTimeout(()=>{e.iconsLoaderFlag=!1,ro(e)}))}function bo(e){const t=[],n=[];return e.forEach(s=>{(s.match(yn)?t:n).push(s)}),{valid:t,invalid:n}}function Qe(e,t,n){function s(){const o=e.pendingIcons;t.forEach(l=>{o&&o.delete(l),e.icons[l]||e.missing.add(l)})}if(n&&typeof n=="object")try{if(!_n(e,n).length){s();return}}catch(o){console.error(o)}s(),vo(e)}function sn(e,t){e instanceof Promise?e.then(n=>{t(n)}).catch(()=>{t(null)}):t(e)}function yo(e,t){e.iconsToLoad?e.iconsToLoad=e.iconsToLoad.concat(t).sort():e.iconsToLoad=t,e.iconsQueueFlag||(e.iconsQueueFlag=!0,setTimeout(()=>{e.iconsQueueFlag=!1;const{provider:n,prefix:s}=e,o=e.iconsToLoad;if(delete e.iconsToLoad,!o||!o.length)return;const l=e.loadIcon;if(e.loadIcons&&(o.length>1||!l)){sn(e.loadIcons(o,s,n),u=>{Qe(e,o,u)});return}if(l){o.forEach(u=>{const h=l(u,s,n);sn(h,y=>{const I=y?{prefix:s,icons:{[u]:y}}:null;Qe(e,[u],I)})});return}const{valid:i,invalid:m}=bo(o);if(m.length&&Qe(e,m,null),!i.length)return;const d=s.match(yn)?Tt(n):null;if(!d){Qe(e,i,null);return}d.prepare(n,s,i).forEach(u=>{go(n,u,h=>{Qe(e,u.icons,h)})})}))}const xo=(e,t)=>{const n=fo(e,!0,Tn()),s=io(n);if(!s.pending.length){let d=!0;return t&&setTimeout(()=>{d&&t(s.loaded,s.missing,s.pending,nn)}),()=>{d=!1}}const o=Object.create(null),l=[];let i,m;return s.pending.forEach(d=>{const{provider:c,prefix:u}=d;if(u===m&&c===i)return;i=c,m=u,l.push(Ve(c,u));const h=o[c]||(o[c]=Object.create(null));h[u]||(h[u]=[])}),s.pending.forEach(d=>{const{provider:c,prefix:u,name:h}=d,y=Ve(c,u),I=y.pendingIcons||(y.pendingIcons=new Set);I.has(h)||(I.add(h),o[c][u].push(h))}),l.forEach(d=>{const c=o[d.provider][d.prefix];c.length&&yo(d,c)}),t?uo(t,s,l):nn};function ko(e,t){const n={...e};for(const s in t){const o=t[s],l=typeof o;s in Cn?(o===null||o&&(l==="string"||l==="number"))&&(n[s]=o):l===typeof n[s]&&(n[s]=s==="rotate"?o%4:o)}return n}const wo=/[\s,]+/;function _o(e,t){t.split(wo).forEach(n=>{switch(n.trim()){case"horizontal":e.hFlip=!0;break;case"vertical":e.vFlip=!0;break}})}function To(e,t=0){const n=e.replace(/^-?[0-9.]*/,"");function s(o){for(;o<0;)o+=4;return o%4}if(n===""){const o=parseInt(e);return isNaN(o)?0:s(o)}else if(n!==e){let o=0;switch(n){case"%":o=25;break;case"deg":o=90}if(o){let l=parseFloat(e.slice(0,e.length-n.length));return isNaN(l)?0:(l=l/o,l%1===0?s(l):0)}}return t}function Co(e,t){let n=e.indexOf("xlink:")===-1?"":' xmlns:xlink="http://www.w3.org/1999/xlink"';for(const s in t)n+=" "+s+'="'+t[s]+'"';return'<svg xmlns="http://www.w3.org/2000/svg"'+n+">"+e+"</svg>"}function So(e){return e.replace(/"/g,"'").replace(/%/g,"%25").replace(/#/g,"%23").replace(/</g,"%3C").replace(/>/g,"%3E").replace(/\s+/g," ")}function Po(e){return"data:image/svg+xml,"+So(e)}function $o(e){return'url("'+Po(e)+'")'}const on={...Sn,inline:!1},Eo={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink","aria-hidden":!0,role:"img"},Ao={display:"inline-block"},Ct={backgroundColor:"currentColor"},En={backgroundColor:"transparent"},an={Image:"var(--svg)",Repeat:"no-repeat",Size:"100% 100%"},ln={webkitMask:Ct,mask:Ct,background:En};for(const e in ln){const t=ln[e];for(const n in an)t[e+n]=an[n]}const at={};["horizontal","vertical"].forEach(e=>{const t=e.slice(0,1)+"Flip";at[e+"-flip"]=t,at[e.slice(0,1)+"-flip"]=t,at[e+"Flip"]=t});function rn(e){return e+(e.match(/^[-0-9.]+$/)?"px":"")}const cn=(e,t)=>{const n=ko(on,t),s={...Eo},o=t.mode||"svg",l={},i=t.style,m=typeof i=="object"&&!(i instanceof Array)?i:{};for(let P in t){const C=t[P];if(C!==void 0)switch(P){case"icon":case"style":case"onLoad":case"mode":case"ssr":break;case"inline":case"hFlip":case"vFlip":n[P]=C===!0||C==="true"||C===1;break;case"flip":typeof C=="string"&&_o(n,C);break;case"color":l.color=C;break;case"rotate":typeof C=="string"?n[P]=To(C):typeof C=="number"&&(n[P]=C);break;case"ariaHidden":case"aria-hidden":C!==!0&&C!=="true"&&delete s["aria-hidden"];break;default:{const N=at[P];N?(C===!0||C==="true"||C===1)&&(n[N]=!0):on[P]===void 0&&(s[P]=C)}}}const d=Ys(e,n),c=d.attributes;if(n.inline&&(l.verticalAlign="-0.125em"),o==="svg"){s.style={...l,...m},Object.assign(s,c);let P=0,C=t.id;return typeof C=="string"&&(C=C.replace(/-/g,"_")),s.innerHTML=Ks(d.body,C?()=>C+"ID"+P++:"iconifyVue"),Gt("svg",s)}const{body:u,width:h,height:y}=e,I=o==="mask"||(o==="bg"?!1:u.indexOf("currentColor")!==-1),k=Co(u,{...c,width:h+"",height:y+""});return s.style={...l,"--svg":$o(k),width:rn(c.width),height:rn(c.height),...Ao,...I?Ct:En,...m},Gt("span",s)};Tn(!0);Js("",lo);if(typeof document<"u"&&typeof window<"u"){const e=window;if(e.IconifyPreload!==void 0){const t=e.IconifyPreload,n="Invalid IconifyPreload syntax.";typeof t=="object"&&t!==null&&(t instanceof Array?t:[t]).forEach(s=>{try{(typeof s!="object"||s===null||s instanceof Array||typeof s.icons!="object"||typeof s.prefix!="string"||!Bs(s))&&console.error(n)}catch{console.error(n)}})}if(e.IconifyProviders!==void 0){const t=e.IconifyProviders;if(typeof t=="object"&&t!==null)for(let n in t){const s="IconifyProviders["+n+"] is invalid.";try{const o=t[n];if(typeof o!="object"||!o||o.resources===void 0)continue;Zs(n,o)||console.error(s)}catch{console.error(s)}}}}const Io={...ut,body:""},zr=cs((e,{emit:t})=>{const n=j(null);function s(){var c,u;n.value&&((u=(c=n.value).abort)==null||u.call(c),n.value=null)}const o=j(!!e.ssr),l=j(""),i=us(null);function m(){const c=e.icon;if(typeof c=="object"&&c!==null&&typeof c.body=="string")return l.value="",{data:c};let u;if(typeof c!="string"||(u=ct(c,!1,!0))===null)return null;let h=Os(u);if(!h){const k=n.value;return(!k||k.name!==c)&&(h===null?n.value={name:c}:n.value={name:c,abort:xo([u],d)}),null}s(),l.value!==c&&(l.value=c,je(()=>{t("load",c)}));const y=e.customise;if(y){h=Object.assign({},h);const k=y(h.body,u.name,u.prefix,u.provider);typeof k=="string"&&(h.body=k)}const I=["iconify"];return u.prefix!==""&&I.push("iconify--"+u.prefix),u.provider!==""&&I.push("iconify--"+u.provider),{data:h,classes:I}}function d(){var u;const c=m();c?c.data!==((u=i.value)==null?void 0:u.data)&&(i.value=c):i.value=null}return o.value?d():mn(()=>{o.value=!0,d()}),Je(()=>e.icon,d),gn(s),()=>{const c=i.value;if(!c)return cn(Io,e);let u=e;return c.classes&&(u={...e,class:c.classes.join(" ")}),cn({...ut,...c.data},u)}},{props:["icon","mode","ssr","width","height","style","color","inline","rotate","hFlip","horizontalFlip","vFlip","verticalFlip","flip","id","ariaHidden","customise","title"],emits:["load"]}),Mo=[{id:"war",name:"Война",nameEn:"War",description:"Физическая сила, боевые навыки, агрессия и доминирование",characteristic:{name:"Мощь",nameEn:"Might",abbreviation:"MIG"},check:{name:"Конфликт",nameEn:"Conflict",description:"Проверки прямого противостояния, боя и физической силы"},color:"#dc2626",colorName:"red",icon:"game-icons:crossed-swords",characteristicIcon:"game-icons:embrassed-energy",checkIcon:"game-icons:arrow-scope",position:{angle:330,corner:"top-left",description:"Верхний левый угол шестиугольника"},neighbors:["nature","knowledge"],opposite:"shadow",axis:{id:"power",name:"Сила",nameEn:"Power",pole:"active"}},{id:"knowledge",name:"Знание",nameEn:"Knowledge",description:"Интеллект, логика, наука и аналитическое мышление",characteristic:{name:"Разум",nameEn:"Reason",abbreviation:"REA"},check:{name:"Порядок",nameEn:"Order",description:"Проверки знаний, логики и систематического подхода"},color:"#3b82f7",colorName:"blue",icon:"game-icons:open-book",characteristicIcon:"game-icons:inspiration",checkIcon:"game-icons:materials-science",position:{angle:30,corner:"top-right",description:"Верхний правый угол шестиугольника"},neighbors:["war","community"],opposite:"mysticism",axis:{id:"progress",name:"Развитие",nameEn:"Progress",pole:"rational"}},{id:"community",name:"Общество",nameEn:"Community",description:"Социальные связи, лидерство, убеждение и дипломатия",characteristic:{name:"Харизма",nameEn:"Charisma",abbreviation:"CHA"},check:{name:"Влияние",nameEn:"Influence",description:"Проверки социального взаимодействия и убеждения"},color:"#f59e0b",colorName:"amber",icon:"game-icons:human-pyramid",characteristicIcon:"game-icons:cheerful",checkIcon:"game-icons:caesar",position:{angle:90,corner:"right",description:"Правый угол шестиугольника"},neighbors:["knowledge","shadow"],opposite:"nature",axis:{id:"path",name:"Путь",nameEn:"Path",pole:"civilization"}},{id:"shadow",name:"Тень",nameEn:"Shadow",description:"Скрытность, обман, манипуляция и тайные действия",characteristic:{name:"Хитрость",nameEn:"Cunning",abbreviation:"CUN"},check:{name:"Коварство",nameEn:"Treachery",description:"Проверки скрытности, обмана и манипуляций"},color:"#374151",colorName:"gray",icon:"game-icons:cowled",characteristicIcon:"game-icons:domino-mask",checkIcon:"game-icons:hooded-figure",position:{angle:150,corner:"bottom-right",description:"Нижний правый угол шестиугольника"},neighbors:["community","mysticism"],opposite:"war",axis:{id:"power",name:"Сила",nameEn:"Power",pole:"subtle"}},{id:"mysticism",name:"Мистика",nameEn:"Mysticism",description:"Магия, духовность, интуиция и связь с потусторонним",characteristic:{name:"Интуиция",nameEn:"Intuition",abbreviation:"INT"},check:{name:"Хаос",nameEn:"Chaos",description:"Проверки магии, интуиции и духовной связи"},color:"#9333ea",colorName:"purple",icon:"game-icons:pentacle",characteristicIcon:"game-icons:coiling-curl",checkIcon:"game-icons:small-fire",position:{angle:210,corner:"bottom-left",description:"Нижний левый угол шестиугольника"},neighbors:["shadow","nature"],opposite:"knowledge",axis:{id:"progress",name:"Развитие",nameEn:"Progress",pole:"intuitive"}},{id:"nature",name:"Природа",nameEn:"Nature",description:"Связь с природой, выживание, животные инстинкты и гармония",characteristic:{name:"Восприятие",nameEn:"Perception",abbreviation:"PER"},check:{name:"Поиск",nameEn:"Search",description:"Проверки наблюдательности, выживания и связи с природой"},color:"#22c55e",colorName:"green",icon:"game-icons:curled-leaf",characteristicIcon:"game-icons:semi-closed-eye",checkIcon:"game-icons:spyglass",position:{angle:270,corner:"left",description:"Левый угол шестиугольника"},neighbors:["mysticism","war"],opposite:"community",axis:{id:"path",name:"Путь",nameEn:"Path",pole:"wilderness"}}],Do=[{id:"power",name:"Сила",nameEn:"Power",description:"Ось силы: от прямой физической мощи до скрытого влияния",aspects:["war","shadow"],poles:{active:{aspect:"war",description:"Прямое действие, открытая сила, доминирование"},subtle:{aspect:"shadow",description:"Скрытое влияние, манипуляция, тайные действия"}}},{id:"progress",name:"Развитие",nameEn:"Progress",description:"Ось развития: от рационального познания до интуитивного понимания",aspects:["knowledge","mysticism"],poles:{rational:{aspect:"knowledge",description:"Логика, наука, аналитическое мышление"},intuitive:{aspect:"mysticism",description:"Интуиция, магия, духовное познание"}}},{id:"path",name:"Путь",nameEn:"Path",description:"Ось пути: от дикой природы до цивилизованного общества",aspects:["nature","community"],poles:{wilderness:{aspect:"nature",description:"Природа, инстинкты, гармония с окружением"},civilization:{aspect:"community",description:"Общество, культура, социальные структуры"}}}],Lo={systemName:"triP",systemFullName:"Triple P System",systemDescription:"Система трёх осей: Power (Сила), Progress (Развитие), Path (Путь)",version:"1.0",aspectCount:6,axisCount:3,circularOrder:["war","knowledge","community","shadow","mysticism","nature"]},Ro={aspects:Mo,axes:Do,metadata:Lo},Fo=[{id:"clothes",category:"armor",subcat:"light",name:"Обычная одежда",desc:"Надевать такую в бой - довольно сомнительная затея. Однако на полях сражений нередко оказывались те, кто не смог себе позволить вовсе никакую броню. А иногда и серьёзных воинов нападение заставало не готовыми, погружёнными в обычные бытовые проблемы.",price:1,epoch:1,defence:0,resist:0,movement:0,bursts:0},{id:"makeshift_light_armor",category:"armor",subcat:"light",name:"Крепкая одежда",desc:"Некоторые виды одежды лучше других держат удар, что позволяет использовать их в качестве импровизированной брони. Это может быть куртка из толстой кожи, шкура зверя или вовсе обычные одеяния, на которые нашили твёрдые элементы.",price:3,epoch:2,defence:3,resist:0,movement:0,bursts:0},{id:"makeshift_heavy_armor",category:"armor",subcat:"heavy",name:"Кустарная тяжёлая броня",desc:"Хорошенько потрудившись, можно сделать из обычной одежды некое подобие брони. Обилие нашитых элементов здорово сковывает движение, зато такой доспех снижает входящий урон и (главное), очень дёшев в производстве.",price:3,epoch:2,defence:0,resist:1,movement:-1,bursts:-1},{id:"light_armor",category:"armor",subcat:"light",name:"Лёгкая броня",desc:"Лёгкая броня не сковывает движений и даёт кое-какую защиту - попасть в уязвимое место противнику становится значительно сложнее.",price:5,epoch:4,defence:6,resist:0,movement:0,bursts:0},{id:"heavy_armor",category:"armor",subcat:"heavy",name:"Тяжёлая броня",desc:"Хорошая тяжёлая броня лишь немного сковывает движения, но уворачиваться в ней уже гораздо сложнее. Зато, если по Вам всё же попали, урона Вы получите значительно меньше.",price:5,epoch:4,defence:0,resist:1,movement:-1,bursts:0},{id:"late_light_armor",category:"armor",subcat:"light",name:"Поздняя лёгкая броня",desc:"Позволить себе такой шедевр мастерства бронников могут не многие, зато живут на поле боя эти счастливчики гораздо дольше других. Защищённых областей на теле больше, а маневренность при этом никак не страдает.",price:7,epoch:6,defence:12,resist:0,movement:0,bursts:0},{id:"late_medium_armor",category:"armor",subcat:"middle",name:"Поздняя средняя броня",desc:"Хороший компромисс между подвижностью и защищённостью, но по совершенно бескомпромиссной цене.",price:7,epoch:6,defence:3,resist:1,movement:0,bursts:0},{id:"late_heavy_armor",category:"armor",subcat:"heavy",name:"Поздняя тяжёлая броня",desc:"Для тех, кто хочет почувствовать себя настоящим танком на поле боя - беспрецедентный уровень защищённости при минимальной подвижности. Несмотря на огромную цену этих доспехов, вряд ли найдётся идиот, который захочет сразиться с Вами ради такого трофея.",price:7,epoch:6,defence:0,resist:2,movement:-1,bursts:0},{id:"simple_spear",category:"weapon",subcat:"spears",name:"Простое копьё",desc:"",length:2,hands:1,price:2,epoch:2,attack:4,defence:3,damageType:"Колющий",armorPen:0,damage:{0:"Царапина",3:"Лёгкий урон",6:"Точный удар"}},{id:"iron_spear",category:"weapon",subcat:"spears",name:"Железное копьё",desc:"",length:2,hands:1,price:4,epoch:4,attack:5,defence:3,damageType:"Колющий",armorPen:0,damage:{0:"Царапина",2:"Лёгкий урон",4:"Точный удар",6:"Тяжёлый урон"}},{id:"steel_spear",category:"weapon",subcat:"spears",name:"Стальное копьё",desc:"",length:2,hands:1,price:6,epoch:6,attack:6,defence:4,damageType:"Колющий",armorPen:0,damage:{0:"Царапина",2:"Лёгкий урон",4:"Точный удар",6:"Тяжёлый урон",9:"Огромный урон"}},{id:"iron_glaive",category:"weapon",subcat:"spears",name:"Глефа",desc:"",length:2,hands:2,price:5,epoch:5,attack:6,defence:2,damageType:"Рубящий",armorPen:0,damage:{0:"Лёгкий урон",3:"Тяжёлый урон",6:"Точный удар",9:"Огромный урон"}},{id:"steel_glaive",category:"weapon",subcat:"spears",name:"Стальная глефа",desc:"",length:2,hands:2,price:7,epoch:7,attack:8,defence:4,damageType:"Рубящий",armorPen:0,damage:{0:"Лёгкий урон",2:"Тяжёлый урон",4:"Точный удар",8:"Огромный урон"}},{id:"iron_halberd",category:"weapon",subcat:"spears",name:"Алебарда",desc:"",length:2,hands:2,price:5,epoch:5,attack:4,defence:3,damageType:"Рубящий",armorPen:0,damage:{0:"Лёгкий урон",2:"Тяжёлый урон",6:"Огромный урон"}},{id:"steel_halberd",category:"weapon",subcat:"spears",name:"Стальная алебарда",desc:"",length:2,hands:2,price:7,epoch:7,attack:5,defence:4,damageType:"Рубящий",armorPen:0,damage:{0:"Лёгкий урон",2:"Тяжёлый урон",6:"Огромный урон"}},{id:"simple_bow",category:"weapon",subcat:"bows",name:"Короткий лук",desc:"",spec:"Нельзя стрелять с порывом",length:2,hands:2,price:3,epoch:2,attack:6,defence:0,damageType:"Колющий",armorPen:0,damage:{0:"Царапина",3:"Лёгкий урон",6:"Точный удар"}},{id:"strong_bow",category:"weapon",subcat:"bows",name:"Боевой лук",desc:"",spec:"",length:2,hands:2,price:4,epoch:4,attack:6,defence:0,damageType:"Колющий",armorPen:0,damage:{0:"Царапина",3:"Лёгкий урон",6:"Точный удар",9:"Тяжёлый урон"}},{id:"longbow",category:"weapon",subcat:"bows",name:"Длинный лук",desc:"",spec:"Нельзя стрелять без порыва. Можно вкладывать в выстрел второй порыв, тогда игнорирует единицу брони.",length:2,hands:2,price:5,epoch:4,attack:6,defence:0,damageType:"Колющий",armorPen:0,damage:{0:"Лёгкий урон",3:"Точный удар",6:"Тяжёлый урон",12:"Огромный урон"}},{id:"stone_knife",category:"weapon",subcat:"daggers",name:"Простой нож",desc:"",length:1,hands:.5,price:1,epoch:1,attack:2,defence:0,damageType:"Колющий",armorPen:0,damage:{0:"Царапина",3:"Лёгкий урон",5:"Точный удар"}},{id:"knife",category:"weapon",subcat:"daggers",name:"Добротный нож",desc:"",length:1,hands:.5,price:2,epoch:2,attack:2,defence:1,damageType:"Колющий",armorPen:0,damage:{0:"Царапина",2:"Лёгкий урон",3:"Точный удар"}},{id:"steel_dagger",category:"weapon",subcat:"daggers",name:"Cтальной кинжал",desc:"",length:1,hands:.5,price:5,epoch:4,attack:3,defence:1,damageType:"Колющий",armorPen:0,damage:{0:"Царапина",2:"Лёгкий урон",3:"Точный удар",4:"Тяжёлый урон"}},{id:"stiletto",category:"weapon",subcat:"daggers",name:"Стилет",desc:"Стилет не особенно то удобен в бою, зато замечательно пронзает многие виды доспехов.",length:1,hands:.5,price:6,epoch:5,attack:2,defence:0,damageType:"Колющий",armorPen:2,damage:{0:"Царапина",2:"Лёгкий урон",3:"Точный удар",6:"Тяжёлый урон"}},{id:"main_gauche",category:"weapon",subcat:"daggers",name:"Дага",desc:"Дага - преимущественно защитный кинжал во вторую руку, тем не менее может применяться и для нанесения серьёзных ударов. Особенно, если вражеская защита пробита. Атаки дагой во второй руке могут наносить ту же категорию ранения, что и атаки основным оружием, а не на категорию ниже, как обычно.",length:1,hands:1,price:6,epoch:5,attack:2,defence:4,damageType:"Колющий",armorPen:0,damage:{0:"Царапина",2:"Лёгкий урон",3:"Точный удар",6:"Тяжёлый урон"}},{id:"wooden_flail",category:"weapon",subcat:"flails",name:"Цеп",desc:"",length:1,hands:1,price:1,epoch:2,attack:6,defence:0,damageType:"Дробящий",armorPen:1,damage:{0:"Царапина",3:"Лёгкий урон"}},{id:"iron_flail",category:"weapon",subcat:"flails",name:"Железный цеп",desc:"",length:2,hands:1,price:5,epoch:4,attack:8,defence:0,damageType:"Дробящий",armorPen:1,damage:{0:"Царапина",6:"Лёгкий урон",12:"Тяжёлый урон",15:"Точный удар"}},{id:"steel_flail",category:"weapon",subcat:"flails",name:"Стальной цеп",desc:"",length:2,hands:1,price:6,epoch:6,attack:9,defence:0,damageType:"Дробящий",armorPen:1,damage:{0:"Царапина",6:"Лёгкий урон",9:"Тяжёлый урон",12:"Точный удар"}},{id:"wooden_club",category:"weapon",subcat:"maces",name:"Дубинка",desc:"",length:1,hands:1,price:1,epoch:1,attack:2,defence:2,damageType:"Дробящий",armorPen:1,damage:{0:"Царапина",6:"Лёгкий урон"}},{id:"simple_staff",category:"weapon",subcat:"maces",name:"Простой посох",desc:"",length:2,hands:2,price:1,epoch:1,attack:2,defence:2,damageType:"Дробящий",armorPen:0,damage:{0:"Царапина",6:"Лёгкий урон"}},{id:"battle_staff",category:"weapon",subcat:"maces",name:"Боевой посох",desc:"",length:2,hands:2,price:3,epoch:3,attack:4,defence:2,damageType:"Дробящий",armorPen:0,damage:{0:"Царапина",5:"Лёгкий урон",10:"Тяжёлый урон"}},{id:"steel_staff",category:"weapon",subcat:"maces",name:"Стальной посох",desc:"",length:2,hands:2,price:5,epoch:5,attack:4,defence:4,damageType:"Дробящий",armorPen:1,damage:{0:"Царапина",5:"Лёгкий урон",10:"Тяжёлый урон"}},{id:"iron_mace",category:"weapon",subcat:"maces",name:"Булава",desc:"",length:1,hands:1,price:5,epoch:4,attack:4,defence:2,damageType:"Дробящий",armorPen:1,damage:{0:"Царапина",6:"Тяжёлый урон",12:"Точный удар"}},{id:"steel_mace",category:"weapon",subcat:"maces",name:"Стальная булава",desc:"",length:1,hands:1,price:7,epoch:6,attack:5,defence:3,damageType:"Дробящий",armorPen:1,damage:{0:"Царапина",2:"Лёгкий урон",4:"Тяжёлый урон",6:"Точный удар"}},{id:"simple_axe",category:"weapon",subcat:"axes",name:"Плотницкий топор",desc:"",length:1,hands:1,price:2,epoch:1,attack:4,defence:2,damageType:"Режущий",armorPen:0,damage:{0:"Царапина",8:"Тяжёлый урон",9:"Точный удар"}},{id:"battle_axe",category:"weapon",subcat:"axes",name:"Боевой топорик",desc:"",length:1,hands:1,price:5,epoch:4,attack:6,defence:3,damageType:"Режущий",armorPen:0,damage:{0:"Царапина",3:"Лёгкий урон",6:"Точный удар",9:"Тяжёлый урон"}},{id:"steel_axe",category:"weapon",subcat:"axes",name:"Стальной топор",desc:"",length:1,hands:1,price:6,epoch:7,attack:8,defence:3,damageType:"Режущий",armorPen:0,damage:{0:"Царапина",2:"Лёгкий урон",4:"Точный удар",6:"Тяжёлый урон"}},{id:"battle_greataxe",category:"weapon",subcat:"axes",name:"Двуручный топор",desc:"",length:2,hands:2,price:6,epoch:5,attack:6,defence:3,damageType:"Режущий",armorPen:0,damage:{0:"Лёгкий урон",3:"Тяжёлый урон",9:"Огромный урон",12:"Точный удар"}},{id:"steel_greataxe",category:"weapon",subcat:"axes",name:"Стальной двуручный топор",desc:"",length:2,hands:2,price:7,epoch:7,attack:8,defence:3,damageType:"Режущий",armorPen:0,damage:{0:"Лёгкий урон",2:"Тяжёлый урон",8:"Огромный урон",10:"Точный удар"}},{id:"stone_hammer",category:"weapon",subcat:"maces",name:"Каменный молоток",desc:"",length:1,hands:1,price:2,epoch:2,attack:2,defence:0,damageType:"Дробящий",armorPen:1,damage:{0:"Лёгкий урон",6:"Тяжёлый урон",12:"Точный удар"}},{id:"stone_greathammer",category:"weapon",subcat:"maces",name:"Каменная кувалда",desc:"",length:2,hands:2,price:2,epoch:2,attack:0,defence:0,damageType:"Дробящий",armorPen:1,damage:{0:"Тяжёлый урон",6:"Огромный урон"}},{id:"iron_hammer",category:"weapon",subcat:"maces",name:"Железный молот",desc:"",length:1,hands:1,price:3,epoch:3,attack:3,defence:0,damageType:"Дробящий",armorPen:1,damage:{0:"Лёгкий урон",5:"Тяжёлый урон",10:"Точный удар"}},{id:"iron_greathammer",category:"weapon",subcat:"maces",name:"Железная кувалда",desc:"",length:2,hands:2,price:5,epoch:4,attack:0,defence:0,damageType:"Дробящий",armorPen:1,damage:{0:"Тяжёлый урон",5:"Огромный урон"}},{id:"iron_warhammer",category:"weapon",subcat:"maces",name:"Железный боевой молот",desc:"",length:1,hands:1,price:4,epoch:4,attack:4,defence:0,damageType:"Дробящий",armorPen:2,damage:{0:"Лёгкий урон",6:"Тяжёлый урон",12:"Точный удар"}},{id:"iron_greatwarhammer",category:"weapon",subcat:"maces",name:"Двуручный боевой молот",desc:"",length:2,hands:2,price:6,epoch:5,attack:2,defence:0,damageType:"Дробящий",armorPen:2,damage:{0:"Тяжёлый урон",6:"Огромный урон",12:"Точный удар"}},{id:"steel_warhammer",category:"weapon",subcat:"maces",name:"Стальной боевой молот",desc:"",length:1,hands:1,price:6,epoch:7,attack:5,defence:2,damageType:"Дробящий",armorPen:2,damage:{0:"Лёгкий урон",4:"Тяжёлый урон",8:"Точный удар"}},{id:"steel_greatwarhammer",category:"weapon",subcat:"maces",name:"Длинный стальной боевой молот",desc:"",length:2,hands:2,price:7,epoch:7,attack:3,defence:2,damageType:"Дробящий",armorPen:2,damage:{0:"Тяжёлый урон",4:"Огромный урон",8:"Точный удар"}},{id:"wooden_buckler",category:"shield",subcat:"shields",name:"Деревянный баклер",desc:"",spec:"Баклер может использоваться для атак, как второе оружие.",length:0,hands:.5,price:5,epoch:4,attack:1,defence:{front:{melee:3,ranged:3},side:{melee:3,ranged:0}}},{id:"wooden_shield",category:"shield",subcat:"shields",name:"Деревянный щит",desc:"",spec:"Небольшим щитом можно толкать противника, затратив один порыв.",length:0,hands:1,price:4,epoch:3,attack:1,defence:{front:{melee:6,ranged:6}}},{id:"large_wooden_shield",category:"shield",subcat:"shields",name:"Большой деревянный щит",desc:"",length:0,hands:1,price:5,epoch:3,defence:{front:{melee:6,ranged:9}}},{id:"wooden_tower_shield",category:"shield",subcat:"shields",name:"Деревянный башенный щит",desc:"",length:0,hands:1,price:5,epoch:3,movement:-1,attack:-3,defence:{front:{melee:9,ranged:12}}},{id:"metal_buckler",category:"shield",subcat:"shields",name:"Стальной баклер",desc:"",spec:"Баклер может использоваться для атак, как второе оружие.",length:0,hands:.5,price:6,epoch:6,attack:3,defence:{front:{melee:6,ranged:3},side:{melee:6,ranged:0}}},{id:"metal_shield",category:"shield",subcat:"shields",name:"Стальной щит",desc:"",spec:"Небольшим щитом можно толкать противника, затратив один порыв.",length:0,hands:1,price:7,epoch:6,attack:3,defence:{front:{melee:6,ranged:6}}},{id:"large_metal_shield",category:"shield",subcat:"shields",name:"Большой стальной щит",desc:"",length:0,hands:1,price:5,epoch:7,attack:1,defence:{front:{melee:9,ranged:9}}},{id:"metal_tower_shield",category:"shield",subcat:"shields",name:"Cтальной башенный щит",desc:"",length:0,hands:1,price:7,epoch:7,defence:{front:{melee:12,ranged:12}}},{id:"iron_shortsword",category:"weapon",subcat:"swords",name:"Короткий меч",desc:"",length:1,hands:1,price:4,epoch:3,attack:3,defence:5,damageType:"Режущий",armorPen:0,damage:{0:"Царапина",4:"Лёгкий урон",8:"Точный удар",12:"Тяжёлый урон"}},{id:"iron_sword",category:"weapon",subcat:"swords",name:"Меч пехотинца",desc:"",length:2,hands:1,price:4,epoch:4,attack:5,defence:5,damageType:"Режущий",armorPen:0,damage:{0:"Царапина",3:"Лёгкий урон",6:"Точный удар",10:"Тяжёлый урон"}},{id:"iron_falchion",category:"weapon",subcat:"swords",name:"Фальшион",desc:"",length:1,hands:1,price:4,epoch:4,attack:7,defence:4,damageType:"Режущий",armorPen:0,damage:{0:"Царапина",3:"Лёгкий урон",6:"Точный удар",10:"Тяжёлый урон"}},{id:"iron_greatsword",category:"weapon",subcat:"swords",name:"Двуручный меч",desc:"",length:2,hands:2,price:5,epoch:4,attack:6,defence:3,damageType:"Режущий",armorPen:0,damage:{0:"Лёгкий урон",4:"Тяжёлый урон",8:"Огромный урон"}},{id:"steel_shortsword",category:"weapon",subcat:"swords",name:"Стальной короткий меч",desc:"",length:1,hands:1,price:6,epoch:6,attack:4,defence:5,damageType:"Режущий",armorPen:0,damage:{0:"Царапина",3:"Лёгкий урон",6:"Точный удар",9:"Тяжёлый урон"}},{id:"steel_sword",category:"weapon",subcat:"swords",name:"Стальной меч",desc:"",length:2,hands:1,price:7,epoch:6,attack:6,defence:6,damageType:"Режущий",armorPen:0,damage:{0:"Царапина",2:"Лёгкий урон",4:"Точный удар",8:"Тяжёлый урон"}},{id:"steel_saber",category:"weapon",subcat:"swords",name:"Сабля",desc:"",length:2,hands:1,price:7,epoch:7,attack:8,defence:3,damageType:"Режущий",armorPen:0,damage:{0:"Царапина",3:"Лёгкий урон",6:"Тяжёлый урон",8:"Точный удар"}},{id:"steel_scimitar",category:"weapon",subcat:"swords",name:"Скимитар",desc:"",length:2,hands:1,price:7,epoch:7,attack:9,defence:2,damageType:"Режущий",armorPen:0,damage:{0:"Царапина",3:"Лёгкий урон",6:"Тяжёлый урон",9:"Точный удар"}},{id:"steel_greatsword",category:"weapon",subcat:"swords",name:"Качественный двуручный меч",desc:"",length:2,hands:2,price:7,epoch:6,attack:7,defence:4,damageType:"Режущий",armorPen:0,damage:{0:"Лёгкий урон",4:"Тяжёлый урон",6:"Огромный урон"}},{id:"rapier",category:"weapon",subcat:"swords",name:"Рапира",desc:"",length:2,hands:1.5,price:6,epoch:7,attack:7,defence:3,damageType:"Колющий",armorPen:0,damage:{0:"Царапина",2:"Лёгкий урон",6:"Точный удар",8:"Тяжёлый урон"}},{id:"hand_crossbow",category:"weapon",subcat:"crossbows",name:"Ручной арбалет",desc:"Требует порыва на перезарядку",length:2,hands:1.5,price:5,epoch:5,attack:4,defence:0,damageType:"Колющий",armorPen:0,damage:{0:"Царапина",5:"Лёгкий урон"}},{id:"crossbow",category:"weapon",subcat:"crossbows",name:"Арбалет",desc:"Требуется два порыва или полное основное действие на перезарядку",length:2,hands:2,price:6,epoch:5,attack:6,defence:0,damageType:"Колющий",armorPen:0,damage:{0:"Царапина",4:"Лёгкий урон",6:"Точный удар",8:"Тяжёлый урон"}},{id:"heavy_crossbow",category:"weapon",subcat:"crossbows",name:"Тяжёлый арбалет",desc:"Требуется полное действие и один порыв на перезарядку, в процессе нельзя передвигаться.",length:2,hands:2,price:6,epoch:5,attack:8,defence:0,damageType:"Колющий",armorPen:1,damage:{0:"Царапина",4:"Лёгкий урон",6:"Точный удар",8:"Тяжёлый урон"}},{id:"sling",category:"weapon",subcat:"slings",name:"Простая праща",desc:"",spec:"Нельзя стрелять с порывом",length:2,hands:2,price:2,epoch:2,attack:3,defence:0,damageType:"Дробящий",armorPen:0,damage:{0:"Царапина",3:"Лёгкий урон"}},{id:"heavy_sling",category:"weapon",subcat:"slings",name:"Боевая праща",desc:"",spec:"Нельзя стрелять без порыва",length:2,hands:2,price:4,epoch:3,attack:4,defence:0,damageType:"Дробящий",armorPen:0,damage:{0:"Царапина",3:"Лёгкий урон",9:"Тяжёлый урон"}}],No={systemName:"triP Items",version:"1.0",totalItems:110},bt={items:Fo,metadata:No},Et=(e,t)=>{const n=e.__vccOpts||e;for(const[s,o]of t)n[s]=o;return n},it={3:{name:"Ниже простой",short:"НП",level:1,modifier:"below",color:"#00DDFF",lightText:!1,linetype:"dashed"},6:{name:"Простая",short:"П",level:1,modifier:"base",color:"#00DDFF",lightText:!1,linetype:"single"},9:{name:"Выше простой",short:"ВП",level:1,modifier:"above",color:"#00DDFF",lightText:!1,linetype:"double"},12:{name:"Ниже лёгкой",short:"НЛ",level:2,modifier:"below",color:"#00CC44",lightText:!1,linetype:"dashed"},15:{name:"Лёгкая",short:"Л",level:2,modifier:"base",color:"#00CC44",lightText:!1,linetype:"single"},18:{name:"Выше лёгкой",short:"ВЛ",level:2,modifier:"above",color:"#00CC44",lightText:!1,linetype:"double"},21:{name:"Ниже средней",short:"НС",level:3,modifier:"below",color:"#FFEE00",lightText:!1,linetype:"dashed"},24:{name:"Средняя",short:"С",level:3,modifier:"base",color:"#FFEE00",lightText:!1,linetype:"single"},27:{name:"Выше средней",short:"ВС",level:3,modifier:"above",color:"#FFEE00",lightText:!1,linetype:"double"},30:{name:"Ниже тяжёлой",short:"НТ",level:4,modifier:"below",color:"#FF8800",lightText:!1,linetype:"dashed"},33:{name:"Тяжёлая",short:"Т",level:4,modifier:"base",color:"#FF8800",lightText:!1,linetype:"single"},36:{name:"Выше тяжёлой",short:"ВТ",level:4,modifier:"above",color:"#FF8800",lightText:!1,linetype:"double"},39:{name:"Ниже жестокой",short:"НЖ",level:5,modifier:"below",color:"#CC0000",lightText:!0,linetype:"dashed"},42:{name:"Жестокая",short:"Ж",level:5,modifier:"base",color:"#CC0000",lightText:!0,linetype:"single"},45:{name:"Выше жестокой",short:"ВЖ",level:5,modifier:"above",color:"#CC0000",lightText:!0,linetype:"double"},48:{name:"Ниже кошмарной",short:"НК",level:6,modifier:"below",color:"#440066",lightText:!0,linetype:"dashed"},51:{name:"Кошмарная",short:"К",level:6,modifier:"base",color:"#440066",lightText:!0,linetype:"single"},54:{name:"Выше кошмарной",short:"ВК",level:6,modifier:"above",color:"#440066",lightText:!0,linetype:"double"},60:{name:"Невозможная",short:"Н",level:7,modifier:"base",color:"#000000",lightText:!0,linetype:"single"}},Oo={key:0,class:"hp-display"},zo={key:0,class:"hp-compact"},Bo={class:"hp-text"},jo={key:0,class:"hp-penalty"},Wo={key:1,class:"hp-full"},Ho={class:"hp-header"},Uo={class:"hp-value"},qo={key:0,class:"hp-penalty-badge"},Vo={class:"hp-groups"},Yo=["onClick"],Go={key:1,class:"wounds-display"},Xo={key:0,class:"wounds-compact"},Qo={key:0,class:"wound-healthy"},Ko={key:1,class:"wounds-full"},Jo=["onClick","onContextmenu","onTouchstart","onTouchend"],Zo={class:"wound-header"},ea={class:"wound-icon"},ta={class:"wound-label"},na={class:"wound-slots"},sa={class:"wound-count"},oa=500,aa={__name:"HealthDisplay",props:{combat:{type:Object,required:!0},stats:{type:Object,default:()=>({})},compact:{type:Boolean,default:!1},readonly:{type:Boolean,default:!1}},emits:["update:hp","add-wound","remove-wound","toggle-health-type"],setup(e,{emit:t}){const n=e,s=t,o=H(()=>{var w;return((w=n.combat)==null?void 0:w.healthType)||"simple"}),l=H(()=>{var w;return((w=n.combat)==null?void 0:w.hp)||0}),i=H(()=>{var w;return((w=n.combat)==null?void 0:w.maxHp)||8}),m=H(()=>{const w=[],A=i.value,x=A%3;let $=0;if(x>0){const R=[];for(let W=0;W<x;W++)R.push({index:$,filled:$<l.value}),$++;w.push(R)}for(;$<A;){const R=[];for(let W=0;W<3&&$<A;W++)R.push({index:$,filled:$<l.value}),$++;w.push(R)}return w}),d=H(()=>{const w=i.value-l.value;return Math.floor(w/3)}),c=H(()=>{var w;return((w=n.combat)==null?void 0:w.wounds)||{scratch:0,light:0,heavy:0,deadly:0}}),u=H(()=>{var w;return((w=n.combat)==null?void 0:w.bonusDeadlySlots)||0}),h=H(()=>{const w=rt(n.stats,u.value);return{scratch:{...w.scratch,total:w.scratch.base+w.scratch.bonus,filled:c.value.scratch,label:"Царапины",icon:"🩹",color:"amber"},light:{...w.light,total:w.light.base+w.light.bonus,filled:c.value.light,label:"Лёгкие",icon:"🩸",color:"orange"},heavy:{...w.heavy,total:w.heavy.base+w.heavy.bonus,filled:c.value.heavy,label:"Тяжёлые",icon:"💔",color:"rose"},deadly:{...w.deadly,total:w.deadly.base+w.deadly.bonus,filled:c.value.deadly,label:"Смертельные",icon:"💀",color:"red"}}}),y=["scratch","light","heavy","deadly"],I=w=>{const z=h.value[w],A=[];z.bonus+z.base;const x=z.filled;for(let $=0;$<z.bonus;$++)A.push({index:$,isBonus:!0,filled:$<x});for(let $=0;$<z.base;$++)A.push({index:z.bonus+$,isBonus:!1,filled:z.bonus+$<x});return A};let k=null;const P=w=>{n.readonly||(w<l.value?s("update:hp",l.value-1):s("update:hp",Math.min(i.value,l.value+1)))},C=(w,z)=>{n.readonly||(z.preventDefault(),s("add-wound",w))},N=(w,z)=>{n.readonly||(z.preventDefault(),s("remove-wound",w))},J=(w,z)=>{n.readonly||(k=setTimeout(()=>{s("remove-wound",w),k=null},oa))},X=(w,z)=>{n.readonly||k&&(clearTimeout(k),k=null,s("add-wound",w))};return(w,z)=>(f(),p("div",{class:oe(["health-display",{compact:e.compact}])},[o.value==="simple"?(f(),p("div",Oo,[e.compact?(f(),p("div",zo,[z[0]||(z[0]=r("span",{class:"hp-icon"},"❤️",-1)),r("span",Bo,O(l.value)+"/"+O(i.value),1),d.value>0?(f(),p("span",jo,"-"+O(d.value),1)):M("",!0)])):(f(),p("div",Wo,[r("div",Ho,[z[1]||(z[1]=r("span",{class:"hp-label"},"HP",-1)),r("span",Uo,O(l.value)+"/"+O(i.value),1),d.value>0?(f(),p("span",qo,"штраф: -"+O(d.value),1)):M("",!0)]),r("div",Vo,[(f(!0),p(Y,null,ae(m.value,(A,x)=>(f(),p("div",{key:x,class:"hp-group"},[(f(!0),p(Y,null,ae(A,$=>(f(),p("div",{key:$.index,class:oe(["hp-cell",{filled:$.filled,clickable:!e.readonly}]),onClick:R=>P($.index)},null,10,Yo))),128))]))),128))])]))])):(f(),p("div",Go,[e.compact?(f(),p("div",Xo,[(f(),p(Y,null,ae(y,A=>(f(),p(Y,{key:A},[h.value[A].filled>0?(f(),p("span",{key:0,class:oe(["wound-badge",`wound-${h.value[A].color}`])},O(h.value[A].icon)+" "+O(h.value[A].filled),3)):M("",!0)],64))),64)),Object.values(c.value).every(A=>A===0)?(f(),p("span",Qo," ✓ Здоров ")):M("",!0)])):(f(),p("div",Ko,[(f(),p(Y,null,ae(y,A=>r("div",{key:A,class:oe(["wound-column",[`wound-column-${h.value[A].color}`,`wound-column-${A}`,{clickable:!e.readonly}]]),onClick:x=>C(A,x),onContextmenu:x=>N(A,x),onTouchstart:x=>J(A),onTouchend:x=>X(A)},[r("div",Zo,[r("span",ea,O(h.value[A].icon),1),r("span",ta,O(h.value[A].label),1)]),r("div",na,[(f(!0),p(Y,null,ae(I(A),x=>(f(),p("div",{key:x.index,class:oe(["wound-slot",{filled:x.filled,bonus:x.isBonus}])},null,2))),128))]),r("div",sa,O(h.value[A].filled)+"/"+O(h.value[A].total),1)],42,Jo)),64))]))]))],2))}},Br=Et(aa,[["__scopeId","data-v-2d19fffd"]]),la={class:"portrait-image"},ia=["src","alt"],ra={key:1,class:"portrait-fallback"},ca={key:3,class:"death-overlay"},ua=["viewBox","width","height"],da=["transform"],fa={key:0,class:"melee-defence"},pa=["d"],ha=["d"],ma=["d"],ga=["d"],va=["d"],ba=["d"],ya={key:1,class:"ranged-defence"},xa=["d"],ka=["d"],wa=["d"],_a=["d"],Ta=["d"],Ca=["d"],Sa=["viewBox","width","height"],Pa=["d","stroke"],$a=["cx","cy","r","fill"],Ue=2,Ea={__name:"CharacterPortrait",props:{portrait:{type:String,default:null},name:{type:String,default:""},combat:{type:Object,default:()=>({})},stats:{type:Object,default:()=>({})},meleeDefence:{type:Object,default:null},rangedDefence:{type:Object,default:null},defenceMode:{type:String,default:"all",validator:e=>["all","melee","ranged","none"].includes(e)},defenceLayout:{type:String,default:"left",validator:e=>["left","both"].includes(e)},defenceRotation:{type:Number,default:0},highlightSegment:{type:Object,default:null},showDefence:{type:Boolean,default:!1},size:{type:String,default:"md",validator:e=>["sm","md","lg","xl"].includes(e)},showWounds:{type:Boolean,default:!0}},setup(e){const t=e,n={sm:48,md:80,lg:120,xl:160},s=H(()=>n[t.size]),o=H(()=>{var b;return((b=t.combat)==null?void 0:b.healthType)||"simple"}),l=H(()=>{var b;return((b=t.combat)==null?void 0:b.wounds)||{scratch:0,light:0,heavy:0,deadly:0}}),i=H(()=>{var b;return o.value!=="wounds"?null:rt(t.stats,((b=t.combat)==null?void 0:b.bonusDeadlySlots)||0)}),m=H(()=>{if(!i.value)return[];const b=i.value.scratch.base+i.value.scratch.bonus,_=i.value.scratch.bonus,T=l.value.scratch;if(T===0)return[];const F=10,ie=(360-b*F)/b,Q=180-(T*ie+(T-1)*F)/2,ce=[];for(let se=0;se<T;se++){const le=Q+se*(ie+F);ce.push({index:se,startAngle:le,endAngle:le+ie,filled:!0,isBonus:se<_})}return ce}),d=(b,_,T,F)=>{const q=s.value,ie=q/2,re=q/2,Q=T,ce=(b-90)*Math.PI/180,se=(_-90)*Math.PI/180,le=ie+Q*Math.cos(ce),pe=re+Q*Math.sin(ce),we=ie+Q*Math.cos(se),ve=re+Q*Math.sin(se),Re=_-b>180?1:0;return`M ${le} ${pe} A ${Q} ${Q} 0 ${Re} 1 ${we} ${ve}`},c=H(()=>{if(!i.value)return[];const b=i.value.light.bonus,_=l.value.light;if(_===0)return[];const T=[],F=s.value,q=F*.08,ie=F/2,re=F/2,Q=F/2,ce=25,le=90+(_-1)*ce/2;for(let pe=0;pe<_;pe++){const ve=(le-pe*ce)*Math.PI/180;T.push({index:pe,cx:re+ie*Math.cos(ve),cy:Q+ie*Math.sin(ve),r:q,filled:!0,isBonus:pe<b})}return T}),u=H(()=>{if(!i.value)return 0;const b=i.value.heavy.base+i.value.heavy.bonus,_=l.value.heavy;return b===0||_===0?0:_/b*70}),h=H(()=>{if(!i.value)return 0;const b=i.value.deadly.base+i.value.deadly.bonus,_=l.value.deadly;return b===0?0:_/b}),y=H(()=>h.value>0),I=H(()=>h.value>=1),k=H(()=>{var T,F;if(o.value!=="simple")return 100;const b=((T=t.combat)==null?void 0:T.hp)||0,_=((F=t.combat)==null?void 0:F.maxHp)||1;return b/_*100}),P=H(()=>Math.max(0,100-k.value)*.7),C=H(()=>{var b,_;return((_=(b=t.name)==null?void 0:b.charAt(0))==null?void 0:_.toUpperCase())||"?"}),N=b=>{const _=Object.entries(it.default||it).map(([F,q])=>({value:parseInt(F),...q})).filter(F=>F.value>=0).sort((F,q)=>F.value-q.value);let T=_[0];for(const F of _)if(F.value<=b)T=F;else break;return T},J=b=>{if(!t.meleeDefence)return null;const _=t.meleeDefence[b];return _==null?null:N(_)},X=b=>{if(!t.rangedDefence)return null;const _=t.rangedDefence[b];return _==null?null:N(_)},w=H(()=>!t.showDefence||!t.meleeDefence||t.defenceMode==="none"||t.defenceMode==="ranged"?null:{front:J("front"),flank:J("flank"),back:J("back")}),z=H(()=>!t.showDefence||!t.rangedDefence||t.defenceMode==="none"||t.defenceMode==="melee"?null:{front:X("front"),flank:X("flank"),back:X("back")}),A=(b,_)=>t.highlightSegment?t.highlightSegment.type===b&&t.highlightSegment.direction===_:!1,x=H(()=>t.highlightSegment!==null),$=H(()=>{if(t.defenceRotation===0)return"";const b=s.value,_=D.value,T=b/2+_,F=b/2+_;return`rotate(${t.defenceRotation} ${T} ${F})`}),R=(b,_=0)=>{const T=s.value,F=D.value,q=T/2+F,ie=T/2+F,re=T/2+14+_,Q=we=>{const ve=(we-90)*Math.PI/180;return{x:q+re*Math.cos(ve),y:ie+re*Math.sin(ve)}},ce=Q(0),se=Q(180),le=Q(240),pe=Q(300);return b==="front"?`M ${ce.x} ${ce.y} L ${pe.x} ${pe.y}`:b==="flank"?`M ${pe.x} ${pe.y} L ${le.x} ${le.y}`:b==="back"?`M ${le.x} ${le.y} L ${se.x} ${se.y}`:""},W=(b,_=0,T="left")=>{const F=s.value,q=D.value,ie=F/2+q,re=F/2+q,ce=F/2+14+8+_;let se,le;if(T==="left")if(b==="front")se=300,le=360;else if(b==="flank")se=240,le=300;else if(b==="back")se=180,le=240;else return"";else if(b==="front")se=0,le=60;else if(b==="flank")se=60,le=120;else if(b==="back")se=120,le=180;else return"";const pe=(se-90)*Math.PI/180,we=(le-90)*Math.PI/180,ve=ie+ce*Math.cos(pe),Re=re+ce*Math.sin(pe),Pe=ie+ce*Math.cos(we),Ne=re+ce*Math.sin(we);return`M ${ve} ${Re} A ${ce} ${ce} 0 0 1 ${Pe} ${Ne}`},ue=b=>{if(!b)return{};const _=b.linetype||"single",F={stroke:b.color||"#FFFFFF","stroke-width":2,fill:"none","stroke-linecap":"butt"};return _==="dashed"?{...F,"stroke-dasharray":"4 3"}:F},U=b=>!b||b.linetype!=="double"?null:{stroke:b.color||"#FFFFFF","stroke-width":2,fill:"none","stroke-linecap":"butt","stroke-dasharray":"4 3"},D=H(()=>t.showDefence?28:0),fe=H(()=>s.value+D.value*2);return(b,_)=>(f(),p("div",{class:oe(["character-portrait",[`size-${e.size}`,{dying:y.value,dead:I.value,"with-defence":e.showDefence}]]),style:Se({width:`${fe.value}px`,height:`${fe.value}px`})},[r("div",{class:"portrait-container",style:Se({width:`${s.value}px`,height:`${s.value}px`,position:"absolute",top:`${D.value}px`,left:`${D.value}px`})},[r("div",la,[e.portrait?(f(),p("img",{key:0,src:E(Is)(e.portrait),alt:e.name,class:"portrait-img",onError:_[0]||(_[0]=T=>T.target.style.display="none")},null,40,ia)):(f(),p("div",ra,O(C.value),1))]),e.showWounds&&o.value==="wounds"&&u.value>0?(f(),p("div",{key:0,class:"heavy-overlay",style:Se({height:`${u.value}%`})},null,4)):M("",!0),e.showWounds&&o.value==="simple"&&P.value>0?(f(),p("div",{key:1,class:"hp-damage-overlay",style:Se({height:`${P.value}%`})},null,4)):M("",!0),e.showWounds&&y.value?(f(),p("div",{key:2,class:"deadly-overlay",style:Se({opacity:h.value*.8})},null,4)):M("",!0),I.value?(f(),p("div",ca,[..._[1]||(_[1]=[r("span",{class:"death-icon"},"💀",-1)])])):M("",!0)],4),e.showDefence&&(w.value||z.value)?(f(),p("svg",{key:0,class:"defence-overlay",viewBox:`0 0 ${fe.value} ${fe.value}`,width:fe.value,height:fe.value,style:{position:"absolute",top:"0",left:"0"}},[r("g",{transform:$.value},[w.value?(f(),p("g",fa,[!x.value||A("melee","front")?(f(),p(Y,{key:0},[w.value.front?(f(),p("path",Ce({key:0,d:R("front",0)},ue(w.value.front)),null,16,pa)):M("",!0),U(w.value.front)?(f(),p("path",Ce({key:1,d:R("front",Ue)},U(w.value.front)),null,16,ha)):M("",!0)],64)):M("",!0),!x.value||A("melee","flank")?(f(),p(Y,{key:1},[w.value.flank?(f(),p("path",Ce({key:0,d:R("flank",0)},ue(w.value.flank)),null,16,ma)):M("",!0),U(w.value.flank)?(f(),p("path",Ce({key:1,d:R("flank",Ue)},U(w.value.flank)),null,16,ga)):M("",!0)],64)):M("",!0),!x.value||A("melee","back")?(f(),p(Y,{key:2},[w.value.back?(f(),p("path",Ce({key:0,d:R("back",0)},ue(w.value.back)),null,16,va)):M("",!0),U(w.value.back)?(f(),p("path",Ce({key:1,d:R("back",Ue)},U(w.value.back)),null,16,ba)):M("",!0)],64)):M("",!0)])):M("",!0),z.value?(f(),p("g",ya,[!x.value||A("ranged","front")?(f(),p(Y,{key:0},[z.value.front?(f(),p("path",Ce({key:0,d:W("front",0,e.defenceLayout)},ue(z.value.front)),null,16,xa)):M("",!0),U(z.value.front)?(f(),p("path",Ce({key:1,d:W("front",Ue,e.defenceLayout)},U(z.value.front)),null,16,ka)):M("",!0)],64)):M("",!0),!x.value||A("ranged","flank")?(f(),p(Y,{key:1},[z.value.flank?(f(),p("path",Ce({key:0,d:W("flank",0,e.defenceLayout)},ue(z.value.flank)),null,16,wa)):M("",!0),U(z.value.flank)?(f(),p("path",Ce({key:1,d:W("flank",Ue,e.defenceLayout)},U(z.value.flank)),null,16,_a)):M("",!0)],64)):M("",!0),!x.value||A("ranged","back")?(f(),p(Y,{key:2},[z.value.back?(f(),p("path",Ce({key:0,d:W("back",0,e.defenceLayout)},ue(z.value.back)),null,16,Ta)):M("",!0),U(z.value.back)?(f(),p("path",Ce({key:1,d:W("back",Ue,e.defenceLayout)},U(z.value.back)),null,16,Ca)):M("",!0)],64)):M("",!0)])):M("",!0)],8,da)],8,ua)):M("",!0),e.showWounds?(f(),p("svg",{key:1,class:"wounds-overlay",viewBox:`0 0 ${s.value} ${s.value}`,width:s.value,height:s.value,style:Se({position:"absolute",top:e.showDefence?`${D.value}px`:"0",left:e.showDefence?`${D.value}px`:"0",overflow:"visible"})},[(f(!0),p(Y,null,ae(m.value,T=>(f(),p("path",{key:`scratch-${T.index}`,d:d(T.startAngle,T.endAngle,s.value/2-3),fill:"none",stroke:T.isBonus?"#a855f7":"#fbbf24","stroke-width":"3","stroke-linecap":"round",class:"scratch-arc filled"},null,8,Pa))),128)),(f(!0),p(Y,null,ae(c.value,T=>(f(),p("circle",{key:`light-${T.index}`,cx:T.cx,cy:T.cy,r:T.r,fill:T.isBonus?"#a855f7":"#ef4444",stroke:"#1f2937","stroke-width":"1.5",class:"light-dot filled"},null,8,$a))),128))],12,Sa)):M("",!0)],6))}},jr=Et(Ea,[["__scopeId","data-v-4eba6bfd"]]),An={};Ro.aspects.forEach(e=>{An[e.id]=e});const Aa=e=>An[e]||null,Ia=e=>{var i,m,d,c,u,h;const t=(e==null?void 0:e.stats)||{},n=((i=e==null?void 0:e.combat)==null?void 0:i.wounds)||(e==null?void 0:e.wounds)||{};if(!n.scratch&&!n.light&&!n.heavy&&!n.deadly)return 0;const s={scratch:{current:typeof n.scratch=="number"?n.scratch:((m=n.scratch)==null?void 0:m.current)||0},light:{current:typeof n.light=="number"?n.light:((d=n.light)==null?void 0:d.current)||0},heavy:{current:typeof n.heavy=="number"?n.heavy:((c=n.heavy)==null?void 0:c.current)||0},deadly:{current:typeof n.deadly=="number"?n.deadly:((u=n.deadly)==null?void 0:u.current)||0}},o=((h=e==null?void 0:e.combat)==null?void 0:h.bonusDeadlySlots)||0,l=rt(t,o);return-ms(s,l)},Ma=e=>{let t=0;return t-=Ia(e),t},Da=(e,t)=>{const n=Aa(t);if(!n)return 0;const s=(e==null?void 0:e.stats)||{},o=s[t]||0,l=n.neighbors||[],i=s[l[0]]||0,m=s[l[1]]||0,d=s[n.opposite]||0,c=Math.floor(o+i/2+m/2),u=Math.floor(d/2),h=Math.max(c,u),y=Ma(e);return h+y},At={};Object.keys(bt).forEach(e=>{Array.isArray(bt[e])&&bt[e].forEach(t=>{At[t.id]=t})});const La=e=>Da(e,"shadow"),Ra=e=>{var n;const t=(n=e==null?void 0:e.equipment)==null?void 0:n.armor;return t&&At[t]||null},Fa=(e,t,n)=>{var m,d;const s=((m=e==null?void 0:e.equipment)==null?void 0:m.activeSetIndex)??0,l=(((d=e==null?void 0:e.equipment)==null?void 0:d.weaponSets)||[])[s];if(!l||!l.weapons)return 0;let i=0;for(const c of l.weapons){const u=At[c];u&&(u.type==="shield"&&t==="front"&&(n==="melee"?i+=u.defenceMelee||0:n==="ranged"&&(i+=u.defenceRanged||0)),u.parry&&t==="front"&&n==="melee"&&(i+=u.parry||0))}return i},yt=(e,t,n)=>{const s=La(e),o=Math.floor(s/2),l=Ra(e),i=(l==null?void 0:l.defence)||0,m=Fa(e,t,n);let d=0,c=0;return t==="front"?(d=6,c=s):t==="flank"?(d=3,c=o):t==="back"&&(d=0,c=o),Math.max(0,d+c+i+m)},un=(e,t)=>({front:yt(e,"front",t),flank:yt(e,"flank",t),back:yt(e,"back",t)}),Na=[{id:"plains",name:"Равнина",color:"#8BC34A"},{id:"forest",name:"Лес",color:"#2E7D32"},{id:"desert",name:"Пустыня",color:"#FDD835"},{id:"swamp",name:"Болото",color:"#5D4037"},{id:"mountain",name:"Горы",color:"#78909C"},{id:"water",name:"Вода",color:"#1E88E5"},{id:"snow",name:"Снег",color:"#ECEFF1"},{id:"volcanic",name:"Вулкан",color:"#BF360C"},{id:"urban",name:"Город",color:"#616161"},{id:"underground",name:"Подземелье",color:"#37474F"}],Oa=[{id:"open",name:"Открытая",description:"Полностью просматривается",value:0},{id:"partial",name:"Частичная",description:"Маскирует (высокая трава, кусты)",value:1},{id:"blocking",name:"Блокирующая",description:"Блокирует обзор (стена, скала)",value:2}],za=[{id:"grass",name:"Трава",description:"Обычный луг",biome:"plains",color:"#4CAF50",image:null,visibility:"open",movementCost:1,meleeAdvantage:0,tags:["природа","базовый"]},{id:"tall_grass",name:"Высокая трава",description:"Высокая трава, скрывающая присевших",biome:"plains",color:"#7CB342",image:null,visibility:"partial",movementCost:1,meleeAdvantage:0,tags:["природа","укрытие"]},{id:"forest_light",name:"Редколесье",description:"Редкие деревья и кустарники",biome:"forest",color:"#66BB6A",image:null,visibility:"partial",movementCost:2,meleeAdvantage:0,tags:["природа","лес","укрытие"]},{id:"forest_dense",name:"Густой лес",description:"Плотный лес с густым подлеском",biome:"forest",color:"#2E7D32",image:null,visibility:"blocking",movementCost:3,meleeAdvantage:-1,tags:["природа","лес","труднопроходимый"]},{id:"sand",name:"Песок",description:"Рыхлый песок",biome:"desert",color:"#FFD54F",image:null,visibility:"open",movementCost:2,meleeAdvantage:-1,tags:["природа","пустыня"]},{id:"dunes",name:"Дюны",description:"Песчаные холмы",biome:"desert",color:"#FFC107",image:null,visibility:"partial",movementCost:3,meleeAdvantage:1,tags:["природа","пустыня","возвышенность"]},{id:"shallow_water",name:"Мелководье",description:"Неглубокая вода по колено",biome:"water",color:"#4FC3F7",image:null,visibility:"open",movementCost:2,meleeAdvantage:-1,tags:["вода"]},{id:"deep_water",name:"Глубокая вода",description:"Глубокая вода, нужно плыть",biome:"water",color:"#1565C0",image:null,visibility:"open",movementCost:4,meleeAdvantage:-2,tags:["вода","опасность"]},{id:"swamp",name:"Болото",description:"Топкое болото",biome:"swamp",color:"#6D4C41",image:null,visibility:"partial",movementCost:3,meleeAdvantage:-1,tags:["природа","болото","опасность"]},{id:"rocks",name:"Камни",description:"Каменистая местность",biome:"mountain",color:"#90A4AE",image:null,visibility:"partial",movementCost:2,meleeAdvantage:0,tags:["природа","горы"]},{id:"cliff",name:"Утёс",description:"Крутой обрыв или возвышенность",biome:"mountain",color:"#607D8B",image:null,visibility:"blocking",movementCost:5,meleeAdvantage:2,tags:["природа","горы","возвышенность"]},{id:"snow",name:"Снег",description:"Заснеженная местность",biome:"snow",color:"#ECEFF1",image:null,visibility:"open",movementCost:2,meleeAdvantage:-1,tags:["природа","холод"]},{id:"ice",name:"Лёд",description:"Скользкий лёд",biome:"snow",color:"#B3E5FC",image:null,visibility:"open",movementCost:1,meleeAdvantage:-2,tags:["природа","холод","опасность"]},{id:"lava",name:"Лава",description:"Раскалённая лава",biome:"volcanic",color:"#FF5722",image:null,visibility:"open",movementCost:5,meleeAdvantage:-2,tags:["опасность","огонь"]},{id:"volcanic_rock",name:"Вулканический камень",description:"Застывшая лава",biome:"volcanic",color:"#3E2723",image:null,visibility:"open",movementCost:2,meleeAdvantage:0,tags:["природа","горы"]},{id:"road_dirt",name:"Грунтовая дорога",description:"Утоптанная тропа",biome:"plains",color:"#A1887F",image:null,visibility:"open",movementCost:1,meleeAdvantage:0,tags:["дорога"]},{id:"road_stone",name:"Каменная дорога",description:"Мощёная дорога",biome:"urban",color:"#9E9E9E",image:null,visibility:"open",movementCost:1,meleeAdvantage:0,tags:["дорога","город"]},{id:"floor_wood",name:"Деревянный пол",description:"Деревянный настил",biome:"urban",color:"#8D6E63",image:null,visibility:"open",movementCost:1,meleeAdvantage:0,tags:["город","здание"]},{id:"floor_stone",name:"Каменный пол",description:"Каменные плиты",biome:"urban",color:"#757575",image:null,visibility:"open",movementCost:1,meleeAdvantage:0,tags:["город","здание"]},{id:"wall",name:"Стена",description:"Непроходимая стена",biome:"urban",color:"#424242",image:null,visibility:"blocking",movementCost:5,meleeAdvantage:0,tags:["город","здание","преграда"]},{id:"dungeon_floor",name:"Пол подземелья",description:"Холодный каменный пол",biome:"underground",color:"#455A64",image:null,visibility:"open",movementCost:1,meleeAdvantage:0,tags:["подземелье"]},{id:"dungeon_wall",name:"Стена подземелья",description:"Массивная каменная стена",biome:"underground",color:"#263238",image:null,visibility:"blocking",movementCost:5,meleeAdvantage:0,tags:["подземелье","преграда"]},{id:"void",name:"Пустота",description:"Пустое пространство",biome:"underground",color:"#0D1117",image:null,visibility:"blocking",movementCost:5,meleeAdvantage:0,tags:["специальный"]}],xt={biomes:Na,visibility:Oa,terrains:za},In=ds("terrain",()=>{const e=j(xt.terrains),t=j([]),n=j(xt.biomes),s=j(xt.visibility),o=j(new Map),l=j({search:"",biome:null,visibility:null,movementCostMin:1,movementCostMax:5,meleeAdvantageMin:-2,meleeAdvantageMax:2,tags:[]}),i=H(()=>[...e.value,...t.value]),m=H(()=>{const x=new Set;return i.value.forEach($=>{var R;(R=$.tags)==null||R.forEach(W=>x.add(W))}),Array.from(x).sort()}),d=H(()=>i.value.filter(x=>{var $;if(l.value.search){const R=l.value.search.toLowerCase(),W=x.name.toLowerCase().includes(R),ue=($=x.description)==null?void 0:$.toLowerCase().includes(R);if(!W&&!ue)return!1}if(l.value.biome&&x.biome!==l.value.biome||l.value.visibility&&x.visibility!==l.value.visibility||x.movementCost<l.value.movementCostMin||x.movementCost>l.value.movementCostMax||x.meleeAdvantage<l.value.meleeAdvantageMin||x.meleeAdvantage>l.value.meleeAdvantageMax)return!1;if(l.value.tags.length>0){const R=new Set(x.tags||[]);if(!l.value.tags.every(ue=>R.has(ue)))return!1}return!0})),c=H(()=>{const x={};return n.value.forEach($=>{x[$.id]={biome:$,terrains:d.value.filter(R=>R.biome===$.id)}}),x});function u(x){return i.value.find($=>$.id===x)||null}function h(x={}){const{biome:$=null,visibility:R=null,passabilityMin:W=0,passabilityMax:ue=5,meleeAdvantageMin:U=-2,meleeAdvantageMax:D=2,search:fe="",tags:b=[]}=x;return i.value.filter(_=>{var q;if(fe){const ie=fe.toLowerCase(),re=_.name.toLowerCase().includes(ie),Q=(q=_.description)==null?void 0:q.toLowerCase().includes(ie);if(!re&&!Q)return!1}if($&&_.biome!==$||R&&_.visibility!==R)return!1;const T=_.movementCost??1;if(T<W||T>ue)return!1;const F=_.meleeAdvantage??0;if(F<U||F>D)return!1;if(b.length>0){const ie=new Set(_.tags||[]);if(!b.every(re=>ie.has(re)))return!1}return!0})}function y(x){return n.value.find($=>$.id===x)||null}function I(x){const $=u(x);if(!$)return"#888888";if($.color)return $.color;const R=y($.biome);return(R==null?void 0:R.color)||"#888888"}function k(x){const $=u(x);return($==null?void 0:$.image)||null}async function P(x){return o.value.has(x)?o.value.get(x):new Promise(($,R)=>{const W=new Image;W.onload=()=>{o.value.set(x,W),$(W)},W.onerror=R,W.src=x})}function C(x){const R={id:`custom_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,name:x.name||"Новый террейн",description:x.description||"",biome:x.biome||"plains",color:x.color||"#888888",image:x.image||null,visibility:x.visibility||"open",movementCost:Math.max(1,Math.min(5,x.movementCost||1)),meleeAdvantage:Math.max(-2,Math.min(2,x.meleeAdvantage||0)),tags:x.tags||[],isCustom:!0,createdAt:Date.now()};return t.value.push(R),R}function N(x,$){const R=t.value.findIndex(W=>W.id===x);return R===-1?!1:(t.value[R]={...t.value[R],...$,updatedAt:Date.now()},!0)}function J(x){const $=t.value.findIndex(R=>R.id===x);return $===-1?!1:(t.value.splice($,1),!0)}function X(x){l.value={...l.value,...x}}function w(){l.value={search:"",biome:null,visibility:null,movementCostMin:1,movementCostMax:5,meleeAdvantageMin:-2,meleeAdvantageMax:2,tags:[]}}function z(){return JSON.stringify(t.value,null,2)}function A(x){try{const $=JSON.parse(x);if(!Array.isArray($))throw new Error("Invalid format");return $.forEach(R=>{C(R)}),!0}catch($){return console.error("Failed to import terrains:",$),!1}}return{baseTerrains:e,customTerrains:t,biomes:n,visibilityTypes:s,imageCache:o,filters:l,allTerrains:i,allTags:m,filteredTerrains:d,terrainsByBiome:c,getTerrainById:u,getFilteredTerrains:h,getBiomeById:y,getTerrainColor:I,getTerrainImage:k,loadImage:P,addCustomTerrain:C,updateCustomTerrain:N,removeCustomTerrain:J,setFilters:X,resetFilters:w,exportCustomTerrains:z,importCustomTerrains:A}},{persist:{key:"trip-terrains",paths:["customTerrains"]}});class Ba{constructor(t=null){this.seed=t??Date.now(),this.current=this.seed}next(){return this.current=this.current*1103515245+12345&2147483647,this.current/2147483647}nextInt(t,n){return Math.floor(this.next()*(n-t+1))+t}shuffle(t){const n=[...t];for(let s=n.length-1;s>0;s--){const o=this.nextInt(0,s);[n[s],n[o]]=[n[o],n[s]]}return n}}function ja(e,t){return[{q:e+1,r:t},{q:e+1,r:t-1},{q:e,r:t-1},{q:e-1,r:t},{q:e-1,r:t+1},{q:e,r:t+1}]}function Wa(e){const[t,n]=e.split(",").map(Number);return{q:t,r:n}}function Ha(e,t){return`${e},${t}`}function Ua(e,t,n){if(!e||e.type===ge.NONE)return!0;const{type:s,operator:o,value:l,minValue:i,maxValue:m}=e;let d;switch(s){case ge.TERRAIN_ID:d=t==null?void 0:t.id;break;case ge.TERRAIN_BIOME:d=t==null?void 0:t.biome;break;case ge.VISIBILITY:d=t==null?void 0:t.visibility;break;case ge.MOVEMENT_COST:d=(t==null?void 0:t.movementCost)??1;break;case ge.MELEE_ADVANTAGE:d=(t==null?void 0:t.meleeAdvantage)??0;break;case ge.TAG:d=(t==null?void 0:t.tags)||[];break;case ge.RANDOM:return!0;default:return!0}switch(o){case ke.EQUALS:return d===l;case ke.NOT_EQUALS:return d!==l;case ke.GREATER:return d>l;case ke.GREATER_EQUALS:return d>=l;case ke.LESS:return d<l;case ke.LESS_EQUALS:return d<=l;case ke.CONTAINS:return Array.isArray(d)?d.includes(l):String(d).includes(String(l));default:return!0}}function qa(e,t,n){return!e.conditions||e.conditions.length===0?!0:e.conditions.every(s=>Ua(s,t))}function Va(e,t,n,s){if(e.length===0)return new Set;const o=Math.round(e.length*(t/100));if(o===0)return new Set;const l=new Set,i=new Set(e),m=n/100,d=Math.max(1,Math.round(o*(1-m*.8))),c=s.shuffle([...i]);for(c.slice(0,Math.min(d,c.length)).forEach(h=>{l.add(h),i.delete(h)});l.size<o&&i.size>0;)if(s.next()<m){const y=[...l],I=s.shuffle(y);let k=!1;for(const P of I){const{q:C,r:N}=Wa(P),J=ja(C,N),X=s.shuffle(J);for(const w of X){const z=Ha(w.q,w.r);if(i.has(z)){l.add(z),i.delete(z),k=!0;break}}if(k)break}if(!k&&i.size>0){const P=s.shuffle([...i])[0];l.add(P),i.delete(P)}}else{const y=s.shuffle([...i])[0];l.add(y),i.delete(y)}return l}function Mn(e,t,n,s={}){const{previewOnly:o=!1,customSeed:l=null}=s;if(!e||!t||t.length===0)return new Map;const i=l??e.seed??Date.now(),m=new Ba(i),d=new Map;for(const u of t)d.set(u,e.baseTerrain);const c=[...e.layers].filter(u=>u.enabled&&u.terrainId).sort((u,h)=>u.priority-h.priority);for(const u of c){const h=[];for(const I of t){const k=d.get(I),P=n.getTerrainById(k);qa(u,P)&&h.push(I)}const y=Va(h,u.density,u.clustering,m);for(const I of y)d.set(I,u.terrainId)}return d}function Ya(e,t){const n={total:e.size,byTerrain:{}};return e.forEach((s,o)=>{if(!n.byTerrain[s]){const l=t.getTerrainById(s);n.byTerrain[s]={id:s,name:(l==null?void 0:l.name)||s,count:0,percent:0}}n.byTerrain[s].count++}),Object.values(n.byTerrain).forEach(s=>{s.percent=Math.round(s.count/n.total*100)}),n}function Ga(e,t,n,s=null){return Mn(e,t,n,{previewOnly:!0,customSeed:s??Date.now()})}const Ze=new Map,Dn=e=>e==null?null:typeof e=="number"?Le(`/images/presets/${e}.png`):typeof e!="string"?Le(`/images/presets/${String(e)}.png`):e.startsWith("http://")||e.startsWith("https://")||e.startsWith("data:")||e.startsWith("blob:")?e:e.startsWith("/")?Le(e):Le(`/images/presets/${e}.png`),Xa=e=>e?Ze.has(e)?Promise.resolve(Ze.get(e)):new Promise((t,n)=>{const s=new Image;!e.startsWith("data:")&&!e.startsWith("blob:")&&(s.crossOrigin="anonymous"),s.onload=()=>{Ze.set(e,s),t(s)},s.onerror=o=>{console.warn("Failed to load image:",e,o),t(null)},s.src=e}):Promise.resolve(null),Qa=async e=>{const t=e.filter(n=>{var s;return(s=n.character)==null?void 0:s.portrait}).map(n=>{const s=Dn(n.character.portrait);return Xa(s).catch(()=>null)});await Promise.all(t)},dn=e=>{const t=Object.entries(it.default||it).map(([s,o])=>({value:parseInt(s),...o})).filter(s=>s.value>=0).sort((s,o)=>s.value-o.value);let n=t[0];for(const s of t)if(s.value<=e)n=s;else break;return n},De=(e,t,n,s)=>{const o=(s-90)*Math.PI/180;return{x:e+n*Math.cos(o),y:t+n*Math.sin(o)}},Ka=(e,t,n,s,o,l,i,m)=>{var c;e.save();const d=Dn(o);if(e.beginPath(),e.arc(t,n,s,0,Math.PI*2),e.clip(),e.fillStyle="#1e293b",e.fill(),d&&Ze.has(d)){const u=Ze.get(d),h=u.width/u.height;let y,I,k,P;h>1?(I=s*2,y=I*h,k=t-y/2,P=n-s):(y=s*2,I=y/h,k=t-s,P=n-I/2),e.drawImage(u,k,P,y,I)}else e.fillStyle="#64748b",e.font=`bold ${s}px sans-serif`,e.textAlign="center",e.textBaseline="middle",e.fillText(((c=l==null?void 0:l.charAt(0))==null?void 0:c.toUpperCase())||"?",t,n);if(i&&m&&i.heavy>0){const u=m.heavy.base+m.heavy.bonus,h=i.heavy/u*.7,y=e.createLinearGradient(t,n+s,t,n-s);y.addColorStop(0,"rgba(220, 38, 38, 0.8)"),y.addColorStop(h,"rgba(220, 38, 38, 0.4)"),y.addColorStop(h+.01,"transparent"),e.fillStyle=y,e.fillRect(t-s,n-s,s*2,s*2)}if(i&&m&&i.deadly>0){const u=m.deadly.base+m.deadly.bonus,h=i.deadly/u;if(h>=1)e.fillStyle="rgba(0, 0, 0, 0.7)",e.fillRect(t-s,n-s,s*2,s*2);else{const y=e.createRadialGradient(t,n,0,t,n,s);y.addColorStop(0,"transparent"),y.addColorStop(.7,"transparent"),y.addColorStop(1,`rgba(220, 38, 38, ${.3+h*.5})`),e.fillStyle=y,e.fillRect(t-s,n-s,s*2,s*2)}}e.restore(),e.beginPath(),e.arc(t,n,s,0,Math.PI*2),e.strokeStyle="rgba(255, 255, 255, 0.3)",e.lineWidth=2,e.stroke()},Ja=(e,t,n,s,o,l)=>{if(!o||!l||o.scratch===0)return;const i=l.scratch.base+l.scratch.bonus,m=o.scratch,d=10,c=(360-i*d)/i,h=180-(m*c+(m-1)*d)/2,y=s+4;e.strokeStyle="#fbbf24",e.lineWidth=2,e.lineCap="round";for(let I=0;I<m;I++){const k=h+I*(c+d),P=(k-90)*Math.PI/180,C=(k+c-90)*Math.PI/180;e.beginPath(),e.arc(t,n,y,P,C),e.stroke()}},Za=(e,t,n,s,o,l)=>{if(!o||!l||o.light===0)return;const i=o.light,m=25,d=s*.1,u=90+(i-1)*m/2;e.fillStyle="#dc2626";for(let h=0;h<i;h++){const I=(u-h*m)*Math.PI/180;e.beginPath(),e.arc(t+s*Math.cos(I),n+s*Math.sin(I),d,0,Math.PI*2),e.fill()}},fn=(e,t,n,s,o,l,i=0,m="left")=>{if(!l)return;const d=l.color||"#FFFFFF",c=l.linetype||"single";let u;m==="left"?u={top:0,upper:300,lower:240,bottom:180}:u={top:0,upper:60,lower:120,bottom:180};const h=De(t,n,s,u.top+i),y=De(t,n,s,u.upper+i),I=De(t,n,s,u.lower+i),k=De(t,n,s,u.bottom+i);let P,C;if(o==="front")P=h,C=y;else if(o==="flank")P=y,C=I;else if(o==="back")P=I,C=k;else return;if(e.lineCap="butt",e.strokeStyle=d,c==="dashed")e.setLineDash([4,5]),e.lineWidth=1.5,e.beginPath(),e.moveTo(P.x,P.y),e.lineTo(C.x,C.y),e.stroke(),e.setLineDash([]);else if(c==="double"){e.lineWidth=1.5,e.beginPath(),e.moveTo(P.x,P.y),e.lineTo(C.x,C.y),e.stroke();const N=s+1.5,J=De(t,n,N,(o==="front"?u.top:o==="flank"?u.upper:u.lower)+i),X=De(t,n,N,(o==="front"?u.upper:o==="flank"?u.lower:u.bottom)+i);e.setLineDash([4,5]),e.lineWidth=1.5,e.beginPath(),e.moveTo(J.x,J.y),e.lineTo(X.x,X.y),e.stroke(),e.setLineDash([])}else e.lineWidth=1.5,e.beginPath(),e.moveTo(P.x,P.y),e.lineTo(C.x,C.y),e.stroke()},pn=(e,t,n,s,o,l,i=0,m="left")=>{if(!l)return;const d=l.color||"#FFFFFF",c=l.linetype||"single";let u,h;if(m==="left")if(o==="front")u=300,h=360;else if(o==="flank")u=240,h=300;else if(o==="back")u=180,h=240;else return;else if(o==="front")u=0,h=60;else if(o==="flank")u=60,h=120;else if(o==="back")u=120,h=180;else return;u+=i,h+=i;const y=(u-90)*Math.PI/180,I=(h-90)*Math.PI/180;e.lineCap="butt",e.strokeStyle=d,c==="dashed"?(e.setLineDash([4,5]),e.lineWidth=1.5,e.beginPath(),e.arc(t,n,s,y,I),e.stroke(),e.setLineDash([])):c==="double"?(e.lineWidth=1.5,e.beginPath(),e.arc(t,n,s,y,I),e.stroke(),e.setLineDash([4,5]),e.lineWidth=1.5,e.beginPath(),e.arc(t,n,s+1.5,y,I),e.stroke(),e.setLineDash([])):(e.lineWidth=1.5,e.beginPath(),e.arc(t,n,s,y,I),e.stroke())},el=(e,t,n,s,o,l,i=0,m={})=>{const{bothSides:d=!1}=m,c=s+14,u=c+6;if(o)for(const h of["front","flank","back"]){const y=o[h];if(y!=null){const I=dn(y);fn(e,t,n,c,h,I,i,"left"),d&&fn(e,t,n,c,h,I,i,"right")}}if(l)for(const h of["front","flank","back"]){const y=l[h];if(y!=null){const I=dn(y);pn(e,t,n,u,h,I,i,"left"),d&&pn(e,t,n,u,h,I,i,"right")}}},tl=(e,t,n,s,o=0)=>{const l=De(t,n,s+8,o),i=De(t,n,s,o-15),m=De(t,n,s,o+15);e.beginPath(),e.moveTo(l.x,l.y),e.lineTo(i.x,i.y),e.lineTo(m.x,m.y),e.closePath(),e.fillStyle="rgba(250, 204, 21, 0.9)",e.fill(),e.strokeStyle="rgba(0, 0, 0, 0.5)",e.lineWidth=1,e.stroke()},nl=(e,t,n={})=>{var A,x;const{tokenSize:s=48,showDefence:o=!1,showFacing:l=!0,isHovered:i=!1,isSelected:m=!1,canSeeDefence:d=!1}=n,{character:c,pixelX:u,pixelY:h,facing:y=0,meleeDefence:I,rangedDefence:k}=t;if(!c)return;const P=u,C=h,N=s/2,J=y*60,X=(A=c.combat)==null?void 0:A.wounds,w=c.woundSlots||(c.stats?rt(c.stats,((x=c.combat)==null?void 0:x.bonusDeadlySlots)||0):null),z=(i||m)&&d&&(I||k);if(z&&sl(e,P,C,N,J,m,i),Ka(e,P,C,N,c.portrait,c.name,X,w),X&&w&&(Ja(e,P,C,N,X,w),Za(e,P,C,N,X,w)),z&&el(e,P,C,N,I,k,J,{bothSides:!0}),l){const $=N+(z?28:8);tl(e,P,C,$,J)}},sl=(e,t,n,s,o=0,l=!1,i=!1)=>{e.save();const m=s+35,d=e.createRadialGradient(t,n,s-5,t,n,m);l?(d.addColorStop(0,"rgba(45, 35, 15, 0.95)"),d.addColorStop(.6,"rgba(35, 28, 12, 0.85)"),d.addColorStop(1,"rgba(25, 20, 8, 0)")):i?(d.addColorStop(0,"rgba(15, 30, 45, 0.95)"),d.addColorStop(.6,"rgba(12, 25, 38, 0.85)"),d.addColorStop(1,"rgba(8, 18, 28, 0)")):(d.addColorStop(0,"rgba(15, 23, 42, 0.95)"),d.addColorStop(.6,"rgba(15, 23, 42, 0.85)"),d.addColorStop(1,"rgba(15, 23, 42, 0)")),e.beginPath(),e.arc(t,n,m,0,Math.PI*2),e.fillStyle=d,e.fill(),e.beginPath(),e.arc(t,n,m-2,0,Math.PI*2),l?e.strokeStyle="rgba(250, 204, 21, 0.4)":i?e.strokeStyle="rgba(56, 189, 248, 0.4)":e.strokeStyle="rgba(148, 163, 184, 0.3)",e.lineWidth=1,e.stroke(),e.restore()},ol=(e,t,n={})=>{var d,c,u;const{hoveredTokenId:s=null,selectedTokenId:o=null,currentUserId:l=null,isMaster:i=!1,draggingTokenId:m=null}=n;for(const h of t){const y=h.id===s||h.characterId===s,I=h.id===o||h.characterId===o,k=h.id===m||h.characterId===m,P=((d=h.character)==null?void 0:d.ownerId)===l,C=((u=(c=h.character)==null?void 0:c.combat)==null?void 0:u.showDefenceToOthers)||!1,N=i||P||C;k&&(e.save(),e.globalAlpha=.7),nl(e,h,{...n,isHovered:y,isSelected:I,canSeeDefence:N}),k&&e.restore()}},al=(e,t,n,s)=>{const o=e-n.pixelX,l=t-n.pixelY,i=s/2;return o*o+l*l<=i*i},ll=(e,t,n,s)=>{for(let o=n.length-1;o>=0;o--){const l=n[o];if(al(e,t,l,s))return l}return null},kt=(e,t,n)=>({x:(e-n.x)/n.zoom,y:(t-n.y)/n.zoom}),il={class:"fill-profile-panel flex flex-col h-full bg-slate-800 text-white"},rl={class:"flex items-center justify-between px-3 py-2 border-b border-white/10"},cl={class:"flex border-b border-white/10"},ul=["onClick"],dl={class:"flex-1 overflow-y-auto p-3"},fl={class:"space-y-2"},pl={class:"flex items-center justify-between mb-2"},hl={class:"flex gap-1"},ml={key:0,class:"p-2 bg-slate-700/50 rounded-lg mb-2"},gl={class:"flex gap-1"},vl=["onClick"],bl={class:"flex items-center justify-between"},yl={class:"text-sm font-medium"},xl={class:"text-xs text-slate-400"},kl=["onClick"],wl={key:1,class:"text-center text-slate-500 text-xs py-4"},_l={key:0,class:"mt-4 pt-4 border-t border-white/10"},Tl={class:"grid grid-cols-5 gap-1 max-h-32 overflow-y-auto"},Cl=["title","onClick"],Sl={key:1,class:"space-y-2"},Pl={class:"flex items-center justify-between mb-2"},$l={class:"text-xs text-slate-400"},El=["onClick"],Al={class:"flex items-center gap-2"},Il=["checked","onChange"],Ml={class:"text-sm"},Dl={class:"flex items-center gap-1"},Ll={class:"text-xs text-slate-400"},Rl=["onClick"],Fl={key:0,class:"mt-3 pt-3 border-t border-white/10 space-y-3"},Nl=["value","onInput"],Ol={class:"grid grid-cols-6 gap-1 mt-1 max-h-24 overflow-y-auto"},zl=["title","onClick"],Bl={class:"flex items-center justify-between"},jl={class:"text-xs text-sky-400"},Wl=["value","onInput"],Hl={class:"flex items-center justify-between"},Ul={class:"text-xs text-sky-400"},ql={class:"flex items-center gap-2 text-[10px] text-slate-500"},Vl=["value","onInput"],Yl={class:"flex items-center justify-between mb-1"},Gl=["onClick"],Xl={key:0,class:"text-xs text-slate-500 italic"},Ql=["value","onChange"],Kl=["value"],Jl=["value","onChange"],Zl=["value"],ei=["value","onInput"],ti=["onClick"],ni={key:0,class:"text-center text-slate-500 text-xs py-4"},si={key:2,class:"text-center py-8"},oi={key:3,class:"text-center text-slate-500 text-xs py-8"},ai={key:0,class:"p-3 border-t border-white/10"},li={__name:"FillProfilePanel",emits:["apply","preview","close"],setup(e,{emit:t}){const n=t,s=bn(),o=In(),{profiles:l,currentProfile:i,sortedProfiles:m}=Ke(s),d=j("profile"),c=j(null),u=j(!1),h=j(""),y=H(()=>[...o.baseTerrains,...o.customTerrains]),I=U=>y.value.find(D=>D.id===U)||{name:U,color:"#888"},k=()=>{h.value.trim()&&(s.createProfile({name:h.value.trim()}),h.value="",u.value=!1)},P=U=>{s.selectProfile(U),c.value=null},C=U=>{confirm("Удалить профиль?")&&s.deleteProfile(U)},N=()=>{var D;if(!i.value)return;const U=s.addLayer(i.value.id,{name:`Слой ${(((D=i.value.layers)==null?void 0:D.length)||0)+1}`});U&&(c.value=U.id,d.value="layers")},J=U=>{i.value&&(s.removeLayer(i.value.id,U),c.value===U&&(c.value=null))},X=(U,D,fe)=>{i.value&&s.updateLayer(i.value.id,U,{[D]:fe})},w=U=>{i.value&&s.updateProfile(i.value.id,{baseTerrain:U})},z=U=>{i.value&&s.addCondition(i.value.id,U,{type:ge.NONE})},A=(U,D)=>{i.value&&s.removeCondition(i.value.id,U,D)},x=()=>{i.value&&n("apply",i.value)},$=()=>{i.value&&n("preview",i.value)},R=()=>{s.createDefaultProfile()},W={[ge.NONE]:"Без условия",[ge.TERRAIN_ID]:"Террейн",[ge.TERRAIN_BIOME]:"Биом",[ge.VISIBILITY]:"Видимость",[ge.MOVEMENT_COST]:"Проходимость",[ge.MELEE_ADVANTAGE]:"Бонус ближ. боя",[ge.TAG]:"Тег"},ue={[ke.EQUALS]:"=",[ke.NOT_EQUALS]:"≠",[ke.GREATER]:">",[ke.GREATER_EQUALS]:"≥",[ke.LESS]:"<",[ke.LESS_EQUALS]:"≤",[ke.CONTAINS]:"содержит"};return(U,D)=>{var fe;return f(),p("div",il,[r("header",rl,[D[5]||(D[5]=r("h3",{class:"text-sm font-medium"},"Профили заливки",-1)),r("button",{type:"button",class:"text-slate-400 hover:text-white transition",onClick:D[0]||(D[0]=b=>n("close"))}," ✕ ")]),r("div",cl,[(f(),p(Y,null,ae([{id:"profile",label:"📋 Профиль"},{id:"layers",label:"📚 Слои"},{id:"preview",label:"👁 Превью"}],b=>r("button",{key:b.id,type:"button",class:oe(["flex-1 px-3 py-2 text-xs transition",d.value===b.id?"bg-sky-500/20 text-sky-400 border-b-2 border-sky-400":"text-slate-400 hover:text-white hover:bg-white/5"]),onClick:_=>d.value=b.id},O(b.label),11,ul)),64))]),r("div",dl,[d.value==="profile"?(f(),p(Y,{key:0},[r("div",fl,[r("div",pl,[D[6]||(D[6]=r("span",{class:"text-xs text-slate-400"},"Сохранённые профили",-1)),r("div",hl,[r("button",{type:"button",class:"px-2 py-1 text-xs bg-sky-500/20 text-sky-400 rounded hover:bg-sky-500/30 transition",onClick:D[1]||(D[1]=b=>u.value=!0)}," + Новый "),E(l).length===0?(f(),p("button",{key:0,type:"button",class:"px-2 py-1 text-xs bg-emerald-500/20 text-emerald-400 rounded hover:bg-emerald-500/30 transition",onClick:R}," Пример ")):M("",!0)])]),u.value?(f(),p("div",ml,[Me(r("input",{"onUpdate:modelValue":D[2]||(D[2]=b=>h.value=b),type:"text",placeholder:"Название профиля...",class:"w-full px-2 py-1 text-xs bg-slate-900/50 border border-white/10 rounded mb-2 focus:outline-none focus:border-sky-400/50",onKeyup:fs(k,["enter"])},null,544),[[qe,h.value]]),r("div",gl,[r("button",{type:"button",class:"flex-1 px-2 py-1 text-xs bg-sky-500 text-white rounded hover:bg-sky-600 transition",onClick:k}," Создать "),r("button",{type:"button",class:"px-2 py-1 text-xs text-slate-400 hover:text-white transition",onClick:D[3]||(D[3]=b=>{u.value=!1,h.value=""})}," Отмена ")])])):M("",!0),(f(!0),p(Y,null,ae(E(m),b=>{var _,T;return f(),p("div",{key:b.id,class:oe(["p-2 rounded-lg border transition cursor-pointer",((_=E(i))==null?void 0:_.id)===b.id?"bg-sky-500/20 border-sky-400/60":"bg-slate-700/30 border-white/10 hover:border-white/20"]),onClick:F=>P(b.id)},[r("div",bl,[r("div",null,[r("div",yl,O(b.name),1),r("div",xl,O(((T=b.layers)==null?void 0:T.length)||0)+" слоёв • База: "+O(I(b.baseTerrain).name),1)]),r("button",{type:"button",class:"p-1 text-slate-400 hover:text-red-400 transition",onClick:$e(F=>C(b.id),["stop"])}," 🗑 ",8,kl)])],10,vl)}),128)),E(l).length===0?(f(),p("div",wl," Нет сохранённых профилей ")):M("",!0)]),E(i)?(f(),p("div",_l,[D[7]||(D[7]=r("div",{class:"text-xs text-slate-400 mb-2"},"Базовый террейн",-1)),r("div",Tl,[(f(!0),p(Y,null,ae(y.value,b=>(f(),p("button",{key:b.id,type:"button",class:oe(["w-10 h-10 rounded border transition",E(i).baseTerrain===b.id?"border-sky-400 ring-2 ring-sky-400/50":"border-white/10 hover:border-white/30"]),style:Se({backgroundColor:b.color||"#888"}),title:b.name,onClick:_=>w(b.id)},null,14,Cl))),128))])])):M("",!0)],64)):M("",!0),d.value==="layers"&&E(i)?(f(),p("div",Sl,[r("div",Pl,[r("span",$l,'Слои профиля "'+O(E(i).name)+'"',1),r("button",{type:"button",class:"px-2 py-1 text-xs bg-sky-500/20 text-sky-400 rounded hover:bg-sky-500/30 transition",onClick:N}," + Слой ")]),(f(!0),p(Y,null,ae(E(i).layers,b=>{var _;return f(),p("div",{key:b.id,class:oe(["p-2 rounded-lg border transition",c.value===b.id?"bg-sky-500/10 border-sky-400/60":"bg-slate-700/30 border-white/10"])},[r("div",{class:"flex items-center justify-between cursor-pointer",onClick:T=>c.value=c.value===b.id?null:b.id},[r("div",Al,[r("input",{type:"checkbox",checked:b.enabled,class:"rounded",onClick:D[4]||(D[4]=$e(()=>{},["stop"])),onChange:T=>X(b.id,"enabled",T.target.checked)},null,40,Il),r("span",{class:"w-4 h-4 rounded",style:Se({backgroundColor:I(b.terrainId).color||"#888"})},null,4),r("span",Ml,O(b.name),1)]),r("div",Dl,[r("span",Ll,O(b.density)+"%",1),r("button",{type:"button",class:"p-1 text-slate-400 hover:text-red-400 transition",onClick:$e(T=>J(b.id),["stop"])}," ✕ ",8,Rl)])],8,El),c.value===b.id?(f(),p("div",Fl,[r("div",null,[D[8]||(D[8]=r("label",{class:"text-xs text-slate-400"},"Название",-1)),r("input",{value:b.name,type:"text",class:"w-full px-2 py-1 text-xs bg-slate-900/50 border border-white/10 rounded mt-1 focus:outline-none focus:border-sky-400/50",onInput:T=>X(b.id,"name",T.target.value)},null,40,Nl)]),r("div",null,[D[9]||(D[9]=r("label",{class:"text-xs text-slate-400"},"Террейн",-1)),r("div",Ol,[(f(!0),p(Y,null,ae(y.value,T=>(f(),p("button",{key:T.id,type:"button",class:oe(["w-8 h-8 rounded border transition",b.terrainId===T.id?"border-sky-400 ring-2 ring-sky-400/50":"border-white/10 hover:border-white/30"]),style:Se({backgroundColor:T.color||"#888"}),title:T.name,onClick:F=>X(b.id,"terrainId",T.id)},null,14,zl))),128))])]),r("div",null,[r("div",Bl,[D[10]||(D[10]=r("label",{class:"text-xs text-slate-400"},"Плотность",-1)),r("span",jl,O(b.density)+"%",1)]),r("input",{value:b.density,type:"range",min:"0",max:"100",class:"w-full mt-1",onInput:T=>X(b.id,"density",Number(T.target.value))},null,40,Wl)]),r("div",null,[r("div",Hl,[D[11]||(D[11]=r("label",{class:"text-xs text-slate-400"},"Группировка",-1)),r("span",Ul,O(b.clustering)+"%",1)]),r("div",ql,[D[12]||(D[12]=r("span",null,"Разброс",-1)),r("input",{value:b.clustering,type:"range",min:"0",max:"100",class:"flex-1",onInput:T=>X(b.id,"clustering",Number(T.target.value))},null,40,Vl),D[13]||(D[13]=r("span",null,"Кластеры",-1))])]),r("div",null,[r("div",Yl,[D[14]||(D[14]=r("label",{class:"text-xs text-slate-400"},"Условия",-1)),r("button",{type:"button",class:"text-xs text-sky-400 hover:text-sky-300",onClick:T=>z(b.id)}," + Условие ",8,Gl)]),((_=b.conditions)==null?void 0:_.length)===0?(f(),p("div",Xl," Нет условий (применяется везде) ")):M("",!0),(f(!0),p(Y,null,ae(b.conditions,T=>(f(),p("div",{key:T.id,class:"flex items-center gap-1 mt-1 p-1 bg-slate-900/30 rounded text-xs"},[r("select",{value:T.type,class:"flex-1 px-1 py-0.5 bg-slate-800 border border-white/10 rounded text-xs",onChange:F=>E(s).updateLayer(E(i).id,b.id,{conditions:b.conditions.map(q=>q.id===T.id?{...q,type:F.target.value}:q)})},[(f(),p(Y,null,ae(W,(F,q)=>r("option",{key:q,value:q},O(F),9,Kl)),64))],40,Ql),T.type!==E(ge).NONE?(f(),p("select",{key:0,value:T.operator,class:"px-1 py-0.5 bg-slate-800 border border-white/10 rounded text-xs",onChange:F=>E(s).updateLayer(E(i).id,b.id,{conditions:b.conditions.map(q=>q.id===T.id?{...q,operator:F.target.value}:q)})},[(f(),p(Y,null,ae(ue,(F,q)=>r("option",{key:q,value:q},O(F),9,Zl)),64))],40,Jl)):M("",!0),T.type!==E(ge).NONE?(f(),p("input",{key:1,value:T.value,type:"text",placeholder:"значение",class:"w-16 px-1 py-0.5 bg-slate-800 border border-white/10 rounded text-xs",onInput:F=>E(s).updateLayer(E(i).id,b.id,{conditions:b.conditions.map(q=>q.id===T.id?{...q,value:F.target.value}:q)})},null,40,ei)):M("",!0),r("button",{type:"button",class:"text-slate-400 hover:text-red-400",onClick:F=>A(b.id,T.id)}," ✕ ",8,ti)]))),128))])])):M("",!0)],2)}),128)),(fe=E(i).layers)!=null&&fe.length?M("",!0):(f(),p("div",ni," Добавьте слои для настройки заливки "))])):M("",!0),d.value==="preview"&&E(i)?(f(),p("div",si,[D[15]||(D[15]=r("div",{class:"text-slate-400 text-sm mb-4"},' Выделите область на карте и нажмите "Превью" чтобы увидеть результат ',-1)),r("button",{type:"button",class:"px-4 py-2 bg-amber-500/20 text-amber-400 rounded-lg hover:bg-amber-500/30 transition",onClick:$}," 👁 Показать превью ")])):M("",!0),!E(i)&&d.value!=="profile"?(f(),p("div",oi," Выберите или создайте профиль ")):M("",!0)]),E(i)?(f(),p("footer",ai,[r("button",{type:"button",class:"w-full py-2 bg-emerald-500 text-white rounded-lg font-medium hover:bg-emerald-600 transition",onClick:x}," 🎲 Применить к выделению ")])):M("",!0)])}}},ii=Et(li,[["__scopeId","data-v-f9b9add9"]]),ri={class:"h-full bg-slate-950 text-slate-50 flex flex-col overflow-hidden relative"},ci={class:"bg-slate-900/90 backdrop-blur border-b border-white/10 px-4 py-2 flex items-center justify-between flex-shrink-0 gap-2 relative z-20"},ui={class:"flex items-center gap-2"},di={key:0,class:"relative"},fi={class:"font-medium truncate max-w-32"},pi=["onClick"],hi={class:"text-sm font-medium"},mi={class:"text-xs text-slate-400"},gi={key:0,class:"text-xs text-emerald-400"},vi={key:0,class:"border-t border-white/10 mt-1 pt-1"},bi={key:1,class:"flex items-center gap-2"},yi={key:0,class:"px-3 py-1.5 rounded-lg bg-slate-800 border border-white/10 text-sm font-medium"},xi={key:1,class:"px-3 py-1.5 rounded-lg bg-slate-800/50 border border-white/10 text-sm text-slate-400"},ki={key:2,class:"text-xs px-2 py-1 rounded bg-slate-800 border border-white/10"},wi={key:3,class:"text-xs px-2 py-1 rounded bg-slate-700 text-slate-400"},_i={key:0,class:"flex items-center gap-1"},Ti=["title","onClick"],Ci={class:"flex items-center gap-1"},Si=["title","onClick"],Pi={key:0,class:"text-xs text-slate-500 italic"},$i={class:"relative"},Ei={class:"mb-3"},Ai={class:"flex gap-1"},Ii=["title","onClick"],Mi={class:"mb-3"},Di={class:"flex gap-1"},Li=["title","onClick"],Ri={class:"mb-3"},Fi={class:"flex gap-1"},Ni=["title","onClick"],Oi={class:"text-[10px] text-slate-500 mt-1"},zi={key:0},Bi={class:"text-xs text-slate-400 mb-1"},ji=["value"],Wi={class:"text-xs text-slate-400 px-1"},Hi={class:"relative"},Ui={class:"text-xs"},qi={class:"p-2 border-b border-white/10"},Vi={class:"flex items-center gap-2"},Yi={key:0,class:"mt-2 space-y-2"},Gi={class:"flex items-center gap-2"},Xi=["value"],Qi={class:"flex items-center gap-2"},Ki=["value"],Ji={class:"flex items-center gap-2"},Zi={class:"text-xs text-slate-300 w-8"},er={class:"p-2 max-h-64 overflow-y-auto"},tr={key:0,class:"grid grid-cols-5 gap-1"},nr=["title","onClick"],sr={class:"absolute bottom-0 left-0 right-0 flex justify-center gap-0.5 p-0.5 bg-black/50 opacity-0 group-hover:opacity-100 transition"},or={key:0,class:"text-[8px]"},ar={key:1,class:"text-[8px]"},lr={key:2,class:"text-[8px]"},ir={key:3,class:"text-[8px]"},rr={key:4,class:"text-[8px] text-green-400"},cr={key:5,class:"text-[8px] text-red-400"},ur={key:1,class:"text-center text-xs text-slate-400 py-4"},dr={key:2,class:"mt-2 pt-2 border-t border-white/10"},fr={class:"grid grid-cols-5 gap-1"},pr=["title","onClick"],hr={class:"flex items-center gap-2"},mr=["title"],gr={class:"flex-1 flex overflow-hidden"},vr=["width","height"],br=["width","height"],yr=["width","height"],xr={key:0,class:"absolute bottom-4 left-4 px-3 py-1.5 rounded-lg bg-slate-900/90 border border-white/10 text-xs font-mono pointer-events-none"},kr={class:"absolute bottom-4 right-4 px-3 py-1.5 rounded-lg bg-slate-900/90 border border-white/10 text-xs pointer-events-none"},wr={class:"bg-slate-900/80 backdrop-blur border-t border-white/10 px-4 py-2 flex-shrink-0 relative z-10"},_r={class:"flex items-center justify-between text-sm"},Tr={class:"text-slate-400 text-xs"},Cr={class:"flex items-center gap-2"},Sr={class:"bg-slate-800 border border-white/10 rounded-xl p-6 w-full max-w-md shadow-2xl"},Pr={class:"space-y-4"},$r={class:"flex gap-2"},Er=["value"],Ar={class:"flex justify-end gap-2 mt-6"},Wr={__name:"BattleMap",props:{readonly:{type:Boolean,default:!1},mobileMode:{type:Boolean,default:!1},pendingAction:{type:Object,default:null}},emits:["action-target-selected"],setup(e,{emit:t}){const n=e,s=t,o=gs(),l=In();bn();const i=vn(),m=vs(),d=hn(),{activeMap:c,editingMap:u,editorMode:h,selectedTerrain:y,activeLayerId:I,camera:k,maps:P,publishedMaps:C,selection:N}=Ke(o),{isMaster:J}=Ke(i),{characters:X}=Ke(m),w=H(()=>n.readonly||!J.value),z=H(()=>!w.value),A=j(null),x=j(null),$=j(null),R=j(null),W=j({width:800,height:600}),ue=j(!1),U=j(!1),D=j(!1),fe=j(!1),b=j(!1),_=j(null),T=j(null),F=j(null),q=j(!1),ie=j(!1),re=j(!1),Q=j(null),ce=j({x:0,y:0}),se=j(null),le=j(""),pe=j(null),we=j(null),ve=j({min:1,max:5}),Re=j(!1),Pe=j(!1),Ne=j(null),Te=j(null),Ee=j([]),de=j(new Set),tt=j({x:0,y:0}),be=j({name:"",orientation:Qt.FLAT,scale:ze.BATTLE,hexSize:32}),he=H(()=>{const g=c.value;return g?new bs({orientation:g.orientation,hexSize:g.hexSize,origin:{x:0,y:0}}):null}),dt=H(()=>{if(!c.value||!he.value)return[];const g=o.getAllTokens(c.value.id),a=he.value;return g.map(S=>{const L=m.getCharacterById(S.characterId);if(!L)return null;const K=a.hexToPixel(S.q,S.r);return{...S,character:L,pixelX:K.x,pixelY:K.y,meleeDefence:un(L,"melee"),rangedDefence:un(L,"ranged")}}).filter(Boolean)}),It=H(()=>c.value?Math.floor(c.value.hexSize*1.6):48),We=H(()=>he.value?new ys(he.value):null),Mt=H(()=>l.getFilteredTerrains({biome:pe.value,visibility:we.value,passabilityMin:ve.value.min,passabilityMax:ve.value.max,search:le.value})),Ln=H(()=>[...l.baseTerrains,...l.customTerrains]),ft=H(()=>{const g=Ln.value.find(a=>a.id===y.value);if(g)return g;if(Ge[y.value]){const a=Ge[y.value];return{id:y.value,name:a.name,fallbackColor:a.color,passability:a.passable?1:0}}return{id:"void",name:"Пустота",fallbackColor:"#0d1117",passability:0}});mn(()=>{Dt(),z.value&&(P.value.length===0?Ht():c.value||o.setActiveMap(P.value[0].id)),nt(),je(()=>{Ae()}),window.addEventListener("resize",Lt)}),gn(()=>{window.removeEventListener("resize",Lt)}),Je([c,k],()=>{je(()=>{Ae()})},{deep:!0}),Je(dt,async g=>{g.length>0&&(await Qa(g),xe())},{immediate:!0});let pt=null;Je(()=>{var g;return(g=c.value)==null?void 0:g.updatedAt},(g,a)=>{!J.value||!g||(pt&&clearTimeout(pt),pt=setTimeout(()=>{i.broadcastMap()},500))},{flush:"post"});const Dt=()=>{if(A.value){const g=A.value.getBoundingClientRect();W.value={width:Math.floor(g.width)||800,height:Math.floor(g.height)||600}}},nt=()=>{o.$patch({camera:{x:W.value.width/2,y:W.value.height/2,zoom:1}})},Ae=()=>{Oe(),Ye(),xe()},Oe=()=>{const g=x.value;if(!g||!c.value||!he.value)return;const a=g.getContext("2d"),S=c.value,L=he.value;a.clearRect(0,0,g.width,g.height),a.save(),a.translate(k.value.x,k.value.y),a.scale(k.value.zoom,k.value.zoom);const K=S.layers.find(te=>te.type===He.TERRAIN);if(!K){a.restore();return}K.data.forEach((te,v)=>{const[B,V]=v.split(",").map(Number),G=L.hexToPixel(B,V),Z=L.getHexCorners(G.x,G.y);let ee=(te==null?void 0:te.terrain)||"void",ne=!1;se.value&&se.value.has(v)&&(ee=se.value.get(v),ne=!0);let ye="#0d1117";const Fe=l.getTerrainById(ee);Fe?ye=Fe.fallbackColor||Fe.color||ye:Ge[ee]&&(ye=Ge[ee].color),a.beginPath(),a.moveTo(Z[0].x,Z[0].y);for(let Ie=1;Ie<6;Ie++)a.lineTo(Z[Ie].x,Z[Ie].y);a.closePath(),a.fillStyle=ye,a.fill(),ne&&(a.strokeStyle="rgba(255, 255, 0, 0.6)",a.lineWidth=2/k.value.zoom,a.stroke())}),a.restore()},Ye=()=>{const g=$.value;if(!g||!c.value||!he.value)return;const a=g.getContext("2d"),S=c.value,L=he.value;if(a.clearRect(0,0,g.width,g.height),!S.visibility.showGrid)return;a.save(),a.translate(k.value.x,k.value.y),a.scale(k.value.zoom,k.value.zoom);const K=S.layers.find(v=>v.type===He.TERRAIN);if(!K){a.restore();return}a.strokeStyle="rgba(255, 255, 255, 0.2)",a.lineWidth=1/k.value.zoom,K.data.forEach((v,B)=>{const[V,G]=B.split(",").map(Number),Z=L.hexToPixel(V,G),ee=L.getHexCorners(Z.x,Z.y);a.beginPath(),a.moveTo(ee[0].x,ee[0].y);for(let ne=1;ne<6;ne++)a.lineTo(ee[ne].x,ee[ne].y);a.closePath(),a.stroke()});const te=L.hexToPixel(0,0);a.beginPath(),a.arc(te.x,te.y,4/k.value.zoom,0,Math.PI*2),a.fillStyle="rgba(250, 204, 21, 0.8)",a.fill(),a.restore()},xe=()=>{var K,te,v;const g=R.value;if(!g||!c.value||!he.value)return;const a=g.getContext("2d"),S=he.value;if(a.clearRect(0,0,g.width,g.height),a.save(),a.translate(k.value.x,k.value.y),a.scale(k.value.zoom,k.value.zoom),de.value.size>0&&de.value.forEach(B=>{const[V,G]=B.split(",").map(Number),Z=S.hexToPixel(V,G),ee=S.getHexCorners(Z.x,Z.y);a.beginPath(),a.moveTo(ee[0].x,ee[0].y);for(let ne=1;ne<6;ne++)a.lineTo(ee[ne].x,ee[ne].y);a.closePath(),a.fillStyle="rgba(250, 204, 21, 0.25)",a.fill(),a.strokeStyle="rgba(250, 204, 21, 0.8)",a.lineWidth=2/k.value.zoom,a.stroke()}),Ee.value.length>0&&Pe.value){const B=N.value.mode;let V,G;if(B===_e.ADD?(V="rgba(34, 197, 94, 0.3)",G="rgba(34, 197, 94, 0.9)"):B===_e.SUBTRACT?(V="rgba(239, 68, 68, 0.3)",G="rgba(239, 68, 68, 0.9)"):(V="rgba(56, 189, 248, 0.3)",G="rgba(56, 189, 248, 0.9)"),Ee.value.forEach(Z=>{const ee=S.hexToPixel(Z.q,Z.r),ne=S.getHexCorners(ee.x,ee.y);a.beginPath(),a.moveTo(ne[0].x,ne[0].y);for(let ye=1;ye<6;ye++)a.lineTo(ne[ye].x,ne[ye].y);a.closePath(),a.fillStyle=V,a.fill(),a.strokeStyle=G,a.lineWidth=1.5/k.value.zoom,a.stroke()}),Te.value&&_.value){const Z=N.value.shape,ee=Te.value,ne=S.hexToPixel(_.value.q,_.value.r);if(a.setLineDash([5/k.value.zoom,5/k.value.zoom]),a.strokeStyle=G,a.lineWidth=2/k.value.zoom,Z===me.RECTANGLE){const ye=Math.min(ee.x,ne.x),Fe=Math.max(ee.x,ne.x),Ie=Math.min(ee.y,ne.y),is=Math.max(ee.y,ne.y);a.strokeRect(ye,Ie,Fe-ye,is-Ie)}else if(Z===me.CIRCLE||Z===me.HEXAGON){const ye=ne.x-ee.x,Fe=ne.y-ee.y,Ie=Math.sqrt(ye*ye+Fe*Fe);a.beginPath(),a.arc(ee.x,ee.y,Ie,0,Math.PI*2),a.stroke()}else Z===me.LINE&&(a.beginPath(),a.moveTo(ee.x,ee.y),a.lineTo(ne.x,ne.y),a.stroke());a.setLineDash([])}}if(Te.value&&Pe.value){const B=Te.value;a.beginPath(),a.arc(B.x,B.y,6/k.value.zoom,0,Math.PI*2),a.fillStyle="rgba(250, 204, 21, 0.9)",a.fill(),a.strokeStyle="rgba(0, 0, 0, 0.5)",a.lineWidth=1/k.value.zoom,a.stroke()}if(_.value&&!Pe.value){const B=S.hexToPixel(_.value.q,_.value.r),V=S.getHexCorners(B.x,B.y);a.beginPath(),a.moveTo(V[0].x,V[0].y);for(let G=1;G<6;G++)a.lineTo(V[G].x,V[G].y);a.closePath(),a.fillStyle="rgba(56, 189, 248, 0.3)",a.fill(),a.strokeStyle="rgba(56, 189, 248, 0.8)",a.lineWidth=2,a.stroke()}const L=dt.value;if(L.length>0&&ol(a,L,{tokenSize:It.value,showFacing:!0,hoveredTokenId:((K=T.value)==null?void 0:K.characterId)||null,selectedTokenId:((te=F.value)==null?void 0:te.characterId)||null,currentUserId:d.userId,isMaster:J.value,draggingTokenId:re.value?(v=Q.value)==null?void 0:v.characterId:null}),re.value&&Q.value&&he.value){const B=he.value.pixelToHex(Q.value.pixelX,Q.value.pixelY),V=he.value.hexToPixel(B.q,B.r);a.beginPath();const G=he.value.getHexCorners(V.x,V.y);a.moveTo(G[0].x,G[0].y);for(let Z=1;Z<G.length;Z++)a.lineTo(G[Z].x,G[Z].y);a.closePath(),a.fillStyle="rgba(250, 204, 21, 0.3)",a.fill(),a.strokeStyle="rgba(250, 204, 21, 0.8)",a.lineWidth=2,a.stroke()}a.restore()},Lt=()=>{Dt(),je(()=>{Ae()})},Rn=g=>{if(!he.value||!R.value)return null;const a=R.value.getBoundingClientRect(),S=(g.clientX-a.left-k.value.x)/k.value.zoom,L=(g.clientY-a.top-k.value.y)/k.value.zoom;return he.value.pixelToHex(S,L)},Rt=g=>{if(!R.value)return null;const a=R.value.getBoundingClientRect(),S=(g.clientX-a.left-k.value.x)/k.value.zoom,L=(g.clientY-a.top-k.value.y)/k.value.zoom;return{x:S,y:L}},Ft=g=>{if(!he.value||!_.value)return null;const a=Rt(g);if(!a)return null;const S=he.value,L=_.value,K=S.hexToPixel(L.q,L.r),te=S.getHexCorners(K.x,K.y),v=[{x:K.x,y:K.y,type:"center"},...te.map((G,Z)=>({x:G.x,y:G.y,type:`corner${Z}`}))];let B=1/0,V=v[0];for(const G of v){const Z=G.x-a.x,ee=G.y-a.y,ne=Z*Z+ee*ee;ne<B&&(B=ne,V=G)}return{x:V.x,y:V.y}},Nt=g=>{if(q.value){const B=g.clientX-tt.value.x,V=g.clientY-tt.value.y;o.panCamera(B,V),tt.value={x:g.clientX,y:g.clientY},Ae();return}if(re.value&&Q.value){const B=g.target.getBoundingClientRect(),V=g.clientX-B.left,G=g.clientY-B.top,Z=kt(V,G,k.value);Q.value.pixelX=Z.x-ce.value.x,Q.value.pixelY=Z.y-ce.value.y,xe();return}const a=Rn(g);a?(_.value=a,Pe.value&&Ne.value&&We.value&&Wn(a,g),ie.value&&u.value&&h.value!=="select"&&jt(a)):_.value=null;const S=g.target.getBoundingClientRect(),L=g.clientX-S.left,K=g.clientY-S.top,te=kt(L,K,k.value),v=ll(te.x,te.y,dt.value,It.value);v!==T.value&&(T.value=v),xe()},Ot=j(0),Fn=j({x:0,y:0}),Nn=g=>{if(g.touches.length===1){const a=g.touches[0];Fn.value={x:a.clientX,y:a.clientY};const S={button:0,clientX:a.clientX,clientY:a.clientY,target:g.target,preventDefault:()=>g.preventDefault()};zt(S)}else g.touches.length===2&&g.preventDefault()},On=g=>{if(g.touches.length===1){const a=g.touches[0],S={clientX:a.clientX,clientY:a.clientY,target:g.target};Nt(S)}g.preventDefault()},zn=g=>{const a=Date.now();if(a-Ot.value,Ot.value=a,g.changedTouches.length===1){const S=g.changedTouches[0];S.clientX,S.clientY,g.target,Bt()}g.preventDefault()},zt=g=>{var a;if(ue.value=!1,D.value=!1,fe.value=!1,g.button===1||g.button===0&&g.shiftKey){q.value=!0,tt.value={x:g.clientX,y:g.clientY},g.preventDefault();return}if(g.button===0&&T.value&&J.value){re.value=!0,Q.value=T.value,F.value=T.value;const S=g.target.getBoundingClientRect(),L=g.clientX-S.left,K=g.clientY-S.top,te=kt(L,K,k.value);ce.value={x:te.x-T.value.pixelX,y:te.y-T.value.pixelY},g.preventDefault();return}if(g.button===0&&T.value){if(n.mobileMode&&n.pendingAction&&(n.pendingAction.id==="attack"||n.pendingAction.id==="skill")){s("action-target-selected",T.value);return}((a=F.value)==null?void 0:a.characterId)===T.value.characterId?F.value=null:F.value=T.value,xe();return}if(g.button===0&&!T.value){if(n.mobileMode&&n.pendingAction&&n.pendingAction.id==="move"&&_.value){s("action-target-selected",{type:"hex",hex:_.value});return}F.value&&(F.value=null,xe())}if(!w.value&&g.button===0&&_.value&&u.value)if(h.value==="select"){Pe.value=!0,Ne.value={..._.value};const S=Ft(g);Te.value=S,Ee.value=[{..._.value}]}else h.value==="token"?(de.value.clear(),de.value.add(`${_.value.q},${_.value.r}`),xe()):(ie.value=!0,jt(_.value))},Bt=g=>{if(re.value&&Q.value&&he.value&&c.value){const a=he.value.pixelToHex(Q.value.pixelX,Q.value.pixelY),S=Q.value.q,L=Q.value.r;(S!==a.q||L!==a.r)&&(o.moveToken(c.value.id,S,L,a.q,a.r)?i.broadcastMapTokenMove(c.value.id,Q.value.characterId,a.q,a.r):console.warn("Failed to move token - target hex may be occupied")),re.value=!1,Q.value=null,ce.value={x:0,y:0},xe();return}Pe.value&&Ne.value&&_.value&&Hn(),q.value=!1,ie.value=!1,Pe.value=!1,Ne.value=null,Te.value=null,Ee.value=[],xe()},Bn=()=>{_.value=null,T.value=null,q.value=!1,ie.value=!1,re.value&&(re.value=!1,Q.value=null,ce.value={x:0,y:0}),Pe.value&&(Pe.value=!1,Ne.value=null,Te.value=null,Ee.value=[]),xe()},jn=g=>{g.preventDefault();const a=R.value.getBoundingClientRect(),S=g.clientX-a.left,L=g.clientY-a.top,K=k.value.zoom,te=g.deltaY>0?.9:1.1,v=Math.max(.25,Math.min(4,K*te)),B=(S-k.value.x)/K,V=(L-k.value.y)/K;o.$patch({camera:{x:S-B*v,y:L-V*v,zoom:v}}),Ae()},jt=g=>{if(u.value){if(h.value==="paint")o.setHexTerrain(u.value.id,g.q,g.r,y.value),Oe(),Ye();else if(h.value==="erase"){const a=c.value,S=a==null?void 0:a.layers.find(L=>L.type===He.TERRAIN);if(S){const L=mt(g.q,g.r);S.data.delete(L),a.updatedAt=Date.now(),Oe(),Ye()}}}},Wn=(g,a=null)=>{if(!We.value||!Te.value)return;const S=N.value.shape,L=N.value.behavior,K=N.value.lineWidth,te=c.value,v=te==null?void 0:te.layers.find(Z=>Z.type===He.TERRAIN),B=v?v.data:new Map,V=a?Ft(a)||Rt(a):null;if(!V)return;let G=[];switch(S){case me.RECTANGLE:G=We.value.calculateRectanglePreviewPixel(Te.value,V,B,L);break;case me.CIRCLE:G=We.value.calculateCirclePreviewPixel(Te.value,V,B,L);break;case me.HEXAGON:G=We.value.calculateHexagonPreviewPixel(Te.value,V,B,L);break;case me.LINE:G=We.value.calculateLinePreviewPixel(Te.value,V,K,B,L);break}Ee.value=G},Hn=()=>{if(Ee.value.length===0)return;const g=N.value.mode,a=new Set(de.value);Ee.value.forEach(S=>{const L=mt(S.q,S.r);switch(g){case _e.REPLACE:a.size===de.value.size&&a.clear(),a.add(L);break;case _e.ADD:a.add(L);break;case _e.SUBTRACT:a.delete(L);break}}),g===_e.REPLACE?de.value=new Set(Ee.value.map(S=>mt(S.q,S.r))):de.value=a},Wt=()=>{de.value=new Set,xe()},Un=()=>{de.value.size===0||!u.value||(de.value.forEach(g=>{const[a,S]=g.split(",").map(Number);o.setHexTerrain(u.value.id,a,S,y.value)}),Oe(),Ye())},qn=()=>{if(de.value.size===0||!c.value)return;const g=c.value.layers.find(a=>a.type===He.TERRAIN);g&&(de.value.forEach(a=>{g.data.delete(a)}),c.value.updatedAt=Date.now(),Wt(),Oe(),Ye())},Ht=()=>{const g=o.createMap({name:be.value.name||"Новая карта",orientation:be.value.orientation,scale:be.value.scale,hexSize:be.value.hexSize}),a=5;for(let S=-a;S<=a;S++)for(let L=-a;L<=a;L++)(Math.abs(S)+Math.abs(S+L)+Math.abs(L))/2<=a&&o.setHexTerrain(g.id,S,L,"grass");o.startEditing(g.id),U.value=!1,be.value.name="",je(()=>{nt(),Ae()})},Vn=g=>{o.setActiveMap(g),ue.value=!1,je(()=>{nt(),Ae()})},Yn=()=>{u.value?o.stopEditing():c.value&&o.startEditing(c.value.id)},Ut=g=>{o.selectTerrain(g),h.value!=="select"&&o.setEditorMode("paint"),D.value=!1},Gn=()=>{c.value&&o.toggleMapPublished(c.value.id)},Xn=()=>{c.value&&confirm(`Удалить карту "${c.value.name}"?`)&&o.deleteMap(c.value.id)},Qn=g=>{if(!g||de.value.size===0){alert("Сначала выделите область на карте");return}const a=[...de.value],S=Ga(g,a,l);se.value=S,Oe(),xe()},Kn=g=>{if(!g||de.value.size===0){alert("Сначала выделите область на карте");return}const a=[...de.value],S=Mn(g,a,l);S.forEach((K,te)=>{const[v,B]=te.split(",").map(Number);o.setHexTerrain(c.value.id,v,B,K)});const L=Ya(S,l);console.log("Заливка применена:",L),se.value=null,de.value=new Set,b.value=!1,Ae()},Jn=()=>{se.value=null,Oe(),xe()},Zn=(g,a,S)=>{if(!c.value)return!1;const L=o.placeToken(c.value.id,g,a,S,0);return L&&xe(),L},es=g=>{let a=null;if(de.value.size>0){const S=de.value.values().next().value,[L,K]=S.split(",").map(Number);a={q:L,r:K}}else _.value&&(a=_.value);return a?Zn(g,a.q,a.r):(console.warn("No hex selected for token placement"),!1)},ts=H(()=>{const g=c.value;if(!g)return 0;const a=g.layers.find(S=>S.type===He.TERRAIN);return(a==null?void 0:a.data.size)||0}),ns=H(()=>c.value?c.value.orientation===Qt.FLAT?"Flat-top ⬡":"Pointy-top ⬢":""),qt={[ze.BATTLE]:"Бой",[ze.LOCATION]:"Локация",[ze.DISTRICT]:"Район",[ze.CITY]:"Город",[ze.REGION]:"Регион",[ze.WORLD]:"Мир"},Vt={[me.RECTANGLE]:"▭",[me.CIRCLE]:"○",[me.HEXAGON]:"⬡",[me.LINE]:"╱"},ss={[me.RECTANGLE]:"Прямоугольник",[me.CIRCLE]:"Круг",[me.HEXAGON]:"Шестиугольник",[me.LINE]:"Линия"},os={[_e.REPLACE]:"⬚",[_e.ADD]:"+",[_e.SUBTRACT]:"−"},as={[_e.REPLACE]:"Заменить",[_e.ADD]:"Добавить",[_e.SUBTRACT]:"Вычесть"},ls={[Be.AGGRESSIVE]:"Все",[Be.STANDARD]:"Станд.",[Be.PASSIVE]:"Связн."},Yt={[Be.AGGRESSIVE]:"Все гексы в геометрической области",[Be.STANDARD]:"Все гексы в геометрической области",[Be.PASSIVE]:"Только связные существующие гексы (flood-fill)"};return(g,a)=>{var S,L,K,te;return f(),p("div",ri,[r("header",ci,[r("div",ui,[z.value?(f(),p("div",di,[r("button",{type:"button",class:"flex items-center gap-2 px-3 py-1.5 rounded-lg bg-slate-800 border border-white/10 hover:bg-slate-700 transition text-sm",onClick:a[0]||(a[0]=$e(v=>{ue.value=!ue.value,D.value=!1},["stop"]))},[r("span",fi,O(((S=E(c))==null?void 0:S.name)||"Выбрать карту"),1),a[25]||(a[25]=r("span",{class:"text-slate-400"},"▼",-1))]),ue.value?(f(),p("div",{key:0,class:"absolute top-full left-0 mt-1 w-64 bg-slate-800 border border-white/10 rounded-lg shadow-xl z-50 py-1 max-h-80 overflow-y-auto",onClick:a[2]||(a[2]=$e(()=>{},["stop"]))},[(f(!0),p(Y,null,ae(E(P),v=>{var B,V;return f(),p("div",{key:v.id,class:oe(["px-3 py-2 hover:bg-slate-700 cursor-pointer flex items-center justify-between",v.id===((B=E(c))==null?void 0:B.id)?"bg-sky-500/20":""]),onClick:G=>Vn(v.id)},[r("div",null,[r("p",hi,O(v.name),1),r("p",mi,O(qt[v.scale]),1)]),(V=v.visibility)!=null&&V.published?(f(),p("span",gi,"●")):M("",!0)],10,pi)}),128)),z.value?(f(),p("div",vi,[r("button",{type:"button",class:"w-full px-3 py-2 text-left text-sm text-sky-400 hover:bg-slate-700",onClick:a[1]||(a[1]=v=>{U.value=!0,ue.value=!1})}," + Создать карту ")])):M("",!0)])):M("",!0)])):(f(),p("div",bi,[E(c)?(f(),p("span",yi," 🗺️ "+O(E(c).name),1)):(f(),p("span",xi," ⏳ Ожидание карты... "))])),E(c)?(f(),p("span",ki,O(ts.value)+" гексов • "+O(ns.value),1)):M("",!0),w.value&&E(c)?(f(),p("span",wi," 👁️ Просмотр ")):M("",!0)]),E(u)&&z.value?(f(),p("div",_i,[(f(),p(Y,null,ae(["select","paint","erase","token"],v=>r("button",{key:v,type:"button",class:oe(["w-9 h-9 rounded-lg border flex items-center justify-center text-sm transition",E(h)===v?"bg-sky-500/30 border-sky-400/60 text-sky-100":"border-white/10 hover:bg-white/5 text-slate-300"]),title:v==="select"?"Выбор":v==="paint"?"Рисовать":v==="erase"?"Стереть":"Токены",onClick:B=>E(o).setEditorMode(v)},O(v==="select"?"👆":v==="paint"?"🖌️":v==="erase"?"🧹":"👤"),11,Ti)),64)),E(h)==="token"?(f(),p(Y,{key:0},[a[27]||(a[27]=r("div",{class:"w-px h-6 bg-white/10 mx-1"},null,-1)),r("div",Ci,[a[26]||(a[26]=r("span",{class:"text-xs text-slate-400 mr-1"},"Персонажи:",-1)),(f(!0),p(Y,null,ae(E(X),v=>{var B,V;return f(),p("button",{key:v.id,type:"button",class:oe(["px-2 py-1 rounded text-xs border border-white/10 hover:bg-white/10 transition truncate max-w-24",E(o).findTokenPosition((B=E(c))==null?void 0:B.id,v.id)?"bg-emerald-500/20 border-emerald-400/40":""]),title:v.name+(E(o).findTokenPosition((V=E(c))==null?void 0:V.id,v.id)?" (на карте)":" - клик для размещения"),onClick:G=>es(v.id)},O(v.name),11,Si)}),128)),E(X).length?M("",!0):(f(),p("span",Pi,"Нет персонажей"))])],64)):M("",!0),E(h)==="select"?(f(),p(Y,{key:1},[a[32]||(a[32]=r("div",{class:"w-px h-6 bg-white/10 mx-1"},null,-1)),r("div",$i,[r("button",{type:"button",class:"flex items-center gap-1 px-2 py-1.5 rounded-lg border border-white/10 hover:bg-white/5 transition text-xs",onClick:a[3]||(a[3]=$e(v=>{fe.value=!fe.value,D.value=!1,ue.value=!1},["stop"]))},[r("span",null,O(Vt[E(N).shape]),1),a[28]||(a[28]=r("span",{class:"text-slate-400"},"▼",-1))]),fe.value?(f(),p("div",{key:0,class:"absolute top-full left-0 mt-1 w-56 bg-slate-800 border border-white/10 rounded-lg shadow-xl z-50 p-3",onClick:a[5]||(a[5]=$e(()=>{},["stop"]))},[r("div",Ei,[a[29]||(a[29]=r("p",{class:"text-xs text-slate-400 mb-1.5"},"Форма",-1)),r("div",Ai,[(f(!0),p(Y,null,ae(Object.values(E(me)),v=>(f(),p("button",{key:v,type:"button",class:oe(["flex-1 py-1.5 rounded border text-sm transition",E(N).shape===v?"bg-sky-500/20 border-sky-400/60":"border-white/10 hover:bg-white/5"]),title:ss[v],onClick:B=>E(o).setSelectionShape(v)},O(Vt[v]),11,Ii))),128))])]),r("div",Mi,[a[30]||(a[30]=r("p",{class:"text-xs text-slate-400 mb-1.5"},"Режим",-1)),r("div",Di,[(f(!0),p(Y,null,ae(Object.values(E(_e)),v=>(f(),p("button",{key:v,type:"button",class:oe(["flex-1 py-1.5 rounded border text-xs transition",E(N).mode===v?"bg-sky-500/20 border-sky-400/60":"border-white/10 hover:bg-white/5"]),title:as[v],onClick:B=>E(o).setSelectionMode(v)},O(os[v]),11,Li))),128))])]),r("div",Ri,[a[31]||(a[31]=r("p",{class:"text-xs text-slate-400 mb-1.5"},"Поведение",-1)),r("div",Fi,[(f(!0),p(Y,null,ae(Object.values(E(Be)),v=>(f(),p("button",{key:v,type:"button",class:oe(["flex-1 py-1 rounded border text-[10px] transition",E(N).behavior===v?"bg-sky-500/20 border-sky-400/60":"border-white/10 hover:bg-white/5"]),title:Yt[v],onClick:B=>E(o).setSelectionBehavior(v)},O(ls[v]),11,Ni))),128))]),r("p",Oi,O(Yt[E(N).behavior]),1)]),E(N).shape===E(me).LINE?(f(),p("div",zi,[r("p",Bi,"Ширина линии: "+O(E(N).lineWidth),1),r("input",{type:"range",min:"1",max:"5",value:E(N).lineWidth,class:"w-full",onInput:a[4]||(a[4]=v=>E(o).setSelectionLineWidth(Number(v.target.value)))},null,40,ji)])):M("",!0)])):M("",!0)]),de.value.size>0?(f(),p(Y,{key:0},[r("span",Wi,O(de.value.size)+" выбрано",1),r("button",{type:"button",class:"px-2 py-1.5 rounded-lg border border-emerald-400/60 bg-emerald-500/20 text-emerald-100 text-xs hover:bg-emerald-500/30 transition",title:"Заполнить выбранным террейном",onClick:Un}," 🎨 Залить "),r("button",{type:"button",class:"px-2 py-1.5 rounded-lg border border-amber-400/60 bg-amber-500/20 text-amber-100 text-xs hover:bg-amber-500/30 transition",title:"Рандомная заливка по профилю",onClick:a[6]||(a[6]=v=>{b.value=!b.value,D.value=!1,fe.value=!1})}," 🎲 Рандом "),r("button",{type:"button",class:"px-2 py-1.5 rounded-lg border border-rose-400/60 bg-rose-500/20 text-rose-100 text-xs hover:bg-rose-500/30 transition",title:"Удалить выбранные гексы",onClick:qn}," 🗑️ "),r("button",{type:"button",class:"px-2 py-1.5 rounded-lg border border-white/10 text-slate-300 text-xs hover:bg-white/5 transition",title:"Снять выделение",onClick:Wt}," ✕ ")],64)):M("",!0)],64)):M("",!0),a[39]||(a[39]=r("div",{class:"w-px h-6 bg-white/10 mx-1"},null,-1)),r("div",Hi,[r("button",{type:"button",class:"flex items-center gap-2 px-2 py-1.5 rounded-lg border border-white/10 hover:bg-white/5 transition text-sm",onClick:a[7]||(a[7]=$e(v=>{D.value=!D.value,ue.value=!1,fe.value=!1},["stop"]))},[r("span",{class:"w-5 h-5 rounded",style:Se({backgroundColor:ft.value.fallbackColor||ft.value.color||"#888"})},null,4),r("span",Ui,O(ft.value.name||E(y)),1)]),D.value?(f(),p("div",{key:0,class:"absolute top-full left-0 mt-1 w-80 bg-slate-800 border border-white/10 rounded-lg shadow-xl z-50 overflow-hidden",onClick:a[14]||(a[14]=$e(()=>{},["stop"]))},[r("div",qi,[r("div",Vi,[Me(r("input",{"onUpdate:modelValue":a[8]||(a[8]=v=>le.value=v),type:"text",placeholder:"Поиск террейна...",class:"flex-1 px-2 py-1 text-xs bg-slate-900/50 border border-white/10 rounded focus:outline-none focus:border-sky-400/50"},null,512),[[qe,le.value]]),r("button",{type:"button",class:oe(["p-1 rounded hover:bg-white/10 transition text-xs",Re.value?"bg-sky-500/20 text-sky-400":"text-slate-400"]),onClick:a[9]||(a[9]=v=>Re.value=!Re.value),title:"Показать фильтры"}," ⚙ ",2)]),Re.value?(f(),p("div",Yi,[r("div",Gi,[a[34]||(a[34]=r("span",{class:"text-xs text-slate-400 w-16"},"Биом:",-1)),Me(r("select",{"onUpdate:modelValue":a[10]||(a[10]=v=>pe.value=v),class:"flex-1 px-2 py-1 text-xs bg-slate-900/50 border border-white/10 rounded focus:outline-none"},[a[33]||(a[33]=r("option",{value:null},"Все биомы",-1)),(f(!0),p(Y,null,ae(E(l).biomes,v=>(f(),p("option",{key:v.id,value:v.id},O(v.name),9,Xi))),128))],512),[[ht,pe.value]])]),r("div",Qi,[a[36]||(a[36]=r("span",{class:"text-xs text-slate-400 w-16"},"Обзор:",-1)),Me(r("select",{"onUpdate:modelValue":a[11]||(a[11]=v=>we.value=v),class:"flex-1 px-2 py-1 text-xs bg-slate-900/50 border border-white/10 rounded focus:outline-none"},[a[35]||(a[35]=r("option",{value:null},"Любой",-1)),(f(!0),p(Y,null,ae(E(l).visibilityTypes,v=>(f(),p("option",{key:v.id,value:v.id},O(v.name),9,Ki))),128))],512),[[ht,we.value]])]),r("div",Ji,[a[37]||(a[37]=r("span",{class:"text-xs text-slate-400 w-16"},"Проход:",-1)),Me(r("input",{"onUpdate:modelValue":a[12]||(a[12]=v=>ve.value.max=v),type:"range",min:"1",max:"5",step:"1",class:"flex-1"},null,512),[[qe,ve.value.max,void 0,{number:!0}]]),r("span",Zi,"≤"+O(ve.value.max),1)]),r("button",{type:"button",class:"w-full px-2 py-1 text-xs bg-slate-700/50 hover:bg-slate-700 rounded transition",onClick:a[13]||(a[13]=v=>{pe.value=null,we.value=null,ve.value={min:1,max:5},le.value=""})}," Сбросить фильтры ")])):M("",!0)]),r("div",er,[Mt.value.length>0?(f(),p("div",tr,[(f(!0),p(Y,null,ae(Mt.value,v=>(f(),p("button",{key:v.id,type:"button",class:oe(["w-12 h-12 rounded border border-white/10 hover:border-white/30 transition relative group",E(y)===v.id?"ring-2 ring-sky-400":""]),style:Se({backgroundColor:v.color||v.fallbackColor||"#888"}),title:`${v.name}
Проход: ${v.movementCost??1}
Ближ. бой: ${(v.meleeAdvantage??0)>0?"+":""}${v.meleeAdvantage??0}`,onClick:B=>Ut(v.id)},[r("div",sr,[v.movementCost>=5?(f(),p("span",or,"🚫")):v.movementCost>2?(f(),p("span",ar,"⚠")):M("",!0),v.visibility==="blocking"?(f(),p("span",lr,"🔲")):v.visibility==="partial"?(f(),p("span",ir,"🌿")):M("",!0),(v.meleeAdvantage??0)>0?(f(),p("span",rr,"+"+O(v.meleeAdvantage),1)):(v.meleeAdvantage??0)<0?(f(),p("span",cr,O(v.meleeAdvantage),1)):M("",!0)])],14,nr))),128))])):(f(),p("div",ur," Террейны не найдены ")),!le.value&&!pe.value&&!we.value?(f(),p("div",dr,[a[38]||(a[38]=r("div",{class:"text-xs text-slate-500 mb-1"},"Базовые (совместимость):",-1)),r("div",fr,[(f(!0),p(Y,null,ae(E(Ge),(v,B)=>(f(),p("button",{key:B,type:"button",class:oe(["w-12 h-12 rounded border border-white/10 hover:border-white/30 transition",E(y)===B?"ring-2 ring-sky-400":""]),style:Se({backgroundColor:v.color}),title:v.name,onClick:V=>Ut(B)},null,14,pr))),128))])])):M("",!0)])])):M("",!0)])])):M("",!0),r("div",hr,[E(J)?(f(),p(Y,{key:0},[r("button",{type:"button",class:oe(["px-3 py-1.5 rounded-lg border text-xs transition",E(u)?"bg-emerald-500/20 border-emerald-400/60 text-emerald-100":"border-white/10 hover:bg-white/5 text-slate-300"]),onClick:Yn},O(E(u)?"✓ Готово":"✏️ Редактировать"),3),E(c)?(f(),p("button",{key:0,type:"button",class:oe(["px-3 py-1.5 rounded-lg border text-xs transition",(L=E(c).visibility)!=null&&L.published?"bg-emerald-500/20 border-emerald-400/60 text-emerald-100":"border-white/10 hover:bg-white/5 text-slate-300"]),title:(K=E(c).visibility)!=null&&K.published?"Карта видна игрокам":"Карта скрыта",onClick:Gn},O((te=E(c).visibility)!=null&&te.published?"👁 Видима":"🙈 Скрыта"),11,mr)):M("",!0)],64)):M("",!0),r("button",{type:"button",class:"w-9 h-9 rounded-lg border border-white/10 hover:bg-white/5 flex items-center justify-center text-sm",title:"Центрировать (0,0)",onClick:a[15]||(a[15]=v=>{nt(),Ae()})}," 🎯 ")])]),r("div",gr,[r("div",{ref_key:"canvasContainer",ref:A,class:"flex-1 overflow-hidden relative bg-slate-900/40 z-0"},[r("canvas",{ref_key:"terrainCanvas",ref:x,class:"absolute top-0 left-0",width:W.value.width,height:W.value.height},null,8,vr),r("canvas",{ref_key:"gridCanvas",ref:$,class:"absolute top-0 left-0",width:W.value.width,height:W.value.height},null,8,br),r("canvas",{ref_key:"uiCanvas",ref:R,class:oe(["absolute top-0 left-0",q.value?"cursor-grabbing":E(u)?"cursor-crosshair":"cursor-grab"]),width:W.value.width,height:W.value.height,onMousemove:Nt,onMousedown:zt,onMouseup:Bt,onMouseleave:Bn,onWheel:jn,onTouchstart:Nn,onTouchmove:On,onTouchend:zn,onContextmenu:a[16]||(a[16]=$e(()=>{},["prevent"]))},null,42,yr),_.value?(f(),p("div",xr," q: "+O(_.value.q)+", r: "+O(_.value.r),1)):M("",!0),r("div",kr,O(Math.round(E(k).zoom*100))+"% ",1)],512),b.value?(f(),ps(ii,{key:0,class:"flex-shrink-0 border-l border-white/10",onClose:a[17]||(a[17]=v=>{b.value=!1,Jn()}),onPreview:Qn,onApply:Kn})):M("",!0)]),r("footer",wr,[r("div",_r,[r("p",Tr,[E(u)?(f(),p(Y,{key:0},[Xt(" Рисуйте кликом/перетаскиванием • Shift+drag для навигации • Колёсико для зума • 🎯 центр (0,0) ")],64)):(f(),p(Y,{key:1},[Xt(O(E(J)?'Нажмите "Редактировать" для изменения карты':"Shift+перетаскивание для навигации"),1)],64))]),r("div",Cr,[E(J)&&E(c)?(f(),p("button",{key:0,type:"button",class:"px-2 py-1 rounded text-xs text-rose-400 hover:bg-rose-500/10 transition",onClick:Xn}," 🗑️ Удалить ")):M("",!0)])])]),U.value?(f(),p("div",{key:0,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/60",onClick:a[24]||(a[24]=$e(v=>U.value=!1,["self"]))},[r("div",Sr,[a[45]||(a[45]=r("h3",{class:"text-lg font-semibold mb-4"},"Создать карту",-1)),r("div",Pr,[r("div",null,[a[40]||(a[40]=r("label",{class:"block text-sm text-slate-400 mb-1"},"Название",-1)),Me(r("input",{"onUpdate:modelValue":a[18]||(a[18]=v=>be.value.name=v),type:"text",class:"w-full px-3 py-2 rounded-lg bg-slate-900 border border-white/10 text-sm",placeholder:"Новая карта"},null,512),[[qe,be.value.name]])]),r("div",null,[a[41]||(a[41]=r("label",{class:"block text-sm text-slate-400 mb-1"},"Ориентация гексов",-1)),r("div",$r,[r("button",{type:"button",class:oe(["flex-1 py-2 rounded-lg border text-sm transition",be.value.orientation==="flat"?"bg-sky-500/20 border-sky-400/60":"border-white/10 hover:bg-white/5"]),onClick:a[19]||(a[19]=v=>be.value.orientation="flat")}," Flat-top ⬡ ",2),r("button",{type:"button",class:oe(["flex-1 py-2 rounded-lg border text-sm transition",be.value.orientation==="pointy"?"bg-sky-500/20 border-sky-400/60":"border-white/10 hover:bg-white/5"]),onClick:a[20]||(a[20]=v=>be.value.orientation="pointy")}," Pointy-top ⬢ ",2)])]),r("div",null,[a[42]||(a[42]=r("label",{class:"block text-sm text-slate-400 mb-1"},"Масштаб",-1)),Me(r("select",{"onUpdate:modelValue":a[21]||(a[21]=v=>be.value.scale=v),class:"w-full px-3 py-2 rounded-lg bg-slate-900 border border-white/10 text-sm"},[(f(),p(Y,null,ae(qt,(v,B)=>r("option",{key:B,value:B},O(v),9,Er)),64))],512),[[ht,be.value.scale]])]),r("div",null,[a[43]||(a[43]=r("label",{class:"block text-sm text-slate-400 mb-1"},"Размер гекса (пиксели)",-1)),Me(r("input",{"onUpdate:modelValue":a[22]||(a[22]=v=>be.value.hexSize=v),type:"number",min:"16",max:"64",class:"w-full px-3 py-2 rounded-lg bg-slate-900 border border-white/10 text-sm"},null,512),[[qe,be.value.hexSize,void 0,{number:!0}]])]),a[44]||(a[44]=r("p",{class:"text-xs text-slate-500"}," Карта не имеет фиксированных границ — она расширяется по мере рисования. Центр карты находится в координатах (0, 0). ",-1))]),r("div",Ar,[r("button",{type:"button",class:"px-4 py-2 rounded-lg border border-white/10 hover:bg-white/5 text-sm",onClick:a[23]||(a[23]=v=>U.value=!1)}," Отмена "),r("button",{type:"button",class:"px-4 py-2 rounded-lg bg-sky-500 hover:bg-sky-600 text-sm font-medium",onClick:Ht}," Создать ")])])])):M("",!0)])}}};export{jr as C,Br as H,zr as I,Et as _,Ro as a,Fr as b,Rr as c,Da as d,un as e,it as f,Or as g,yt as h,bt as i,Wr as j,Lr as k,Is as p,Nr as r};
