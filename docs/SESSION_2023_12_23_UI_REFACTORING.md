# Сессия 23.12.2025 - Рефакторинг UI панелей мастера

## Выполненные задачи

### 1. ✅ Исправление координат мыши при выборе направления
- **Проблема**: При развороте токенов координаты мыши определялись неправильно (~100px смещение)
- **Решение**: Добавлено смещение `rect.left` и `rect.top` при вычислении `facingDragCenter` в BattleMap.vue

### 2. ✅ Ctrl-режим для мастерского перетаскивания токенов
- **Проблема**: Мастер мог случайно перетаскивать токены
- **Решение**: Добавлена проверка `event.ctrlKey` - только с зажатым Ctrl мастер может мгновенно перемещать токены. Без Ctrl мастер работает как игрок (клик для выбора, затем выбор направления)

### 3. ✅ Удалён правый клик для выбора направления
- **Причина**: Устаревший механизм, заменён на slingshot-drag
- **Изменения**: Удалены обработчики правого клика из BattleMap.vue

### 4. ✅ Разворот на месте для мастера
- **Добавлено**: Если мастер кликает на уже выбранный токен, начинается режим разворота (facingRingDrag)

### 5. ✅ Создан useTokenMovement composable
- **Файл**: `src/composables/useTokenMovement.js`
- **Назначение**: Унифицированная логика перемещения токенов для всех контекстов
- **Функции**:
  - `moveTokenWithAnimation()` - перемещение с анимацией
  - `playRemoteTokenAnimation()` - воспроизведение анимации от другого игрока
  - `useTokenMovement()` - хук для компонентов

### 6. ✅ Система очереди сообщений (session.js)
- **Добавлено в session.js**:
  - `messageQueue: []` - очередь сообщений
  - `isQueuePaused: false` - режим накопления
  - `pauseQueue()` / `flushQueue()` / `clearQueue()` - управление очередью
- **Назначение**: Позволяет мастеру накапливать изменения и отправлять их игрокам пакетно или последовательно

### 7. ✅ Создана MapControlPanel (нижняя панель)
- **Файл**: `src/components/master/MapControlPanel.vue`
- **Расположение**: Нижняя часть экрана для мастера (desktop)
- **Содержит**:
  - Выбор карты (dropdown)
  - Кнопка создания новой карты (+)
  - Режимы редактора (выбор/рисование/ластик)
  - Выбор террейна с палитрой
  - Счётчик выделенных гексов
  - Действия с выделением (залить/удалить/снять)
  - Кнопка редактирования
  - Видимость карты
  - Индикатор масштаба (%)
  - Кнопка центрирования
  - Удаление карты

### 8. ✅ Создана BattleControlPanel (правая боковая панель)
- **Файл**: `src/components/master/BattleControlPanel.vue`
- **Расположение**: Правый край, между инфопанелью и MapControlPanel
- **Динамическое позиционирование**: `top` меняется в зависимости от состояния инфопанели
- **Содержит** (базовый UI):
  - Секция "Планирование" - управление очередью сообщений
  - Секция "Указка" - инструменты указки
  - Секция "На карте" - список токенов с HP

### 9. ✅ Скрыт header для мастера на desktop
- **Изменение**: Условие `v-if` в BattleMap.vue изменено на `(!mobileMode && !isMaster) || (mobileMode && isMaster)`
- **Результат**: На desktop мастер использует нижнюю MapControlPanel вместо верхнего header

### 10. ✅ Инфопанель на полную ширину
- **Решение**: Убрано сужение инфопанели при открытой боевой панели
- **BattleControlPanel**: Динамически сдвигается вниз когда инфопанель развёрнута

### 11. ✅ Состояние боевой панели в interaction store
- **Добавлено в interaction.js**:
  - `battlePanelExpanded: false`
  - `toggleBattlePanel()`
  - `setBattlePanelExpanded()`

---

## Не завершённые задачи

### ❌ MapControlPanel - неполный функционал

**Что работает:**
- Выбор карты
- Создание карты
- Редактирование/Готово
- Видимость
- Удаление
- Центрирование
- Индикатор масштаба

**Что НЕ работает / НЕ перенесено из header:**
- [ ] Расширенный выбор террейна с фильтрами (биом, проходимость, видимость)
- [ ] Размещение токенов на карту
- [ ] Настройки выделения (форма: точка/линия/прямоугольник, режим: добавить/убрать/переключить, поведение)
- [ ] Рандомная заливка по профилю
- [ ] Информация о карте (количество гексов, ориентация)

### ❌ BattleControlPanel - почти не работает

**Что есть (только UI):**
- Кнопка "Накапливать" для очереди сообщений
- Кнопки инструментов указки
- Список токенов на карте

**Что НЕ работает:**
- [ ] Редактирование HP токенов (UI есть, но не подключено)
- [ ] Выбор токена из списка не синхронизирован с картой
- [ ] Инициатива / порядок хода
- [ ] Быстрые действия с токенами
- [ ] Статусы / эффекты
- [ ] Управление боевыми раундами

### ❌ Другие незавершённые задачи

- [ ] Альтернатива Ctrl для touch-устройств (визуальный переключатель режима)
- [ ] Содержимое правой части инфопанели (органы управления выделенными объектами)
- [ ] Полная интеграция очереди сообщений с анимациями движения

---

## Технические заметки

### Реактивность infoPanelHeight
Для отслеживания состояния инфопанели нужно обращаться напрямую к реактивному state:
```javascript
// ❌ Неправильно - не создаёт реактивную зависимость
const isOpen = userStore.getInfoPanelOpen('battle-map')

// ✅ Правильно - реактивно
const isOpen = userStore.infoPanelState?.['battle-map'] ?? false
```

### Структура панелей на desktop для мастера
```
┌─────────────────────────────────────────────────┐
│ NavBar (GameLayout)                              │
├─────────────────────────────────────────────────┤
│ InfoPanel (GameLayout) - 56px свёрнутая / ~200px│
├──────────────────────────────────┬──────────────┤
│                                  │ Battle       │
│                                  │ Control      │
│         BattleMap Canvas         │ Panel        │
│                                  │ (260px)      │
│                                  │              │
├──────────────────────────────────┴──────────────┤
│ MapControlPanel (BattleMap) - ~40px             │
└─────────────────────────────────────────────────┘
```

### Ключевые файлы изменённые в этой сессии
- `src/components/battle/BattleMap.vue` - основные изменения взаимодействия
- `src/components/layout/GameLayout.vue` - интеграция store, mobile-mode
- `src/components/master/MapControlPanel.vue` - НОВЫЙ
- `src/components/master/BattleControlPanel.vue` - НОВЫЙ
- `src/composables/useTokenMovement.js` - НОВЫЙ
- `src/stores/interaction.js` - добавлен battlePanelExpanded
- `src/stores/session.js` - добавлена очередь сообщений
